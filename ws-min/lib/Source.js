$ws.core.loadTemplateFile=function(a,b){function e(k){if(!b&&k instanceof Array){for(var j=0,g=k.length;j<g;j++){if($ws.single.Storage.isStored("resfile://"+k[j])||j==g-1){k=k[j];break;}}}var f=($&&$.cookie&&$.cookie("sid"))||"",m=($&&$.cookie&&$.cookie("rid"))||0,h=""+(parseInt(f.split("-")[3],16)||0)+m;return $ws.single.Storage.store("resfile://"+k,function(i){i.dependOn($ws.single.ioc.resolve("ITransport",{dataType:b?"text":"xml",url:(function(){var l=$ws._const.buildnumber,n;if(l){$ws._const.buildnumber=l+h;}n=$ws.core.urlWithHost(k+(b?".fast.xml":".xml"));if(l){$ws._const.buildnumber=l;}return n;})()}).execute(null));});}if($ws._const.xmlPackages[a]&&!b){return new $ws.proto.Deferred().dependOn(e($ws._const.xmlPackages[a])).addCallback(function(h){var f=h.documentElement;for(var g=f.childNodes.length-1;g>=0;--g){if(f.childNodes[g].nodeType!=$ws._const.nodeType.ELEMENT_NODE){continue;}if(f.childNodes[g].getAttribute("id")==a){return f.childNodes[g];}}return new Error(a+" is not found in the package "+$ws._const.xmlPackages[a]);});}var c=a.substr(0,1),d=$ws._const.wsRoot+"res/xml/";if(c=="/"||c=="."){d="";}else{if(a in $ws._const.xmlContents){a=$ws._const.xmlContents[a];d=$ws._const.resourceRoot;}}return e(d+a);};$ws.core.attachTemplate=function(a,b,c){return $ws.single.Storage.store("res://"+a,function(d){function e(g,f,h){if(typeof $ws.proto[g]=="function"){d.callback(new $ws.proto[g]({templateXML:f,template:f,templateName:h}));}else{d.errback(new Error("$ws.core.attachTemplate : $ws.proto."+g+" is not implemented"));}}if(b&&c){e("FastTemplate",c,a);}else{if(a){$ws.core.loadTemplateFile(a,b).addCallbacks(function(f){if(b){e("FastTemplate",f,a);}else{e("XMLTemplate",f,a);}$ws.helpers.addXmlLog(a);return f;},function(f){d.errback(f);return f;});}else{e("EmptyTemplate","","");}}});};$ws._const.templateParseConfig={"#text":true,control:"div",option:false,style:false,configuration:false};$ws._const.allowAttribute={config:false};$ws._const.nodeType={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12};$ws.proto.Template=$ws.core.extend({},{$protected:{_templateName:"",_dReady:null,_loadedHandlers:[],_configuration:{autoWidth:false,autoHeight:false,isRelativeTemplate:false,minWidth:0}},$constructor:function(a){this._templateName=a.templateName;this._dReady=new $ws.proto.ParallelDeferred();},isPage:function(){throw new Error("Template::isPage - method is not implemented!");},getRenderResult:function(){return this._dReady.getResult();},getStyle:function(){throw new Error("Template::getStyle - method is not implemented!");},getDimensions:function(){throw new Error("Template::getDimensions - method is not implemented!");},getAlignment:function(){throw new Error("Template::getAlignment - method is not implemented!");},getTitle:function(){throw new Error("Template::getTitle - method is not implemented!");},getConfig:function(a){throw new Error("Template::getConfig - method is not implemented!");},getDeclaredHandlers:function(){return this._loadedHandlers;},createMarkup:function(a){throw new Error("Template::createMarkup - method is not implemented!");},getControls:function(a){throw new Error("Template::getControls - method is not implemented!");},getName:function(){return this._templateName;},_mergeAttrToConfig:function(a,b,c){if(b!=="title"&&b!=="width"&&b!=="height"){a[b]=c==="false"?false:(c==="true"?true:c);}}});$ws.proto.EmptyTemplate=$ws.proto.Template.extend({$constructor:function(){this._dReady.done();},isPage:function(){return true;},getConfig:function(){return{};},getStyle:function(){return"";},getAlignment:function(){return{horizontalAlignment:"Stretch",verticalAlignment:"Stretch"};},getTitle:function(){return"";},createMarkup:function(a){a.get(0).innerHTML="";},getDimensions:function(){return{width:"",height:""};},getControls:function(){return[];}});$ws.proto.XMLTemplate=$ws.proto.Template.extend({$protected:{_xml:null,_toText:[],_html:"",_dReady:null,_innerTemplates:[],_templateName:"",_loadedHandlers:{},_document:undefined,_controlTagCache:""},$constructor:function(b){var c=this;this._dReady=new $ws.proto.ParallelDeferred();this._xml=b.templateXML;this._document=this._xml.documentElement?this._xml.documentElement:this._xml;this._innerTemplates[this._templateName=b.templateName]=true;this._includeInnerTemplate(new $ws.proto.Deferred()).addCallbacks(function(){c._assignId();c._loadEventHandlers();},function(f){$ws.single.ioc.resolve("ILogger").log("Template","Building failed. Reason: "+f.message);return f;});var a=this._xml.getElementsByTagName("style")[0];if(a){var d=this._findCDATA(a,true);if(d){var e=$ws.helpers.insertCss(d,true);if(e){this._dReady.push(e);}}}},isPage:function(){return this._document.getAttribute("isApplication")==="false";},_extractControlConfiguration:function(controlNode){var configObject,cfg=controlNode.getAttribute("config");if(cfg){try{configObject=eval("("+cfg+")");}catch(e){configObject={};}}else{configObject=this._parseConfiguration(controlNode.getElementsByTagName("configuration")[0]);}return configObject;},_findCDATA:function(d,f){var c,e;for(var b=0,a=d.childNodes.length;b<a;b++){c=d.childNodes[b];if(c.nodeType===$ws._const.nodeType.CDATA_SECTION_NODE){e=f?c.nodeValue:c;break;}}return e;},_includeInnerTemplate:function(f){var m=this,g=this._xml.getElementsByTagName("include"),h=new $ws.proto.ParallelDeferred(),b,j,a,c=[],k=[];if(g.length===0){f.callback();}else{for(var e=0,d=g.length;e<d;e++){b=g[e];j=b.parentNode;if((a=g[e].getAttribute("name"))!==null){if(this._innerTemplates[a]){return f.errback("Cyclic dependency detected");}else{c.push(a);k[e]="";(function(n,o,l){h.push($ws.core.loadTemplateFile(a).addCallback(function(s){var t=(s.documentElement?s.documentElement.childNodes:s.childNodes),i=s.getElementsByTagName("style")[0],r;if(i){k[l]=m._findCDATA(i,true);(s.documentElement?s.documentElement:s).removeChild(i);}for(var p=0,q=t.length;p<q;p++){r=t[0];if(m._xml.adoptNode){r=m._xml.adoptNode(r);}n.insertBefore(r,o);}n.removeChild(o);return s;}));})(j,b,e);}}else{$ws.helpers.forEach(b.childNodes,function(l){if(l.getAttribute){var i=l.getAttribute("source");if(i){h.push($ws.core.attach(i));}}});}}h.done().getResult().addCallback(function(){var p=m._xml.getElementsByTagName("style")[0];for(var o=0,n=c.length;o<n;o++){m._innerTemplates[c[o]]=true;}if(p){m._findCDATA(p,false).nodeValue+=k.join("");}else{p=m._xml.createElement("style");p.appendChild(m._xml.createCDATASection(k.join("")));m._document.appendChild(p);}m._includeInnerTemplate(f);});}return f;},_assignId:function(){var b=this._getControlTags(this._xml);for(var c=0,a=b.length;c<a;c++){var d=b[c];if(!d.getAttribute("id")){d.setAttribute("id",$ws.helpers.randomId());}}},_getControlTags:function(c){var a;if(this._controlTagCache){return this._controlTagCache;}if(c.querySelectorAll){var g=c.querySelectorAll('div[wsControl="true"]');if(g){a=g;}}if(!a){a=[];var f=c.getElementsByTagName("div");for(var d=0,b=f.length;d<b;d++){var e=f[d];if(e.getAttribute("wsControl")){a.push(e);}}}return(this._controlTagCache=a);},_getFunctionOptions:function(){var b;if(this._xml.querySelectorAll){b=this._xml.querySelectorAll('option[type="function"]');if(b){return b;}}var c=this._xml.getElementsByTagName("option");b=[];for(var a=0;a<c.length;a++){if(c[a].getAttribute("type")==="function"){b.push(c[a]);}}return b;},_loadEventHandlers:function(){var d=this._getFunctionOptions();for(var b=0;b<d.length;b++){var a=d[b].getAttribute("name"),c=d[b].getAttribute("value");if(c!==null&&c.length>0){this._dReady.push($ws.core.getHandler(c));}}this._dReady.push(this._processTemplateHandlers()).done(this);},_processTemplateHandlers:function(){var e=new $ws.proto.ParallelDeferred(),j=this;var g=this._document.attributes,h={};for(var c=0,b=g.length;c<b;c++){var a=g[c],f=a.nodeName;if(f.substring(0,2)=="on"&&a.nodeValue!==""){h[f]=a.nodeValue.split("|");}}if(!Object.isEmpty(h)){for(var d in h){if(h.hasOwnProperty(d)){(function(k,m){j._loadedHandlers[k]=[];for(var l=0;l<m.length;++l){(function(n){e.push($ws.core.getHandler(m[n]).addCallbacks(function(i){j._loadedHandlers[k][n]=i;return i;},function(i){$ws.single.ioc.resolve("ILogger").error("Template","Error while loading handler "+k+": "+i.message,i);return i;}));}(l));}})(d,h[d]);}}}return e.done().getResult();},getRenderResult:function(){return this._dReady.getResult();},getStyle:function(){return this._document.getAttribute("windowStyle")||"";},getDimensions:function(){var b=this._document.getAttribute("width"),a=this._document.getAttribute("height");return{width:!b?"":b.toLowerCase()==="auto"?"auto":b.indexOf("%")>=0?b:parseInt(b,10)+"px",height:!a?"":a.toLowerCase()==="auto"?"auto":a.indexOf("%")>=0?a:parseInt(a,10)+"px"};},getAlignment:function(){var b=this._document.getAttribute("HorizontalAlignment"),a=this._document.getAttribute("VerticalAlignment");return{horizontalAlignment:!b?"Stretch":b,verticalAlignment:!a?"Stretch":a};},getTitle:function(){return this._document.getAttribute("title");},getConfig:function(f){var c=this._configuration,a=f||this._document;if(a.attributes!==null){for(var e=0,b=a.attributes.length;e<b;e++){var d=a.attributes[e];this._mergeAttrToConfig(c,d.nodeName,d.nodeValue);}}return c;},getDeclaredHandlers:function(){return this._loadedHandlers;},createMarkup:function(b){var j=BOOMR.plugins.WS.startSpan("mkup:"+this.getName());var m;if(this._html===""){var a=(this._xml.nodeName=="ws-template"?this._xml:this._xml.getElementsByTagName("ws-template")[0]);var h=b.get(0).ownerDocument;var g=h.createElement("div");var c=a?a.childNodes:[];var k,e=0,d;while(c.length&&e<c.length){k=c.item(e);if(k.nodeType==$ws._const.nodeType.ELEMENT_NODE&&k.nodeName!="style"){k=$ws.proto.Template._importNode(h,k,true);e++;g.appendChild(k);}else{e++;}}var f=g.getElementsByTagName("configuration");for(e=0,d=f.length;e<d;e++){f[0].parentNode.removeChild(f[0]);}this._html=m=g.innerHTML.replace(/<\/ ?br>/ig,"").replace(/&amp;/ig,"&");}else{m=this._html;}b.html(m);j.stop();},getControls:function(h){var f=BOOMR.plugins.WS.startSpan("ctrls:"+this.getName());var d=this._getControlTags(this._xml);var a=[];for(var e=0,c=d.length;e<c;e++){var g=d[e];if(h==g.getAttribute("parentId")){var b=this._extractControlConfiguration(g);b.type=g.getAttribute("type");b.id=g.getAttribute("id");a.push(b);}}f.stop();return a;},_parseConfiguration:function(k,c){var a,n,m,h=function(){var i=this;i.mass=c?[]:{};i.push=function(l,o){if(c){i.mass.push(o);}else{if(l!==null){i.mass[l]=o;}}};},d=new h();if(k&&k.childNodes){var f=k.childNodes;for(var j=0,g=f.length;j<g;j++){var e=f[j];if(e.nodeName&&e.nodeName=="option"){a=e.getAttribute("name");m=e.getAttribute("type");n=e.getAttribute("value");if(m==="array"||(n===null&&m!="cdata")){if(n===null){n=this._parseConfiguration(e,m==="array");}d.push(a,n);}else{switch(m){case"cdata":d.push(a,this._findCDATA(e,true));break;case"boolean":d.push(a,n==="true");break;case"function":if(typeof(n)==="string"&&n.length>0){var b=$ws.core.getHandler(n);if(b.isSuccessful()){(function(i){b.addCallback(function(l){if(typeof(l)=="function"){d.push(i,l);return l;}else{throw new Error("Integrity error! Some serious problems in $ws.core.getHandler()!");}});})(a);}else{throw new Error(n+" function is not ready or don't exist");}}break;case"dialog":if(typeof(n)==="string"&&n.length>0){(function(i){d.push(a,function(){$ws.core.attachInstance("Control/Area:Dialog",{template:i,opener:this,context:(new $ws.proto.Context().setPrevious(this.getLinkedContext()))});});})(n);}break;case"floatArea":if(typeof(n)==="string"&&n.length>0){(function(i){d.push(a,function(){var l=this.getTopParent().getContainer();this.setEnabled(false);$ws.core.attachInstance("Control/Area:FloatArea",{id:this.getId(),opener:this,name:this.getName()+"-floatArea",template:i,target:l,side:"right",autHide:true,showDelay:300,animationLength:300,offset:{x:0,y:(window.scrollY>l.offset().top)?window.scrollY:0},handlers:{onAfterClose:function(){this.getOpener().setEnabled(true);}}});});})(n);}break;case"command":if(typeof(n)==="string"&&n.length>0){(function(i){d.push(a,function(){$ws.single.CommandDispatcher.sendCommand(this,i);});})(n);}break;case"page":case"newpage":if(typeof(n)==="string"&&n.length>0){(function(l,i){d.push(a,function(){if(i=="page"){window.location=l;}else{window.open(l);}});})(n,m);}break;case"menu":if(typeof(n)==="string"&&n.length>0){(function(i){d.push(a,function(){if(SBIS3&&SBIS3.CORE&&SBIS3.CORE.Button&&this instanceof SBIS3.CORE.Button){this._options.menuName=i;this.unsubscribe("onActivated",arguments.callee);this._initMenu();this._notify("onActivated");}});})(n);}break;case null:default:if(n==="null"){n=null;}if(n==="Infinity"){n=Infinity;}d.push(a,n);break;}}}}}return d.mass;}});$ws.proto.FastTemplate=$ws.proto.Template.extend({$protected:{_options:{template:""},_dom:null,_rootConfig:{},_controlsConfig:[]},$constructor:function(){var n=this;var k=BOOMR.plugins.WS.startSpan("FastTemplate:ctor");var g=BOOMR.plugins.WS.startSpan("FastTemplate:ctor:configuration:"+this.getName());this._dom=document.createElement("div");this._dom.innerHTML=this._options.template;if(!this._dom.firstChild){throw new Error("Wrong template came from server");}this._rootConfig=JSON.parse(this._dom.firstChild.getAttribute("templateConfig"));this._controlsConfig=JSON.parse(this._dom.firstChild.getAttribute("config"));g.stop();var d=BOOMR.plugins.WS.startSpan("FastTemplate:ctor:func_preload:"+this.getName());$ws.helpers.forEach(this._controlsConfig.functions,function(q){var p='["'+q.split("/").join('"]["')+'"]';var o=new Function("s","val","return arguments.length == 1 ? s"+p+" : (s"+p+" = val);");var l=n._controlsConfig;var i=o(l).split("#");switch(i[0]){case"function":n._dReady.push($ws.core.getHandler(i[1]).addCallback(function(r){o(l,r);}));break;case"moduleFunc":var e=i[1].split("/");n._dReady.push($ws.requireModule(e[0]).addCallback(function(r){o(l,r[0][e[1]]);}));break;case"dialog":o(l,function(){$ws.core.attachInstance("Control/Area:Dialog",{template:i[1],opener:this,context:(new $ws.proto.Context().setPrevious(this.getLinkedContext()))});});break;case"command":o(l,function(){$ws.single.CommandDispatcher.sendCommand(this,i[1]);});break;case"newpage":case"page":o(l,function(){if(i[0]=="page"){window.location=i[1];}else{window.open(i[1]);}});break;case"menu":o(l,function(){if(SBIS3&&SBIS3.CORE&&SBIS3.CORE.Button&&this instanceof SBIS3.CORE.Button){this._options.menuName=i[1];this.unsubscribe("onActivated",arguments.callee);this._initMenu();this._notify("onActivated");}});break;}});d.stop();var c=BOOMR.plugins.WS.startSpan("FastTemplate:ctor:handlers_preload:"+this.getName());$ws.helpers.forEach(this._rootConfig,function(l,i){if(i.substr(0,2)=="on"){var e=l.split("|");$ws.helpers.forEach(e,function(p,o){n._dReady.push($ws.core.getHandler(p).addCallback(function(q){n._loadedHandlers[i]=n._loadedHandlers[i]||[];n._loadedHandlers[i][o]=q;return q;}));});}});c.stop();if(this._rootConfig.style){var h=$ws.helpers.insertCss(this._rootConfig.style,true);if(h){this._dReady.push(h);}}var a=this._dom.getElementsByTagName("i");for(var f=0,b=a.length;f<b;f++){var m=a[f].getAttribute("spec");if(m){try{m=JSON.parse(m);}catch(j){m=false;}if(m){m.js&&n._dReady.push($ws.core.attachSequentally(m.js));m.css&&n._dReady.push($ws.core.attachSequentally(m.css));}}}this._dReady.done();k.stop();},isPage:function(){return !this._rootConfig.isApplication;},getConfig:function(){$ws.helpers.forEach(this._rootConfig,function(b,a){this._mergeAttrToConfig(this._configuration,a,b);},this);return this._configuration;},getStyle:function(){return this._rootConfig.windowStyle||"";},getAlignment:function(){var b=this._rootConfig.HorizontalAlignment,a=this._rootConfig.VerticalAlignment;return{horizontalAlignment:!b?"Stretch":b,verticalAlignment:!a?"Stretch":a};},getTitle:function(){return this._rootConfig.title;},createMarkup:function(a){var b=BOOMR.plugins.WS.startSpan("mkup:"+this.getName());a.html(this._dom.firstChild.innerHTML);b.stop();},getDimensions:function(){var b=this._rootConfig.width+"",a=this._rootConfig.height+"";return{width:!b?"":b.toLowerCase()==="auto"?"auto":b.indexOf("%")>=0?b:parseInt(b,10)+"px",height:!a?"":a.toLowerCase()==="auto"?"auto":a.indexOf("%")>=0?a:parseInt(a,10)+"px"};},getControls:function(a){if(a){return[];}return this._controlsConfig.children;}});$ws.proto.JSONLoader=$ws.core.extend({},{$protected:{_options:{url:"/data.php",updateURL:"",destroyURL:"",tableName:""}},load:function(b,c){var a=this._options.url;if(c==="update"&&this._options.updateURL){a=this._options.updateURL;}else{if(c==="destroy"&&this._options.destroyURL){a=this._options.destroyURL;}}if(this._options.tableName!==""){b.tableName=this._options.tableName;}return $ws.single.ioc.resolve("ITransport",{method:"POST",dataType:"json",url:a+(/\?/.test(a)?"&":"?")+"$=1"+($ws.core.debug?"&"+Math.random():"")}).execute(b);}});$ws.proto.RecordSet=$ws.proto.Abstract.extend({$constructor:function(a){if(this._goUp==1){return $ws.single.ioc.resolve("IRecordSet",a);}}});$ws.proto.ClientRecordSet=$ws.proto.RecordSet.extend({$protected:{_data:[],_columns:[],_way:null,_results:null,_requestBegin:0,_timeElapsed:0,_dataIterator:-1,_pkIndex:{},_pkColumnIndex:0,_columnsParsed:false,_lastError:false,_options:{context:"",filterParams:{},requiredParams:[],readerType:"ReaderUnifiedSBIS",readerParams:{},firstRequest:true,usePages:"",pageNum:0,rowsPerPage:2,sorting:null,waitForPrevQuery:false,hierarchyField:""},_parsedColumns:undefined,_columnIndex:{},_childRecordsMap:[],_reader:"",_hasNextPage:0,_pageNum:0,_usePages:"",_sorting:null,_loaded:true,_queryStack:[],_initialFilter:{},_currentFilter:{},_loadingId:undefined,_level:{},_newData:undefined,_loadExpanded:false,_tree:null,_shadowed:false,_treeMap:null,_loadingInfo:null,_isEmptyTable:false,_isChanged:false},$constructor:function(){this._pageNum=this._options.pageNum;this._usePages=this._options.usePages;this._options.rowsPerPage=parseInt(this._options.rowsPerPage,10);this._sorting=this._options.sorting;this._initialFilter=this._prepareFilter(this._options.filterParams);this._publish("onBeforeLoad","onAfterLoad","onRecordUpdated","onRecordDeleted","onAbort","onPageChange","onShadowLoad");this._tree=new $ws.proto.OrderedHashMap();this._clearTreeMap();if(this._options.readerType!==""&&this._options.firstRequest){this._beginLoad();}if(!(this._options.context instanceof $ws.proto.Context)){this._options.context=$ws.single.GlobalContext;}},toJSON:function(){return{s:this.getColumnsForSerialize(),d:this.getDataForSerialize()};},_onNewData:function(a,b){this._childRecordsMap=[];this._newData=b;},_clearTreeMap:function(){this._treeMap=new $ws.proto.OrderedHashMap();this._tree=new $ws.proto.OrderedHashMap();},getContext:function(){return this._options.context;},setContext:function(a){this._options.context=a;},reload:function(){var a=this._createLoadingInfo();this._beginLoad(undefined,undefined,a);return a.deferred;},setSource:function(b,f,d,c){this._options.readerType=b;this._options.readerParams=f;this._options.filterParams=d;this._reader="";var a;if(c!==false){var e=this._createLoadingInfo();this._beginLoad(undefined,true,e);a=e.deferred;}else{a=(new $ws.proto.Deferred()).callback();}return a;},getSource:function(){return{readerType:this._options.readerType,readerParams:this._options.readerParams,filterParams:this._options.filterParams};},_createLoadingInfo:function(a){return{options:a,deferred:new $ws.proto.Deferred()};},setQuery:function(c,a,b){this._options.filterParams=this._prepareFilter(c);var d=this._createLoadingInfo(b);this._beginLoad(undefined,a,d);return d.deferred;},resetFilter:function(d,b){this._options.filterParams=d||{};for(var c in this._options.requiredParams){if(this._options.requiredParams.hasOwnProperty(c)){this._options.filterParams[c]=this._initialFilter[c];}}this._currentFilter=$ws.core.merge({},this._options.filterParams);var a;if(!b){var e=this._createLoadingInfo();this._beginLoad(undefined,true,e);a=e.deferred;}else{a=(new $ws.proto.Deferred()).callback();}return a;},getQuery:function(){return this._currentFilter;},getUpdatedQuery:function(a){var c=this._options.filterParams||{};for(var b in a){if(!a.hasOwnProperty(b)){continue;}if(typeof(a[b])==="function"||(a[b] instanceof Object&&a[b]["fieldName"]!==undefined)){c[b]=a[b];}}return this._prepareFilter(c);},_prepareFilter:function(b,h,a){var j={},m=b?$ws.core.merge({},b):{},c={},f=this._options.requiredParams.length,d,k,e;for(k=0;k<f;k++){e=this._options.requiredParams[k];j[e]=true;if(!(e in m)&&!h){m[e]=this._initialFilter[e];}}for(var g in m){d=undefined;if(m.hasOwnProperty(g)){if(m[g]!==null&&typeof(m[g])==="object"&&"fieldName" in m[g]){if(this._options.context.getValue!==undefined&&!a){d=this._options.context.getValue(m[g].fieldName);}}else{if(typeof(m[g])==="function"){if(!a){d=m[g].apply(this,[this._options.context,g]);}}else{d=m[g];}}if(d!==undefined){c[g]=d;}else{if(j[g]===true&&!h){c[g]=this._initialFilter[g];}}}}if(!h){if(this._usePages){c.pageNum=this._pageNum;c.pageCount=this._options.rowsPerPage;if(this._pageNum===-1){c.usePages="full";}else{c.usePages=this._usePages;}}if(this._sorting){c.sorting=this._sorting;}}return c;},prepareFilter:function(b,a){return this._prepareFilter(b,a);},_beginLoad:function(e,b,f){var c=this;if(!this._loaded){if(this._options.waitForPrevQuery){this._queryStack.push([this._prepareFilter(this._options.filterParams),f]);return;}else{this.getReader().abort();}}var d=this._prepareFilter(e?e:this._options.filterParams);this._shadowed=d.shadowed;if(!this._shadowed){this._notify("onBeforeLoad",d,f&&f.options);}this._requestBegin=new Date();this._loaded=false;this._newData=[];if(this._options.hierarchyField){this._loadingId=d[this._options.hierarchyField];if(!(this._loadingId instanceof Array)){this._loadingId=[this._loadingId];}}else{this._loadingId=[null];}this._loadExpanded=(d["Разворот"]==="С разворотом");if(b){this._pkIndex={};this._level={};this._data=[];this._tree.clear();this._treeMap.clear();}this._loadingInfo=f;this._currentFilter=d;var a=this.getReader().readRecords(d,this._columnsParsed);if(a instanceof $ws.proto.Deferred){a.addCallback(function(){c._loaded=true;var g=c._queryStack.shift();if(g){c._beginLoad(g[0],undefined,g[1]);}});}else{this._loaded=true;}},_updateNextPage:function(b,a){if(this._pageNum===-1){this._pageNum=Math.ceil(a/this._options.rowsPerPage)-1;this._hasNextPage=false;}else{this._hasNextPage=a;}},setPage:function(c,b,e){this._pageNum=c;this._notify("onPageChange",c);var a;if(!b){var d=this._createLoadingInfo();this._beginLoad(undefined,!e,d);a=d.deferred;}else{a=(new $ws.proto.Deferred()).callback();}return a;},setPageSize:function(c,b){this._options.rowsPerPage=c;this._pageNum=0;this._notify("onPageChange",0);var a;if(!b){var d=this._createLoadingInfo();this._beginLoad(undefined,false,d);a=d.deferred;}else{a=(new $ws.proto.Deferred()).callback();}return a;},getPageSize:function(){return this._options.rowsPerPage;},setUsePages:function(a){this._pageNum=0;this._usePages=a;},hasNextPage:function(){return this._hasNextPage;},usePaging:function(){return !!this._usePages;},getPageNumber:function(){return this._pageNum;},getRecords:function(){var b=[],a=this._data.length,c=0;while(c<a){b.push(this.at(c));c++;}return b;},setSorting:function(d,c,f,b){this._sorting=d||null;var a;if(!b){var e=this._createLoadingInfo();this._beginLoad(c,!f,e);a=e.deferred;}else{a=(new $ws.proto.Deferred()).callback();}return a;},getReader:function(){if(this._reader===""){var a=$ws.core.merge({handlers:this._getReaderHandlers()},this._options.readerParams);this._reader=new $ws.proto[this._options.readerType](a);}return this._reader;},_getReaderHandlers:function(){return{onNewRecord:$ws.helpers.proxy(this._onNewRecord,this),onWayExists:$ws.helpers.proxy(this._onWayExists,this),onResults:$ws.helpers.proxy(this._onResults,this),onSettingsParsed:$ws.helpers.proxy(this._onSettingsParsed,this),onComplete:$ws.helpers.proxy(this._onComplete,this),onNewData:$ws.helpers.proxy(this._onNewData,this),onNextPageChange:$ws.helpers.proxy(this._updateNextPage,this)};},getWay:function(){return this._way;},getResults:function(){return this._results;},_onNewRecord:function(b,a){this._newData.push(a);},_onWayExists:function(d,b){if(b.d){var c={readerType:"ReaderSBIS",readerParams:{pkColumnName:b.s[b.k||0].n,adapterType:"TransportAdapterStatic",adapterParams:{data:{s:b.s,d:b.d}}}},a=this;a._way=new $ws.proto.RecordSet(c);}},isEmptyTable:function(){return this._isEmptyTable;},_onResults:function(b,a){this._results=new $ws.proto.Record({colDef:a.columns,row:a.row,pkValue:null,parentRecordSet:null});},_onSettingsParsed:function(f,a,e){var c,b=a.length,d=0;while(d<b){c=a[d].n;this._columnIndex[c]=d;d++;}if(!Object.isEmpty(a)){this._columnsParsed=true;}this._pkColumnIndex=e;this._columns=a;},isInit:function(){return this._columnsParsed;},_buildHierarchyData:function(s){var d={},j=[],n,o,g={},e,k=this,p={},a={},b,q=false,h={},t,m=function(u){var i=u[k.getColumnIdx(k._options.hierarchyField)];i=$ws.helpers.parseIdentity(i);return i;},r=function(u,i){if(u=="null"){u=null;}if(i=="null"){i=null;}return u==i;},c=function(i){i.each(function(w,u){if(!p[w]){if(u.childs){if(!d[w]){d[w]=[];}u.childs.each(function(y,x){if(r(m(x.record),w)){d[w].push(x.record);g[y]=true;}});}}if(!p[w]||!k._loadExpanded){c(u.childs);}});},f=function(i,u){i.each(function(z,y){if(!g[z]){return;}if(y.record){if(k._shadowed){j.push(y.record);}else{k._pkIndex[z]=k._data.length;k._data.push(y.record);}}k._level[z]=u;if(!y.childs){y.childs=new $ws.proto.OrderedHashMap();}if(!k._shadowed){k._treeMap.put(z,y.childs);}if(d[z]){if(!k._shadowed){if(h[z]){q=true;}h[z]=true;for(var A=0,x=d[z].length;A<x;++A){var C=d[z][A],B=$ws.helpers.parseIdentity(C[k._pkColumnIndex]),w;if(y.childs.put(B,{record:C,childs:w=new $ws.proto.OrderedHashMap()})){k._treeMap.put(B,w);}else{k._treeMap.put(B,y.childs.get(B).childs);}}h[z]=false;}if(!q){f(y.childs,u+1);}}return true;});};for(n=0,o=this._loadingId&&this._loadingId.length;n<o;++n){p[this._loadingId[n]]=true;}c(this._tree);for(n=0,o=s.length;n<o;++n){e=m(s[n]);if(!d[e]){d[e]=[];}d[e].push(s[n]);g[s[n][this._pkColumnIndex]]=true;}for(n=0,o=this._childRecordsMap.length;n<o;++n){b=this._childRecordsMap[n];if(b){a[b.getKey()]=b;}}this._data=[];this._level={};this._pkIndex={};this._clearTreeMap();for(n in d){if(d.hasOwnProperty(n)&&!g[n]){g[n]=true;var l=new $ws.proto.OrderedHashMap();this._tree.put(n,{record:undefined,childs:l});}}f(this._tree,-1);this._childRecordsMap=[];for(n=0,o=this._data.length;n<o;++n){t=this._data[n][this._pkColumnIndex];if(a[t]){this._childRecordsMap[n]=a[t];}}if(q){$ws.single.ioc.resolve("ILogger").error("RecordSet","Recursive hierarchy data");}return j;},_onComplete:function(g,b,h,a){if(b){this._parsedColumns=undefined;}var c,d=[].concat(this._newData);if(this._options.hierarchyField!==""){c=this._buildHierarchyData(this._newData);}else{if(this._shadowed){c=this._newData;}else{this._data=[];this._childRecordsMap=[];this._pkIndex={};this._level={};for(var f=0,e=this._newData.length;f<e;++f){var i=$ws.helpers.parseIdentity(this._newData[f][this._pkColumnIndex]);this._level[i]=0;this._pkIndex[i]=this._data.length;this._data.push(this._newData[f]);}}}this._newData=[];this._timeElapsed=new Date()-this._requestBegin;if(!b){this._lastError=h;}else{this._isEmptyTable=!!(a===false);}this.rewind();if(this._shadowed){this._notify("onShadowLoad",this,b,h,c);this._shadowed=false;}else{this._notify("onAfterLoad",this,b,h,this._loadingInfo&&this._loadingInfo.options);if(this._loadingInfo&&!this._loadingInfo.deferred.isReady()){this._loadingInfo.deferred.callback(d.length);}}},_produceRecord:function(a){if(a===null||a===undefined){return null;}return new $ws.proto.Record({row:a.row,colDef:a.columns,parentRecordSet:this,pkValue:$ws.helpers.parseIdentity(a.row[a.pk]),objectName:a.objectName});},createRecord:function(b,a){return this.getReader().createRecord(this._prepareFilter(b),a).addCallback($ws.helpers.proxy(this._produceRecord,this));},readRecord:function(c,a,b){if(c===undefined){$ws.single.ioc.resolve("ILogger").log("RecordSet","Не рекомендуется использовать readRecord с id === undefined, используйте createRecord.");return this.createRecord(a);}else{return this.getReader().readRecord(c,a,b).addCallback($ws.helpers.proxy(this._produceRecord,this));}},copyRecord:function(b){try{return this.getReader().copyRecord(b).addCallback($ws.helpers.proxy(this._produceRecord,this));}catch(a){return new $ws.proto.Deferred().errback(a);}},mergeRecords:function(b,d){var a=this;try{return this.getReader().mergeRecords(b,d).addCallback(function(){a.clearRecord(d);});}catch(c){return new $ws.proto.Deferred().errback(c);}},clear:function(){this._data=[];this._newData=[];this._pkIndex=[];this._level={};this._tree.clear();this._treeMap.clear();this._pageNum=0;this._notify("onPageChange",0);},clearRecord:function(c){if(this._pkIndex[c]!==undefined){if(this._options.hierarchyField){var a=this.at(this._pkIndex[c]),b,d;if(a instanceof $ws.proto.Record){b=a.get(this._options.hierarchyField);d=this._treeMap.get(b);if(d){d.remove(c);}}}this._data.splice(this._pkIndex[c],1);this._childRecordsMap.splice(this._pkIndex[c],1);this._removeKeyFromIndex(c);delete this._level[c];}},clearNode:function(h){if(this._pkIndex[h]===undefined){return[];}for(var d=this._pkIndex[h]+1,g=this._data.length,a=this._level[h];d<g;++d){if(!this._data[d]){continue;}var f=this.at(d);if(this._level[f.getKey()]>a){var k=f.getKey();this._data[d]=null;delete this._pkIndex[k];delete this._level[k];delete this._data[d];}else{break;}}var e=this._data;this._data=[];for(var c=0,b=e.length;c<b;++c){if(e[c]){this._data.push(e[c]);}}this._refreshPkIndex();},_refreshPkIndex:function(){var b;this._pkIndex={};for(var c=0,a=this._data.length;c<a;c++){b=this.at(c);if(b){this._pkIndex[b.getKey()]=c;}}},rewind:function(){this._dataIterator=-1;},isChanged:function(){if(this._isChanged===true){return true;}else{var a=false;this.each(function(b){if(b.isChanged()){a=true;return false;}});return a;}},commit:function(){this._isChanged=false;},next:function(){var b=this._data.length;while(++this._dataIterator<b){var a=this.at(this._dataIterator);if(a){return a;}}return false;},at:function(b){if(this._childRecordsMap[b]===undefined){var a=this._data[b];if(a){this._childRecordsMap[b]=new $ws.proto.Record({row:a,colDef:this._columns,parentRecordSet:this,pkValue:this._pkColumnIndex>=0?$ws.helpers.parseIdentity(a[this._pkColumnIndex]):null});}else{if(b<0||b>=this._data.length){return undefined;}else{throw new Error("No record at index "+b);}}}return this._childRecordsMap[b];},each:function(b){this.rewind();var c,a=0;while((c=this.next())!==false){if((b.apply(this,[c,a++]))===false){return;}}},getElapsedTime:function(){return this._timeElapsed;},getBeginTime:function(){return this._requestBegin;},getColumns:function(){if(Object.isEmpty(this._parsedColumns||{})){var a=this.getReader().getParser();this._parsedColumns=a.getParsedColumns(this._columns);}return this._parsedColumns;},setColumns:function(c){if(Object.prototype.toString.call(c)=="[object Object]"){this._columns=$ws.single.SerializatorSBIS.serializeCols(c);}else{this._columns=c;}var a=this._columns.length,b=0;while(b<a){this._columnIndex[this._columns[b].n]=b;b++;}},updateRecord:function(b,a){var d=b.getKey(),c=this;return this.getReader().updateRecord(b,a).addCallback(function(e){if(e!==null&&d===null){b.setKey(e,c._pkColumnIndex);}c._isChanged=true;c._notify("onRecordUpdated",b);return e;});},deleteRecord:function(c){var b=this;try{var a=this.contains(c)?this.getRecordByPrimaryKey(c):false,f=function(){b.clearRecord(c);b._isChanged=true;b._notify("onRecordDeleted",c,a);};if(c!==null){return this.getReader().deleteRecord(c).addCallback(f);}else{f();return new $ws.proto.Deferred().callback();}}catch(d){return new $ws.proto.Deferred().errback(d);}},deleteRecordsByFilter:function(c,b){var a=this;return this.getReader().deleteRecordsByFilter(c,b).addCallback(function(){a.clear();a._isChanged=true;a._notify("onRecordDeleted",null,[]);});},_removeKeyFromIndex:function(c){var b=this._pkIndex[c];delete this._pkIndex[c];for(var a in this._pkIndex){if(this._pkIndex.hasOwnProperty(a)&&this._pkIndex[a]>b){this._pkIndex[a]--;}}},getRecordCount:function(){var a=0;for(var b=this._data.length-1;b>=0;--b){if(this._data[b]){++a;}}return a;},getLastError:function(){return this._lastError;},getRecordByPrimaryKey:function(a){if(a in this._pkIndex){return this.at(this._pkIndex[a]);}throw new Error("Record with primary key "+a+" is not found");},addPkIndex:function(a){this._pkIndex[a]=this._data.length-1;},getPkColumnIndex:function(){return this._pkColumnIndex;},getColumnIdx:function(a){if(a in this._columnIndex){return this._columnIndex[a];}else{throw new TypeError("Column "+a+" is not defined");}},getDataForSerialize:function(){for(var b=0,a=this._childRecordsMap.length;b<a;b++){if(this._childRecordsMap[b]!==undefined){this._childRecordsMap[b].prepareToSerialize();}}return this._data;},getColumnsForSerialize:function(){return this._columns;},abort:function(){this.getReader().abort();this._notify("onAbort");},contains:function(a){return this._pkIndex[a]!==undefined;},loadNode:function(a,f,g,h,e,i,b){if(this._options.hierarchyField){if(!b){this._options.filterParams[this._options.hierarchyField]=a;}}var c=this._prepareFilter(this._options.filterParams);this._pageNum=(g?g:0);this._notify("onPageChange",this._pageNum);if(this._options.hierarchyField){c["Разворот"]=h?"С разворотом":"Без разворота";}c.shadowed=e;var d=this._createLoadingInfo(i);this._beginLoad(c,f,d);return d.deferred;},getLoadingId:function(){if(this._loadingId instanceof Array&&this._loadingId.length===1){return this._loadingId[0];}return this._loadingId;},getRecordLevel:function(a){return this._level[a];},getHierarchyField:function(){return this._options.hierarchyField;},setHierarchyField:function(a){if(this._options.hierarchyField!==a){this._options.hierarchyField=a;if(a){this._buildHierarchyData(this._data);}}},_importRecord:function(g){var a=false,j=g.getColumns(),h=this.getColumns(),l=[],n=Array.indexOf(j,"ctid"),i,e,d,c;for(var b in h){if(h.hasOwnProperty(b)){l[h[b].index]=b;}}if(n!==-1){j.splice(n,1);}c=j.length;if(l.length===c){for(var f=0;f<c;f++){e=j[f];d=h[e];i=g.getColumnDefinition(e);if(!d||d.type!==i.type||d.index!==i.index){a=true;break;}}}else{a=true;}g.setRecordSet(this,true);var m=g.getKey();if(!m&&m!==0){g.setKey(this._data.length,this._pkColumnIndex);}if(a===true){throw new TypeError("RecordSet:appendRecord - передана запись формата, отличного от формата набора данных. Возможны проблемы в работе с этим набором записей.");}},appendRecord:function(f){var b=this._columns,n={},g,q=[],m=b.length,k,o=this._data.length;if(f instanceof $ws.proto.Record){k=f;this._importRecord(k);q=k.getDataRow();this._childRecordsMap[o]=k;}else{$ws.single.ioc.resolve("ILogger").log("ClientRecordSet:appendRecord","Вызов данного метода с типом аргумента Object является устаревшим. Передавайте $ws.proto.Record");q=[];for(var e=0;e<m;e++){n=b[e];g=typeof(n.t)=="string"?n.t:n.t.n;if(n.n in f){q.push(this._importValueForSet(f[n.n],g));}else{q.push(null);}}k=new $ws.proto.Record({colDef:b,row:q,pkValue:$ws.helpers.parseIdentity(q[this._pkColumnIndex]),parentRecordSet:this});}this._pkIndex[k.getKey()]=o;if(k.getKey()!==null&&this._options.hierarchyField!==""){var h=k.get(this._options.hierarchyField),p=this._level[h],c;this._level[k.getKey()]=p?p+1:1;this._newData=[];var a=this._data.length,d=0;while(d<a){c=this.at(d);if(c.get(this._options.hierarchyField)==h){this._newData.push(this._data[d]);}d++;}this._newData.push(q);this._data=this._newData;this._onComplete({},true);}else{this._data.push(q);this._notify("onAfterLoad",this,true);}return this.at(o);},insertAfter:function(d,g){var k=this.contains(d)?(this._pkIndex[d]+1):0,m=g.getKey(),n=[];if(g instanceof $ws.proto.Record){n=g.getDataRow();}else{throw new Error("Не передана запись для вставки в набор данных!");}this._data.splice(k,0,n);for(var e=this._childRecordsMap.length;e>=k;e--){if(this._childRecordsMap[e]!==undefined){this._childRecordsMap[e+1]=this._childRecordsMap[e];}}this._childRecordsMap[k]=g;for(var f in this._pkIndex){if(this._pkIndex.hasOwnProperty(f)&&this._pkIndex[f]>=k){++this._pkIndex[f];}}this._pkIndex[m]=k;g.setRecordSet(this,true);if(this._options.hierarchyField){var h=this._options.hierarchyField,l=g.get(h),c;if(this._treeMap.contains(l)){c=this._treeMap.get(l);}else{c=new $ws.proto.OrderedHashMap();this._treeMap.put(l,c);}var a=d,b;while(this.contains(a)&&(b=this.getRecordByPrimaryKey(a))&&b.get(h)!=l){a=b.get(h);}if(!this.contains(a)){a=undefined;}c.insert(m,{record:n,childs:new $ws.proto.OrderedHashMap()},a);}this._notify("onAfterLoad",this,true);return g;},_importValueForSet:function(j,f){switch(f){case $ws.proto.Record.FIELD_TYPE_DATE:case $ws.proto.Record.FIELD_TYPE_DATETIME:case $ws.proto.Record.FIELD_TYPE_TIME:var g;switch(f){case"Дата и время":g=true;break;case"Время":g=false;break;}return j instanceof Date?j.toSQL(g):null;case $ws.proto.Record.FIELD_TYPE_INTEGER:return(typeof(j)=="number")?j:(isNaN(parseInt(j,10))?null:parseInt(j,10));case $ws.proto.Record.FIELD_TYPE_IDENTITY:return $ws.single.SerializatorSBIS.serializeHierarchyIdentity(j);case $ws.proto.Record.FIELD_TYPE_ENUM:var a=j.getCurrentValue();return a===null?null:parseInt(a,10);case $ws.proto.Record.FIELD_TYPE_FLAGS:if(j instanceof $ws.proto.Record){var n={},m=j.getColumns(),c=[];for(var i=0,d=m.length;i<d;i++){n[j.getColumnIdx(m[i])]=m[i];}var e=Object.sortedPairs(n),k=j.toObject();for(var h=0,b=e.keys.length;h<b;h++){c.push(k[e.values[h]]);}return c;}else{return null;}case $ws.proto.Record.FIELD_TYPE_RECORD:case $ws.proto.Record.FIELD_TYPE_QUERY:if(j===null){return null;}else{if(j instanceof $ws.proto.Record||j instanceof $ws.proto.RecordSet){return j.toJSON();}else{return $ws.single.SerializatorSBIS.serialize(j);}}case $ws.proto.Record.FIELD_TYPE_STRING:return j===null?null:j+"";case $ws.proto.Record.FIELD_TYPE_LINK:return j===null?null:parseInt(j,10);default:return j;}},updatePages:function(){var d=0;for(var c=0,b=this._data.length;c<b;++c){if(this._data[c]){++d;}}var a;if(d===0&&this._pageNum>0){a=this.setPage(this._pageNum-1,true,true);}else{a=(new $ws.proto.Deferred()).callback();}return a;},moveRecord:function(p,q,b){var l=this._treeMap.get(p),r=[],o=[[],[]],a=0,e;if(l){var f,d=function(h,c){r.push([h,l.get(h)]);r.push([c,l.get(c)]);};l.each(function(h,c){if(b){if(a===0&&h==q&&f!==undefined){o[0].pop();d(h,f);++a;}else{o[a].push([h,c]);}f=h;}else{if(h==q){f=h;}else{if(a===0&&f!==undefined){d(h,f);++a;}else{o[a].push([h,c]);}}}});this._treeMap.put(p,new $ws.proto.OrderedHashMap());for(var n=0;n<2;++n){for(var g=0,k=o[n].length;g<k;++g){e=this._treeMap.get(p);e.put.apply(e,o[n][g]);}if(n===0){for(var i=0;i<2;++i){e=this._treeMap.get(p);e.put.apply(e,r[i]);}}}}},checkHierColumn:function(b){if(this._loadingId!==undefined){var a=this._columnIndex[b];if(a===undefined){return false;}return this._columns[a].s&&this._columns[a].s==="Иерархия";}return true;},updateInitialParameter:function(a,b){this._initialFilter[a]=b;},isLoaded:function(){return this._loaded;},recordChilds:function(b){var a=[],c=this._treeMap.get(b);if(c){c.each(function(d){a.push(d);});}return a;},addColumn:function(b,h,a){if(!(b in this._columnIndex)){var f,c;var d=$ws.single.SerializatorSBIS.getColumnConfigByType(b,h,a);if(d!==false){var k=["","@","$"],g,e;for(g=0,e=d.cols.length;g<e;g++){this._columnIndex[b+k[g]]=this._columns.length;this._columns.push(d.cols[g]);}for(f=0,c=this._childRecordsMap.length;f<c;f++){if(this._childRecordsMap[f]!==undefined){this._childRecordsMap[f].addColumn(b,h,a,true,d.cols);}}for(g=0,e=d.cols.length;g<e;g++){for(f=0,c=this._data.length;f<c;f++){if(this._data[f]!==undefined){this._data[f].push(d.data[g]);}}}this._parsedColumns={};return true;}}return false;},removeColumn:function(c){if(c in this._columnIndex){var a=this.getColumnIdx(c),b,d;for(var e in this._columnIndex){if(this._columnIndex.hasOwnProperty(e)&&this._columnIndex[e]>a){this._columnIndex[e]--;}}delete this._columnIndex[c];for(b=0,d=this._data.length;b<d;b++){if(this._data[b]!==undefined){this._data[b].splice(a,1);}}this._columns.splice(a,1);for(b=0,d=this._childRecordsMap.length;b<d;b++){if(this._childRecordsMap[b]!==undefined){this._childRecordsMap[b].removeColumn(c,true);}}this._parsedColumns={};return true;}else{return false;}}});$ws.proto.FastRecordSet=$ws.proto.ClientRecordSet.extend({});$ws.proto.RecordSetStatic=$ws.proto.ClientRecordSet.extend({$protected:{_options:{defaultColumns:{},records:[],filter:undefined},_hiddenData:[],_expand:false,_parentNode:null},$constructor:function(){this._initOptions();this._initRecords();this._startLoad();},_initOptions:function(){this._columns=this._options.defaultColumns;this._hiddenData=this._options.records;},_initRecords:function(){for(var b=0;b<this._hiddenData.length;++b){this._hiddenData[b].setRecordSet(this);var a=this._hiddenData[b].getKey();this._pkIndex[a]=b;this._level[a]=0;}},_startLoad:function(){if(this._options.firstRequest){this._beginLoad();}},isInit:function(){return true;},_beginLoad:function(n,k,b){var o=this,q=[],e=[],a=this._options.filter,d=function(t){if(t===null){t="null";}for(var r=0,c=o._hiddenData.length;r<c;++r){if(o._hiddenData[r]){var s=o._hiddenData[r].get(o._options.hierarchyField);if(s===null){s="null";}if(s==t&&(!a||a(o._hiddenData[r],o._options.filterParams))){var j=o._hiddenData[r].getKey();o._level[j]=o._level[t]+1;q.push(o._hiddenData[r]);if(o._expand){d(o._hiddenData[r].getKey());}}}}};if(k){this._data=[];}if(this._options.hierarchyField){if(this._parentNode instanceof Array){this._expanded=false;}else{this._parentNode=[this._parentNode];}for(h=0;h<this._parentNode.length;++h){q=[];this._level[this._parentNode[h]]=0;d(this._parentNode[h]);e=e.concat(q);var p=false;for(g=0;g<this._data.length;++g){if(this._data[g]&&this._data[g].getKey()==this._parentNode[h]){for(var m=g+1;m<this._data.length;++m){if(this._data[m]&&this._data[m].get(this._options.hierarchyField)==this._parentNode[h]){this._data.splice(m--,1);}}this._data.splice.apply(this._data,[g+1,0].concat(q));p=true;break;}}if(!p){this._data=this._data.concat(q);}}q=this._data;}else{for(var g=0,f=this._hiddenData.length;g<f;++g){if(this._hiddenData[g]&&(!a||a(this._hiddenData[g],this._options.filterParams))){q.push(this._hiddenData[g]);}}}if(this._usePages){if(this._usePages==="parts"&&this._pageNum===-1){this._pageNum=Math.ceil(q.length/this._options.rowsPerPage)-1;}this._data=[];this._hasNextPage=(this._usePages==="full"?q.length:(q.length>(this._pageNum+1)*this._options.rowsPerPage));for(var h=this._pageNum*this._options.rowsPerPage,l=Math.min(q.length,h+this._options.rowsPerPage);h<l;++h){this._data.push(q[h]);}}else{this._data=q;}this._notify("onAfterLoad",this,true,undefined,b&&b.options);if(b&&b.deferred&&!b.deferred.isReady()){b.deferred.callback(e||this._data);}},setFilter:function(a){this._options.filter=a;},setQuery:function(a){this._expand=a["Разворот"]==="С разворотом";return $ws.proto.RecordSetStatic.superclass.setQuery.apply(this,arguments);},getColumns:function(){return $ws.core.merge({},this._options.defaultColumns);},_rebuild:function(){this._pkIndex={};this._level={};for(var c=0,a=this._hiddenData.length;c<a;++c){if(c in this._hiddenData){var b=this._hiddenData[c].getKey();this._level[b]=0;this._pkIndex[b]=c;}}},setRecords:function(a){this._hiddenData=a;this._rebuild();this._beginLoad();},addRecords:function(a){this._hiddenData=this._hiddenData.concat(a);this._rebuild();this._beginLoad();},getRecordByPrimaryKey:function(a){if(a in this._pkIndex){return this._hiddenData[this._pkIndex[a]];}throw new Error("Record with primary key "+a+" is not found");},createRecord:function(a){a=a||{};var m=new $ws.proto.Deferred(),c=this._columns,d=0;for(var f=0,g=this._hiddenData.length;f<g;++f){if(!this._hiddenData[f]){continue;}var b=this._hiddenData[f].getKey();if(d<b){d=b;}}var l=[],h=this._options.hierarchyField;for(var e in c){if(c.hasOwnProperty(e)){l[c[e].index]=null;}}l[this._pkColumnIndex]="null";if(h){var k=a[h].hierarchy;if(k){if(k[0]==="null"){k[0]=null;}l[c[h].index]=k[0];l[c[h+"@"].index]=k[1];l[c[h+"$"].index]=false;}}m.callback(new $ws.proto.Record({row:l,colDef:this._options.defaultColumns,parentRecordSet:this,pkValue:"null"}));return m;},readRecord:function(b){if(b===undefined||this._pkIndex[b]===undefined||!this._hiddenData[this._pkIndex[b]]){return this.createRecord();}var a=new $ws.proto.Deferred();a.callback(this._hiddenData[this._pkIndex[b]]);return a;},updateRecord:function(b){var c=b.getKey(),a=new $ws.proto.Deferred();if(c==="null"){b.setKey(c=this._hiddenData.length,this._pkColumnIndex);}if(this._pkIndex[c]!==undefined){this._hiddenData[this._pkIndex[c]]=b;}else{this._hiddenData.push(b);this._pkIndex[c]=this._hiddenData.length-1;}if(this._options.hierarchyField){var d=b.get(this._options.hierarchyField);this._level[c]=((d!==undefined&&this._level[d])?(this._level[d]+1):0);}else{this._level[c]=0;}this._notify("onRecordUpdated",b);this._notify("onAfterLoad",this,true);a.callback(c);return a;},addPkIndex:function(){},_deleteRecord:function(e){var a=this._pkIndex[e],c;if(a!==undefined&&a!==null){var b=this._hiddenData[a];this._hiddenData[a]=null;delete this._hiddenData[a];delete this._level[e];delete this._pkIndex[e];for(var d=0;d<this._data.length;++d){c=this.at(d);if(c&&c.getKey()==e){delete this._data[d];break;}}this._isChanged=true;this._notify("onRecordDeleted",e+"",b);return true;}return false;},deleteRecord:function(b){var a=new $ws.proto.Deferred();if(this._deleteRecord(b)){a.callback(b);}else{a.errback();}return a;},deleteRecords:function(c){for(var b=0,a=c.length;b<a;++b){this._deleteRecord(c[b]);}},loadNode:function(g,a,d,c,f,b){this._parentNode=g;this._pageNum=(d?d:0);this._notify("onPageChange",this._pageNum);this._expand=c;var e=this._createLoadingInfo(b);this._beginLoad(undefined,a,e);return e.deferred;},hasNextPage:function(){var a=this,b=function(){var d=0,f=a._options.filter;for(var e=0,c=a._hiddenData.length;e<c;++e){if(a._hiddenData[e]&&(!f||f(a._hiddenData[e],a._options.filterParams))){++d;}}return d;};if(this._usePages==="parts"){return b()>(this._pageNum+1)*this._options.rowsPerPage;}return b();},getRecordCount:function(){var b=0;for(var c=0,a=this._data.length;c<a;++c){if(this._data[c]){++b;}}return b;},_recordFromData:function(e,a){var c=this._columns,f=[];for(var b in c){if(c.hasOwnProperty(b)){var d;if(b in e){d=e[b];}else{if(c[b].index===this._pkColumnIndex){d=this._hiddenData.length+a;}else{d=null;}}f[c[b].index]=d;}}this._pkIndex[f[this._pkColumnIndex]]=this._hiddenData.length+a;return new $ws.proto.Record({colDef:c,row:f,pkValue:f[this._pkColumnIndex],parentRecordSet:this});},_importRecord:function(a){$ws.proto.RecordSetStatic.superclass._importRecord.apply(this,arguments);if(a.getKey()===undefined){a.setKey(this._hiddenData.length,this._pkColumnIndex);}},appendRecord:function(b){var a;if(b instanceof $ws.proto.Record){a=b;this._importRecord(a);}else{$ws.single.ioc.resolve("ILogger").log("RecordSet:appendRecord","Вызов данного метода с типом аргумента Object является устаревшим. Передавайте $ws.proto.Record");a=this._recordFromData(b,0);}this.addRecords([a]);return a;},at:function(a){return this._data[a];},appendData:function(d){var b=[];for(var c=0,a=d.length;c<a;++c){b.push(this._recordFromData(d[c],c));}this.addRecords(b);return b;},insertAfter:function(c,b){var a=this._pkIndex[c];if(a!==undefined&&a!==null){this._hiddenData.splice(a+1,0,b);}else{this._hiddenData.unshift(b);}this._rebuild();this._beginLoad();return b;},clear:function(){this._hiddenData=[];this._rebuild();},getRecords:function(){return this._hiddenData;},recordChilds:function(d){var b=[];for(var c=0,a=this._hiddenData.length;c<a;++c){if(this._hiddenData[c]&&this._hiddenData[c].get(this._options.hierarchyField)==d){b.push(this._hiddenData[c].getKey());}}return b;},abort:function(){this._notify("onAbort");},_buildHierarchyData:function(){},clearRecord:function(a){this._deleteRecord(a);},toJSON:function(){var a={s:[],d:[]};this.each(function(c,b){if(b===0){var d=c.toJSON();a.s=d.s;a.d.push(d.d);}else{a.d.push(c.getDataRow());}});return a;},_calcResults:function(b){var a=0;this.each(function(c){if(c.hasColumn(b)){a+=c.get(b);}});return a;},getResults:function(){var b=this.getColumns(),e=[];for(var a in b){if(b.hasOwnProperty(a)){var d=b[a],c=d.type;if(c===$ws.proto.Record.FIELD_TYPE_MONEY||c===$ws.proto.Record.FIELD_TYPE_INTEGER||c===$ws.proto.Record.FIELD_TYPE_DOUBLE){e[d.index]=this._calcResults(d.title);}}}return new $ws.proto.Record({row:e,colDef:b});}});$ws.proto.Record=function(a){return $ws.single.ioc.resolve("IRecord",a);};$ws.proto.ClientRecord=$ws.core.extend($ws.proto.Record,{$protected:{_objectName:"",_row:[],_colDef:[],_parentRecordSet:null,_pkValue:undefined,_columnIndex:{},_changedFields:[],_complexTypes:{"Флаги":true,"Перечисляемое":true,"Связь":true,"Массив":true,"Иерархия":true},_forGetValues:[],_settedValues:[],_hasSetted:false,_originalRow:false},$constructor:function(b){if(b){this._prepareData(b.row);this._colDef=b.colDef;this._parentRecordSet=b.parentRecordSet;this._pkValue=b.pkValue;this._parentId=b.parentId;this._objectName=b.objectName;this.commit();if(!b.colDef||Object.prototype.toString.call(b.colDef)=="[object Object]"){var f=$ws.single.SerializatorSBIS.serializeData(this._row,this._colDef);this._colDef=f.s;this._row=[];var g="",a=this._colDef.length,e=0;while(e<a){g=this._colDef[e].n;this._addColumnIdx(g,e);this._row.push(f.d[e]);e++;}}else{var d=this._colDef.length,c=0;while(c<d){this._addColumnIdx(this._colDef[c].n,c);c++;}}}},_addColumnIdx:function(b,a){this._columnIndex[b]=a;},toJSON:function(){this._originalRow=this._row.slice();this.prepareToSerialize();return{s:this._colDef,d:this._row};},isBranch:function(){var a=this._parentRecordSet.getHierarchyField();if(a){return this.get(a+"@");}},hasChildren:function(){var a=this._parentRecordSet.getHierarchyField();if(a){return this.get(a+"$");}},getParentKey:function(){var a=this._parentRecordSet.getHierarchyField();if(a){return this.get(a);}},_prepareData:function(a){this._row=a;},_createOriginalRow:function(e){var a=[];for(var d=0,b=e.length;d<b;d++){var c=e[d];if($ws.helpers.hasFunctionProperty(c,"valueOf")){c=c.valueOf();}a[d]=c instanceof Array?$ws.core.clone(c):c;}return a;},cloneRecord:function(b){this.prepareToSerialize();var a={row:this._row.slice(),colDef:this._colDef,pkValue:this._pkValue,objectName:this._objectName,parentRecordSet:null};if(b||b===undefined){a.parentRecordSet=this._parentRecordSet;}else{a.colDef=a.colDef.slice();}return new $ws.proto.Record(a);},addColumn:function(b,f,a,g,j){var h=["","@","$"],e,d;if(this._parentRecordSet instanceof $ws.proto.RecordSet&&this._parentRecordSet.contains(this.getKey())){if(g===true){if(j){for(e=0,d=j.length;e<d;e++){this._addColumnIdx(b+h[e],this._row.length);if(this._colDef[this._columnIndex[b]+h[e]]===undefined){this._colDef.push(j[e]);}}}else{this._addColumnIdx(b,this._row.length);}}else{throw new Error("ClientRecord:addColumn - Нельзя изменять набор колонок в записи выборки.");}}else{if(!this.hasColumn(b)){var c=$ws.single.SerializatorSBIS.getColumnConfigByType(b,f,a);if(c!==false){for(e=0,d=c.cols.length;e<d;e++){this._colDef.push(c.cols[e]);this._addColumnIdx(b+h[e],this._row.length);this._row.push(c.data[e]);}return true;}}}return false;},removeColumn:function(c,b){if(this._parentRecordSet instanceof $ws.proto.RecordSet&&b!==true&&this._parentRecordSet.contains(this.getKey())){throw new Error("Record:removeColumn - Нельзя изменять набор колонок в записи выборки.");}else{if(this.hasColumn(c)){var a=this.getColumnIdx(c);for(var d in this._columnIndex){if(this._columnIndex.hasOwnProperty(d)&&this._columnIndex[d]>a){this._columnIndex[d]--;}}delete this._columnIndex[c];this._changedFields.splice(a,1);this._forGetValues.splice(a,1);this._settedValues.splice(a,1);if(b!==true){this._row.splice(a,1);this._colDef.splice(a,1);}return true;}else{return false;}}},getDataRow:function(){this.prepareToSerialize();return this._row;},toObject:function(){var d,b={},a=this._colDef.length,c=0;while(c<a){d=this._colDef[c];b[d.n]=this.get(d.n);c++;}return b;},getColumns:function(){var c=[],d={},a=this._colDef.length,b=0;while(b<a){d=this._colDef[b];c.push(d.n);b++;}return c;},toArray:function(){var d,b=[],a=this._colDef.length,c=0;while(c<a){d=this._colDef[c];b.push(this.get(d.n));c++;}return b;},getColumnIdx:function(a){if(a in this._columnIndex){return this._columnIndex[a];}else{throw new TypeError("Column "+a+" is not defined");}},getColumnType:function(a){return this._getColumnTypeByIndex(this.getColumnIdx(a));},getColumnDefinition:function(b){var a=this.getColumnIdx(b),d={},c;d.title=this._colDef[a].n;d.index=a;c=this._colDef[a].t;if(typeof(c)=="object"){d.type=c.n;switch(c.n){case"Флаги":case"Перечисляемое":d.s=c.s;break;case"Связь":d.table=c.t;break;case"Массив":d.arrayType=c.t;break;default:break;}}else{d.type=c;if(this._colDef[a].s=="Иерархия"){d.s="Иерархия";}}return d;},hasColumn:function(a){return a in this._columnIndex;},getRecordSet:function(){return this._parentRecordSet;},setRecordSet:function(a,b){if(a!=this._parentRecordSet&&b){this._colDef=this._colDef.slice();}if(!this._parentRecordSet||b){this._parentRecordSet=a;}},getKey:function(){if(typeof this._pkValue=="number"||(typeof this._pkValue=="string"&&this._pkValue.indexOf($ws._const.IDENTITY_SPLITTER)==-1)){if(this._objectName){return this._pkValue+$ws._const.IDENTITY_SPLITTER+this._objectName;}}return this._pkValue;},getComplexKey:function(){return $ws.helpers.parseComplexKey(this.getKey());},_importValueForGet:function(i,f,c){switch(f){case $ws.proto.Record.FIELD_TYPE_DATE:case $ws.proto.Record.FIELD_TYPE_DATETIME:case $ws.proto.Record.FIELD_TYPE_TIME:var b=Date.fromSQL(i),g;switch(f){case"Дата и время":g=true;break;case"Время":g=false;break;}b.setSQLSerializationMode(g);return b;case $ws.proto.Record.FIELD_TYPE_IDENTITY:return $ws.helpers.parseIdentity(i);case $ws.proto.Record.FIELD_TYPE_ENUM:return new $ws.proto.Enum({availableValues:c.s,currentValue:i});case $ws.proto.Record.FIELD_TYPE_FLAGS:var l={},a=Object.sortedPairs(c.s),k=[];for(var j=0,h=a.keys.length;j<h;j++){l[j]={type:"Логическое",title:a.values[j],index:a.keys[j]};k[j]=i[j];}return new $ws.proto.Record({row:k,colDef:l,parentRecordSet:null,pkValue:null});case $ws.proto.Record.FIELD_TYPE_RECORD:if(i===null){return null;}else{return new $ws.proto.Record({row:i.d,colDef:i.s,parentRecordSet:null,pkValue:null});}case $ws.proto.Record.FIELD_TYPE_QUERY:if(i===null){return null;}else{var e=[],m=[];if(Object.prototype.toString.call(i)=="[object Object]"){e=i.d||[];m=i.s||[];}return new $ws.proto.RecordSet({readerParams:{adapterType:"TransportAdapterStatic",adapterParams:{data:{d:e,s:m}}}});}default:return i===undefined?null:i;}},_importValueForSet:function(j,f){switch(f){case $ws.proto.Record.FIELD_TYPE_DATE:case $ws.proto.Record.FIELD_TYPE_DATETIME:case $ws.proto.Record.FIELD_TYPE_TIME:var g;switch(f){case"Дата и время":g=true;break;case"Время":g=false;break;}return j instanceof Date?j.toSQL(g):null;case $ws.proto.Record.FIELD_TYPE_INTEGER:return(typeof(j)=="number")?j:(isNaN(parseInt(j,10))?null:parseInt(j,10));case $ws.proto.Record.FIELD_TYPE_IDENTITY:return $ws.single.SerializatorSBIS.serializeHierarchyIdentity(j);case $ws.proto.Record.FIELD_TYPE_ENUM:if(j instanceof $ws.proto.Enum){var a=j.getCurrentValue();return a===null?null:parseInt(a,10);}else{return j;}case $ws.proto.Record.FIELD_TYPE_FLAGS:if(j instanceof $ws.proto.Record){var n={},m=j.getColumns(),c=[];for(var i=0,d=m.length;i<d;i++){n[j.getColumnIdx(m[i])]=m[i];}var e=Object.sortedPairs(n),k=j.toObject();for(var h=0,b=e.keys.length;h<b;h++){c.push(k[e.values[h]]);}return c;}else{return null;}case $ws.proto.Record.FIELD_TYPE_RECORD:case $ws.proto.Record.FIELD_TYPE_QUERY:if(j===null){return null;}else{if(j instanceof $ws.proto.Record||j instanceof $ws.proto.RecordSet){return j.toJSON();}else{return $ws.single.SerializatorSBIS.serialize(j);}}case $ws.proto.Record.FIELD_TYPE_STRING:return j===null?null:j+"";case $ws.proto.Record.FIELD_TYPE_LINK:return j===null?null:parseInt(j,10);default:return j;}},get:function(c){var a=this._columnIndex[c],d,b,e;if(a===undefined){throw new TypeError("Column "+c+" is not defined");}else{if(this._hasSetted&&this._settedValues[a]!==undefined){e=this._settedValues[a];}else{if(this._forGetValues[a]!==undefined){d=this._colDef[a].t;b=typeof(d)=="object"?d.n:d;e=this._forGetValues[a];}}if(e===undefined){d=this._colDef[a].t;b=typeof(d)=="object"?d.n:d;e=this._row[a];if(e!==null||b in {"Перечисляемое":0,"Запись":0,"Выборка":0}){e=this._importValueForGet(e,b,d);}this._forGetValues[a]=e;}return e;}},_isValueEqual:function(b,a){if(b===a){return true;}if(b instanceof Array&&a instanceof Array){if(b.length===a.length){for(var c=0;c<b.length;++c){if(b[c]!==a[c]){return false;}}return true;}}return false;},_setField:function(c,g){var a=this._columnIndex[c];if(a===undefined){throw new TypeError("Column "+c+" is not defined");}else{if(g===undefined){throw new TypeError("Value for column "+c+" is not valid");}else{var d=true;if(this._settedValues[a]===undefined){var f=this._colDef[a].t,b=typeof(f)=="object"?f.n:f,e=this._importValueForSet(g,b);if(this._isValueEqual(e,this._row[a])){d=false;}}if(d){this._hasSetted=true;this._settedValues[a]=g;this._changedFields[a]=g!==this._row[a];}}}},_setInnerField:function(c,f){try{var a=this.getColumnIdx(c),d=this._colDef[a].t,b=typeof(d)=="object"?d.n:d;f=this._importValueForSet(f,b);this._row[a]=f;return true;}catch(g){}return false;},_getColumnTypeByIndex:function(a){var b=this._colDef[a].t;if(typeof(b)=="string"){return b;}else{return b.n;}},prepareToSerialize:function(){var a=this._forGetValues.length,c=0,b=this,h=function(j,i){j=parseInt(j,10);i=parseInt(i,10);return j<i?-1:1;},g,e;while(c<a){if(this._forGetValues.hasOwnProperty(c)){g=this._forGetValues[c];e=this._getColumnTypeByIndex(c);if(e==$ws.proto.Record.FIELD_TYPE_FLAGS&&g instanceof $ws.proto.Record){this._row[c]=[];var f=Object.keys(this._colDef[c].t.s).sort(h);$ws.helpers.forEach(f,function(j,i){b._row[c][i]=g.get(b._colDef[c].t.s[j]);});}else{if(g instanceof $ws.proto.Record||g instanceof $ws.proto.RecordSet){this._row[c]=g.toJSON();}else{if(g instanceof $ws.proto.Enum){var d=g.getCurrentValue();this._row[c]=(d===null?null:parseInt(d,10));}}}}c++;}for(c=0,a=this._colDef.length;c<a;++c){e=this._colDef[c].t;if(e===$ws.proto.Record.FIELD_TYPE_IDENTITY&&!(this._row[c] instanceof Array)){this._row[c]=[this._row[c]];}}a=this._settedValues.length;c=0;while(c<a){if(this._settedValues[c]!==undefined){this._setInnerField(this._colDef[c].n,this._settedValues[c]);}c++;}},set:function(a,c){if(typeof(a)!="object"){this._setField(a,c);}else{for(var b in a){this._setField(b,a[b]);}}},getKeyField:function(){var a;if(this._parentRecordSet){a=this._parentRecordSet.getPkColumnIndex();}else{a=0;}return this._colDef[a].n;},setKey:function(b,a){var c=(a===undefined?this.getKeyField():this._colDef[a].n);if(c){this._setField(c,b);}this._pkValue=b;if(this._parentRecordSet){this._parentRecordSet.addPkIndex(b);}if(!this._objectName){this._objectName=$ws.helpers.parseComplexKey(b).objName;}},destroy:function(){return this._parentRecordSet.deleteRecord(this._pkValue);},update:function(a){var b=this;return this._parentRecordSet.updateRecord(this,a).addCallback(function(c){b.commit();return c;});},commit:function(){var a=this._forGetValues.length,b=0,d,e;this._changedFields=[];var c=function(g,f){if(g!==undefined){if($ws.helpers.hasFunctionProperty(g,"commit")){g.commit();}d=this._colDef[f];e=typeof(d.t)=="string"?d.t:d.t.n;this._row[f]=this._importValueForSet(g,e);}};while(b<a){c.apply(this,[this._forGetValues[b],b]);b++;}a=this._settedValues.length;b=0;while(b<a){c.apply(this,[this._settedValues[b],b]);b++;}this._originalRow=undefined;},_rewriteLinkId:function(a){if(this._objectName){if((""+a).indexOf($ws._const.IDENTITY_SPLITTER)==-1){a=a+$ws._const.IDENTITY_SPLITTER+this._objectName;}}return a;},updateLink:function(c,b){var a=this;return this.readLink(this._rewriteLinkId(c),b).addCallback(function(d){d.each(function(f,h){try{a.set(f,h);}catch(g){}});return d;});},readLink:function(b,a){return this._parentRecordSet.readRecord(this._rewriteLinkId(b),undefined,a);},rollback:function(){this._changedFields=[];this._settedValues=[];this._forGetValues=[];if(this._originalRow){this._row=this._originalRow;this._originalRow=undefined;}},isChanged:function(f){var e=function(g){if(g&&typeof(g.isChanged)=="function"&&g.isChanged()){return true;}return false;};if(f===undefined){for(var d=0,c=this._changedFields.length;d<c;d++){if(this._changedFields[d]){return true;}}var b=function(h){for(var j=0,g=h.length;j<g;j++){if(e(h[j])){return true;}}return false;};if(b(this._settedValues)){return true;}if(b(this._forGetValues)){return true;}return false;}else{var a=this.getColumnIdx(f);if(this._changedFields[a]===true){return true;}if(e(this._settedValues[a])){return true;}if(e(this._forGetValues[a])){return true;}else{return false;}}},each:function(d){var a=this._colDef.length,c;for(var b=0;b<a;b++){if(b in this._colDef){c=this._colDef[b].n;if(d.apply(this,[c,this.get(c)])===false){return;}}}},equals:function(b){if(b instanceof $ws.proto.Record){if(this.getColumns().length!==b.getColumns().length){return false;}var a=true;this.each(function(d,c){if(!b.hasColumn(d)){return(a=false);}if(c&&c.equals){if(!c.equals(b.get(d))){return(a=false);}}else{if(c!==b.get(d)){return(a=false);}}});return a;}else{return false;}}});$ws.proto.FastRecord=$ws.proto.ClientRecord.extend({});$ws.proto.Record.FIELD_TYPE_QUERY="Выборка";$ws.proto.Record.FIELD_TYPE_RECORD="Запись";$ws.proto.Record.FIELD_TYPE_INTEGER="Число целое";$ws.proto.Record.FIELD_TYPE_STRING="Строка";$ws.proto.Record.FIELD_TYPE_TEXT="Текст";$ws.proto.Record.FIELD_TYPE_DOUBLE="Число вещественное";$ws.proto.Record.FIELD_TYPE_MONEY="Деньги";$ws.proto.Record.FIELD_TYPE_DATE="Дата";$ws.proto.Record.FIELD_TYPE_DATETIME="Дата и время";$ws.proto.Record.FIELD_TYPE_TIME="Время";$ws.proto.Record.FIELD_TYPE_ARRAY="Массив";$ws.proto.Record.FIELD_TYPE_BOOLEAN="Логическое";$ws.proto.Record.FIELD_TYPE_HIERARCHY="Иерархия";$ws.proto.Record.FIELD_TYPE_IDENTITY="Идентификатор";$ws.proto.Record.FIELD_TYPE_ENUM="Перечисляемое";$ws.proto.Record.FIELD_TYPE_FLAGS="Флаги";$ws.proto.Record.FIELD_TYPE_LINK="Связь";$ws.proto.Record.FIELD_TYPE_BINARY="Двоичное";$ws.proto.Record.FIELD_TYPE_UUID="UUID";$ws.proto.ReaderAbstract=$ws.proto.Abstract.extend({$protected:{_parser:null,_options:{parserType:"ParserAbstract",adapterType:"",adapterParams:{}},_nullable:{format:undefined},_adapter:""},$constructor:function(){var a=this._options.adapterType;this._publish(["onNewRecord","onSettingsParsed","onComplete","onWayExists","onResults","onNextPageChange"]);if(a===""){throw new Error("Adapter type is not specified");}if(!(a in $ws.proto)||typeof($ws.proto[a])!=="function"){throw new Error("Adapter of wronng type specified");}this._parser=this._getParser();},_getParser:function(){return new $ws.proto[this._options.parserType](this._getParserCfg());},getParser:function(){if(this._parser===null){return this._getParser();}else{return this._parser;}},_getParserCfg:function(){var c=this,b={},f=["onNewRecord","onSettingsParsed","onComplete","onWayExists","onResults"];for(var e=0,a=f.length;e<a;e++){var d=f[e];b[d]=function(g){arguments[0]=g._eventName;c._notify.apply(c,arguments);};}return{handlers:b};},getAdapter:function(b,a){if(this._adapter===""){this._adapter=new $ws.proto[this._options.adapterType]($ws.core.merge({},this._options.adapterParams));}return this._adapter;},readRecords:function(c,a){var b=this;return this.getAdapter().list(this._makeArgsForQuery(c)).addCallbacks(function(d){if(d){b._notify("onNextPageChange",d.n);b._onLoaderDone(d,a);return d;}else{var f=new Error("Reader error : data is null");b._notify("onComplete",false,f);return f;}},function(d){b._notify("onComplete",false,d);return d;});},createRecord:function(b,a){return this.getAdapter().create(this._makeArgsForCreate(b,a===undefined?this._options.format:a)).addCallback($ws.helpers.proxy(this._parser.readRecord,this._parser));},readRecord:function(c,a,b){return this.getAdapter("read",arguments).read(this._makeArgsForRead(c,a===undefined?this._options.format:a,b)).addCallback($ws.helpers.proxy(this._parser.readRecord,this._parser));},copyRecord:function(a){return this.getAdapter("copy",arguments).copy(this._makeArgsForCopy(a)).addCallback($ws.helpers.proxy(this._parser.readRecord,this._parser));},deleteRecord:function(a){return this.getAdapter("destroy",arguments).destroy(this._makeArgsForDestroy(a));},mergeRecords:function(a,b){return this.getAdapter("merge",arguments).merge(this._makeArgsForMergeRecords(a,b));},updateRecord:function(b,a){return this.getAdapter("update",arguments).update(this._makeArgsForUpdate(b,a));},deleteRecordsByFilter:function(b,a){return this.getAdapter("destroyByFilter",arguments).destroyByFilter(this._makeArgsForDestroyByFilter(b,a));},_onLoaderDone:function(c,a){var f=false,b;try{this._parser.parseData(c,a);f=true;}catch(d){b=d.message;$ws.single.ioc.resolve("ILogger").error("Reader","Parser ("+this._options.parserType+") parseData ends with error: "+b,d);}this._notify("onComplete",f,b,c.e);},parseData:function(b,a){this._columnsParser(b);if(b.p){this._notify("onWayExists",b.p);}if(b.r){this._notify("onResults",this.readRecord(b.r));}this._dataParser(b);},_columnsParser:function(b){var a=this._columnsParseFnc(b);this._notify("onSettingsParsed",this._transformColumns(a.settings),a.pk);},_columnsParseFnc:function(a){throw new Error("Method AbstractReader::_columnsParseFnc must be implemented");},_dataParser:function(a){throw new Error("Method AbstractReader::_dataParser must be implemented");},_makeArgsForQuery:function(a){return a;},_makeArgsForCreate:function(b,a){throw new Error("Method AbstractReader::_makeArgsForCreate must be implemented");},_makeArgsForDestroyByFilter:function(b,a){throw new Error("Method AbstractReader::_makeArgsForDestroyByFilter must be implemented");},_makeArgsForMergeRecords:function(a,b){throw new Error("Method AbstractReader::_makeArgsForMergeRecords must be implemented");},_makeArgsForCopy:function(a){throw new Error("Method AbstractReader::_makeArgsForCopy must be implemented");},_makeArgsForDestroy:function(a){throw new Error("Method AbstractReader::_makeArgsForDestroy must be implemented");},_makeArgsForUpdate:function(b,a){throw new Error("Method AbstractReader::_makeArgsForUpdate must be implemented");},_makeArgsForRead:function(b,a,c){throw new Error("Method AbstractReader::_makeArgsForRead must be implemented");},abort:function(){this.getAdapter().abort();}});$ws.proto.ReaderSBIS=$ws.proto.ReaderAbstract.extend({$protected:{_pkColumnName:"pk",_options:{parserType:"ParserSBIS",linkedObject:"",pkName:"id"}},$constructor:function(){this._publish("onNewData");this._parser.subscribe("onDataParsed",$ws.helpers.proxy(this._onDataParsed,this));},_extractPlainKey:function(b){var c=$ws.helpers.parseComplexKey(b).objKey;var a=Number(c);return isNaN(a)?b:a;},_extractObjectName:function(a){return $ws.helpers.parseComplexKey(a).objName;},_prepareFilter:function(c){var a={d:[],s:[]};if(c){for(var b in c){if(b=="pageNum"||b=="pageCount"||b=="usePages"||b=="sorting"){continue;}if(c.hasOwnProperty(b)&&c[b]!==undefined){var d=$ws.proto.ReaderSBIS.serializeParameter(b,c[b]);if(c[b] instanceof Object&&c[b].hasOwnProperty("hierarchy")){a.d=a.d.concat(d.d);a.s=a.s.concat(d.s);}else{a.d.push(d.d);a.s.push({n:b,t:d.s});}}}}return a;},prepareFilter:function(a){return this._prepareFilter(a);},_prepareSorting:function(d){if(!d||d.sorting===undefined){return null;}var b={s:[{n:"n",t:"Строка"},{n:"o",t:"Логическое"},{n:"l",t:"Логическое"}],d:[]};for(var a=d.sorting.length,c=0;c<a;++c){b.d.push([d.sorting[c][0],d.sorting[c][1],!d.sorting[c][1]]);}return b;},_prepareNavigation:function(a){if(!a||a.pageNum===undefined||a.pageCount===undefined||!a.usePages){return null;}return{s:[{n:"Страница",t:"Число целое"},{n:"РазмерСтраницы",t:"Число целое"},{n:"ЕстьЕще",t:"Логическое"}],d:[a.pageNum,a.pageCount,a.usePages=="parts"||a.usePages=="auto"]};},_makeArgsForQuery:function(a){return{"ДопПоля":[],"Фильтр":this._prepareFilter(a),"Сортировка":this._prepareSorting(a),"Навигация":this._prepareNavigation(a)};},_makeArgsForCreate:function(b,a){if(a===undefined){a=this._options.queryName||"null";if(a!="null"){a=this._options.dbScheme+this._options.linkedObject+"."+a;}}return{"Фильтр":this._prepareFilter(b),"ИмяМетода":a};},_makeArgsForUpdate:function(c,b){var a={"Запись":$ws.single.SerializatorSBIS.serialize(c)};if(b===true){a["Проверка"]=true;}return a;},_makeArgsForRead:function(c,a,d){if(a===undefined){a=this._options.queryNameForRead||this._options.queryName||"null";if(a!="null"&&a!="БазовоеРасширение"){a=this._options.dbScheme+this._options.linkedObject+"."+a;}}var b={"ИдО":this._extractPlainKey(c),"ИмяМетода":a};if(d){b["Связь"]=d;}return b;},_makeArgsForMergeRecords:function(a,b){return{"ИдО":this._extractPlainKey(a),"ИдОУд":this._preparePlainKeys(b)};},_makeArgsForCopy:function(a){return{"ИдО":this._extractPlainKey(a)};},_makeArgsForDestroy:function(a){return{"ИдО":this._preparePlainKeys(a)};},_makeArgsForDestroyByFilter:function(b,a){if(a===undefined){a=this._options.dbScheme+this._options.linkedObject+"."+this._options.queryName;}return{"ИмяМетода":a,"Фильтр":this._prepareFilter(b)};},_preparePlainKeys:function(d){if(d instanceof Array){var b=[];for(var c=0,a=d.length;c<a;c++){b.push(this._extractPlainKey(d[c]));}return b;}else{return this._extractPlainKey(d);}},deleteRecord:function(a){return $ws.proto.ReaderSBIS.superclass.deleteRecord.apply(this,arguments).addCallback(function(b){if(b!==true){return new Error("Запись не удалена.");}else{return b;}});},_onDataParsed:function(a,b){this._notify("onNewData",b);}});$ws.proto.ReaderSimple=$ws.proto.ReaderAbstract.extend({$protected:{_options:{parserType:"ParserSimple",pkColumnName:"id"}},readRecords:function(c,a){var b=this;this.getAdapter().list(this._makeArgsForQuery(c)).addCallbacks(function(d){b._onLoaderDone(d,a);return d;},function(d){b._notify("onComplete",false,d);return d;});},_getParserCfg:function(){var a=$ws.proto.ReaderSimple.superclass._getParserCfg.apply(this,arguments);a.pkColumnName=this._options.pkColumnName;return a;},_makeArgsForDestroy:function(a){return{pk:a,pkColumn:this._options.pkColumnName};},_makeArgsForUpdate:function(a){return{pk:a.get(this._options.pkColumnName),pkColumn:this._options.pkColumnName,row:a.toObject()};}});$ws.proto.ReaderUnifiedSBIS=$ws.proto.ReaderSBIS.extend({$protected:{_options:{parserType:"ParserSBIS",linkedObject:"",dbScheme:"",adapterType:"TransportAdapterRPCJSON",queryName:"Список",readMethodName:"Прочитать",createMethodName:"Создать",updateMethodName:"Записать",destroyMethodName:"Удалить",otherUrl:false,queryNameForRead:null}},$constructor:function(){this._options.adapterParams=$ws.core.merge({serviceUrl:this._options.otherUrl?this._options.otherUrl:$ws._const.defaultServiceUrl,createMethodName:this._options.dbScheme+this._options.linkedObject+"."+this._options.createMethodName,listMethodName:this._options.dbScheme+this._options.linkedObject+"."+this._options.queryName,updateMethodName:this._options.dbScheme+this._options.linkedObject+"."+this._options.updateMethodName,destroyMethodName:this._options.dbScheme+this._options.linkedObject+"."+this._options.destroyMethodName,mergeMethodName:this._options.dbScheme+this._options.linkedObject+".Объединить",copyMethodName:this._options.dbScheme+this._options.linkedObject+".Копировать",readMethodName:this._options.dbScheme+this._options.linkedObject+"."+this._options.readMethodName},this._options.adapterParams||{});},getAdapter:function(h,c){var d,b,g={read:".Прочитать",copy:".Копировать",destroy:".Удалить",update:".Записать",merge:".Объединить"};switch(h){case"copy":case"destroy":case"read":d=this._extractObjectName(c[0]);break;case"update":d=this._extractObjectName(c[0].getKey());break;case"merge":var f=this._extractObjectName(c[0]);var e=this._extractObjectName(c[1]);if(f==e){d=f;}else{return{merge:function(){return new $ws.proto.Deferred().errback("Невозможно объединить записи различных типов ("+f+", "+e+")");}};}break;}if(d){if(this._options.linkedObject==d){BOOMR.plugins.WS.reportEvent("ReaderUnifiedSBIS",'Составной ключ указывает на базовый объект для "'+d+'"');}b=$ws.core.merge({},this._options.adapterParams);if(this._options.linkedObject!=d){for(var a in g){if(g.hasOwnProperty(a)){if(this._options[a+"MethodName"]!=g[a].substr(1)){BOOMR.plugins.WS.reportEvent("ReaderUnifiedSBIS",'Составной ключ на объекте "'+this._options.linkedObject+'".Замена метода "'+this._options[a+"MethodName"]+'" на "'+(d+g[a])+'"');}b[a+"MethodName"]=d+g[a];}}}b.objectName=d;return new $ws.proto[this._options.adapterType](b);}return $ws.proto.ReaderUnifiedSBIS.superclass.getAdapter.apply(this,arguments);}});$ws.proto.FastReaderUnifiedSBIS=$ws.proto.ReaderUnifiedSBIS.extend({});$ws.proto.ReaderSBIS.serializeParameter=function(g,f){var c={d:null,s:null};if(f instanceof Array){c.s={n:"Массив",t:"Текст"};for(var b=0,a=f.length;b<a;b++){f[b]=(f[b]==="null"||f[b]===undefined||f[b]===null)?null:f[b].toString();}c.d=f;}else{if(f instanceof Date){c.d=f.toSQL(null);c.s="Строка";}else{if(f instanceof $ws.proto.Enum){c.d=f.getCurrentValue()+"";c.s="Строка";}else{if(f instanceof Object&&f.hierarchy!==undefined){c.d=[$ws.single.SerializatorSBIS.serializeHierarchyIdentity(f.hierarchy[0]),f.hierarchy[1],null];c.s=[{n:"Раздел",t:"Идентификатор",s:"Иерархия"},{n:"Раздел@",t:"Логическое",s:"Иерархия"},{n:"Раздел$",t:"Логическое",s:"Иерархия"}];}else{if(f instanceof Object){var e;c.d={d:[],s:[]};c.s="Запись";for(var d in f){if(f.hasOwnProperty(d)){e=$ws.proto.ReaderSBIS.serializeParameter(d,f[d]);c.d.d.push(e.d);c.d.s.push({n:d,t:e.s});}}}else{if(typeof f=="boolean"){c.d=f;c.s="Логическое";}else{c.d=(f===null)?null:(""+f);c.s="Строка";}}}}}}return c;};$ws._const.returnType={RECORD:"returnRecord",RECORD_SET:"returnRecordSet"};$ws.proto.ParserAbstract=$ws.proto.Abstract.extend({$protected:{_cols:null,_rows:[]},$constructor:function(){this._publish(["onWayExists","onResults","onSettingsParsed","onNewRecord"]);},parse:function(g,f){var d=this,a;if(g===null){return null;}this._rows=[];var c=this._columnsParseFnc(g);this._cols=c.settings;switch(f){case $ws._const.returnType.RECORD:a=new $ws.proto.Record({row:g.d,colDef:this._cols,pkValue:g.d[c.pk||0]});break;case $ws._const.returnType.RECORD_SET:var h=[];for(var e=0,b=g.d.length;e<b;e++){h=g.d[e];this._rows.push(new $ws.proto.Record({row:h,colDef:d._cols,pkValue:h[c.pk||0]}));}a=new $ws.proto.RecordSetStatic({defaultColumns:this._cols,records:this._rows});break;}return a;},parseData:function(b,a){this._columnsParser(b);if(b.p){this._notify("onWayExists",b.p);}if(b.r){this._notify("onResults",this.readRecord(b.r));}this._dataParser(b);},_columnsParser:function(b){var a=this._columnsParseFnc(b);this._notify("onSettingsParsed",this._transformColumns(a.settings),a.pk);},_columnsParseFnc:function(a){throw new Error("Method AbstractReader::_columnsParseFnc must be implemented");},_dataParser:function(a){throw new Error("Method AbstractReader::_dataParser must be implemented");},_transformColumns:function(e){var b={},a=e.length,d;for(var c=0;c<a;c++){if(e[c].s&&e[c].s=="Иерархия"){b[e[c].n]={type:e[c].t,title:e[c].n,s:e[c].s,index:c};}else{if(typeof(e[c].t)=="object"){d=e[c].t;if(d.n=="Связь"){b[e[c].n]={type:d.n,title:e[c].n,table:d.t,index:c};}else{if(d.n=="Массив"){b[e[c].n]={type:d.n,title:e[c].n,arrayType:d.t,index:c};}else{if(d.n=="Перечисляемое"||d.n=="Флаги"){b[e[c].n]={type:d.n,title:e[c].n,s:d.s,index:c};}}}}else{b[e[c].n]={type:e[c].t,title:e[c].n,index:c};}}}return b;},getParsedColumns:function(a){a=this._columnsParseFnc({s:a,d:[]});return this._transformColumns(a.settings);},readRecord:function(e){if(e===null){return null;}var d=this._columnsParseFnc(e),h=d.settings,b=d.pk,g=h.length,c=[],j=this._dataParser(e);for(var f=0;f<g;f++){if(h[f].s&&h[f].s=="Иерархия"){if(h[f].t=="Логическое"){c[f]={t:h[f].t,n:h[f].n,s:h[f].s};}else{c[f]={t:h[f].t,n:h[f].n,b:h[f].b,f:h[f].f,s:h[f].s};}}else{if(h[f].t=="Связь"||h[f].t=="Массив"){c[f]={t:h[f].t,n:h[f].n,s:h[f].s};}else{c[f]={t:h[f].t,n:h[f].n};}}}var a={columns:this._transformColumns(c),row:j,pk:b};if(e.objectName){a.objectName=e.objectName;}return a;}});$ws.proto.ParserSimple=$ws.proto.ParserAbstract.extend({$protected:{_options:{pkColumnName:"id"}},_columnsParseFnc:function(f){var c=-1,e=[],g={int2:"Число целое",int4:"Число целое",int8:"Число целое",integer:"Число целое",smallint:"Число целое",bigint:"Число целое",decimal:"Число вещественное",numeric:"Число вещественное",real:"Число вещественное","double":"Число вещественное",money:"Деньги",date:"Дата",timestamp:"Дата и время",time:"Время","boolean":"Логическое",character:"Символ",varchar:"Строка",text:"Текст",bytea:"Двоичное"};for(var b=0,a=f.cols.length;b<a;b++){var d=f.cols[b].type.replace(/\([^\)]*\)/,"");if(f.cols[b].name==this._options.pkColumnName){c=b;}e.push({n:f.cols[b].name,t:d in g?d:"Строка"});}if(c==-1){throw new ReferenceError("Requested pkColumnName = '"+this._options.pkColumnName+"' which is not found");}return{settings:e,pk:c};},_dataParser:function(c){for(var b=0,a=c.data.length;b<a;b++){this._notify("onNewRecord",c.data[b]);}}});$ws.proto.ParserSBIS=$ws.proto.ParserAbstract.extend({$constructor:function(){this._publish("onDataParsed","onNewData");},_columnsParseFnc:function(d){var c,a=0;if("s" in d){for(var b=0;b<d.s.length;b++){if(!d.s.hasOwnProperty(b)){continue;}if("k" in d&&d.k==d.s[b].n){c=a;}a++;}if(c===undefined&&d.k=="-1"){c=-1;}return{settings:d.s,pk:c||0};}},_dataParser:function(A){var k=false,e=A.d[0];if(A.s&&A.s.length===0){return[];}if(typeof A.s[0].t=="object"){if(A.s[0].t.n=="Массив"||A.s[0].t.n=="Флаги"){e=e&&e[0]||null;}}else{if(A.s[0].t=="Идентификатор"){e=e&&e[0]===null?[null]:(e&&e[0]||null);}}if(e!==undefined&&!(e instanceof Array)){k=true;A.d=[A.d];}for(var v=0,t=A.d.length;v<t;v++){var d=[];for(var u=0,w=A.d[v].length;u<w;u++){var n=A.s[u].s&&A.s[u].s==="Иерархия"?A.s[u]:A.s[u].t,a=A.d[v][u];if(typeof(n)==="object"&&n!==null){var c=n.n;if(n.s&&n.s==="Иерархия"){c="Иерархия";}else{for(var g in n){var q={"Флаги":0,"Запись":0,"Связь":0,"Перечисляемое":0,"Массив":0};if(g in q){c=g;}}}var f=n.s||n[c];if(c=="Флаги"){var r={},B=Object.sortedPairs(f),b=[];for(var p=0,m=B.keys.length;p<m;p++){r[B.values[p]]={type:"Логическое",title:B.values[p],index:B.keys[p]};b[B.keys[p]]=a===null?null:a[p];}d.push(new $ws.proto.Record({row:b,colDef:r,parentRecordSet:null,pkValue:null}));}else{if(c==="Связь"||c==="Массив"){d.push(a);}else{if(c==="Перечисляемое"){d.push(new $ws.proto.Enum({availableValues:f,currentValue:a}));}else{if(c=="Иерархия"){d.push(!(n.n.substr(n.n.length-1,1) in {"@":true,"$":true})?$ws.helpers.parseIdentity(a):a);}else{if(c==="Запись"){var h={d:a,s:f};d.push(new $ws.proto.Record({row:this._dataParser(h),colDef:this._transformColumns(f)}));}}}}}}else{if(n==="Идентификатор"){d.push($ws.helpers.parseIdentity(a));}else{if(n==="Запись"){if(a!==null){var o=this._columnsParseFnc(a);d.push(new $ws.proto.Record({row:this._dataParser(a),colDef:this._transformColumns(o.settings)}));}else{d.push(null);}}else{if((n in {"Дата":0,"Время":0,"Дата и время":0,timestamp:0,date:0})&&a!==null){var x=Date.fromSQL(a),z=undefined;switch(n){case"Дата и время":z=true;break;case"Время":z=false;break;}x.setSQLSerializationMode(z);d.push(x);}else{if(n=="Выборка"){if(a!==null){d.push(new $ws.proto.RecordSet({readerType:"ReaderSBIS",readerParams:{adapterType:"TransportAdapterStatic",adapterParams:{data:{d:a.d,s:a.s}}}}));}else{d.push(null);}}else{d.push(a);}}}}}}if(k){A.d=A.d[0];return d;}else{this._notify("onNewRecord",d);}}},parseData:function(b,a){this._notify("onSettingsParsed",b.s,this._columnsParseFnc(b).pk);if(b.p){this._notify("onWayExists",b.p);}if(b.r){this._notify("onResults",this.readRecord(b.r));}this._notify("onDataParsed",b.d);},getParsedData:function(a){return this._dataParser(a);},readRecord:function(b){if(b===null||b===undefined){return null;}var a={columns:b.s,row:b.d,pk:this._columnsParseFnc(b).pk};if(b.objectName){a.objectName=b.objectName;}return a;}});$ws.proto.FastParserSBIS=$ws.proto.ParserSBIS.extend({});$ws.proto.TransportAdapterAbstract=$ws.core.extend({},{list:function(a){throw new Error("TransportAdapterAbstract::list must be implemented");},create:function(a){throw new Error("TransportAdapterAbstract::create must be implemented");},update:function(a){throw new Error("TransportAdapterAbstract::update must be implemented");},merge:function(a){throw new Error("TransportAdapterAbstract::merge must be implemented");},copy:function(a){throw new Error("TransportAdapterAbstract::copy must be implemented");},destroy:function(a){throw new Error("TransportAdapterAbstract::destroy must be implemented");},read:function(a){throw new Error("TransportAdapterAbstract::read must be implemented");},abort:function(){throw new Error("TransportAdapterAbstract::abort must be implemented");}});$ws.proto.TransportAdapterStatic=$ws.proto.TransportAdapterAbstract.extend({$protected:{_options:{data:{}},_pkColumnIndex:0,_pkIndex:{},_pkColumnName:undefined,_columns:[],_data:[],_columnsName:"s",_dataName:"d",_countName:"n",_columnTypeName:"t",_columnTitleName:"n",_pkName:"ИдО",_isStandartReader:true},$constructor:function(){if(typeof(this._options.data)==="string"){this._options.data=JSON.parse(this._options.data);}var a=this._options.data;this._isStandartReader=!(a.cols&&a.data);if(!this._isStandartReader){this._columnsName="cols";this._dataName="data";this._columnTypeName="type";this._columnTitleName="name";this._pkName="pk";}this._columns=a[this._columnsName];this._data=a[this._dataName];this._pkColumnIndex=a.k=a.k||0;if(this._pkColumnIndex>=0&&this._columns&&this._columns[this._pkColumnIndex]!==undefined){this._pkColumnName=this._columns[this._pkColumnIndex][this._columnTitleName];this._refreshPkIndex();}},_refreshPkIndex:function(){var b=[];this._pkIndex={};for(var c=0,a=this._data.length;c<a;c++){b=this._data[c];this._pkIndex[b[this._pkColumnIndex]]=c;}},list:function(m){var a=this._isStandartReader&&m["Навигация"]||(m&&m.usePages?m:false),g={},k=this._data.length,n=0,h=k;g[this._countName]=k;if(a){var o,e,b;if(this._isStandartReader){for(var d=0,c=a[this._columnsName].length;d<c;d++){switch(a[this._columnsName][d].n){case"Страница":o=a[this._dataName][d];break;case"РазмерСтраницы":e=a[this._dataName][d];break;case"ЕстьЕще":b=a[this._dataName][d];break;default:break;}}}else{o=a.pageNum;e=a.pageCount;b=a.usePages=="full";}if(o==-1){o=parseInt(k/e,10);}n=o*e;h=Math.min(n+e,k);if(b){g[this._countName]=!!this._data[h];}}g[this._dataName]=[];g[this._columnsName]=this._columns;for(var f=n;f<h;f++){g[this._dataName].push(this._data[f].slice());}if(this._options.data.r){g.r=this._options.data.r;}return new $ws.proto.Deferred().callback(g);},update:function(d){if(this._pkColumnIndex<0){return new $ws.proto.Deferred().errback(new Error("Запрещено редактирование записей в списке без ключа"));}var b=d["Запись"][this._dataName],f=b[this._pkColumnIndex],c=this._pkIndex[f]===undefined?[]:this._data[this._pkIndex[f]];for(var e=0,a=this._columns.length;e<a;e++){c[e]=b[e];}if(this._pkIndex[c[this._pkColumnIndex]]===undefined){this._data.push(c);this._pkIndex[c[this._pkColumnIndex]]=this._data.length-1;}return new $ws.proto.Deferred().callback(c[this._pkColumnIndex]);},destroy:function(a){if(this._pkColumnIndex<0){return new $ws.proto.Deferred().errback(new Error("Запрещено удадение записей в списке без ключа"));}var b=a[this._pkName];if(this._pkIndex[b]!==undefined){this._data.splice(this._pkIndex[b],1);}this._refreshPkIndex();return new $ws.proto.Deferred().callback(true);},read:function(b){var c=b[this._pkName],a=this._data[this._pkIndex[c]];return new $ws.proto.Deferred().callback(this._getRecordByConfig(a));},copy:function(b){if(this._pkColumnIndex<0){return new $ws.proto.Deferred().errback(new Error("Запрещено копирование записей в списке без ключа"));}var c=new $ws.proto.Deferred(),a=this;this.read(b).addCallback(function(d){d[a._dataName][a._pkColumnName]=null;c.callback(d);return d;});return c;},create:function(a){if(this._pkColumnIndex<0){return new $ws.proto.Deferred().errback(new Error("Запрещено создание записей в списке без ключа"));}return new $ws.proto.Deferred().callback(this._getRecordByConfig(a&&a["Фильтр"]));},_getRecordByConfig:function(k){var g={},c={},n,e,a,m;if(Object.prototype.toString.call(k)=="[object Object]"){a=k[this._columnsName];m=k[this._dataName];}g[this._dataName]=[];g[this._columnsName]=this._columns;for(var f=0,b=this._columns.length;f<b;f++){c=this._columns[f];n=c[this._columnTitleName];e=null;if(Object.prototype.toString.call(k)=="[object Object]"){for(var d=0,h=a.length;d<h;d++){if(a[d][this._columnTitleName]==n&&m[d]!==undefined){e=m[d];}}}else{if(Object.prototype.toString.call(k)=="[object Array]"){if(k[f]!==undefined){e=k[f];}}}g[this._dataName].push(e);}return g;},abort:function(){}});$ws.proto.TransportAdapterRPCAbstract=$ws.proto.TransportAdapterAbstract.extend({$protected:{_errorHandler:function(a){$ws.single.ioc.resolve("ILogger").error("RPC",(a instanceof HTTPError)?(a+""):a.message,a);return a;},_options:{objectName:undefined,serviceUrl:"",createMethodName:"",listMethodName:"",updateMethodName:"",destroyMethodName:"",mergeMethodName:"",copyMethodName:"",readMethodName:""},_rpcClient:null},$constructor:function(){},getRPCClient:function(){if(this._rpcClient===null){this._rpcClient=this._createRpcClient();}return this._rpcClient;},setRPCClient:function(a){if(a.callMethod){this._rpcClient=a;}},_invoke:function(c,b){var a=this;return this.getRPCClient().callMethod(c,b).addCallbacks(function(e){if(a._options.objectName){e.objectName=a._options.objectName;}return e;},this._errorHandler);},_createRpcClient:function(){throw new Error("Abstract method TransportAdapterRPCAbstract::_createRpcClient must be implemented in child class");},list:function(a){return this._invoke(this._options.listMethodName,a);},update:function(a){return this._invoke(this._options.updateMethodName,a);},merge:function(a){return this._invoke(this._options.mergeMethodName,a);},destroy:function(a){return this._invoke(this._options.destroyMethodName,a);},destroyByFilter:function(a){return this._invoke(this._options.destroyMethodName,a);},create:function(a){return this._invoke(this._options.createMethodName,a);},read:function(a){return this._invoke(this._options.readMethodName,a);},copy:function(a){return this._invoke(this._options.copyMethodName,a);},abort:function(){if(this._rpcClient){this._rpcClient.abort();}},getConfig:function(){return this._options;}});$ws.proto.TransportAdapterRPCJSON=$ws.proto.TransportAdapterRPCAbstract.extend({_createRpcClient:function(){return new $ws.proto.RPCJSON({serviceUrl:this._options.serviceUrl});}});$ws.proto.TransportAdapterWS=$ws.proto.TransportAdapterAbstract.extend({$protected:{_options:{url:"",updateURL:"",destroyURL:"",tableName:""},_JSONLoader:null},$constructor:function(){this._JSONLoader=new $ws.proto.JSONLoader({url:this._options.url,updateURL:this._options.updateURL,destroyURL:this._options.destroyURL,tableName:this._options.tableName});},list:function(a){return this._JSONLoader.load(a);},update:function(a){return this._JSONLoader.load(a,"update");},destroy:function(a){return this._JSONLoader.load(a,"destroy");}});$ws.single.SerializatorSBIS={serialize:function(b){var a;if(b instanceof $ws.proto.RecordSet||b instanceof $ws.proto.Record){a=b.toJSON();}else{throw new TypeError("Попытка сериализации неподдерживаемого типа");}return a;},serializeData:function(h,g){var b={d:[],s:[]},j,p;g=this.serializeCols(g);b.s=g;for(var k=0,e=g.length;k<e;k++){p=g[k];j=typeof(p.t)=="object"?p.t.n:p.t;if(j=="Перечисляемое"){if(h[k] instanceof $ws.proto.Enum){b.s[k].t.s=h[k].getValues();}}else{if(j=="Флаги"){if(!(h[k] instanceof $ws.proto.Record)){h[k]=null;}}}if(h[k] instanceof $ws.proto.Record||h[k] instanceof $ws.proto.RecordSet){if(j==="Флаги"){var d=[],u={},r=h[k].getColumns();for(var o=0,f=r.length;o<f;o++){u[h[k].getColumnIdx(r[o])]=r[o];}var m=Object.sortedPairs(u),q=h[k].toObject();u={};for(var n=0,c=m.keys.length;n<c;n++){u[m.keys[n]]=m.values[n];d.push(q[m.values[n]]);}b.d.push(d);b.s[k].t.s=u;}else{b.d.push(this.serialize(h[k]));}}else{if(p.s&&p.s=="Иерархия"){if(!(p.n.substr(p.n.length-1,1) in {"@":true,"$":true})){b.d.push($ws.single.SerializatorSBIS.serializeHierarchyIdentity(h[k]));}else{b.d.push(h[k]);}}else{if(j=="Связь"){b.d.push(h[k]===null||h[k]=="null"?null:parseInt(h[k],10));}else{if(j=="Массив"){b.d.push((h[k]&&h[k] instanceof Array)?h[k]:[]);}else{if(h[k] instanceof Date){if(j=="Дата"){b.d.push(h[k].toSQL());}else{if(j=="Дата и время"){b.d.push(h[k].toSQL(true));}else{b.d.push(h[k].toSQL(false));}}}else{if(h[k] instanceof $ws.proto.Enum){var a=h[k].getCurrentValue();b.d.push(a===null?null:parseInt(a,10));}else{if(j=="Идентификатор"){b.d.push($ws.single.SerializatorSBIS.serializeHierarchyIdentity(h[k]));}else{if(j=="Число целое"){b.d.push((typeof(h[k])=="number")?h[k]:(isNaN(parseInt(h[k],10))?null:parseInt(h[k],10)));}else{b.d.push(h[k]!==undefined?h[k]:null);}}}}}}}}}return b;},serializeCols:function(c){var a=[];for(var b in c){if(c.hasOwnProperty(b)){var e=c[b],d=e.type;if(e.s&&e.s=="Иерархия"){a.push({n:e.title,t:e.type,s:e.s});}else{if(d=="Перечисляемое"||d=="Флаг"){a.push({n:e.title,t:{n:d,s:e.s}});}else{if(d=="Массив"||d=="Связь"){a.push({n:e.title,t:{n:d,t:d=="Связь"?e.table:e.arrayType}});}else{if(d=="Флаги"){a.push({n:e.title,t:{n:d,s:e.s}});}else{a.push({n:e.title,t:d});}}}}}}return a;},serializeHierarchyIdentity:function(d){var c;if(d===null){c=[null];}else{if(d instanceof Array){if(typeof d[0]=="string"){var b=parseInt(d[0],10);if(!isNaN(b)){var a=d.slice();a[0]=b;return a;}else{return d;}}return d;}else{if(typeof d=="string"){var e=$ws.helpers.parseComplexKey(d);d=[parseInt(e.objKey,10)];if(e.objName){d.push(e.objName);}c=d;}else{c=[d];}}}return c;},getColumnConfigByType:function(b,d,c){var a={cols:[],data:[]},e;switch(d){case $ws.proto.Record.FIELD_TYPE_QUERY:case $ws.proto.Record.FIELD_TYPE_RECORD:case $ws.proto.Record.FIELD_TYPE_INTEGER:case $ws.proto.Record.FIELD_TYPE_STRING:case $ws.proto.Record.FIELD_TYPE_TEXT:case $ws.proto.Record.FIELD_TYPE_DOUBLE:case $ws.proto.Record.FIELD_TYPE_MONEY:case $ws.proto.Record.FIELD_TYPE_DATE:case $ws.proto.Record.FIELD_TYPE_DATETIME:case $ws.proto.Record.FIELD_TYPE_TIME:case $ws.proto.Record.FIELD_TYPE_BOOLEAN:case $ws.proto.Record.FIELD_TYPE_IDENTITY:case $ws.proto.Record.FIELD_TYPE_BINARY:case $ws.proto.Record.FIELD_TYPE_UUID:a.cols.push({t:d,n:b});break;case $ws.proto.Record.FIELD_TYPE_LINK:case $ws.proto.Record.FIELD_TYPE_ARRAY:if(c){e={n:d,t:c};a.cols.push({t:e,n:b});}else{return false;}break;case $ws.proto.Record.FIELD_TYPE_ENUM:case $ws.proto.Record.FIELD_TYPE_FLAGS:if(c){e={n:d,s:c};a.cols.push({t:e,n:b});}else{return false;}break;case $ws.proto.Record.FIELD_TYPE_HIERARCHY:a.cols.push({s:"Иерархия",t:"Идентификатор",n:b});a.cols.push({s:"Иерархия",t:"Логическое",n:b+"@"});a.cols.push({s:"Иерархия",t:"Логическое",n:b+"$"});break;default:return false;}switch(d){case $ws.proto.Record.FIELD_TYPE_QUERY:case $ws.proto.Record.FIELD_TYPE_RECORD:a.data.push({s:[],d:[]});break;case $ws.proto.Record.FIELD_TYPE_IDENTITY:a.data.push([null]);break;case $ws.proto.Record.FIELD_TYPE_ARRAY:case $ws.proto.Record.FIELD_TYPE_FLAGS:if(c){a.data.push([]);}else{return false;}break;case $ws.proto.Record.FIELD_TYPE_HIERARCHY:a.data.push([null]);a.data.push(false);a.data.push(false);break;default:a.data.push(null);}return a;}};$ws.single.RecordSetToXMLSerializer={_complexFields:{"Связь":true,"Иерархия":true,"Перечисляемое":true,"Флаги":true,"Массив":true,"Запись":true,"Выборка":true},_colNameToTag:{"Число целое":"ЧислоЦелое","Число вещественное":"ЧислоВещественное","Дата и время":"ДатаИВремя"},_branchTypes:{"true":"Узел","false":"Лист","null":"СкрытыйУзел"},serialize:function(b,e,d,a){var f=this._createXMLDocument(),c=b instanceof $ws.proto.Record?[b]:b;this._serializeObject(c,f,f);this._serializeColumns(e,c,f,d,a);return f;},_serializeColumns:function(d,g,k,m,a){var f="",j,c;if(d&&d instanceof Array&&d.length>0){k.documentElement.appendChild(j=k.createElement("Колонки"));for(var h=0,b=d.length;h<b;h++){j.appendChild(c=k.createElement("Колонка"));c.setAttribute("Имя",d[h].title);c.setAttribute("Поле",d[h].field);}}if(g instanceof $ws.proto.RecordSet){f=g.getHierarchyField();}if(g instanceof Array&&g[0] instanceof $ws.proto.Record&&g[0].getRecordSet()!==null){var e=g[0].getRecordSet();if(e){f=e.getHierarchyField();}}if(f!==""){k.documentElement.setAttribute("ПолеИерархии",f);k.documentElement.setAttribute("ИмяИерархии",m===undefined?"":m);k.documentElement.setAttribute("Корень",a?(a+""):"null");}},_serializeObject:function(f,p,m){var j,h,d=[],o,a;if(f instanceof $ws.proto.RecordSet){p.appendChild(h=m.createElement("Выборка"));f.rewind();while((j=f.next())!==false){this._serializeObject(j,h,m);}}else{if(f instanceof Array){p.appendChild(h=m.createElement("Выборка"));var c=f.length;for(var g=0;g<c;g++){this._serializeObject(f[g],h,m);}}else{if(f instanceof $ws.proto.Record){p.appendChild(o=m.createElement("Запись"));var n=f.getKey();if(n===null){n="null";}o.setAttribute("КлючЗаписи",n);d=f.getColumns();a=f.getRecordSet()===null?d[0]:d[f.getRecordSet().getPkColumnIndex()];o.setAttribute("ПолеКлюча",a);for(var e=0,b=d.length;e<b;e++){this._serializeField(d[e],f,o,m);}}}}},_serializeField:function(f,e,o,p){var k,c,d,b;k=e.getColumnDefinition(f);o.appendChild(c=p.createElement("Поле"));c.setAttribute("Имя",k.title);var g=e.get(k.title)===null?"null":e.get(k.title);var j=typeof(k.type)=="object"?k.type.n:k.type;if(!this._complexFields[j]&&!k.s&&!this._complexFields[k.s]){d=this._colNameToTag[k.type]?this._colNameToTag[k.type]:k.type;b=p.createElement(d);if(g instanceof Date){if(k.type=="Дата и время"){g=g.toSQL()+"T"+g.toTimeString().replace(" GMT","").replace(/\s[\w\W]*/,"");}if(k.type=="Дата"){g=g.toSQL();}if(k.type=="Время"){g=g.toTimeString().replace(" GMT","").replace(/\s[\w\W]*/,"");}}b.appendChild(p.createTextNode(g+""));c.appendChild(b);}else{if(j=="Связь"){b=p.createElement("Связь");b.setAttribute("Таблица",typeof(k.type)=="object"?k.type.t:k.table);b.appendChild(p.createTextNode(g));c.appendChild(b);}else{if(j=="Иерархия"||(k.s&&k.s=="Иерархия")){c.appendChild(b=p.createElement("Иерархия"));var h,m;b.appendChild(h=p.createElement("Родитель"));b.appendChild(m=p.createElement("ТипУзла"));if(typeof(k.type)=="object"){b.setAttribute("ИмяИерархии",k.type.f+"");h.appendChild(p.createTextNode(g[1]+""));m.appendChild(p.createTextNode(this._branchTypes[g[0]+""]));}else{if(j=="Идентификатор"){b.setAttribute("ИмяИерархии",k.titleColumn+"");h.appendChild(p.createTextNode(g+""));g=this._branchTypes[e.get(k.title+"@")+""];m.appendChild(p.createTextNode(g));}else{o.removeChild(c);}}}else{if(j=="Перечисляемое"){c.appendChild(b=p.createElement("Перечисляемое"));var n;g=g.toObject();for(var v in g.availableValues){if(g.availableValues.hasOwnProperty(v)){b.appendChild(n=p.createElement("Вариант"));n.setAttribute("Значение",v);var q=g.availableValues[v];if(q===null){q="null";}n.setAttribute("Название",q);if(v==g.currentValue){n.setAttribute("Выбран","true");}}}}else{if(j=="Флаги"){c.appendChild(b=p.createElement("Флаги"));var t;g=g.toObject();for(var a in g){if(g.hasOwnProperty(a)){b.appendChild(t=p.createElement("Флаг"));t.setAttribute("Название",a);t.setAttribute("Состояние",g[a]+"");}}}else{if(j=="Массив"){c.appendChild(b=p.createElement("Массив"));b.setAttribute("ТипДанных",typeof(k.type)=="object"?k.type.t:k.arrayType);var u;for(var s=0,r=g.length;s<r;s++){b.appendChild(u=p.createElement("Значение"));u.appendChild(p.createTextNode(g[s]));}}else{if(g instanceof $ws.proto.RecordSet||g instanceof $ws.proto.Record){this._serializeObject(g,c,p);}}}}}}}},_createXMLDocument:function(){var a;if(document.implementation&&document.implementation.createDocument){a=document.implementation.createDocument("","",null);}if(window.ActiveXObject){a=new ActiveXObject("Microsoft.XmlDom");}return a;}};$ws.proto.ReportPrinter=$ws.core.extend({},{$protected:{_options:{columns:[],titleColumn:""}},prepareReport:function(c,b,a){var d=$ws.single.RecordSetToXMLSerializer.serialize(c,this._options.columns,this._options.titleColumn,a);return $ws.core.attachInstance("xslt:XSLTransform",{xml:d,xsl:b}).addCallback(function(e){var f=e.transformToText();e.destroy();return f;});}});$ws.proto.BLObject=function(a){return $ws.single.ioc.resolve("IBLObject",a);};$ws.proto.ClientBLObject=$ws.core.extend($ws.proto.BLObject,{$protected:{_name:"",_serviceUrl:""},$constructor:function(a){if(a&&typeof(a)=="object"){if("name" in a){this._name=a.name;}if("serviceUrl" in a){this._serviceUrl=a.serviceUrl;}}else{if(typeof(a)=="string"){this._name=a;}}if(!this._name){throw new Error("Name of the object must be specified then creating BLObject instance");}},getName:function(){return this._name;},call:function(a,h,i,f,g,e){if(!a||typeof(a)!="string"){throw new TypeError("Method name must be specified");}if(!h||typeof(h)!=="object"){throw new TypeError("Wrong arguments specified. Must be an object");}switch(i){case $ws.proto.BLObject.RETURN_TYPE_RECORD:var c,b=g?(g.indexOf(".")!==-1?g:this._name+"."+g):this._name+".Записать",d=e?(e.indexOf(".")!==-1?e:this._name+"."+e):this._name+".Удалить";c=new $ws.proto.RecordSet({firstRequest:false,readerType:"StraightArgsReader",readerParams:{dbScheme:"",adapterType:"TransportAdapterRPCJSON",adapterParams:{serviceUrl:this._serviceUrl,readMethodName:this._name+"."+a,updateMethodName:b,destroyMethodName:d}}});return c.readRecord(h);break;case $ws.proto.BLObject.RETURN_TYPE_RECORDSET:return $ws.helpers.newRecordSet(this._name,a,h,"StraightArgsUnifiedReader",true,this._serviceUrl,f);break;case $ws.proto.BLObject.RETURN_TYPE_ASIS:$ws.helpers.forEach(h,function(l,j,m){if(l instanceof $ws.proto.Record||l instanceof $ws.proto.RecordSet){m[j]=$ws.single.SerializatorSBIS.serialize(l);}});return new $ws.proto.RPCJSON({serviceUrl:this._serviceUrl}).callMethod(this._name+"."+a,h);break;default:throw new TypeError("Wrong return type specified");}},query:function(d,b,a,c){if(!d||typeof(d)!="string"){throw new TypeError("Method name must be specified");}if(a){if(typeof a!="object"){throw new TypeError("Paging parameter must be an object");}else{if(a.type){a.page=+a.page;a.pageSize=+a.pageSize;if(isNaN(a.page)){throw new TypeError("Page must be a number (paging.page)");}if(isNaN(a.pageSize)){throw new TypeError("Page size must be a number (paging.pageSize)");}}}}if(c&&!(c instanceof Array)){throw new TypeError("Sorting parameter must be an array");}return $ws.helpers.newRecordSet(this._name,d,b,undefined,!(c||a),this._serviceUrl,undefined,this._createFast).addCallback(function(e){if(c||a){var f=new $ws.proto.Deferred();if(c){e.setSorting(c,undefined,undefined,true);}if(a&&a.type){e.setUsePages(a.type);e.setPageSize(a.pageSize,true);e.setPage(a.page,true);}e.once("onAfterLoad",function(j,i,g,h){if(g){f.callback(i);}else{f.errback(h);}});e.reload();return f;}else{return e;}});}});$ws.proto.StraightArgsUnifiedReader=$ws.proto.ReaderUnifiedSBIS.extend({_makeArgsForQuery:function(a){$ws.helpers.forEach(a,function(c,b,d){if(c instanceof $ws.proto.Record||c instanceof $ws.proto.RecordSet){d[b]=$ws.single.SerializatorSBIS.serialize(c);}else{if(c instanceof Date){d[b]=c.toSQL(null);}}});return a;}});$ws.proto.FastStraightArgsUnifiedReader=$ws.proto.StraightArgsUnifiedReader.extend({});$ws.proto.StraightArgsReader=$ws.proto.ReaderSBIS.extend({_makeArgsForRead:function(a){$ws.helpers.forEach(a,function(c,b,d){if(c instanceof $ws.proto.Record||c instanceof $ws.proto.RecordSet){d[b]=$ws.single.SerializatorSBIS.serialize(c);}else{if(c instanceof Date){d[b]=c.toSQL(null);}}});return a;}});$ws.proto.ReaderGETJSON=$ws.proto.ReaderAbstract.extend({_columnsParseFnc:function(d){var c=[],b=JSON.parse(d);for(var a in b[0]){c.push({n:a,t:"Строка"});}return{settings:c,pk:0};},_dataParser:function(d){var e,c=JSON.parse(d);for(var b in c){e=[];for(var a in c[b]){e.push(c[b][a]);}this._notify("onNewRecord",e);}},_makeArgsForQuery:function(a){return a;}});$ws.proto.TransportAdapterGETJSON=$ws.proto.TransportAdapterAbstract.extend({$protected:{_options:{url:""},_xhrTransport:null},list:function(a){this._xhrTransport=$ws.single.ioc.resolve("ITransport",{url:this._options.url});var c=[];for(var b in a){c.push(encodeURI(b)+"="+encodeURI(a[b]));}return this._xhrTransport.execute(c.join("&"));},getRPCClient:function(){return{};},abort:function(){if(this._xhrTransport){this._xhrTransport.abort();}}});$ws.proto.BLObject.RETURN_TYPE_ASIS="asis";$ws.proto.BLObject.RETURN_TYPE_RECORD="record";$ws.proto.BLObject.RETURN_TYPE_RECORDSET="recordset";$ws.proto.Template._importNode=function(h,b,f,m){if(m!==false&&h.importNode){try{return h.importNode(b,f);}catch(d){m=false;}}switch(b.nodeType){case $ws._const.nodeType.ELEMENT_NODE:var l=h.createElement(b.nodeName),c,j;if(b.attributes&&b.attributes.length>0){for(c=0,j=b.attributes.length;c<j;c++){var g=b.attributes[c].nodeName,k=b.getAttribute(g);if(g.toLowerCase()==="style"&&$.browser.msie){l.style.cssText=k;}else{l.setAttribute(g,k);}}}if(f&&b.childNodes&&b.childNodes.length>0){for(c=0,j=b.childNodes.length;c<j;c++){var a=$ws.proto.Template._importNode(h,b.childNodes[c],f,m);if(a){l.appendChild(a);}}}return l;break;case $ws._const.nodeType.TEXT_NODE:case $ws._const.nodeType.CDATA_SECTION_NODE:return h.createTextNode(b.nodeValue);case $ws._const.nodeType.COMMENT_NODE:return null;break;}};