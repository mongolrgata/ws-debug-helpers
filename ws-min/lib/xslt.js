$ws._const.XSLTCaps={TRANSFORM_TO_TEXT:1,TRANSFORM_TO_DOC:2,TRANSFORM_TO_FRAGMENT:4,LOAD_URL:8,LOAD_TEXT:16};$ws.proto.XSLTransform=$ws.core.extend({},{$protected:{_xmlDoc:"",_xslDoc:"",_loadedFiles:[],_options:{xml:"",xsl:""},_nsResolver:null},$constructor:function(){this._xmlDoc=new $ws.proto.XMLDocument({name:this._options.xml}).getDocument();this._xslDoc=new $ws.proto.XMLDocument({name:this._options.xsl}).getDocument();if($.browser.webkit){this._nsResolver=function(b){switch(b){case"xsl":return"http://www.w3.org/1999/XSL/Transform";default:return null;}};this._chromeWorkaround();if($ws._const.debug){var a=$ws.single.ioc.resolve("ILogger");a.log("xslt","XML document:\n"+new XMLSerializer().serializeToString(this._xmlDoc));a.log("xslt","XSL document:\n"+new XMLSerializer().serializeToString(this._xslDoc));}}},_loadDoc:function(a){if(Array.indexOf(this._loadedFiles,a)==-1){var b=new $ws.proto.XMLDocument({name:a}).getDocument();this._loadedFiles.push(a);return b;}else{$ws.single.ioc.resolve("ILogger").log("XSLTransfor","Potential cyclic dependency on file "+a);return null;}},_chromeWorkaround:function(){while(this._xslDoc.getElementsByTagName("import").length>0){this._preparseImports(this._xslDoc);this._preparseImportAppliance(this._xslDoc);}while(this._xslDoc.getElementsByTagName("include").length>0){this._preparseIncludes(this._xslDoc);}this._preparseDocumentFunction(this._xmlDoc,this._xslDoc);},_preparseIncludes:function(c){var i=c.getElementsByTagName("include");while(i.length>0){var e=i[0];var a=e.getAttribute("href");var h=this._loadDoc(a);var b=e.parentNode;if(h){var d=h.documentElement.childNodes;for(var f=0,g=d.length;f<g;f++){b.insertBefore(c.importNode(d[f],true),e);}}b.removeChild(e);}},_preparseImportAppliance:function(e){var a=e.getElementsByTagName("apply-imports");while(a.length>0){var c=a[0];var d=c.parentNode;var b=e.createElement("xsl:apply-templates");b.setAttribute("select",".");b.setAttribute("mode","imports");d.replaceChild(b,c);}},_preparseImports:function(e){var b=e.getElementsByTagName("import");while(b.length>0){var l=b[0];var a=l.getAttribute("href");var q=this._loadDoc(a);var c=l.parentNode;if(q){var f=q.documentElement.childNodes;for(var i=0,o=f.length;i<o;i++){var d=f[i];if(d.nodeName=="xsl:template"){if(d.hasAttribute("name")){var g=d.getAttribute("name");var r=e.evaluate("count(//xsl:template[@name='"+g+"'])",e,this._nsResolver,XPathResult.NUMBER_TYPE,null);if(r&&r.numberValue>0){$ws.single.ioc.resolve("ILogger").log("xslt","Ignored duplicate named template: "+g);continue;}}if(d.hasAttribute("match")){var h=d.getAttribute("match");var k=e.evaluate("count(//xsl:template[@match='"+h+"'])",e,this._nsResolver,XPathResult.NUMBER_TYPE,null);if(k&&k.numberValue>0){d.setAttribute("mode","imports");}}}c.insertBefore(e.importNode(d,true),l);}}c.removeChild(l);}},_preparseDocumentFunction:function(e,c){var p=c.evaluate("//*[contains(@select, 'document(')]",c,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var j;var r=[];while((j=p.iterateNext())!==null){var d=j.getAttribute("select");var f=d.match(/document\('([^\)]+)'\)/);if(f&&f.length>0){var b=f[1];var o=this._loadDoc(b);if(o){var a="x"+b.replace(/\//g,"-")+"-document";var n=e.createElement(a);var q=this._getForeignDocContainer(e);q.appendChild(n);n.appendChild(e.importNode(o.documentElement,true));d="//ws-foreign-documents-namespace/"+a+d.substring(b.length+12);r.push([j,d]);}}}if(r.length>0){var s=c.createElement("xsl:template");s.setAttribute("match","ws-foreign-documents-namespace");c.documentElement.appendChild(s);for(var h=0,g=r.length;h<g;h++){r[h][0].setAttribute("select",r[h][1]);}}},_getForeignDocContainer:function(b){var a=b.getElementsByTagName("ws-foreign-documents-namespace")[0];if(!a){a=b.createElement("ws-foreign-documents-namespace");b.documentElement.appendChild(a);}return a;},_insertForeignDoc:function(c,e){var f=new $ws.proto.XMLDocument({name:e});var b="xxx";var d=this._getForeignDocContainer(c);var a=c.createElement(b);a.appendChild(a.importNode(f.getDocument(),true));d.appendChild(a);},_ieAddParams:function(g,f){if(!f){return g;}for(var d in f){try{var b=f[d];if(typeof b==="boolean"||(isNaN(parseInt(b,10))&&(typeof b!=="string"||b.charAt(0)!=="'"))){b="'"+b+"'";}var a=g.selectSingleNode('//xsl:param[@name="'+d+'"]');if(a){a.setAttribute("select",b);}}catch(c){throw new Error("Problems with setting parameter "+d+" in the xsl transform");}}return g;},transformToText:function(a){if(window.XMLSerializer&&!$.browser.msie){return new XMLSerializer().serializeToString(this.transformToDocument(a));}else{if(window.ActiveXObject){return this._xmlDoc.transformNode(this._ieAddParams(this._xslDoc,a));}}throw new Error("Transform to text is not supported in your environment");},transformToDocument:function(d){if(window.XSLTProcessor){var a=new XSLTProcessor();for(var c in d){a.setParameter(null,c,d[c]);}if(a.transformToDocument){a.importStylesheet(this._xslDoc);return a.transformToDocument(this._xmlDoc);}}else{if(window.ActiveXObject){var b=new ActiveXObject("Microsoft.XMLDOM");this._ieAddParams(b,d);if("transformNodeToObject" in this._xmlDoc){this._xmlDoc.transformNodeToObject(this._ieAddParams(this._xslDoc,d),b);return b;}}}throw new Error("Transform to document is not supported in your environment");},transformToFragment:function(f,g){if(window.XSLTProcessor){var b=new XSLTProcessor();for(var e in g){b.setParameter(null,e,g[e]);}if(b.transformToFragment){b.importStylesheet(this._xslDoc);return b.transformToFragment(this._xmlDoc,f);}}else{if(window.ActiveXObject){var d=f.createDocumentFragment();var c=this._xmlDoc.transformNode(this._ieAddParams(this._xslDoc,g));var a=f.createElement("div");a.innerHTML=c;while(a.hasChildNodes()){d.appendChild(a.firstChild);}return d;}}throw new Error("Transform to fragment is not supported in your environment");},getCapabilities:function(){var b=$ws._const.XSLTCaps.LOAD_URL,a;if(window.DOMParser){b|=$ws._const.XSLTCaps.LOAD_TEXT;}if(window.XSLTProcessor){a=new XSLTProcessor();if(a.transformToDocument){b|=$ws._const.XSLTCaps.TRANSFORM_TO_DOC;}if(a.transformToFragment){b|=$ws._const.XSLTCaps.TRANSFORM_TO_FRAGMENT;}}else{if(window.ActiveXObject){a=new ActiveXObject("Microsoft.XMLDOM");if("transformNodeToObject" in a){b|=$ws._const.XSLTCaps.TRANSFORM_TO_DOC;}if("transformNode" in a){b|=$ws._const.XSLTCaps.TRANSFORM_TO_TEXT;}if("loadXML" in a){b|=$ws._const.XSLTCaps.LOAD_TEXT;}}}if(window.XMLSerializer){b|=$ws._const.XSLTCaps.TRANSFORM_TO_TEXT;}return b;},destroy:function(){this._xmlDoc=null;this._xslDoc=null;this._options=null;}});$ws.proto.XMLDocument=function(a){return $ws.single.ioc.resolve("IXMLDocument",a);};$ws.proto.ClientXMLDocument=$ws.core.extend($ws.proto.XMLDocument,{$protected:{_options:{name:""},_doc:null},$constructor:function(){this._doc=this._loadDocument(this._options.name);},getDocument:function(){return this._doc;},checkDocument:function(a){var b=null;if(a){if(a.parseError){if(a.parseError.errorCode!==0){b=a.parseError.reason;}}else{var c=a.getElementsByTagName("parsererror");if(c.length){b=c[0].textContent;}}}else{b="Empty document";}if(b!==null){throw new EvalError("Parse error: "+b);}return a;},_loadDocument:function(a){var b=null;if(a.documentElement){b=a;}else{b=this["_loadDocumentFrom"+(this._isUrl(a)?"Url":"String")](a);}return this.checkDocument(b);},_loadDocumentFromString:function(a){var b=null;if(window.ActiveXObject){b=new ActiveXObject("Microsoft.XMLDOM");b.async=false;b.loadXML(a);}else{if(window.DOMParser){b=new DOMParser().parseFromString(a,"text/xml");}}if(b!==null){return b;}throw new Error("Your environment is not able to parse XML documents from string");},_loadDocumentFromUrl:function(a){if(window.ActiveXObject){var c=new ActiveXObject("Microsoft.XMLDOM");c.async=false;c.load(a);return c;}else{var b=new XMLHttpRequest();b.open("GET",a,false);b.send("");return b.responseXML;}},_isUrl:function(b){if(b.substr===undefined||b===""||!b){return false;}if(!/^http[s]?:/.test(b)){var a=b.substr(0,1);if(a!="/"&&a!="."){if(a=="<"){return false;}}}return true;},destroy:function(){this._doc=null;this._options=null;}});