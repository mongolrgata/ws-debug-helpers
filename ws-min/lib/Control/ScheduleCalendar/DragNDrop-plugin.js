(function(){$ws.core.attach($ws._const.wsRoot+"lib/Control/Plugins/ControlDragAndDrop-plugin.js").addCallback(function(){$ws.proto.ScheduleCalendar.extendPlugin($ws.proto.Control.DragAndDropPlugin);});$ws.single.DependencyResolver.register("/lib/Control/ScheduleCalendar/DragNDrop-plugin.js",function(){return["/lib/Control/Plugins/ControlDragAndDrop-plugin.js"];});$ws.proto.ScheduleCalendar.DragNDrop=$ws.proto.ScheduleCalendar.extendPlugin({$protected:{_drag:{offset:{left:undefined,top:undefined},dragStarted:false,dragElement:undefined,record:undefined,timeStart:undefined,timeEnd:undefined,duration:undefined,recDate:undefined,updated:undefined},_dropHint:{elem:undefined,color:undefined},_event:undefined},$constructor:function(){this._addDragContainer(".ws-calendar-draggable",this._container);},$condition:function(){return true;},_dragStart:function(c){var a=c.closest(".ws-calendar-draggable"),b=a.data();this._clearDragging();return b;},_dragStarted:function(b){b=this._fixEvent(b);var d=$(b.target),a=d.closest(".ws-calendar-draggable"),c=a.data();this._dropHint.elem=undefined;this._event=b;this._drag.dragStarted=false;this._drag.dragElement=a;this._drag.offset={left:(b.pageX-d.offset().left),top:(b.pageY-d.offset().top)};this._drag.record=this._recordSet.getRecordByPrimaryKey(c.key);this._drag.updated=undefined;if(this._drag.record){this._drag.timeStart=this._drag.record.get("ВремяНач");this._drag.timeEnd=this._drag.record.get("ВремяКнц");this._drag.recDate=this._drag.record.get("Дата");this._drag.duration=(this._drag.timeStart!==null&&this._drag.timeEnd!==null)?this.timeToInt(this._drag.timeEnd,true)-this.timeToInt(this._drag.timeStart):this._options.quantum;this._dropHint.color=this._drag.record.hasColumn("Цвет")?this._drag.record.get("Цвет"):this._options.defaultColor;}},_draggedOut:function(a,b){this._container.removeClass("ws-calendar-drag-over");},_dragIn:function(b,c){var a=false;if(this!==c){this._dropHint.elem=undefined;this._event=undefined;this._drag.dragStarted=true;this._drag.dragElement=undefined;this._drag.offset={left:0,top:10};this._drag.record=undefined;this._drag.updated=undefined;this._drag.timeStart=undefined;this._drag.timeEnd=undefined;this._drag.duration=this._options.quantum;this._dropHint.color=this._options.defaultColor;a=true;}return this===c||a;},_draggedIn:function(a,b){this._container.addClass("ws-calendar-drag-over");},_canDragOut:function(){return true;},_dragEnd:function(a,b){this._container.removeClass("ws-group-drag-over");if(!this._drag.started){}else{if(!(this._drag.updated instanceof $ws.proto.Deferred)){this._clearDragging();}}},_updateRecord:function(c,e,b,a){var d=this,f=this._notify("onMove",c,e,b,a);if(f!==false){c.set("Дата",e);c.set("ВремяНач",b);c.set("ВремяКнц",a);if(this._dropHint.elem&&this._dropHint.elem.length){this._dropHint.elem.addClass("waiting");}this._drag.updated=this.update(c,true);if(this._drag.updated instanceof $ws.proto.Deferred){this._drag.updated.addErrback(function(g){d._clearDragging();if(g&&g.message){$ws.core.alert(g.message,"error");}g.processed=true;return g;});}else{this._clearDragging();}}},_clearDragging:function(){if(this._dropHint.elem){this._dropHint.elem.remove();}if(this._drag.dragElement){this._drag.dragElement.removeClass("dragging");}},_getTimeOffsets:function(c,f){var g=this._options.quantum%2?this._options.quantum:this._options.quantum/2,b=this.timeToInt(this._options.interval.s)+Math.round((f-(c.offset().top+this._drag.offset.top))/42*this._options.quantum),a,e=this.timeToInt(this._options.interval.e,true),d=this.timeToInt(this._options.interval.s);b=Math.round(b/g)*g;b=(b<d)?d:b;a=b+this._drag.duration;a=(a>24*60)?24*60:a;a=(a>e)?e:a;return{tStart:b,tEnd:a};},_drop:function(f,c,h){var d=f.closest(".ws-calendar-droppable");if(d.length){var g=d.data("type"),a=d.data("date");a=new Date(a.getFullYear(),a.getMonth(),a.getDate());if(h==this){if(this._drag.record){switch(g){case"top-event":if(this._drag.recDate&&this._drag.recDate.equals(a)&&(this._drag.timeStart===null||this._drag.timeEnd===null)){this._clearDragging();break;}this._updateRecord(this._drag.record,a,null,null);break;case"main-event":var b=this._getTimeOffsets(d,this._event.pageY);if(this._drag.recDate.equals(a)&&(this._drag.timeStart&&this.timeToInt(this._drag.timeStart)==b.tStart)&&(this._drag.timeEnd&&this.timeToInt(this._drag.timeEnd)==b.tEnd)){this._clearDragging();break;}this._updateRecord(this._drag.record,a,this._toTime(b.tStart),this._toTime(b.tEnd));break;case"main-event-allday":if(this._drag.recDate.equals(a)){this._clearDragging();break;}this._updateRecord(this._drag.record,a,this._drag.timeStart,this._drag.timeEnd);break;case"before-event":if(this._drag.recDate.equals(a)&&this._drag.data.type=="before-event"){this._clearDragging();break;}if(this._drag.data.type=="before-event"){this._updateRecord(this._drag.record,a,this._drag.timeStart,this._drag.timeEnd);}else{this._updateRecord(this._drag.record,a,this._toTime(0),this._toTime(this._drag.duration));}break;case"after-event":if(this._drag.recDate.equals(a)&&this._drag.data.type=="after-event"){this._clearDragging();break;}if(this._drag.data.type=="after-event"){this._updateRecord(this._drag.record,a,this._drag.timeStart,this._drag.timeEnd);}else{var e=this.timeToInt(this._options.interval.e)+this._drag.duration;e=e>24*60?24*60:e;this._updateRecord(this._drag.record,a,this._options.interval.e,this._toTime(e));}break;}}}else{var i;switch(g){case"top-event":i=this._notify("onDragDrop",a,null,c);break;case"main-event":b=this._getTimeOffsets(d,this._event.pageY);i=this._notify("onDragDrop",a,this._toTime(b.tStart),c);break;}if(this._dropHint.elem&&this._dropHint.elem.length){this._dropHint.elem.addClass("waiting");}if(i===false){this._clearDragging();}else{if(i instanceof $ws.proto.Deferred){this._drag.updated=i;this._drag.updated.addCallbacks(function(j){if(j===false){this._clearDragging();}else{this.reload(true);}}.bind(this),function(j){this._clearDragging();return j;}.bind(this));}else{this.reload(true);}}}}},_dropBlock:function(f,d){if(d){d=this._fixEvent(d);}this._event=d;var b=f.closest(".ws-calendar-droppable");if(b.length){var c=b.data("type");var a=b.data("date");if(!this._drag.dragStarted){this._drag.dragStarted=true;this._drag.dragElement.addClass("dragging");}switch(c){case"before-event":break;case"after-event":break;case"top-event":break;case"main-event":if(this._dropHint.elem){var e=this.timeToInt(this._options.interval.s),g=this._getTimeOffsets(b,d.pageY);this._dropHint.elem.css({top:this._calcOffset(g.tStart,e)+"px",height:this._calcOffset(g.tEnd,g.tStart)+"px"});}break;}}return b;},_dragAddHighlight:function(g,e){if(e){e=this._fixEvent(e);}this._event=e;var b=g.closest(".ws-calendar-droppable");if(b.length){var d=b.data("type");var a=b.data("date");var c=a.strftime("%Y-%m-%d");switch(d){case"before-event":if(this._overlays.before[c]){}break;case"after-event":if(this._overlays.after[c]){}break;case"top-event":if(this._overlays.top[c]){this._overlays.top[c].append(this._dropHint.elem=$('<div class="drop-hint-top" style="height: 20px;">'));this._dropHint.elem.css({"background-color":this._dropHint.color});}break;case"main-event-allday":if(this._overlays.main[c]){this._overlays.main[c].append(this._dropHint.elem=$('<div class="drop-hint-top" style="height: 20px;">'));this._dropHint.elem.css({"background-color":this._dropHint.color});}break;case"main-event":if(this._overlays.main[c]){this._overlays.main[c].append(this._dropHint.elem=$('<div class="drop-hint-main">'));this._dropHint.elem.css({"background-color":this._dropHint.color});}var f=this.timeToInt(this._options.interval.s),h=this._getTimeOffsets(b,e.pageY);this._dropHint.elem.css({top:this._calcOffset(h.tStart,f)+"px",height:this._calcOffset(h.tEnd,h.tStart)+"px"});break;}}},_dragRemoveHighlight:function(b,a){if(!this._drag.updated&&this._dropHint.elem){this._dropHint.elem.remove();}},_isDragAcceptable:function(c,b,d,a){return true;},_dropTarget:function(a){}});})();