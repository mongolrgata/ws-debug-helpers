(function(){$ws.proto.ScheduleCalendar.Resize=$ws.proto.ScheduleCalendar.extendPlugin({$protected:{_resize:{data:undefined,startPoint:{x:0,y:0},offset:{left:undefined,top:undefined},started:false,target:undefined,resizeElement:undefined,record:undefined,timeStart:undefined,timeEnd:undefined,duration:undefined,recDate:undefined,updated:undefined,event:undefined,hint:undefined,hintColor:undefined},_resized:false},$constructor:function(){this._publish("onResizeStart","onResizeStop","onResizeMove");this._addResizeContainer(".ws-calendar-resizer",this._container);},$condition:function(){return true;},_addResizeContainer:function(a,b){$(b).delegate(a,"mousedown",function(c){c=this._fixEvent(c);if(c.which!==1||!this.isEnabled()){return true;}var d=this._resizeStart($(c.target),c);if(!d){return false;}this._resize.data=d;if(this._notify("onResizeStart",d)===false){return true;}this._resize.startPoint.x=c.pageX;this._resize.startPoint.y=c.pageY;$(document).bind("mousemove.wsResize",this._resizeMouseMove.bind(this)).bind("mouseup.wsResize",this._resizeMouseUp.bind(this));c.stopPropagation();return false;}.bind(this));},_clearResizing:function(){if(this._resize.hint&&this._resize.hint.length){this._resize.hint.remove();}if(this._resize.resizeElement){this._resize.resizeElement.removeClass("resizing");}},_resizeStart:function(d,b){var a=d.closest(".ws-calendar-main-event-wrapper");var c=a.data();this._clearResizing();this._resize.resizeElement=a;this._resize.target=d;return c;},_resizeStarted:function(b){var c=this._resize.target,a=c.closest(".ws-calendar-main-event-wrapper");this._resize.hint=undefined;this._resize.event=b;this._resize.started=true;this._resize.offset={left:(b.pageX-a.offset().left),top:(b.pageY-a.offset().top)};this._resize.record=this._recordSet.getRecordByPrimaryKey(this._resize.data.key);this._resize.updated=undefined;if(this._resize.record){this._resize.timeStart=this._resize.record.get("ВремяНач");this._resize.timeEnd=this._resize.record.get("ВремяКнц");this._resize.recDate=this._resize.record.get("Дата");this._resize.duration=(this._resize.timeStart!==null&&this._resize.timeEnd!==null)?this.timeToInt(this._resize.timeEnd,true)-this.timeToInt(this._resize.timeStart):this._options.quantum;this._resize.hintColor=this._resize.record.hasColumn("Цвет")?this._resize.record.get("Цвет"):this._options.defaultColor;}},_checkMoveDistance:function(a){if(!this._resize.started){var c=Math.abs(a.clientX-this._resize.startPoint.x),b=Math.abs(a.clientY-this._resize.startPoint.y);if(c+b>2){this._resize.resizeElement.addClass("resizing");this._resizeStarted(a);}else{return true;}}return false;},_resizeMouseMove:function(a){a=this._fixEvent(a);if(this._checkMoveDistance(a)){return true;}$ws.helpers.clearSelection();this._resize.event=a;this._resizeBlock($(a.target));return false;},_resizeMouseUp:function(b){$(document).unbind(".wsResize");if(!this._resize.started){this._resizeEnd(this._resize.data);return false;}this._resize.event=this._fixEvent(b);$ws.helpers.clearSelection();var c;if(this._resize.target){c={data:this._resize.data,target:this._resize.target,event:this._resize.event};if(this._notify("onResizeStop",c)!==false){this._resizeDone(this._resize.target);}}this._resizeEnd(this._resize.data);this._resize.started=false;var a=this;this._resized=true;setTimeout(function(){a._resized=false;},0);return false;},_resizeEnd:function(a){this._container.removeClass("ws-group-resize-over");if(!this._resize.started){}else{if(!(this._resize.updated instanceof $ws.proto.Deferred)){this._clearResizing();}}},_updateResizeRecord:function(c,e,b,a){var d=this,f=this._notify("onMove",c,e,b,a);if(f!==false){c.set("Дата",e);c.set("ВремяНач",b);c.set("ВремяКнц",a);this._resize.hint.addClass("waiting");this._resize.updated=this.update(c,true);if(this._resize.updated instanceof $ws.proto.Deferred){this._resize.updated.addErrback(function(g){d._clearDragging();if(g&&g.message){$ws.core.alert(g.message,"error");}g.processed=true;return g;});}else{this._clearResizing();}}},_getResizeOffset:function(c,e){var f=this._options.quantum%2?this._options.quantum:this._options.quantum/2,b=this.timeToInt(this._resize.timeStart),a=this.timeToInt(this._options.interval.s)+Math.round((e-c.offset().top)/42*this._options.quantum),d=this.timeToInt(this._options.interval.e,true);a=Math.round(a/f)*f;a=(a>24*60)?24*60:a;a=(a>d)?d:a;a=(a<=b)?b+f:a;return{tStart:b,tEnd:a};},_resizeDone:function(c){var b=c.closest(".ws-calendar-event-cell");if(b.length){var a=b.data("date");a=new Date(a.getFullYear(),a.getMonth(),a.getDate());if(this._resize.record){var d=this._getResizeOffset(b,this._resize.event.pageY);if((this._resize.timeStart&&this.timeToInt(this._resize.timeStart)===d.tStart)&&(this._resize.timeEnd&&this.timeToInt(this._resize.timeEnd)===d.tEnd)){this._clearResizing();return;}this._updateResizeRecord(this._resize.record,this._resize.recDate,this._toTime(d.tStart),this._toTime(d.tEnd));}}},_resizeBlock:function(f){var b=f.closest(".ws-calendar-event-cell");if(b.length){var d=b.data("type");var a=b.data("date");var c=a.strftime("%Y-%m-%d");if(!this._resize.hint&&!this._resize.hint){if(this._overlays.main[c]){this._overlays.main[c].append(this._resize.hint=$('<div class="resize-hint-main">'));this._resize.hint.css({"background-color":this._resize.hintColor});}}var e=this.timeToInt(this._options.interval.s),g=this._getResizeOffset(b,this._resize.event.pageY);this._resize.hint.css({top:this._calcOffset(g.tStart,e)+"px",height:this._calcOffset(g.tEnd,g.tStart)+"px"});}return b;}});})();