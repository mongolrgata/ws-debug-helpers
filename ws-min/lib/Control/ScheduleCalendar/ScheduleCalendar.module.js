$ws.declareModule({namespace:"SBIS3.CORE",name:"ScheduleCalendar",imports:["SBIS3.CORE.Control","SBIS3.CORE.Infobox","SBIS3.CORE.DragAndDropPlugin"]},function(a,b){$ws.single.DependencyResolver.register("SBIS3.CORE.ScheduleCalendar",function(){return["/lib/Control/ScheduleCalendar/DragNDrop-plugin.js","/lib/Control/ScheduleCalendar/Resize-plugin.js"];});$ws.proto.ScheduleCalendar=a.DataBoundControl.extend({$protected:{_scrollWidth:undefined,_options:{cellRenderFunc:null,footRenderFunc:null,faces:[],dates:[],interval:{s:new Date(2013,1,1,0,0,0),e:new Date(2013,1,1,23,59,59)},workTime:{s:undefined,e:undefined},displayAllDay:false,quantum:60,showTitle:true,dataSource:undefined,defaultColor:"#E5ECF5",noEventsText:"Нет мероприятий"},_appendFooter:false,_recordSet:undefined,_eventElem:undefined,_rootDiv:undefined,_prevHeight:undefined,_prevTop:undefined,_loadingIndicator:undefined,_header:undefined,_timeline:undefined,_mainWrapper:undefined,_scrollWrapper:undefined,_scrollContainer:undefined,_footerContainer:undefined,_scheduleContainer:undefined,_beforeTable:undefined,_mainTable:undefined,_afterTable:undefined,_lastTable:undefined,_scrollBar:undefined,_dayEvents:undefined,_curTime:{timeline:undefined,today:undefined},_grid:undefined,_overlays:{main:{},top:{},before:{},after:{}},_freeEvents:{},_freeEventsByDate:{},_beforeEvents:{},_beforeEventsByDate:{},_afterEvents:{},_afterEventsByDate:{},_mainEvents:{},_mainEventsByDate:{},_activeEvent:undefined,_renderCurrentTimeID:undefined,_actionState:undefined},$constructor:function(){this._publish("onInit","onEdit","onCreate","onMove","onChangeParams","onChangeCurrent","onDragDrop","onDayClick");if(this._options.displayAllDay){this._options.interval={s:new Date(2000,1,1,0,0,0),e:new Date(2000,1,1,24,0,0)};}this._redraw(true);},_redraw:function(c){if(!c){this._container.html("");}if(typeof(this._options.cellRenderFunc)!=="function"){throw new Error("Cell rendering function not set");}if(typeof(this._options.footRenderFunc)==="function"){this._appendFooter=true;}this._scrollWidth=$ws.helpers.getScrollWidth();this._container.append(this._loadingIndicator=$('<div class="ws-browser-ajax-loader ws-hidden"><div class="ws-loading-indicator-outer"><div class="ws-loading-indicator-block"><div class="ws-loading-indicator">'+($ws._const.theme==="wi_scheme"?"":"Загрузка")+"</div></div></div></div>"));this._container.append(this._rootDiv=$('<div class="ws-calendar-gridcontainer no-r-border no-l-border">'));this.reload();},_buildContainer:function(){this._rootDiv.html("");this._header=$('<div class="ws-calendar-topcontainer">');this._rootDiv.prepend(this._header);this._dayEvents=$('<div class="ws-calendar-top-events-container">');this._rootDiv.append(this._dayEvents);this._scrollContainer=$('<div class="ws-calendar-scroll-container">');this._scrollWrapper=$('<div class="ws-calendar-scroll-wrapper">').css("margin-right","-"+(this._scrollWidth)+"px");this._scrollContainer.append(this._scrollWrapper);this._scrollContainer.append('<div class="border-before-events"></div><div class="border-after-events"></div><div class="border-right-events"></div>');this._scrollWrapper.append(this._mainWrapper=$('<div class="ws-calendar-timed-events-wrapper">'));this._rootDiv.append(this._scrollContainer);if(this._appendFooter){this._footerContainer=$('<div class="ws-calendar-footer">');this._rootDiv.append(this._footerContainer);}},_renderEvent:function(d){var e=this._recordSet.getRecordByPrimaryKey(d),c=this._options.cellRenderFunc.apply(this,[e]);if(c!==null){if(typeof(c)==="string"){c=$ws.helpers.escapeTagsFromStr(c,["script"]);}else{if(c.nodeType){c=$(c);}}}else{c=$("<div/>",{text:""});}return c;},_bindEventHandlers:function(f,e){var h=this._recordSet.getRecordByPrimaryKey(e);f.data({key:e,date:h.get("Дата")});this._eventElem[e]=f;if(h.hasColumn("Описание")){var g=h.get("Описание");f.data({desc:g});f.bind("mouseenter mouseleave",h,function(i){var j;if(i.type=="mouseenter"){j=i.data?"Описание: "+i.data.get("Описание"):"Нет данных";b.show(this,j,300);}else{b.hide(0);}});}var c=function(j){function n(t,s,q){function u(r){var w=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],v=r%16;return""+w[(r-v)/16]+w[v];}return"#"+u(t)+u(s)+u(q);}var m=parseInt(j.substr(1,2),16),l=parseInt(j.substr(3,2),16),i=parseInt(j.substr(5,2),16),p=[25,50,100],k=[{c:m,i:0},{c:l,i:1},{c:i,i:2}];k.sort(function(r,q){return q.c-r.c;});var o=[m,l,i].map(function(r,u){for(var s=0;s<3;s++){var q=k[s].i;if(q==u){var t=r-Math.round(p[s]*(r/255));return t>0?t:0;}}return r;});return n(o[0],o[1],o[2]);};var d=h.hasColumn("Цвет")?h.get("Цвет"):this._options.defaultColor;d=d?d:this._options.defaultColor;if(!/^#[0-9|A-F]{6}/gi.test(d)){d=this._options.defaultColor;}f.css({"background-color":d,border:"1px solid "+c(d)});if(this._activeEvent&&this._activeEvent==e){this._renderActive(f.parent());}},_renderActive:function(c,d){c=$(c);if(c.hasClass("ws-calendar-active-event")){if(d!==false){$(".ws-calendar-active-event-border",c).show();}else{c.removeClass("ws-calendar-active-event");$(".ws-calendar-active-event-border",c).hide();}}else{if(d!==false){c.addClass("ws-calendar-active-event");c.append('<div class="ws-calendar-active-event-border border-top"></div><div class="ws-calendar-active-event-border border-bottom"></div><div class="ws-calendar-active-event-border border-left"></div><div class="ws-calendar-active-event-border border-right"></div>');}}},_isToday:function(d){var c=new Date();return(c.getDate()==d.getDate()&&c.getMonth()==d.getMonth()&&c.getFullYear()==d.getFullYear());},_renderHeader:function(){var d=this;if(this._options.showTitle){var j=this._options.dates;if(this._header){this._header.html("");}var f=$('<table class="ws-calendar-title" cellpadding="0" cellspacing="0"><tbody><tr></tr></tbody></table>'),c=f.find("tr"),g;c.append($("<td>",{width:"60","class":"ws-calendar-header"}));for(g=0;g<j.length;g++){var e=j[g],k=e.date.strftime("%A, %e %q"),h;c.append(h=$("<th>",{"class":"ws-calendar-header "+(e.holiday?"ws-calendar-header-holiday ":"")+(this._isToday(e.date)?"ws-calendar-header-today ":"")+(g+1>=j.length?"last-child":""),title:k,scope:"col"}).append('<div class="ws-calendar-dayname"><span class="ws-calendar-daylink">'+k+"</span></div>"));if(this._options.dates.length>1){h.find(".ws-calendar-daylink").bind("click",e,function(i){d.setPeriod([i.data]);d.refresh();d._notify("onChangeParams",d._options.dates,d._options.interval);});}}$(".ws-calendar-header-today",c).prev().addClass("p-today");this._header.html(f);}else{if(this._header){this._header.html("");}}},_fixEvent:function(f){f=f||window.event;if(f.pageX===null&&f.clientX!==null){var d=document.documentElement;var c=document.body;f.pageX=f.clientX+(d&&d.scrollLeft||c&&c.scrollLeft||0)-(d.clientLeft||0);f.pageY=f.clientY+(d&&d.scrollTop||c&&c.scrollTop||0)-(d.clientTop||0);}if(!f.which&&f.button){f.which=f.button&1?1:(f.button&2?3:(f.button&4?2:0));}return f;},clickWrapper:function(c){if(typeof(c)!=="function"){return c;}return function(){if(this._resized||this._dropped){return false;}return c.apply(this,arguments);}.bind(this);},_onCreateFreeEvent:function(c){this._onCreate(c);},_onCreateEvent:function(d){var c=$(d.data);c.data({tStart:this._toTime(0),tEnd:this._toTime(0)});this._onCreate(d);},_onCreateTimedEvent:function(i){var g=this,f=$(i.data),h=f.data("date"),d,c;i=g._fixEvent(i);d=this.timeToInt(this._options.interval.s)+Math.round((i.pageY-f.offset().top)/42*this._options.quantum);d=d-d%this._options.quantum;c=d+this._options.quantum;f.data({tStart:this._toTime(d),tEnd:this._toTime(c)});this._onCreate(i);},_onCreate:function(j){var g=this,f=$(j.data),h=f.data("date"),d=f.data("tStart"),c=f.data("tEnd");j.stopImmediatePropagation();if(h!==undefined&&this._recordSet){var i=$ws.core.merge({},g._options.dataSource.filterParams);this._recordSet.createRecord(i).addCallbacks(function(k){function l(m){if(m){g.add(m);}else{k.destroy();}}if(k instanceof $ws.proto.Record){var e=g._notify("onCreate",k,h,d,c);if(e instanceof $ws.proto.Deferred){e.addCallback(l);}else{l(e);}}else{$ws.core.alert("Не удалось создать запись","error");}return k;},function(e){if(e&&e.message){$ws.core.alert(e.message,"error");}e.processed=true;return e;});}},_onEdit:function(g){var d=this,c=$(g.data),f=c.data("key");g.stopImmediatePropagation();if(f!==undefined&&d._recordSet&&d._recordSet.contains(f)){d._recordSet.readRecord(f).addCallbacks(function(h){function i(j){if(j){d.update(j);}}if(h instanceof $ws.proto.Record){d.setActiveEvent(h.getKey());var e=d._notify("onEdit",h);if(e instanceof $ws.proto.Deferred){e.addCallback(i);}else{i(e);}}else{$ws.proto.alert("Не удалось прочитать запись","error");}return h;},function(e){if(e&&e.message){$ws.core.alert(e.message,"error");}e.processed=true;return e;});}},_renderDayEvents:function(){var e=this._options.dates;if(this._dayEvents){this._dayEvents.html("");}if(this._options.displayAllDay){return;}var p=$('<table class="ws-calendar-top-events" cellpadding="0" cellspacing="0"><tbody><tr class="ws-calendar-top-events-row"></tr><tr height="16" class="ws-calendar-top-events-padding"></tr></tbody></table>'),i=p.find(".ws-calendar-top-events-row",p),r=p.find(".ws-calendar-top-events-padding"),f,o,q,l,g;i.append('<td width="60" rowspan="2" class="ws-calendar-top-event-cell ws-calendar-all-day"><div class="ws-calendar-top-event-title">на<br/>день</div></td>');for(var d=0;d<e.length;d++){g=e[d].date;l=g.strftime("%Y-%m-%d");q=this._freeEventsByDate[l];f=$('<td class="ws-calendar-top-event-cell">');f.data({date:g,type:"top-event"});f.addClass((this._isToday(g)?"ws-calendar-today ":""));f.addClass("ws-pointer");f.addClass("can-add");if(d+1>=e.length){f.addClass("last-child");}f.addClass("ws-calendar-droppable");i.append(f);o=f.clone();o.data({date:g,type:"top-event"});r.append(o);if(q&&q.length>0){for(var k=0;k<q.length;k++){var n=q[k],j=$('<div class="ws-calendar-top-event-wrapper">'),c=$('<div class="ws-calendar-top-event">'),m=this._renderEvent(n);j.append(c.html(m));this._bindEventHandlers(c,n);j.bind("click",c,this.clickWrapper(this._onEdit).bind(this));f.append($('<div class="ws-calendar-events-wrapper">').append(j));j.addClass("ws-calendar-draggable");j.data({key:n,type:"top-event"});}}f.bind("click",f,this.clickWrapper(this._onCreateFreeEvent).bind(this));o.bind("click",f,this.clickWrapper(this._onCreateFreeEvent).bind(this));o.prepend(this._overlays.top[l]=$('<div class="top-events-overlay"></div>'));var h=function(s){s.data.td.toggleClass("hover",s.data.flag);s.data.td2.toggleClass("hover",s.data.flag);};f.bind("mousemove",{td:f,td2:o,flag:true},h);o.bind("mousemove",{td:f,td2:o,flag:true},h);f.bind("mouseleave",{td:f,td2:o,flag:false},h);o.bind("mouseleave",{td:f,td2:o,flag:false},h);}i.find(".ws-calendar-all-day").bind("click",function(){this._notify("onDayClick");}.bind(this));this._dayEvents.html(p);},_renderFooter:function(){if(this._footerContainer&&this._footerContainer.length>0){var d=this._options.dates,i,g,e,f,k=new $ws.proto.ParallelDeferred(),j=this;i=$('<table class="ws-calendar-footer-table" cellpadding="0" cellspacing="0"><tbody><tr class="ws-calendar-footer-row"></tr></tbody></table>');g=i.find(".ws-calendar-footer-row");g.append('<td width="60" class="ws-calendar-footer-cell"></td>');this._footerContainer.append(i);for(var c=0;c<d.length;c++){f=d[c];e=$('<td class="ws-calendar-footer-cell"></td>');g.append(e);var h=this._options.footRenderFunc.apply(this,[e,f]);if(h instanceof $ws.proto.Deferred){k.push(h);}}k.done().getResult().addBoth(function(){j._setHeight();});}},_calcOffset:function(d,g){var e=(d instanceof Date)?this.timeToInt(d):d,f=(g instanceof Date)?this.timeToInt(g):g,c=Math.round(42*(e-f)/this._options.quantum)-1;if(e-g===0){return 0;}return c;},_renderCurrentTime:function(){var f=new Date(),g=this._calcOffset(f,this._options.interval.s),e=this.timeToInt(f),d=this.timeToInt(this._options.interval.s),c=this.timeToInt(this._options.interval.e,true);if(e>=d&&e<=c){if(this._curTime.timeline){this._curTime.timeline.css({top:g,display:"block"});}if(this._curTime.today){this._curTime.today.css({top:g,display:"block"});}}else{if(this._curTime.timeline){this._curTime.timeline.css({display:"none"});}if(this._curTime.today){this._curTime.today.css({display:"none"});}}},_toTime:function(d){var c=new Date();c.setHours(d/60);c.setMinutes(d%60);c.setSeconds(0);c.setMilliseconds(0);return c;},_buildIndexArray:function(h){var c=[];for(var j=0;j<h.length;j++){var g=h[j],i=this._recordSet.getRecordByPrimaryKey(g);c.push({type:0,key:g,n:j,time:this.timeToInt(i.get("ВремяНач")),depth:0,maxDepth:undefined});var d=this.timeToInt(i.get("ВремяКнц"));c.push({type:1,key:g,n:j,time:d?d:1440,depth:0,maxDepth:undefined});}function f(k,e){var l=k.time-e.time;if(l===0){l=(e.type-k.type);}if(l===0){l=k.n-e.n;}return l;}c.sort(f);return c;},_renderMainEvents:function(){var U=this._options.dates;if(this._mainWrapper){this._mainWrapper.html("");}var ab,w,r,N,X,x,y,d=this.timeToInt(this._options.interval.s),n=this.timeToInt(this._options.interval.e,true),z=this._options.quantum,h,j,H,v,o,C,Z,L;this._beforeTable=this._mainTable=this._afterTable=this._lastTable=undefined;h=this._toTime(d);j=(n-d)/z;if(this._beforeEvents.length>0||(!this._options.displayAllDay&&this._options.interval.s.equals(this._options.interval.e))){ab=w=this._beforeTable=$('<table class="ws-calendar-main-events before-events" cellpadding="0" cellspacing="0"><tbody></tbody></table>');r=ab.find("tbody");N=$('<tr class="ws-calendar-main-events-row">');N.append('<td width="60" class="ws-calendar-event-cell"><div class="ws-calendar-event-title ws-calendar-title-cell">до <br/>'+this._options.interval.s.strftime("%H:%M")+"</div></td>");for(H=0;H<U.length;H++){L=U[H].date.strftime("%Y-%m-%d");x=this._beforeEventsByDate[L];X=$('<td class="ws-calendar-event-cell">');X.data({date:U[H].date,type:"before-event"});X.addClass("ws-calendar-droppable");X.addClass((this._isToday(U[H].date)?"ws-calendar-today ":""));X.addClass("ws-pointer");X.addClass("can-add");if(H+1>=U.length){X.addClass("last-child");}N.append(X);X.bind("click",X,this.clickWrapper(this._onCreateEvent).bind(this));if(x&&x.length>0){for(y=0;y<x.length;y++){v=x[y];o=$('<div class="ws-calendar-event-wrapper">');C=$('<div class="ws-calendar-event">');Z=this._renderEvent(v);o.append(C.html(Z));this._bindEventHandlers(C,v);o.bind("click",C,this.clickWrapper(this._onEdit).bind(this));o.addClass("ws-calendar-draggable");o.data({key:v,type:"before-event"});X.append($('<div class="ws-calendar-events-wrapper">').append(o));}}X.append(this._overlays.before[L]=$('<div class="before-events-overlay">'));}r.append(N);this._mainWrapper.append(ab);}if(this._options.displayAllDay){ab=w=this._mainTable=$('<table class="ws-calendar-main-events main-events" cellpadding="0" cellspacing="0"><tbody></tbody></table>');r=ab.find("tbody");N=$('<tr class="ws-calendar-main-events-row">');N.append('<td width="60" class="ws-calendar-event-cell"><div class="ws-calendar-event-title ws-calendar-title-cell"><br/></div></td>');for(H=0;H<U.length;H++){L=U[H].date.strftime("%Y-%m-%d");x=this._mainEventsByDate[L];X=$('<td class="ws-calendar-event-cell">');X.data({date:U[H].date,type:"main-event-allday"});X.addClass((this._isToday(U[H].date)?"ws-calendar-today ":""));X.addClass("ws-pointer");X.addClass("can-add");if(H+1>=U.length){X.addClass("last-child");}X.addClass("ws-calendar-droppable");N.append(X);X.bind("click",X,this.clickWrapper(this._onCreateEvent).bind(this));var k=false;if(x&&x.length>0){k=true;for(y=0;y<x.length;y++){v=x[y];o=$('<div class="ws-calendar-event-wrapper">');C=$('<div class="ws-calendar-event">');Z=this._renderEvent(v);o.append(C.html(Z));this._bindEventHandlers(C,v);o.bind("click",C,this.clickWrapper(this._onEdit).bind(this));o.addClass("ws-calendar-draggable");o.data({key:v,type:"main-event-allday"});X.append($('<div class="ws-calendar-events-wrapper">').append(o));}}x=this._freeEventsByDate[L];if(x&&x.length>0){k=true;for(y=0;y<x.length;y++){v=x[y];o=$('<div class="ws-calendar-top-event-wrapper">');C=$('<div class="ws-calendar-top-event">');Z=this._renderEvent(v);o.append(C.html(Z));this._bindEventHandlers(C,v);o.bind("click",C,this.clickWrapper(this._onEdit).bind(this));o.addClass("ws-calendar-draggable");o.data({key:v,type:"top-event"});X.append($('<div class="ws-calendar-events-wrapper">').append(o));}}if(!k){X.append($('<div class="ws-calendar-events-wrapper no-events">'+this._options.noEventsText+"</div>"));}X.append(this._overlays.main[L]=$('<div class="main-events-overlay">'));}r.append(N);this._mainWrapper.append(ab);}else{ab=w=this._mainTable=$('<table class="ws-calendar-main-events main-events" cellpadding="0" cellspacing="0"><tbody></tbody></table>');ab.height(j*42);r=ab.find("tbody");var Q=$('<tr class="ws-calendar-grid" height="0">');Q.append($('<td width="60px" class="ws-calendar-grid-cell"></td>').append(this._timeline=$('<div class="ws-calendar-times-column"></div>')));var S=h;for(V=0;V<j;V++){this._timeline.append('<div class="ws-calendar-event-title" style="height:42px;"><div style="height: 41px" class="ws-calendar-timeline-cell '+(V==j-1?"last-cell":"")+'">'+S.strftime("%H:%M")+"</div></div>");S=this._toTime(this.timeToInt(S)+z);}Q.append(this._grid=$('<td colspan="'+U.length+'"></td>'));var aa=$('<div class="ws-calendar-grid-wrapper"></div>'),q=$('<div class="ws-calendar-warkers"></div>');for(var V=0;V<j;V++){q.append('<div class="ws-calendar-marker-cell'+((V===0)?" ws-first-row":"")+'"><div class="ws-calendar-sub-marker"></div></div>');}this._grid.append(aa.append(q));N=$('<tr class="ws-calendar-main-events-row" height="'+j*42+'">');N.append(X=$('<td width="60" class="ws-calendar-event-cell"></td>'));X.prepend('<div class="ws-calendar-currenttime-wrapper"><div class="nowmarker"></div></div>');this._curTime.timeline=X.find(".nowmarker");for(H=0;H<U.length;H++){L=U[H].date.strftime("%Y-%m-%d");x=this._mainEventsByDate[L];X=$('<td class="ws-calendar-event-cell">');var T=$('<div class="ws-calendar-event-column">');T.css({height:j*42,"margin-bottom":-j*42});X.append(T);X.prepend('<div class="worktime-overlay"></div>');if(this._options.workTime.s){var c=this.timeToInt(this._options.workTime.s);if((c>=d)&&(c<=n)){var O;X.find(".worktime-overlay").append(O=$('<div class="worktime-start"></div>'));O.css("top",this._calcOffset(this._options.workTime.s,d));}}if(this._options.workTime.e){var l=this.timeToInt(this._options.workTime.e);if((l>=d)&&(l<=n)){var Y;X.find(".worktime-overlay").append(Y=$('<div class="worktime-end"></div>'));Y.css("top",this._calcOffset(this._options.workTime.e,d));}}X.append(this._overlays.main[L]=$('<div class="main-events-overlay">'));X.data({date:U[H].date,type:"main-event"});X.addClass("ws-calendar-droppable");if(this._isToday(U[H].date)){X.addClass("ws-calendar-today");X.append('<div class="nowmarker-overlay"></div>');X.find(".nowmarker-overlay").append(this._curTime.today=$('<div class="nowmarker"></div>'));}if(H+1>=U.length){X.addClass("last-child");}N.append(X);var B;T.prepend(B=$('<div class="ws-event-adder ws-hidden"><i class="ws-calendar-add-button"></i></div>'));B.find("i").bind("click",X,this.clickWrapper(this._onCreateTimedEvent).bind(this));X.bind("mousemove",B,function(p){if($(p.target).closest(".main-events-overlay").length===0){var s=p.pageY-$(this).offset().top,i=s-s%21;p.data.removeClass("ws-hidden").css("top",i);}else{p.data.addClass("ws-hidden");}});X.bind("mouseleave",B,function(i){i.data.addClass("ws-hidden");});if(x&&x.length>0){var u=$('<div class="events-wrapper">');T.append(u);var D=this._buildIndexArray(x),K={};for(y=0;y<x.length;y++){K[x[y]]={depth:undefined,width:undefined,maxDepth:undefined};}var m=0,G=0;for(var t=0;t<D.length;t++){if(D[t].type===0){m++;D[t].depth=m;K[D[t].key].depth=m;G=(G<m)?m:G;}else{m--;if(m===0){var F=t;while(F>=0&&!D[F].maxDepth){D[F].maxDepth=G;K[D[F].key].maxDepth=G;F--;}G=0;}}D[t].depth=m;}var R=function(i){var e=Array(i);this.getFreePosition=function(){for(var p=0;p<e.length;p++){if(e[p]===undefined){return p;}}return false;};this.clearPosition=function(s){for(var p=0;p<e.length;p++){if(e[p]===s){e[p]=undefined;break;}}};this.setPosition=function(s,p){e[s]=p;};this.toString=function(){return e.toString();};};var g,M=true;for(t=0;t<D.length;t++){if(M){g=new R(D[t].maxDepth);M=false;}if(D[t].type===0){var E=g.getFreePosition();g.setPosition(E,D[t].key);K[D[t].key].depth=E;}else{g.clearPosition(D[t].key);}if(D[t].depth===0){M=true;}}for(y=0;y<x.length;y++){v=x[y];o=$('<div class="ws-calendar-main-event-wrapper">');C=$('<div class="ws-calendar-event">');Z=this._renderEvent(v);o.append(C.html(Z));var J=this._recordSet.getRecordByPrimaryKey(v);if(J&&(!J.hasColumn("Выполнено")||(J.hasColumn("Выполнено")&&!J.get("Выполнено")))){o.append('<div class="ws-calendar-resizer"><div class="resize-icon"></div></div>');}this._bindEventHandlers(C,v);o.bind("click",C,this.clickWrapper(this._onEdit).bind(this));var P=this._recordSet.getRecordByPrimaryKey(v),A=this.timeToInt(P.get("ВремяНач")),W=this.timeToInt(P.get("ВремяКнц"),true),I=this._calcOffset(A,d),f=this._calcOffset(W,A);o.css({top:I+"px",left:K[v].depth*(100/K[v].maxDepth)+"%",height:f+"px",width:(100/K[v].maxDepth)+"%"});o.addClass("ws-calendar-draggable");o.data({key:v,type:"main-event"});C.css({height:f+"px"});u.append(o);}}}r.append(Q).append(N);this._mainWrapper.append(ab);}if(this._afterEvents.length>0||(!this._options.displayAllDay&&this._options.interval.s.equals(this._options.interval.e))){ab=w=this._afterTable=$('<table class="ws-calendar-main-events after-events" cellpadding="0" cellspacing="0"><tbody></tbody></table>');r=ab.find("tbody");N=$('<tr class="ws-calendar-main-events-row">');N.append('<td width="60" class="ws-calendar-event-cell"><div class="ws-calendar-event-title ws-calendar-title-cell">после<br/>'+this._options.interval.e.strftime("%H:%M")+"</div></td>");for(H=0;H<U.length;H++){L=U[H].date.strftime("%Y-%m-%d");x=this._afterEventsByDate[L];X=$('<td class="ws-calendar-event-cell">');X.data({date:U[H].date,type:"after-event"});X.addClass("ws-calendar-droppable");X.addClass((this._isToday(U[H].date)?"ws-calendar-today ":""));X.addClass("ws-pointer");X.addClass("can-add");if(H+1>=U.length){X.addClass("last-child");}N.append(X);X.bind("click",X,this.clickWrapper(this._onCreateEvent).bind(this));if(x&&x.length>0){for(y=0;y<x.length;y++){v=x[y];o=$('<div class="ws-calendar-event-wrapper">');C=$('<div class="ws-calendar-event">');Z=this._renderEvent(v);o.append(C.html(Z));this._bindEventHandlers(C,v);o.bind("click",C,this.clickWrapper(this._onEdit).bind(this));o.addClass("ws-calendar-draggable");o.data({key:v,type:"after-event"});X.append($('<div class="ws-calendar-events-wrapper">').append(o));}}X.append(this._overlays.after[L]=$('<div class="after-events-overlay">'));}r.append(N);this._mainWrapper.append(ab);}this._lastTable=w.addClass("last-table");},timeToInt:function(e,c){var d=e.getHours()*60+e.getMinutes();return c&&(d===0)?1440:d;},_prepareEventArrays:function(){this._eventElem=[];this._freeEvents=[];this._freeEventsByDate=[];this._beforeEvents=[];this._beforeEventsByDate=[];this._afterEvents=[];this._afterEventsByDate=[];this._mainEvents=[];this._mainEventsByDate=[];this._fixInterval();if(this._recordSet){this._recordSet.rewind();var d,c=this._options.dates;while((d=this._recordSet.next())!==false){var o=d.get("Дата"),e=o.strftime("%Y-%m-%d"),j;for(j in c){if(c.hasOwnProperty(j)){if(o.getMonth()==c[j].date.getMonth()&&o.getFullYear()==c[j].date.getFullYear()&&o.getDate()==c[j].date.getDate()){var k=d.get("ВремяНач"),l=d.get("ВремяКнц"),f=this._options.interval,m=d.getKey();if(k===null||l===null){this._freeEvents.push(m);if(!this._freeEventsByDate[e]){this._freeEventsByDate[e]=[];}this._freeEventsByDate[e].push(m);}else{if(f.s&&f.e){if(this.timeToInt(k)<this.timeToInt(f.s)){this._beforeEvents.push(m);if(!this._beforeEventsByDate[e]){this._beforeEventsByDate[e]=[];}this._beforeEventsByDate[e].push(m);}else{if(this.timeToInt(k)>=this.timeToInt(f.e,true)){this._afterEvents.push(m);if(!this._afterEventsByDate[e]){this._afterEventsByDate[e]=[];}this._afterEventsByDate[e].push(m);}else{this._mainEvents.push(m);if(!this._mainEventsByDate[e]){this._mainEventsByDate[e]=[];}this._mainEventsByDate[e].push(m);}}}else{this._mainEvents.push(m);if(!this._mainEventsByDate[e]){this._mainEventsByDate[e]=[];}this._mainEventsByDate[e].push(m);}}break;}}}}}var n=this,h=function(q,p){var s=n._recordSet.getRecordByPrimaryKey(q),r=n._recordSet.getRecordByPrimaryKey(p),i;i=n.timeToInt(s.get("ВремяНач"))-n.timeToInt(r.get("ВремяНач"));if(i===0){i=n.timeToInt(r.get("ВремяКнц"),true)-n.timeToInt(s.get("ВремяКнц"),true);}if(i===0){i=q-p;}return i;},g=function(q,p){var i,s=parseInt(q,10),r=parseInt(p,10);if(!isNaN(s)&&!isNaN(r)){i=s-r;}else{i=q>p?1:(q<p?-1:0);}return i;};this._freeEvents.sort(g);for(j in this._freeEventsByDate){if(this._freeEventsByDate.hasOwnProperty(j)){this._freeEventsByDate[j].sort(g);}}this._beforeEvents.sort(h);for(j in this._beforeEventsByDate){if(this._beforeEventsByDate.hasOwnProperty(j)){this._beforeEventsByDate[j].sort(h);}}this._mainEvents.sort(h);for(j in this._mainEventsByDate){if(this._mainEventsByDate.hasOwnProperty(j)){this._mainEventsByDate[j].sort(h);}}this._afterEvents.sort(h);for(j in this._afterEventsByDate){if(this._afterEventsByDate.hasOwnProperty(j)){this._afterEventsByDate[j].sort(h);}}},reload:function(c){var d=this;if(!c){d._loadingIndicator.removeClass("ws-hidden");}this._initDataSource().addCallback(function(e){d._recordSet=e;d._loadingIndicator.addClass("ws-hidden");d.refresh();return e;}).addErrback(function(e){d._loadingIndicator.addClass("ws-hidden");d.refresh();if(e&&e.message){$ws.core.alert(e.message,"error");}e.processed=true;return e;});},refresh:function(){var c=this;this._prevTop=this._scrollWrapper?this._scrollWrapper.scrollTop():0;this._prevHeight=this._mainWrapper?this._mainWrapper.height():0;c._buildContainer();c._prepareEventArrays();c._renderHeader();c._renderDayEvents();c._renderMainEvents();if(this._appendFooter){c._renderFooter();}c._setHeight();this._renderCurrentTime();if(this._prevHeight===this._mainWrapper.height()){this._scrollWrapper.scrollTop(this._prevTop);}clearInterval(this._renderCurrentTimeID);this._renderCurrentTimeID=setInterval(this._renderCurrentTime.bind(this),1000);},update:function(d,c){var e=this;if(this._recordSet){return this._recordSet.updateRecord(d).addCallback(function(){e.reload(c);});}return false;},add:function(c){var d=this;if(c instanceof $ws.proto.Record){return c.update().addCallback(function(e){d.reload(true);d.setActiveEvent(e);});}return new $ws.proto.Deferred().callback();},remove:function(d){var c=this;return this._recordSet.deleteRecord(d).addCallback(function(){c.reload();});},_fixInterval:function(){var d=this.timeToInt(this._options.interval.s),c=this.timeToInt(this._options.interval.e,true);d=d-d%this._options.quantum;c=c+(c%this._options.quantum?(this._options.quantum-c%this._options.quantum):0);this._options.interval.s=this._toTime(d);this._options.interval.e=this._toTime(c);},setPeriod:function(c){this._options.dates=c;this._notify("onChangeParams",this._options.dates,this._options.interval);},getPeriod:function(){return this._options.dates;},setInterval:function(d,c){this._options.interval={s:d,e:c};this._fixInterval();this._notify("onChangeParams",this._options.dates,this._options.interval);},displayAllDay:function(c){this._options.displayAllDay=(c===undefined)?true:c;if(this._options.displayAllDay){this._options.interval={s:new Date(2000,1,1,0,0,0),e:new Date(2000,1,1,24,0,0)};}},getInterval:function(){return[this._options.interval.s,this._options.interval.e];},setActiveEvent:function(c){if(this._recordSet.contains(c)){if(this._eventElem[this._activeEvent]){this._renderActive(this._eventElem[this._activeEvent].parent(),false);}if(this._eventElem[c]){this._renderActive(this._eventElem[c].parent());}this._activeEvent=c;this._notify("onChangeCurrent",this._recordSet.getRecordByPrimaryKey(c));}else{this._notify("onChangeCurrent",null);}},getActiveEvent:function(){return this._activeEvent;},setQuantum:function(c){this._options.quantum=c;this.refresh();},getQuantum:function(){return this._options.quantum;},setFaces:function(c){this._options.faces=c;},getFaces:function(){return this._options.faces;},setWorkTime:function(d,c){this._options.workTime={s:d,e:c};this._notify("onChangeParams",this._options.dates,this._options.interval);},showTitle:function(){this._options.showTitle=true;this.refresh();},hideTitle:function(){this._options.showTitle=false;this.refresh();},undo:function(){},_initDataSource:function(){var c=this._options.dataSource,g=$ws.core.merge(c.filterParams,{}),m=new $ws.proto.Deferred();var d=undefined,j=undefined,k,e=this._options.dates;for(k in e){if(e.hasOwnProperty(k)){if(!j||(j>e[k].date)){j=e[k].date;}if(!d||(d<e[k].date)){d=e[k].date;}}}g["ДатНач"]=j;g["ДатКнц"]=d;g["Лица"]=this._options.faces;c=$ws.core.merge(c,{filterParams:g});c.firstRequest=true;var h=$ws.core.merge({},c);h=$ws.core.merge(h,{handlers:{onAfterLoad:function l(o,n,f,i){n.unsubscribe("onAfterLoad",l);if(f){m.callback(n);}else{m.errback(i);}}}});$ws.core.attachInstance("Source:RecordSet",h);return m;},_onResizeHandler:function(){this._setHeight();},_setHeight:function(){if(this._scrollWrapper){var c=this._header.height(),i=this._dayEvents.height(),f=this._appendFooter?this._footerContainer.height():0;if(!this._options.autoHeight||(this._options.autoHeight&&this._verticalAlignment==="Stretch")){this._scrollWrapper.css("height",Math.min(this._container.height()-c-i-f,this._mainWrapper.height()));}else{this._scrollWrapper.css("height","auto");var j=this._options.minHeight;if(j>0){this._container.css("min-height",j);if(this._beforeTable&&this._afterTable){var e=Math.round((j-i-c)/2);var d=parseInt(this._beforeTable.css("height").slice(0,-2),10);var g=parseInt(this._afterTable.css("height").slice(0,-2),10);if(!isNaN(d)&&(d<e)){this._beforeTable.css("height",e);}if(!isNaN(g)&&(g<e)){this._afterTable.css("height",e);}}else{if(this._lastTable.hasClass("after-events")){this._lastTable.css("height","");this._lastTable.css("height",Math.max(j-c-i-(this._beforeTable?this._beforeTable.height():0)-(this._mainTable?this._mainTable.height():0),0));}else{if(this._lastTable.hasClass("main-events")){if(this._options.displayAllDay){this._lastTable.css("height","");this._lastTable.css("height",Math.max(j-c-i-(this._beforeTable?this._beforeTable.height():0),0));}else{}}}}}}}}});return $ws.proto.ScheduleCalendar;});