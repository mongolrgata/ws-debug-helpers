$ws.declareModule({namespace:"SBIS3.CORE",name:"FieldMonth",imports:["SBIS3.CORE.FieldAbstract"]},function(a){$ws._const.FieldMonth={monthsCount:12,flowOffset:{top:8,left:-65},menuWidth:130};$ws.proto.FieldMonth=a.extend({$protected:{_options:{viewType:"month",titleRender:undefined,monthRender:undefined,cssClassName:"ws-date-month"},_buttonsBlock:undefined,_menuCreate:false,_menuShowed:false,_flowBlock:undefined,_menuTitle:undefined,_monthsBlock:undefined,_viewedYear:0,_hoverMonth:undefined,_keysWeHandle:[$ws._const.key.plus,$ws._const.key.minus,$ws._const.key.right,$ws._const.key.left,$ws._const.key.up,$ws._const.key.down,$ws._const.key.del,$ws._const.key.insert,$ws._const.key.esc,$ws._const.key.f7,$ws._const.key.enter]},$constructor:function(){this._init();this._declareCommands();},_declareCommands:function(){$ws.single.CommandDispatcher.declareCommand(this,"nextDate",this.nextDate);$ws.single.CommandDispatcher.declareCommand(this,"prevDate",this.prevDate);$ws.single.CommandDispatcher.declareCommand(this,"clear",this.clear);$ws.single.CommandDispatcher.declareCommand(this,"selectToday",this.selectToday);},_init:function(){this._curval=this._trimDate(new Date());if(this._options.readonly){this.setEnabled(false);}},_trimDate:function(b){b.setDate(1);b.setHours(0,0,0,0);if(this._options.viewType!=="month"){b.setMonth(0);}return b;},_getDefaultValue:function(){if(this._options.value){var b=this,d=function(f){var e=f.split("/");if(e.length===3&&!isNaN(parseInt(e[0],10))&&!isNaN(parseInt(e[1],10))&&!isNaN(parseInt(e[2],10))){return new Date(e[2],e[1]-1,e[0]);}return new Date();},c=function(e){if(e instanceof Date){return b._trimDate(e);}else{if(typeof(e)==="string"){return b._trimDate(d(e));}}return null;};if(typeof(this._options.value)==="function"){return c(this._options.value());}return c(this._options.value);}return this._trimDate(new Date());},_createMarkup:function(){var b=$ws.proto.FieldMonth.superclass._createMarkup.apply(this,arguments),d=(this._options.viewType==="month"?"месяц":"год"),c='<div class="ws-date-month-button ws-date-month-button-left ws-date-month-button-enabled" title="Выбрать предыдущий '+d+'"></div><div class="ws-date-month-button ws-date-month-button-right ws-date-month-button-enabled" title="Выбрать следующий '+d+'"></div><div class="ws-date-month-title-block" title="{{=it.tooltip}}"></div>';return this._extendMarkup(b,c);},_bindInternals:function(){this._inputControl=this._container.find(".ws-date-month-title-block");this._buttonsBlock=this._container.find(".ws-date-month-button");this._initEvents();},_initEvents:function(){var b=this;this._container.find(".ws-date-month-button").click(function(c){b._onClickHandler(c);if(b.isEnabled()){b[$(this).hasClass("ws-date-month-button-right")?"nextDate":"prevDate"]();}});$(".ws-date-month-title",this._inputControl.get(0)).live("click",this._titleClick.bind(this));},_titleClick:function(){if(!this._options.enable){return;}this._toggleMenu();},_modifyDate:function(b){if(this._options.viewType==="month"){this._curval.setMonth(this._curval.getMonth()+b);}else{this._curval.setFullYear(this._curval.getFullYear()+b);}this._updateTitle();this._onValueChangeHandler();},_setValueInternal:function(b){if(b instanceof Date){this._curval=new Date(b);}else{if(b===null){this._curval=new Date();}else{if(typeof(b)==="string"){this._curval=Date.fromSQL(b);}}}this._trimDate(this._curval);this._updateTitle();},_updateTitle:function(){var c;if(this._options.titleRender){c=this._options.titleRender.call(this,new Date(this._curval));}else{var b="ws-date-month-title";if(this._options.viewType!=="month"){b+="-year";}c='<span class="'+b+'">'+this.getStringValue()+"</span>";}this._inputControl.empty().append(c);},_updateMenuTitle:function(){this._menuTitle.text(this._viewedYear);},_updateMonths:function(){this._monthsBlock.empty();for(var c=0;c<$ws._const.FieldMonth.monthsCount;++c){var b;if(this._options.monthRender){b=this._options.monthRender.call(this,new Date(this._viewedYear,c,1));}else{b=$ws._const.Date.longMonths[c];}$('<div class="ws-field-month-element'+(c===this._hoverMonth?" hover":"")+'" data-month="'+c+'">'+b+"</div>").appendTo(this._monthsBlock);}},_getMenuTemplate:function(){return'<div class="ws-date-month-flow" tabindex="0"><div class="ws-date-month-flow-arrow"></div><div class="ws-date-month-flow-title-block"><div class="ws-date-month-button ws-date-month-year ws-date-month-button-left ws-date-month-button-enabled" title="Показать предыдущий год"></div><div class="ws-date-month-button ws-date-month-year ws-date-month-button-right ws-date-month-button-enabled" title="Показать следующий год"></div><div class="ws-date-month-flow-title"></div></div><div class="ws-date-month-flow-months"></div></div>';},_buildMenu:function(){if(this._menuCreated){return;}this._menuCreated=true;this._flowBlock=$(this._getMenuTemplate()).appendTo("body");this._bindMenuEvents();this._bindMenuElements();},_unMarkHoverMonth:function(){this._monthsBlock.children().eq(this._hoverMonth).removeClass("hover");},_disableHoverMonth:function(){if(this._hoverMonth!==undefined){this._unMarkHoverMonth();this._hoverMonth=undefined;}},_bindMenuEvents:function(){this._flowBlock.bind("keydown",this._keyboardHover.bind(this));$(document).bind("mousedown."+this.getId()+" wsmousedown."+this.getId(),function(b){var c=$(b.target),d=this._container.find(".ws-date-month-title");d.push(this._flowBlock.get(0));if(this._menuShowed&&c.closest(d).size()===0){if(/block/.test(this._flowBlock.css("display"))){this._hideMenu();}}}.bind(this));},_bindMenuElements:function(){var b=this;this._menuTitle=this._flowBlock.find(".ws-date-month-flow-title");this._monthsBlock=this._flowBlock.find(".ws-date-month-flow-months");this._monthsBlock.bind("mouseleave",this._disableHoverMonth.bind(this));$(".ws-field-month-element",this._flowBlock.get(0)).live("click",function(){b._selectMonth(parseInt($(this).data("month"),10));}).live("mouseenter",function(){b._selectHoverMonth(parseInt($(this).data("month"),10));});this._flowBlock.find(".ws-date-month-button-left").click(function(){b._modifyViewedYear(-1);});this._flowBlock.find(".ws-date-month-button-right").click(function(){b._modifyViewedYear(+1);});},_selectViewedYear:function(){this._curval.setFullYear(this._viewedYear);this._updateTitle();this._onValueChangeHandler();this._hideMenu();},_selectMonth:function(b){this._curval.setMonth(b);this._selectViewedYear();},_modifyViewedYear:function(b){this._viewedYear+=b;this._updateMenuTitle();if(this._options.monthRender){this._updateMonths();}},selectToday:function(){this._curval=this._trimDate(new Date());this._updateTitle();this._onValueChangeHandler();},clear:function(){this.selectToday();},nextDate:function(){this._modifyDate(+1);},prevDate:function(){this._modifyDate(-1);},_showMenu:function(){if(this._options.viewType!=="month"){return;}this._buildMenu();if(!this._menuShowed){this._menuShowed=true;this._viewedYear=this._curval.getFullYear();this._hoverMonth=undefined;this._updateMenuTitle();this._updateMonths();this._buttonsBlock.addClass("ws-hidden");this._flowBlock.show();var d=this._container.offset(),c=this._container.width(),b=this._container.height();d.left+=$ws._const.FieldMonth.flowOffset.left+c/2;d.top+=$ws._const.FieldMonth.flowOffset.top+b;this._flowBlock.css($ws.helpers.positionInWindow(d,$ws._const.FieldMonth.menuWidth,this._flowBlock.outerHeight()));this._flowBlock.focus();this._container.trigger("wsSubWindowOpen");}},_hideMenu:function(){if(this._menuShowed){this._menuShowed=false;this._buttonsBlock.removeClass("ws-hidden");if(this._flowBlock){this._flowBlock.hide();}if(this.isActive()){this._container.focus();}this._container.trigger("wsSubWindowClose");}},_toggleMenu:function(){if(this._menuShowed){this._hideMenu();}else{this._showMenu();}},setActive:function(b){$ws.proto.FieldMonth.superclass.setActive.apply(this,arguments);if(!b){this._hideMenu();}},_setDisableAttr:function(b){if(!b){this._hideMenu();}this._inputControl.toggleClass("ws-date-month-disabled",!b);this._buttonsBlock.toggleClass("ws-date-month-button-disabled",!b).toggleClass("ws-date-month-button-enabled",b);},setEnabled:function(b){$ws.proto.FieldMonth.superclass.setEnabled.apply(this,arguments);if(!b){this._hideMenu();}},_notFormatedVal:function(){return this._curval?new Date(this._curval):null;},_onValueChangeHandler:function(){$ws.proto.FieldMonth.superclass._onValueChangeHandler.apply(this,arguments);this.validate();},destroy:function(){if(this._flowBlock){this._flowBlock.empty().remove();}$(document).unbind("."+this.getId());if(this._menuShowed){this._container.trigger("wsSubWindowClose");}$ws.proto.FieldMonth.superclass.destroy.apply(this,arguments);},_selectHoverMonth:function(b){this._unMarkHoverMonth();this._hoverMonth=b;this._monthsBlock.children().eq(this._hoverMonth).addClass("hover");},_moveMenuMonth:function(c){var b;if(this._hoverMonth===undefined){if(c>0){b=c-1;}else{b=c;}}else{this._unMarkHoverMonth();b=this._hoverMonth+c;}b=(b+12)%12;this._selectHoverMonth(b);},_keyboardHover:function(b){if(b.shiftKey||b.altKey||b.ctrlKey){return true;}if(b.which===$ws._const.key.plus||b.which===$ws._const.key.right){if(this._menuShowed){this._modifyViewedYear(+1);}else{this.nextDate();}}else{if(b.which===$ws._const.key.up){if(this._menuShowed){this._moveMenuMonth(-1);}else{this.nextDate();}}else{if(b.which===$ws._const.key.minus||b.which===$ws._const.key.left){if(this._menuShowed){this._modifyViewedYear(-1);}else{this.prevDate();}}else{if(b.which===$ws._const.key.down){if(this._menuShowed){this._moveMenuMonth(+1);}else{this.prevDate();}}else{if(b.which===$ws._const.key.del){this.clear();}else{if(b.which===$ws._const.key.insert){this.selectToday();}else{if(b.which===$ws._const.key.esc){if(this._menuShowed){this._hideMenu();}else{return true;}}else{if(b.which===$ws._const.key.f7){this._toggleMenu();}else{if(b.which===$ws._const.key.enter){if(this._menuShowed){if(this._hoverMonth!==undefined){this._selectMonth(this._hoverMonth);}else{this._selectViewedYear();}}else{this._showMenu();}}}}}}}}}}return false;},getStringValue:function(){if(this._options.viewType==="month"){return this._curval.strftime("%B, %Y");}return this._curval.strftime("%Y");},_redraw:function(b){if((b&&!this._hasMarkup())||!b){if(!$ws.proto.FieldMonth.__markupTemplate){$ws.proto.FieldMonth.__markupTemplate=doT.template(this._getMarkupTemplate());}this._container.html($ws.proto.FieldMonth.__markupTemplate(this._options));}}});return $ws.proto.FieldMonth;});