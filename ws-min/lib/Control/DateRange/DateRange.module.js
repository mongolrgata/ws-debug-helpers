$ws.declareModule({namespace:"SBIS3.CORE",name:"DateRange",imports:["SBIS3.CORE.Control"]},function(a){$ws._const.DateRange={rowHeight:30,startOffset:0,startYearOffset:0,scrollCount:30,yearOffset:3,menuOffset:{top:-5,left:-5},separatorWidth:29};$ws.proto.DateRange=a.DataBoundControl.extend({$protected:{_options:{dateFromName:"",dateToName:"",dateFromValue:"",dateToValue:"",validators:[],textView:false},_fieldsTabindex:undefined,_dateControls:[],_datesDeferred:undefined,_menuBlock:undefined,_menuShowed:false,_calendarBlock:undefined,_currentDate:undefined,_currentYear:undefined,_yearBlock:undefined,_yearScrollerBlock:undefined,_yearScroller:undefined,_yearScrollerShowed:false,_daysScroller:undefined,_state:0,_range:[null,null],_selectionSlider:undefined,_tipSlider:undefined,_rangeEndAt:1,_menuControlsRow:undefined,_movingControlsBlock:undefined,_months:[],_prevMonth:undefined,_daysCells:[],_rangeMarks:[],_monthSelection:undefined,_toggledButtons:[],_selectionMarker:undefined,_errorMarker:undefined,_errorMessage:"",_rangeTitle:undefined,_validationErrors:[0,0],_textField:undefined},$constructor:function(){this._publish("onChange","onMenuHide");this._datesDeferred=new $ws.proto.Deferred();this._container.addClass("clearfix").addClass("ws-date-range");this._currentDate=new Date();this._currentYear=this._currentDate.getFullYear();this._container.removeAttr("tabindex");this._initValidation();var b=this;this._childIsVisible=function(){return $ws.proto.FieldDate.prototype.isVisible.apply(this)&&b.isVisible();};},_initValidation:function(){this._options.validators.push({validator:function(){return !this._range[0]||!this._range[1]||this._range[0]<=this._range[1];}.bind(this),errorMessage:"Дата начала периода не может быть больше даты окончания"});},_childIsVisible:null,_getDefaultValue:function(){var b=function(f,e){var d;if(!f.split||(d=f.split("/")).length!==3){$ws.single.ioc.resolve("ILogger").log("DateRange","Incorrect date format");return new Date();}if(e){return new Date(d[2],d[1]-1,d[0],23,59,59);}return new Date(d[2],d[1]-1,d[0]);},c=function(e,d){if(typeof(e)==="function"){e=e();if(e instanceof Date){return e;}}if(!e){return null;}return b(e,d);};return[c(this._options.dateFromValue,false),c(this._options.dateToValue,true)];},_onContextValueReceived:function(b){if(b!==undefined){this.setValue(b);}},_contextUpdateHandler:function(d,g,e){var c=this._options.name,i=function(j){if(j instanceof Date){return j;}else{if(typeof(j)==="string"){return Date.fromSQL(j);}}return j;},h=i(this._context.getValue(this.getDateFromName())),f=i(this._context.getValue(this.getDateToName()));if(c!==""&&this._context){if(g){if(g===c){this._onContextValueReceived(e);}else{if(g===this.getDateFromName()){this._setRange(e,f);}else{if(g===this.getDateToName()){this._setRange(h,e);}}}}else{var b=this._context.getValue(c);if(b!==undefined){this._onContextValueReceived(b);}else{if(h!==undefined||f!==undefined){this._onContextValueReceived([h,f]);}}}}},init:function(){$ws.proto.DateRange.superclass.init.apply(this,arguments);this._initDateContainer();},_initDateContainer:function(){var b=this;if(this._options.textView){var c="<Диапозон дат не установлен>";if(this._options.dateFromValue&&this._options.dateToValue){this._state=2;c=this._getRangeTitle();}this._container.append(this._textField=$('<div class="ws-date-range-text">'+c+"</div>").bind("click",function(){if(b._options.enable){b._showMenu(0);}}));this._textField.addClass(this._options.enable?"ws-enabled":"ws-disabled");}else{this._createControlsBlock();}},_registerToParent:function(b){if(this._options.tabindex){this._options.tabindex=parseInt(this._options.tabindex,10);}if(!this._options.textView){this._fieldsTabindex=this._options.tabindex;this.setTabindex(false,true);}$ws.proto.DateRange.superclass._registerToParent.apply(this,arguments);},_createControlsBlock:function(){var b=this;this._container.append(this._movingControlsBlock=$('<div class="ws-date-range-input-block ws-'+(this._options.enable?"enabled":"disabled")+'"></div>'));var d=this.getParent();if(d){this._movingControlsBlock.bind("keydown",function(f){if(b._menuShowed&&f.which===$ws._const.key.tab){return d.moveFocus(f);}else{if(f.which===$ws._const.key.f7&&b._options.enable){f.preventDefault();b._toggleMenu(0);return false;}else{if(f.which===$ws._const.key.esc&&b._menuShowed){b._hideMenuAndMoveFocus(0);}}}return true;});}for(var c=0;c<2;++c){this._rangeMarks.push($('<div class="ws-date-range-'+(c===0?"start":"end")+'-selection"></div>'));(function(e){$ws.core.attachInstance("SBIS3.CORE.FieldDate",{mask:"DD.MM.YYYY",parent:b.getParent(),calendar:false,width:"auto",element:$('<div class="ws-date-range-block"></div>').appendTo(b._movingControlsBlock),"float":"left",tabindex:b._fieldsTabindex?b._fieldsTabindex+e:false,name:b._options[e===0?"dateFromName":"dateToName"],value:b._range[e]?new Date(b._range[e]):null,enable:b._options.enable,linkedContext:b.getLinkedContext(),subcontrol:true,handlers:{onChange:function(g,f){if(f!==null&&b._range[e]!==null){if(b._range[e].getTime()===f){return;}}b._range[e]=f;if(f===null){--b._state;if(b._state<0){b._state=0;}b._rangeEndAt=(e!==0);}else{if(b._range[0]&&b._range[1]&&b._range[0]<=b._range[1]){b._state=2;}else{b._state=0;}}b._updateRange();b._updateSelectionSlider();b._updateSelection();b._rangeReady();},onActivated:function(){if(b._options.enable){b._toggleMenu(e);}},onFocusIn:function(){b._movingControlsBlock.addClass("has-focused-children");},onFocusOut:function(g,f,h){b._movingControlsBlock.removeClass("has-focused-children");if(b._menuShowed&&h!==b._dateControls[0]&&h!==b._dateControls[1]){b._hideMenu();}}}}).addCallback(function(f){f.isVisible=b._childIsVisible;b._setupErrorBoxEventsToggler(b._container,f);f.validate=function(){var g=$ws.proto.FieldDate.prototype._invokeValidation.apply(this,arguments);b._validationErrors[e]=!g.result;if(g.errors.length>0){b._toggleError(true,g.errors);}return g.result;};b._dateControls.push(f);f.setValue(b._range[e]);b.getLinkedContext().setValue(b._options[e===0?"dateFromName":"dateToName"],b._range[e],undefined,true);if(e===1){b._movingControlsBlock.width(b._dateControls[0].getContainer().find(".ws-field").outerWidth()+$ws._const.DateRange.separatorWidth+b._dateControls[1].getContainer().find(".ws-field").outerWidth());b._datesDeferred.callback();if(b._range[0]&&b._range[1]){b._state=2;}b._notify("onReady");}else{}});if(e===0){b._movingControlsBlock.append('<div class="ws-date-range-block delimeter"></div>').bind("click",function(){if(b._options.enable){b._toggleMenu(0);}});}})(c);}},_buildMenu:function(){var f,k,m,g,b,h,e,l=this,j='<table border="0" width="100%" cellpadding="0" cellspacing="0"></table>',c="<tr></tr>";this._menuBlock=$('<div class="ws-date-range-menu-block clearfix"></div>').appendTo($("body")).hide();this._menuControlsRow=$('<div class="ws-date-range-menu-dates"></div>').appendTo(this._menuBlock);this._errorMarker=$('<img class="ws-date-range-error-marker" width="22" height="22" src="'+$ws._const.wsRoot+($ws._const.theme===""||$ws._const.theme==="wi"?"img/daterange":"img/themes/"+$ws._const.theme)+'/validation_error.png">').appendTo(this._menuControlsRow);this._setupErrorBoxEventsToggler(this._errorMarker);$('<div class="ws-date-range-close" title="Закрыть">Установить</div>').appendTo(this._menuControlsRow).bind("click",function(){l._hideMenuAndMoveFocus(0);});this._rangeTitle=$('<div class="ws-date-range-title" title="Очистить выделение"></div>').appendTo(this._menuControlsRow).bind("click",function(){l._range[0]=l._range[1]=null;l._state=0;l._updateRange();l._updateSelectionAndFocus();l._updateSelectionSlider();l._rangeReady();});e=$('<div class="ws-date-range-menu-bot"></div>').appendTo(this._menuBlock);b=$('<div class="ws-date-range-menu-left"></div>').appendTo(e);b.append(f=$('<div class="ws-date-range-months"></div>'));f.append('<div class="ws-date-range-months-bg"></div>');f.append(this._monthSelection=$('<div class="ws-date-range-month-selection"></div>'));f.append(this._selectionSlider=$('<div class="ws-date-range-slider left right"><div class="ws-date-range-slider-bg"></div></div>').hide());f.append(this._tipSlider=$('<div class="ws-date-range-slider preselected left right"><div class="ws-date-range-slider-bg"></div></div>').hide());f.append(k=$(j));k.append(m=$(c));for(g=0;g<12;++g){this._months.push($('<td class="ws-date-range-month" title="Показать '+$ws._const.Date.longMonthsSmall[g]+', либо выбрать/снять выделение (при двойном клике)"><div class="ws-date-range-month-text"><div class="ws-date-range-month-selection2"></div>'+$ws._const.Date.monthsBig[g]+"</div></td>").appendTo(m).bind("click dblclick",{month:g},function(n){if(n.type==="click"){var i=new Date(l._currentYear,n.data.month,1);l._setMonday(i);l._daysScroller.setDate(i);}else{$ws.helpers.clearSelection();l._selectMonths(n.data.month,n.data.month+1,n);}return false;}));}b.append(f=$('<div class="ws-date-range-days"></div>'));f.append(k=$(j));k.append(m=$(c));for(g=0;g<7;++g){m.append('<td class="ws-date-range-day">'+$ws._const.Date.daysSmall[(g+1)%7]+"</td>");}b.append(this._calendarBlock=$('<div class="ws-date-range-calendar"></div>'));var d=new Date();d.setDate(1);this._setMonday(d);this._daysScroller=this._createScroller(this._calendarBlock,false,d);e.append(h=$('<div class="ws-date-range-menu-right"></div>'));this._yearScrollerBlock=$('<div class="ws-date-range-year-scroller"></div>').appendTo(h);this._yearBlock=$('<div class="ws-date-range-menu-year" title="Выбрать текущий год">'+this._currentYear+"</div>").appendTo(h).bind("click dblclick",function(n){if(n.type==="click"){if(!l._yearScrollerShowed){l._yearScrollerBlock.fadeIn("fast");var i=new Date(l._currentYear-$ws._const.DateRange.yearOffset,0,1);if(!l._yearScroller){l._yearScroller=l._createScroller(l._yearScrollerBlock,true,i);}else{l._yearScroller.setDate(i);}}else{l._yearScrollerBlock.fadeOut("fast");}l._yearScrollerShowed^=true;}else{l._selectMonths(0,12,n);}return false;});this._toggledButtons.push($('<div class="ws-date-range-menu-halfyear" title="Первое полугодие">1</div>').appendTo(h).bind("click mouseover mouseout",{months:[0,6]},$.proxy(this._buttonsHandler,this)));this._toggledButtons.push($('<div class="ws-date-range-menu-halfyear last" title="Второе полугодие">2</div>').appendTo(h).bind("click mouseover mouseout",{months:[6,12]},$.proxy(this._buttonsHandler,this)));this._toggledButtons.push($('<div class="ws-date-range-menu-quarter" title="Первый квартал">I</div>').appendTo(h).bind("click mouseover mouseout",{months:[0,3]},$.proxy(this._buttonsHandler,this)));this._toggledButtons.push($('<div class="ws-date-range-menu-quarter" title="Второй квартал">II</div>').appendTo(h).bind("click mouseover mouseout",{months:[3,6]},$.proxy(this._buttonsHandler,this)));this._toggledButtons.push($('<div class="ws-date-range-menu-quarter" title="Третий квартал">III</div>').appendTo(h).bind("click mouseover mouseout",{months:[6,9]},$.proxy(this._buttonsHandler,this)));this._toggledButtons.push($('<div class="ws-date-range-menu-quarter last" title="Четвёртый квартал">IV</div>').appendTo(h).bind("click mouseover mouseout",{months:[9,12]},$.proxy(this._buttonsHandler,this)));this._selectionMarker=$('<div class="ws-date-range-selection-marker" title="Показать начало выделения"></div>').appendTo(h).bind("click",function(){var i=new Date(l._range[0]);l._setMonday(i);l._daysScroller.setDate(i);});$('<div class="ws-date-range-today">'+this._currentDate.strftime("%d %q %Y")+"</div>").appendTo(h);$('<div class="ws-date-range-today-button" title="Показать на календаре сегодняшний день">Сегодня</div>').appendTo(h).bind("click dblclick",function(q){if(q.type==="dblclick"){var p;if((p=(l._state===2))){for(var o=0;o<2;++o){if(l._range[o].getDate()!==l._currentDate.getDate()||l._range[o].getMonth()!==l._currentDate.getMonth()||l._range[o].getYear()!==l._currentDate.getYear()){p=false;break;}}}if(p){l._state=0;}else{l._state=2;l._range[0]=new Date(l._currentDate);l._range[1]=new Date(l._currentDate);}l._updateRange();l._updateSelectionAndFocus();l._updateSelectionSlider();$ws.helpers.clearSelection();l._rangeReady();}else{l._currentYear=l._currentDate.getFullYear();l._updateYear();var n=new Date(l._currentDate);n.setDate(1);l._setMonday(n);l._daysScroller.setDate(n);}return false;});$(document).bind("mousedown."+this.getId(),function(){if(l._menuBlock){if(/block/.test(l._menuBlock.css("display"))){l._hideMenu();}}});this._menuBlock.bind("mousedown",function(i){i.stopImmediatePropagation();});},_selectMonth:function(b){if(this._prevMonth!=b){if(this._prevMonth!==undefined){this._months[this._prevMonth].removeClass("selected");}this._prevMonth=b;this._months[b].addClass("selected");this._monthSelection.css("left",this._months[b].position()["left"]+"px");}},_showMenu:function(b){if(!this._menuBlock){if(this._options.textView){this._createControlsBlock();}this._buildMenu();}if(!this._menuShowed){if(this._state===2){var c=new Date(this._range[0]);c=this._setMonday(c);this._daysScroller.setDate(c);}this._menuBlock.show();this._setMenuPosition();this._prevMonth=undefined;this._daysScroller.drawCalendar();this._movingControlsBlock.prependTo(this._menuControlsRow);this._menuShowed=true;this._dateControls[b].setActive(true);this._updateSelectionSlider();this._updateRangeTitle();this.clearMark();if(this._errorMessage){this._toggleError(true,this._errorMessage);}this._container.trigger("wsSubWindowOpen");}},_setMenuPosition:function(){var d=this._container.offset(),b=this._menuBlock.outerWidth(),f=this._menuBlock.outerHeight();for(var e in d){if(d.hasOwnProperty(e)){d[e]+=$ws._const.DateRange.menuOffset[e];}}$ws.helpers.positionInWindow(d,b,f);this._menuBlock.css(d);},_hideMenu:function(){if(this._menuBlock){this._menuBlock.hide();if(!this._options.textView){this._movingControlsBlock.prependTo(this._container);}else{this._textField.html(this._state>0?this._getRangeTitle():"<Диапозон дат не установлен>");}this._menuShowed=false;if(this._daysScroller){this._daysScroller.stopTimers();}if(this._yearScroller){this._yearScroller.stopTimers();}if(this._errorMessage){this.markControl(this._errorMessage);}this._notify("onMenuHide");this._container.trigger("wsSubWindowClose");}},_hideMenuAndMoveFocus:function(b){this._hideMenu();if(this._dateControls[b]){this._dateControls[b].setActive(true);}},_toggleMenu:function(b){if(this._menuShowed){this._hideMenu(b);}else{this._showMenu(b);}},setActive:function(c){this._container.removeClass("ws-has-focus");var b=this;this._datesDeferred.addCallback(function(){b._dateControls[0].setActive(c);});},_setMonday:function(b){var c=b.getDay();if(c===0){c=7;}if(c>1){b.setDate(b.getDate()-c+1);}return b;},_buttonsHandler:function(b){if(b.type==="click"){this._selectMonths(b.data.months[0],b.data.months[1],b);}else{if(b.type==="mouseover"){this._updateSlider(this._tipSlider,new Date(this._currentYear,b.data.months[0],1),new Date(this._currentYear,b.data.months[1],0));}else{this._tipSlider.hide();}}},_selectMonths:function(b,l,c){var f=[new Date(this._currentYear,b,1),new Date(this._currentYear,l,0)],d=["getYear","getMonth","getDate"],k=true,e=c.shiftKey||c.ctrlKey;for(var g=0;g<2;++g){for(var h=0;h<d.length;++h){if(!this._range[g]||this._range[g][d[h]]()!==f[g][d[h]]()){k=false;g=2;break;}}}if(k&&this._state!==0){this._state=0;this._range[0]=null;this._range[1]=null;}else{if(e){if(f[0]<this._range[0]){this._range[0]=f[0];}if(f[1]>this._range[1]){this._range[1]=f[1];}}else{this._range[0]=f[0];this._range[1]=f[1];}this._state=2;}this._updateRange();this._updateSelectionSlider();this._updateSelectionAndFocus();this._rangeReady();},_updateSelection:function(){if(this._yearScroller){this._yearScroller.clearSelection();this._yearScroller.updateSelection();}if(this._daysScroller){this._daysScroller.clearSelection();this._daysScroller.updateSelection();}},_updateDatesValues:function(){if(this._dateControls[0]){var b;if(this._state>0){b=this._range[0];}else{b=null;}this._dateControls[0].setValue(b);this.getLinkedContext().setValue(this._dateControls[0].getName(),b,undefined,true);if(this._state>0){b=this._range[1];}else{b=null;}this._dateControls[1].setValue(b);this.getLinkedContext().setValue(this._dateControls[1].getName(),b,undefined,true);}},_updateSelectionAndFocus:function(c){this._updateSelection();if(!c){this._updateDatesValues();}if(!c&&this._dateControls[0]){var b=this._dateControls[0].isActive();this._dateControls[b?0:1].setActive(true);}},_checkRange:function(){if(this._range[1]<this._range[0]){var b=this._range[1];this._range[1]=this._range[0];this._range[0]=b;}},_updateRange:function(){if(this._range[0]){this._range[0].setHours(0,0,0,0);}if(this._range[1]){this._range[1].setHours(23,59,59,999);}var b=this.getLinkedContext();b.setValue(this._options.dateFromName,this._range[0],undefined,true);b.setValue(this._options.dateToName,this._range[1],undefined,true);},_rangeReady:function(){this._updateRangeTitle();var b=this.validate();if(b===true){this._notify("onChange",this._range[0],this._range[1]);}this._notifyOnValueChange([this.getValue()]);},validate:function(){if(this._datesDeferred.isSuccessful()){this._dateControls[0].validate();this._dateControls[1].validate();var b=$ws.proto.DateRange.prototype._invokeValidation.apply(this,arguments);this._toggleError(b.errors.length>0,b.errors);this._notify("onValidate",!!b.result,b.errors,this._previousValidationResult);this._previousValidationResult=!!b.result;return b.result;}else{return"Контрол не готов!";}},_getRangeTitle:function(){var h="";if(this._range[0]&&this._range[1]){var g=[this._range[0].getDate(),this._range[1].getDate()],b=[this._range[0].getMonth(),this._range[1].getMonth()],e=[this._range[0].getFullYear(),this._range[1].getFullYear()],d=new Date(this._range[1]);d.setDate(d.getDate()+1);if(e[0]!==e[1]){if(b[0]===0&&b[1]===11&&g[0]===1&&g[1]===31){h=e[0]+" - "+e[1];}else{if(g[0]===1&&(new Date(e[1],b[1],g[1]+1)).getMonth()!==b[1]){h=$ws._const.Date.longMonthsSmall[b[0]]+" "+e[0]+" - "+$ws._const.Date.longMonthsSmall[b[1]]+" "+e[1];}else{h=g[0]+" "+$ws._const.Date.monthsWithDays[b[0]]+" "+e[0]+" - "+g[1]+" "+$ws._const.Date.monthsWithDays[b[1]]+" "+e[1];}}}else{if(this._range[1].getMonth()!=this._range[0].getMonth()){if(g[0]===1&&d.getDate()===1){var f=d.getMonth();if(b[0]%3===0&&f%3===0){if(f===0){f=12;}if(f-b[0]===12){h=e[0];}else{if((f-b[0])===6&&b[0]%6===0){h=(f/6)+" полугодие "+e[0];}else{var c=["I","II","III","IV"];if(f-b[0]>3){h=c[b[0]/3]+" - "+c[(f/3)-1]+" квартал "+e[0];}else{h=c[b[0]/3]+" квартал "+e[0];}}}}else{h=$ws._const.Date.longMonthsSmall[b[0]]+" - "+$ws._const.Date.longMonthsSmall[b[1]]+" "+e[0];}}else{h=g[0]+" "+$ws._const.Date.monthsWithDays[b[0]]+" - "+g[1]+" "+$ws._const.Date.monthsWithDays[b[1]]+" "+e[0];}}else{if(this._range[1].getDate()!=this._range[0].getDate()){if(g[0]===1&&d.getDate()===1){h=$ws._const.Date.longMonthsSmall[b[0]]+" "+e[0];}else{h=g[0]+" - "+g[1]+" "+$ws._const.Date.monthsWithDays[b[0]]+" "+e[0];}}else{h=g[0]+" "+$ws._const.Date.monthsWithDays[b[0]]+" "+e[0];}}}}else{if(this._range[0]){h="C "+this._range[0].strftime("%e %q %Y года");}else{if(this._range[1]){h="По "+this._range[1].strftime("%e %q %Y года");}}}return h;},_updateRangeTitle:function(){if(this._rangeTitle){this._rangeTitle.html(this._getRangeTitle());}},_toggleError:function(b,c){if(b||this._validationErrors[0]||this._validationErrors[1]){var d=b?c:this._errorMessage;if(this._menuShowed){this._options.validationError=true;this._setErrorMarker(d);}else{this.markControl(d);}this._movingControlsBlock.addClass("ws-validation-error");if(b){this._errorMessage=c;}}else{this._errorMessage="";this.clearMark();if(this._errorMarker){this._errorMarker.hide();}this._movingControlsBlock.removeClass("ws-validation-error");}},_setErrorMarker:function(b){if(this._errorMarker){var c=b&&(typeof b=="string"||b instanceof Array)?b:this._options.errorMessageFilling;this._createErrorMessage(c);this._errorMarker.show();}},_getDatePosition:function(b){var d=b.getFullYear(),c=new Date(d,0,1),e=((d%4===0&&(d%100!==0||d%400===0))?366:365);return(b-c)/(1000*60*60*24*e);},_updateSlider:function(c,g,f){var e,b,d=this._calendarBlock.width()-1;c.stop();if(this._currentYear===g.getFullYear()){e=Math.round(this._getDatePosition(g)*d);}if(this._currentYear===f.getFullYear()){b=Math.round(this._getDatePosition(f)*d);}c.toggleClass("left",e!==undefined);c.toggleClass("right",b!==undefined);if(e!==undefined||b!==undefined){e=(e!==undefined?e:0);b=(b!==undefined?b:d);if(b-e<=0){if(e===d){--e;}else{++b;}}c.animate({left:e+"px",width:(b-e)},"fast").show();}else{if(g.getFullYear()<this._currentYear&&this._currentYear<f.getFullYear()){c.animate({left:"0px",width:d},"fast").show();}else{c.hide();}}},_updateSelectionSlider:function(){if(this._yearBlock){var c={},e;if(this._state===2){var d=new Date(this._range[1]);d.setDate(d.getDate()+1);if(d.getDate()===1&&this._range[0].getDate()===1){var b=[this._range[0].getMonth(),d.getMonth()];if(b[1]===0){b[1]=12;}if(b[0]===0&&b[1]===12){c[0]=true;}else{if((b[1]-b[0])===6&&b[0]%6===0){c[1+(b[0]/6)]=true;}else{if(b[0]%3===0&&b[1]%3===0){for(e=0;e<4;++e){if(e*3>=b[0]&&(e+1)*3<=b[1]){c[3+e]=true;}}}}}}}this._yearBlock.toggleClass("toggle",c[0]!==undefined);for(e=1;e<7;++e){this._toggledButtons[e-1].toggleClass("toggle",(c[e]!==undefined));}this._daysScroller.updateSelectionMarker();}if(this._selectionSlider){if(this._state>0&&this._range[0]&&this._range[1]){this._selectionSlider.toggleClass("preselected",this._state===1).toggleClass("selected",this._state===2);this._updateSlider(this._selectionSlider,this._range[0],this._range[1]);}else{this._selectionSlider.hide();}}},_intervalNumber:function(){var d=this._daysScroller.drawedDays;if(d[0].getYear()!=d[1].getYear()){var c=[0,0];var b=new Date(d[0].getFullYear(),11,31);c[0]=b-d[0];b=new Date(d[1].getFullYear(),0,1);c[1]=d[1]-b;return(c[0]<c[1]?1:0);}return 0;},_setYear:function(b){var c=b-this._currentYear,d=this._daysScroller.drawedDays;this._currentYear=b;d[0].setFullYear(d[0].getFullYear()+c);this._setMonday(d[0]);this._daysScroller.setDate(d[0]);this._updateSelectionSlider();},_updateYear:function(){this._yearBlock.html(this._currentYear);this._updateSelectionSlider();},_dateLesser:function(d,c,e,b){if(d.getYear()>c.getYear()){return false;}else{if(d.getYear()<c.getYear()){return true;}}if(d.getMonth()>c.getMonth()){return false;}else{if(d.getMonth()<c.getMonth()){return true;}}return !e||(d.getDate()<c.getDate())||(b&&d.getDate()==c.getDate());},_createScroller:function(d,f,c){var e=this,b={rows:[],drawedDays:[new Date(c),new Date(c)],offset:$ws._const.DateRange[f?"startYearOffset":"startOffset"],table:$('<table class="ws-date-range-table'+(f?" year":"")+'" border="0" cellpadding="0" cellspacing="0"></table>').appendTo(d),redraw:false,clickY:undefined,lastMove:undefined,moveTimer:undefined,scrollTimer:undefined,scrollingOnClick:undefined,setDate:function(g){for(var h=0;h<b.rows.length;++h){b.rows[h].row.remove();}b.drawedDays[0]=new Date(g);b.drawedDays[1]=new Date(g);b.offset=0;b.rows=[];b.drawCalendar(true);b.stopTimers();},addYearSelection:function(g,h){if(e._state===2){if(h.getYear()>=e._range[0].getYear()&&h.getYear()<=e._range[1].getYear()){g.addClass("selected");}}},addCellSelection:function(g,h){if(e._state===0||!e._range[0]||!e._range[1]){return;}if(e._dateLesser(e._range[0],h,true)&&e._dateLesser(h,e._range[1],true)){g.addClass(e._state===2?"selected":"preselected");}for(var j=0;j<2;++j){if(h.getDate()==e._range[j].getDate()&&h.getMonth()==e._range[j].getMonth()&&h.getYear()==e._range[j].getYear()){var k=g.children().eq(0);k.addClass(j===0?"start":"end");k.prepend(e._rangeMarks[j].show());e._daysCells.push(k);break;}}},updateSelection:function(){while(e._daysCells.length){e._daysCells.pop().removeClass("start end").find(".ws-date-range-end-selection, .ws-date-range-start-selection").hide();}if(e._state===0){return;}for(var l=0;l<b.rows.length;++l){var h=b.rows[l];for(var k=0;k<h.cells.length;++k){var g=h.cells[k];if(f){b.addYearSelection(g.element,g.date);}else{b.addCellSelection(g.element,g.date);}}}},clearSelection:function(){for(var l=0;l<b.rows.length;++l){var h=b.rows[l];for(var k=0;k<h.cells.length;++k){var g=h.cells[k];g.element.removeClass("selected preselected");}}},drawDay:function(h){var g=$('<td class="ws-date-range-date"></td>'),m=$('<div class="ws-date-range-date-block"></div>').appendTo(g);if(h.getMonth()%2===0){g.addClass("month-even");}if(h.getDate()===e._currentDate.getDate()&&h.getMonth()===e._currentDate.getMonth()&&h.getYear()===e._currentDate.getYear()){g.addClass("current");}b.addCellSelection(g,h);g.bind("mouseover mouseout click",{date:h.getTime()},function(o){if(o.type==="mouseover"||o.type==="mouseout"){g.toggleClass("hover",o.type==="mouseover");if(e._state===1&&o.type==="mouseover"){var n=new Date(o.data.date),p=e._range[1-e._rangeEndAt];if(n<p){e._rangeEndAt=0;e._range[1]=p;}else{e._rangeEndAt=1;e._range[0]=p;}e._range[e._rangeEndAt]=n;b.clearSelection();b.updateSelection();e._updateSelectionSlider();}}else{if(o.type==="click"){if(!b.scrollingOnClick){if(e._state===2&&(o.ctrlKey||o.shiftKey||o.altKey)){var i=new Date(o.data.date);if(o.altKey!=(i.getTime()>(e._range[1].getTime()+e._range[0].getTime())/2)){e._range[1]=i;}else{e._range[0]=i;}e._checkRange();}else{if(e._state%2===0){e._range[0]=new Date(o.data.date);e._range[1]=new Date(o.data.date);e._state=1;}else{if(e._state===1){e._state=2;e._rangeEndAt=1;}}}e._updateRange();e._updateSelectionAndFocus();e._updateSelectionSlider();if(e._state!==1){e._rangeReady();}}return false;}}});m.append('<div class="ws-date-range-date-number">'+h.getDate()+"</div>");var k=h.getDate()===1;if(e._state>=1){for(var j=0;j<2;++j){if(e._range[j]&&h.getDate()==e._range[j].getDate()&&e._range[j].getMonth()==h.getMonth()&&e._range[j].getYear()==h.getYear()){m.addClass(j===0?"start":"end");m.prepend(e._rangeMarks[j].show());e._daysCells.push(m);break;}}}var l;m.append(l=$('<div class="ws-date-range-date-month">'+$ws._const.Date.monthsWithDays[h.getMonth()]+"</div>"));if(k){l.css("display","block");}return g;},drawYear:function(h){var g=$('<td class="ws-date-range-date year"></td>'),i=$('<div class="ws-date-range-date-block"></div>').appendTo(g);b.addYearSelection(g,h);if(h.getYear()==e._currentDate.getYear()){g.addClass("current");i.attr("title","Текущий год");}else{if(h.getFullYear()==e._currentYear){i.addClass("visible");i.attr("title","Просматриваемый год");}}g.bind("click dblclick",{year:h.getFullYear()},function(j){if(j.type==="click"){e._setYear(j.data.year);e._yearScrollerBlock.fadeOut("fast");e._yearBlock.html(j.data.year);e._yearScrollerShowed=false;}else{e._setYear(j.data.year);e._selectMonths(0,12,j);}});i.append(h.getFullYear());return g;},drawMonthRow:function(j){var m=$("<tr></tr>"),l=new Date(j),h=[];for(var k=0;k<7;++k,l.setDate(l.getDate()+1)){var g=b.drawDay(l);m.append(g);h.push({element:g,date:new Date(l)});}return{row:m,cells:h};},drawYearRow:function(i){var k=$("<tr></tr>"),j=new Date(i),h=[],g=b.drawYear(j);k.append(g);h.push({element:g,date:new Date(j)});return{row:k,cells:h};},drawCalendar:function(l){var p=d.height(),s=0,u,r=(f?b.drawYearRow:b.drawMonthRow);while(b.offset>0){++s;if(!f){b.drawedDays[0].setDate(b.drawedDays[0].getDate()-7);}else{b.drawedDays[0].setFullYear(b.drawedDays[0].getFullYear()-1);}u=r(b.drawedDays[0]);b.rows.unshift(u);b.table.prepend(u.row);b.offset-=$ws._const.DateRange.rowHeight;}while(b.offset+b.rows.length*$ws._const.DateRange.rowHeight<p){u=r(b.drawedDays[1]);b.rows.push(u);b.table.append(u.row);if(!f){b.drawedDays[1].setDate(b.drawedDays[1].getDate()+7);}else{b.drawedDays[1].setFullYear(b.drawedDays[1].getFullYear()+1);}}while(b.offset+(b.rows.length-3)*$ws._const.DateRange.rowHeight>p){b.rows.pop().row.remove();if(!f){b.drawedDays[1].setDate(b.drawedDays[1].getDate()-7);}else{b.drawedDays[1].setFullYear(b.drawedDays[1].getFullYear()-1);}}while(b.offset+$ws._const.DateRange.rowHeight*2<0){--s;b.rows.shift().row.remove();b.offset+=$ws._const.DateRange.rowHeight;if(!f){b.drawedDays[0].setDate(b.drawedDays[0].getDate()+7);}else{b.drawedDays[0].setFullYear(b.drawedDays[0].getFullYear()+1);}}if(b.redraw){if(s){b.table.css("margin-top",(b.offset-s*$ws._const.DateRange.rowHeight)+"px");}if(l){b.table.stop().css({"margin-top":b.offset+"px"});}else{b.table.stop().animate({"margin-top":b.offset+"px"},"fast","linear");}}if(!f&&b.redraw){var n=e._currentYear;e._currentYear=b.drawedDays[e._intervalNumber()].getFullYear();if(n!==e._currentYear){e._updateYear();}}if(!f){b.updateSelectionMarker();var h=0,k=0,g=new Date(b.drawedDays[0]),j=new Date(b.drawedDays[0]);for(var m=j.getMonth(),o=b.drawedDays[1].getMonth();m!=o;m=(m+1)%12){var q=j.getMonth();if(q==b.drawedDays[1].getMonth()){j.setDate(b.drawedDays[1].getDate());}else{j.setMonth(q+1);j.setDate(0);}var t=j.getDate()-g.getDate();if(t>h&&j.getFullYear()==e._currentYear){h=t;k=m;}g.setMonth(q+1);g.setDate(1);j.setDate(j.getDate()+1);}e._selectMonth(k);}if(!b.redraw){b.redraw=true;}},initEvents:function(){var g=function(i){var h=i.clientX,k=i.clientY;if(!h){var j=i.originalEvent.touch||i.originalEvent.touches[0]||i.originalEvent.changedTouches[0];if(j){h=j.pageX;k=j.pageY;}}return{x:h,y:k};};d.bind("touchstart",function(i){var j=g(i),h=false;b.clickY=j.y;b.lastMove=0;b.scrollingOnClick=!!b.scrollTimer;b.stopTimers();$(document).bind("touchmove touchend",function(k){if(k.type==="touchmove"){var l=g(k);b.lastMove=l.y-b.clickY;b.offset+=b.lastMove;if(b.clickY!==l.y){h=true;}b.clickY=l.y;b.drawCalendar(true);if(b.moveTimer){clearTimeout(b.moveTimer);}b.moveTimer=setTimeout(function(){b.lastMove=0;},140);return false;}else{b.stopTimers();if(Math.abs(b.lastMove)>0){b.scrollTimer=setInterval(function(){b.offset+=b.lastMove/2;b.drawCalendar(true);},30);}if(h){return false;}}k.stopImmediatePropagation();});});},stopTimers:function(){if(b.moveTimer){clearTimeout(b.moveTimer);b.moveTimer=undefined;$(document).unbind("touchmove touchend");}if(b.scrollTimer){clearInterval(b.scrollTimer);b.scrollTimer=undefined;}},updateSelectionMarker:function(){if(e._selectionMarker){var g=0;if(e._state===2){if(e._range[1]<b.drawedDays[0]){g=1;}else{if(e._range[0]>b.drawedDays[1]){g=2;}}}e._selectionMarker.toggle(g>0).toggleClass("bottom",g===2);}}};d.bind("mousewheel DOMMouseScroll",function(h){if(h.wheelDelta===undefined){h.wheelDelta=h.detail;}if($.browser.mozilla){h.wheelDelta*=-1;}var g=(h.wheelDelta>0?1:-1);b.offset+=g*$ws._const.DateRange.scrollCount;b.drawCalendar();return false;});b.drawCalendar(true);b.initEvents();return b;},destroy:function(){if(this._menuBlock){if(this._daysScroller){this._daysScroller.stopTimers();}if(this._yearScroller){this._yearScroller.stopTimers();}this._menuBlock.empty().remove();}for(var b=0;b<2;++b){if(this._dateControls[b]){this._dateControls[b].destroy();}}if(this._menuShowed){this._container.trigger("wsSubWindowClose");}$(document).unbind("mousedown."+this.getId());$ws.proto.DateRange.superclass.destroy.apply(this,arguments);},getRangeStart:function(){return this._range[0];},getRangeEnd:function(){return this._range[1];},getValue:function(){if(this._state===0){return undefined;}return[this.getRangeStart(),this.getRangeEnd()];},getStringValue:function(){return this._getRangeTitle();},getDateFromName:function(){return this._options.dateFromName;},getDateToName:function(){return this._options.dateToName;},_setRange:function(c,b){this._range[0]=c;this._range[1]=b;if(this._range[0]&&this._range[1]){this._state=2;}else{if(this._range[0]||this._range[1]){this._state=1;}else{this._state=0;}}this._updateRangeTitle();this._updateSelection();this._updateSelectionSlider();this.validate();this._notifyOnValueChange([this.getValue()]);},setRange:function(c,b){if((c instanceof Date||c===null)||(b instanceof Date||b===null)){this._setRange(c,b);this._updateDatesValues();}else{$ws.single.ioc.resolve("ILogger").error("DateRange::setRange","Incorrect value "+c+", "+b);}},setValue:function(b){if(b instanceof Array&&b.length===2){this.setRange(b[0],b[1]);}else{if(b!==undefined){$ws.single.ioc.resolve("ILogger").error("DateRange::setValue","Incorrect value "+b);}}},setEnabled:function(c){c=!!c;if(this._options.allowChangeEnable||c===this._options.enable){$ws.proto.DateRange.superclass.setEnabled.apply(this,arguments);if(this._movingControlsBlock){this._movingControlsBlock.toggleClass("ws-enabled",c).toggleClass("ws-disabled",!c);}if(this._textField){this._textField.toggleClass("ws-enabled",c).toggleClass("ws-disabled",!c);}var b=this;this._datesDeferred.addCallback(function(){b._dateControls[0].setEnabled(c);b._dateControls[1].setEnabled(c);});if(this._menuShowed){this._hideMenu();}}},_getElementToFocus:function(){return undefined;},_redraw:function(b){if(!b){this._container.empty();}this._initDateContainer();}});return $ws.proto.DateRange;});