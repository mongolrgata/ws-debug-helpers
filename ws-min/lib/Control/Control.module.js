$ws.declareModule({namespace:"SBIS3.CORE",name:"Control",imports:["SBIS3.CORE.Infobox","SBIS3.CORE.NavigationController"]},function(d){var c=500;var a=500;var b=10000;$ws.single.ControlBatchUpdater=new ($ws.core.extend({},{$protected:{_applyUpdateInProcess:false,_batchUpdateSpan:null,_batchUpdateSpanHint:null,_batchUpdateCount:0,_batchUpdateControls:{},_delayedEventsHash:{},_delayedActionsHash:{},_con:null,_debugEnabled:false,_delayedEvents:[]},$constructor:function(){this._setDebugEnabled(this._debugEnabled);},_dummyUpdate:{},_nop:function(){},_setDebugEnabled:function(f){this._debugEnabled=f;var e=this;this._con=window&&window.console;if(!this._con||!this._debugEnabled){this._con={log:this._nop,info:this._nop,group:this._nop,groupEnd:this._nop,profile:this._nop,profileEnd:this._nop};}if(!this._con.group){this._con.groupLevel=0;this._con.group=function(i,h,j){e._con.log(i,h,j);e._con.groupLevel++;};var g=this._con.log;this._con.log=function(j,h,n){var m="",l=(e._con.groupLevel+1)*2;for(var k=0;k<l;k++){m+="_";}g(m,j,h,n);};this._con.groupEnd=function(){e._con.groupLevel--;};}if(!this._con.profile){this._con.profile=this._nop;}if(!this._con.profileEnd){this._con.profileEnd=this._nop;}this.addComment=this._debugEnabled?this._addComment:this._nop;this.getType=this._debugEnabled?this._getType:this._nop;},_getControlById:function(f){var e=$ws.single.ControlStorage;return e.contains(f)?e.get(f):null;},beginBatchUpdate:function(e){if(this._batchUpdateCount===0){this._batchUpdateSpan=BOOMR.plugins.WS.startSpan("pckRsz:"+e);this._batchUpdateSpanHint=e;}this._batchUpdateCount++;},_endBatchUpdateFinish:function(g){var e=BOOMR.plugins.WS.startSpan("pckRszApply:"+this._batchUpdateSpanHint);try{this._applyBatchUpdate(this._batchUpdateSpanHint);}finally{e.stop();this._batchUpdateSpan.stop();var f=BOOMR.plugins.WS.startSpan("pckRszEvents:"+this._batchUpdateSpanHint);try{this._batchUpdateSpan=null;this._batchUpdateSpanHint=null;this._runDelayedActions();this._sendDelayedEvents();}finally{f.stop();}}},endBatchUpdate:function(e){if(this._batchUpdateCount===0){throw new Error("Лишний вызов _endBatchChange: "+e);}this._batchUpdateCount--;if(this._batchUpdateCount===0){this._endBatchUpdateFinish(e);}},createBatchUpdateWrapper:function(h,i,e){var g=this;if(typeof i==="string"){var f=i;i=function(){return this[f].apply(this,arguments);};}if(e){return function(){return g._runInBatchUpdate(h,e,i,arguments);};}else{return function(){return g._runInBatchUpdate(h,this,i,arguments);};}},runInBatchUpdate:function(g,e,f){return this._runInBatchUpdate("",e,g,f);},_runInBatchUpdate:function(j,f,k,h){function g(){var o=this,q=true,n=false;function p(r){return function(s){o.endBatchUpdate(r+" - "+j);return s;};}function m(r){$ws.single.ioc.resolve("ILogger").error("ControlBatchUpdater","_runInBatchUpdate: нельзя добавить обработчик в "+r+": обработчики заблокированы. hint: "+j);}this.beginBatchUpdate(j);try{var l=k.apply(f,h||[]);if(l instanceof $ws.proto.Deferred){q=false;if(l.isCallbacksLocked()){m("Deferred");}else{l.addCallbacks(p("Deferred"),p("Deferred Error"));n=true;}}else{if(l instanceof $ws.proto.ParallelDeferred){q=false;if(l.getResult().isCallbacksLocked()){m("ParallelDeferred");}else{l.getResult().addCallbacks(p("Parallel Deferred"),p("Parallel Deferred Error"));n=true;}}}}finally{if(q){this.endBatchUpdate("simple - "+j);}else{if(!n){this.endBatchUpdate("bad Deferred/ParallelDeferred - "+j);}}}return l;}function e(){return k.apply(f,h||[]);}var i=this._applyUpdateInProcess?e:g;return i.apply(this);},getType:null,_getType:function(f){var e=f.getContainer()&&f.getContainer().attr("type");if(!e){if(SBIS3.CORE.Grid&&(f instanceof SBIS3.CORE.Grid)){e="@Control/Area/Grid";}else{if(SBIS3.CORE.DataView&&(f instanceof SBIS3.CORE.DataView)){e="@Control/DataView";}else{if(SBIS3.CORE.ToolBar&&(f instanceof SBIS3.CORE.ToolBar)){e="@Control/ToolBar";}else{if(SBIS3.CORE.OperationsPanel&&(f instanceof SBIS3.CORE.OperationsPanel)){e="@Control/OperationsPanel";}else{if(SBIS3.CORE.Window&&(f instanceof SBIS3.CORE.Window)){e="@Control/Window";}else{if(SBIS3.CORE.Dialog&&(f instanceof SBIS3.CORE.Dialog)){e="@Control/Dialog";}else{if(SBIS3.CORE.SimpleDialogAbstract&&(f instanceof SBIS3.CORE.SimpleDialogAbstract)){e="@Control/SimpleDialogAbstract";}else{if(SBIS3.CORE.Tabs&&(f instanceof SBIS3.CORE.Tabs)){e="@Control/Tabs";}else{if(SBIS3.CORE.HTMLView&&(f instanceof SBIS3.CORE.HTMLView)){e="@Control/HTMLView";}else{if(SBIS3.CORE.FiltersArea&&(f instanceof SBIS3.CORE.FiltersArea)){e="@Control/FiltersArea";}else{if(SBIS3.CORE.TemplatedArea&&(f instanceof SBIS3.CORE.TemplatedArea)){e="@Control/TemplatedArea";}else{if(SBIS3.CORE.TemplatedAreaAbstract&&(f instanceof SBIS3.CORE.TemplatedAreaAbstract)){e="@Control/TemplatedAreaAbstract";}else{if(SBIS3.CORE.AreaAbstract&&(f instanceof SBIS3.CORE.AreaAbstract)){e="@Control/AreaAbstract";}}}}}}}}}}}}}}return e;},addComment:null,_addComment:function(e,f){if(!e.comments){e.comments=[f];}else{e.comments.push(f);}},_checkDelayedEventName:function(f,h){var i=f+":"+h.getId(),e=this._delayedEventsHash[i],g=this._delayedEvents.length;if(!e){e=this._delayedEventsHash[i]={last:undefined};}if(e.last!==undefined){this._delayedEvents[e.last]=null;}e.last=g;},addDelayedFunc:function(g,f,e){if(g){this._checkDelayedEventName(g,f);}this._delayedEvents.push({func:e,control:f});},addDelayedEvent:function(f,g,e){if(g.hasHandlersForEvent(f)){this._checkDelayedEventName(f,g);this._delayedEvents.push({event:f,control:g,args:e});}},registerDelayedAction:function(e,f,g){this._delayedActionsHash[e]={actionFunc:f,uniqueForBatch:g,delayed:false,args:[]};},_addDelayedAction:function(e,f){var g=this._delayedActionsHash[e];if(g){g.delayed=true;g.args=f;}},runBatchedDelayedAction:function(e,f){if(this.haveBatchUpdate()){this._addDelayedAction(e,f);}else{this._runInBatchUpdate("runBatchedDelayedAction."+e,this,function(){this._addDelayedAction(e,f);});}},addBatchSizeChanged:function(f,g){var i=f.getId(),e=this._batchUpdateControls,h=e[i];if(h){h.control=f;h.sizeChanged=true;}else{h=e[i]={control:f,sizeChanged:true};}if(g){h.recalculateOwnSize=true;}},_runDelayedActions:function(){var e=$ws.helpers.reduce(this._delayedActionsHash,function(f,h,g){if(h.delayed){f.push([g,h.args]);}h.delayed=false;h.args=[];return f;},[]);$ws.helpers.forEach(e,function(h){var g=h[0],f=h[1]||[],i=this._delayedActionsHash[g];if(i){i.actionFunc.apply(this,f);}},this);},_sendDelayedEvents:function(){var e=this._delayedEvents;this._delayedEvents=[];this._delayedEventsHash={};$ws.helpers.forEach($ws.helpers.filter(e),function(f){if(f.event){f.control._notify.apply(f.control,f.args);}else{if(f.func){f.func.apply(f.control);}}});},_applyBatchUpdate:function(k){var l,h,u=this,j=this.addComment,o=this.getType,n=this._debugEnabled;function t(x){var w=x.getParent(),z=w&&w.getId(),v,y;if(z){v=h[z];if(!v){y=t(w);v={control:w,type:o(w),children:{}};y.children[z]=v;h[z]=v;}}else{v=l;}return v;}function r(v){return v.control._haveAutoSize();}function i(v){return $ws.helpers.map(v,function(w){return w.control;});}function e(y){var w=function v(z){return z.isVisible()&&(!z.getParent()||v(z.getParent()));}(y);if(w){var x=y.getContainer();w=x&&x.closest(".ws-hidden").length===0;}return w;}function q(w,v){$ws.helpers.forEach(w.children||{},function(x){q(x,v);v(x);});}function f(w){var z=w.control,x=z._getBatchUpdateData()||{},y=x.delayedRecalkData||{},v=0;function A(C){var B=C.update;if(B&&B.sizeChanged){y[C.control.getId()]={recalculateOwnSize:!!B.recalculateOwnSize};v++;}}q(w,A);A(w);j(w,"невидимый");if(v>0){if(n){j(w,"отложено "+v+" элементов");}x.delayedRecalkData=y;z._setBatchUpdateData(x);}}function p(B,w){var D=B.update||u._dummyUpdate,z=!B.children||Object.isEmpty(B.children),y=D.sizeChanged,F=B.control,I=e(F),A=w||I,G=F._needRecalkInvisible(),J,K,v,E,C,x,H;if(A||G){if(!A){j(B,"невидимый - всё равно пересчитываем");f(B);}H=r(B);F._beforeChildrenBatchCalc&&F._beforeChildrenBatchCalc();try{J=$ws.helpers.filter(B.children,function(L){return p(L,w||(G&&!I));});if(!z&&n){j(B,H?"прозрачный":"непрозрачный");j(B,J.length+" изм.");}K=y||((J.length>0)&&H);if(J.length>0||(D.recalculateOwnSize)){v=F._onSizeChangedBatch(i(J));if(!v){K=false;}if(F.hasEvent("onBatchFinished")){F._notifyBatchDelayed("onBatchFinished");}B.needSendOnResize=!!F._onResizeHandlerBatch;if(n){if(B.needSendOnResize){j(B,"пакетный - есть изм. узлы! - "+(v?"есть изм.":"нет изм."));}else{j(B,"пакетный - пересчёт себя (нет изм. дочерних)");}}}else{if(n){j(B,z?"пакетный - листовой":"пакетный - нет изм. узлов");}}}finally{F._afterChildrenBatchCalc&&F._afterChildrenBatchCalc();}}else{f(B);K=y;}return K;}function m(v,w){if(v.needSendOnResize&&!w){w=true;v.control._onResizeHandlerBatch();j(v,"*");}if(!w){$ws.helpers.forEach(v.children,function(x){m(x,w);});}}function g(x){var w,v,y,z;y=x.type+" ("+(x.control?(x.control.getId()+" - "):"")+") ";z=x.comments||[];for(w=0,v=z.length;w<v;w++){y+=(z[w]+((w<v-1)?", ":""));}if(!Object.isEmpty(x.children)){u._con.group(y,x.control&&x.control.getContainer());$ws.helpers.forEach(x.children,g);u._con.groupEnd();}else{u._con.log(y,x.control&&x.control.getContainer());}}function s(){l={control:null,children:{}};h={};this._con.group("_applyBatchUpdate: "+k);$ws.helpers.forEach(this._batchUpdateControls,function(A,z){var x=A.control;if(x&&!x._isDestroyed){var w=o(x),v=t(x),y;if(v!==l){y=v.children[z];if(y){y.control=x;y.type=w;}else{y={control:x,type:w,children:{}};v.children[z]=y;h[z]=y;}y.update=A;}}},this);this._batchUpdateControls={};$ws.helpers.forEach(l.children,function(v){p(v,false);});m(l,false);if(this._debugEnabled){g(l);}this._con.groupEnd();}this._applyUpdateInProcess=true;try{s.apply(this);if(!Object.isEmpty(this._batchUpdateControls)){s.apply(this);}}finally{this._batchUpdateControls={};this._applyUpdateInProcess=false;}},haveBatchUpdate:function(){return this._batchUpdateCount>0;},haveApplyUpdateInProcess:function(){return this._applyUpdateInProcess;},_needDelayedRecalk:function(f){var e=f._getBatchUpdateData();return e&&e.delayedRecalkData;},_doDelayedRecalk:function(k){var f=this,i=k._getBatchUpdateData(),j=(i&&i.delayedRecalkData)||{},h=$ws.helpers.reduce(j,function(l,n,m){if(k.getId()!==m){l[m]=n;}return l;},{});k._setBatchUpdateData(undefined);function e(l){var m;if(f._debugEnabled){m="_doDelayedRecalk: "+l+f.getType(k)+": "+k.getId();}else{m="_doDelayedRecalk "+l;}return m;}function g(l,n){function m(){$ws.helpers.forEach(n,function(q,p){var o=this._getControlById(p);if(o){o._notifyOnSizeChanged(o,o,q.recalculateOwnSize);}},this);}f._runInBatchUpdate(e(l),f,m);}g("-1 шаг-",j);this.addDelayedFunc("doDelayedRecalk -2 шаг-",k,function(){g("-2 шаг-",h);});}}))();$ws.proto.Control=$ws.proto.Abstract.extend({$protected:{_container:undefined,_isControlActive:false,_id:"",_parent:null,_context:false,_keysWeHandle:[],_isVisible:true,_minHeight:null,_margins:{},_horizontalAlignment:"Stretch",_verticalAlignment:"Stretch",_batchUpdateData:undefined,_lastOnSizeChangedWidth:undefined,_lastOnSizeChangedHeight:undefined,_underCursor:false,_infoboxHandlerBound:null,_options:{horizontalAlignment:undefined,verticalAlignment:undefined,name:"",enable:true,allowChangeEnable:true,width:"",height:"",minWidth:0,minHeight:0,maxWidth:Infinity,maxHeight:Infinity,owner:null,tooltip:"",extendedTooltip:false,hidden:false,tabindex:false,className:"",renderStyle:"classic",zIndex:0,autoHeight:false,autoWidth:false,saveState:false,isRelative:false,subcontrol:false,cssClassName:""}},$constructor:function(e){var f=this;this._publish("onChange","onKeyPressed","onClick","onFocusIn","onFocusOut","onSizeChanged","onStateChanged","onTooltipContentRequest");this._keysWeHandle=$ws.core.hash(this._keysWeHandle);this._infoboxHandlerBound=this._showExtendedTooltip.bind(this);if(e){if("parent" in e&&(e.parent instanceof $ws.proto.Control||(SBIS3.CORE.AreaAbstract&&e.parent instanceof SBIS3.CORE.AreaAbstract))){this._parent=e.parent;}if("linkedContext" in e&&e.linkedContext instanceof $ws.proto.Context){this._context=e.linkedContext;}if("id" in e){this._id=e.id;}this._initContainer(e);}if(this._isCorrectContainer()){var g=this._container.attr("HorizontalAlignment");this._horizontalAlignment=this._options.horizontalAlignment||(g?g:this._horizontalAlignment);g=this._container.attr("VerticalAlignment");this._verticalAlignment=this._options.verticalAlignment||(g?g:this._verticalAlignment);this._container.removeAttr("HorizontalAlignment").removeAttr("VerticalAlignment");if(!this._hasMarkup()&&this._options.cssClassName){this._container.addClass(this._options.cssClassName);}this._container.addClass("ws-control-inactive").addClass(this._options.className).attr({tabindex:0,hideFocus:true}).css("z-index",this._options.zIndex).bind("click",$.proxy(this._onClickHandler,this));if(this._options.hidden){this.hide();}if(this._hasLinkedLabel()){this.getParent().subscribe("onReady",function(){var h=f._getLinkedLabel();if(h){h.css("z-index",f._options.zIndex);}});}this._initKeyboardMonitor();this._bindExtendedTooltip();}this._margins=$ws.helpers.parseMargins(this._container);this._initSizeOptions();if(this._options.autoWidth){this._options.width="auto";}if(this._options.autoHeight){this._options.height="auto";}if(this._context===false){this._context=$ws.single.GlobalContext;}if(e&&e.parent){this._registerToParent(e.parent);}if(this._options.saveState){this.subscribe("onStateChanged",this._stateChangeHandler);this.subscribe("onDestroy",function(){$ws.single.NavigationController.removeState(this);});}this.subscribe("onSizeChanged",$ws.helpers.proxy(function(h,j,i,k){this._notifyOnSizeChanged(j,i,k);$ws.single.ioc.resolve("ILogger").error("Control","_notify('onSizeChanged'): не вызывайте _notify с событием 'onSizeChanged'. Оно устарело и перестанет поддерживаться в версии 3.5. Вместо вызова _notify('onSizeChanged') надо использовать у контрола HTMLChunk метод chunk.recalcOnDOMChange(), у браузеров browser.recalcBrowserOnDOMChange(). Проверьте свой код, пока старый вариант ещё поддерживается.");},this));},describe:function(){return(this._isCorrectContainer()?this.getContainer().attr("type"):"?Control")+"#"+this.getId();},_extendMarkup:function(f,e){f=f||"<innerTpl></innerTpl>";return f.replace("<innerTpl></innerTpl>",e);},_bindInternals:function(){},_registerToParent:function(e){if(SBIS3.CORE.AreaAbstract&&e instanceof SBIS3.CORE.AreaAbstract){if(e.hasEvent("onResize")){e.registerChildControl(this);}}else{if(e){$ws.single.ioc.resolve("ILogger").error("Control","Incorrect parent ("+((e instanceof Object&&e.getId)?e.getId():"not object")+") for control ("+this.getId()+"), parent must be instanceof $ws.proto.AreaAbstract");}}},_createMarkup:function(e){return this._extendMarkup(e,"");},_runInBatchUpdate:function(f,g,e){return $ws.single.ControlBatchUpdater._runInBatchUpdate(f,this,g,e);},_createBatchUpdateWrapper:function(g,h,f){var e=this;return function(){return $ws.single.ControlBatchUpdater._runInBatchUpdate(g,f?this:e,h,arguments);};},_haveBatchUpdate:function(){var e=$ws.single.ControlBatchUpdater;return e.haveBatchUpdate()||e.haveApplyUpdateInProcess();},_needForceOnResizeHandler:function(){return $ws.single.ControlBatchUpdater.haveApplyUpdateInProcess();},_needRecalkInvisible:function(){return false;},_getBatchUpdateData:function(){return this._batchUpdateData;},_setBatchUpdateData:function(e){this._batchUpdateData=e;},_haveAutoSize:function(){return false;},init:function(){this._initFocusCatch();$ws.proto.Control.superclass.init.apply(this,arguments);},_initComplete:function(){$ws.single.ControlStorage.store(this);$ws.proto.Control.superclass._initComplete.apply(this,arguments);if(this._isCorrectContainer()){this._container.addClass("ws-init-done");}},_runBatchDelayedFunc:function(g,f){var e;if(this._haveBatchUpdate()){$ws.single.ControlBatchUpdater.addDelayedFunc(g,this,f);}else{e=f.apply(this);}return e;},_notifyBatchDelayed:function(g){var f=Array.prototype.slice.call(arguments),e;if(this._haveBatchUpdate()){$ws.single.ControlBatchUpdater.addDelayedEvent(g,this,f);}else{e=this._notify.apply(this,f);}return e;},_notifyOnSizeChanged:function(h,g,i){var f=this;function e(){$ws.single.ControlBatchUpdater.addBatchSizeChanged(f,i);}if(this._haveBatchUpdate()){e();}else{this._runInBatchUpdate("_notifyOnSizeChanged",e);}},_initFocusCatch:function(){if(this.getTabindex()){var e=this,h=[this._getElementToFocus()];if(!h[0]||h[0].get(0)!=this._container.get(0)){h.push(this._container);}for(var g=0;g<h.length;++g){var f=h[g];if(f){f.bind("focusin",function(i){if(!e.isActive()){e.setActive(true,false,true);}i.stopPropagation();});}}}},applyState:function(){},_stateChangeHandler:function(h,g,f){if(g!==undefined){$ws.single.NavigationController.updateState(this.getName(),g,f);}},_initSizeOptions:function(){this._options.minWidth=parseInt(this._options.minWidth,10);this._options.minHeight=parseInt(this._options.minHeight,10);if(this._options.maxWidth!=Infinity){this._options.maxWidth=parseInt(this._options.maxWidth,10);}else{this._options.maxWidth=Infinity;}if(this._options.maxHeight!=Infinity){this._options.maxHeight=parseInt(this._options.maxHeight,10);}else{this._options.maxHeight=Infinity;}},_initContainer:function(e){if("element" in e){if(typeof(e.element)=="string"){var f=e.element;this._container=$("#"+e.element);if(this._container.length===0){throw new Error("Вы пытаетесь создать элемент в несуществующем контейнере! Необходимо создать контейнер с указанным id = "+f);}}else{if("jquery" in e.element){this._container=e.element;}else{if(e.element.nodeType){this._container=$(e.element);}}}}},_removeContainer:function(){if(this._isCorrectContainer()){this._container.empty().remove();}},destroy:function(){if(this.isActive()){this._isControlActive=false;this._notify("onFocusOut",true);}this._removeContainer();$ws.single.CommandDispatcher.deleteCommandsForObject(this);$ws.single.ControlStorage.remove(this);if(this._parent&&this._parent.unregisterChildControl){this._parent.unregisterChildControl(this);}this._context=null;this._parent=null;$ws.proto.Control.superclass.destroy.apply(this,arguments);},getId:function(){if(this._id===""){if(this._isCorrectContainer()){var e=this._id=this._container[0].id;if(!e||e===""){this._id=this._container[0].id=$ws.helpers.randomId();}}else{this._id=$ws.helpers.randomId();}}return this._id;},getName:function(){return this._options.name;},getTabindex:function(){return this._options.tabindex;},setTabindex:function(f,g){if(!g){var e=this.getParent();if(e&&(SBIS3.CORE.AreaAbstract&&e instanceof SBIS3.CORE.AreaAbstract)){e.changeControlTabIndex(this,f);}}this._options.tabindex=f;},getTooltip:function(){return this._options.tooltip;},setTooltip:function(e){this._options.tooltip=""+e;},getExtendedTooltip:function(){return this._options.extendedTooltip;},setExtendedTooltip:function(e){this._options.extendedTooltip=e;},_isCanShowExtendedTooltip:function(){return !!this._options.extendedTooltip;},_bindExtendedTooltip:function(){var e=this;this.subscribe("onFocusIn",function(){if(this._isCanShowExtendedTooltip()){this._showExtendedTooltip();}});this.subscribe("onFocusOut",function(){if(this._isCanShowExtendedTooltip()){if(d.isCurrentTarget(e._getExtendedTooltipTarget())){d.hide(0);}}});this.getContainer().bind("mouseenter",function(){e._underCursor=true;if(e._isCanShowExtendedTooltip()){e._showExtendedTooltip();}});this.getContainer().bind("mouseleave",function(){e._underCursor=false;if(e._isCanShowExtendedTooltip()){if(!e.isActive()){if(d.isCurrentTarget(e._getExtendedTooltipTarget())){d.hide(a);}}}});},_getExtendedTooltipTarget:function(){return this.getContainer();},_showExtendedTooltip:function(h){var f=this,g,e;if(h!==true&&d.isCurrentTarget(this._getExtendedTooltipTarget())){return;}e=this._notify("onTooltipContentRequest",g=this._options.extendedTooltip);if(e instanceof $ws.proto.Deferred){g='<i class="ws-inline-ajax-loader-16">Загрузка&hellip;</i>';e.addBoth(function(i){if(!d.hasTarget()){f._finallyShowInfobox(i);}else{if(d.isCurrentTarget(f._getExtendedTooltipTarget())){d.setText(f._alterTooltipText(i));}else{d.once("onShow",function(){if(d.isCurrentTarget(f._getExtendedTooltipTarget())){d.setText(f._alterTooltipText(i));}});}}return i;});}else{if(typeof e=="string"){g=e;}else{if(e===false){g="";}}}this._finallyShowInfobox(g);},_finallyShowInfobox:function(f){var e=this,g=function(){return e._underCursor||e.isMarked();};d.show(this._getExtendedTooltipTarget(),this._alterTooltipText(f),"auto",c,b,g);},_alterTooltipText:function(e){return e;},isActive:function(){return this._isControlActive;},setActive:function(l,g,m,f){var h=this._isControlActive;this._isControlActive=l;if(this._isCorrectContainer()){this._container.toggleClass("ws-control-inactive",!l).toggleClass("ws-has-focus",l);$ws.helpers.clearSelection();if(l){if(!m){var i=this.isEnabled()?this._getElementToFocus():this._container;if(i&&i.focus){i.focus();if($.browser.mozilla){try{document.getSelection().removeAllRanges();}catch(k){}}}}if(l!==h){var j=this.getParent();if(j){j.activate(this);}this._notify("onFocusIn");}else{if(this._isCanShowExtendedTooltip()){this._showExtendedTooltip();}}}else{if(l!==h){this._notify("onFocusOut",false,f);}}}},_getElementToFocus:function(){return this._container;},getParentWindow:function(){try{return this.getParentByClass(SBIS3.CORE.Window);}catch(f){return undefined;}},findParent:function(f){if(typeof f!="function"){throw new Error("Control.findParent - требуется передать функцию-фильтр");}var e=this;do{e=e.getParent();}while(e&&!f(e));return e;},getParent:function(){return this._parent;},getTopParent:function(){var e=this;while(e.getParent()){e=e.getParent();}return e;},getParentByName:function(e){return this.findParent(function(f){return f instanceof $ws.proto.Control&&f.getName()==e;});},getParentByClass:function(e){if(!e){throw new Error("Control.getParentByClass - искомый класс не определен");}return this.findParent(function(f){return f instanceof e;});},getLinkedContext:function(){return this._context;},_isCorrectContainer:function(){return this._container!==undefined&&("jquery" in this._container)&&this._container.length==1;},_hasMarkup:function(){return this._isCorrectContainer()&&this._container.attr("hasMarkup")=="true";},_calculatePositionHorisontal:function(){var h=this._container.parent().width(),e=this._margins.left+this._margins.right,f="",g="margin-left";this._container.css(g,"");if((h-e)>this._options.maxWidth){f=Math.round((h-e-this._options.maxWidth)/2);this._container.css(g,f);}},_calculatePositionVertical:function(){var f=this._container.parent().height(),g=this._margins.top+this._margins.bottom,h="",e="margin-top";if((f-g)>this._options.maxHeight){h=Math.round((f-g-this._options.maxHeight)/2);}this._container.css(e,h);},_calcStretchPosition:function(){if(this._horizontalAlignment=="Stretch"&&this._options.maxWidth!=Infinity){this._calculatePositionHorisontal();}if(this._verticalAlignment=="Stretch"&&this._options.maxHeight!=Infinity){this._calculatePositionVertical();}},_onResizeHandler:function(){this._calcStretchPosition();},_onClickHandler:function(e){e.stopImmediatePropagation();if(!this._isControlActive){this.setActive(true);}this._notify("onClick");},_isAcceptKeyEvents:function(){return this.isEnabled();},_initKeyboardMonitor:function(){var e=this;$ws.helpers.keyDown(e._container,function(h){var f=e._notify("onKeyPressed",h);if(h.which in e._keysWeHandle&&f!==false&&e._isAcceptKeyEvents()){var g=e._keyboardHover(h);if(!g){h.preventDefault();h.stopPropagation();return false;}return g;}});},_keyboardHover:function(e){},isEnabled:function(){return this._options.enable;},show:function(){this._setVisibility(true);},hide:function(){this._setVisibility(false);},_isContainerInsideParent:function(){return true;},toggle:function(e){if(e!==undefined){this._setVisibility(!!e);}else{this._setVisibility(!this._isVisible);}},isVisible:function(){return this._isVisible;},_setVisibility:function(f){if(this._isCorrectContainer()&&this._isVisible!==f){this._container.toggleClass("ws-hidden",!f).toggle(f).css("visibility",f?"inherit":"hidden");this._isVisible=f;var e=this.getContainer().parent(),h=this._getLinkedLabel();if(h){if(e.hasClass("ws-labeled-control")){e[f?"show":"hide"]();}h.find("label")[f?"show":"hide"]();}var g=$ws.single.ControlBatchUpdater;if(f&&g._needDelayedRecalk(this)){g._doDelayedRecalk(this);}else{this._notifyOnSizeChanged(this,this);}}},_hasLinkedLabel:function(){return this._options.name&&!!$('label[for="fld-'+this._options.name+'"]').length;},_getLinkedLabel:function(){var f,e;if(this._hasLinkedLabel()){f=this.getContainer().parent();if(this._options.name){e=f.find('label[for="fld-'+this._options.name+'"]');}else{e=f.find("label");}}if(e&&e.parent){e=e.parent();}return e;},setEnabled:function(e){e=!!e;if(this._options.allowChangeEnable||e===this._options.enable){this._container.toggleClass("ws-disabled",!e).attr("tabindex",e?"0":"-1");this._options.enable=e;}},getOwnerId:function(){return this._options.owner;},getOwner:function(){if(this._options.owner){return $ws.single.ControlStorage.get(this._options.owner);}return null;},getContainer:function(){return this._container;},getMinSize:function(){return{minHeight:this.getMinHeight(),minWidth:this.getMinWidth()};},getMinHeight:function(){if(this._container&&this.isVisible()){var e=0;var f=!this._options.autoHeight;if(f){e=(this._height&&this._height!=="100%"&&this._height!=="auto")?parseInt(this._height,10):this._container.outerHeight();}else{if(this._verticalAlignment=="Stretch"){e=this._calcMinHeight();}else{e=this._container.outerHeight();}}if(e>this._options.maxHeight){e=this._options.maxHeight;}if(e<this._options.minHeight){e=this._options.minHeight;}if(this._margins.top){e+=this._margins.top;}if(this._margins.bottom){e+=this._margins.bottom;}return e;}return 0;},_calcMinHeight:function(){return this._options.minHeight;},_calcMinWidth:function(){return this._options.minWidth;},getMinWidth:function(){if(this._container&&this.isVisible()){var e=0;var g=!this._options.autoWidth;if(g){e=(this._width&&this._width!=="100%"&&this._width!=="auto")?parseInt(this._width,10):this._container.outerWidth();}else{if(this._horizontalAlignment=="Stretch"){e=this._calcMinWidth();}else{e=parseInt(this._container.css("min-width"),10);var f=this._container.outerWidth();if(!e){e=f;}e=Math.max(e,f);}}if(e>this._options.maxWidth){e=this._options.maxWidth;}if(e<this._options.minWidth){e=this._options.minWidth;}if(this._margins.left){e+=this._margins.left;}if(this._margins.right){e+=this._margins.right;}return e;}return 0;},getAlignment:function(){return{horizontalAlignment:this._horizontalAlignment,verticalAlignment:this._verticalAlignment};},sendCommand:function(e){var f=Array.prototype.slice.call(arguments,1);f.unshift(this,e);return $ws.single.CommandDispatcher.sendCommand.apply($ws.single.CommandDispatcher,f);},_isAttachedToDom:function(){return this._container.parents(":last").is("html");},canAcceptFocus:function(){return this.isVisible()&&this.isEnabled()&&this.getTabindex();},isSubControl:function(){return this._options.subcontrol;},_setOptions:function(f,h){var k=this._options,j=f.split("."),g="";for(var e=0;e<j.length;e++){g=j[e];if(g in k){if(e<=j.length-2){k=k[g];}else{k[g]=h;}}else{break;}}if(e==j.length){this._redraw();return true;}return false;}});$ws.single.ControlStorage={_storage:{},_waitingChildren:{},_waitingChildrenByName:{},store:function(f){var g=false;if(f instanceof $ws.proto.Control){this._storage[g=f.getId()]=f;if(this._waitingChildren[g]){try{this._waitingChildren[g].callback(f);}finally{delete this._waitingChildren[g];}}var e=f.getName();if(this._waitingChildrenByName[e]&&!this._waitingChildrenByName[e].isReady()){try{this._waitingChildrenByName[e].callback(f);}finally{delete this._waitingChildrenByName[e];}}}return g;},remove:function(f){if(f instanceof $ws.proto.Control){var g=f.getId();var e=f.getName();if(g in this._storage){this._storage[g]=null;delete this._storage[g];}if(g in this._waitingChildren){this._waitingChildren[g]=null;delete this._waitingChildren[g];}if(e in this._waitingChildrenByName){this._waitingChildrenByName[e]=null;delete this._waitingChildrenByName[e];}}},get:function(e){if(this._storage[e]===undefined){throw new Error("ControlStorage : id = '"+e+"' not stored");}return this._storage[e];},contains:function(e){return this._storage[e]!==undefined;},getByName:function(e,f){for(var g in this._storage){if(this._storage.hasOwnProperty(g)){if(this._storage[g].getName()==e){if(f&&!(this._storage[g] instanceof f)){continue;}return this._storage[g];}}}throw new Error("ControlStorage : control with name '"+e+"' is not stored");},containsByName:function(e){for(var f in this._storage){if(this._storage.hasOwnProperty(f)){if(this._storage[f].getName()==e){return true;}}}return false;},waitChild:function(e){if(e in this._storage){return new $ws.proto.Deferred().callback(this._storage[e]);}else{return(e in this._waitingChildren)?this._waitingChildren[e]:(this._waitingChildren[e]=new $ws.proto.Deferred());}},waitChildByName:function(e){if(this.containsByName(e)){return new $ws.proto.Deferred().callback(this.getByName(e));}else{return(e in this._waitingChildrenByName)?this._waitingChildrenByName[e]:(this._waitingChildrenByName[e]=new $ws.proto.Deferred());}},getControls:function(){return this._storage;}};if(window){$ws.single.NavigationController.init();}$ws.proto.DataBoundControl=$ws.proto.Control.extend({$protected:{_contextUpdateHandlerFunction:null,_validating:false,_defaultValue:undefined,_previousValidationResult:true,_initialValueSetted:false,_options:{value:"",bindErrorBox:true,errorMessage:"",validationError:false,errorMessageFilling:"Введите значение",validators:[]}},$constructor:function(){this._publishEvents();this._contextUpdateHandlerFunction=$.proxy(this._contextUpdateHandler,this);if(this._context){this._context.subscribe("onDataBind",this._contextUpdateHandlerFunction);this._context.subscribe("onFieldChange",this._contextUpdateHandlerFunction);}},_notifyOnValueChange:function(e){if(this._initialValueSetted){if(!(e instanceof Array)){e=[e];}e.unshift("onValueChange");this._notify.apply(this,e);}},_markInitialValueSetted:function(){this._initialValueSetted=true;},_contextUpdateHandler:function(f,h,g){var e=this._options.name;if(e!==""&&this._context){if(h){if(h==e){this._onContextValueReceived(g);}}else{this._onContextValueReceived(this._context.getValue(e));}}},_publishEvents:function(){this._publish("onValidate","onValueChange");},init:function(){this._initDefaultValue();this._contextUpdateHandler();if(this.getValue()===undefined){this._defaultValueHandler();}if(this.getValue()===undefined){this._curval=this._curValue();this._updateSelfContextValue(this._notFormatedVal());}this._markInitialValueSetted();$ws.proto.DataBoundControl.superclass.init.apply(this,arguments);},_initDefaultValue:function(){this._defaultValue=this._getDefaultValue();},_updateSelfContextValue:function(e){this.getLinkedContext().setValue(this._options.name,e,undefined,true);},_defaultValueHandler:function(){var e=this.getDefaultValue();if(e!==undefined&&this.setValue){this.setValue(e,true,true);}},_getDefaultValue:function(){return undefined;},getValue:function(){return this.getLinkedContext().getValue(this._options.name);},getDefaultValue:function(){return this._defaultValue;},_curValue:function(){},_notFormatedVal:function(){},_alterTooltipText:function(e){if(this.isMarked()){var f=this._options.errorMessage instanceof jQuery?this._options.errorMessage[0].outerHTML:this._options.errorMessage;return(typeof e=="string"?("<p>"+e+"</p>"):"")+"<p><span class='ws-validation-error-message'>Ошибки:</span> "+f+"</p>";}else{return e;}},_isCanShowExtendedTooltip:function(){return $ws.proto.DataBoundControl.superclass._isCanShowExtendedTooltip.apply(this,arguments)||this.isMarked();},_canValidate:function(){return this._options.validators.length;},_invokeValidation:function(){var g={errors:[],result:true};for(var k=0,f=this._options.validators.length;k<f;k++){var n=this._options.validators[k],h=!(n.noFailOnError||false),j=false;try{j=n.validator.apply(this,n.params||[]);}catch(m){$ws.single.ioc.resolve("ILogger").log("FieldAbstract","Exception while validating "+m.message);}if(j!==true){j=n.errorMessage?n.errorMessage:j;g.errors.push(j);if(h){g.result&=false;}}}return g;},validate:function(){this.clearMark();var g,f=this.getContainer();if(this._validating||!this._canValidate()||!f||f.hasClass("ws-hidden")===true){return true;}try{this._validating=true;g=this._invokeValidation();}catch(h){g={errors:[h.message],result:false};}finally{this._validating=false;}if(g.errors.length>0){this.markControl(g.errors);}this._notify("onValidate",!!g.result,g.errors,this._previousValidationResult);this._previousValidationResult=!!g.result;return g.result;},_getMessageBox:function(l,h){var m=$("body > .ws-warning-message-box");if(!m.length){m=$('<div class="ws-warning-message-box"></div>').append($('<span class="ws-warning-icon"></span>')).append($('<span class="ws-warning-message-text"></span>'));var k=$('<div class="ws-arrow-balloon"></div>');var j="";for(var g=1;g<=10;g++){j+='<b class="b'+g+'"></b>';}k.html(j);m.append(k);$("body").append(m);}if(l){m.find(".ws-warning-message-text").html($ws.helpers.escapeHtml(l));}try{if(h){if(h.icon&&m.data("current-icon")!=h.icon){var f=$ws._const.wsRoot+"img/infobox/icon-"+h.icon+".png";m.find(".ws-warning-icon").css({"background-image":'url("'+f+'")',display:"block"});m.data("current-icon",h.icon);}if(h.noIcon){m.find(".ws-warning-icon").hide();}if(h.color){m.find(".ws-warning-message-text").css("color",h.color);}if(h["background-color"]&&m.data("current-background-color")!=h["background-color"]){m.css("background-color",h["background-color"]);m.find(".ws-arrow-balloon b").css("background-color",h["background-color"]);m.data("current-background-color",h["background-color"]);}}}catch(n){$ws.single.ioc.resolve("ILogger").log("Error","Ошибка установки опций в функции Control._getMessageBox");}return m;},_createErrorMessage:function(h){var g;if(h instanceof Array&&h.length==1){g=h[0];}else{if(h instanceof Array){g=$("<ul></ul>");for(var f=0,e=h.length;f<e;f++){g.append("<li>"+h[f]+"</li>");}}else{g=h;}}this._options.errorMessage=g;},_handlersPath:function(g){var f=this._events[g],j=[];if(f){for(var h=0,e=f.length;h<e;h++){if(f[h].wsHandlerPath){j.push(f[h].wsHandlerPath);}}}return j;},_setupErrorBoxEventsToggler:function(k,j){return false;var g=!!k,i=this;k=k||this._container;if(!k){return;}var e=function(A){var x=j?i:this,E=this._getErrorBox(),n=this.getId(),B=x._options.validationError&&(A.type=="mouseenter"||A._eventName=="onFocusIn");if(B){E.find("span").empty().append(x._options.errorMessage||"");var l,s=k.offset(),o=$(window).scrollLeft(),D=$(window).scrollTop(),G=$(window).width()+o,r=$(window).height()+D,w=E.outerWidth(),q=E.outerHeight(),v=E.height(),u=(q-v)/2,F=parseInt(E.css("margin-left"),10),t=false,y=3;s.top-=v;if(s.left+w+F>G-y){s.left=G-w-F-y;}if(s.top+q-u>r){s.top=r-q+u;}if(s.left+F-y<o){s.left=-F+y;}if(s.top-u<D){t=true;s.top=k.offset().top+k.height()+8-parseInt(E.css("margin-top"),10);}E.css(s);l=Math.max(0,k.offset().left-s.left);var C=E.find(".ws-arrow-balloon"),z=E.find(".ws-arrow-balloon-rt");C.toggle(!t).css("left",10+l);z.toggle(t).css("left",24+l);if(this._options.linkTextAlign=="right"){var p=k.width()-10-C.width();C.css("left",p);z.css("left",p);}E.data("ownerId",n);}if(E.data("ownerId")==n){E.css("display",B?"block":"none");if(B&&$.browser.opera){C.toggle(t).toggle(!t);z.toggle(!t).toggle(t);}if(E.data("timerID")){clearInterval(E.data("timerID"));E.data("timerID",undefined);}if(B){var m=setInterval(function(){if(!k.is(":visible")){E.hide();clearInterval(m);E.data("timerID",undefined);}},100);E.data("timerID",m);}}};var f=function(){if(j){j.subscribe("onFocusIn",e);j.subscribe("onFocusOut",e);}else{if(!g){i.subscribe("onFocusIn",e);i.subscribe("onFocusOut",e);}}k.bind("mouseenter.wsErrorBoxBinder mouseleave.wsErrorBoxBinder",$.proxy(e,this));},h=function(){if(j){j.unsubscribe("onFocusIn",e);j.unsubscribe("onFocusOut",e);}else{if(!g){i.unsubscribe("onFocusIn",e);i.unsubscribe("onFocusOut",e);}}k.unbind(".wsErrorBoxBinder");};this._ErrorBoxBinder=f;this._ErrorBoxUnbinder=h;},markControl:function(e){var f=e&&(typeof e=="string"||e instanceof Array)?e:this._options.errorMessageFilling;this._createErrorMessage(f);this._options.validationError=true;this._container.addClass("ws-validation-error");},clearMark:function(){if(this._options.validationError){this._options.validationError=false;this._options.errorMessage="";this._container.removeClass("ws-validation-error");if(d.hasTarget()&&d.isCurrentTarget(this._getExtendedTooltipTarget())){if(this._isCanShowExtendedTooltip()){this._showExtendedTooltip(true);}else{d.hide(0);}}}},isMarked:function(){return this._options.validationError;},destroy:function(){if(this._context){this._context.unsubscribe("onDataBind",this._contextUpdateHandlerFunction);this._context.unsubscribe("onFieldChange",this._contextUpdateHandlerFunction);}if(d.hasTarget()&&d.isCurrentTarget(this._getExtendedTooltipTarget())){d.hide();}$ws.proto.DataBoundControl.superclass.destroy.apply(this,arguments);},_onContextValueReceived:function(e){}});return{Control:$ws.proto.Control,DataBoundControl:$ws.proto.DataBoundControl,ControlStorage:$ws.single.ControlStorage,ControlBatchUpdater:$ws.single.ControlBatchUpdater};});