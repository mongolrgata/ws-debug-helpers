$ws.declareModule({namespace:"SBIS3.CORE",name:"PathSelector",imports:["SBIS3.CORE.Control"]},function(a){$ws._const.PathSelector={delayMenuHide:200};$ws.proto.PathSelector=a.Control.extend({$protected:{_options:{dataSource:undefined,path:[],rootNodeCaption:"Корень",rootNodeId:null,titleColumn:"",folderIcon:"img/browser/folder.gif",hierarchyField:"Раздел",filterParams:{}},_path:[],_width:[],_block:undefined,_back:undefined,_points:[],_showedPoints:0,_menuShowed:-1,_pressedArrow:undefined,_menuContainer:undefined,_recordSet:undefined,_browserRecordSet:undefined,_indicator:undefined,_paging:undefined,_menuCache:{},_loaded:{},_rootElement:undefined,_ready:undefined,_menuMaxHeight:undefined,_hierarchyField:undefined},$constructor:function(){this._initConfig();this._initBlock();this._initRecordSet();this._initEvents();},_initConfig:function(){if(this._options.rootNodeId===-1){this._options.rootNodeId=null;}this._path=this._options.path;this._path.unshift({title:this._options.rootNodeCaption,id:this._options.rootNodeId});this._hierarchyField=this._options.hierarchyField+"@";this._publish("onPathChange","onArrowClick","onDrawPoint");},_initBlock:function(){this._container.removeAttr("tabindex").addClass("ws-no-select");this._block=$('<div class="ws-path-block"></div>');this._block.appendTo(this._container);this._build();},_initRecordSet:function(){var b=this._options.dataSource;if(b.filterParams===undefined){b.filterParams={};}b.filterParams=$ws.core.merge(this._options.filterParams,b.filterParams);b.filterParams["Разворот"]="Без разворота";b.filterParams["ВидДерева"]="Только узлы";b.usePages="";b.handlers={onBeforeLoad:this._onBeforeLoad.bind(this),onAfterLoad:this._onDataLoaded.bind(this)};b.firstRequest=false;b.waitForPrevQuery=true;this._ready=$ws.core.attachInstance("Source:RecordSet",b).addCallback(function(c){this._recordSet=c;return c;}.bind(this));},_initEvents:function(){var b=this._block.get(0);this._block.bind("click",function(c){c.stopPropagation();});$(".ws-path-point",b).live("click",this._onMouseClick.bind(this));$(".ws-path-arrow",b).live("mousedown",this._onMouseDown.bind(this));$(".ws-path-point, .ws-path-arrow",b).live("mouseover",this._onMouseOver.bind(this));},_build:function(){var c;this._block.empty();this._points=[];this._back=$('<span class="ws-path-arrow ws-path-back ws-hidden"></span>');for(var d=0,b=this._path.length;d<b;++d){c=this._drawPoint(d,d===b-1);if(d===0){this._rootElement=c;this._back.appendTo(this._block);}}this._onResizeHandler();},_onPointClick:function(c,g,f){if(c!==undefined){var e=this._path.length-c-1;for(var b=0;b<e;++b){var d=this._path.pop().id;this._menuCache[d]=undefined;delete this._menuCache[d];this._loaded[d]=0;}if(this._path[c].id!=g){this._path.push({id:g,title:f});}}else{this._path=[{id:g,title:f}];}this._build();this._onResizeHandler();this._notify("onPathChange",g);},_onMouseClick:function(c){if(this.isEnabled()){var d=$(c.target).closest(".ws-path-point"),b=d.data("index"),f=this._path[b].id,e=this._path[b].title;if(b+1!==this._path.length){this._onPointClick(b,f,e);}}},_onMouseDown:function(d){if(this.isEnabled()){var e=$(d.target),c=e.data("index"),b=e.hasClass("ws-path-back");this._pressedArrow=e.addClass("ws-path-pressed");this._processMenu(b?this._options.rootNodeId:this._path[c].id,e,b);}},_processMenu:function(f,e,b){var d;if(b){d=[];for(var c=this._path.length-this._showedPoints-1;c>0;--c){d.push(this._path[c]);}}this._processMenuForRows(d,f,e);},_processMenuForRows:function(c,d,b){this._menuShowed=d;if(!this._menuContainer){this._createMenu(c,b,d);}else{this._updateMenuPosition(b);this._menuShow();this._setMenuRows(c,d);}},_onMenuClick:function(e){var f=$(e.target).closest(".ws-path-menu-action"),h=f.data("id"),g=f.text(),c;for(var d=0,b=this._path.length;d<b;++d){if(this._path[d].id===this._menuShowed){c=d;break;}}if(c!==undefined){this._onPointClick(c,h,g);}},_initMenuEvents:function(){this._menuContainer.bind("blur",this._menuStartHide.bind(this));$(".ws-path-menu-action",this._menuContainer.get(0)).live("click",this._onMenuClick.bind(this));},_createMenu:function(c,b,d){this._menuContainer=$('<div class="ws-path-menu" tabindex="-1"></div>').appendTo($("body"));this._updateMenuPosition($(b));this._setMenuRows(c,d);this._container.trigger("wsSubWindowOpen");this._initMenuEvents();setTimeout(function(){this._menuContainer.focus();}.bind(this),0);},_clearPressedArrow:function(){if(this._pressedArrow){this._pressedArrow.removeClass("ws-path-pressed");this._pressedArrow=undefined;}},_onMouseOver:function(d){var f=$(d.target).closest(".ws-path-point, .ws-path-arrow"),c=f.data("index"),b=f.hasClass("ws-path-back"),g=b?this._options.rootNodeId:this._path[c].id,e;if(this._menuShowed!==-1&&g!==this._menuShowed&&(b||c<this._path.length-1)){this._clearPressedArrow();e=b?f:this._points[c][1];this._pressedArrow=e.addClass("ws-path-pressed");this._processMenu(g,e,b);}},_getPointContents:function(c,d){if(c===0&&!this._options.rootNodeCaption){var b;if(this.isEnabled()){b="icon-primary action-hover";}else{b="icon-disabled";}return'<span class="ws-path-point icon-16 icon-Close '+b+(d?" ws-hidden":"")+' ws-path-root-icon" title="Перейти в корень"></span>';}return'<span class="ws-path-point ws-path-point-text">'+(this._path[c].title?$ws.helpers.escapeHtml(this._path[c].title):"")+"</span>";},_drawText:function(c,e){var f=this._path[c],d=this._notify("onDrawPoint",f,e),b;if(d instanceof jQuery){b=d.addClass("ws-path-point");}else{b=$(this._getPointContents(c,e));}b.attr("data-index",c);if(e){b.addClass("ws-path-point-last");}else{b.addClass("ws-path-point-not-last");}return b;},_drawPoint:function(c,d){var b=this._drawText(c,d),e=$('<span class="ws-path-arrow"></span>');e.attr("data-index",c);if(d){e.addClass("ws-hidden");}this._block.append(b,e);this._points.push([b,e]);this._width[c]=(this._width[c-1]||0)+b.outerWidth()+e.outerWidth();return b;},getLastNodeId:function(){return this._path[this._path.length-1].id;},setPath:function(b){this._path=b;this._path.unshift({title:this._options.rootNodeCaption,id:this._options.rootNodeId});this._build();},append:function(b){this._container.find(".ws-path-point-last").removeClass("ws-path-point-last").addClass("ws-path-point-not-last");this._container.find(".ws-path-arrow-block.ws-hidden").removeClass("ws-hidden");this._path.push(b);this._drawPoint(this._path.length-1,true);if(this._path.length===2&&!this._options.rootNodeCaption&&this.isEnabled()){this._points[0][0].addClass("icon-primary action-hover").removeClass("ws-hidden");}this._onResizeHandler();},pop:function(){var b=this._points.length;this._points[b-1][0].remove();this._points[b-1][1].remove();this._points.pop();if(b>=2){this._points[b-2][0].removeClass("ws-path-point-not-last").addClass("ws-path-point-last");this._points[b-2][1].addClass("ws-hidden");if(b===2&&!this._options.rootNodeCaption){this._points[0][0].removeClass("icon-primary action-hover").addClass("ws-hidden");}}var c=this._path.pop().id;this._menuCache[c]=null;delete this._menuCache[c];this._loaded[c]=0;this._onResizeHandler();},isEmpty:function(){return this._path.length===1;},setRootNode:function(b){this._options.rootNodeId=b;this.setPath([]);},updateLast:function(){var b=this._points.length;if(b){var c=this._path[b-1].id;if(this._menuShowed==c){this._menuContainer.html("");this._menuContainer.append(this._indicator=$('<div class="ws-path-loading"></div>'));}}},_onResizeHandler:function(){var g=this._container.width(),f=this._points.length,e,c=this,b=function(m,k){for(var l=0;l<2;++l){if(m===f-1&&l===1){continue;}c._points[m][l].toggleClass("ws-hidden",!k);}};if(f==1){this._back.addClass("ws-hidden");b(0,false);}else{var d=this._width[0];if(this._width[f-1]>g){this._back.removeClass("ws-hidden");this._points[0][1].addClass("ws-hidden");var h=f-1;for(e=f-2;e>=1;--e){if(d+this._width[f-1]-this._width[e]<g){h=e+1;}}for(e=1;e<f-1;++e){b(e,e>=h);}this._showedPoints=f-h-1;}else{this._back.addClass("ws-hidden");for(e=0;e<f-1;++e){b(e,true);}this._showedPoints=f-1;}}},_onBeforeLoad:function(){if(this._menuContainer){this._menuContainer.append(this._indicator=$('<div class="ws-path-loading"></div>'));}},_onDataLoaded:function(b,n,e,l){if(this._indicator){this._indicator.remove();this._indicator=undefined;}if(e){var h,c=this._recordSet.getLoadingId(),k=this._recordSet.getRecordCount();if(!this._menuCache[c]){this._menuCache[c]=[];}if(this._menuContainer&&c==this._menuShowed){this._menuContainer.empty();}if(k&&this._loaded[c]){var d=undefined;for(var g=0,j=this._path.length;g<j;++g){if(this._path[g].id==c){d=(g+1<j?this._path[g+1].id:undefined);break;}}this._recordSet.rewind();while((h=this._recordSet.next())!==false){var m=h.get(this._options.titleColumn),f=h.getKey();this._menuCache[c].push({title:m,id:f});}if(this._menuContainer&&c==this._menuShowed){this._drawMenuArray(c,this._menuCache[c],d);this._updateMenuHeight();}}else{if(this._menuContainer&&c==this._menuShowed&&this._menuContainer.is(":visible")){this._menuContainer.hide();this._container.trigger("wsSubWindowClose");}}}else{if(l.httpError==="403"){l.processed=true;}}},_menuShow:function(){if(!this._menuContainer.is(":visible")){this._menuContainer.show();this._container.trigger("wsSubWindowOpen");}var b=this;setTimeout(function(){b._menuContainer.focus();},0);},_menuHide:function(){if(!this._menuContainer){return;}this._menuShowed=-1;if(this._menuContainer.is(":visible")){this._container.trigger("wsSubWindowClose");}this._menuContainer.hide();this._clearPressedArrow();},_menuStartHide:function(){this._clearPressedArrow();this._menuHide();},_updateMenuPosition:function(b){var c=b.offset();this._menuContainer.css({left:c.left,top:c.top+b.outerHeight()});},_createMenuPoint:function(f,d,e,b){var c=(this._options.folderIcon!==$ws._const.Browser.hierarchyIcons)?' style="background-image: url('+$ws._const.wsRoot+this._options.folderIcon+');"':"";return'<div class="ws-path-menu-action'+(b?" selected":"")+'" data-id="'+e+'"><span class="ws-path-menu-icon icon-16 icon-Folder icon-disabled"'+c+'></span><div class="ws-path-menu-action-text">'+(d?$ws.helpers.escapeHtml(d).replace(/ /g,"&nbsp"):"&nbsp")+"</div></div>";},_updateMenuHeight:function(){if(this._menuMaxHeight===undefined){this._menuMaxHeight=parseInt(this._menuContainer.css("max-height"),10);}if(this._menuContainer.get(0).scrollHeight>this._menuMaxHeight){this._menuContainer.css("overflow-y","scroll");}},_drawMenuArray:function(g,f,e){var d="";for(var c=0,b=f.length;c<b;++c){d+=this._createMenuPoint(g,f[c].title,f[c].id,e==f[c].id);}this._menuContainer.html(d);this._updateMenuHeight();},_getRowsFromChilds:function(f){var c,e=[];for(var d=0,b=f.length;d<b;++d){if(this._browserRecordSet.contains(f[d])){c=this._browserRecordSet.getRecordByPrimaryKey(f[d]);if(c.get(this._hierarchyField)){e.push({title:c.get(this._options.titleColumn),id:c.getKey()});}}}return e;},_loadNode:function(e,c){var d,b;b=this._notify("onArrowClick",e);if(b instanceof $ws.proto.Deferred){this._onBeforeLoad();b.addCallback(function(f){this._drawMenuArray(e,f);}.bind(this));}else{if(this._browserRecordSet&&!this._browserRecordSet.usePaging()&&(d=this._browserRecordSet.recordChilds(e)).length){this._drawMenuArray(e,this._getRowsFromChilds(d),c);}else{if(this._recordSet&&!this._loaded[e]){this._loaded[e]=1;this._recordSet.loadNode(e,true,0);}}}},_setMenuRows:function(e,f){this._menuContainer.html("").css("overflow-y","hidden");var d;for(var c=0,b=this._path.length;c<b;++c){if(this._path[c].id==f){d=(c+1<b?this._path[c+1].id:undefined);break;}}if(e){this._drawMenuArray(f,e,d);}else{if(this._recordSet&&this._menuCache[f]){if(this._menuCache[f].length){this._drawMenuArray(f,this._menuCache[f],d);}else{if(this._menuContainer.is(":visible")){this._menuContainer.hide();this._container.trigger("wsSubWindowClose");}}}else{this._loadNode(f,d);}}},setQuery:function(b){this._loaded={};this._menuCache={};this._menuHide();b["Разворот"]="Без разворота";b["ВидДерева"]="Только узлы";b[this._recordSet.getHierarchyField()]=this.getLastNodeId();this._recordSet.clear();this._recordSet.resetFilter(b,true);},setSource:function(b){this._ready.addCallback(function(){this._recordSet.setSource(b.readerType,b.readerParams,b.filterParams,false);}.bind(this));},destroy:function(){if(this._menu){if(this._menuContainer.is(":visible")){this._container.trigger("wsSubWindowClose");}this._menuContainer.empty().remove();}$ws.proto.PathSelector.superclass.destroy.apply(this,arguments);},_updateWidths:function(){var d=0;for(var c=0,b=this._points.length;c<b;++c){d+=this._points[c][0].outerWidth()+this._points[c][1].outerWidth();this._width[c]=d;}},setRootName:function(b){this._options.rootNodeCaption=b;if(this._path[0]){this._path[0].title=b;}if(this._rootElement){var c=this._drawText(0,this._path.length===1);this._points[0][0].replaceWith(c);this._points[0][0]=c;this._updateWidths();this._onResizeHandler();}},setBrowserRecordSet:function(b){this._browserRecordSet=b;},setEnabled:function(b){if(b!==this._options.enable&&!this._options.rootNodeCaption){this._points[0][0].toggleClass("icon-primary action-hover",b).toggleClass("icon-disabled",!b);}$ws.proto.PathSelector.superclass.setEnabled.apply(this,arguments);},setHierarchyField:function(b){this._hierarchyField=b+"@";},_redraw:function(b){this._build();}});return $ws.proto.PathSelector;});