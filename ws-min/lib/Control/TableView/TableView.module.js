$ws.declareModule({namespace:"SBIS3.CORE",name:"TableView",imports:["SBIS3.CORE.DataViewAbstract"]},function(a){$ws._const.Browser=$ws._const.Browser||{};$ws._const.Browser.iconWidth=16;$ws._const.Browser.tabWidth=16;$ws._const.Browser.defaultCellPadding=7;$ws._const.Browser.iconPadding=3;$ws._const.Browser.minColumnWidth=8;$ws._const.Browser.defColWidth={"Логическое":"20px","Число целое":"40px","Деньги":"85px","Дата":"80px","Дата и время":"80px",another:"50px"};$ws._const.Browser.type2ClassMap={"Деньги":"money","Число целое":"integer","Число вещественное":"integer"};$ws._const.Browser.rowOptionsMenuOffset={left:8,top:27};$ws._const.Browser.rowOptionsElementsOffset={right:0,top:0};$ws._const.Browser.rowOptionsOverflow=3;$ws._const.Browser.rowOptionsButtonWidth=34;$ws._const.Browser.rowOptionsActions={addItem:true,edit:true,"delete":true};$ws._const.Browser.rowOptionsShowDelay=350;$ws._const.Browser.rowOptionsHideDelay=1000;$ws._const.Browser.pathSelectorHeight=21;$ws._const.Browser.rowOptionBeforeAll=-1;$ws.single.DependencyResolver.register("SBIS3.CORE.TableView",function(e){var j={};if(e){if(e.display.ladder&&e.display.ladder.length){j["/lib/Control/Plugins/Ladder-plugin.js"]=1;}if(e.display.columns!==undefined){var d=false,c=false,g=e.display.columns,b=g.length,h={};for(var f=0;f<b;f++){h=g[f];if(h.allowEditAtThePlace){d=true;}if(h.isResultField){c=true;}if(d&&c){break;}}if(e.display.editAtThePlaceTemplate){d=true;}if(d){j["/lib/Control/Plugins/AtPlaceEdit-plugin.js"]=1;}if(c){j["/lib/Control/Plugins/Results-plugin.js"]=1;}}if(e.colorMark){j["SBIS3.CORE.PLUGINS.ColorMarkPlugin"]=1;}}return Object.keys(j);},"SBIS3.CORE.DataViewAbstract");$ws.proto.TableView=a.extend({$protected:{_options:{display:{useSorting:true,hasZebra:true,cutLongRows:false,rowOptions:false,rowRender:"",headColumnRender:"",showHead:true,headRender:"",showActiveRowInFocus:true,showSelectionCheckbox:false,useSeparating:false,useDrawingLines:false,mainRowOptions:{}}},_columnMap:[],_bodyColumns:"",_headColumns:"",_rowOptionsInitialized:false,_rowOptionsElement:false,_hasRowOptions:false,_rowOptionsMenu:undefined,_rowOptionsHoverRow:undefined,_rowOptionsHoverRecord:undefined,_rowOptionsTargetRow:undefined,_rowOptionsMenuVisible:false,_rowOptionsCurrentMenu:undefined,_rowOptionsButtons:{},_rowOptionsMenuButtons:[],_rowOptionsDisableStandart:false,_rowOptionsDefault:[],_rowOptionsLeaveTimer:0,_rowOptionsShowTimer:0,_rowOptions:{},_highlight:"",_emptyDataScroller:undefined,_columnFilterMap:[],_rowSelection:undefined,_rowsMap:{},_colgroupCache:undefined,_mainRowOptionsCount:0},$constructor:function(){this._publish("onRowOptions","onResetColumnFilter");this.subscribe("onFilterChange",$.proxy(this._onFilterChangeHandler,this));this.subscribe("onNewAction",$.proxy(this._onNewAction,this));var b=this.getParentWindow();if(b!==undefined){this._container.addClass("ws-browser-in-dialog");}if(this._options.display.rowOptions){this._initRowOptionsDefaults();}if(!Object.isEmpty(this._options.display.mainRowOptions)){this._mainRowOptionsCount=Object.keys(this._options.display.mainRowOptions).length;}},_contentHeightChanged:function(){$ws.proto.TableView.superclass._contentHeightChanged.apply(this,arguments);this._hideRowOptions();},_onNewAction:function(c,b){if(this._options.display.rowOptions){this.addRowOption(b);}},_onFilterChangeHandler:function(f,d){var h,e,c;if(!Object.isEmpty(this._options.display.columns)){for(var b in this._options.display.columns){if(this._options.display.columns.hasOwnProperty(b)){if(this._options.display.columns[b].filterDialog){e=this._options.display.columns[b];c=e.filterName?e.filterName:e.title;if(d[c]){this._columnFilterMap[c]=b;}else{delete this._columnFilterMap[c];this._clearMarkColumnFilter(b,e.title);}}}}}if(this._columnMap.length>0){for(var g in this._columnFilterMap){if(this._columnFilterMap.hasOwnProperty(g)){if(d[g]){h=this._columnFilterMap[g];this._markFilteredColumn(d,h);}}}}},resetFilterByColumnName:function(d){var g={},h;if(d){for(var e=0,c=this._columnMap.length;e<c;++e){if(this._columnMap[e].title===d){g=this._columnMap[e];h=e;break;}}if(!Object.isEmpty(g)&&g.filterDialog){var f=this.getQuery();if(f[g.filterName||g.title]){delete f[g.filterName||g.title];}var b=this._notify("onResetColumnFilter",f,g.filterName||g.title,g.title);this.setQuery(b&&Object.prototype.toString.call(b)=="[object Object]"?b:f);this._clearMarkColumnFilter(h,g.title);}}},_clearMarkColumnFilter:function(d,c){var b=this._head.find("#"+d+".ws-browser-head-link");$(b).next(".ws-browser-filter").css("display","none");if(b.html()!==c){b.text(c);}},_markFilteredColumn:function(d,g){var f,e={},c,b;if(d&&g){f=false;e=this._columnMap[g];c=e.filterName||e.title;b=this._head.find("#"+g+".ws-browser-head-link");if(b.length>0){if(e.visualFilterFunction){f=e.visualFilterFunction.apply(this,[d]);}if(!f&&e.title){b.empty().append(e.title);}if(d[c]){if(f instanceof Object&&"jquery" in f){b.empty().append(f);}else{if(typeof(f)==="string"){b.html($ws.helpers.escapeHtml(f));}else{b.text(d[c]);}}b.next(".ws-browser-filter").show();}}}},_bindHeaderEvents:function(){var b=this;$(".ws-browser-filter-trigger",this._head.get(0)).live("click",function(e){var d,f,c=$(this);f=this.id?this.id:c.prev(".ws-browser-head-link").attr("id");d=b._columnMap[f];if(c.attr("hasFilter")==="true"){b.createFiltersDialog.apply(b,[d.filterDialog,f]);}else{b.resetFilterByColumnName.apply(b,[d.title]);}e.preventDefault();e.stopPropagation();return false;});$(".ws-browser-head-hover",this._head.get(0)).live("click",{self:this},this._headCellClick);$(".ws-browser-checkbox-holder",this._head.get(0)).live("click",function(c){var d=$(this).closest("tr");if(!d.hasClass("ws-browser-selected")){b.selectAll();d.addClass("ws-browser-selected");}else{b.removeSelection();d.removeClass("ws-browser-selected");}c.preventDefault();c.stopPropagation();return false;});},_createContainer:function(){var e=this._options.display.showRecordsCount||this._options.display.showPaging||this._options.display.showSelectionCheckbox,d=this._options.display.showHead,c=this._options.display.useDrawingLines?"ws-browser-border":"",b=this._options.display.allowHorizontalScroll,f=$.browser.msie?"&nbsp;":"";if(this._options.display.showActiveRowInFocus===false){this._container.addClass("ws-browser-hide-active-row");}this._container.get(0).innerHTML+=['<div class="ws-browser-ajax-loader ws-hidden">','<div class="ws-loading-indicator-outer">','<div class="ws-loading-indicator-block">','<div class="ws-loading-indicator ws-browser-loading-indicator">',($ws._const.theme==="wi_scheme"?"":"Загрузка"),"</div>","</div>","</div>","</div>",this._getResizerCode(),'<div class="ws-browser-data-container"',this._getBrowserDataContainerStyles()," >",'<div style="width: 100%;">',(this._options.display.showHead?['<div class="ws-browser-head-container">','<div class="ws-browser-head-scroller">',this._renderHead(),"</div>","</div>"].join(""):""),'<div class="ws-browser-container-wrapper">','<div class="ws-browser-container" tabindex="-1">','<table cellspacing="0" class="ws-table-fixed ws-browser '+c+" "+(d?"":"ws-browser-border-top")+'">',"<colgroup>",this._renderColgroups(),"</colgroup>",'<tbody class="ws-browser-body"></tbody>',"</table>",(b?'<div class="ws-browser-empty-scroller ws-hidden">'+f+"</div>":""),"</div>",'<div class="ws-browser-empty ws-hidden">',this._options.display.emptyHtml,"</div>","</div>",(e?['<div class="ws-browser-footer">','<table class="ws-browser-foot" cellspacing="0">',"<tfoot>","<tr>",'<td class="ws-browser-pager-cont">',(this._options.display.showRecordsCount?['<div class="ws-browser-pager ws-hidden">','<span class="ws-browser-pager-text">&nbsp;</span>',(this._options.display.usePaging&&this._options.display.usePageSizeSelect?['<div class="ws-browser-dropdown-container">','<span class="ws-browser-page-selector ws-browser-pager-select-text">&nbsp;(по&nbsp;</span>','<div  class="ws-browser-page-selector ws-browser-pager-select"></div>','<span class="ws-browser-page-selector ws-browser-pager-select-text">&nbsp;на странице)</span>',"</div>"].join(""):""),"</div>"].join(""):""),(this._options.display.showPaging?'<div class="ws-browser-paging"></div>':""),"</td>","</tr>","</tfoot>","</table>","</div>"].join(""):""),"</div>","</div>"].join("");$ws.proto.TableView.superclass._createContainer.apply(this,arguments);if(typeof(this._options.display.headRender)=="function"){this._options.display.headRender.apply(this,[this._head]);}this._initHeadVariables();this._bindHeaderEvents();},_getBrowserDataContainerStyles:function(){var b="";if(this._options.isRelative&&this._horizontalAlignment==="Stretch"){b=' style="position: absolute; top: 0; left: 0; right: 0;"';}return b;},_getResizerCode:function(){var b="";if(this._options.isRelative&&this._horizontalAlignment==="Stretch"&&this._isHeightGrowable()){b='<div class="ws-browser-resizer" style="position: relative"></div>';}return b;},_updateDataBlockSize:function(){this._setWidth();if(!this._emptyDataBlock.hasClass("ws-hidden")){var b=this._emptyDataBlock.parent().height(),c=this._emptyDataBlock.height("auto").height(),d=this._emptyDataBlock.width("auto").width();if(this._horizontalScrollShowed){b-=this._scrollWidth;}b=Math.max(b,c);this._emptyDataBlock.css({width:"",height:""});this._emptyDataBlock.height(b);this._browserContainer.css({"min-height":c+(this._horizontalScrollShowed?this._scrollWidth:0),"min-width":d+(this._verticalScrollShowed?this._scrollWidth:0)});}this._updateSizeVariables();},_onResizeHandler:function(){$ws.proto.TableView.superclass._onResizeHandler.apply(this,arguments);if(this.getActiveRow()!==false){this._setSelection(this.getActiveRow(),true);}},_onBeforeRenderActions:function(){var b;try{this._inBeforeRenderActionCnt++;b=this._notify("onBeforeRender",this.getColumns());}finally{this._inBeforeRenderActionCnt--;}if(b===false){this._hideLoadingIndicator();return false;}else{if(b instanceof Object){this._options.display.columns=b;this._columnMap=[];}}return true;},_initActionsFlags:function(){$ws.proto.TableView.superclass._initActionsFlags.apply(this,arguments);this._actions.clearSorting=this._options.display.useSorting&&$.proxy(this.clearSorting,this);},_findRow:function(b){var c=this._rowsMap[b]?this._rowsMap[b]:this._body.find('tr[rowkey="'+b+'"]');if(!c||!c.length){$ws.single.ioc.resolve("ILogger").error("Browser","Cannot find row with rowkey "+b);}return c;},_haveRow:function(b){return !!this._rowsMap[b];},_columnIndex:function(b){for(var c in this._columnMap){if(this._columnMap.hasOwnProperty(c)&&this._columnMap[c].title===b){return c;}}return -1;},_findCell:function(d,b){var c=this._columnIndex(b);if(c>=0){return this._findRow(d).children("td:eq("+c+")");}$ws.single.ioc.resolve("ILogger").error("Browser","Cannot find column with name "+b);return $();},_headCellClick:function(e){var f=$(this),d=f.attr("columnId"),o=e.data.self,n=o._columnMap[d].field,j=0,p=false,h=f.find(".ws-browser-sortable"),b=["asc","desc","none"];for(var g=o._sortingStack.length-1;g>=0;--g){if(!o._sortingStack[g]){continue;}if(o._sortingStack[g]["field"]==n){p=true;j=++o._sortingStack[g]["type"];if(j==2){delete o._sortingStack[g];}break;}}if(!p){o._sortingStack.push({field:n,type:0});}h.removeClass(b[(j+2)%3]);h.addClass(b[j]);if(o._currentRecordSet&&o._currentRecordSet instanceof $ws.proto.RecordSet){var k=[];for(var m=0,l=o._sortingStack.length;m<l;++m){if(!o._sortingStack[m]){continue;}k.push([o._sortingStack[m]["field"],o._sortingStack[m]["type"]>0]);}o._currentRecordSet.setPage(0,true);o._currentRecordSet.setSorting(k,o.getQuery(),o.isHierarchyMode());}},_setWidth:function(v){var q=this,p=-1,j=0,c=0,s=0,w=[],l=[],f=[],h=[],y;s=q._rootElement.width()-(this._verticalScrollShowed?this._scrollWidth:0)-1;if(this._options.display.showSelectionCheckbox&&this._options.useSelection!==false){s-=30;}if(this._columnMap.length===0){return;}function m(D){var A=q._columnMap[D].type,z=q._columnMap[D].minWidth,C=$ws._const.Browser.defColWidth,B=A in C?C[A]:C.another;return parseInt(z!==null?z:B,10);}if(s===0){this._needResize=true;}y=(s>this._options.minWidth?s:this._options.minWidth)+"px";this._data.width(y);if(this._head){this._head.closest("table").width(y);}if(!this._haveAutoWidth()){if(v){$ws.helpers.forEach(v,function(A,z){this._headColumns.eq(z).attr("width",A);this._bodyColumns.eq(z).attr("width",A);},this);}else{v=[];if(this._bodyColumns){this._bodyColumns.each(function(A){var z=(q._columnMap&&q._columnMap[A]&&q._columnMap[A].width)||0;l.push($(this));if(typeof(z)!="number"){if(z.indexOf("%")>0){z=Math.floor((s*parseInt(z,10))/100);}else{if(!q._columnMap[A]||!q._columnMap[A].fixedSize){f.push(A);}}}else{if(q._columnMap[A]&&!q._columnMap[A].fixedSize){f.push(A);}}if(q._columnMap[A]&&!q._columnMap[A].fixedSize){h.push(A);}z=parseInt(z,10);if(!z){z=m(A);if(q._columnMap[A]&&q._columnMap[A].fixedSize){throw new Error("Column with fixed size option must have width");}w.push(A);}v[A]=z;c+=z;if(z>j){j=z;p=A;}});}if(c>s&&h.length){var o=c-s,x=0;var k=function(z){$ws.helpers.forEach(h,function(A){if(A in v){var B=m(A);z(A,B,B-v[A]);}});};k(function(A,B,z){if(z>=0){o+=z;}else{x+=(-z);}});k(function(B,C,A){var z=v[B],D=(A>=0)?C:Math.max(z+o*(A/x),C);c+=(D-z);v[B]=D;});}var r=function(A){var z=A.length>0?Math.floor((s-c)/A.length):0;if(z>0){$ws.helpers.forEach(A,function(B){v[B]+=z;});c+=z*A.length;}};r(w.length?w:f);if(s>c){v[p]+=s-c;}if(this._bodyColumns){$ws.helpers.forEach(l,function(A,z){A.attr("width",v[z]);this._headColumns.eq(z).attr("width",v[z]);},this);}if(this._options.display.allowHorizontalScroll&&this._emptyDataScroller){this._emptyDataScroller.width(c);}}}else{this._data.removeClass("ws-table-fixed").width("auto").css({"table-layout":"auto"});this._head.parent().width("1px").css({"table-layout":"auto"});this._browserContainer.width("auto");if(!v){v=$ws.helpers.map(this._columnMap,function(z){return z.width;});}var i=this._data.find("tr:eq(0) td"),u=this._head.find("tr:eq(0) td"),b=this._container.find(".ws-browser-footer");$ws.helpers.forEach(v,function(z,A){q._bodyColumns.eq(A).attr("width","");q._headColumns.eq(A).attr("width","");},this);var e=0,d=this._currentRecordSet&&this._currentRecordSet.isEmptyTable();$ws.helpers.forEach(v,function(z,A){var B,C=this._columnMap[A]&&this._columnMap[A].fixedSize;if(C||d){B=C?v[A]:(v[A]||m(A));}else{B=Math.max(i.eq(A).outerWidth(),u.eq(A).outerWidth());if(this._columnMap[A]){this._columnMap[A].width=B=parseInt(B,10);}}e+=B;},this);$ws.helpers.forEach(this._columnMap,function(z,A){this._headColumns.eq(A).attr("width",z.width);this._bodyColumns.eq(A).attr("width",z.width);},this);this._data.width("auto");this._updateSizeVariables();var g=this._options.minWidth,n=false;if(this._verticalScrollShowed){g-=this._scrollWidth;}if(e<g){n=true;e=g;}var t=e;if(this._verticalScrollShowed){t+=this._scrollWidth;}this._data.width(e);this._browserContainer.width(t);this._head.parent().width(t);b.width(t);this._container.width("auto");this._rootElement.width(t);if(n){$ws.helpers.forEach(this._columnMap,function(z,A){if(!z.fixedSize){this._bodyColumns.eq(A).attr("width","");}},this);$ws.helpers.forEach(this._columnMap,function(z,A){var B=i.eq(A).outerWidth();if(!z.fixedSize){z.width=B;}this._bodyColumns.eq(A).attr("width",B);this._headColumns.eq(A).attr("width",B);},this);this._head.parent().width(t);}this._data.addClass("ws-table-fixed").css({"table-layout":"fixed"});this._head.parent().addClass("ws-table-fixed").css({"table-layout":"fixed"});}},_drawBodyCycle:function(){var n="",k=this,c;this._selectedRecords=[];if(!this._hasMarkup()){if(!$ws.proto.TableView.__markupTemplate){$ws.proto.TableView.__markupTemplate=doT.template(this._getMarkupTemplate());}var e,u,f={},s=0,m,t="",v="",d={columns:[],data:[],keys:[],classes:[],title:[],checkbox:this._options.display.showSelectionCheckbox&&this._options.useSelection!==false},r,o=this._columnMap.length;for(r=0;r<o;r++){f=k._columnMap[r];m="";if(f.textAlign==="auto"&&$ws._const.Browser.type2ClassMap[f.type]){m=" ws-browser-type-"+$ws._const.Browser.type2ClassMap[f.type];}d.columns.push({textAlign:f.textAlign,type:f.type,className:f.className+m,render:f.render?true:false});}this._currentRecordSet.rewind();while((c=this._currentRecordSet.next())!==false){e=this._options.display.hasZebra?(s%2):true;u=c.getKey();if(typeof u=="string"){u=u.replace(/'/g,"&#039;");}d.keys.push(u);d.classes[s]=""+(e?"":" rE");if(this._selected&&this._selected[u]!==undefined){d.classes[s]+=" ws-browser-selected";this._selectedRecords.push(c);}d.data[s]=[];for(r=0;r<o;r++){f=k._columnMap[r];t=k._renderTD(f,c);if(this._options.display.cutLongRows){d.title[s]=d.title[s]||[];v=t;if(typeof v=="string"){v=$ws.helpers.escapeTagsFromStr(t,[]).replace(/'/g,"&#039;");}d.title[s].push(v);}d.data[s]=d.data[s]||[];d.data[s].push(t);}s++;}n=$ws.proto.TableView.__markupTemplate(d);}this._body.remove();this._body=$(n);var g=typeof(this._options.display.rowRender)=="function"?this._options.display.rowRender:false;if(g){var h=this._body.find(".ws-browser-table-row"),b;for(var q=0,p=h.length;q<p;q++){b=$(h[q]);c=this._currentRecordSet.getRecordByPrimaryKey(b.attr("rowkey"));if(g){g.apply(this,[c,b]);}}}if(this._options.display.allowHorizontalScroll){this._emptyDataScroller.toggleClass("ws-hidden",!s);}this._data.append(this._body);this._count=s;},_createMarkup:function(b){throw new Error("Youno use it!");},_getMarkupTemplate:function(){return["<tbody class='ws-browser-body'>","{{~it.keys :value:index }}","<tr class='ws-browser-table-row ws-visible {{=it.classes[index]}}' rowkey='{{=value}}'>","{{? it.checkbox }}","<td class='ws-browser-checkbox-holder'><div class='ws-browser-cell-paddings'><div class='ws-browser-cell-container'>","<span class='ws-browser-checkbox'/>","</div></div></td>","{{?}}","{{~it.columns :colvalue:colindex }}","<td class='ws-browser-valign-top {{? it.title[index] }}ws-browser-cell-cut{{?}}","{{? colvalue.textAlign !== 'auto' }}"," ws-browser-{{=colvalue.textAlign}}","{{?}}","{{? colvalue.className }}"," {{=colvalue.className}}","{{?}}","' coldefindex={{=colindex}}><div class='ws-browser-cell-paddings'>","<div class='ws-browser-cell-container {{? it.title[index] }}ws-browser-div-cut{{?}} {{? colvalue.render }}ws-browser-render{{??}}ws-browser-text-no-render{{?}}'","{{? it.title[index] && it.title[index][colindex]}}"," title='{{=it.title[index][colindex]}}'","{{?}}",">","{{=it.data[index][colindex]}}","</div></div></td>","{{~}}","</tr>","{{~}}","</tbody>"].join("");},delegateUserEvent:function(b,d,c,e){if(typeof b!=="string"||b===""){throw new TypeError("delegateEvent: Selector must be a non-empty string");}if(typeof c!="function"){throw new TypeError("delegateEvent: Handler must be a function");}if(typeof d!="string"||d===""){throw new TypeError("delegateUserEvent: Event name must be a non-empty string");}this._container.find(".ws-browser-container table").delegate(b,d,e,c);},_renderTD:function(c,b){var d=b.hasColumn(c.field)?b.get(c.field):"";return this._prepareColumnData(c,d,b);},_prepareColumnData:function(c,e,b){var d=null;if(typeof(c.render)==="function"){d=c.render.apply(this,[b,c.field]);if(d instanceof Object&&"jquery" in d){d=$ws.helpers.jQueryToString(d);}if(typeof(d)==="string"){d=$ws.helpers.escapeTagsFromStr(d,["script"]);}}else{if((d=e)!==null){if(typeof(d)==="string"&&!c.render){d=$ws.helpers.escapeHtml(d);}if(c.formatValue){d=$ws.helpers.format(b,c.formatValue);}else{switch(c.type){case"Перечисляемое":d=$ws.render.defaultColumn.enumType(d);break;case"Деньги":d=$ws.render.defaultColumn.money(d);break;case"timestamp":case"timestamptz":case"interval":case"date":case"Дата":case"Дата и время":case"Время":d=$ws.render.defaultColumn.timestamp(d,c.type);break;case"oid":case"int2":case"int4":case"int8":case"Число целое":d=$ws.render.defaultColumn.integer(d);break;case"boolean":case"bool":case"Логическое":d=$ws.render.defaultColumn.logic(d,true);break;case"Флаги":d=$ws.render.defaultColumn.flags(d);break;case"":break;default:break;}}d=this._highlightData(d);}else{d="";}}return d;},_highlightData:function(b){if(this._highlight&&b&&typeof(b)==="string"){b=b.replace(new RegExp(this._highlight,"gi"),'<span class="ws-browser-highlight">$&</span>');}return b;},_prepareHeadStruct:function(){var v=0,f=[],w,u=-1,g,m,h=0,x=0;for(w in this._columnMap){if(this._columnMap.hasOwnProperty(w)){f[++u]=[];h++;var y=this._columnMap[w].title,l=0;do{/^([^\.]*)(\.?(.*)$|$)/.exec(y);if(RegExp.$3){if(RegExp.$3.substr(0,1)===" "&&(RegExp.$1.charAt(RegExp.$1.length-1)!=="\\")){var e=RegExp.$1+". ";/^([^\.]*)(\.?(.*)$|$)/.exec(RegExp.$3);e+=RegExp.$1;f[u].push({title:e});y=RegExp.$3;}else{f[u].push({title:RegExp.$1});y=RegExp.$3;}}else{f[u].push({title:RegExp.$1+RegExp.$2});y=null;}}while(y);l=0;while(l<=f[u].length-1){var o=f[u][l].title;if(o!==""){f[u][l].title=f[u][l].title.replace(/\\\\\\./g,"\\.");if(f[u][l].title==="\\\\."){f[u][l].title=".";}else{if(o.charAt(o.length-1)==="\\"&&o.charAt(o.length-2)==="\\"){f[u][l].title=f[u][l].title.replace(/\\\\$/,".");f[u][l].title+=f[u][l+1].title;f[u].splice(l+1,1);l--;}else{if(l===f[u].length-1){f[u][l].title=f[u][l].title.replace("\\\\.",".");}}}}l++;}v=f[u].length>v?f[u].length:v;}}for(var r=0;r<v;r++){u=-1;for(w in this._columnMap){if(this._columnMap.hasOwnProperty(w)){var p=this._columnMap[w];++u;var t=f[u][r],b=u!==0&&f[u-1]&&f[u-1][r]?f[u-1][r].title:undefined;if(t!==undefined&&(u===0||(t.title!=b))){var d=f[u][r].title;for(g=u;g<h&&(f[g]!==undefined)&&d==t.title;g++){d=f[g+1]&&f[g+1][r]?f[g+1][r].title:undefined;}g--;for(m=r+1;m<v&&f[u][m]===undefined;m++){}m--;if(g>u){x+=g-u+1;}else{x++;}var q="";for(var s=0;s<=r;s++){q+=(s===0?"":".")+f[u][s].title;}t.csIndex=x;t.columnId=w;t.rs=m;t.cs=g;t.colspan=g-u+1;t.rowspan=m-r+1;t.colName=q;if(typeof(this._columnMap[w].captionRender)=="function"){t.content=this._columnMap[w].captionRender.apply(this,[q]);}else{if(typeof(this._options.display.headColumnRender)=="function"){t.content=this._options.display.headColumnRender.apply(this,[q]);}}t.content=t.content||t.title;t.filterVis=p.title;t.hasFilter=false;if(this._initialFilter){var c=p.filterName||p.title;if(this._initialFilter[c]){t.hasFilter=true;if(p.visualFilterFunction){t.filterVis=p.visualFilterFunction.call(this,this._initialFilter);}else{t.filterVis=this._initialFilter[c];}}}}}}}return[f,v];},_prepareHeadTemplate:function(s){if(!s||s.length!=2){return"";}var p=s[1];var o=s[0];var g;var t=[];var d=false,q=(this._options.display.showSelectionCheckbox===true);for(var c=0;c<p;c++){t.push("<tr class='ws-browser-head-",(c===0?"top":"bottom"),"'>");g=-1;if(q){var m=(c+1===o[0].length);t.push("<td class='"+(m?"ws-browser-checkbox-holder":"")+"'>"+(m?"<span class='ws-browser-checkbox'></span>":"")+"</td>");}for(var h in this._columnMap){if(this._columnMap.hasOwnProperty(h)){++g;var l=o[g][c];if(l!==undefined&&(g===0||l.title!=(o[g-1][c]&&o[g-1][c].title))){var f=l.rs,k=l.cs,e=l.csIndex,b=l.columnId;if(l.colspan>1){d=true;}t.push(["<td columnId='",b,"' csIndex='",e,"' class='",["ws-browser-header-cell",(this._columnMap[g]?"ws-browser-valign-"+this._columnMap[g].verticalAlign:""),(this._options.display.useSorting&&f+1==p&&this._columnMap[h].isSortable?"ws-browser-head-hover":""),("ws-browser-"+this._columnMap[h].captionAlign),(k==g&&this._columnMap[h].type=="text"?"ws-browser-text":""),(this._options.display.useSeparating===true&&g<(o.length-1)?"ws-browser-separatable":"")].join(" "),"' ",(k>g?" colspan='"+l.colspan+"' ":""),(f>c?" rowspan='"+l.rowspan+"' ":""),">","<div>",(this._options.display.useSorting===true?"<span class='ws-browser-sortable none'></span>":""),(l.content.jquery?$ws.helpers.jQueryToString(l.content):(!this._columnMap[g].filterDialog?$ws.helpers.escapeHtml(l.content).replace(/\n/mg,"<br>"):["<a href='javascript:void(0)' class='ws-browser-head-link ws-browser-filter-trigger' hasFilter='true' id='",h,"'>",(l.filterVis.jquery?$ws.helpers.jQueryToString(l.filterVis):l.filterVis),l.content,"</a>","<span class='ws-browser-filter ws-browser-filter-trigger' style='",(l.hasFilter?"display: block;":""),"' hasFilter='false'></span>"].join(""))),"</div>","</td>"].join(""));}}}t.push("<td class='ws-browser-header-cell-scroll-placeholder' width='",this._scrollWidth,"'>&nbsp;</td>");t.push("</tr>");}if($ws._const.browser.isIE&&d){var r=[];r.push("<tr>");if(q){r.push("<td></td>");}$ws.helpers.forEach(this._columnMap,function(){r.push("<td></td>");});r.push('<td class="ws-browser-header-cell-scroll-placeholder"></td>');r.push("</tr>");t=r.concat(t);}return t.join("");},_renderColgroups:function(b){if(this._colgroupCache&&!b){return this._colgroupCache;}this._colgroupCache=$ws.helpers.reduce(this._columnMap,function(e,d){var c;if((d.fixedSize||this._haveAutoWidth())&&(c=d.width)){e.push('<col class="ws-browser-col" width="',c,'"/>');}else{e.push('<col class="ws-browser-col"/>');}return e;},[this._options.display.showSelectionCheckbox?'<col width="27"/>':""],this).join("");return this._colgroupCache;},_renderHead:function(){var b=this._options.display.useDrawingLines?"ws-browser-border":"";return['<table cellspacing="0" class="ws-table-fixed ws-browser-head '+b+'">',"<colgroup>",this._renderColgroups(),"</colgroup>","<thead>",this._prepareHeadTemplate(this._prepareHeadStruct()),"</thead>","</table>"].join("");},refresh:function(b){this._runInBatchUpdate("TableView.refresh",function(){if(this._dReady.isReady()&&this._currentRecordSet){this._rowSelectionSetted=false;if(this._onBeforeRenderActions()){if(b||!this._columnMap||this._columnMap.length===0){this._refreshHead();}var c=this._browserContainer.find("colgroup").eq(0);c.empty().append(this._renderColgroups());this._bodyColumns=c.children(".ws-browser-col");this._drawBody();this._setHeight();}}});},_refreshHead:function(){if(!this._options.display.showHead){return;}this._colgroupCache=undefined;if(this._columnMap.length===0){this._mapColumns();$(this._container.find("colgroup")[1]).empty().append(this._renderColgroups());}this._headContainer.find(".ws-browser-head-scroller").empty().append(this._renderHead());this._initHeadVariables();this._bindHeaderEvents();},_mapColumns:function(){var b=this._options.display.columns,d=this._currentRecordSet&&this._currentRecordSet.getColumns(),c=b?b:d,f=0;if(c){for(var e in c){if(c.hasOwnProperty(e)){var k=c[e],j=k.field?k.field:k.title,h=k.title,g=(d&&d[j])?d[j].type:(k.type?k.type:null);this._columnMap[f]={title:h,isSortable:k.field!==undefined&&(k.isSortable!==undefined?k.isSortable:true),field:j,render:k.render?k.render:null,type:g,fixedSize:k.fixedSize?k.fixedSize:false,textAlign:k.textAlign?k.textAlign:"auto",className:k.className?k.className:"",captionAlign:k.captionAlign?k.captionAlign:"auto",captionRender:k.captionRender?k.captionRender:null,formatValue:k.formatValue?k.formatValue:null,filterDialog:k.filterDialog?k.filterDialog:null,filterName:k.filterName?k.filterName:h,visualFilterFunction:k.visualFilterFunction?k.visualFilterFunction:null,verticalAlign:k.verticalAlign?k.verticalAlign:null,minWidth:k.minWidth||null};this._columnMap[f].width=k.width?parseInt(k.width,10):(this._getDefWidth(this._columnMap[f].type));f++;}}}},getColumnMap:function(){return this._columnMap;},_getDefWidth:function(b){if(b&&$ws._const.Browser.defColWidth[b]){return $ws._const.Browser.defColWidth[b];}return null;},_initHeadVariables:function(){this._head=this._rootElement.find("thead");this._headColumns=this._head.parent().find("col.ws-browser-col");this._bodyColumns=this._body.parent().find("col.ws-browser-col");this._resultsColumns=this._rootElement.find(".ws-browser-foot.results").find("col.ws-browser-col");this._scrollGapPlaceholder=this._head.find("td.ws-browser-header-cell-scroll-placeholder");this._initColumnsWidth();if(this._options.display.resizable){this._initResizeEvents();}},_initColumnsWidth:function(){var c=0,b=this;b._resizingColumn=b._head.find("th:first");b._idCols=[];for(var d in b._columnMap){if(b._columnMap.hasOwnProperty(d)){b._idCols[c]=d;c++;}}c=0;b._body.find("tr:first > td").each(function(){$(this).attr("id",b._idCols[c]);c++;});},_activeHoverHideSelection:function(c){if(!this._useKeyboard&&this._activeElement&&"jquery" in this._activeElement){var b=c?$(c.relatedTarget||c.toElement):false;if(b&&"jquery" in b){b=b.closest(".ws-browser-row-options-block");}if(b===false||b.length===0){this._activeElement.removeClass("ws-browser-item-over");this._activeElement=undefined;this._hovered=false;}}},_initEvents:function(){var b=this,c,d=this._body.parent()[0];$(".ws-browser-checkbox-holder",d).live("click",function(h){var g=$(this);b._runInBatchUpdate("ws-browser-checkbox-holder click",function(){if(b.isEnabled()){b._selectActiveElement(g.parents(".ws-browser tr.ws-browser-table-row"));}});h.stopImmediatePropagation();return false;});$ws.proto.TableView.superclass._initEvents.apply(this,arguments);this._checkRowOptions();if(this._options.useSelection){if(this._options.useHoverRowAsActive){this._data.addClass("ws-browser-active-hover");$("[rowkey]",d).live("mouseenter",function(){if(!b._useKeyboard){b.setActiveElement.apply(b,[$(this),false,true,false]);}});$(this._data).live("mouseleave",$.proxy(b._activeHoverHideSelection,b));}else{this._data.addClass("ws-browser-hover");}}var f=this._rootElement.find(".ws-browser-container"),e=this._headContainer.find(".ws-browser-head-scroller");f.bind("scroll",function(){var g=f.scrollLeft();e.scrollLeft(g);b._onScrollActions(g);});},_checkRowOptions:function(){if(this._options.display.rowOptions){if(!this._rowOptionsInitialized){this._rowOptionsInitialized=true;this._initRowOptions();}}},_initRowOptions:function(){if(this.isEnabled()){var b=this,c=this._rootElement.find(".ws-browser-container-wrapper");c.bind("mousemove",function(f){if(b._checkMoveRowOptions()){var d=$(f.target),e=d;if(f.target.nodeName.toLowerCase()!="tr"||!d.hasClass("ws-browser-table-row")){e=e.parents(".ws-browser tr.ws-browser-table-row");}b._hideRowOptionsForRow.apply(b,[d,e]);}});$("tr",b._body.parent()[0]).live("mouseenter",function(d){if(b._checkMoveRowOptions()){b._showRowOptions.apply(b,[d.target]);}});c.bind("mouseleave",function(){if(b._checkMoveRowOptions()){if(b._rowOptionsMenuVisible){b._rowOptionsTargetRow=undefined;}else{b._hideRowOptions();}}});}},_checkMoveRowOptions:function(){return true;},_hideRowOptionsForRow:function(b,c){if(!c||c.length===0||c.parents("table").get(0)!=this._data.get(0)){if(b.parents(".ws-browser-row-options-block").length===0&&!b.hasClass("ws-browser-row-options-block")){if(!this._rowOptionsMenuVisible){this._hideRowOptions();}else{this._rowOptionsTargetRow=undefined;}}return true;}},_showRowOptions:function(f){var d=$(f),e=d;if(f.nodeName.toLowerCase()!="tr"){e=e.parents(".ws-browser tr.ws-browser-table-row");}this._hideRowOptionsForRow.apply(this,[d,e]);var c=e.attr("rowkey"),b=this._currentRecordSet.contains(c)&&this._currentRecordSet.getRecordByPrimaryKey(c);if(!b){this._hideRowOptionsForRow.apply(this,[d]);return true;}if(this._rowOptionsMenuVisible){this._rowOptionsTargetRow=e;return true;}this._showRowOptionsForRow(e);},_uninitRowOptions:function(){this._browserContainer.unbind("mousemove");$("tr",this._body.parent()[0]).die("hover");this._rootElement.find(".ws-browser-container-wrapper").unbind("mouseleave");},_onScrollActions:function(b){if(this._hasRowOptions){this._hideRowOptions();}},_hideRowOptions:function(){if(this._rowOptionsMenuVisible){this._rowOptionsMenuVisible=false;this._rowOptionsCurrentMenu.show({});}if(this._rowOptionsElement){this._rowOptionsElement.addClass("ws-hidden");}this._rowOptionsTargetRow=this._rowOptionsHoverRow=undefined;this._rowOptionsHoverRecord=undefined;if(this._options.useSelection&&this._options.useHoverRowAsActive){this._activeHoverHideSelection();}},_additionalFilterRowOptions:function(c,b){if(this._isDisableEditOptionForRecord(b)){c.push("edit");}},_isDisableEditOptionForRecord:function(b){return !this._selectMode&&this._options.mode==="oneClickMode";},_showRowOptionsForRow:function(i){var d=i.attr("rowkey"),c=this._currentRecordSet.contains(d)&&this._currentRecordSet.getRecordByPrimaryKey(d);if(c){if(this._options.useHoverRowAsActive&&!this._useKeyboard){this.setActiveElement(i,false,true,false);}var g=[];if(!c){g=["edit","delete"];}else{if(this._rowOptionsDisableStandart===true){g=["edit","delete"];}else{if(this._rowOptionsDisableStandart!==false){g=this._rowOptionsDisableStandart||[];}}}this._additionalFilterRowOptions(g,c);g=this._rowOptionsFilterConcat(g);this._refilterRowOptions(g);var b=$ws.core.merge({},this._rowOptions,{clone:true}),f=this._notify("onRowOptions",c,i,this._rowOptions);if(f!==false){this._rowOptionsHoverRow=this._rowOptionsTargetRow=i;this._rowOptionsHoverRecord=c;var h=i.height();if(!(f instanceof Array)){f=[];}this._createRowOptions();f=f.concat(this._updateRowOptions(b));this._refilterRowOptions(g.concat(f));this._applyRowOptions();if(this._hasRowOptions&&this._rowOptionsElement&&i.parent().parent().length){var e=($ws._const.theme==="wi_scheme"?2:0);this._rowOptionsElement.css({top:i.position().top+$ws._const.Browser.rowOptionsElementsOffset.top+(this._emptyDataBlock&&this._emptyDataBlock.hasClass("ws-browser-empty-top")?$ws._const.Browser.pathSelectorHeight:0),right:(this._verticalScrollShowed?this._scrollWidth:e)+$ws._const.Browser.rowOptionsElementsOffset.right,height:h}).removeClass("ws-hidden");if($ws._const.theme!="wi_scheme"){this._rowOptionsElement.find(".ws-browser-row-option-border").css("top",(h/2-10)+"px");}return;}}}this._hideRowOptions();},_rowOptionsFilterConcat:function(f){var e=[];if((this._options.display.readOnly||!this._options.allowEdit||this._options.useHoverRowAsActive)&&!this._selectMode){e.push("edit");}if(this._options.display.readOnly||!this._options.allowDelete){e.push("delete");}for(var d=0,b=e.length;d<b;++d){var g=false;for(var c=0;c<f.length;++c){if(f[c]==e[d]){g=true;break;}}if(!g){f.push(e[d]);}}return f;},_refilterRowOptions:function(e){var f={};for(var c=0;c<e.length;++c){f[e[c]]=true;}this._rowOptions={};for(c=0;c<this._rowOptionsDefault.length;++c){var d=this._rowOptionsDefault[c],b=d[3]||d[2];if(!f[b]&&!(typeof(d[2])==="string"&&!this._actions[d[2]])){this._rowOptions[b]={title:d[0],icon:d[1],name:b,callback:typeof(d[2])==="string"?this._actions[d[2]]:d[2]};}}},_rowOptionsStartLeaveTimer:function(){this._rowOptionsStopLeaveTimer();var b=this;this._rowOptionsLeaveTimer=setTimeout(function(){if(b._rowOptionsMenu instanceof Object){b._rowOptionsMenu.hide();}},$ws._const.Browser.rowOptionsHideDelay);},_rowOptionsStopLeaveTimer:function(){if(this._rowOptionsLeaveTimer){clearTimeout(this._rowOptionsLeaveTimer);this._rowOptionsLeaveTimer=0;}},_rowOptionsShowMenu:function(b){this._rowOptionsStopShowTimer();this._rowOptionsStopLeaveTimer();this._rowOptionsMenuVisible=true;if(this._rowOptionsMenu instanceof Object){this._applyRowOptions();(this._rowOptionsCurrentMenu=this._rowOptionsMenu).show(b);}else{if(this._rowOptionsMenu===undefined){this._createRowOptionsMenu(b);}}},_rowOptionsStartShowTimer:function(c){this._rowOptionsStopShowTimer();var b=this;this._rowOptionsShowTimer=setTimeout(function(){b._rowOptionsShowMenu(c);},$ws._const.Browser.rowOptionsShowDelay);},_rowOptionsStopShowTimer:function(){if(this._rowOptionsShowTimer){clearTimeout(this._rowOptionsShowTimer);this._rowOptionsShowTimer=0;}},_rowOptionsEventHandler:function(b){this._rowOptionsHoverRow&&this._rowOptionsHoverRow[b.type==="mouseenter"?"addClass":"removeClass"]("hover");},_calculateImagePath:function(c,b){return b.indexOf("/")>-1?b:c+b;},_applyRowOptionItem:function(c,d,b){if(b.indexOf("sprite:")!=-1){$(c).removeClass("ws-browser-row-option");$(c).addClass(b.split("sprite:")[1]);}else{b=this._calculateImagePath(d,b);$ws.helpers.makeBackground(c,b);}},_isMainRowOption:function(b,c){if(c){return true;}if(!Object.isEmpty(this._options.display.mainRowOptions)){if(this._options.display.mainRowOptions.hasOwnProperty(b)&&this._options.display.mainRowOptions[b]){return true;}}return false;},_createRowOptions:function(){if(this._rowOptionsElement!==false){return;}var q=this,m=this._rootElement.find(".ws-browser-container-wrapper"),l=$ws._const.wsRoot+($ws._const.theme?"img/themes/"+$ws._const.theme+"/browser/":"img/browser/"),r=this._rowOptionsDefault;if(r.length){var f=($ws._const.theme=="wi_scheme"?"":'<img src="'+l+'panel_bg0.png" width="10" height="100%" style="float:right;">'),e=($ws._const.theme=="wi_scheme"?"":'<img class="ws-browser-row-options-bg" src="'+l+'panel_bg1.png" height="100%" style="position:absolute;">'),c=$('<div class="ws-browser-row-options-block ws-hidden">'+f+"</div>").bind("mouseenter mouseleave",$.proxy(this._rowOptionsEventHandler,q)),d=$('<div class="ws-browser-row-options-container">'+e+"</div>").prependTo(c),o=function(t){var s=t.offset(),i={};i.clientX=s.left+$ws._const.Browser.rowOptionsMenuOffset.left;i.clientY=s.top+$ws._const.Browser.rowOptionsMenuOffset.top;return i;};this._rowOptionsMenuButton=$('<span class="ws-browser-row-option-border ws-browser-row-option-menu-button"><span class="ws-browser-row-option menu"></span></span>').appendTo(d).hover(function(){if(!q._rowOptionsMenuVisible){q._rowOptionsStartShowTimer(o($(this)));}q._rowOptionsStopLeaveTimer();},function(){q._rowOptionsStopShowTimer();q._rowOptionsStartLeaveTimer();}).mousedown(function(i){i.stopImmediatePropagation();q._rowOptionsShowMenu(o($(this)));});for(var g=0,k=r.length;g<k;++g){var n=this._rowOptionsButtonCallback(r[g]),b="";if(typeof(r[g][2])==="string"){b=r[g][2];}else{if(r[g][3]){b=r[g][3];}}var j=$('<span class="ws-browser-row-option"></span>'),h=$('<span class="ws-browser-row-option-border" title="'+r[g][0]+'"></span>').appendTo(d).append(j).mousedown(function(i){i.stopPropagation();i.preventDefault();});if(this._isMainRowOption(b,r[g][6])){h.addClass("ws-browser-main-row-option");}var p=r[g][1];p=this._applyRowOptionItem(j,l,p);if(n){h.bind("click",n);}if(b){this._rowOptionsButtons[b]=h;}}this._rowOptionsElement=c.appendTo(m).bind("mousemove",function(){q._rowOptionsTargetRow=q._rowOptionsHoverRow;});}else{this._rowOptionsElement=undefined;}},_showRowOptionsForTargetRow:function(){if(this._rowOptionsTargetRow===undefined){this._hideRowOptions();}else{if(this._rowOptionsTargetRow!==this._rowOptionsHoverRow){this._showRowOptionsForRow(this._rowOptionsTargetRow);}else{this._rowOptionsTargetRow=undefined;}}},disableStandartRowOptions:function(b){this._rowOptionsDisableStandart=b===undefined?true:b;},_rowOptionsButtonCallback:function(c){var d,b=this;if(typeof(c[2])==="function"){d=this._rowOptionsCallbackWrapper(c[2]);}else{d=function(e){if(e&&e.stopPropagation){e.stopPropagation();}b.setActiveRow(b._rowOptionsHoverRow);b._actions[c[2]](b._rowOptionsHoverRow,true,e);};}return d;},_rowOptionsCallbackWrapper:function(c){var b=this;return function(d){if(d&&d.stopPropagation){d.stopPropagation();}b.setActiveRow(b._rowOptionsHoverRow);c.apply(b,[b._rowOptionsHoverRecord,b._rowOptionsHoverRow,arguments[2]||this]);};},_createRowOptionsSubMenu:function(b,c){},_createRowOptionsMenu:function(b){var d=this._rowOptionsDefault,m=[],j=$ws._const.wsRoot+($ws._const.theme?"img/themes/"+$ws._const.theme+"/browser/":"img/browser/"),l=this,g=false;this._rowOptionsMenu=true;for(var f=0,h=d.length;f<h;++f){if(d[f][0]){var k=this._rowOptionsButtonCallback(d[f]),c=function(o,n,i){if(!i.subMenu){o();}}.bind(this,k),e={caption:d[f][0],id:l.getId()+"_"+(d[f][3]||d[f][2]),imgSrc:this._calculateImagePath(j,d[f][1]),handlers:{onActivated:c}};this._createRowOptionsSubMenu(d[f][2],e);m.push(e);g=false;}else{if(m.length){m.push({caption:""});g=true;}}}if(g){m.pop();}$ws.core.attachInstance("Control/Menu",{data:m,handlers:{onReady:function(){l._rowOptionsMenu=this;l._rowOptionsCurrentMenu=this;l._applyRowOptions();this.show(b);},onClose:function(i,n){if(n===0){l._rowOptionsMenuVisible=false;l._showRowOptionsForTargetRow();}},onMouseEnter:function(){l._rowOptionsStopLeaveTimer();},onMouseLeave:function(){l._rowOptionsStartLeaveTimer();}}}).addCallback(function(i){l._rowOptionsMenu=i;});},_updateRowOptions:function(b){var e=[];for(var d=0;d<this._rowOptionsDefault.length;++d){var c=this._rowOptionsDefault[d][3]||this._rowOptionsDefault[d][2];if(b.hasOwnProperty(c)&&this._rowOptions.hasOwnProperty(c)){if(b[c]["title"]!=this._rowOptions[c]["title"]){if(this._rowOptionsButtons[c]){this._rowOptionsButtons[c].attr("title",this._rowOptions[c]["title"]);}if(this._rowOptionsMenu){this._rowOptionsMenu.setItemText(this.getId()+"_"+c,this._rowOptions[c]["title"]);}this._rowOptionsDefault[d][0]=this._rowOptions[c]["title"];}if(b[c]["icon"]!=this._rowOptions[c]["icon"]){if(this._rowOptionsButtons[c]){$ws.helpers.makeBackground(this._rowOptionsButtons[c].find(".ws-browser-row-option"),this._rowOptions[c]["icon"]);}if(this._rowOptionsMenu){this._rowOptionsMenu.setItemIcon(this.getId()+"_"+c,this._rowOptions[c]["icon"]);}this._rowOptionsDefault[d][1]=this._rowOptions[c]["icon"];}if(b[c]["callback"]!=this._rowOptions[c]["callback"]){var f=this._rowOptionsCallbackWrapper(this._rowOptions[c]["callback"]);if(this._rowOptionsButtons[c]){this._rowOptionsButtons[c].unbind("click");this._rowOptionsButtons[c].bind("click",f);}if(this._rowOptionsMenu){this._rowOptionsMenu.setItemClickHandler(this.getId()+"_"+c,f);}this._rowOptionsDefault[d][2]=this._rowOptions[c]["callback"];}}else{if(b.hasOwnProperty(c)){e.push(c);}}}for(d in this._rowOptions){if(this._rowOptions.hasOwnProperty(d)&&!b.hasOwnProperty(d)){this.addRowOption(this._rowOptions[d]);}}return e;},_applyRowOptions:function(){var e=0,k=this._rowOptions;for(var d in k){if(k.hasOwnProperty(d)){++e;}}var h=(e>=$ws._const.Browser.rowOptionsOverflow)&&(this._mainRowOptionsCount<e),c=this._rowOptionsDefault;if(this._rowOptionsMenuButton){this._rowOptionsMenuButton.css("display",h?"inline-block":"none");}for(d=0;d<c.length;++d){var f=c[d],b=f[3]||f[2],g=k[b]&&!h,j=this._rowOptionsButtons[b].hasClass("ws-browser-main-row-option");this._rowOptionsButtons[b].css("display",g||(j&&k[b])?"inline-block":"none");if(this._rowOptionsMenu){this._rowOptionsMenu[k[b]&&!j?"showItem":"hideItem"](this.getId()+"_"+b);}}this._hasRowOptions=e>0;},zebraBody:function(c){var b=this._body.find("tr");b.removeClass("rE");this._data.toggleClass("ws-browser-hasZebra",!!c);this._options.display.hasZebra=c;if(c){b.filter(":even").addClass("rE");}this._updateSelection();},setTextHighlight:function(f,c){this._highlight=f.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");if(f&&c){var e=this._body.find(".ws-browser-text-no-render");for(var d=0,b=e.length;d<b;++d){this._highlightNode($(e[d]));}}},_highlightNode:function(b){if(b.attr("highlight")===this._highlight){return;}b.attr("highlight",this._highlight);b.html(this._highlightData(b.text()));},_addRowOption:function(g){var m=this._rowOptionsButtonCallback(g),c="",l=$ws._const.wsRoot+($ws._const.theme?"img/themes/"+$ws._const.theme+"/browser/":"img/browser/");if(typeof(g[2])==="string"){c=g[2];}else{if(g[3]){c=g[3];}}for(var f=0;f<this._rowOptionsDefault.length;++f){if(c===(this._rowOptionsDefault[f][3]||this._rowOptionsDefault[f][2])){return;}}this._createRowOptions();if(this._rowOptionsElement){var n=this._calculateImagePath(l,g[1]),e=$('<span class="ws-browser-row-option">'+(g[5]?g[0]:"")+"</span>"),h=$('<span class="ws-browser-row-option-border" title="'+g[0]+'"></span>').append(e).mousedown(function(i){i.stopPropagation();i.preventDefault();});if(this._isMainRowOption(c,g[6])){h.addClass("ws-browser-main-row-option");var j=false,d;for(d in this._options.display.mainRowOptions){if(d===c){j=true;break;}}if(!j){this._mainRowOptionsCount++;}}if(g[5]){e.addClass("asLink ws-browser-row-option-as-link");h.addClass("ws-browser-row-option-border-as-link");}else{this._applyRowOptionItem(e,l,g[1]);}if(g[4]===$ws._const.Browser.rowOptionBeforeAll){h.prependTo(this._rowOptionsElement.find(".ws-browser-row-options-container"));}else{if(g[4]){h.insertBefore(this._rowOptionsButtons[g[4]]);}else{h.appendTo(this._rowOptionsElement.find(".ws-browser-row-options-container"));}}if(m){h.bind("click",m);}if(c){this._rowOptionsButtons[c]=h;}if(this._rowOptionsMenu instanceof Object){var b={imgSrc:n,id:this.getId()+"_"+c,caption:g[0],handlers:{onActivated:m}};if(g[4]===$ws._const.Browser.rowOptionBeforeAll){this._rowOptionsMenu.insertItem(b,$ws._const.Menu.insertItemBeforeAll);}else{if(g[4]!==undefined){this._rowOptionsMenu.insertItem(b,this.getId()+"_"+g[4]);}else{this._rowOptionsMenu.addItem(b);}}}}if(g[4]===$ws._const.Browser.rowOptionBeforeAll){this._rowOptionsDefault.unshift(g);}else{if(g[4]){for(f=0;f<this._rowOptionsDefault.length;++f){var k=this._rowOptionsDefault[f];if((k[3]||k[2])==g[4]){this._rowOptionsDefault.splice(f,0,g);break;}}}else{this._rowOptionsDefault.push(g);}}},addRowOption:function(b){this._addRowOption([b.title,b.icon,b.callback,b.name,b.before,b.linkText,b.isMainOption]);},addRowOptions:function(c){var e=[];for(var d=0,b=c.length;d<b;++d){if(c[d] instanceof Array){e=c[d];}else{if(c[d] instanceof Object){e.push(c[d]["title"],c[d]["icon"],c[d]["callback"],c[d]["name"],c[d]["before"],c[d]["linkText"],c[d]["isMainOption"]);}}this._addRowOption(e);e=[];}},_getRowOptions:function(){var b=[];b.push([this._options.display.readOnly?"Просмотреть (F3)":"Редактировать (F3)","sprite:icon-16 icon-Edit icon-primary","edit","edit"]);b.push(["Удалить","sprite:icon-16 icon-Erase icon-error","delete","delete"]);return b;},_initRowOptionsDefaults:function(){this._rowOptionsDefault=this._getRowOptions();},setActiveRow:function(b){this.setActiveElement(b);},getActiveRow:function(){return this.getActiveElement();},setColumns:function(e){var c=this,f=[];for(var d=0,b=e.length;d<b;d++){if(e[d]!==undefined){e[d].title=e[d].title.replace(/\\\.|\\/g,function(g){if(g.length==2){return".";}else{return g+g;}});f.push(e[d]);}}this._dReady.addCallback(function(){c._options.display.columns=f;c._columnMap=[];c._colgroupCache=undefined;c._mapColumns();c.refresh(true);});},getColumns:function(){return this._options.display.columns||(this._currentRecordSet&&this._currentRecordSet.getColumns());},setEnabled:function(b){b=!!b;if(this._options.allowChangeEnable||b===this._options.enable){$ws.proto.TableView.superclass.setEnabled.apply(this,arguments);if(this._options.display.rowOptions){if(!b){this._hideRowOptions();this._uninitRowOptions();}else{this._initRowOptions();}}}},setRowRender:function(b){this._options.display.rowRender=b;},setColumnRender:function(c,f){for(var d=0,b=this._options.display.columns.length;d<b;++d){var e=this._options.display.columns[d];if(e.title===c){e.render=f;break;}}},destroy:function(){if(this._rowOptionsMenu){this._rowOptionsMenu.destroy();}$ws.proto.TableView.superclass.destroy.apply(this,arguments);},setReadOnly:function(b){if(this._options.display.readOnly!=!!b&&this._options.display.rowOptions){for(var c=0;c<this._rowOptionsDefault.length;++c){if(this._rowOptionsDefault[c][2]==="edit"){this._rowOptionsDefault[c][0]=(b?"Просмотреть (F3)":"Редактировать (F3)");break;}}}$ws.proto.TableView.superclass.setReadOnly.apply(this,arguments);},_updateAfterRecordsDelete:function(b){$ws.proto.TableView.superclass._updateAfterRecordsDelete.apply(this,arguments);if(!this._options.display.reload){for(var d=0;d<b.length;++d){var c=b[d].getKey();if(this._haveRow(c)){this._findRow(c).remove();this._rowsMap[c]=undefined;}}this.setActiveRow(this._activeElement);}},_redraw:function(){}});return $ws.proto.TableView;});