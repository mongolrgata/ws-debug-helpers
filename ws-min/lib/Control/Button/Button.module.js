$ws.declareModule({namespace:"SBIS3.CORE",name:"Button",imports:["SBIS3.CORE.Control"]},function(a){var b=32;var g=6;var c=9;var d=185;var i=15;var j=-16;var f=0;var e=-1;var h=0;$ws.proto.Button=a.DataBoundControl.extend({$protected:{_inputControl:null,_keysWeHandle:[$ws._const.key.enter,$ws._const.key.space],_options:{name:"",menuName:"",caption:"","float":"left",height:"",width:"",img:"",imgAlign:"undertext",margin:"",press:false,isDefault:false,textAlign:"",openLink:"",cssClassName:"ws-field-button"},_pressed:false,_hasProcess:false,_isSpriteImage:false,_text:undefined,_textContainer:undefined,_menuInitialized:false,_defaultPlace:true,_clickHandler:null,_dummy:undefined,_menuShowed:false,_menuContent:undefined,_menuControl:undefined,_menuOpenHandler:undefined,_menuCloseHandler:undefined,_menuToggleHandler:undefined},$constructor:function(){this._publish("onActivated");if(this._isCorrectContainer()){if($.browser.opera||($.browser.msie&&($.browser.version==="8.0"))){this._container.addClass("ws-field-button-badbro");}else{if($.browser.msie&&($.browser.version==="7.0")){this._container.addClass("ws-field-button-ie7");}}this._container.attr("tabindex",-1).css({"float":this._options["float"],margin:this._options.margin}).toggleClass("ws-without-caption",!this._options.caption.length).toggleClass("ws-field-button-with-img",this._options.img!=="");}var k=this;this._container.delegate(".ws-field-button-element","mousedown mouseup mouseleave",function(l){if(!k._menuShowed){$(this).toggleClass("ws-field-button-element-active",l.type=="mousedown");}});this._clickHandler=function(){if(this.isEnabled()){this._activate();}return false;}.bind(this);this._container.addClass("ws-no-select").attr("unselectable","on").bind("selectstart",false);this._redraw(true);},setDefault:function(k){if(k===undefined){k=true;}if(this._options.isDefault!==k){this._inputControl.toggleClass("ws-default-button",k);if(k){this._registerDefaultButton();}else{this._unregisterDefaultButton();}this._options.isDefault=k;}},_unregisterDefaultButton:function(){var k=this.getParent();if(k&&k.unregisterDefaultButton){k.unregisterDefaultButton(this);}},_registerDefaultButton:function(){var k=this.getParent();if(k&&k.registerDefaultButton){k.registerDefaultButton(this);}},_getMenuContent:function(k){return k.getContainer().Menu.$eUL;},_getMenuDiv:function(k){return this._getMenuContent(k).parent();},_prepareMenuHeader:function(k){k.addClass("ws-button-menu");k.prepend('<div class="ws-button-menu-header"><div class="ws-button-menu-header-left"></div><div class="ws-button-menu-header-right"></div><div class="ws-button-menu-header-center"></div><div class="ws-button-menu-header-content"></div></div>');},_createDummy:function(){if(!this._dummy){this._dummy=this._container.clone(true).addClass("ws-button-dummy");}},_updateMenuClasses:function(n){for(var m=0,k=n.subMenus.length;m<k;++m){var l=n.subMenus[m];l.$eUL.toggleClass("ws-button-menu-content",this._menuShowed);this._updateMenuClasses(l);}},_onMenuOpen:function(){if(this._menuShowed){if(!this._container.hasClass("ws-button-in-menu")){var k=Math.max(d,this._container.width()+i),m,l;this._menuContent.css("min-width",k);if(this._options.renderStyle==="classic"){m=this._menuContent.parent();this._prepareMenuHeader(m);l=m.find(".ws-button-menu-header-content");this._menuContent.addClass("ws-button-menu-content").append('<div class="ws-button-menu-shadow"></div>');this._createDummy();this._container.find(".ws-field-button-element").addClass("ws-field-button-element-active");this._dummy.insertAfter(this._container);this._container.addClass("ws-button-in-menu");this._container.appendTo(l);}}else{if(this._options.renderStyle==="classic"){this._updateMenuClasses(this._menuControl.getContainer().Menu);}}}},_onCloseMenu:function(k,l){if(l===0&&this._menuShowed){this._menuShowed=false;$ws._const.$win.unbind("scroll.button"+this.getId());if(this._options.renderStyle==="classic"){this._container.removeClass("ws-button-in-menu");this._container.find(".ws-field-button-element-active").removeClass("ws-field-button-element-active");this._container.insertAfter(this._dummy);this._dummy.detach();this._menuContent.removeClass("ws-button-menu-content").parent().find(".ws-button-menu-shadow, .ws-button-menu-header").remove();this._updateMenuClasses(this._menuControl.getContainer().Menu);}}},_prepareMenu:function(k){this._menuControl=k;this._menuContent=this._getMenuContent(k);k.subscribe("onOpen",this._menuOpenHandler=this._onMenuOpen.bind(this));k.subscribe("onClose",this._menuCloseHandler=this._onCloseMenu.bind(this));return k;},_initMenu:function(){if(this._menuInitialized){return;}this._menuInitialized=true;this.subscribe("onActivated",this._menuToggleHandler=function(){this._toggleSubMenu();}.bind(this));this.getContainer().attr("data-menu-id",this._options.menuName);$ws.single.ControlStorage.waitChild(this._options.menuName).addCallback(this._prepareMenu.bind(this));},_setContainerClick:function(k){if(k){this._container.bind("mouseup",this._clickHandler);}else{this._container.unbind("mouseup",this._clickHandler);}this._container.toggleClass("ws-btn-container-click",k);},_bindInternals:function(){if(this._options.renderStyle==="asLink"){this._inputControl=this._container.find(".ws-field-button-link");this._textContainer=this._inputControl;}else{this._inputControl=this._container.find(".ws-input-control-element");this._textContainer=this._container.find(".ws-button-text-element");}},_getMarkupTemplate:function(){return"{{? it.renderStyle == 'asLink' }}<a class='ws-field-button-link btn asLink {{? !it.caption}}ws-btn-container-click {{?}}{{? it.isDefault }}ws-default-button{{?}}' {{? it.tooltip }}title='{{=it.tooltip}}'{{?}} {{? it.openLink }}href='{{=it.openLink}}'{{?}}><span class='ws-link-btn-caption'>{{!it.caption}}</span></a>{{??}}<div title='{{=it.tooltip}}' class='ws-input-control-element ws-field-button-element btn {{=it.renderStyle}} {{? it.isDefault }}ws-default-button{{?}}'><div class='ws-field-button-medium ws-field-button-text-classic ws-field-button-text{{? it.menuName }} ws-field-button-medium-menu{{?}}'><div class='ws-field-button-left'></div><div class='ws-field-button-right{{? it.menuName }} ws-button-right-menu{{?}}'></div><div class='ws-button-text-element ws-field-button-text-container-classic'>{{!it.caption}}</div></div></div>{{?}}";},_createMarkup:function(k){return this._extendMarkup(k,this._getMarkupTemplate());},_redraw:function(k){if((k&&!this._hasMarkup())||!k){if(!$ws.proto.Button.__markupTemplate){$ws.proto.Button.__markupTemplate=doT.template(this._getMarkupTemplate());}this._container.html($ws.proto.Button.__markupTemplate(this._options));}this._bindInternals();this._applyImageChange();this._bindClick();this.setEnabled(this._options.enable);if(this._options.isDefault){this._registerDefaultButton();}if(this._options.menuName){this._initMenu();}},_bindClick:function(){var k=this;this._inputControl.click(function(l){if(k.isEnabled()){k._container.click();k._activate();}l.stopPropagation();l.stopImmediatePropagation();l.preventDefault();return false;});},canAcceptFocus:function(){if(this.getName()==="windowTitleClose"){return false;}else{return $ws.proto.Button.superclass.canAcceptFocus.apply(this,arguments);}},_keyboardHover:function(k){if(this.isEnabled()&&(k.which==$ws._const.key.enter||k.which==$ws._const.key.space)){this._activate();k.stopImmediatePropagation();return false;}return true;},_toggleProcess:function(k){this._hasProcess=k;this.setEnabled(!k);this._applyImageChange();},_activate:function(){this.togglePress();var k=this._notify("onActivated",this._pressed);if(k instanceof $ws.proto.Deferred){this._toggleProcess(true);k.addBoth(this._toggleProcess.bind(this,false));}},togglePress:function(k){if(this._options.press){this._pressed=k!==undefined?!!k:!this._pressed;this._inputControl.toggleClass("ws-button-pressed",this._pressed);if(this._isSpriteImage&&this._options.img){this._applyImageChange();}}},isPressed:function(){return this._pressed;},_onContextValueReceived:function(k){if(k){this.setCaption(k);}},_applyImageChange:function(){var r,p,s,q,o,m,l;if(this._hasProcess){l=$ws.helpers.processImagePath("ws:/button/process.gif");}else{l=this._options.img;}this._isSpriteImage=(l.indexOf("sprite:")!==-1);m=this._isSpriteImage?"div":"img";r=this._inputControl.find(".ws-button-image");p=this._inputControl.find(".ws-field-button-image-wrapper");if(l!==""){this._setContainerClick(false);if(r.length){if(r.get(0).nodeName.toLowerCase()!=m){r.empty().remove().length=0;p.empty().remove().length=0;}}}this._container.toggleClass("ws-btn-with-img",!!l);if(r.length===0||p.length===0){if(l!==""){r=$("<"+m+"/>",{"class":"ws-button-image"});if(this._options.renderStyle==="asLink"){r=r.prependTo(this._textContainer);}else{this._textContainer.before(r);}p=$("<"+(this._options.textAlign?"span":"div")+"/>",{"class":"ws-field-button-image-wrapper"});r.wrap(p);p=this._container.find(".ws-field-button-image-wrapper");}}else{if(l===""){p.remove();return;}}p.toggleClass("imgOnly",!this._options.caption);this._container.toggleClass("ws-btn-imgOnly",!this._options.caption);if(this._isSpriteImage){s=l.indexOf("sprite:");var n=r.data("current-sprite-class");if(n){r.removeClass(n);}var k=l.substr(s+"sprite:".length).replace(/_/g," ");if(this._pressed){k=k.replace("icon-primary","icon-error");}r.addClass(k);r.data("current-sprite-class",k);}else{r.attr("src",$ws.helpers.processImagePath(l));}if(!l||this._options.imgAlign=="undertext"){q=o=false;}else{if(this._options.imgAlign!=="undertext"){q=this._options.imgAlign==="left";o=!q;}}p.toggleClass("left",q).toggleClass("right",o);if(this._text){this._text.toggleClass("imgLeft",q).toggleClass("imgRight",o);}if(!this._options.textAlign){p.css("float",this._options.imgAlign&&this._options.imgAlign!="undertext"?this._options.imgAlign:"none");}},setImage:function(k){this._options.img=k;this._applyImageChange();this._container.toggleClass("ws-field-button-with-img",!!k);},hasImage:function(){return !!this._options.img;},setImageAlign:function(k){this._options.imgAlign=k;this._applyImageChange();},setCaption:function(k){if(k===undefined||k===null||k===false){k="";}else{if(typeof(k)!=="string"){k=k+"";}}if(k!==""){this._setContainerClick(false);}else{if(!this._container.hasClass("ws-btn-container-click")&&this._options.img===""){this._setContainerClick(true);}}if(this._options.renderStyle==="asLink"){this._container.find(".ws-link-btn-caption").text(k);}else{this._container.find(".ws-field-button-text-container-classic").text(k);}this._container.toggleClass("ws-without-caption",!k.length);this._options.caption=k;if(k){this._inputControl.find(".ws-field-button-image-wrapper").removeClass("imgOnly");this._container.removeClass("ws-btn-imgOnly");}},getCaption:function(){return this._options.caption;},setEnabled:function(k){if(this._options.allowChangeEnable||k===this._options.enable){if(this.getName()!=="windowTitleClose"){if(k===false){this._inputControl.attr("disabled","disabled");}else{this._inputControl.removeAttr("disabled");}$ws.proto.Button.superclass.setEnabled.apply(this,arguments);}}},_getOffsetContainer:function(){if(this._dummy&&this._dummy.closest("html").size()){return this._dummy;}return this._container;},_getMenuOffset:function(){var o=this._getOffsetContainer().offset(),n=this._menuContent.parent(),l=n.width(),k=$ws._const.$win.width(),m;if(this._options.renderStyle==="asLink"){o.top+=this._height+g;}else{o.top+=b;}o.left+=c;m=o.left+l>k&&l<k;if(m){o.left+=this.getContainer().width()-l;if(this._options.renderStyle==="asLink"){o.top+=h;o.left+=e;}else{o.top+=f;o.left+=j;}}n.toggleClass("ws-button-menu-header-toright",m);return o;},_toggleSubMenu:function(){var k=this.getContainer();if(!this._height){this._height=k.height();}if(!this._width){this._width=k.width()-1;}if(!this._menuShowed){this._menuShowed=true;}$ws._const.$win.unbind("scroll.button"+this.getId());$ws._const.$win.bind("scroll.button"+this.getId(),function(){this._menuControl.getContainer().Menu.setPosition({},true,this._getMenuOffset());}.bind(this));$ws.single.ControlStorage.waitChild(this._options.menuName).addCallback(function(l){l.show({},this._getMenuOffset());return l;}.bind(this));},destroy:function(){if(this._dummy){this._dummy.remove();}$ws._const.$win.unbind("scroll.button"+this.getId());$ws.proto.Button.superclass.destroy.apply(this,arguments);},setMenu:function(k){if(this._menuControl){this._menuControl.unsubscribe("onOpen",this._menuOpenHandler);this._menuControl.unsubscribe("onClose",this._menuCloseHandler);}if(this._menuInitialized){this.unsubscribe("onActivated",this._menuToggleHandler);}this._menuInitialized=false;this._menuContent=undefined;this._menuControl=undefined;this._options.menuName=k;this._container.removeAttr("data-menu-id");if(this._options.renderStyle==="classic"){this._container.find(".ws-field-button-medium").toggleClass("ws-field-button-medium-menu",!!k);this._container.find(".ws-field-button-right").toggleClass("ws-button-right-menu",!!k);}if(k){this._initMenu();}}});return $ws.proto.Button;});