$ws.declareModule({namespace:"SBIS3.CORE",name:"FilterButton",imports:["SBIS3.CORE.Control"]},function(a){$ws._const.FilterButton={defaultText:"Нужно отобрать?",buttonsWidth:71};$ws.proto.FilterButton=a.Control.extend({$protected:{_options:{template:"",browserId:undefined,singleFilterItem:undefined,filterLine:undefined,sendDefault:false},_button:undefined,_text:undefined,_floatAreaDeferred:undefined,_floatArea:undefined,_clearButton:undefined,_handlerArea:undefined,_filter:{},_defaultValues:{},_filterChangeHandler:undefined,_destroyHandler:undefined,_browserDeferred:undefined,_browser:undefined,_areaContext:undefined,_filterSetted:false,_controlChangedValues:0,_changedControlsMap:{},_nonValidatedControls:0,_buttonApply:undefined,_buttonClear:undefined,_keysWeHandle:[$ws._const.key.space,$ws._const.key.enter]},$constructor:function(){this._configChecking();this._publishEvents();this._createContainer();this._initEvents();this._declareCommands();this._initFilterChangeHandler();this._initBrowser();},_configChecking:function(){if(this._options.singleFilterItem&&typeof this._options.singleFilterItem!=="function"){$ws.single.ioc.resolve("ILogger").error("FilterButton","Incorrect _options.singleFilterItem");}if(this._options.filterLine&&typeof this._options.filterLine!=="function"){$ws.single.ioc.resolve("ILogger").error("FilterButton","Incorrect _options.filterLine");}},_publishEvents:function(){this._publish("onBeforeShow","onRestoreFilter","onDrawLine","onResetFilter","onSetQuery");},_createContainer:function(){this._container.addClass("ws-filter-button clearfix");if(!this._hasMarkup()){if(!$ws.proto.FilterButton.__markupTemplate){$ws.proto.FilterButton.__markupTemplate=doT.template(this._getMarkupTemplate());}this._container.html($ws.proto.FilterButton.__markupTemplate(this._options));}this._button=this._container.find(".ws-filter-button-block");this._text=this._container.find(".ws-filter-button-text");this._clearButton=this._container.find(".ws-filter-button-clear");this._handlerArea=this._container.find(".ws-filter-button-handler-area");},_initEvents:function(){this._button.bind("click",$.proxy(this.toggleFloatArea,this));this._text.bind("click",$.proxy(this.toggleFloatArea,this));this._clearButton.bind("click",$.proxy(this.resetFilter,this));},_declareCommands:function(){$ws.single.CommandDispatcher.declareCommand(this,"show",this.showFloatArea);$ws.single.CommandDispatcher.declareCommand(this,"hide",this.hideFloatArea);$ws.single.CommandDispatcher.declareCommand(this,"toggle",this.toggleFloatArea);$ws.single.CommandDispatcher.declareCommand(this,"resetFilter",this.resetFilter);$ws.single.CommandDispatcher.declareCommand(this,"applyFilter",this.applyFilter);},_initFilterChangeHandler:function(){var b=this;this._filterChangeHandler=function(d,c){b._changeFilter($ws.core.merge({},c));};this._destroyHandler=function(){b._clearBrowser();};},_initBrowser:function(){if(this._options.browserId){var b=this;this._browserDeferred=new $ws.proto.Deferred();$ws.single.ControlStorage.waitChild(this._options.browserId).addCallback(function(c){if(!b._browserDeferred.isReady()){b._browserDeferred.errback();}b.setBrowser(c);return c;});}},_changeFilter:function(c){var b=this;if(!this._filterSetted){this._filter=c;if(!this._floatAreaDeferred){this._createFloatArea().addCallback(function(d){d.hide();return d;});}this._floatAreaDeferred.addCallback(function(e){b._setControlsValues(c);var d={},f={};c={};b._getFilters(c,d,f).addCallback(function(){b._applyFilter(c,d,f);});return e;});}else{this._filterSetted=false;}},_getMarkupTemplate:function(){return'<span class="ws-filter-button-clear" title="Очистить фильтр"></span><span class="ws-filter-button-handler-area"></span><span class="ws-filter-button-text">'+$ws._const.FilterButton.defaultText+'</span><span class="ws-filter-button-block"></span>';},_createFloatArea:function(){var b=this;this._areaContext=new $ws.proto.Context();if(this._browser){this._areaContext.setPrevious(this._browser.getLinkedContext());}this._floatAreaDeferred=new $ws.proto.Deferred();return $ws.core.attachInstance("SBIS3.CORE.FilterFloatArea",{autoWidth:true,autoHeight:true,name:this.getName()+"-area",template:"filterButton",target:this._container,side:"right",parent:this.getParent(),filterArea:true,context:this._areaContext,handlers:{onReady:function(){b._floatArea=this;b._initButtons();this.getChildControlByName("filtersTemplate").setTemplate(b._options.template).addCallback(b._initTemplatedArea.bind(b));},onBeforeShow:function(){if(b._floatAreaDeferred&&b._floatAreaDeferred.isReady()){b._notify("onBeforeShow");}},onDestroy:function(){b._floatArea=undefined;b._floatAreaDeferred=undefined;}}});},_useFloatArea:function(c){var b=this;if(this._floatAreaDeferred){this._floatAreaDeferred.addCallback(function(d){if(b._filter){b._setControlsValues(b._filter);}d[c]();return d;});}else{this._createFloatArea();}},showFloatArea:function(){this._useFloatArea("show");return true;},hideFloatArea:function(){(this._floatAreaDeferred||this._createFloatArea()).addCallback(function(b){b.hide();return b;});return true;},toggleFloatArea:function(){this._useFloatArea("toggle");return true;},_initControls:function(){var c=this._floatArea.getChildControls(),b=this;for(var d=0;d<c.length;++d){var e=c[d];if(this._filterControl(e)){e.subscribe("onChange",function(){b._controlValueChange(this);});if(e.hasEvent("onValidate")){e.subscribe("onValidate",function(h,f,i,g){b._controlValidationChange(this,f,g);});}}}},_controlDefaultValue:function(c,b){return c.getDefaultValue?c.getDefaultValue():this._defaultValues[b];},_controlValueChange:function(c){var b=c.getName();if(this._isValueEqual(this._controlDefaultValue(c,b),c.getValue())){if(this._changedControlsMap[b]){this._changedControlsMap[b]=false;if(--this._controlChangedValues===0){this._toggleButtonsState();}}}else{if(!this._changedControlsMap[b]){this._changedControlsMap[b]=true;if(++this._controlChangedValues===1){this._toggleButtonsState();}}}},_toggleApplyButton:function(){this._buttonApply.setEnabled(this._nonValidatedControls===0);},_toggleClearButton:function(b){this._buttonClear.setEnabled(b);},_toggleButtonsState:function(){this._toggleApplyButton();this._toggleClearButton(!!this._controlChangedValues);},_controlValidationChange:function(d,b,c){if(b!==c){if(b){--this._nonValidatedControls;}else{++this._nonValidatedControls;}this._toggleApplyButton();}},_initButtons:function(){this._buttonApply=this._floatArea.getChildControlByName("applyFilter");this._buttonClear=this._floatArea.getChildControlByName("resetFilter");this._buttonApply.subscribe("onActivated",$.proxy(this._applyFilterAndClose,this));this._buttonClear.subscribe("onActivated",$.proxy(this._clearControlsValues,this));},_initTemplatedArea:function(){var b=this;this._getFilter(true).addCallback(function(c){b._defaultValues=c;b._initControls();b._floatAreaDeferred.callback(b._floatArea);if(b._floatArea.isOpened()){b._notify("onBeforeShow");}});},_setControlsValues:function(d,e){var r=this._floatArea.getChildControls(),b={},j,c,p,k,m,l,h,s,f;this._changedControlsMap={};this._controlChangedValues=0;for(k=0,m=r.length;k<m;++k){j=r[k];if(this._filterControl(j,true)&&(j.isEnabled()||!e)){c=j.getName();s=j.isSubControl();if(s){if($ws.proto.FieldCheckbox&&j instanceof $ws.proto.FieldCheckbox){b[c]=j.getDefaultValue();}else{if(!$ws.proto.FieldDate||!(j instanceof $ws.proto.FieldDate)){b[c]="";}}}else{var n=this._controlDefaultValue(j,c);if($ws.proto.DateRange&&j instanceof $ws.proto.DateRange){l=j.getDateFromName();h=j.getDateToName();if(d[l]!==undefined&&d[h]!==undefined){p=[d[l],d[h]];if(typeof(p[0])==="string"){p[0]=Date.fromSQL(p[0]);}if(typeof(p[1])==="string"){p[1]=Date.fromSQL(p[1]);}}else{p=n;}b[l]=p[0];b[h]=p[1];}else{if(SBIS3.CORE.GroupCheckBox&&j instanceof SBIS3.CORE.GroupCheckBox&&!(d[c] instanceof $ws.proto.Record)&&d[c] instanceof Object){p=n.cloneRecord();var g=d[c];for(var o in g){if(g.hasOwnProperty(o)&&p.hasColumn(o)){p.set(o,g[o]);}}b[c]=p;}else{if($ws.proto.FieldRadio&&j instanceof $ws.proto.FieldRadio&&!(d[c] instanceof $ws.proto.Enum)&&typeof(d[c])==="string"){b[c]=p=n.clone();p.set(d[c]);}else{p=d[c]!==undefined?d[c]:n;b[c]=p;}}}if(j.isEnabled()&&!this._isValueEqual(p,n)){this._changedControlsMap[c]=true;++this._controlChangedValues;}}}}var q=this._notify("onRestoreFilter",b);if(q&&q instanceof Object){b=q;}for(k=0,m=r.length;k<m;++k){j=r[k];if(this._filterControl(j,true)&&(j.isEnabled()||!e)){c=j.getName();f=false;if($ws.proto.DateRange&&j instanceof $ws.proto.DateRange){l=j.getDateFromName();h=j.getDateToName();p=[b[l],b[h]];if(b[l]!==undefined&&b[h]!==undefined&&!this._isValueEqual(p,j.getValue())){f=true;}}else{if(c in b){p=b[c];if(p instanceof $ws.proto.Enum){p=p.clone();}else{if(p instanceof $ws.proto.Record){p=p.cloneRecord();}}if(!this._isValueEqual(p,j.getValue())){if($ws.proto.FieldLink&&j instanceof $ws.proto.FieldLink){j.dropAllLinks(undefined,true);}f=true;}}}if(f){j.setValue(p,undefined,true);if(j.clearMark){j.clearMark();}}}}this._toggleButtonsState();},_clearControlsValues:function(){this._setControlsValues({},true);this._notifyOnReset();},_notifyOnReset:function(){var b=this._notify("onResetFilter");if(typeof(b)==="boolean"){this._toggleClearButton(true);}},_filterControl:function(c,b){return c&&c.getName&&c.getValue&&c.setValue&&(b&&!($ws.proto.FieldCheckbox&&c instanceof $ws.proto.FieldCheckbox)||!c.isSubControl());},_getFilter:function(h){var c={},f=new $ws.proto.ParallelDeferred(),e=this._floatArea.getChildControls(),d=function(k){if(!k.hasEvent("onInit")){return;}var i=k.getName();c[i]=(k.getDefaultValue&&h)?k.getDefaultValue():k.getValue();if($ws.proto.DateRange&&k instanceof $ws.proto.DateRange){c[k.getDateFromName()]=k.getRangeStart();c[k.getDateToName()]=k.getRangeEnd();}};for(var g=0,b=e.length;g<b;++g){var j=e[g];if(this._filterControl(j)){if(j.getValueDeferred){f.push(j.getValueDeferred().addBoth(d.bind(undefined,j)));}else{d(j);}}}return f.done().getResult().addCallback(function(){return c;});},_isSendDefaultValue:function(b){return this._options.sendDefault&&(($ws.proto.FieldDate&&b instanceof $ws.proto.FieldDate)||($ws.proto.DateRange&&b instanceof $ws.proto.DateRange)||($ws.proto.FieldLink&&b instanceof $ws.proto.FieldLink));},_getStringValueFromCheckboxGroup:function(d,f){var g=d.getValue();if(!g||!(g instanceof $ws.proto.Record)){return"";}var c=g.toObject(),b=f.toObject(),h=[],e=[];for(var i in c){if(c.hasOwnProperty(i)){if(c[i]!==b[i]){var j=d.getFlagCaption(i);if(c[i]&&c[i]!=="false"){h.push(j);}else{e.push(j);}}}}if(h.length||e.length){return(h.length?"Показывать: "+h.join(", "):"")+(h.length&&e.length?", ":"")+(e.length?"Не показывать: "+e.join(", "):"");}return"";},_getStringValueFromCheckbox:function(d){var c=d.getValue(),b=d.getCaption();if(c){return b;}return"Не "+b.charAt(0).toLowerCase()+b.substring(1);},_getStringValueFromSwitcher:function(c){var b=c.getValue();if(b){return c.getTextOn();}return c.getTextOff();},_getFilters:function(c,n,g){var j=this._floatArea.getChildControls(),h=new $ws.proto.ParallelDeferred(),l=new $ws.proto.ParallelDeferred(),m=this,k=function(t,r){if(!t.hasEvent("onInit")){return;}var s=t.getValue(),p=t.isSubControl(),i,o=m._controlDefaultValue(t,r);if((s!==undefined||($ws.proto.DateRange&&t instanceof $ws.proto.DateRange))&&(!m._isValueEqual(o,s)||m._isSendDefaultValue(t))){if(!p){if($ws.proto.FieldDate&&t instanceof $ws.proto.FieldDate){if(typeof s==="string"){s=Date.fromSQL(s);}i=s?$ws.render.defaultColumn.timestamp(s):"";}else{if(SBIS3.CORE.GroupCheckBox&&t instanceof SBIS3.CORE.GroupCheckBox){i=m._getStringValueFromCheckboxGroup(t,o);}else{if(SBIS3.CORE.FieldCheckbox&&t instanceof SBIS3.CORE.FieldCheckbox){i=m._getStringValueFromCheckbox(t);}else{if(SBIS3.CORE.Switcher&&t instanceof SBIS3.CORE.Switcher){i=m._getStringValueFromSwitcher(t);}else{if(t.getStringValue){i=t.getStringValue();}else{i=s;}}}}}if(m._options.singleFilterItem){i=m._options.singleFilterItem.apply(m,[r,s,o,i]);if(i instanceof $ws.proto.Deferred){(function(v,u){u.addCallback(function(w){n[v]=w;});})(r,i);l.push(i);}}if(i&&!(i instanceof $ws.proto.Deferred)){n[r]=i;}}if(i||(p&&SBIS3.CORE.FieldDate&&t instanceof SBIS3.CORE.FieldDate)){var q=(t.isEnabled()&&!m._isValueEqual(o,s))?c:g;if($ws.proto.DateRange&&t instanceof $ws.proto.DateRange){q[t.getDateFromName()]=t.getRangeStart();q[t.getDateToName()]=t.getRangeEnd();}else{q[r]=s;}}}};for(var e=0,f=j.length;e<f;++e){var d=j[e];if(this._filterControl(d)){var b=d.getName();if(d.getValueDeferred){h.push(d.getValueDeferred().addBoth(k.bind(undefined,d,b)));}else{k(d,b);}}}h.done().getResult().addCallback(function(){l.done();});return l.getResult();},_isValueEqual:function(c,b){if(c instanceof Date&&b instanceof Date){return c.getTime()===b.getTime();}if(typeof(c)==="string"&&b instanceof Date){return this._isValueEqual(Date.fromSQL(c),b);}if(typeof(b)==="string"&&c instanceof Date){return this._isValueEqual(c,Date.fromSQL(b));}if(c instanceof Array&&b instanceof Array){if(c.length!==b.length){return false;}for(var d=0;d<c.length;++d){if(!this._isValueEqual(c[d],b[d])){return false;}}return true;}if(c instanceof Object&&c.equals){return c.equals(b);}return c==b;},_getTextFromFilter:function(e,c){if(!Object.isEmpty(c)&&!Object.isEmpty(e)){var b="",f=false;for(var d in c){if(c.hasOwnProperty(d)&&c[d]){if(!e.hasOwnProperty(d)||e[d]!==undefined){if(f){b.append("<span>, </span>");}else{f=true;b=$("<span></span>");}if(typeof(c[d])==="string"){b.append("<span>"+$ws.helpers.escapeHtml(c[d])+"</span>");}else{b.append(c[d]);}}}}return b;}return"";},_setButtonText:function(c,e){var d;if(typeof(c)==="string"){d=c?c:"";}else{d=c.text();}this._handlerArea.css("display","none");this._text.attr("title",d).css("display","inline-block");if(!c){c=$ws._const.FilterButton.defaultText;}var b=this._notify("onDrawLine",c,e);if(typeof(b)==="boolean"){e=!b;}if(!e){this._clearButton.css("display","inline-block");this._text.css("max-width",this._container.width()-$ws._const.FilterButton.buttonsWidth);}else{this._clearButton.css("display","none");this._text.css("max-width","");}this._text.html(c);},_setButtonContainer:function(b,c){this._text.css("display","none").html("");this._handlerArea.css({display:"inline-block","max-width":this._container.width()-$ws._const.FilterButton.buttonsWidth}).html("").append(b);this._clearButton.css("display",c?"none":"inline-block");},_applyFilter:function(e,c,g){var f=Object.isEmpty(e)||Object.isEmpty(c),b=this._notify("onChange",$ws.core.merge(e,g),c),d=this;return $ws.helpers.callbackWrapper(b,function(i){var h=e;if(i!==false){if(i instanceof Object){h=i;}d._setLineData(h,c,f);}return h;});},_setLineData:function(f,c,h){var g,b,d=this,e=function(i){if(i instanceof Object&&("jquery" in i)){d._setButtonContainer(i,h);return;}else{if(typeof(i)==="string"){g=i;}else{g=d._getTextFromFilter(f,c);}}d._setButtonText(g,h);};if(this._options.filterLine){b=this._options.filterLine.apply(this,[f,c]);}$ws.helpers.callbackWrapper(b,e);},_setQuery:function(c){if(this._browserDeferred){var b=this;this._browserDeferred.addCallback(function(){b._filterSetted=true;var d,e=b._browser.getQuery(true),g=b._browser.getRecordSet().getHierarchyField();for(d in e){if(e.hasOwnProperty(d)&&!b._defaultValues.hasOwnProperty(d)){if(!c.hasOwnProperty(d)&&d!==g){c[d]=e[d];}}}var f=$.extend({},c);for(d in f){if(f.hasOwnProperty(d)){if(f[d] instanceof $ws.proto.Record){f[d]=f[d].toObject();}else{if(f[d] instanceof $ws.proto.Enum){f[d]=f[d].getCurrentValue();}}}}if(b._notify("onSetQuery",f)!==false){b._browser.setQuery(f);}});}},_rememberValues:function(){this._getFilter(false).addCallback(function(b){this._filter=b;}.bind(this));},resetFilter:function(){this._notifyOnReset();var e={},b={};this._getFilters({},b,e);for(var c in b){if(b.hasOwnProperty(c)&&!e.hasOwnProperty(c)){delete b[c];}}var d=this._applyFilter({},b,e);$ws.helpers.callbackWrapper(d,function(f){this._filter={};this._setQuery(f);return f;}.bind(this));return true;},applyFilter:function(){var b=this;if(!this._floatAreaDeferred){this._createFloatArea();}this._floatAreaDeferred.addCallback(function(e){var d={},c={},f={};b._getFilters(d,c,f).addCallback(function(){d=b._applyFilter(d,c,f);$ws.helpers.callbackWrapper(d,function(g){b._rememberValues();b._setQuery(g);return g;});});return e;});return true;},_applyFilterAndClose:function(){if(this._floatArea.validate()){this.applyFilter();if(this._floatArea){this._floatArea.hide();}}},_keyboardHover:function(){this.toggleFloatArea();},setBrowser:function(c){if(c!==this._browser){if(this._browserDeferred&&!this._browserDeferred.isReady()){this._browserDeferred.errback();}if(this._browser){this._clearBrowser();}if(c){var b=!!this._browser;this._browserDeferred=new $ws.proto.Deferred().callback();this._browser=c;this._filterSetted=false;c.subscribe("onFilterChange",this._filterChangeHandler);c.subscribe("onDestroy",this._destroyHandler);if(this._areaContext){this._areaContext.setPrevious(c.getLinkedContext());}if(c.recordSetReady().isReady()||b){var d=c.getQuery();this._changeFilter(d);}}}},_clearBrowser:function(){this._browser.unsubscribe("onFilterChange",this._filterChangeHandler);this._browser.unsubscribe("onDestroy",this._destroyHandler);this._browserDeferred=undefined;this._browser=undefined;},setTemplate:function(b){this._options.template=b;if(this._floatArea){var c=this;this._floatAreaDeferred.addCallback(function(){c._floatAreaDeferred=new $ws.proto.Deferred();c._floatArea.getChildControlByName("filtersTemplate").setTemplate(c._options.template).addCallback($.proxy(c._initTemplatedArea,c));});}},getFloatArea:function(){return this._floatArea;},getTemplateName:function(){return this._options.template;},getBrowser:function(){return this._browser;},_redraw:function(){}});return $ws.proto.FilterButton;});