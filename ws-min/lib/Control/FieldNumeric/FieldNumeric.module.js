$ws.declareModule({namespace:"SBIS3.CORE",name:"FieldNumeric",imports:["SBIS3.CORE.FieldString"]},function(a){$ws.proto.FieldNumeric=a.extend({$protected:{_emptyNegative:false,_options:{unlimitedDec:false,unlimitedInt:true,decimals:0,integers:16,defaultValueIsNull:false,hideEmptyDecimals:false,delimiters:true,notNegative:false,cssClassName:"ws-field-numeric"}},$constructor:function(){this._options.decimals=parseInt(this._options.decimals,10);this._options.integers=this._options.unlimitedInt?0:parseInt(this._options.integers,10);var b=this;this._inputControl.keypress(function(d){if(!b.isEnabled()){return true;}var c=d.which||d.keyCode;if(c&&!d.ctrlKey&&c>40||b._extractKey(d)==$ws._const.key.space||c<=40&&d.shiftKey){if(/[0-9]/.test(String.fromCharCode(c))){b._typing(d);}if(/\.|,/.test(String.fromCharCode(c))){if(d.which){b._pointFunc();}}if(d.which===0&&d.keyCode==45){return true;}if(/[\-]/.test(String.fromCharCode(c))){b._negativeValue();}return(!d.which&&(c==$ws._const.key.f5||c==$ws._const.key.f12||c==$ws._const.key.left||c==$ws._const.key.right||c==$ws._const.key.end||c==$ws._const.key.home));}return true;}).keydown(function(c){if(!b.isEnabled()){return true;}if(c.keyCode==$ws._const.key.backspace||c.keyCode==$ws._const.key.del&&!(c.ctrlKey&&c.shiftKey)){if(c.keyCode==$ws._const.key.del&&c.ctrlKey){c.preventDefault();}b._typing(c);return false;}return true;}).blur(function(){this.value=this.value.replace(/\.$/g,"");b._emptyNegative=false;b._isBluring=true;b._setValueInternal(b.getValue());});this.subscribe("onFocusIn",function(){if(b._options.hideEmptyDecimals){b._setValueInternal(b.getValue());}});},_getDefaultValue:function(){var d=this._options.value,c=this,b=function(e){if(e===""||e===null){return c._options.defaultValueIsNull?null:"0";}else{return e;}};if(typeof(d)==="function"){return b(d());}return b(d);},decimalsCount:function(b){this.setDecimalsCount(b);},setDecimalsCount:function(b){this._options.unlimitedDec=b<0;this._options.decimals=b>=0?b:0;this.setValue(this.getValue());},setIntegersCount:function(b){this._options.unlimitedInt=b<0;this._options.integers=b>=0?b:0;this.setValue(this.getValue());},getDecimalsCount:function(){return this._options.unlimitedDec?-1:this._options.decimals;},getIntegersCount:function(){return this._options.unlimitedInt?-1:this._options.integers;},_negativeValue:function(){if(!this._options.notNegative){var e=this.getValue(),d=!e,b=this._getCaret(),f=e?Math.max(b[0]+(e<0?-1:+1),0):b[0],c=e?b[1]+(e<0?-1:+1):b[1];if(d){this._emptyNegative=!this._emptyNegative;f=this._emptyNegative;c=f+1;}this.setValue(-e);if(d){this._inputControl.val((this._emptyNegative?"-":"")+this._inputControl.val());}this._setCaret(f,c);}},_typing:function(m){var u=m.which,d=m.keyCode,h=this,s=h._getCaret()[0],p=h._getCaret()[1],q=[],t,v=h._inputControl.get(0).value,f=String.fromCharCode(u),o=h._curValue(),k=o===""||o===null?(this._options.decimals?this._options.decimals+1:0):(h._curval+"").length,g=v.indexOf("."),j=/\-/.test(v)?1:0,r,i;if(g==-1){g=v.length;}i=g-v.substr(0,g).replace(new RegExp(" ","g"),"").length;if(d==$ws._const.key.backspace&&s==p&&s>0){--s;if(v.charAt(s)==" "){--s;--p;}}if(d==$ws._const.key.del&&s==p&&p<k){++p;if(v.charAt(s)==" "){++s;++p;}}if(s!=p){if(v.charAt(s)==" "){s++;}if(s!=p&&v.charAt(p-1)==" "){p--;}}if(s==p&&(this._options.decimals&&k==p&&k>this._options.decimals||this._options.integers&&this._options.integers+i+j<=g&&s<=g)){return;}q.push(v.substring(0,s));if(/[0-9]/.test(f)){q.push(f);}r=undefined;if(s!=p&&k-s>=(this._options.decimals+1)&&k-p<=this._options.decimals&&this._options.decimals!==0){r=true;}else{if(g!=-1&&s<=g&&p>g){r=false;}}if(r!==undefined){q.push(".");var c=p-(r?k-this._options.decimals:g+1),n;t=q.slice();if(r===true){q.push("000000000000".substr(0,c));}q.push(v.substr(p));t.push(v.substr(p));if(t.join("")==="."){n=".";}else{n=q.join("");}h._setValueInternal(n);g=h._curval.indexOf(".");if(g==-1){g=h._curval.length;}h._setCaret(g);return;}if(k-p<=this._options.decimals&&this._options.decimals!==0){q.push("000000000000".substr(0,p-s+(/[0-9]/.test(f)?-1:0)));}q.push(v.substring(k-p<=this._options.decimals&&s==p?p+1:p));v=q.join("");h._setValueInternal(v);h._inputControl.change();if(h._emptyNegative&&h.getValue()>0){h.setValue(-h.getValue());h._emptyNegative=false;}if(m.keyCode!=$ws._const.key.backspace){if(k-p<=this._options.decimals&&k>this._options.decimals){s++;p++;}}else{if(k-p==this._options.decimals-1){p--;}}h._caretPos(k-s,k-p);},_caretPos:function(c,f){var d=(this._curval+"").length;if(c<0){c=0;}if(f<0){f=0;}if(c!=f&&c<this._options.decimals){this._setCaret(d-c);}else{this._setCaret(d-f);}},_pointFunc:function(){var d=this._inputControl.val(),g=d.indexOf(".");if(this._options.unlimitedDec&&g==-1){var j=this._getCaret(),c=j[0],h=j[1],f=[];f.push(d.substring(0,c));f.push(d.substr(h));this._inputControl.val(f.join("."));this._setCaret(c+1);}else{if(this._options.decimals||this._options.unlimitedDec){if(d===""){this._inputControl.val(".");g=1;}this._setCaret(g+1);}}},_createMarkup:function(c){var b=$ws.proto.FieldAbstract.prototype._createMarkup.apply(this,arguments),d="<input class='input-text-field' title='{{=it.tooltip}}' {{? it.tooltipInside }}placeholder='{{=it.tooltip}}'{{?}} {{? it.maxlength }}maxlength='{{=it.maxlength}}'{{?}} type='{{? it.password }}password{{??}}text{{?}}' name='{{=it.name}}' />";return this._extendMarkup(b,d);},_bindInternals:function(){this._inputControl=this._container.find(".input-text-field");this._createPlaceholder();},_getCaret:function(){var h=this._inputControl.get(0),c,g,d;if(document.selection){var f=document.selection.createRange();d=f.text.length;f.moveStart("textedit",-1);g=f.text.length;f.moveEnd("textedit",-1);c=g-d;}else{c=h.selectionStart;g=h.selectionEnd;}return[c,g];},_setCaret:function(e,b){b=b||e;var d=this._inputControl.get(0);if(document.selection){var c=d.createTextRange();c.collapse(true);c.moveStart("character",e);c.moveEnd("character",b-e);c.select();}else{d.setSelectionRange(e,b);d.focus();}},_notFormatedVal:function(){var b=parseFloat((this._curval+"").replace(/ /g,""));if(!isNaN(b)){return b;}return null;},_setValueInternal:function(g){var c,f,b,e;if((g+"").indexOf("e")!==-1&&!isNaN(parseFloat(g+""))){g=g.toFixed(20);var d=g.length;while(g.charAt(d-1)==="0"){--d;}g=g.substr(0,d);}g=(""+g).replace(this._options.notNegative?/[^0-9\.]/g:/[^0-9\.\-]/g,"");f=g.indexOf(".");b=g.indexOf(".",f+1);e=/\-/.test(g)?1:0;if(b!==-1){g=g.substring(0,b);}if(f===g.length-1){g=g.substr(0,g.length-1);f=-1;}if(!/^\-?[0-9]*(\.[0-9]*)?$/.test(g)){g="";}if(g===""||g===null){c=null;}else{if(!this._options.unlimitedInt){if(f==-1){f=g.length;}if(this._options.integers+e<f){g=g.substring(0,this._options.integers+e)+g.substr(f);}f=g.indexOf(".");}if(this._options.unlimitedDec){if(f==-1){c=$ws.render.defaultColumn.integer(g,!this._options.delimiters);}else{c=[$ws.render.defaultColumn.integer(g.substring(0,f),!this._options.delimiters),g.substr(f)].join("");}}else{g=g.substr(0,this._options.maxlength&&!this._options.delimiters?this._options.maxlength:g.length);c=$ws.render.defaultColumn.real(g,this._options.decimals,this._options.delimiters);}}if(this._emptyNegative&&(parseInt(g,10)||c===null)){this._emptyNegative=false;}if(this._options.hideEmptyDecimals&&(!this.isActive()||this._isBluring)){this._isBluring=false;if(c!==null){f=c.indexOf(".");if(f!==-1){if(/^0*$/.test(c.substr(f+1))){c=c.substr(0,f);}}}}$ws.proto.FieldNumeric.superclass._setValueInternal.apply(this,[c]);},_redraw:function(b){}});return $ws.proto.FieldNumeric;});