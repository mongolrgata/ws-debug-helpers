$ws.declareModule({namespace:"SBIS3.CORE",name:"FieldDate",imports:["SBIS3.CORE.FieldFormatAbstract"]},function(a){$ws.proto.FieldDate=a.extend({$protected:{_options:{performFormatValidation:true,calendar:true,cssClassName:"ws-field-date"},_containerClickHandher:null,_year:0,_startDate:undefined},$constructor:function(){var b=this;this._container.find(".ws-field").width("+=1").before('<input class="input-helper" type="hidden"/>');if(this._options.calendar){if(this._clearMask.search(/[DMY]/)!==-1){this._container.find(".ws-field").after('<div title="'+this._options.tooltip+'" class="calendar-container"></div>');}$ws.core.attach("ext/jquery-ui/jquery-ui-1.8.5.custom.min.js").addCallback(function(){$ws.core.attach("css/datepicker/jquery-ui-1.8.5.custom.css");$ws.core.attach("ext/datepicker/jquery.ui.datepicker-ru.js",{charset:"UTF-8"});var c=b._container.find(".input-helper").datepicker({onSelect:function(d){b._year=arguments[1]["drawYear"];b.setValue(b.strToDate(d,b._year));b.setActive(true);b._notify("onChange",b._notFormatedVal());},beforeShow:function(d){$(d).val(b._inputControl.get(0).textContent||b._inputControl.get(0).innerText);if(b._startDate){c.datepicker("setDate",b._startDate);}b._container.trigger("wsSubWindowOpen");},onClose:function(){b._container.trigger("wsSubWindowClose");},dateFormat:b._getMask(b._options.mask,"datepicker"),changeYear:true,yearRange:"c-70:c+10",duration:0});b._container.find(".calendar-container").mousedown(function(d){d.stopImmediatePropagation();}).click(function(){b.setActive(true);if(b._options.enable){b._toggleCalendar();}});if(b._parent){b._containerClickHandler=function(){b._container.find(".input-helper").datepicker("hide");};b._parent.getContainer().bind("container-clicked",b._containerClickHandler);}if(!$.datepicker.propagationStopped){$.datepicker.propagationStopped=true;$.datepicker.dpDiv.bind("click",function(d){d.stopPropagation();});}});}$ws.helpers.keyDown(this._inputControl,function(c){if(c.which==$ws._const.key.insert&&!c.ctrlKey){c.preventDefault();b._insDate();return false;}if(c.which==$ws._const.key.plus||c.which==$ws._const.key.minus){b._insDate(c.which);return false;}if(c.which==$ws._const.key.f7){c.preventDefault();b._toggleCalendar();}if(c.which==$ws._const.key.esc){if(/block/.test($("#ui-datepicker-div").css("display"))){b._container.find(".input-helper").datepicker("hide");c.stopPropagation();}}});this._options.validators.splice(0,0,{validator:this._textValidate});this._resizeCalendarBtn();},_canValidate:function(){return true;},_invokeValidation:function(){var c=$ws.proto.FieldDate.superclass._invokeValidation.apply(this,arguments),b=this.getValue();if(b&&typeof b==="string"){b=this.strToDate(b);}if(b&&b.getFullYear&&b.getFullYear()<1400){c.result=false;c.errors.push("Год не может быть меньше 1400");}return c;},setTooltip:function(b){this._container.find(".calendar-container").attr("title",b);},_resizeCalendarBtn:function(){var b,c,d;b=this._container;d=this._container.find(".calendar-container");if(d.length){c=b.height();d.height(c).width(c);}},destroy:function(){this._toggleCalendar(false);if(this._parent&&this._containerClickHandher){this._parent.getContainer().unbind("container-clicked",this._containerClickHandher);}$ws.proto.FieldDate.superclass.destroy.apply(this,arguments);},_prepareRegExp:function(){this._sepExp=/[^YMDHISU]+/g;this._notsepExp=/[YMDHISU]+/g;},_isCalendarOpen:function(){return $("#ui-datepicker-div").css("display")=="block";},_toggleCalendar:function(b){if(!this._options.calendar){return;}if(b===undefined){b=!this._isCalendarOpen();}this._container.find(".input-helper").datepicker(b?"show":"hide");},strToDate:function(h,j){var g=["y","m","d","h","i","s","u"],d={},k,c,b,f=false;if(/\d{2}\.\d{2}\.\d{4}$/g.test(h)){k="dd.mm.yyyy";}else{if(/\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}$/g.test(h)){k="yyyy-mm-dd hh:ii:ss";}else{if(/\d{4}-\d{2}-\d{2}$/g.test(h)){k="yyyy-mm-dd";}else{k=this._options.mask.toLowerCase();}}}while(k.indexOf("{")!==-1){k=k.replace(/{[^\}]*}/,"");}for(var e in g){if(g.hasOwnProperty(e)){c=k.indexOf(g[e]);b=k.lastIndexOf(g[e])-c+1;d[g[e]]=c===-1?0:parseInt(h.substr(c,b),10);f|=c!==-1&&(d[g[e]]!==null&&isNaN(d[g[e]])===false);d[g[e]]|=0;}}if(j){d.y=j;}else{if(k.indexOf("y")===-1){d.y=new Date().getFullYear();}d.y+=d.y<100?2000:0;}if(d.m>0){d.m--;}if(d.d===0){d.d=f?1:NaN;}return new Date(d.y,d.m,d.d,d.h,d.i,d.s,d.u);},_setValueInternal:function(c){if(typeof c==="string"){if(!/\d{2}\.\d{2}\.\d{4}$/g.test(c)&&!/\d{4}-\d{2}-\d{2}$/g.test(c)&&!/\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}$/g.test(c)){c=this._formatTest(c);}this._inputControl.html(this._htmlMask);c=this.strToDate(c);}if(!c){this.clear();c=null;}else{if(!isNaN(c.getTime())){this._insDate(c);var b=c.getFullYear();if(b){this._year=b;}}}$ws.proto.FieldAbstract.prototype._setValueInternal.apply(this,[c]);this._hideMask(this.isActive());},_checkDate:function(g){if(g&&g instanceof Date&&!isNaN(g.getTime())){var c={H:"Hours",I:"Minutes",S:"Seconds",U:"Milliseconds"},f={};for(var b=0;b<this._options.mask.length;++b){f[this._options.mask[b]]=true;}for(var e in c){if(c.hasOwnProperty(e)&&!f[e]){g["set"+c[e]](0);}}return g;}else{return null;}},_getDefaultValue:function(){if(typeof this._options.value==="function"){return this._checkDate(this._options.value());}else{if(typeof this._options.value==="string"){return this._checkDate(this.strToDate(this._options.value));}else{if(this._options.value instanceof Date){return this._checkDate(this._options.value);}}}return null;},_keyExp:function(){return[/[0-9]/,false];},_insDate:function(b){var e=this._clearMask.split(/[^YMDHISU]/g),c=typeof b=="object"?b:new Date(),f=[],g=this._curValue().split(/\D/g);for(var d=0;d<e.length;d++){f[d]={Y:"FullYear",M:"Month",D:"Date",H:"Hours",I:"Minutes",S:"Seconds",U:"Milliseconds"}[e[d].charAt(0)];}if(b==$ws._const.key.plus||b==$ws._const.key.minus){c=new Date(0);for(d=f.length-1;d>=0;d--){if(f[d]=="FullYear"){g[d]=parseInt(g[d],10);g[d]+=(g[d]<100?2000:0);}c["set"+f[d]](g[d]-(f[d]=="Month"?1:0));}if(c=="Invalid Date"||c=="NaN"||c.getTime()<0){c=new Date();}if(b==$ws._const.key.plus){c.setDate(c.getDate()+1);}if(b==$ws._const.key.minus){c.setDate(c.getDate()-1);}}for(d=0;d<f.length;d++){this._inputControl.find("em:eq("+d*2+")").html(this._roundTime(c["get"+f[d]]()+(f[d]=="Month"?1:0),e[d].length,f[d]));}if(this.isActive()){this._moveCursor(this._inputControl.get(0).childNodes[0].childNodes[0],0);}},_roundTime:function(d,g,e){var f="";if((d.toString().length-g)>0){return d.toString().substr(d.toString().length-g,g);}else{var b=g-d.toString().length;}for(var c=1;c<=b;c++){f+="0";}return f+d;},_notFormatedVal:function(c){var b=this._getString(),e=(typeof b=="string"&&b.indexOf("_")==-1)?this.strToDate(b,this._year):null;if(c){return b;}if(e instanceof Date&&!isNaN(e.getTime())){var f=new Date(e.getTime());var d;switch(this.getType()){case"datetime":d=true;break;case"time":d=false;break;}f.setSQLSerializationMode(d);return f;}else{return null;}},getType:function(){var g={date:["Y","M","D"],time:["H","I","S","U"]},b="",f=0;for(var e in g){for(var d=0,c=g[e].length;d<c;d++){if(this._clearMask.indexOf(g[e][d])!=-1){f++;b=e;break;}}}return f==2?"datetime":b;},_textValidate:function(){var n=this._curValue();if(!this._options.performFormatValidation||n===null){return true;}var k=this._htmlMask.replace(/<[^<]+>/g,""),c=this._inputControl.html().replace(/<[^<]+>/g,""),b=c.split(/\D/g),p=this._clearMask.split(/[^YMDHISU]/g),g={Y:"FullYear",M:"Month",D:"Date",H:"Hours",I:"Minutes",S:"Seconds",U:"Milliseconds"},q=true;n=typeof n=="string"?this.strToDate(n):n;if(k!=c){for(var h=0,f=p.length;h<f;h++){var d=g[p[h].charAt(0)];try{var o=this._roundTime(n["get"+d]()+(d=="Month"?1:0),p[h].length);if(b[h]!=o){throw"error";}}catch(j){q=false;break;}}}return q?q:"Неверный формат";},setActive:function(b){$ws.proto.FieldDate.superclass.setActive.apply(this,arguments);if(!b&&this._containerClickHandher){this._containerClickHandher();}},_onValueChangeHandler:function(){var b=this._notFormatedVal(true),c=this.strToDate(b);if(!isNaN(c.getTime())){this._year=c.getFullYear();}$ws.proto.FieldDate.superclass._onValueChangeHandler.apply(this,arguments);},setStartDate:function(b){this._startDate=b;},clearStartDate:function(){this._startDate=undefined;},_redraw:function(b){}});return $ws.proto.FieldDate;});