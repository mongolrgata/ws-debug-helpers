(function(){$ws._const.DataViewAbstractViewPlugin={recordsMoveOffset:{left:5,top:5}};$ws.core.attach($ws._const.wsRoot+"lib/Control/Plugins/ControlDragAndDrop-plugin.js").addCallback(function(){$ws.proto.DataViewAbstract.extendPlugin($ws.proto.Control.DragAndDropPlugin);});$ws.single.DependencyResolver.register("/lib/Control/Plugins/Move-plugin.js",function(){return["/lib/Control/Plugins/ControlDragAndDrop-plugin.js"];});$ws.proto.DataViewAbstract.MovePlugin=$ws.proto.DataViewAbstract.extendPlugin({$protected:{_options:{useCurrentFilterOnMove:false,dragRecordsToOtherBrowser:false},_drag:{rootBlock:undefined}},$constructor:function(){this._registerShortcut($ws._const.key.m,$ws._const.modifiers.control,this._moveRecords);this._publish("onDragStart","onDragMove","onDragStop","onDragOut","onDragIn");if(!this._options.display.readOnly&&this._options.allowMove){this._menuButtons.move=["Переместить выбранные записи (Ctrl+M)","sprite:icon-16 icon-Move icon-primary","move","move"];}},$condition:function(){return this._options.allowMove&&!this._options.display.readOnly;},_moveRecords:function(){if(this.isEnabled()){var b=this.getActiveRecord(),g=this.getSelection(),e=true,h=$ws.proto.HierarchyViewAbstract&&this instanceof $ws.proto.HierarchyViewAbstract,i=this;if(g.length>0&&this._notify("onDragStart",g)!==false){if(h){var c=g[0].get(this._hierColumnParentId);for(var f=1,d=g.length;f<d;f++){if(g[f].get(this._hierColumnParentId)!==c){e=false;}}if(e&&!(b&&(c===b.get(this._hierColumnParentId)||c===b.getKey()||c===i._currentRootId))){e=false;}}if(e){$ws.core.setCursor(false);this._useKeyboard=true;var a=$ws.core.merge({},this._initialSource);a.firstRequest=false;a.usePages=a.filterParams.usePages="";a.handlers={};if(this._options.useCurrentFilterOnMove){a.filterParams=this.getQuery();}else{a.filterParams=$ws.core.merge({},this._initialFilter);}a.filterParams["ВидДерева"]="Только узлы";a.filterParams[this._hierColumnParentId]=i._rootNode;a.filterParams.usePages="";$ws.core.attachInstance("Source:RecordSet",a).addCallback(function(j){$ws.core.attachInstance("Control/Area:Dialog",{template:"replaceRecordsDialog",handlers:{onReady:function(){var m=this.getChildControlByName("ws-browser-replace"),l=this,k=function(p,n){var o=m.getItemParents(p);i.move(p,n,o);};m.subscribe("onReady",function(){m.setData(j);m.setHierarchyField(i._hierColumnParentId);m.setRootNode(i._rootNode);});m.subscribe("onRowDoubleClick",function(q,r,n){var p=n?n.get(i._hierColumnParentId):i._rootNode,o=[];while((p+"")!==(i._rootNode+"")&&!h){if(!i._expanded[p]){i._expanded[p]=true;o.push(p);}p=this.getRecordSet().getRecordByPrimaryKey(p).get(i._hierColumnParentId);}if(i._notify("onDragStop",g,n?n:i._rootNode,true)!==false){k(n?n.getKey():i._rootNode,o);}l.close();});m.subscribe("onSelectionConfirm",function(q,n){var p=n.length===0?i._rootNode:n[0].get(i._hierColumnParentId),o=[];while((p+"")!==(i._rootNode+"")&&!h){if(!i._expanded[p]){i._expanded[p]=true;o.push(p);}p=this.getRecordSet().getRecordByPrimaryKey(p).get(i._hierColumnParentId);}if(i._notify("onDragStop",g,n.length===0?i._rootNode:n[0],true)!==false){i.move(n.length===0?i._rootNode:n[0].getKey(),o);}l.close();});this.getChildControlByName("replace").subscribe("onActivated",function(){var o=m.getActiveRecord()?m.getActiveRecord().get(i._hierColumnParentId):i._rootNode,n=[],p;while((o+"")!==(i._rootNode+"")&&!h){if(!i._expanded[o]){i._expanded[o]=true;n.push(o);}o=m.getRecordSet().getRecordByPrimaryKey(o).get(i._hierColumnParentId);}p=m.getActiveRecord();if(i._notify("onDragStop",g,p?p:i._rootNode,true)!==false){k(p?p.getKey():i._rootNode,n);}l.close();});},onAfterShow:function(){$ws.core.setCursor(true);},onAfterClose:$.proxy(i._mouseMonitor,i)}});});}else{this._confirmMoveRecords(b);}}}},_confirmMoveRecords:function(b){var a=this,c=this.getSelection();if(this._notify("onDragStart",c)!==false){$ws.core.setCursor(false);this._useKeyboard=true;$ws.core.attachInstance("Control/Area:DialogConfirm",{resizable:false,message:"Переместить выбранные записи ( "+c.length+" ) в текущий раздел?",handlers:{onConfirm:function(f,d){if(d===true){var e=a._currentRootId;if(b){if(b.get(a._hierColumnIsLeaf)){e=b;}else{e=b.get(a._hierColumnParentId);e=a._isIdEqual(e,a._rootNode)?e:a._currentRecordSet.getRecordByPrimaryKey(e);}}if(a._notify("onDragStop",c,e,true)!==false){var g=e instanceof $ws.proto.Record?e.getKey():e;a.move(a._isIdEqual(e,a._rootNode)?a._rootNode:g);}a._mouseMonitor.apply(a);a.removeSelection();}}}}).addBoth(function(d){$ws.core.setCursor(true);return d;});}},_getItemParents:function(c){var a=[c],b;while(c&&c!=this._rootNode&&this._currentRecordSet.contains(c)){b=this._currentRecordSet.getRecordByPrimaryKey(c);c=b.get(this._hierColumnParentId);a.push(c);}return a;},_moveSelectedRecordsToCurrent:function(a){this._confirmMoveRecords(a);},move:function(m,l,p){if(!this._options.allowMove){return;}if(m==="null"){m=null;}var c=this.getSelection(),q=this,b,k=p||this._getItemParents(m),g=$ws.proto.TreeView&&this instanceof $ws.proto.TreeView,a={};l=l||[];l.push(m);for(var d=0,f=k.length;d<f;++d){a[k[d]]=true;}for(d=0,f=c.length;d<f;++d){var o=c[d].getKey();if(o==m||(o in a)){$ws.core.alert("Вы не можете переместить запись саму в себя!");return;}if(g){l.push(c[d].get(q._hierColumnParentId));}}if(g){if(!this._expanded[m]){this._expanded[m]=true;l.push(m);}}var n=function(){var s=new $ws.proto.ParallelDeferred(),u=[],t=function(){q.unsubscribe("onAfterRender",t);q._hovered=c[0].getKey();q.showBranch(m);};$ws.core.setCursor(false);for(var r=0,e=c.length;r<e;r++){c[r].set(q._hierColumnParentId,m);s.push(c[r].update().addErrback(function(i){u.push(i.message);}));}s.done();s.getResult().addBoth(function(){if(u.length!==0){$ws.core.alert("В процессе перемещения возникли ошибки: \n "+u.join(" ;\n "));}q._isUpdatingRecords=false;if(!q._expanded[m]&&(m!=q._rootNode||q._options.display.showRoot)){q._activeElement=undefined;q._hovered=m;}q.removeSelection();if(q._options.mode==="navigationMode"&&g){q._closeOtherBranches(m);}if(!g){q.subscribe("onAfterRender",t);}q._onRecordUpdated(g,l);$ws.core.setCursor(true);});},j=function(){if(b.get(q._hierColumnIsLeaf)!==true){$ws.core.alert("Вы не можете перемещать в лист! Выберите другую запись для перемещения!");}else{n();}};q._isUpdatingRecords=true;if(m===q._rootNode){n();}else{try{b=this._currentRecordSet.getRecordByPrimaryKey(m);j();}catch(h){this._currentRecordSet.readRecord(m).addCallback(function(e){b=e;j();});}}},_initEvents:function(){var a=this._browserContainer.parent();this._addDragContainer("[rowkey]",a);},_dragStart:function(d){var a=false;for(var c=0;c<d[0].childNodes.length;++c){if(d[0].childNodes[c].nodeType==$ws._const.nodeType.TEXT_NODE){a=true;break;}}if(d.closest("a").length===1){a=true;}if(!a){return false;}var b=this._dropRecord(d);if(!b){return false;}this.setActiveElement(d.closest("tr"),false,true);return this.getSelection();},_dragStarted:function(){this._useKeyboard=true;},_dragCreateRootBlock:function(){this._drag.rootBlock=$('<div class="ws-browser-drag-root" rowkey="null"><div class="ws-browser-drag-root-title">Корень</div></div>').appendTo(this._browserContainer.parent()).hover(function(){$(this).addClass("hover");},function(){$(this).removeClass("hover");});this._onResizeHandler();},_dragRemoveRootBlock:function(){if(this._drag.rootBlock){this._drag.rootBlock.remove();this._drag.rootBlock=undefined;this._onResizeHandler();}},_dragRemoveHighlight:function(a){a.removeClass("ws-browser-want-drag");},_dragAddHighlight:function(a){if(a.hasClass("ws-browser-table-row")){a.addClass("ws-browser-want-drag");}},_isDragAcceptable:function(g,e,h,b){if(!b){return false;}var d=b.getKey(),c,a;if(h===this){for(c=0,a=e.length;c<a;++c){if(e[c].getKey()==d){return false;}}}if(this.isHierarchyMode()){var f=d;while(f&&!this._isIdEqual(f,this._rootNode)){for(c=0,a=e.length;c<a;++c){if(e[c].getKey()==f){return false;}}f=b.get(this._hierColumnParentId);if(this._currentRecordSet.contains(f)){b=this._currentRecordSet.getRecordByPrimaryKey(f);}else{if(!this._isIdEqual(f,this._rootNode)){if(f!=this._currentRootId){return false;}break;}}}}return true;},_createRootRecord:function(){var a=new $ws.proto.Record({colDef:this._currentRecordSet.getColumns(),row:[]});a.setKey(this._rootNode,this._currentRecordSet.getPkColumnIndex());return a;},_dropBlock:function(a){if(this.isHierarchyMode()){return a.closest("tr, .ws-browser-drag-root, .ws-browser-container");}return a.closest(".ws-browser-container");},_dropRecord:function(b){var c=this._dropBlock(b),a=c.attr("rowkey");if(this._isIdEqual(a,this._rootNode)||c.is(this._browserContainer)){return this._createRootRecord();}if(!this._currentRecordSet.contains(a)){return false;}return this._currentRecordSet.getRecordByPrimaryKey(a);},_dropTarget:function(b){var a=this._dropRecord(b);if(!this.isHierarchyMode()||a&&(a.get(this._hierColumnIsLeaf)||this._isIdEqual(a.getKey(),this._rootNode))){return a;}return false;},_dragEnd:function(){this._useKeyboard=false;},_drop:function(d,a,c){if(this===c){var b=this._dropTarget(d);if(b){this.move(b.getKey());}}},_canDragOut:function(){return this._options.dragRecordsToOtherBrowser;},_dragIn:function(a,b){return b===this||this._canDragOut();},_draggedIn:function(a,b){this._container.addClass("drag-over");if(this.isHierarchyMode()&&!this._options.display.showRoot&&this._notify("onDragMove",a,this._createRootRecord(),b)===true){this._dragCreateRootBlock();}},_draggedOut:function(){this._container.removeClass("drag-over");this._dragRemoveRootBlock();},_getAdditionalHeight:function(a){return a+(this._drag.rootBlock?this._drag.rootBlock.outerHeight():0);}});})();