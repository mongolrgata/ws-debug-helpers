$ws.declareModule({namespace:"SBIS3.CORE",name:"DragAndDropPlugin",imports:["SBIS3.CORE.Control"]},function(){$ws._const.DragAndDropPlugin={recordsMoveOffset:{top:5,left:5}};$ws.proto.Control.DragAndDropPlugin={$protected:{_drag:{data:undefined,startPoint:{x:0,y:0},started:false,flowObject:undefined,dropContainer:undefined,onDroppable:false,target:undefined,dropBlock:undefined,dropCorrect:false},_dropContainer:undefined,_dropped:false},$constructor:function(){this._publish("onDragStart","onDragMove","onDragIn","onDragOut","onDragStop");},_addDragContainer:function(a,b){$(a,b.get(0)).live("mousedown",function(c){if(c.which!==1||!this.isEnabled()){return true;}var d=this._dragStart($(c.target));if(!d){return true;}this._drag.data=d;if(this._notify("onDragStart",d)===false){return true;}this._drag.startPoint.x=c.clientX;this._drag.startPoint.y=c.clientY;this._dragStarted(c);$(document).bind("mousemove.wsDragNDrop",this._dragMouseMove.bind(this)).bind("mouseup.wsDragNDrop",this._dragMouseUp.bind(this));return false;}.bind(this));b.bind("wsDragIn",this._dragDataIn.bind(this));b.bind("wsDragOut",this._dragDataOut.bind(this));b.bind("wsDragMove",this._dragDataMove.bind(this));b.bind("wsDragStop",this._dropData.bind(this));this._addDropContainer(b);},_addDropContainer:function(a){this._dropContainer=a.addClass("ws-dropzone");},_dragStart:function(a){},_dragStarted:function(a){},_isDragAcceptable:function(b,a,d,c){},_drop:function(c,a,b){},_dropBlock:function(b,a){},_dropTarget:function(a){},_dragEnd:function(a,b){},_canDragOut:function(){},_dragIn:function(a,b){this._drag.target=undefined;},_draggedIn:function(a,b){},_draggedOut:function(a,b){},_dragDataCount:function(a){if(a instanceof Array){return a.length;}return"";},_dragAddHighlight:function(b,a){},_dragRemoveHighlight:function(a){},_createDragObject:function(b){var a=this._dragDataCount(this._drag.data);return $('<div class="ws-dragged"><span class="ws-dragged-count">'+a+"</span></div>").appendTo($("body")).css({left:b.clientX+$ws._const.DragAndDropPlugin.recordsMoveOffset.left,top:b.clientY+$ws._const.DragAndDropPlugin.recordsMoveOffset.top});},_checkDragDistance:function(a){if(!this._drag.started){var c=Math.abs(a.clientX-this._drag.startPoint.x),b=Math.abs(a.clientY-this._drag.startPoint.y);if(c+b>$ws._const.startDragDistance){this._drag.flowObject=this._createDragObject(a);this._drag.started=true;}else{return true;}}return false;},_checkDropContainer:function(b){var a={};if(!b.is(this._drag.dropContainer)){if(!(this._drag.onDroppable===false&&b.size()===0)){if(this._drag.dropContainer&&this._canDragOut()){a={data:this._drag.data,from:this};this._drag.dropContainer.trigger("wsDragOut",a);}if(!b.size()){this._drag.onDroppable=false;}if(a.correct||!this._drag.dropContainer){this._drag.dropContainer=undefined;if(b.size()&&(b.is(this._dropContainer)||this._canDragOut())){a={data:this._drag.data,from:this};b.trigger("wsDragIn",a);if(a.correct){this._drag.dropContainer=b;this._drag.onDroppable=true;if(this._dropContainer.is(b)){this._drag.flowObject.removeClass("ws-dragged-out ws-drop-over");}else{this._drag.flowObject.removeClass("ws-dragged-out").addClass("ws-drop-over");}}}else{this._drag.flowObject.removeClass("ws-drop-over").addClass("ws-dragged-out");}}}}else{this._drag.onDroppable=true;}},_dragMouseMove:function(a){if(this._checkDragDistance(a)){return true;}$ws.helpers.clearSelection();this._drag.flowObject.css({left:a.pageX+$ws._const.DragAndDropPlugin.recordsMoveOffset.left,top:a.pageY+$ws._const.DragAndDropPlugin.recordsMoveOffset.top});var c=$(a.target);if(c.hasClass("ws-dragged")||c.closest(".ws-dragged").length){return true;}var d=c.closest(".ws-dropzone");this._checkDropContainer(d);if(!this._drag.dropContainer){return false;}var b={target:c,data:this._drag.data,from:this,event:a};this._drag.dropContainer.trigger("wsDragMove",b);if(b.correct){this._drag.target=c;}else{this._drag.target=undefined;}return false;},_dragMouseUp:function(){$(document).unbind(".wsDragNDrop");if(!this._drag.started){this._dragEnd(this._drag.data);return;}$ws.helpers.clearSelection();this._drag.flowObject.remove();var b,a;if(this._drag.onDroppable&&this._drag.target){a={data:this._drag.data,from:this,target:this._drag.target,correct:this._drag.onDroppable};this._drag.dropContainer.trigger("wsDragStop",a);if(a.correct&&this!==a.to){this._notify("onDragStop",this._drag.data,a.dropTarget,true,this,a.to);b=a.to;if(a.callback&&a.callback instanceof Function){a.callback();}}this._drag.onDroppable=false;}if(this._drag.dropContainer){a={from:this,force:true};this._drag.dropContainer.trigger("wsDragOut",a);this._drag.dropContainer=undefined;}this._dragEnd(this._drag.data,b);this._drag.started=false;},_dragDataIn:function(a,b){var c=b.data,d=b.from;if(this._dragIn(c,d)&&this._notify("onDragIn",d,c)!==false){this._draggedIn(c,d);b.correct=true;}},_dragDataOut:function(a,b){var c=b.data,d=b.from;this._dragRemoveHighlight(this._drag.dropBlock);if(this._notify("onDragOut",d,c)!==false||b.force){this._draggedOut(c,d);b.correct=true;}},_dragDataMove:function(a,b){var e=b.target,d=b.data,g=b.from,c=this._dropBlock(e,b.event);if(c==this._drag.dropBlock||(c&&c.is(this._drag.dropBlock))){b.correct=this._drag.dropCorrect;return;}if(this._drag.dropBlock){this._dragRemoveHighlight(this._drag.dropBlock);}this._drag.dropBlock=c;if(!c){return;}var f=this._dropTarget(e);this._drag.dropCorrect=this._isDragAcceptable(e,d,g,f)&&this._notify("onDragMove",d,f,g)!==false;if(this._drag.dropCorrect){b.correct=true;this._dragAddHighlight(c,b.event);}},_dropData:function(a,b){var d=b.data,e=b.from,c=b.target;b.to=this;b.dropTarget=this._dropTarget(c);if(this._notify("onDragStop",d,b.dropTarget,true,e,this)!==false){this._drop(c,d,e);}this._dropped=true;setTimeout(function(){this._dropped=false;}.bind(this),0);}};return $ws.proto.Control.DragAndDropPlugin;});