$ws.proto.DataViewAbstract.PrintPlugin=$ws.proto.DataViewAbstract.extendPlugin({$withoutCondition:["init","setUseDefaultPrint"],$protected:{_options:{printMode:"",reports:{},reportsForList:{}},_menuButtons:{print:["Печать реестра (Ctrl+P)","sprite:icon-16 icon-Print icon-primary","print"],printRecord:["Печать записи (F4)","sprite:icon-16 icon-Print icon-primary","printRecord"]},_printMenu:null,_printMenuIsShow:false,_needPrint:true,_reportPrinter:null,_useDefaultPrint:false},$condition:function(){return this._useDefaultPrint||!Object.isEmpty(this._options.reports)||!Object.isEmpty(this._options.reportsForList);},$constructor:function(){if(this._options.display.rowOptions){delete this._menuButtons.printRecord;}this._publish("onPrepareReportData","onSelectReportTransform","onBeforeShowPrintReports");this._reportPrinter=new $ws.proto.ReportPrinter({columns:this._columnMap,titleColumn:this._options.display.titleColumn});this._keysWeHandle[$ws._const.key.f4]=true;this._keysWeHandle[$ws._const.key.p]=true;this._notify("onNewAction",{title:"Печать записи (F4)",icon:$ws._const.theme?"sprite:icon-16 icon-Print icon-primary":"print.png",name:"printRecord",callback:"printRecord"});},getReportPrinter:function(){return this._reportPrinter;},_drawToolBar:function(){var a=this;this._toolbarReady.addCallback(function(c){if(a.getReports(true).length!==0||(!a._options.display.rowOptions&&a.getReports(false).length!==0)){var b=function(){this.getButton("menu").subscribe("onActivated",function(){a._addSubMenuForToolbarElement("print",this.getId()+"_print",true);if(!a._options.display.rowOptions){a._addSubMenuForToolbarElement("printRecord",this.getId()+"_printRecord",false);}});};try{b.apply(c,[]);}catch(d){c.subscribe("onAfterLoad",b);}}return c;});},_initActionsFlags:function(){var a=this;this._actions=this._actions||{};this._actions.print=$.proxy(a._showReportsListForList,a);this._actions.printRecord=!Object.isEmpty(this._options.reports)&&function(e,c,d){var b;if(e instanceof Object&&"jquery" in e){if(a._printMenuIsShow){a._printMenu.show(d);a._createPrintMenu([]);a._printMenuIsShow=false;}else{b=a._currentRecordSet.getRecordByPrimaryKey(e.attr("rowkey"));a._showReportsListForRecord(b,e,d);}}else{a._showReportsListForRecord();}};},_createRowOptionsSubMenu:function(b,e){if(b=="printRecord"){var d=this._rowOptionsHoverRow.attr("rowkey");if(!this._isIdEqual(d,this._rootNode)){var a=this.getRecordSet().getRecordByPrimaryKey(d),c=this._prepareReports(false,a);if(c===false){this._needPrint=false;}else{if(typeof(c)=="string"){this._needPrint=c;c=false;}}if(c){e.subMenu=c;}}}},_addSubMenuForToolbarElement:function(b,d,f,e,c){var g=e?e:this._toolbar.getMenu();if(g.hasSubMenu(d)){g.destroySubMenu(d);}if(g.isVisible()){var a=this._prepareReports(f,f?false:(c?c:this.getActiveRecord()),b);if(a&&(a.constructor===Array||typeof(a)=="string")){g.showItem(b);if(a.constructor===Array){g.addSubMenu(b,a);this._needPrint=false;}else{this._needPrint=a;}}else{this._needPrint=false;if(!f){g.hideItem(b);}}}},_prepareReports:function(c,g,k){var d=null,e=Object.isEmpty(this._selected)?(g?g:this.getActiveRecord()):this.getSelection(),h=this._notify("onBeforeShowPrintReports",this.getReports(c),e,c),i=this;if(h===false){d=false;}else{var f;if(h instanceof Array){f=h;}else{f=this.getReports(c);}if(f.length==1){d=f[0];}else{d=[];for(var b=0,a=f.length;b<a;b++){d.push({caption:f[b],id:i.getId()+"_"+k+f[b],handlers:{onActivated:function(l,j){i.printReport(j.caption,c,i.getActiveRecord());}}});}}}return d;},_keyboardHover:function(b,a){var c=true;if(this._printMenuIsShow){this._printMenu.show(b);this._createPrintMenu([]);this._printMenuIsShow=false;c=b.which!==$ws._const.key.f4&&!(b.ctrlKey&&b.which===$ws._const.key.p);}if(this.isActive()&&!b.altKey&&!b.shiftKey&&(!b.ctrlKey&&b.which===$ws._const.key.f4||(b.ctrlKey&&b.which===$ws._const.key.p))){if(c&&(!Object.isEmpty(this._options.reports)&&b.which===$ws._const.key.f4||b.which!==$ws._const.key.f4)){this._showReportsList(b,b.which!==$ws._const.key.f4);return false;}}return a;},_showReportsListForList:function(){if(this._needPrint===true){this._showReportsList(this._createFakeEvent(),true);}else{if(typeof(this._needPrint)=="string"){this.printReport(this._needPrint,true,null);}}},_showReportsListForRecord:function(a,c,b){if(this._needPrint===true){this._showReportsList(typeof(b)=="object"?b:this._createFakeEvent(),false,a,c);}else{if(typeof(this._needPrint)=="string"){this.printReport(this._needPrint,false,a);}}},_showReportsList:function(h,b,a,i){var g=null,f=this,d;if(!b){g=a?a:(Object.isEmpty(this._selected)?this.getActiveRecord():this.getSelection());}d=this._notify("onBeforeShowPrintReports",this.getReports(b),g,b);if(d!==false){var c;if(d instanceof Array){c=d;if(d.length==1){d=d[0];}}else{c=typeof(d)==="string"?[]:"";}this._createPrintMenu(c,b).addCallback(function(j){if(f._printMenu===null){if(!d||d===true){var n=f._options[b?"reportsForList":"reports"];for(var k in n){if(n.hasOwnProperty(k)){d=k;}}}d=d===true?undefined:d;f.printReport(d,b);}else{if(!h.clientX||!h.clientY){var m=i?i:(f._activeElement?f._activeElement:f._body.find("tr:first")),e=m.offset();h.clientX=e.left+9;h.clientY=e.top+m.height()+9;}else{h.clientY+=16;}try{f._printMenu.show(h);f._printMenuIsShow=true;}catch(l){f._printMenu.subscribe("onReady",function(){f._printMenu.show(h);f._printMenuIsShow=true;});}}return j;});}},getReports:function(a){var b=[],d;d=a?this._options.reportsForList:this._options.reports;for(var c in d){if(d.hasOwnProperty(c)){b.push(c);}}return b;},_createPrintMenu:function(f,b){var e=this,d=[],h;if(!f||!(f instanceof Array)){f=[];h=b?this._options.reportsForList:this._options.reports;for(var g in h){if(h.hasOwnProperty(g)){f.push(g);}}}for(var c=0,a=f.length;c<a;c++){d[c]={caption:f[c],id:f[c],handlers:{onActivated:function(j,i){e.printReport(i.caption,b);}}};}if(e._printMenu!==null){e._printMenu.destroy();e._printMenu=null;}if(d.length>1){return $ws.core.attachInstance("Control/Menu",{data:d}).addCallback(function(i){e._printMenu=i;return i;});}else{return new $ws.proto.Deferred().callback();}},getCurrentTransform:function(a,b){if(a===undefined){return"default-list-transform.xsl";}else{return b?this._options.reportsForList[a]:this._options.reports[a];}},getPrepareReportDataResult:function(c,d,e,b,a,f){return a!==true?(d?this._prepareReportDataForList(b,f):this._notify("onPrepareReportData",c,e)):undefined;},printReport:function(h,g,e,a,f){var d=e?e:this.getSelection(),b=this.getCurrentTransform(h,g),c=e?e:this.getPrepareReportDataResult(h,g,d,true,a,f),i=this;$ws.core.setCursor(false);if(i._options.printMode==="newWindow"){i._openPrintWindow(h,g,b,i.isHierarchyMode()?i._currentRootId:undefined,f);}else{if(c!==false){if(c instanceof $ws.proto.Deferred){c.addCallback(function(j){if(j instanceof $ws.proto.Record||j instanceof $ws.proto.RecordSet||j instanceof Array){i._showReport(h,j,b,g);}}).addErrback(function(j){$ws.core.setCursor(true);$ws.core.alert(j.message,"error");});}else{if(c instanceof $ws.proto.Record||c instanceof $ws.proto.RecordSet||c instanceof Array){d=c;}this._showReport(h,d,b,g);}}else{$ws.core.setCursor(true);}}if(i._printMenu!==null&&i._printMenuIsShow){i._printMenu.show();i._printMenuIsShow=false;}},getTransform:function(b,e,d,c){if(b===undefined){return $ws._const.wsRoot+"res/xsl/"+d;}else{var a=this._notify("onSelectReportTransform",b,e,d,c);if(typeof(a)==="string"){d=a;}return $ws._const.resourceRoot+d;}},_showReport:function(a,e,d,b){var c=this;d=this.getTransform(a,e,d,b);this._useKeyboard=true;c._reportPrinter.prepareReport(e,d,c.isHierarchyMode()?c._currentRootId:undefined).addCallback(function(f){$ws.helpers.showHTMLForPrint(f).addCallback(function(g){g.subscribe("onAfterClose",$.proxy(c._mouseMonitor,c));g.subscribe("onAfterShow",function(){var h=this.getChildControlByName("ws-dataview-print-report");h.subscribe("onContentSet",function(){$ws.core.setCursor(true);c.removeSelection();});});$ws.core.setCursor(true);});}).addErrback(function(f){$ws.core.setCursor(true);$ws.core.alert(f.message,"error");});},destroy:function(){this._reportPrinter=null;},_prepareReportDataForList:function(a,d){if(a===undefined){a=true;}var c=new $ws.proto.Deferred(),b=this;if(a&&(!this.isHierarchy()||(this.isHierarchy()&&this._turn===""))&&this._paging){b._selectPrintPages().addCallback(function(e){b._getData(e,c);$ws.core.setCursor(false);return e;}).addErrback(function(e){$ws.core.setCursor(true);});}else{b._getData(b._collectDataSource(d),c);}return c;},prepareReportDataForList:function(a){return this._prepareReportDataForList(a);},_selectPrintPages:function(){var b=new $ws.proto.Deferred(),a=this,c;c=this._getDataSource();$ws.core.attachInstance("SBIS3.CORE.Dialog",{template:"selectPrintPages",handlers:{onBeforeClose:function(e,d){if(d===true){if(this.getChildControlByName("printPages").getStringValue()==="cur"){c.filterParams.pageNum=a.getRecordSet().getPageNumber();c.pageNum=c.filterParams.pageNum;c.filterParams.usePages="full";c.usePages="full";}b.callback(c);}else{b.errback(new Error("cancelled"));}}}}).addBoth(function(d){$ws.core.setCursor(true);return d;});return b;},_collectDataSource:function(c){var d=this._options.dataSource;d.filterParams=this.getQuery();if(c){d.filterParams.pageNum=this._currentRecordSet.getPageNumber();}else{d.filterParams.pageNum="";d.filterParams.usePages="";}if(this.isTree()){var a=[this._rootNode];for(var b in this._expanded){a.push(b);}d.filterParams[this._hierColumnParentId]=a;}if(!c){d.usePages="";}d.firstRequest=true;return d;},_getData:function(b,a){return $ws.core.attachInstance("Source:RecordSet",$ws.core.merge({firstRequest:true},b)).addCallback(function(c){c.subscribe("onAfterLoad",function(){a.callback(c);});}).addErrback(function(c){$ws.core.setCursor(true);$ws.core.alert(c.message,"error");});},_openPrintWindow:function(q,p,d,h,c,n){var r=this,f={id:this.getId(),_events:{}},m=[];if(q!==undefined){f.idR=q;}if(p!==undefined){f.list=p;}if(d!==undefined){f.xsl=d;}if(h!==undefined){f.root=h;}if(!(Object.isEmpty(this._options.reports))){f.reports=this._options.reports;f._events.onBeforeShowPrintReports=this._handlersPath("onBeforeShowPrintReports");f._events.onPrepareReportData=this._handlersPath("onPrepareReportData");f._events.onSelectReportTransform=this._handlersPath("onSelectReportTransform");}if(r._columnMap!==undefined){for(var k=0,e=r._columnMap.length;k<e;k++){m.push({title:r._columnMap[k].title,field:r._columnMap[k].field});}f.cols=m;}if(r._options.titleColumn!==undefined){f.tCol=r._options.titleColumn;}$ws.core.setCursor(true);if(!q){if(r._paging&&r._turn===""){r._selectPrintPages().addCallback(function(i){if(i!==undefined){f.dS=this._prepareRecordSetForPrint(i);}r._transmitParamsForPrintWindow(f,c);return i;});}else{f.dS=this._prepareRecordSetForPrint(r._collectDataSource(n));r._transmitParamsForPrintWindow(f,c);}}else{var b=r._getDataSource(),a;if(b){f.dS=this._prepareRecordSetForPrint(b);}a=r.getSelection();f.keys=[];for(var g=0,o=a.length;g<o;g++){f.keys.push(a[g].getKey());}r._transmitParamsForPrintWindow(f,c);}},_prepareRecordSetForPrint:function(b){var a=$ws.core.merge({},b);delete a.handlers;delete a.context;if(a.readerType=="ReaderUnifiedSBIS"){delete a.readerType;}if(a.firstRequest===true){delete a.firstRequest;}if(!this.isHierarchyMode()){delete a.hierarchyField;}if(this._options.display.usePaging===""){delete a.rowsPerPage;delete a.usePages;}if(a.readerParams["dbScheme"]===""){delete a.readerParams["dbScheme"];}if(a.readerParams["queryName"]==="Список"){delete a.readerParams["queryName"];}if(a.readerParams["readMethodName"]==="Прочитать"){delete a.readerParams["readMethodName"];}if(a.readerParams["createMethodName"]==="Создать"){delete a.readerParams["createMethodName"];}if(a.readerParams["updateMethodName"]==="Записать"){delete a.readerParams["updateMethodName"];}if(a.readerParams["destroyMethodName"]==="Удалить"){delete a.readerParams["destroyMethodName"];}return a;},_transmitParamsForPrintWindow:function(e,b){var c="printWindow",d=b?b:$ws._const.appRoot+c+".html",a;d+="?printParams="+encodeURIComponent($ws.helpers.serializeURLData(e));a=window.open(d,"_blank");if(a){a.focus();}},_getDataSource:function(){var c=this._options.dataSource;c.filterParams=this.getQuery();c.filterParams.pageNum="";c.filterParams.usePages="";c.usePages="";c.firstRequest=true;if(!Object.isEmpty(this._expanded)){var a=[];for(var b in this._expanded){if(this._expanded.hasOwnProperty(b)){a.push(b);}}if(this._rootNode&&!this._expanded[this._rootNode]){a.push(this._rootNode);}c.filterParams[this._hierColumnParentId]=a;}return c;},_createFakeEvent:function(){var a;if(document.createEvent){a=document.createEvent("HTMLEvents");}else{if(document.createEventObject){a=document.createEventObject();}}return a;},setUseDefaultPrint:function(){this._useDefaultPrint=true;}});