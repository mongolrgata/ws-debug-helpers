$ws.proto.TableView.LadderPlugin=$ws.proto.TableView.extendPlugin({$protected:{_options:{display:{ladder:[],useWordsLadder:false,wordsLadderCount:1,mergeCells:false}},_hasLadder:false,_ladder:{},_previousRecord:null,_typesForWordsLadder:{"Строка":true,"Текст":true,varchar:true,text:true}},$condition:function(){return !Object.isEmpty(this._options.display.ladder);},$constructor:function(){for(var b=0,a=this._options.display.ladder.length;b<a;b++){this._ladder[this._options.display.ladder[b]]=b;}},_mapColumns:function(){var d={},e;for(var c=0,a=this._columnMap.length;c<a;c++){d=this._columnMap[c];if(this._ladder&&this._ladder[d.field]!==undefined){if(typeof(d.render)=="function"){e=e?Math.min(e,this._ladder[d.field]):this._ladder[d.field];delete this._ladder[d.field];}else{d.className+=" ws-browser-column-with-ladder";}}}if(e){for(var b in this._ladder){if(this._ladder[b]>=e){delete this._ladder[b];}}}},_renderTD:function(k,h,b){var g=b||"";if(this._ladder&&this._ladder[k.field]!==undefined){var m,e="",j=false,c=this._options.display.ladder,i=Array.indexOf(c,k.field);if(this._previousRecord instanceof $ws.proto.Record&&(i>0&&this._hasLadder||i===0)){this._hasLadder=true;j=true;m=this._previousRecord.hasColumn(k.field)?this._previousRecord.get(k.field):"";e=this._prepareColumnData(k,m,this._previousRecord);}if(i===(Object.keys(this._ladder).length-1)){this._hasLadder=false;this._previousRecord=h;}if(j===true){if(this._options.display.useWordsLadder&&k.type in this._typesForWordsLadder){var f=String.trim(g).split(" "),d=String.trim(e).split(" ",this._options.display.wordsLadderCount),a=Math.min(this._options.display.wordsLadderCount,d.length),l=0;while(l<a&&f[l]==d[l]){l++;}if(l){g=['<span class="ws-invisible ws-browser-ladder-element">',f.splice(0,l).join(" ")," </span>",f.join(" ")].join("");}}else{if(b===e){g=["<div class='ws-browser-ladder-element ws-hidden'>",g,"</div>"].join("");}else{this._hasLadder=false;}}}}return g;},_drawBodyCycle:function(){this._previousRecord=null;if(!this._options.display.useWordsLadder&&this._options.display.mergeCells){var v=this._body.find(".ws-ladder-first"),g=this,e=[],u=0,d=0,h,w,c;if(v.length){$(v).removeClass(".ws-ladder-first");}this._body.find(".ws-browser-table-row").each(function(){var j=$(this),i=j.find(".ws-ladder-bottom-last");if(g._options.display.hasZebra){j.removeClass("ws-ladder-top ws-ladder-bottom ws-ladder-top-last");if(i.length){i.each(function(){$(this).removeClass("ws-ladder-bottom-last");});}}});this._body.find(".ws-browser-table-row:first td").each(function(){var i=$(this);if(i.hasClass("ws-browser-column-with-ladder")){e.push(i.index());}u++;});for(var r=0,o=e.length;r<o;r++){h=[];w=1;this._body.find(".ws-browser-table-row").each(function(){var j=$(this).children(),i=j.length===u?e[r]:0;h.push(j.eq(i));});for(var q=0,s=h.length;q<s;q++){if(h[q].find(".ws-browser-ladder-element").length){if(c===undefined){c=q-1;}w++;}if(c!==undefined&&((q===s-1)||(!h[q+1].find(".ws-browser-ladder-element").length))){var t=w+c;if(r===0){d++;for(var m=c;m<=q;m++){var a=$(h[m].closest("tr")[0]).attr("rowgroup",d);if(this._options.useSelection){a.hover(function(){g._body.find(".ws-browser-table-row[rowgroup="+$(this).attr("rowgroup")+"]").addClass("ws-ladder-hover");if(g._options.useHoverRowAsActive){var i=g._body.find(".ws-active-hover");if(i.length){i.removeClass("ws-active-hover");}}},function(){var i=g._body.find(".ws-browser-table-row[rowgroup="+$(this).attr("rowgroup")+"]");$(i).removeClass("ws-ladder-hover");if(g._options.useHoverRowAsActive){$(i).removeClass("ws-browser-item-over");}});}}if(this._options.display.hasZebra){var b=t!==s?"ws-ladder-bottom":"ws-ladder-top-last";h[c].addClass("ws-ladder-bottom-last");h[c].closest("tr").addClass("ws-ladder-top");h[t-1].closest("tr").addClass(b);}}h[c].attr("rowspan",w);for(var p=c+1;p<t;p++){var f=h[p].next();if(f.length){$(f).addClass("ws-ladder-first");}h[p].remove();}c=undefined;w=1;}}}}},setActiveElement:function(j,m,h){if(!this._options.display.useWordsLadder&&this._options.display.mergeCells&&this._options.useSelection&&j){if(this._options.useHoverRowAsActive){this._body.find(".ws-browser-table-row[rowgroup="+a+"]").addClass("ws-active-hover");}else{var a=$(j).attr("rowgroup"),k=this._body.find(".ws-browser-table-row[rowgroup="+a+"] td[rowspan]"),g=this._body.find(".ws-selected"),c=k.length,d=1,b;if(g.length){g.removeClass("ws-selected");}if(c){b=$(k[0]);for(var f=0;f<c;f++){var e=$(k[f]).attr("rowspan");if(e>d){d=e;b=$(k[f]);}}if(!$(j).find(b).length&&b.is("td:first-child")){$(j).addClass("ws-bg-none");b.addClass("ws-selected");this._body.find(".ws-browser-table-row[rowgroup="+a+"] td:first-child:not(.ws-selected)").each(function(){if($(this).get(0)!==b.get(0)){$(this).addClass("ws-ladder-first");}});}}}}},_rowOptionsEventHandler:function(a){if(!this._options.display.useWordsLadder&&this._options.display.mergeCells&&this._options.useSelection&&this._rowOptionsHoverRow){this._body.find(".ws-browser-table-row[rowgroup="+this._rowOptionsHoverRow.attr("rowgroup")+"]")[a.type==="mousenter"?"addClass":"removeClass"]("ws-ladder-hover");}},_startEditTd:function(f,c){var d=$(f).closest("tr"),a=d.attr("rowgroup");if(a){var e=this._body.find(".ws-browser-table-row[rowgroup="+a+"]"),b="ws-browser-editable-rowgroup";$(e).each(function(){var g=$(this);if(g.hasClass(b)){g.removeClass(b);}g.addClass(b);});}},_toggleClassForLadder:function(a){var e=a.find(".ws-browser-column-with-ladder");for(var d=0,b=e.length;d<b;d++){var c=e[d].getElementsByClassName("ws-browser-ladder-element")[0];if(c!==undefined){$(c).toggleClass(c.tagName==="DIV"?"ws-hidden":"ws-invisible");}}},_onScrollActions:function(){if(!Object.isEmpty(this._ladder)){var b=this._browserContainer.offset().top,c=this._browserContainer.find("tr:visible:first"),a=c.offset();while(a!==null&&a.top<b){c=c.next("tr:visible");a=c.offset();}if(c!==this._previousTRWithLadder){this._toggleClassForLadder(c);if(this._previousTRWithLadder!==undefined){this._toggleClassForLadder(this._previousTRWithLadder);}this._previousTRWithLadder=c;}}}});