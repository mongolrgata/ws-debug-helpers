$ws.proto.FieldImage.CropPlugin=$ws.proto.FieldImage.extendPlugin({$protected:{_options:{cropAspectRatio:undefined,cropStartSelectAuto:true,cropStartSelect:undefined,BLObjLoadMethodName:""},_cropSourceReady:undefined},$condition:function(){return this._options.cropEnabled===true;},$constructor:function(){this._publish("onCropInit","onCropStarted","onCropFinished");var a=new $ws.proto.ParallelDeferred({steps:[$ws.core.attach("ext/jcrop/jquery.Jcrop.min.js"),$ws.core.attach("ext/jcrop/jquery.Jcrop.min.css")]});this._cropSourceReady=a.done().getResult();if(this._options.cropStartSelect){this._options.cropStartSelect=(this._options.cropStartSelect+"").split(",");}this._onPluginLoaded("CropPlugin");},cropInit:function(){var e=this,g=this._options.cropStartSelect,d=function(h){e._cropCoords=h;};this._notify("onCropInit");if(this._options.cropStartSelectAuto){var c=this._getImage(),b=c.width(),f=c.height(),a=Math.min(b,f);g=[(b-a)/2,(f-a)/2,a,a];}this._cropSourceReady.addCallback(function(){e._getImage().eq(0).Jcrop({aspectRatio:e._options.cropAspectRatio,setSelect:g,keySupport:false,onChange:d,onSelect:d});e._getRepositionMethod().call(e);});},cropPerform:function(){var k=this._cropCoords;if(!k||k.x>=k.x2||k.y>=k.y2){return;}var m=this,e=this._getImage(),g=e.height(),l=e.width(),d=this.getRealHeight(),i=this.getRealWidth(),c=Math.max(d/g,i/l),b=this._options.dataSource.readerParams.linkedObject,h=this._options.filterParams["ИдО"].fieldName,f=this._options.BLObjLoadMethodName,j=b+"."+this._options.dataSource.readerParams.queryName,a={rwidth:0,rheight:0,readMethod:j,writeMethod:f,left:Math.round(k.x*c),top:Math.round(k.y*c),width:Math.round(k.w*c),height:Math.round(k.h*c)};$ws.helpers.callbackWrapper(this._notify("onCropStarted",a),function(o){if(o!==false){var n=new $ws.proto.BLObject("ImageEditingPython");if(o instanceof Object){a=o;}a.ID=m.getLinkedContext().getValue(h);n.call("КадрироватьФото",a,$ws.proto.BLObject.RETURN_TYPE_ASIS).addBoth(function(p){if(!isNaN(parseFloat(p))&&isFinite(p)){m.cropFinish();}m._notify("onCropFinished",p);return p;});}return o;});},cropFinish:function(){this._cropCoords=undefined;this.reloadImage();this._rebuildImage();}});