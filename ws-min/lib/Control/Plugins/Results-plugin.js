$ws.proto.TableView.ResultsPlugin=$ws.proto.TableView.extendPlugin({$withoutCondition:["_mapColumns"],$protected:{_options:{display:{resultsRender:"",resultText:"&Sigma;"}},_resultFields:[],_resultTypes:{leaves:"По листьям",folders:"По узлам",foldersAndLeaves:"По узлам и листьям"},_resultBrowser:undefined,_resultContainer:undefined,_hasResults:false,_hasResultFields:undefined},$condition:function(){return this._hasResultFields!==false||this._hasResults;},_mapColumns:function(){var c=this._options.display.columns,a=this._currentRecordSet&&this._currentRecordSet.getColumns(),e=c?c:a;this._hasResultFields=false;for(var d=0,b=e.length;d<b;d++){this._columnMap[d].isResultField=e[d].isResultField===undefined?false:e[d].isResultField;if(!this._hasResultFields&&this._columnMap[d].isResultField){this._hasResultFields=true;}}this._initResultFieldsList();if(this._options.dataSource.filterParams===undefined){this._options.dataSource.filterParams={};this._options.dataSource.filterParams["_Итоги"]=this._options.filterParams["_Итоги"];}},_drawBody:function(){this._resultContainer.toggleClass("ws-hidden",!(this._currentRecordSet.getRecordCount()>0));},_createContainer:function(){this._container.find(".ws-browser-container").append(['<div class="ws-browser-results-block">','<table class="ws-table-fixed ws-browser-foot results" cellspacing="0">',"<colgroup>",this._renderColgroups(),"</colgroup>","<tbody></tbody>","</table>","</div>"].join(""));this._resultBrowser=this._rootElement.find(".ws-browser-foot.results");this._resultContainer=this._rootElement.find(".ws-browser-results-block");},_updateResults:function(){var f=this._resultBrowser.find(".ws-browser-results").length;if(this._resultFields.length!==0){if(f===0){this._resultBrowser.prepend('<tr class="ws-browser-results"></tr><td class="ws-browser-checkbox-holder"/>');}else{this._resultBrowser.find(".ws-browser-results td").remove();}var j=this._columnMap.length;var e=this._currentRecordSet.getResults(),g,a,b,h,d;g=$('<tr class="ws-browser-results"/>');for(var c=0;c<j;c++){h=this._columnMap[c];d="";a=$(this._createTdTemplate(c));if(h.isResultField&&e!==null&&e.hasColumn(h.field)){a.attr("title",h.title);d=e.get(h.field);d=d===null?0:d;switch(h.type){case"Деньги":d=$ws.render.defaultColumn.money(d);break;case"oid":case"int2":case"int4":case"int8":case"Число целое":d=$ws.render.defaultColumn.integer(d);break;}}b=a.find(".ws-browser-cell-container");if(c===0){if(this._options.display.showSelectionCheckbox&&this._options.useSelection!==false){a.attr("colspan",2);}b.append($('<span class="ws-browser-sigma">'+this._options.display.resultText+"</span><div>"+d+"</div>"));}else{b.text(d);}g.append($(a));}if(typeof(this._options.display.resultsRender)==="function"){this._options.display.resultsRender.apply(this,[g,e]);}this._resultBrowser.find(".ws-browser-results").replaceWith(g);this._hasResults=true;this._setHeight();}else{if(f!==0){this._resultBrowser.find(".ws-browser-results").remove();this._hasResults=false;this._setHeight();}}this._setContainerHeightForRecalk();},_onScrollActions:function(a){this._resultBrowser.parent().scrollLeft(a);},_initResultFieldsList:function(){this._resultFields=[];for(var b=0,a=this._options.display.columns.length;b<a;b++){if(this._options.display.columns[b].isResultField===true){this._resultFields.push(this._options.display.columns[b].field);}}if(this._resultFields&&this._resultFields.length!==0){if(!this._options.display.resultType){this._options.display.resultType="leaves";}this._options.filterParams["_Итоги"]={"ПоляРасчета":this._resultFields,"ВидРасчета":this._resultTypes[this._options.display.resultType]};this._systemParams["_Итоги"]=this._options.filterParams["_Итоги"];}else{delete this._systemParams["_Итоги"];}},_onDataLoaded:function(d,c,a,b){if(a){this._updateResults();}},_setWidth:function(){this._updateResultsColgroup();},setColumns:function(){var a=this;this._dReady.addCallback(function(){var g={},f=false,d,b,c;b=a._resultFields.length;for(d=0;d<b;d++){g[a._resultFields[d]]=true;}a._initResultFieldsList();c=a._resultFields.length;if(b!==0&&c!==0){if(b==c){for(d=0;d<c;d++){if(!g[a._resultFields[d]]){f=true;return;}}}else{f=true;}}if(f){var e=a.getQuery();e["_Итоги"]=a._options.filterParams["_Итоги"];a.setQuery(e);}else{a._updateResults();}});},_updateResultsColgroup:function(){if(this._resultBrowser){var b=this._resultBrowser.find("colgroup");b.empty().append($(this._renderColgroups(true)));var a=b.find("col.ws-browser-col");this._bodyColumns.each(function(c){a[c].setAttribute("width",this.getAttribute("width"));});}},_createTdTemplate:function(b){var g=document.createElement("td"),f=b>=0?this._columnMap[b]:{type:"Строка",render:null,field:this._options.display.titleColumn,title:this._options.display.titleColumn,className:"",allowEditAtThePlace:this._titleColumnIndex==-1?false:this._columnMap[this._titleColumnIndex].allowEditAtThePlace,textAlign:"left",fixedSize:false},d=$ws._const.Browser.type2ClassMap[f.type]||f.type,c=[];if(this._options.display.cutLongRows){c.push("ws-browser-cell-cut");}if(f.textAlign!=="auto"){c.push("ws-browser-"+f.textAlign);}else{if($ws.render.defaultColumn.isNumeric(f.type)){c.push("ws-browser-type-numeric");}if(d){c.push("ws-browser-type-"+d);}}if(f.className){c.push(f.className);}if(c.length>0){g.className=c.join(" ");}var a=document.createElement("div");a.className="ws-browser-cell-container"+(this._options.display.cutLongRows?" ws-browser-div-cut":"");if(this.isHierarchyMode()&&b<=0){var e=document.createElement("div");e.className="ws-browser-text-container";a.appendChild(e);}g.appendChild(a);return g;},_getAdditionalHeight:function(){var a=(this._resultBrowser?this._resultBrowser.height():0);if(arguments[0]!==undefined){return a+arguments[0];}}});