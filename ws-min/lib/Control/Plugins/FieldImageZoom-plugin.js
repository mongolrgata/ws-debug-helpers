$ws._const.FieldImageZoomPlugin={zoomSteps:[0.25,0.33,0.5,0.67,0.75,0.9,1,1.1,1.25,1.5,1.75,2,2.5,3,4,5],defaultZoom:1,rotateClasses:["","ws-rotate-left ws-rotate-left-top-right","ws-rotate-half-turn","ws-rotate-right"],saveRotateDelay:1400};$ws.proto.FieldImage.ZoomPlugin=$ws.proto.FieldImage.extendPlugin({$protected:{_options:{saveRotate:false,BLObjLoadMethodName:""},_zoomElement:undefined,_zoomContainer:undefined,_zoomImageContainer:undefined,_zoomImage:undefined,_zoomScale:$ws._const.FieldImageZoomPlugin.defaultZoom,_zoomStartScale:$ws._const.FieldImageZoomPlugin.defaultZoom,_zoomInElement:undefined,_zoomOutElement:undefined,_fullScreenElement:undefined,_zoomButtons:undefined,_fullScreenHandler:undefined,_isFullScreen:false,_zoomFakeOption:undefined,_zoomScaledToContainer:false,_rotate:0,_zoomDropDownDeferred:undefined,_zoomDropDown:undefined,_rotateTimer:undefined,_rotateSavedState:0},$condition:function(){return this._options.zoomEnabled===true;},_build:function(){this._initDropDownDeferred();this._createContainer();this._attachDropDown();this._bindElements();this._initZoomEvents();this._declareCommands();this._onPluginLoaded("ZoomPlugin");},_initDropDownDeferred:function(){this._zoomDropDownDeferred=new $ws.proto.Deferred();},_createContainer:function(){this._container.append('<div class="ws-fieldImage-zoom"><div class="ws-fieldImage-zoom-container"><div class="ws-fieldImage-zoom-image-container"></div></div><div class="ws-fieldImage-zoom-buttons-container"><span class="ws-fieldImage-zoom-button icon-16 icon-Unsuccess icon-disabled" title="Отдалить"></span><span class="ws-fieldImage-zoom-button icon-16 icon-Add icon-disabled" title="Приблизить"></span><div class="ws-fieldImage-zoom-select"></div><span class="ws-fieldImage-zoom-button icon-16 icon-Move2 icon-disabled" title="Вписать"></span>'+($ws._const.compatibility.fullScreen?'<span class="ws-fieldImage-zoom-button icon-16 icon-NewTab icon-disabled" title="Посмотреть в полноэкранном режиме"></span>':"")+'<span class="ws-fieldImage-zoom-button icon-16 icon-TurnL icon-disabled" title="Повернуть влево"></span><span class="ws-fieldImage-zoom-button icon-16 icon-TurnR icon-disabled" title="Повернуть вправо"></span></div></div>');},_attachDropDown:function(){var e=[],c=[],b=$ws._const.FieldImageZoomPlugin.zoomSteps,a=this;for(var d=0;d<b.length;++d){e.push(b[d]);c.push(this._zoomDropDownOptionText(b[d]));}$ws.core.attachInstance("Control/Field/FieldDropdown",{element:this._container.find(".ws-fieldImage-zoom-select"),data:{keys:e,values:c},name:this.getName()+"_dropdown",value:$ws._const.FieldImageZoomPlugin.defaultZoom,enabled:false,handlers:{onAfterLoad:function(){this.setEnabled(a._imageReady);a._zoomDropDown=this;a._zoomDropDownDeferred.callback();},onChange:function(f,g){a._zoomToScale(g);}}});},_bindElements:function(){this._zoomElement=this._container.children(".ws-fieldImage-zoom");this._zoomContainer=this._container.find(".ws-fieldImage-zoom-container");this._zoomImageContainer=this._container.find(".ws-fieldImage-zoom-image-container");this._zoomInElement=this._container.find(".icon-Add");this._zoomOutElement=this._container.find(".icon-Unsuccess");this._fullScreenElement=this._container.find(".icon-NewTab");this._zoomButtons=this._container.find(".ws-fieldImage-zoom-button");},toggleFullScreen:function(){if($ws._const.compatibility.fullScreen){if(this._getFullScreenElement()){if(document.cancelFullScreen){document.cancelFullScreen();}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen();}}}}else{var a=this._zoomElement.get(0);if(a.requestFullscreen){a.requestFullscreen();}else{if(a.mozRequestFullScreen){a.mozRequestFullScreen();}else{if(a.webkitRequestFullscreen){a.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}}}}}},_toggleZoomButtons:function(c){var a=$ws._const.FieldImageZoomPlugin.zoomSteps,b=Math.abs(c-a[a.length-1])>0.000001,d=Math.abs(c-a[0])>0.000001;this._zoomInElement.toggleClass("icon-disabled",!b).toggleClass("icon-primary action-hover",b);this._zoomOutElement.toggleClass("icon-disabled",!d).toggleClass("icon-primary action-hover",d);},_zoomDropDownOptionText:function(a){return Math.round(a*100)+"%";},_zoomAppendFakeOptions:function(b,a){this._zoomFakeOption=b;this._zoomDropDownDeferred.addCallback(function(){this._zoomDropDown.insertOption(b,this._zoomDropDownOptionText(b),a);this._zoomDropDown.setValue(b);}.bind(this));},_zoomSetSelectValue:function(a){this._zoomDropDownDeferred.addCallback(function(){if(this._zoomFakeOption){this._zoomDropDown.removeOption(this._zoomFakeOption);this._zoomFakeOption=undefined;}var c=$ws._const.FieldImageZoomPlugin.zoomSteps,e=c[0];for(var d=0;d<c.length;++d){var b=c[d];if(Math.abs(a-b)<0.000001){this._zoomDropDown.setValue(b);return;}else{if(b<a+0.000001){e=c[d+1];}}}this._zoomAppendFakeOptions(a,e);}.bind(this));},_getZoomSizes:function(d){var f=this._zoomContainer.width(),e=this._zoomContainer.height(),c=this.getRealWidth(),a=this.getRealHeight();if(this._rotate%2===1){var b=a;a=c;c=b;}if(d){c*=this._zoomScale;a*=this._zoomScale;}return{containerWidth:f,containerHeight:e,imageWidth:c,imageHeight:a};},_fixRotationPosition:function(b,a){if($ws._const.compatibility.cssTransform){if(this._rotate===1){b.left-=a.imageHeight;}else{if(this._rotate===2){b.top-=a.imageHeight;b.left-=a.imageWidth;}else{if(this._rotate===3){b.top-=a.imageWidth;}}}}},_zoomReposition:function(){var a=this._getZoomSizes(true),b={left:0,top:0};if(a.containerWidth>a.imageWidth){b.left=Math.round((a.containerWidth-a.imageWidth)/2);}if(a.containerHeight>a.imageHeight){b.top=Math.round((a.containerHeight-a.imageHeight)/2);}if(a.imageWidth<=a.containerWidth&&a.imageHeight<=a.containerHeight){this._zoomContainer.css("overflow","hidden");}else{this._zoomContainer.css("overflow","");}this._fixRotationPosition(b,a);this._zoomImageContainer.css(b);},_getRepositionMethod:function(){return this._zoomReposition;},_zoomToScale:function(c){this._zoomScale=c;this._zoomScaledToContainer=false;var f=this._container.find("img"),d=f.width(),e=Math.round(this.getRealWidth()*c),g=this._zoomContainer.width()/2,j=e/d,i=this._zoomContainer.scrollLeft(),k=f.height(),a=Math.round(this.getRealHeight()*c),l=this._zoomContainer.height()/2,b=a/k,h=this._zoomContainer.scrollTop();this._zoomContainer.css("overflow","hidden");this._zoomReposition();f.width(e);f.height(a);this._zoomContainer.scrollLeft((i+g)*j-g);this._zoomContainer.scrollTop((h+l)*b-l);this._zoomContainer.css("overflow","");this._zoomSetSelectValue(c);this._toggleZoomButtons(c);},_zoomModify:function(e){var b=$ws._const.FieldImageZoomPlugin.zoomSteps,a=b.length,g=this._zoomScale,d,f;for(var c=0;c<b.length;++c){if(Math.abs(g-b[c])<0.000001){d=c+e;}else{if(g+0.000001>b[c]){f=c;}}}if(d===undefined){if(e>0){d=f+e;}else{d=f+1+e;}}if(d>=a){d=a-1;}else{if(d<0){d=0;}}this._zoomToScale($ws._const.FieldImageZoomPlugin.zoomSteps[d]);},zoomOut:function(){this._zoomModify(-1);return true;},zoomIn:function(){this._zoomModify(1);return true;},resetZoom:function(){this._zoomToScale(1);return true;},zoomToContainer:function(){var c=this._getZoomSizes(),a=$ws._const.FieldImageZoomPlugin.zoomSteps,b=Math.min(c.containerWidth/c.imageWidth,c.containerHeight/c.imageHeight);if(b>a[a.length-1]){b=a[a.length-1];}if(b<a[0]){b=a[0];}this._zoomToScale(b);this._zoomScaledToContainer=true;},_rotateTo:function(b){var a=this._getImage();a.removeClass($ws._const.FieldImageZoomPlugin.rotateClasses[this._rotate]);this._rotate=b;a.addClass($ws._const.FieldImageZoomPlugin.rotateClasses[this._rotate]);this._zoomReposition();this._rotateStartSave();},_rotateBy:function(a){this._rotateTo((this._rotate+a+4)%4);},rotateLeft:function(){this._rotateBy(1);},rotateRight:function(){this._rotateBy(-1);},_zoomButtonClick:function(b){var a=this;return function(c){if(c.type==="click"&&!$(this).hasClass("icon-disabled")){b.call(a);}else{$(this).trigger("wsmousedown");}c.preventDefault();return false;};},_zoomGestureEnd:function(){this._zoomContainer.unbind(".wszoom");},_trimScale:function(b){var a=$ws._const.FieldImageZoomPlugin.zoomSteps;if(b<a[0]){b=a[0];}else{if(b>a[a.length-1]){b=a[a.length-1];}}return b;},_zoomGestureChange:function(a){var b=a.originalEvent.scale;if(b!==undefined){var c=this._trimScale(this._zoomStartScale*b);if(Math.abs(c-this._zoomScale)>0.000001){this._zoomToScale(c);a.preventDefault();a.stopPropagation();return false;}}return true;},_zoomGestureStart:function(){this._zoomStartScale=this._zoomScale;this._zoomContainer.bind("gesturechange.wszoom",this._zoomGestureChange.bind(this));this._zoomContainer.bind("gestureend.wszoom",this._zoomGestureEnd.bind(this));},_getFullScreenElement:function(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;},_zoomPostFullScreen:function(a){this._isFullScreen=a;if(a){this._zoomElement.addClass("full-screen").attr("tabindex","0").focus();}else{this._zoomElement.removeClass("full-screen").removeAttr("tabindex");if(!this._imageReady){this._fullScreenElement.removeClass("icon-primary action-hover").addClass("icon-disabled");}}if(this._zoomScaledToContainer){this.zoomToContainer();}else{this._zoomReposition();}this._zoomDropDownDeferred.addCallback(function(){this._zoomDropDown.toggleOptionsToContainer(a);}.bind(this));},_fullScreenChanged:function(){var a=this._getFullScreenElement();if($(a).is(this._zoomElement)){this._zoomPostFullScreen(true);}else{if(this._zoomElement.hasClass("full-screen")){this._zoomPostFullScreen(false);}}},_zoomKeyDown:function(a){if(a.which===$ws._const.key.esc){a.stopPropagation();}},_zoomContainerClick:function(a){a.stopImmediatePropagation();},_initZoomEvents:function(){this._fullScreenElement.bind("click mousedown",this._zoomButtonClick(this.toggleFullScreen));this._zoomOutElement.bind("click mousedown",this._zoomButtonClick(this.zoomOut));this._zoomInElement.bind("click mousedown",this._zoomButtonClick(this.zoomIn));this._container.find(".icon-Move2").bind("click mousedown",this._zoomButtonClick(this.zoomToContainer));this._container.find(".icon-TurnL").bind("click mousedown",this._zoomButtonClick(this.rotateLeft));this._container.find(".icon-TurnR").bind("click mousedown",this._zoomButtonClick(this.rotateRight));this._zoomContainer.bind("gesturestart",this._zoomGestureStart.bind(this));if($ws._const.compatibility.fullScreen){this._container.bind("keydown",this._zoomKeyDown.bind(this));this._zoomContainer.bind("click",this._zoomContainerClick.bind(this));$(document).bind("fullscreenchange mozfullscreenchange webkitfullscreenchange",this._fullScreenHandler=this._fullScreenChanged.bind(this));}},_getImageContainer:function(){return this._zoomImageContainer;},_getImage:function(){return this._container.find("img");},_declareCommands:function(){$ws.single.CommandDispatcher.declareCommand(this,"zoomIn",this.zoomIn);$ws.single.CommandDispatcher.declareCommand(this,"zoomOut",this.zoomOut);$ws.single.CommandDispatcher.declareCommand(this,"resetZoom",this.resetZoom);$ws.single.CommandDispatcher.declareCommand(this,"zoomToContainer",this.zoomToContainer);$ws.single.CommandDispatcher.declareCommand(this,"rotateLeft",this.rotateLeft);$ws.single.CommandDispatcher.declareCommand(this,"rotateRight",this.rotateRight);if($ws._const.compatibility.fullScreen){$ws.single.CommandDispatcher.declareCommand(this,"toggleFullScreen",this.toggleFullScreen);}},destroy:function(){if(this._fullScreenHandler){$(document).unbind("fullscreenchange mozfullscreenchange webkitfullscreenchange",this._fullScreenHandler);}this._rotateSave();},_disableButtons:function(){var a=this._zoomButtons.filter(".icon-primary");if(this._isFullScreen){a=a.filter(":not(.icon-NewTab)");}a.removeClass("icon-primary action-hover").addClass("icon-disabled");this._zoomDropDownDeferred.addCallback(function(){this._zoomDropDown.setEnabled(false);}.bind(this));},removeImage:function(){this._zoomScale=$ws._const.FieldImageZoomPlugin.defaultZoom;this._rotate=0;this._zoomScaledToContainer=false;this._disableButtons();this._zoomDropDownDeferred.addCallback(function(){this._zoomDropDown.setValue($ws._const.FieldImageZoomPlugin.defaultZoom);}.bind(this));},_rebuildImage:function(){if(!this._imageReady){return;}this._zoomButtons.filter(".icon-disabled").removeClass("icon-disabled").addClass("icon-primary action-hover");this._zoomDropDownDeferred.addCallback(function(){this._zoomDropDown.setEnabled(true);}.bind(this));this.zoomToContainer();},_onPluginLoaded:function(a){if(a==="CropPlugin"){this.subscribe("onCropInit",this._zoomFreezeImage);}},_zoomFreezeImage:function(){this._rotateTo(0);this._disableButtons();},_rotateClearTimer:function(){if(this._rotateTimer){clearTimeout(this._rotateTimer);this._rotateTimer=undefined;}},_rotateSave:function(){this._rotateClearTimer();if(this._rotateSavedState!==this._rotate&&this._options.saveRotate){var a=this._options.dataSource.readerParams.linkedObject,h=this._options.filterParams["ИдО"],e=h.fieldName,b=this._options.BLObjLoadMethodName,f=a+"."+this._options.dataSource.readerParams.queryName,i,c=(4-(this._rotate-this._rotateSavedState+4)%4)*90,d;if(h instanceof Object){i=this.getLinkedContext().getValue(e);}else{i=h;}d={readMethod:f,writeMethod:b,degrees:c,ID:i};this._rotateSavedState=this._rotate;var g=new $ws.proto.BLObject("ImageEditingPython"),j=g.call("ПовернутьФото",d,$ws.proto.BLObject.RETURN_TYPE_ASIS);this.getTopParent().addPendingOperation(j);}},_rotateStartSave:function(){this._rotateClearTimer();this._rotateTimer=setTimeout(this._rotateSave.bind(this),$ws._const.FieldImageZoomPlugin.saveRotateDelay);}});