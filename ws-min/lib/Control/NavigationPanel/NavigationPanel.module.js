$ws.declareModule({namespace:"SBIS3.CORE",name:"NavigationPanel",imports:["SBIS3.CORE.Control","SBIS3.CORE.Marker"]},function(a){$ws._const.NavigationPanel={padding:16};$ws.proto.NavigationPanel=a.Control.extend({$protected:{_options:{saveState:true,dataSource:{},behavior:"default",autoHeight:false,altTreeNameFld:"",hierColumn:"",filterParams:{},hasMarker:true,cssClassName:"ws-accordion ws-navigation-panel"},_dReady:null,_defTopParent:null,_roots:[],_areaHeight:[],_recordSet:null,_activeElement:null,_onAfterLoadHandler:null,_ftime:false,_activeGroup:null},$constructor:function(){this._publish("onElementClick","onReplaceMarker");var c=this;this._onAfterLoadHandler=function(i,h,f,g){if(!f){$ws.single.ioc.resolve("ILogger").error("NavigationPanel",g.message);c._dReady.errback();return;}c._recordSet=h;c._roots=h.recordChilds(null);if(!c._hasMarkup()){if(!$ws.proto.NavigationPanel.__markupTemplate){$ws.proto.NavigationPanel.__markupTemplate=doT.template(c._createMarkup());}c._container.html($ws.proto.NavigationPanel.__markupTemplate({rs:h,opt:c._options}));}c._bindInternals();if(c._activeElement!==null){if(!c._isValidRecord(c._activeElement)){c._activeElement=c._activeGroup;c._ftime=false;}c.openElement(c._activeElement,c._ftime,true);}else{if(c._roots.length){c._activeElement=c._roots[0];c._openGroup(c._activeElement);c._selfNotify(c._recordSet.getRecordByPrimaryKey(c._activeElement),true);}}c._dReady.callback();c._ftime=true;};this._dReady=new $ws.proto.Deferred();this._defTopParent=new $ws.proto.Deferred();this.getTopParent().subscribe("onReady",function(){c._dReady.addCallback(function(g){if(c._options.hasMarker&&c._activeElement){var f=c.getContainer().find('[element="'+c._activeElement+'"]'),e=c.elementIsRoot(c._activeElement)?{}:{left:-f.position().left,width:$ws._const.NavigationPanel.padding+f.position().left};$ws.single.Marker.positionToElement(f,e);}c._defTopParent.callback();return g;});});if(this._options.autoHeight){this._container.css({height:"auto","overflow-y":"visible"});}this._options.dataSource.filterParams={"Разворот":"С разворотом","ЗаголовокИерархии":this._options.altTreeNameFld};this._options.dataSource.filterParams=$ws.core.merge(this._options.dataSource.filterParams,this._options.filterParams,{rec:true});this._options.dataSource.hierarchyField=this._options.hierColumn;var b=this._events.onElementClick;this.unbind("onElementClick");this.subscribe("onElementClick",function(g,h,f){this._notify("onStateChanged",h.getKey(),!f);});for(var d in b){if(b.hasOwnProperty(d)){this.subscribe("onElementClick",b[d]);}}this.subscribe("onReplaceMarker",function(i,h){var g=this.getContainer().find('[element="'+h+'"]');if(this._options.hasMarker&&this._defTopParent.isReady()){var f=c.elementIsRoot(h)?{}:{left:-g.position().left,width:15+g.position().left};$ws.single.Marker.positionToElement(g,f);}});$ws.single.ControlStorage.waitChildByName(this.getName()).addCallback(function(){c._notify("onStateChanged");c._createRecordSet($ws.core.clone(c._options.dataSource),c._onAfterLoadHandler);});},refresh:function(){this._dReady=new $ws.proto.Deferred();this._areaHeight=[];this._createRecordSet($ws.core.clone(this._options.dataSource),this._onAfterLoadHandler);},_isValidRecord:function(c){try{this._recordSet.getRecordByPrimaryKey(c);return true;}catch(b){return false;}},_createRecordSet:function(b,c){b.handlers=b.handlers||{};b.handlers.onAfterLoad=c;new $ws.proto.RecordSet(b);},_bindInternals:function(){var b=this;this._container.find(".ws-accordion-wr>span").hover(function(c){$(this).parent().toggleClass("ws-accordion-wr-hover",c.type=="mouseenter");}).click(function(){var d=$(this).attr("element"),c=b._recordSet.getRecordByPrimaryKey(d);b._activeElement=d;b._openGroup(d);b._selfNotify(c,true);});this._container.find(".ws-navigation-panel-item span").click(function(){b.openElement($(this).attr("element"),undefined,true);});},openElement:function(e,b,g){var d=this._container.find('[element="'+e+'"]'),f=d.parent(),c=f.hasClass(".ws-accordion-wr");if(c){this._openGroup(e);}else{this._openGroup(d.parents(".ws-accordion-wr").children("span").attr("element"));d.parent().children("ul.ws-navigation-panel-list").show();d.parents(".ws-navigation-panel ul.ws-navigation-panel-list").show();d.parentsUntil(".ws-navigation-panel").siblings().find("ul.ws-navigation-panel-list").hide();}this._notifyOnSizeChanged(this,this);this._activeElement=e;if(!b){this._selfNotify(this._recordSet.getRecordByPrimaryKey(e),g);}},applyState:function(c){var b=this;if(this._recordSet===null){this._activeElement=c;}else{this._dReady.addCallback(function(){b.openElement(c,undefined,true);});}},openGroup:function(b){this.openElement(b);},_openGroup:function(e){this._activeGroup=e;if(this._container.find('[element="'+e+'"]').hasClass("ws-accordion-active")){return;}this._closeActiveGroup();var b=this._container.find('[element="'+e+'"]').parent().addClass("ws-accordion-wrapper-active"),d=b.children(".ws-accordion-element-title").addClass("ws-accordion-active"),c=b.children(".ws-accordion-element-area").show();c.children("ul.ws-navigation-panel-list").show();this._container.find(".ws-accordion-element-title").trigger("mouseleave");if(!this._options.autoHeight&&!this._areaHeight[e]){this._areaHeight[e]=this._container.outerHeight()-this._roots.length*d.outerHeight()-this._container.find(".ws-accordion-shadow").height()-parseInt(c.css("padding-top"),10);if(c.height()<this._areaHeight[e]){c.height(this._areaHeight[e]);}}if(this._options.behavior=="dragToTop"&&b.prev().length>0){this._dragToTop(b);}this._notifyOnSizeChanged(this,this);},_dragToTop:function(b){this._container.find(".ws-accordion-wr").first().before(b);},_closeActiveGroup:function(){this._container.find(".ws-accordion-wrapper-active").removeClass("ws-accordion-wrapper-active").children(".ws-accordion-element-title").removeClass("ws-accordion-active").end().children(".ws-accordion-element-area").hide().end().find("ul.ws-navigation-panel-list").hide();},elementIsRoot:function(b){return !!(Array.indexOf(this._roots,String(b))!=-1);},getActiveElement:function(){return this._container.find('[element="'+this._activeElement+'"]');},getActiveRecord:function(){var b=null;if(this._recordSet instanceof $ws.proto.RecordSet){try{b=this._recordSet.getRecordByPrimaryKey(this._activeElement);}catch(c){b=null;}}return b;},_selfNotify:function(b,c){this._notifyBatchDelayed("onReplaceMarker",b.getKey());this._notifyBatchDelayed("onElementClick",b,c);},_createMarkup:function(b){return this._extendMarkup(b,"   {{var rootElements=it.rs.recordChilds(null);}}   {{for (var i = 0, l = rootElements.length; i < l; i++){}}   {{var id = rootElements[i], record = it.rs.getRecordByPrimaryKey(rootElements[i]);}}   <div id='{{=it.opt.id}}-{{=id}}' class='ws-accordion-wr'>   <span class='ws-accordion-element-title' element='{{=id}}'>{{=record.get(it.opt.altTreeNameFld)}}</span>   <div class='ws-accordion-element-area'>   {{var html = (function f(key){}}   {{var childs=it.rs.recordChilds(key),m=[];}}   {{if(childs.length)m.push('<ul id=\"ws-navigation-panel-list-'+ key +'\" class=\"ws-navigation-panel-list\">');}}   {{for (var j=0,len=childs.length;j<len;j++){}}   {{var rec = it.rs.getRecordByPrimaryKey(childs[j]);}}   {{m.push('<li id=\"ws-navigation-panel-item-'+ childs[j] +'\"  class=\"ws-navigation-panel-item\"><span element=\"'+ childs[j] +'\">'+ rec.get(it.opt.altTreeNameFld) +'</span>');}}   {{m.push(f(childs[j]));}}   {{m.push('</li>');}}   {{}}}   {{ if(childs.length)m.push('</ul>');}}   {{return m.join('');}}   {{})(id);}}   {{=html}}   </div>   <div class='ws-accordion-shadow'></div>   </div>   {{}}}   ");},_redraw:function(b){if((b&&!this._hasMarkup())||!b){if(!$ws.proto.NavigationPanel.__markupTemplate){$ws.proto.NavigationPanel.__markupTemplate=doT.template(this._getMarkupTemplate());}this._container.html($ws.proto.NavigationPanel.__markupTemplate(this._options));}}});return $ws.proto.NavigationPanel;});