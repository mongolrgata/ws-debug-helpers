$ws.declareModule({namespace:"SBIS3.CORE",name:"TreeView",imports:["SBIS3.CORE.HierarchyViewAbstract"]},function(a){$ws._const.Browser=$ws._const.Browser||{};$ws._const.TreeView={recordsMoveOffset:{top:5,left:5},treeLevelAttribute:"treelevel",hierarchyIcons:"img/browser/tree_icons.gif"};$ws.single.DependencyResolver.register("SBIS3.CORE.TreeView",[],"SBIS3.CORE.DataViewAbstract/SBIS3.CORE.TableView/SBIS3.CORE.HierarchyViewAbstract");$ws.proto.TreeView=a.extend({$protected:{_options:{selectChilds:"",display:{showRoot:false,rootName:"Все",hierarchyIcons:$ws._const.TreeView.hierarchyIcons}},_selectAfterPathLoad:true,_fullTreeExpand:false,_expanded:{},_loaded:{},_rootNode:null,_currentRootId:null,_turn:"",_rowTemplate:undefined,_rowOptionsDefault:[],_selectedPart:{},_disabledEditCells:{},_hierColumnParentId:"Раздел",_hierColumnIsLeaf:"Раздел@",_hierColumnHasChild:"Раздел$",_useLoadChildsFlag:false,_hasFirstRequest:false,_systemParams:{"ВидДерева":"",HierarchyField:"","Разворот":"","ЗаголовокИерархии":"","_ЕстьДочерние":false},_keysWeHandle:[$ws._const.key.enter,$ws._const.key.down,$ws._const.key.up,$ws._const.key.del,$ws._const.key.insert,$ws._const.key.f3,$ws._const.key.esc,$ws._const.key.pageUp,$ws._const.key.minus,$ws._const.key.pageDown,$ws._const.key.space,$ws._const.key.q,$ws._const.key.n,$ws._const.key.left,$ws._const.key.right,$ws._const.key.b,$ws._const.key.v]},$constructor:function(){this._publishTreeEvents();this._createRowTemplate();this._initLoading();},_filterState:function(b){$ws.proto.TreeView.superclass._filterState.apply(this,arguments);if(b[this._hierColumnParentId]!==undefined){delete b[this._hierColumnParentId];}},_publishTreeEvents:function(){this._publish("onDragStart","onDragMove","onDragStop","onFolderOpen","onFolderClose");},_initLoading:function(){var b=this;this._dReady.addCallback(function(){var d=b._currentFilter,c=b._options.display.expand,e={onlyFolders:"Только узлы",items:"Только листья"};if(c){d["Разворот"]="С разворотом";d["ВидДерева"]=c in e?e[c]:"С узлами и листьями";}if(b._hasFirstRequest){b.setQuery(d);}});},_initKeys:function(){$ws.proto.TreeView.superclass._initKeys.apply(this,arguments);this._registerShortcut($ws._const.key.left,$ws._const.modifiers.nothing,this._keyLeft);this._registerShortcut($ws._const.key.right,$ws._const.modifiers.nothing,this._keyRight);},_checkActiveRecord:function(d){var b=this.getActiveRecord();if(b){var c=b.getKey();d.call(this,b,c);}},_keyLeft:function(){if(this.isEnabled()){var b=this;this._checkActiveRecord(function(c,d){if(b._expanded[d]){b._processTreeClick(d,true);}else{var e=c.get(b._hierColumnParentId);if(b._haveRow(e)){b.setActiveRow(b._findRow(e));}}});}},_keyRight:function(){if(this.isEnabled()){var b=this;this._checkActiveRecord(function(c,e){if(b._expanded[e]){var d=b._currentRecordSet.recordChilds(e);if(d.length&&b._haveRow(d[0])){b.setActiveRow(b._findRow(d[0]));}}else{b._processTreeClick(e,false);}});}},_clickOnFolder:function(d,c,b){this._processElementClick(d,c,b);},_elementActivated:function(d,e){var b=this.getActiveRecord(d),c=b.hasColumn(this._hierColumnIsLeaf)?b.get(this._hierColumnIsLeaf):false;if(this._selectMode&&c&&this._options.folderLinkAction=="activate"){this.confirmSelection([b]);return;}$ws.proto.TreeView.superclass._elementActivated.apply(this,arguments);},toggleBranch:function(b){this._processTreeClick(b,!!this._expanded[b]);},_processElementClick:function(e,d,c){var b=this._processTreeClick(d,!!this._expanded[d]);if(!b){this._notifySetCursor(this._body.find('[rowkey="'+d+'"]'),c);}return b;},_initEvents:function(){$ws.proto.TreeView.superclass._initEvents.apply(this,arguments);var b=this,c,d=this._body.parent()[0];var e=function(i){i.stopPropagation();var j=$(this).parents("tr"),h=j.attr("rowkey"),g=b._currentRecordSet.contains(h)?b._currentRecordSet.getRecordByPrimaryKey(h):undefined;if(b.isEnabled()){var f=b._notify("onRowClick",j,g,b._columnMap[0].title,b._columnMap[0].field);if(f!==false){b._processElementClick(j,h,g);}else{b._notifySetCursor(j,g);}}};$(".ws-browser-expander",d).live("click",e);},_createRowTemplate:function(){this._rowTemplate=document.createElement("tr");},_mapColumns:function(){var c=this._options.display.columns,b=this._currentRecordSet&&this._currentRecordSet.getColumns(),d=c?c:b;if(d){$ws.proto.TreeView.superclass._mapColumns.apply(this,arguments);}},_cellFirstTemplate:function(b){var c=doT.template('<td class="{{=it.cellClassName}}"><div class="{{=it.containerClassName}}" style="padding-left: {{=it.padding}}px;">{{? it.expanderClassName }}<span class="{{=it.expanderClassName}}"></span>{{?}}<div class="ws-browser-text-container">{{=it.data}}</div></div></td>');this._cellFirstTemplate=c;return c(b);},_cellGeneralTemplate:function(b){var c=doT.template('<td class="{{=it.cellClassName}}"><div class="{{=it.containerClassName}}">{{=it.data}}</div></td>');this._cellGeneralTemplate=c;return c(b);},_rowHTMLTemplate:function(b){var c=doT.template('<tr class="{{=it.className}}" rowkey="{{=it.rowkey}}" treelevel="{{=it.level}}" parentId="{{=it.parentId}}">{{? it.useCheckbox}}<td class="{{? it.checkbox}} ws-browser-checkbox-holder {{?}} "><div class="ws-browser-cell-paddings"><div class="ws-browser-cell-container">{{? it.checkbox }} <span class="ws-browser-checkbox"/> {{?}}</div></div></td>{{?}}{{~it.cells :cell:index }}{{ if(index === 0){ out += this._cellFirstTemplate(cell);}else{out += this._cellGeneralTemplate(cell);} }}{{~}}</tr>');this._rowHTMLTemplate=c;return c.call(this,b);},_rowHTMLString:function(h,c){var k=h.getKey(),d=["ws-browser-table-row ws-visible"],g=h.get(this._hierColumnIsLeaf),b=this._options.editMode,e={cells:[]};if(typeof k=="string"){k=k.replace(/'/g,"&#039;");}if(this._options.display.hasZebra){d.push("rE");}if(this._selected[k]!==undefined){d.push("ws-browser-selected");this._selectedRecords.push(h);}if(this._selectedPart[k]!==undefined){d.push("ws-browser-selected-part");}e.className=d.join(" ");e.rowkey=k;e.level=c;e.parentId=h.get(this._hierColumnParentId);e.useCheckbox=this._options.display.showSelectionCheckbox&&this._options.useSelection!==false;e.checkbox=false;if(this._options.selectionType==="all"||this._options.selectionType==="node"&&g||this._options.selectionType==="leaf"&&!g){e.checkbox=true;}for(var f=0,j=this._columnMap.length;f<j;++f){e.cells.push(this._cellTemplateOptions(h,c,b,f,g,f,false));}return this._rowHTMLTemplate.call(this,e);},_createTR:function(h,c){var n=this._rowTemplate.cloneNode(false),l=h.getKey(),e=["ws-browser-table-row ws-visible"],g=h.get(this._hierColumnIsLeaf),d=[],b=this._options.editMode;if(this._options.display.hasZebra){e.push("rE");}if(this._selected[l]!==undefined){e.push("ws-browser-selected");}if(this._selectedPart[l]!==undefined){e.push("ws-browser-selected-part");}n.className=e.join(" ");n.setAttribute("rowkey",l);n.setAttribute("treelevel",c);n.setAttribute("parentId",h.get(this._hierColumnParentId));if(this._options.display.showSelectionCheckbox&&this._options.useSelection!==false){var k=this._options.selectionType==="all"||this._options.selectionType==="node"&&g||this._options.selectionType==="leaf"&&!g;d.push(['<td class="',k?"ws-browser-checkbox-holder":"",'"><div class="ws-browser-cell-paddings">','<div class="ws-browser-cell-container">',k?'<span class="ws-browser-checkbox"/>':"","</div>","</div>","</td>"].join(""));}for(var f=0,j=this._columnMap.length;f<j;++f){var m=this._cellTemplateOptions(h,c,b,f,g);if(f===0){d.push(this._cellFirstTemplate(m));}else{d.push(this._cellGeneralTemplate(m));}}if($.browser.msie&&(!$ws._const.browser.isModernIE||$ws._const.browser.isIE9)){$(n).html(d.join(""));}else{n.innerHTML=d.join("");}this._rowsMap[l]=$(n);if(this._options.display.rowRender){this._options.display.rowRender.apply(this,[h,$(n)]);}return n;},_drawBodyCycle:function(){var c=$("<tbody/>");this._selectedRecords=[];this._rowsMap={};if(this._options.display.expand){this._expanded[this._rootNode]=2;}if(this._options.display.showRoot){this._createRoot(c.get(0));}var b=this._body;this._body=c;this._drawBranch(this._rootNode);if(this._options.display.allowHorizontalScroll){this._emptyDataScroller.toggleClass("ws-hidden",this._count);}b.remove();this._data.append(this._body);},applyTurnTree:function(c,b){if(this._options.display.fixedExpand){return;}if(c){this._fullTreeExpand=true;this._expandTreeAll(b,this._rootNode);}else{this._fullTreeExpand=false;this._closeAll(b);}},_expandAll:function(c,b){},_expandTreeAll:function(b,d){this._expanded[d]=2;this._currentFilter["Разворот"]="С разворотом";if(!b){if(this._options.display.partiallyLoad){var c=this;this._clearBranch(d);this._updateActiveRow();this._toggleExpander(d,true);this._loaded[d]=true;this._currentRecordSet.loadNode(d,false,0,true,undefined,{browserFolder:true}).addCallback(function(){c._hideLoadingIndicator();c._clearBranch(d);var e=c._drawBranch(d);c._notify("onFolderOpen",d,e.keys,e.rows);c._heightChangedIfVisible();});}else{this._clearBranch(d);this._openBranch(d);this._heightChangedIfVisible();}}},openAll:function(){var b=this;$(this._body).find("tr.ws-browser-folder").each(function(){var c=$(this).attr("rowkey");c=c==="null"?null:c;b._expanded[c]=1;});this._reloadBody();},hideBranch:function(b){if(this._turn===""){this._processTreeClick(b,true);}},isTreeFolderExpanded:function(b){return !!this._expanded[b];},_showBranchAfterPathLoad:function(b,c){if(c){this._selectAfterPathLoad=b;}},_showActiveFolderOrElement:function(c,h){if(this._isIdEqual(c,this._rootNode)){if(!this._expanded[this._rootNode]){if(this._haveRow(c)){this._processTreeClick(c,false);}if(!h){this.setActiveElement(this._body.find('tr[rowkey="'+c+'"]'));}}return undefined;}var j=[],e=c,g,b=this._hierColumnIsLeaf,d=this._hierColumnParentId;if(e&&e!=this._rootNode&&!this._currentRecordSet.contains(e)){return undefined;}g=this._currentRecordSet.getRecordByPrimaryKey(e);if(!g.get(b)){e=g.get(d)||null;}while(e&&e!=this._rootNode){j.push(e);if(this._currentRecordSet.contains(e)){g=this._currentRecordSet.getRecordByPrimaryKey(e);}else{throw new Error("Something wrong with the showBranch!");}e=g.get(d)||null;}if(this._options.mode==="navigationMode"){this._closeOtherBranches(c);}for(var f=j.length-1;f>=0;--f){g=this._currentRecordSet.getRecordByPrimaryKey(j[f]);if(g.get(this._hierColumnIsLeaf)===false){c=j[f];break;}if(!this._expanded[j[f]]){this._expanded[j[f]]=1;}}if(this._options.display.partiallyLoad&&this._currentRecordSet.getRecordByPrimaryKey(c).get(b)&&!this._loaded[c]){var l=this._currentRecordSet.loadNode(c,false),k=this;if(!h){l.addCallback(function(){k.setActiveElement(k._body.find('tr[rowkey="'+c+'"]'));});}return l;}else{this._drawBody();this._updatePager();}if(!h){this.setActiveElement(this._body.find('tr[rowkey="'+c+'"]'));}return undefined;},_pathRecordSetLoaded:function(e,f,b){this._wayRS=f;if(b){var k=this._wayRS.getWay(),d,h=[];if(this._rootNode&&k!==null&&!k.contains(this._rootNode)){return;}k.rewind();while((d=k.next())!==false){if(d.get(this._hierColumnIsLeaf)===false){break;}var g=d.getKey();h.push(g);this._expanded[g]=1;this._loaded[g]=true;}if(h.length){var c=this._wayRS.getLoadingId();if(c instanceof Array){c=c[0];}if(this._selectAfterPathLoad===true){this._hovered=c;this._activeElement=undefined;}else{this._selectAfterPathLoad=true;}this._systemParams[this._hierColumnParentId]=h;var j=this._currentRecordSet.loadNode(h,false);if(!this._wayRSDeferred.isReady()){this._wayRSDeferred.dependOn(j);}if(this._options.mode==="navigationMode"){var i=this;j.addCallback(function(){i._closeOtherBranches(h[h.length-1]);i.refresh();});}}else{this._wayRSDeferred.callback();}}},isHierarchyMode:function(){return true;},_updateActiveRow:function(){if(this._activeElement&&this._activeElement.closest("html").size()===0||!this._activeElement&&this._hovered){var b=(this._hovered&&this._haveRow(this._hovered))?this._findRow(this._hovered):undefined;this.setActiveElement(b,false,true);}},_clearBranch:function(b){var e,f,c,d;if(this._haveRow(b)){e=this._findRow(b);c=parseInt(e.attr($ws._const.TreeView.treeLevelAttribute),10)||0;e=e.next();}else{if(this._isIdEqual(b,this._rootNode)){c=-1;e=this._body.find("tr:first");}else{return;}}while(e.length){d=parseInt(e.attr($ws._const.TreeView.treeLevelAttribute),10)||0;if(d<=c){break;}this._rowsMap[e.attr("rowkey")]=undefined;f=e;e=e.next();f.remove();}},_closeBranch:function(b){this._toggleExpander(b,false);this._clearBranch(b);this._notify("onFolderClose",b);},_drawFolder:function(b,d,f,k){var h=this._currentRecordSet.recordChilds(b);for(var c=0,g=h.length;c<g;++c){var e=this._currentRecordSet.getRecordByPrimaryKey(h[c]),j=e.getKey();if(e.get(this._hierColumnIsLeaf)&&this._expanded[j]===undefined&&(this._expanded[b]===2||f)&&(!this._useLoadChildsFlag||this._currentRecordSet.recordChilds(j).length>0||!e.get(this._hierColumnHasChild))){this._expanded[j]=1;}k(e,d);if(e.get(this._hierColumnIsLeaf)===true&&this._expanded[j]){this._drawFolder(j,d+1,this._expanded[b]===2||f,k);}}if(this._expanded[b]===2){this._expanded[b]=1;}},_drawBranch:function(b){var j=this._haveRow(b)&&this._findRow(b),c=j&&parseInt(j.attr($ws._const.TreeView.treeLevelAttribute),10)+1||0,g=document.createDocumentFragment(),m={keys:[],rows:$()},k=this;if(this._body[0].childNodes.length){this._drawFolder(b,c,false,function(i,n){var o=k._createTR(i,n);m.keys.push(i.getKey());m.rows.push(o);g.appendChild(o);});}else{var e="";this._drawFolder(b,c,false,function(i,n){e+=k._rowHTMLString(i,n);});this._body.html(e);var l=this._body.children();for(var d=0,f=l.length;d<f;++d){var h=l.eq(d).attr("rowkey");m.keys.push(h);m.rows.push(l.get(d));this._rowsMap[h]=l.eq(d);if(this._options.display.rowRender){this._options.display.rowRender.apply(this,[this._currentRecordSet.getRecordByPrimaryKey(h),l.eq(d)]);}}}if(j&&j.length){this._body[0].insertBefore(g,j[0].nextSibling);}else{this._body.append(g);}this._count=this._body.get(0).childNodes.length;this._updatePager();this._updateActiveRow();return m;},_toggleExpander:function(c,b){var d=this._haveRow(c)&&this._findRow(c);if(d){d.find(".ws-browser-expander").toggleClass("minus",b).toggleClass("plus",!b);}},_openBranch:function(b){if(this._haveRow(b)){this._toggleExpander(b,true);}var c=this._drawBranch(b);this._notify("onFolderOpen",b,c.keys,c.rows);},_processTreeClick:function(g,c){if(this._options.display.fixedExpand===true&&this._options.mode!=="navigationMode"){return null;}var b,f=false,j=this._currentRecordSet.contains(g),e=j&&this._currentRecordSet.getRecordByPrimaryKey(g).get(this._hierColumnIsLeaf)||!j;if(this._options.mode==="navigationMode"&&!!this._expanded[g]){return null;}if(c){this._expanded[g]=0;}else{if(e){this._expanded[g]=1;}}if(this._options.mode==="navigationMode"){f=this._closeOtherBranches(g);if(f){for(var h in this._expanded){if(this._expanded.hasOwnProperty(h)&&this._expanded[h]===0){this._closeBranch(h);}}}}if(j&&!e){this._heightChangedIfVisible();return null;}if(c){this._closeBranch(g);this._heightChangedIfVisible();b=null;}else{if(this._options.display.partiallyLoad&&!this._loaded[g]){this._loaded[g]=true;this._toggleExpander(g,true);var d=this;b=this._currentRecordSet.loadNode(g,false,undefined,undefined,undefined,{browserFolder:true}).addCallback(function(k){d._hideLoadingIndicator();if(d._expanded[g]&&k){var i=d._drawBranch(g);d._notify("onFolderOpen",g,i.keys,i.rows);d._heightChangedIfVisible();}});}else{this._openBranch(g);this._heightChangedIfVisible();b=null;}}this._updatePager();return b?b:null;},_closeOtherBranches:function(c){var g=this._getItemParents(c),b={},f=false;for(var e=0;e<g.length;++e){b[g[e]]=true;}for(e in this._expanded){if(this._expanded.hasOwnProperty(e)){if(this._expanded[e]&&!b[e]){this._expanded[e]=0;f=true;}}}for(e=1;e<g.length;++e){if(g.hasOwnProperty(e)){if(!this._expanded[g[e]]){var d=this._currentRecordSet.contains(g[e]);if(d&&this._currentRecordSet.getRecordByPrimaryKey(g[e]).get(this._hierColumnIsLeaf)||!d){this._expanded[g[e]]=1;f=true;}}}}return f;},_closeAll:function(b){this._expanded={};if(this._options.display.partiallyLoad){this._systemParams["Разворот"]="Без разворота";this._currentFilter["Разворот"]="Без разворота";}if(!b){this._drawBody();}},closeAll:function(){for(var b in this._expanded){if(this._expanded.hasOwnProperty(b)){if(!this._isIdEqual(b,this._rootNode)){this._clearBranch(b);}}}this._expanded={};this._heightChangedIfVisible();},_updateHierColumnParams:function(b){this._hierColumnParentId=b;this._hierColumnIsLeaf=b+"@";this._hierColumnHasChild=b+"$";},_configChecking:function(){this._options.display.usePaging="";$ws.proto.TreeView.superclass._configChecking.apply(this,arguments);this._options.display.showPathSelector=false;this._rootNode=this._getDefaultRootNode();if(this._options.display.viewMode=="foldersTree"){this.setLoadChildFlag(true);}if(this._options.display.partiallyLoad){this._options.selectChilds="";}},_getDefaultRootNode:function(){if(this._options.display.rootNode!==null&&typeof(this._options.display.rootNode)==="object"){var c=this.getLinkedContext(),d=this._options.display.rootNode.fieldName,b;if((b=c.getValue(d))!==undefined){return b;}}return this._options.display.rootNode;},_prepareDataSource:function(){$ws.proto.TreeView.superclass._prepareDataSource.apply(this,arguments);this._options.dataSource.hierarchyField=this._options.display.hierColumn;this._hasFirstRequest=(this._options.dataSource.firstRequest||this._options.dataSource.firstRequest===undefined);if(this._options.optionsSaver.display){this._options.dataSource.usePages="parts";this._options.dataSource.rowsPerPage=1000;}this._options.dataSource.firstRequest=false;if(this._options.dataSource.filterParams[this._hierColumnParentId]===""){this._options.dataSource.filterParams[this._hierColumnParentId]=this._rootNode;}},_prepareSystemParams:function(b){if(b[this._hierColumnParentId]===undefined){b[this._hierColumnParentId]=this._rootNode;}return $ws.proto.TreeView.superclass._prepareSystemParams.apply(this,arguments);},_onDataLoaded:function(f,e,b,d,c){if(!c||!c.browserFolder){$ws.proto.TreeView.superclass._onDataLoaded.apply(this,arguments);}},setRootNode:function(e,c){var d=this,b=new $ws.proto.Deferred();this._dReady.addCallback(function(){d._rootNode=d._currentRootId=e;d._currentRecordSet.updateInitialParameter(d._hierColumnParentId,e+"");if(c){b.callback();}else{b.dependOn(d.reload());}});return b;},reload:function(){var g=this.getQuery(true),f=!this._options.display.partiallyLoad||this._options.display.expand||this._fullTreeExpand;g["Разворот"]=f?"С разворотом":"Без разворота";if(f){g[this._hierColumnParentId]=this._rootNode;}else{g[this._hierColumnParentId]=[];this._loaded={};for(var e in this._expanded){if(this._expanded.hasOwnProperty(e)){var b=this._expanded[e]?1:2,d=e,c;while(!this._isIdEqual(d,this._rootNode)){if(!this._currentRecordSet.contains(d)){b=0;break;}c=this._currentRecordSet.getRecordByPrimaryKey(d);d=c.get(this._hierColumnParentId);if(d!=this._rootNode&&!this._expanded[d]){b=0;break;}}if(b===1){g[this._hierColumnParentId].push(e);this._loaded[e]=true;}else{if(b===0){delete this._expanded[e];}}}}if(!this._options.display.showRoot&&!this._loaded[this._rootNode]){this._loaded[this._rootNode]=true;if(g[this._hierColumnParentId].length===0){g[this._hierColumnParentId]=this._rootNode;}else{g[this._hierColumnParentId].push(this._rootNode);}}else{if(g[this._hierColumnParentId].constructor===Array&&g[this._hierColumnParentId].length===0){this._expanded[this._rootNode]=true;g[this._hierColumnParentId]=this._rootNode;}}}return this._runQuery(g,true);},setLoadChildFlag:function(b){this._useLoadChildsFlag=b;this._systemParams["_ЕстьДочерние"]=b;},_getNodeForRecordUpdate:function(b){if(!this._options.display.partiallyLoad){return this._rootNode;}return b.get(this._hierColumnParentId);},isTree:function(){return true;},_insertRowPosition:function(e,d){var f;if(e instanceof Object&&"jquery" in e){var c=e.attr("rowkey");if(this._currentRecordSet.contains(c)){var b=this._currentRecordSet.getRecordByPrimaryKey(c);if(d&&d.altKey){if(b.get(this._hierColumnIsLeaf)){f=c;}else{return false;}}else{f=b.get(this._hierColumnParentId);}}}if(f===undefined){f=this._rootNode;}return f;},_onBeforeSaveRecordDialog:function(e,b){if(b.hasColumn(this._hierColumnParentId)){var d=b.get(this._hierColumnParentId);if(this._haveRow(d)){var c=new $ws.proto.Deferred();$ws.helpers.callbackWrapper(this.showBranch(d),function(){c.callback();});e.setResult(c);}}$ws.proto.TreeView.superclass._onBeforeSaveRecordDialog.apply(this,arguments);},_reloadAfterRecordsChange:function(d){var c;if(this._options.display.partiallyLoad){if(d.length){if(d.length>1){var f={};for(var e=0;e<d.length;++e){var b=d[e];f[b.get(this._hierColumnParentId)]=true;}c=Object.keys(f);}else{c=d[0].get(this._hierColumnParentId);}}}else{c=this._rootNode;}this._currentRecordSet.loadNode(c,undefined,this._currentRecordSet.getPageNumber(),!this._options.display.partiallyLoad);},_getRowOptions:function(){var c=$ws.proto.TreeView.superclass._getRowOptions.apply(this,arguments),b=this;if(this._options.editDialogTemplate){c.unshift(["Добавить лист (Insert)","sprite:icon-16 icon-Add icon-primary",function(){b._insertChildRecordItem();},"addItem"]);}if(this._options.editBranchDialogTemplate){c.unshift(["Добавить папку (Ctrl + Insert)","sprite:icon-16 icon-CreateFolder icon-primary",function(){b._insertChildRecordFolder();},"addFolder"]);}return c;},_getCellTextAlign:function(b){return this._getCellGeneralTextAlign(b);},_cellTemplateOptions:function(b,h,g,f,d){var e=$ws.proto.TreeView.superclass._cellTemplateOptions.apply(this,arguments),c;if(this._options.display.viewMode==="foldersTree"){c=b.get(this._hierColumnHasChild);}else{c=true;}if(c){e.expanderClassName=d?"ws-browser-expander-container ws-browser-icon ws-browser-expander "+(this._expanded[b.getKey()]?"minus":"plus"):"";}e.checkbox=e.checkbox?"ws-browser-checkbox":(this._options.display.showSelectionCheckbox&&this._options.useSelection!==false&&"ws-browser-checkbox-holder");return e;},_toggleTurn:function(e,b){var c=this.getActiveRecord(),d=(c&&c.getKey())||this._rootNode;if(this._expanded[d]){this._processTreeClick(d,true);}else{if(c&&c.get(this._hierColumnIsLeaf)){this._expandTreeAll(b,d);}}},_additionalFilterRowOptions:function(c,b){$ws.proto.TreeView.superclass._additionalFilterRowOptions.apply(this,arguments);if(!b||!b.get(this._hierColumnIsLeaf)||this._options.display.readOnly){c.push("addItem","addFolder");}},_unselectRow:function(b){$ws.proto.TreeView.superclass._unselectRow.apply(this,arguments);if(this._isIdEqual(b,this._rootNode)&&!this._options.display.showRoot){this._head.find(".ws-browser-checkbox").closest("tr").removeClass("ws-browser-selected-part");}else{var c=this._body.find('tr[rowkey="'+b+'"]');c.removeClass("ws-browser-selected-part");delete this._selectedPart[b];}},_selectRow:function(b){$ws.proto.TreeView.superclass._selectRow.apply(this,arguments);if(this._isIdEqual(b,this._rootNode)&&!this._options.display.showRoot){this._head.find(".ws-browser-checkbox").closest("tr").removeClass("ws-browser-selected-part");}else{var c=this._body.find('tr[rowkey="'+b+'"]');c.removeClass("ws-browser-selected-part");delete this._selectedPart[b];}},_selectPartRow:function(b){if(this._isIdEqual(b,this._rootNode)&&!this._options.display.showRoot){this._head.find(".ws-browser-checkbox").closest("tr").addClass("ws-browser-selected-part").removeClass("ws-browser-selected");}else{this._unselectRow(b);var c=this._body.find('tr[rowkey="'+b+'"]');c.addClass("ws-browser-selected-part");this._selectedPart[b]=true;}},_toggleRowSelection:function(d){if(this._options.selectChilds){var e=this._selected[d]===undefined,c=this,b=function(h){if(e){c._selectRow(h);}else{c._unselectRow(h);}var j=c._currentRecordSet.recordChilds(h);for(var g=0;g<j.length;++g){b(j[g]);}};b(d);if(d){var f=function(j){var k=c._currentRecordSet.recordChilds(j),g=0,l=false;for(var h=0;h<k.length;++h){if(c._selected[k[h]]!==undefined){++g;}else{if(c._selectedPart[k[h]]!==undefined){l=true;}}}if(g===0&&!l){c._unselectRow(j);}else{if(g===k.length&&(c._options.selectChilds==="full"||c._isIdEqual(j,c._rootNode))){c._selectRow(j);}else{c._selectPartRow(j);}}if(!c._isIdEqual(c._rootNode,j)){f(c._currentRecordSet.getRecordByPrimaryKey(j).get(c._hierColumnParentId));}};f(c._currentRecordSet.getRecordByPrimaryKey(d).get(c._hierColumnParentId));}}else{$ws.proto.TreeView.superclass._toggleRowSelection.apply(this,arguments);}},_rebuildPartialSelection:function(){if(this._options.selectChilds){this._selectedPart={};var c=this,b=function(h,k){var j=c._currentRecordSet.recordChilds(h),e=true,d=false;if(k){c._selectRow(h);}for(var g=0;g<j.length;++g){var f=b(j[g],c._selected[h]!==undefined);if(f!==2){e=false;}if(f>0){d=true;}}if(k||(d&&e&&c._options.selectChilds==="full")||c._selected[h]!==undefined){c._selectRow(h);return 2;}else{if(d){c._selectPartRow(h);return 1;}}c._unselectRow(h);return 0;};b(this._rootNode,this._selected[this._rootNode]!==undefined);}},setSelection:function(b){$ws.proto.TreeView.superclass.setSelection.apply(this,arguments);this._rebuildPartialSelection();},clearSelection:function(b){$ws.proto.TreeView.superclass.clearSelection.apply(this,arguments);this._rebuildPartialSelection();},removeSelection:function(){$ws.proto.TreeView.superclass.removeSelection.apply(this,arguments);this._rebuildPartialSelection();},selectAll:function(){if(this._options.selectChilds){this._selected=[];this._selectedRecords=[];var b=this,c=function(e){b._selectRow(e);var f=b._currentRecordSet.recordChilds(e);for(var d=0;d<f.length;++d){c(f[d]);}};c(this._rootNode);this._updatePager();}else{$ws.proto.TreeView.superclass.selectAll.apply(this,arguments);}},_onRecordUpdated:function(d,b){var c,e;if(b instanceof $ws.proto.Record){e=b.get(this._hierColumnParentId);if(this._options.display.viewMode==="foldersTree"&&this._currentRecordSet.contains(e)){c=this._currentRecordSet.getRecordByPrimaryKey(e);if(c.get(this._hierColumnIsLeaf)===true){c.set(this._hierColumnHasChild,true);c.commit();}}}$ws.proto.TreeView.superclass._onRecordUpdated.apply(this,arguments);},_redraw:function(){}});return $ws.proto.TreeView;});