$ws.declareModule({namespace:"SBIS3.CORE",name:"Suggest",imports:["SBIS3.CORE.Control"]},function(a){$ws._const.Suggest={showAllRowsPerPage:20,hideTimeout:200,containerBonusWidth:4,minWidth:150,showAllTemplate:"suggestShowAll",iconWidth:16};$ws.proto.Suggest=a.Control.extend({$protected:{_options:{rowsCount:5,filter:[],delay:500,startChar:3,sourceField:[],resultField:[],processField:[],dataSource:{},filterParams:{},linkedBrowser:null,useBrowserFilter:false,display:{columns:"",showHead:true,rowRender:"",partiallyLoad:false,viewType:"",hierColumn:"Раздел",cutLongRows:false},browserWidth:"500",selectOnLoad:true,expandTree:false,maximumHeight:"auto",autoShow:false,browserAutoWidth:false,showAllTemplate:"suggestShowAll",clearOnOpen:false,clearBrowser:false,resetRoot:false},_currentBrowser:null,_currentRecordSet:null,_sources:[],_sourcesNames:{},_results:undefined,_keysWeHandle:[$ws._const.key.enter,$ws._const.key.down,$ws._const.key.up,$ws._const.key.left,$ws._const.key.right,$ws._const.key.esc,$ws._const.key.space,$ws._const.key.tab],_timer:undefined,_filter:undefined,_hasMoreLabel:undefined,_browserContainer:undefined,_hideTimer:undefined,_isVisible:false,_loading:undefined,_hasFocus:false,_clearButtons:[],_loaded:false,_currentField:0,_browserInit:false,_containerConnectedToLinkedBrowser:false},$constructor:function(){var b=this;this._publish("onDataLoaded","onSuggest","onDataLoadStarted","onMenuHide");this.getId();this._loading=$('<div class="ws-suggest-loading"></div>');if(!this._container){if(this._options.linkedBrowser){var f=this.getParentWindow();if(f){BOOMR.plugins.WS.reportEvent("$ws.proto.Suggest","constructor: автодополнению не задан контейнер. Цепляем его к контейнеру связанного браузера.");try{this._container=f.getChildControlById(this._options.linkedBrowser).getContainer();this._containerConnectedToLinkedBrowser=true;}catch(d){}}}if(!this._container){this._container=$("<div></div>");}}this._container.hide();if(this._options.linkedBrowser){this._width=0;this._height=0;}else{this._container.css("z-index","");this._container.addClass("ws-suggest-container").bind("focus",$.proxy(this._moveFocus,this)).css({width:parseInt(this._options.browserWidth,10)+$ws._const.Suggest.containerBonusWidth+"px"});if(this._options.maximumHeight!=="auto"){this._options.maximumHeight=parseInt(this._options.maximumHeight,10);this._container.height(this._options.maximumHeight+$ws._const.Suggest.containerBonusWidth+"px");}this._container.css("right","auto !important");this._browserContainer=$('<div class="ws-suggest-browser"></div>').appendTo(this._container).css({width:parseInt(this._options.browserWidth,10)+"px"});if(this._options.maximumHeight!=="auto"){this._browserContainer.height(b._options.maximumHeight+"px");}else{this._browserContainer.attr("VerticalAlignment","Top");}if(b._options.browserAutoWidth){b._browserContainer.attr("HorizontalAlignment","Left");}this._container.append(this._hasMoreLabel=$('<div class="ws-suggest-hasmore ws-hidden"></div>')).appendTo("body");}var c=new $ws.proto.ParallelDeferred();if(!(this._options.filter instanceof Array&&this._options.filter.length===this._options.sourceField.length)){throw new Error("filter must be an array with the same size, as sourceFiled");}this._initFields(this._options.sourceField,true,c);if(this._options.resultField.length){this._results=[];if(this._options.processField.length!==this._options.resultField.length){throw new Error("processField must be an array with the same size, as resultFiled");}this._initFields(this._options.resultField,false,c);}c.done().getResult().addCallback(function(){b._reloadControls(b._sources,true);if(b._results===undefined){b._results=b._sources;}else{b._reloadControls(b._results,false);}if(!b._options.filter){throw new Error("filter option must be set");}if(!b._options.dataSource&&!b._options.linkedBrowser){throw new Error("dataSource option must be set");}if(!b._options.processField){b._options.processField=b._options.filter;}if(!!b._options.linkedBrowser&&!b._browserInit){b._init();}});$(document).bind("mousedown."+this.getId()+" wsmousedown."+this.getId(),function(h){if(!b._options.linkedBrowser){var g=function(){var m=$(h.target).parents(".ws-suggest-browser, .ws-suggest-container, .ws-field-string")[0],n=false,l=false,j=b._currentBrowser.getContainer()[0];if(m){if(j==m){n=true;l=true;}else{for(var k=0,e=b._sources.length;k<e;++k){if(b._sources[k].getContainer()[0]==m){n=true;break;}}}}if(!n){if(l){b._moveFocus();}else{b._hideMenu();}}};if(b._currentBrowser!==null){g();}}});},_reloadControls:function(h,d){var g=this.getTopParent();for(var c=0,b=h.length;c<b;++c){if(typeof(h[c])==="string"){try{if(g&&g instanceof SBIS3.CORE.TemplatedAreaAbstract){h[c]=g.getChildControlById(h[c]);}else{h[c]=$ws.single.ControlStorage.get(h[c]);}if(d){this._sourcesNames[this._options.filter[c]]=true;this._initSourceEvents(c,h[c],this._options.linkedBrowser!==null);}}catch(f){}}}},_initFields:function(g,e,c){for(var d=0,b=g.length;d<b;++d){var f=g[d];if(typeof(f)==="string"){this[e?"_sources":"_results"].push(g[d]);c.push($ws.single.ControlStorage.waitChild(f));}else{if(f instanceof a.Control){this[e?"_sources":"_results"].push(f);if(e){this._initSourceEvents(d,f,this._options.linkedBrowser!==null&&e);}}else{if(e){throw new Error('$ws.proto.Suggest: sourceField has illegal control with id = "'+g[d]+'"');}}}}},_initSourceEvents:function(f,g,e){var c=this,d=($ws.proto.FieldFormatAbstract&&g instanceof $ws.proto.FieldFormatAbstract),b=this._findInput(g);g.subscribe(d?"onChangePure":"onChange",function(j,m){var k=d?this.getStringValue():m;if(e){if(!c._clearButtons[f]){var n=b.position(),i=b.parent().outerWidth(),h=i-b.width()-n.left,l=n.top+(b.height()-$ws._const.Suggest.iconWidth)/2;c._clearButtons[f]=$('<div class="ws-suggest-clear" />').click(function(){g.setValue(null);g.setActive(true);c._clearButtons[f].hide();c.show();});c._clearButtons[f].appendTo(b.parent()).css({top:l,right:h});b.addClass("ws-no-default-clear-button");}c._clearButtons[f].toggle(c.isEnabled()&&!!k);}if(c._options.enable){c._processChanges(c._findInput(this),!(c._options.linkedBrowser!==null&&k+""===""&&!c._options.clearBrowser));}});g.subscribe("onKeyPressed",function(h,i){c._initKeyboardMonitor(g,h,i);});g.subscribe("onFocusIn",function(){c._focusIn(this);});g.subscribe("onFocusOut",$.proxy(this._focusOut,this));if(g.isActive()){this._focusIn(g);}},_findInput:function(d){var c=$ws.proto.FieldFormatAbstract&&d instanceof $ws.proto.FieldFormatAbstract,b=d.getContainer();return c?b.find(".input-field:first"):b.find(".ws-field input");},_init:function(){var c=this;if(!c._options.linkedBrowser){return this._browserInit=c._getRecordSet().addCallback(function(d){c._currentRecordSet=d;return $ws.core.attachInstance("SBIS3.CORE.Browser",{element:c._browserContainer,dataSource:false,editDialogTemplate:"",editBranchDialogTemplate:"",filterParams:c._options.filterParams,autoWidth:c._options.browserAutoWidth,autoHeight:c._options.maximumHeight==="auto",minWidth:$ws._const.Suggest.minWidth,setCursorOnLoad:c._options.selectOnLoad,display:{columns:c._options.display.columns,height:c._options.height,width:c._options.width,showTiming:false,cutLongRows:c._options.display.cutLongRows,showHead:c._options.showHead,showRecordsCount:false,showRoot:false,showPaging:false,viewType:c._options.display.viewType,hierColumn:c._options.display.hierColumn,rowRender:c._options.display.rowRender,partiallyLoad:c._options.display.partiallyLoad,allowHorizontalScroll:!c._options.display.cutLongRows,reload:false,autoResize:false,usePaging:"full",recordsPerPage:c._options.rowsCount,rootNode:null},handlers:{onRowClick:$.proxy(c._onRowActivated,c),onRowDoubleClick:$.proxy(c._onRowActivated,c)}}).addCallback(function(e){c._currentBrowser=e;c._currentBrowser.setData(c._currentRecordSet);c._initBrowser();});});}else{var b=new $ws.proto.Deferred().dependOn($ws.single.ControlStorage.waitChild(c._options.linkedBrowser));if(!b){throw new Error('Browser (id = "'+c._options.linkedBrowser+'") for $ws.proto.Suggest does not exist');}else{return this._browserInit=b.addCallback(function(d){c._currentBrowser=d;c._currentBrowser.recordSetReady().addCallback($.proxy(c._onBrowserReady,c));c._currentBrowser.subscribe("onRowActivated",$.proxy(c._onRowActivated,c));if(c._currentBrowser.hasEvent("onConvert")){c._currentBrowser.subscribe("onConvert",$.proxy(c._onConvertReInit,c));}c._initBrowser();return d;});}}},_getRecordSetFromHandler:function(d){var c=this._options.dataSource(d),b=new $ws.proto.Deferred();if(c instanceof $ws.proto.Deferred||c instanceof $ws.proto.RecordSet){if(c instanceof $ws.proto.Deferred){return c.addCallback(function(e){if(!(e instanceof $ws.proto.RecordSet)){throw new Error("Необходимо отдать корректный набор данных!");}return e;});}else{b.callback(c);}return b;}else{throw new Error("Необходимо отдать корректный набор данных!");}},_getRecordSet:function(c,b){if(typeof(this._options.dataSource)=="function"){return this._getRecordSetFromHandler(c);}return this._createRecordSet(b);},_createRecordSet:function(b){var c=b||{context:this._context,firstRequest:false,usePages:"full",rowsPerPage:this._options.rowsCount},d=$ws.core.merge({},this._options.dataSource);return $ws.core.attachInstance("Source:RecordSet",$ws.core.merge(d,c));},_onBrowserReady:function(){this._currentRecordSet=this._currentBrowser.getRecordSet();if(!this._options.linkedBrowser){this._currentBrowser.subscribe("onFocusIn",$.proxy(this._moveFocus,this));}},_clearFilterOnOpen:function(d,b){var c,e;if(this._options.clearOnOpen){$ws.helpers.forEach(this._sources,function(g,f){g.setValue("");if(this._clearButtons[f]){this._clearButtons[f].hide();}}.bind(this));c=this._getFilter();clearTimeout(this._timer);if(this._filter&&!this._isFilterEqual(c)){this._filter=$ws.core.merge({},c);if(this._options.useBrowserFilter){c=$ws.core.merge(c,this._currentBrowser.getQuery(),{preferSource:true});}c["Разворот"]="Без разворота";c[this._currentBrowser.getRecordSet().getHierarchyField()]=b;this._currentBrowser.setTextHighlight("");e=this._currentBrowser.getRecordSet();e.setPage(0,true);e.setQuery(c,false);this.hide();d.setResult(false);}}},_onFilterChange:function(f,e){var b=this._getFilter(),d=this._currentBrowser.getRecordSet();if(d){if(e[d.getHierarchyField()]===this._currentBrowser.getRootNode()&&this._options.expandTree){for(var c in b){if(b.hasOwnProperty(c)){if(b[c]){this._currentBrowser.applyTurn("mixed",true);e["Разворот"]="С разворотом";return;}}}}}},_initBrowser:function(){var b=this;if(this._options.expandTree&&b._currentBrowser.isTree()){this._currentBrowser.setLoadChildFlag(true);}if(this._filter){this._currentBrowser.setQuery(this._filter);this._filter=undefined;}if(!this._options.linkedBrowser){this._currentBrowser.subscribe("onLoadError",function(c){c.setResult(true);});}this._currentBrowser.subscribe("onBeforeLoad",$.proxy(this._onDataLoadStarted,this));this._currentBrowser.subscribe("onAfterLoad",$.proxy(this._onDataLoaded,this));this._currentBrowser.subscribe("onBeforeRender",$.proxy(this._onBeforeRender,this));this._currentBrowser.getContainer().find(".ws-browser-container").bind("focus",function(){b._stopHideTimer();});if(this._hasFocus&&this._options.autoShow){this._processChanges(this._findInput(this._sources[0]),true);}if(this._currentBrowser.hasEvent("onFolderEnter")){this._currentBrowser.subscribe("onFolderEnter",this._clearFilterOnOpen.bind(this));this._currentBrowser.subscribe("onFilterChange",this._onFilterChange.bind(this));}this._notify("onReady");},_updateContainerSize:function(){var c=false;this._browserContainer.find(".ws-browser-scrollbar").height("100%");if(this._options.maximumHeight!=="auto"){var b=this._currentBrowser.getContainer().find(".ws-browser-container > .ws-browser").outerHeight()+1;if(b>this._options.maximumHeight){b=this._options.maximumHeight;c=true;}this._browserContainer.find(".ws-browser-container").height(b);this._browserContainer.height("auto");this._container.height("auto");}else{if($.browser.msie&&parseInt($.browser.version,10)==9){this._container.find("*").each(function(){$(this).height();});}}if(this._options.browserAutoWidth){var d=this._currentBrowser.getContainer().find(".ws-browser").width()+$ws._const.Suggest.containerBonusWidth;if(c){d+=$ws.helpers.getScrollWidth();}this._container.width(d);}},_moveFocus:function(){var b=this;if(b._currentBrowser){b._currentBrowser.setActive(false);if(b._sources[0]&&b._sources[0].setActive){b._sources[0].setActive(true);}}},_focusIn:function(c){var b=this;$ws.helpers.callbackWrapper(!this._browserInit&&this._init(),function(d){if(!b._hasFocus){b._hasFocus=true;b._stopHideTimer();if(b._options.autoShow&&c.isEnabled()){b._processChanges(b._findInput(b._sources[0]),true);}}for(var e=0;e<b._sources.length;++e){if(b._sources[e]===c){b._currentField=e;if(b._isVisible&&c.isEnabled()){b._moveMenuToField(b._sources[e].getContainer());}return d;}}b._currentField=0;return d;});},_focusOut:function(){this._hasFocus=false;if(!this._options.linkedBrowser){this._stopHideTimer();var b=this;this._hideTimer=setTimeout(function(){b._hideMenu();},$ws._const.Suggest.hideTimeout);}},_stopHideTimer:function(){if(this._hideTimer){clearTimeout(this._hideTimer);}},_notifySubWindow:function(b){var c=this.getParent();if(c){c.getContainer().trigger("wsSubWindow"+(b?"Open":"Close"));}},_hideMenu:function(){if(this._isVisible){this._container.stop(true,true);this._container.fadeOut("fast");this._isVisible=false;this.abort();this._notify("onMenuHide");this._notifySubWindow(false);}},_onRowActivated:function(d,c,b){this.processSuggest(b);d.setResult(!!this._options.linkedBrowser);},_onConvertReInit:function(e,c){var b=this,d=this._filter;this._currentBrowser=c;b._currentBrowser.recordSetReady().addCallback($.proxy(b._onBrowserReady,b));b._currentBrowser.subscribe("onRowActivated",$.proxy(b._onRowActivated,b));b._filter=undefined;b._initBrowser();if(d){b.show();}},_initKeyboardMonitor:function(b,d,c){if(c&&c.which in this._keysWeHandle&&(this._isVisible===true||this._notify("onKeyPressed",c)!==false)){this._keyboardHover(b,d,c);}},_keyboardHover:function(b,h,i){var n=this,m=this._currentBrowser.getContainer().find(".ws-browser-item-over"),d=b.getContainer().find("textarea").length>0&&!this._isVisible;if(!this._options.enable||i.altKey||i.shiftKey||i.ctrlKey&&i.which!==$ws._const.key.space||!b.isEnabled()){return false;}var j=function(){if(m&&m.length){n.processSuggest(n._currentBrowser.getActiveRecord());n._hideMenu();}};if(!d&&(i.which===$ws._const.key.down||i.which===$ws._const.key.up)){var g=m.length?m.next():n._container.find("tr:first"),f=m.length?m.prev():n._container.find("tr:last");var l=i.which===$ws._const.key.down?g:f;if(l!==null&&(n._options.selectOnLoad&&l.length||!n._options.selectOnLoad)){m.removeClass("ws-browser-item-over");l.addClass("ws-browser-item-over");n._currentBrowser.setActiveElement(l.length?l:undefined);i.stopPropagation();i.preventDefault();return false;}}else{if((i.which===$ws._const.key.enter&&n._currentBrowser.getRecordSet().getRecordCount()&&!d)||(i.which===$ws._const.key.space&&i.ctrlKey)){if(!n._isVisible){n.show();}else{if(i.which===$ws._const.key.enter&&!d){j();}}i.stopPropagation();i.preventDefault();}else{if(i.which===$ws._const.key.enter&&!d){n.show();i.stopPropagation();i.preventDefault();}else{if(i.which===$ws._const.key.esc&&n._isVisible){i.stopImmediatePropagation();n.hide();}else{if((i.which===$ws._const.key.left||i.which===$ws._const.key.right)&&this._currentBrowser.isTree()){var c=m.attr("rowkey"),k=(i.which===$ws._const.key.left);if(k===this._currentBrowser.isTreeFolderExpanded(c)&&this._currentBrowser.isRecordFolder(c)){this._currentBrowser[k?"hideBranch":"showBranch"](c);h.setResult(false);i.preventDefault();i.stopPropagation();return false;}h.setResult(true);return true;}else{if(i.which===$ws._const.key.tab&&this._isVisible&&this._loaded){j();}}}}}}return false;},processSuggest:function(c){var e=this,d={},h,g,b;if(c instanceof $ws.proto.Record){for(g=0,b=e._options.processField.length;g<b;++g){h=c.get(e._options.processField[g]);d[e._options.processField[g]]=h;}}var f=e._notify("onSuggest",c,d);if(f===undefined){for(g=0,b=e._options.processField.length;g<b;++g){if(e._results&&e._results[g]){e._results[g].setValue(d[e._options.processField[g]]);}}}if(f!==false&&!this._options.linkedBrowser){e._sources[e._currentField].setActive(true);e._hideMenu();}},_onDataLoadStarted:function(){this._notify("onDataLoadStarted");},getRecordSet:function(){return this._currentBrowser.getRecordSet();},_showMenu:function(){if(this._needShowBrowser()&&!this._isVisible){this._container.fadeOut(0);this._container.stop(true,true);this._container.fadeIn();this._moveMenuToField(this._sources[this._currentField].getContainer());this._isVisible=true;this._notifySubWindow(true);}},_moveMenuToField:function(d){var b=d.offset(),c=this._container.outerWidth();this._container.css($ws.helpers.positionInWindow({left:b.left,top:(b.top+d.height())},c));},_needShowBrowser:function(){var b=!this._options.linkedBrowser;if(b){var c=this._currentBrowser.getRecordSet();b=!!(c&&c.getRecordCount());}return b;},_onBeforeRender:function(){if(this._hasFocus){this._container.stop(true,true);this._container[this._needShowBrowser()?"show":"hide"]();}return true;},_onDataLoaded:function(){this._loaded=true;if(this._hasFocus&&this._currentBrowser){var g=this._currentBrowser.getRecordSet(),c=g.getRecordCount(),f=g.hasNextPage(),b=this,d=this._currentBrowser.getQuery();this._notify("onDataLoaded");if(this._needShowBrowser()){this._updateContainerSize();}if(!this._options.linkedBrowser){if(this._options.maximumHeight!=="auto"){this._container.height(this._options.maximumHeight+$ws._const.Suggest.containerBonusWidth);}this._browserContainer.height(this._options.maximumHeight);}if(c<f){var e=function(j,i){var h=j%10,k=Math.floor((j/10)%10);if(h==1&&k!==1){return i[0];}else{if(h>=1&&h<=4&&k!==1){return i[1];}}return i[2];};if(!b._options.linkedBrowser){this._hasMoreLabel.empty();if(b._options.maximumHeight!=="auto"){this._container.height(b._options.maximumHeight+24);}this._hasMoreLabel.append("Всего найдено "+f+" запис"+e(f,["ь","и","ей"])+". ").append($('<span class="ws-suggest-hasmore-link">Показать все.</span>').bind("click",function(h){b.hide();$ws.core.attachInstance("SBIS3.CORE.Dialog",{opener:b,template:b._options.showAllTemplate||$ws._const.Suggest.showAllTemplate,handlers:{onReady:function(){if($ws.proto.Browser){var l=this.getChildControls();for(var k=0,j=l.length;k<j;++k){if(l[k] instanceof $ws.proto.Browser||$ws.proto.DataViewAbstract&&l[k] instanceof $ws.proto.DataViewAbstract){b._setupShowAllBrowser(this,l[k],d);break;}}}}}});h.stopImmediatePropagation();return false;})).removeClass("ws-hidden");}}else{if(!b._options.linkedBrowser){this._hasMoreLabel.addClass("ws-hidden");if(b._options.maximumHeight!=="auto"){this._container.height(b._options.maximumHeight+$ws._const.Suggest.containerBonusWidth);}}}this._showMenu();}if(this._loading){this._loading.hide();}},_setupShowAllBrowser:function(e,c,f){var b=this;c.subscribe("onRowActivated",function(i,h,g){i.setResult(false);i.cancelBubble();e.close();b.processSuggest(g);});var d={firstRequest:true,filterParams:f,usePages:"full",rowsPerPage:$ws._const.Suggest.showAllRowsPerPage,context:b.getLinkedContext()};b._getRecordSet(f,d).addCallback(function(g){c.setColumns(b._currentBrowser.getColumns());if(b._options.display.rowRender){c.setRowRender(b._options.display.rowRender);}c.setData(g);});},_getFilter:function(c){var f={};for(var d=0,b=this._options.filter.length;d<b;++d){var e=$ws.proto.FieldFormatAbstract&&this._sources[d] instanceof $ws.proto.FieldFormatAbstract,g=e?this._sources[d].getStringValue():this._sources[d].getValue();if(g!==null){g+="";}if(g&&typeof(g)==="string"&&(g.length>=this._options.startChar||c===false)){f[this._options.filter[d]]=g;}else{if(!f[this._options.filter[d]]){f[this._options.filter[d]]="";}}}return f;},_setBrowserHighlightning:function(d){var b=[];for(var c in d){if(d.hasOwnProperty(c)){var e=d[c];if(e instanceof Object&&"fieldName" in e){e=this.getLinkedContext().getValue(e.fieldName);}if(e){b.push(e);}}}if(this._currentBrowser){this._currentBrowser.setTextHighlight(b.length?b.join("|"):"");}},_processChanges:function(d,c){var b=this;$ws.helpers.callbackWrapper(!this._browserInit&&this._init()||this._browserInit,function(e){if(parseInt(b._options.startChar,10)===0&&!b._options.clearBrowser){c=false;}var k=b._currentBrowser.getRecordSet(),j=false,g=b._getFilter(c);for(var f in g){if(!g.hasOwnProperty(f)){continue;}if(g[f]&&b._sourcesNames[f]){j=true;break;}}b._setBrowserHighlightning(g);g=$ws.core.merge(b._options.filterParams,g);g=k.prepareFilter(g,true);if(j||c===false){b._container.toggleClass("ws-control-inactive",false).toggleClass("ws-has-focus",true);if(!b._isFilterEqual(g)||!b._loaded){b.hide();b._loaded=false;b._filter=$ws.core.merge({},g);var h=function(){if(k!==null&&k.getReader().getAdapter().getRPCClient()!==null){k.abort();}if(b._options.linkedBrowser!==null){b._currentBrowser.setPage(0,false);}if(b._options.expandTree){if(b._currentBrowser.isTree()){b._currentBrowser.applyTurnTree(j,true);}else{if(j){b._currentBrowser.applyTurn("mixed",true);}else{b._currentBrowser.clearTurn(true);}}}if(b._options.selectOnLoad===false){b._currentBrowser.setActiveRow(undefined);}var o=d.length===0?{}:d.position(),q=d.parent().find(".ws-suggest-clear"),n=o.left+d.width()-16,m=o.top+(d.height()-$ws._const.Suggest.iconWidth)/2;if(q.length>0&&q.css("display")!=="none"){n-=16;}b._loading.css({top:m,left:n}).appendTo(d.parent()).show().fadeIn("fast");if(typeof(b._options.dataSource)=="function"){b._getRecordSetFromHandler(g).addCallback(function(r){b._currentRecordSet=r;b._currentBrowser.setData(r);});}else{if(b._options.useBrowserFilter){var i=b._currentBrowser.getQuery(),p=b._currentBrowser.getRecordSet().getHierarchyField();for(var l in i){if(i.hasOwnProperty(l)){if(l===p){delete i[l];break;}}}g=$ws.core.merge(g,i,{preferSource:true});}if(b._options.resetRoot){b._currentBrowser.setRootNode(b._currentBrowser.getRootNode(),true);}b._currentBrowser.setQuery(g,true,false);}};if(b._options.delay){if(b._timer){clearTimeout(b._timer);}b._timer=setTimeout(h,b._options.delay);}else{h();}}else{b._showMenu();}}else{if(b._timer){clearTimeout(b._timer);}b._filter={};b._currentBrowser.setTextHighlight("");if(b._options.clearBrowser){b._currentBrowser.clear();b._currentBrowser.setEmptyHtml("Введите не меньше "+b._options.startChar+" символов для начала поиска");}b.hide();}return e;});},_isFilterEqual:function(d){this._filter=this._filter||{};var c=true,b=function(g,f){for(var e in g){if(g.hasOwnProperty(e)){if(!f.hasOwnProperty(e)||f[e]!==g[e]){c=false;break;}}}};b(d,this._filter);b(this._filter,d);return c;},setParams:function(b){this._options.filterParams=b;},getParams:function(){return this._options.filterParams;},_setVisibility:function(b){if(b){this._processChanges(this._findInput(this._sources[0]),this._options.clearBrowser);}else{this._hideMenu();}},_isContainerInsideParent:function(){return false;},destroy:function(){$(document).unbind("mousedown."+this.getId());$(document).unbind("wsmousedown."+this.getId());if(this._options.linkedBrowser===null&&this._currentBrowser!==null){this._currentBrowser.destroy();}this._currentBrowser=null;this._currentRecordSet=null;this._sources=[];this._sourcesNames={};this._results=undefined;this._timer=undefined;this._filter=undefined;this._hasMoreLabel=undefined;this._browserContainer=undefined;this._hideTimer=undefined;if(this._isVisible){this._isVisible=false;this._notifySubWindow(false);}this._loading=undefined;if(this._containerConnectedToLinkedBrowser){this._container=undefined;}$ws.proto.Suggest.superclass.destroy.apply(this,arguments);},setEnabled:function(b){if(this._isVisible){this.hide();}$ws.proto.Suggest.superclass.setEnabled.apply(this,arguments);},setAutoShow:function(b){this._options.autoShow=b;},addSource:function(d,b){var c=this._sources.length;this._sources.push(d);this._sourcesNames[b]=true;this._options.filter.push(b);this._results.push(d);this._options.processField.push(b);this._initSourceEvents(c,d,this._options.linkedBrowser!==null);},abort:function(){if(this._currentBrowser){var b=this._currentBrowser.getRecordSet();if(b){b.abort();if(this._timer){clearTimeout(this._timer);}if(this._loading){this._loading.hide();}}}},setClearOnOpen:function(b){this._options.clearOnOpen=true;},_redraw:function(){}});return $ws.proto.Suggest;});