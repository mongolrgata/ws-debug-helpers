$ws.declareModule({namespace:"SBIS3.CORE",name:"Master",imports:["SBIS3.CORE.AreaAbstract","SBIS3.CORE.TemplatedArea"]},function(b,a){var c=a.extend({_disableScrollbars:function(){this._container.removeClass("ws-master-div-scrolling");},_enableScrollbars:function(){this._container.addClass("ws-master-div-scrolling");},_beforeChildrenBatchCalc:function(){this._disableScrollbars();},_afterChildrenBatchCalc:function(){this._enableScrollbars();},_onResizeHandler:function(){c.superclass._onResizeHandler.apply(this,arguments);var e=this._container.get(0),f=e.scrollWidth,h=e.scrollHeight,d=$(e).width(),g=$(e).height();if((f<=d)&&(h<=g)){this._disableScrollbars();setTimeout(this._enableScrollbars.bind(this),0);}}});$ws.proto.Master=b.extend({$protected:{_options:{steps:[],width:"auto",height:"120px",showTitle:true},_steps:{},_controls:{},_loaded:{},_currStep:undefined,_toStep:{},_history:[]},$constructor:function(){var d=this;this._publish("onPrevious","onNext","onStepReady","onComplete","onCancel");$ws.single.CommandDispatcher.declareCommand(this,"next",this.next);$ws.single.CommandDispatcher.declareCommand(this,"prev",this.prev);$ws.single.CommandDispatcher.declareCommand(this,"complete",this.complete);$ws.single.CommandDispatcher.declareCommand(this,"cancel",this.cancel);this._dReady=new $ws.proto.Deferred();this._dReady.addCallback(function(){d._notify("onReady");});for(var e in this._options.steps){if(this._options.steps.hasOwnProperty(e)){var f=parseInt(e,10);this._toStep[this._options.steps[f].id]=f+1;}}this._createSteps();},getReadyDeferred:function(){return this._dReady;},_getId:function(d){return this._options.steps[d-1].id?this._options.steps[d-1].id:d;},_loadContent:function(d){return this._runInBatchUpdate("Master._loadContent",function(){var h=this,i=this._getId(d),g;if(!this._loaded[d]){this._loaded[d]=true;if(this._options.steps[d-1].template!==undefined){var f=new $ws.proto.Deferred(),e;e=new c({autoHeight:true,autoWidth:true,template:this._options.steps[d-1].template,element:this._getBlockId(i),parent:this,keepSize:false,tabindex:1,name:"mysteparea"+i,context:this.getLinkedContext(),isRelative:this._options.isRelative,handlers:{onReady:function(){h._setUpTitle(d);h._currStep=d;if(!h._dReady.isReady()){h._dReady.callback();}else{this.setActive(true);}f.callback();}}});h._controls[d]=e;e.init();g=f;}}else{this._setUpTitle(d);this._currStep=d;g=new $ws.proto.Deferred();g.callback();}g.addCallback(function(){var j=h.getChildArea(d),k=$ws.single.ControlBatchUpdater;j._notifyOnSizeChanged(j,j);if(k._needDelayedRecalk(j)){k._doDelayedRecalk(j);}h._notify("onStepReady",d,i);});return g;});},_createSteps:function(){if(!this._options.steps){return;}this._allowEvents();var e=this._notify("onNext",1,this._getId(1));e=this._parseStepValue(e)||1;for(var d in this._options.steps){if(!this._options.steps.hasOwnProperty(d)){continue;}var f=parseInt(d,10)+1,g=this._options.steps[f-1],j=(g.id===undefined||g.id==="")?f:g.id,h=(e!=f)?" ws-hidden":"";this._steps[f]=$('<div class="ws-master-div ws-area-height-100-fix'+h+'" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" id="'+this._getBlockId(j)+'"></div>').appendTo(this._container).css({position:"absolute",left:0,top:0,right:0,bottom:0}).bind("mousewheel",function(i){i.stopPropagation();return true;});this._loaded[f]=false;if(e==f){this._currStep=f;this._loadContent(f);}}},_setUpTitle:function(e){var h=this._options.showTitle;if(h===true){var m=this.getParent();while(m&&!(SBIS3.CORE.Window&&m instanceof SBIS3.CORE.Window)){m=m.getParent();}if(m instanceof b&&!m.isPage()){var k=m.getTitle(),l=this._options.steps[this._currStep-1].title,d=this._options.steps[e-1].title,j=new RegExp(" "+l+"$");if(j.test(k)){m.setTitle(k.replace(j," "+d));}else{m.setTitle(k+" "+d);}}}else{if(h.length){var n=this._getControls(e);if(n!==undefined){for(var g=0;g<n.length;g++){var f=n[g];if(f instanceof $ws.proto.FieldLabel&&f.getName()==h){f.setValue(this._options.steps[e-1].title);}}}}}},next:function(){var e=1+this._currStep;if(e>this._options.steps.length){return true;}if(this.validate(this._currStep)){var d=this._notify("onNext",e,this._getId(e));e=(d===undefined)?e:d;this.setStep(e);}return true;},prev:function(){var e=this._history.pop();if(e===undefined){return true;}var d=this._notify("onPrevious",e,this._getId(e));e=(d===undefined)?e:d;this.setStep(e);this._history.pop();return true;},complete:function(){if(this.validate(this._currStep)){this._notify("onComplete",this._currStep,this._getId(this._currStep));}return true;},cancel:function(){var d=this.getLinkedContext().getRecord();if(d){d.rollback();}this._notify("onCancel");return true;},_parseStepValue:function(d){if(d!==undefined){if(!isNaN(parseFloat(d))&&isFinite(d)){if(d>0&&d<=this._options.steps.length){return d;}}else{if(d.length){return this._toStep[d];}}}return undefined;},setStep:function(e){var d=this._parseStepValue(e);if(d===null||this._currStep===undefined||this._currStep===d||this._steps[d]===undefined){return;}this._steps[d].removeClass("ws-hidden");if(this._steps[this._currStep]){this._steps[this._currStep].addClass("ws-hidden");}this._history.push(this._currStep);this._loadContent(d);},_resizeChilds:function(){var d=(this._currStep!==undefined)&&this.getChildArea(this._currStep);if(d){d._onResizeHandler();}},getStepId:function(){return this._options.steps[this._currStep-1].id;},getStep:function(){return this._currStep;},_getBlockId:function(d){return"ws-master-"+this.getId()+"-"+d;},_getControls:function(d){return(this._controls[d]&&this._controls[d] instanceof b)?this._controls[d].getChildControls():[];},getChildControls:function(){return this._getControls(this._currStep);},validate:function(h){var f=h?h:this._currStep,e=[this._controls[f]]||[];if(e!==undefined){var d=true;for(var g=0;g<e.length;g++){var j=e[g];if(j.validate){d=(j.validate()===true)&&d;}}return d;}return true;},getChildArea:function(d){return this._controls[d];},getSteps:function(){return this._options.steps;},_redraw:function(){}});return $ws.proto.Master;});