$ws.declareModule({namespace:"SBIS3.CORE",name:"RaphaelPieGraph",imports:["SBIS3.CORE.RaphaelDrawerInternal"]},function(a){var c=a.CommonGraphConst,b=a.helpers,e=b.readyDefWrapper;var d={defaultColors:["#6e1ba3","#1b888a","#d71d67","#ffc833","#2aa8f1","#befdbd","#ffa7a3","#ffc478"],defaultLegendStyle:c.defaultLegendStyle};$ws.proto.RaphaelPieGraph=a.RaphaelAbstractGraph.extend({$protected:{_options:{field:undefined,descriptionField:undefined,sectorNameField:undefined,stroke:"#001259",colors:d.defaultColors,gutter:20,strokeWidth:"2",init:false,href:undefined,render:undefined,animation:true},_flag:undefined,_graphSet:[],_legend:null,_centerX:undefined,_centerY:undefined,_centerXPercent:undefined,_centerYPercent:undefined,_radiusPercent:undefined,_radius:undefined,_sectors:[],_sectorsByName:{},_sectorOthers:undefined},$constructor:function(f){this._publish("onPrepareData");this._initValidateOptions(f);},_initValidateOptions:function(n){var q=this,l=n.centerX,k=n.centerY,o=n.radius,h;if(this._options.sectorNameField===undefined){this._options.sectorNameField=this._options.descriptionField;}this._sectors=n.sectors||[];this._sectorOthers=n.sectorOthers||undefined;if(l===undefined){l="50%";}if(k===undefined){k="50%";}if(o===undefined){o="30%";}function j(s){var r=String(s).match(/(.+)%$/),i;if(r){i=[undefined,Math.max(1,parseFloat(String.trim(r[1])))];}else{i=[Math.max(1,parseFloat(String.trim(String(s)))),undefined];}if(isNaN(i[0])&&isNaN(i[1])){throw new Error("Неправильный формат параметра centerX/centerY/radius: (надо число или проценты - положительное число больше нуля): "+s);}return i;}h=j(l);this._centerX=h[0];this._centerXPercent=h[1];h=j(k);this._centerY=h[0];this._centerYPercent=h[1];h=j(o);this._radius=h[0];this._radiusPercent=h[1];if(n.data){this.setData(n.data);}else{if(this._options.recordSet){this.setRecordSet(this._options.recordSet);}else{if(this._options.dataSource){this.setDataSource(this._options.dataSource,{});}}}function g(s){var r=q._getLegendConfig(s,d.defaultLegendStyle);var i=b.clone(r);i.legends=[];i.chart=q;return new a.ChartLegend(i);}this._legend=g(n.legend);if(this._options.sectorNameField){var m,p,f;for(m=0,p=this._sectors.length;m!==p;m++){f=this._sectors[m].name;if(!f){throw new Error("У настроек сектора круговой диаграммы должно быть имя, соотв. имени поля, по которому идентифицируется сектор.");}if(f in this._sectorsByName){throw new Error("У настроек сектора круговой диаграммы должно быть уникальное имя.");}this._sectorsByName[f]=this._sectors[m];}}},setConfig:e(function(f){this._options=b.extend(this._options,f);this._initValidateOptions(f);this.draw();}),_removeFlag:function(){if(this._flag){var f=this._flag;this._flag=null;f.animate({opacity:0},300,function(){this.remove();});}},_clearDraw:function(){this._removeFlag();$ws.helpers.forEach(this._graphSet,function(f){f.remove();});this._graphSet=[];this._legend._clearDraw();},_remove:function(){this._clearDraw();},_drawChart:function(){this._clearDraw();var x=this,u=b.clone(b.ensureArray(this._options.colors||d.defaultColors)),j=this.getCanvas(),L=[],k=this._options.descriptionField,I=this._options.sectorNameField,C=this._options.field,H=[],w=this._options.margin,o={left:w.left,top:w.top,width:this._options.width-w.left-w.right,height:this._options.height-w.top-w.top},l={stroke:this._options.stroke,strokewidth:this._options.strokeWidth,init:this._options.init,href:this._options.href,colors:u,gutter:this._options.gutter,matchColors:true},q=this._sectorOthers,m,E,t,s,r,n,D={},M;if(u.length===0){u=d.defaultColors;}for(E=0,t=this._chartData.length;E!==t;E++){if(E>=u.length){u[E]=u[u.length-1];}L[E]=this._chartData[E][C];if(I!==undefined){M=this._chartData[E][I];D[E]=(M&&this._sectorsByName[M])||null;}}var h,z,v,J,A,F,g,p,B;if(k){h=Raphael.fn.piechartPrepareValues(L,l).values;for(E=0,t=h.length;E!==t;E++){z=h[E];v=z.order;J=z.others;if(J){A=q;B="Остальные";}else{if(v in D){A=D[v];B=this._chartData[v][k];}}g={stroke:u[v]};if(A&&(F=A.style)){if(F.legendPathStyle){if(!F.legendPathStyle.stroke){F.legendPathStyle.stroke=F.legendPathStyle.fill;}b.extend(g,F.legendPathStyle);}else{if((p=(F.sectorPathStyle&&F.sectorPathStyle.fill))){b.extend(g,{stroke:p});}}}H.push({description:B,style:g});}}this._legend._setLegends(H);this._legend._setDrawBounds(o);if(!this._legend._getInsideChart()){m=this._legend._getLayoutMargin();o.left+=m.left;o.top+=m.top;o.width-=(m.left+m.right);o.height-=(m.top+m.bottom);}if(this._centerX!==undefined){s=o.left+this._centerX;}else{s=o.left+(this._centerXPercent*o.width/100);}if(this._centerY!==undefined){r=o.top+this._centerY;}else{r=o.top+(this._centerYPercent*o.height/100);}if(this._radius!==undefined){n=this._radius;}else{n=this._radiusPercent*Math.min(o.height,o.width)/100;}var f=j.piechart(s,r,n,L,l),K=function(){if(x._options.animation){this.sector.transform("s1.5");if(this.sector.value){var O=7,P=j.text(this.mx,this.my,this.sector.value.value||"0").attr({font:"12px Arial, sans-serif",fill:"#fff"}),N=P.getBBox(),i=j.rect(N.x-O,N.y-O,N.width+O*2,N.height+O*2,7).attr({fill:"#000",stroke:"none"}).insertBefore(P);x._flag=j.set().push(P).push(i);}}x._notify("onHover",this);},G=function(){if(x._options.animation){this.sector.transform("");x._removeFlag();}x._notify("onOutHover",this);},y=function(){x._notify("onClick",this);};f.hover(K,G);f.click(y);f.each(function(){var i=this.value.order,P=this.value.others,N,O;if(P){N=q;}else{if(i in D){N=D[i];}}O=N&&N.style;if(O&&O.sectorPathStyle){this.sector.attr(O.sectorPathStyle);}});this._legend._draw();this._graphSet=[f];},_clearData:function(){this._chartData=[];},setData:e(function(g){var f=this._notify("onPrepareData",g);if(f!==undefined){this._chartData=f;}else{this._chartData=g;}this.draw();this._notify("onAfterLoad");}),_checkValue:function(g,f){if(typeof g=="string"||typeof g=="number"){g=parseFloat(g);if(isNaN(g)){throw new Error("Can't cast value to float.See RecordSet record: "+f);}}else{throw new Error("Invalid type value in RecordSet.See RecordSet record: "+f);}return g;},_layout:function(){}});return $ws.proto.RaphaelPieGraph;});