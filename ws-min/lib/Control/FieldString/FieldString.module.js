$ws.declareModule({namespace:"SBIS3.CORE",name:"FieldString",imports:["SBIS3.CORE.FieldAbstract","SBIS3.CORE.Infobox"]},function(a,b){$ws.proto.FieldString=a.extend({$protected:{_tooltipContainer:null,_initValue:undefined,_infoboxTargetChangeHandler:null,_options:{password:false,canNotBeEmpty:false,tooltipInside:false,inputFilter:"",trim:false,cssClass:"ws-field-string",cssClassName:"ws-field-string"},_keysWeHandle:[$ws._const.key.del,$ws._const.key.backspace,$ws._const.key.left,$ws._const.key.right]},$constructor:function(){if($.browser.msie){$ws.core.attach("ext/field/ierange-m2-min.js");}this._infoboxTargetChangeHandler=function(h,g){var f=this._getExtendedTooltipTarget().get(0);if(g==f){this._inputControl.attr("title",this._options.tooltip);}}.bind(this);var d=this,e=function(){d._mouseDraggedThroughFirstSelect=true;c.unbind("mousemove",e);},c=this._inputControl;if(!$ws._const.browser.isModernIE&&c.is("input")){c.css("line-height",this._container.height()-2+"px");}c.bind("keypress",function(f){d._handleCapsLock(f);return d._options.inputFilter!==""?d._inputFilter(f,new RegExp(d._options.inputFilter)):true;}).bind("paste",function(){d._pasteProcessing++;var f;if(d._options.maxlength){f=d._options.maxlength;d._inputControl.attr("maxlength",10000);}setTimeout(function(){d._pasteProcessing--;if(d._pasteProcessing){return;}if(f){d._inputControl.attr("maxlength",f);}d._setValueInternal(d._curValue(true));d._onValueChangeHandler();},100);}).bind("mousedown",function(){if(d._isControlActive!==true){d._mouseDraggedThroughFirstSelect=false;c.bind("mousemove",e);}}).bind("mouseup",function(){c.unbind("mousemove",e);}).bind("click",function(){if(d._mouseDraggedThroughFirstSelect!==undefined){if(d._mouseDraggedThroughFirstSelect===false){d._firstSelect();}d._mouseDraggedThroughFirstSelect=undefined;}d._inputClicked=true;}).bind("blur",function(){d._getMessageBox().hide();});this._container.find(".ws-field").bind("click",function(){if(!d._inputClicked){d._firstSelect();}else{d._inputClicked=false;}});},init:function(){$ws.proto.FieldString.superclass.init.apply(this,arguments);this._initValue=this.getValue();},_handleCapsLock:function(c){if(this._options.password){if($ws.helpers.checkCapsLock(c)){this._showWarning("Caps-lock включен.");}else{this._getMessageBox().hide();}}},_showWarning:function(e){var d=this._getMessageBox(e,{icon:"warning"});var c=$(this._container).offset();c.top-=d.height()+3;c.left+=10;d.css(c);d.show();},_inputFilter:function(i,g){i=i||window.event;var h=i.target||i.srcElement,d=document.all;if(h.tagName.toUpperCase()=="INPUT"){var f=d?i.keyCode:i.which,c=String.fromCharCode(f);if(f<32||i.ctrlKey||i.altKey){return true;}if(!g.test(c)){return false;}}return true;},_bindTooltipHandlers:function(){var c=this;if(this._options.tooltipInside&&this._options.tooltip.length>0){this._tooltipContainer.click(function(){if(c.isEnabled()){c._inputControl.focus();}});this._inputControl.unbind(".tooltip");this._inputControl.bind("keyup.tooltip blur.tooltip",function(){c._tooltipHandler();});}},_isEmpty:function(){var c=this._curValue();return(typeof(c)==="undefined"||c==="");},_tooltipHandler:function(){if(this._options.tooltipInside&&this._options.tooltip.length>0&&!$ws._const.compatibility.placeholder){this._tooltipContainer.toggle(this._isEmpty()&&this.isEnabled());}},setTooltip:function(c){$ws.proto.FieldString.superclass.setTooltip.apply(this,arguments);this._setTooltip(c);},_setTooltip:function(c){this._inputControl.attr("title",c);if(this._options.tooltipInside){if($ws._const.compatibility.placeholder){this._inputControl.attr("placeholder",c);}else{if(this._tooltipContainer){this._tooltipContainer.text(c).toggle(!!c&&this._isEmpty());}}}},_finallyShowInfobox:function(){this._inputControl.attr("title",null);$ws.proto.FieldString.superclass._finallyShowInfobox.apply(this,arguments);},_bindExtendedTooltip:function(){$ws.proto.FieldString.superclass._bindExtendedTooltip.apply(this,arguments);b.subscribe("onChangeTarget",this._infoboxTargetChangeHandler);},_firstSelect:function(){this._funcFocus();},setActive:function(e,d,f){var c=this._isControlActive!=e;$ws.proto.FieldString.superclass.setActive.apply(this,arguments);if(e&&c&&!f){this._firstSelect();}},_getElementToFocus:function(){return this._inputControl;},_createMarkup:function(d){var c=$ws.proto.FieldString.superclass._createMarkup.apply(this,arguments),e="<input class='input-string-field' title='{{=it.tooltip}}' {{? it.tooltipInside }}placeholder='{{=it.tooltip}}'{{?}} {{? it.maxlength }}maxlength='{{=it.maxlength}}'{{?}} type='{{? it.password }}password{{??}}text{{?}}' name='{{=it.name}}' />";return this._extendMarkup(c,e);},_createPlaceholder:function(){if(this._options.tooltipInside&&this._options.tooltip.length>0){if(!$ws._const.compatibility.placeholder){this._tooltipContainer=$(["<div class='ws-tooltip-container'>",this._options.tooltip,"</div>"].join(""));this._inputControl.after(this._tooltipContainer);this._bindTooltipHandlers();this._tooltipHandler();}}},_bindInternals:function(){this._inputControl=this._container.find(".input-string-field");this._createPlaceholder();},_curValue:function(){var c=this._inputControl.val();if(!c&&this._initValue===null){return null;}return c;},_filterValue:function(d){var f=new RegExp(this._options.inputFilter),g=[];for(var e=0,c=d.length;e<c;e++){if(f.test(d.charAt(e))){g.push(d.charAt(e));}}return g.join("");},_setValueInternal:function(c){if(c===null||c===undefined){c="";}if(typeof c!="string"){c=c+"";}if(this._options.inputFilter){c=this._filterValue(c);}if(this._options.maxlength&&c.length>this._options.maxlength){c=c.substr(0,this._options.maxlength);}this._inputControl.val(c);$ws.proto.FieldString.superclass._setValueInternal.apply(this,[c]);this._tooltipHandler();},_getDefaultValue:function(){var c=function(d){if(d&&typeof(d)==="string"){return d;}return"";};if(typeof(this._options.value)==="function"){return c(this._options.value());}return c(this._options.value);},_funcFocus:function(){var d=this._inputControl.get(0);if(this.isEnabled()){if(document.selection&&document.selection.type!="None"){var c=d.createTextRange();c.select();}else{d.select();}}},_canValidate:function(){return $ws.proto.FieldString.superclass._canValidate.apply(this,arguments)||this._options.canNotBeEmpty;},_invokeValidation:function(){var c=this.getValue();if(this._options.trim&&typeof c=="string"){this.setValue(String.trim(c));}var d=$ws.proto.FieldString.superclass._invokeValidation.apply(this,arguments);if(this._options.canNotBeEmpty&&this._isEmpty()){d.result=false;d.errors.push(this._options.errorMessageFilling);}return d;},setEnabled:function(c){c=!!c;if(this._options.allowChangeEnable||c===this._options.enable){this._options.enable=c;if(!c){this._setTooltip("");this._container.addClass("readonly");this._inputControl.attr("readonly","readonly");this._inputControl.bind("keypress.readonly, change.readonly, keyup.readonly, keydown.readonly",function(d){if(d.which!=$ws._const.key.tab&&d.which!=$ws._const.key.esc&&!d.ctrlKey){d.preventDefault();d.stopImmediatePropagation();}});}else{this._setTooltip(this._options.tooltip);this._container.removeClass("readonly");this._inputControl.removeAttr("readonly");this._inputControl.unbind("keypress.readonly, change.readonly, keyup.readonly, keydown.readonly");}}},_keyboardHover:function(c){c.stopImmediatePropagation();return true;},getMaxLength:function(){return this._options.maxlength;},setMaxLength:function(c){if(c<0){return;}this._options.maxlength=c;this._inputControl.attr("maxlength",c);},_redraw:function(c){if((c&&!this._hasMarkup())||!c){if(!$ws.proto.FieldString.__markupTemplate){$ws.proto.FieldString.__markupTemplate=doT.template(this._getMarkupTemplate());}this._container.html($ws.proto.FieldString.__markupTemplate(this._options));}},destroy:function(){b.unsubscribe("onChangeTarget",this._infoboxTargetChangeHandler);$ws.proto.FieldString.superclass.destroy.apply(this,arguments);}});return $ws.proto.FieldString;});