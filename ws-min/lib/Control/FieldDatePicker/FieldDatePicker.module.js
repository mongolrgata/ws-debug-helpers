$ws.declareModule({namespace:"SBIS3.CORE",name:"FieldDatePicker",imports:["SBIS3.CORE.Control"]},function(a){$ws.proto.FieldDatePicker=a.DataBoundControl.extend({$protected:{idDiv:"",_options:{dateRenderFunction:null,forbidChangeDate:false},_objData:null,_defferedShowDatePicker:new $ws.proto.Deferred()},$constructor:function(){var c,b=this;this.subscribe("onInit",this.onInit);if(typeof(this._options.value)=="function"){c=this._options.value();}else{c=this._options.value;}this._publish("onDateChange","onMonthChange","onHighlight","onLegend");this.idDiv="#"+this.getId();this._container.addClass("ws-datepicker-static");if(this._options.forbidChangeDate){this._container.addClass("ws-dp-readonly");}if(this._isCorrectContainer()){var d=b._parseToDate(c);this._defferedShowDatePicker=$ws.helpers.showDatePicker(this.getId(),this._options.dateRenderFunction,b._parseToDate(c));this.getContainer().data({month:(d.getMonth()),year:d.getFullYear()});}},onInit:function(){var b=this;this._defferedShowDatePicker.addCallback(function(){var c=$.datepicker._getInst(b._container[0]);c.self=b;if(b._options.forbidChangeDate){$.datepicker._selectDay=function(k,i,f,j){var h=$(k);if($(j).hasClass(this._unselectableClass)||this._isDisabledDatepicker(h[0])){return;}var g=this._getInst(h[0]);if(!g.self||!g.self._options.forbidChangeDate){g.selectedDay=g.currentDay=$("a",j).html();g.selectedMonth=g.currentMonth=i;g.selectedYear=g.currentYear=f;}this._selectDate(k,this._formatDate(g,$("a",j).html(),i,f));};}$(b.idDiv).datepicker("option","onSelect",function(g,f){b._notify("onDateChange",b._parseToDate(g,"."));});$(b.idDiv).datepicker("option","onChangeMonthYear",function(g,i,h){var f=i+"";if(f.length<2){f="0"+f;}b.getContainer().data({month:i-1,year:g});b._notify("onMonthChange",b._parseToDate("01."+f+"."+g,"."));});$(b.idDiv).datepicker("option","beforeShowDay",function(g){if(b._objData!==null){var f=g.toDateString();if(b._objData[f]!==undefined){return[true,b._objData[f],""];}else{return[true,""];}}return[true,""];});var e=b._notify("onHighlight"),d;if(e instanceof $ws.proto.Deferred){e.addCallback(function(f){b.setHighLight(f);});}else{if(e!==undefined){b.setHighLight(e);}}d=b._notify("onLegend");if(d instanceof $ws.proto.Deferred){d.addCallback(function(f){b.setLegend(f);});}else{if(d!==undefined){b.setLegend(d);}}});},_parseToDate:function(d,b){var c;if(d instanceof Date){return d;}if(typeof d=="string"){if(b==="."){c=new Date(d.replace(/(\d+).(\d+).(\d+)/,"$3/$2/$1"));}else{c=new Date(d.replace(/(\d+)\/(\d+)\/(\d+)/,"$3/$2/$1"));}if(isNaN(+c)){c=null;}return c;}else{return null;}},setHighLight:function(b){this._arrayToObj(b);$(this.idDiv).datepicker("setDate",$(this.idDiv).datepicker("getDate"));},setLegend:function(c){var d='<div class="ws-dp-legend">';for(var b in c){if(c.hasOwnProperty(b)){d+='<div class="ws-dp-row-legend"><span class="'+b+'">&nbsp;</span>'+c[b]+"</div>";}}d+="</div>";$(this.idDiv).append(d);},_arrayToObj:function(b){var e={};for(var d=0,c=b.length;d<c;d++){e[b[d][0].toDateString()]=b[d][1];}this._objData=e;},_redraw:function(){}});return $ws.proto.FieldDatePicker;});