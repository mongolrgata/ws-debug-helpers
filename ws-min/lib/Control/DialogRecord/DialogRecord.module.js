$ws.declareModule({namespace:"SBIS3.CORE",name:"DialogRecord",imports:["SBIS3.CORE.Dialog"]},function(a){$ws._const.DialogRecord={savingMessage:"Подождите, идёт сохранение"};$ws.proto.DialogRecord=a.extend({$protected:{_options:{readOnly:false,isNewRecord:false,reports:{}},_record:null,_recordSaved:false,_loadingIndicator:undefined,_saving:false,_reportPrinter:null,_printMenu:null,_printMenuIsShow:false,_lastMenuItemList:[]},$constructor:function(){$ws.single.CommandDispatcher.declareCommand(this,"save",this.save);$ws.single.CommandDispatcher.declareCommand(this,"delete",this.delRecord);$ws.single.CommandDispatcher.declareCommand(this,"print",this.print);$ws.single.CommandDispatcher.declareCommand(this,"printReport",this.printReport);this._publish("onBeforeDelete","onRecordDeleted","onBeforeSave","onSave","onSuccess","onFail","onRecordUpdate","onBeforeShowPrintReports","onPrepareReportData","onSelectReportTransform");if(!(this._options.record instanceof $ws.proto.Record)){throw new Error("Valid record required to build DialogRecord");}else{this._options.isNewRecord=this._options.record.getKey()===null||this._options.isNewRecord;}if(this.getReports().length!==0){this._reportPrinter=new $ws.proto.ReportPrinter({});}if(this._options.readOnly){var b=this;this._dRender.addCallback(function(){b._setEnabledForChildControls(false);});}},_setEnabledForChildControls:function(e){var d=this.getChildControls(),f;for(var c=0,b=d.length;c<b;++c){f=d[c];if(f&&f.getName()!=="windowTitleClose"){if(typeof(f.setReadOnly)=="function"){f.setReadOnly(!e);}else{f.setEnabled(e);}}}},destroy:function(){this.getRecord().rollback();$ws.proto.DialogRecord.superclass.destroy.apply(this,arguments);},delRecord:function(e){var c=this,d=new $ws.proto.Deferred(),b=c._notify("onBeforeDelete");if(b!==false){$ws.helpers.question(typeof(b)=="string"?b:"Вы действительно хотите удалить эту запись?").addCallback(function(f){if(f){d.dependOn(c.getRecord().destroy().addCallbacks(function(g){c._recordSaved=true;c._notify("onSuccess",g);c._notify("onRecordDeleted");if(e!==true){c.ok();}return g;},$.proxy(c._processError,c)));}else{d.callback();}});}return d;},getRecord:function(){return this.getLinkedContext().getRecord();},save:function(d,e){if(!this._saving){var c=this;if(this._options.readOnly){if(d instanceof $ws.proto.Deferred){d.errback("Readonly!");}if(e!==true){this.ok();}}else{var b=new $ws.proto.Deferred();this.waitAllPendingOperations(b);b.addCallback(function(){c._saving=true;(function(f){if(d instanceof $ws.proto.Deferred){return d.dependOn(f);}else{return f;}})(c.updateRecord()).addBoth(function(f){c._saving=false;return f;}).addCallback(function(f){if(e!==true){c.ok();}return f;});});}}},_processError:function(c){var b=this._notify("onFail",c),d=c&&c.message;if(b||b===undefined){if(typeof b=="string"){d=b;}if(d){$ws.core.alert(d);}}return c;},_showLoadingIndicator:function(){if(this._loadingIndicator){this._loadingIndicator.addCallback(function(c){c.show($ws._const.DialogRecord.savingMessage);return c;});}else{var b=this;this._loadingIndicator=$ws.core.attachInstance("SBIS3.CORE.LoadingIndicator",{parent:this,showInWindow:true,modal:true,message:$ws._const.DialogRecord.savingMessage,name:this.getId()+"-LoadingIndicator"}).addCallback(function(c){if(!b._events){c.destroy();}return c;});}},_hideLoadingIndicator:function(){if(this._loadingIndicator){this._loadingIndicator.addCallback(function(b){b.hide();return b;});}},updateRecord:function(){var f=new $ws.proto.Deferred(),c=this,g=function(k){if(k===false){f.errback("Cancelled by onBeforeSave handler");}else{if(c.validate()){c._showLoadingIndicator();var j=c._notify("onSave"),e=c.getRecord();if(j===false){f.errback("Cancelled by onSave handler");}else{var i=(j instanceof $ws.proto.Deferred)?j:e.update();f.dependOn(i.addCallbacks(function(l){var m=e.getKey();if(typeof(m)==="number"){c.getLinkedContext().setValue(e.getKeyField(),m);}c._notify("onRecordUpdate",l);c._recordSaved=true;c._notify("onSuccess",l);return l;},function(l){c._processError(l);return l;}));}f.addBoth(function(l){c._hideLoadingIndicator();return l;});}else{f.errback("Validation failed");}}},b=function(e){c._processError(e);f.errback(e);};if(this._options.readOnly){f.callback();}else{try{var d=this._notify("onBeforeSave");if(d instanceof $ws.proto.Deferred){d.addCallback(function(e){g(e);return e;}).addErrback(function(i){b(i.message);return i;});}else{g(d);}}catch(h){b(h);}}return f;},close:function(c){var b=this;this.waitAllPendingOperations(new $ws.proto.Deferred().addCallback(function(){var d=new $ws.proto.Deferred();if(!this._options.readOnly&&!c&&this.getRecord().isChanged()){$ws.core.attachInstance("SBIS3.CORE.DialogConfirm",{opener:this,resizable:false,message:"Сохранить изменения?",handlers:{onConfirm:function(f,e){if(e){b.updateRecord().addCallback(function(){d.callback(e);}).addErrback(function(g){b._moveFailValidatedToFocus();return g;});}else{b.getRecord().rollback();d.callback(e);}},onAfterClose:function(e){d.addCallback(function(f){b._dialogRecordSuperClassClose([f]);});}}});}else{b._dialogRecordSuperClassClose([c]);}}.bind(this)));},_dialogRecordSuperClassClose:function(){$ws.proto.DialogRecord.superclass.close.apply(this,arguments[0]);},isSaved:function(){return this._recordSaved;},isReadOnly:function(){return this._options.readOnly;},setReadOnly:function(b){this._options.readOnly=!!b;this._setEnabledForChildControls(!b);},isNewRecord:function(){return this._options.isNewRecord;},getReports:function(){var b=[];for(var c in this._options.reports){if(this._options.reports.hasOwnProperty(c)&&this._options.reports[c]!==undefined){b.push(c);}}return b;},_printMenuItemsIsChanged:function(c){if(this._lastMenuItemList.length!==c.length){return true;}for(var d=0,b=c.length;d<b;d++){if(this._lastMenuItemList[d]!==c[d]){return true;}}return false;},_createPrintMenu:function(c){var b=this;if(!c||!(c instanceof Array)){c=this.getReports();}if(c.length>1&&(this._printMenu===null||this._printMenuItemsIsChanged(c))){this._lastMenuItemList=c;if(b._printMenu!==null){b._printMenu.destroy();b._printMenu=null;}return $ws.helpers.newContextMenu(c,function(e,d){b.printReport.apply(b,[d.caption]);}).addCallback(function(d){b._printMenu=d;return d;});}else{return new $ws.proto.Deferred().callback(this._printMenu);}},showReportList:function(h){if(Object.isEmpty(this._options.reports)){return;}var g=this.getRecord(),f=this.getReports(),d=this,c;c=this._notify("onBeforeShowPrintReports",f,g,false);if(c!==false){var b;if(c instanceof Array){b=c;if(c.length==1){c=c[0];}}else{b=typeof(c)==="string"?[]:"";}this._createPrintMenu(b).addCallback(function(e){if(d._printMenu===null){if(c===undefined){c=f[0];}if(typeof(c)=="string"){d.printReport(c);}}else{try{d._printMenu.show(h);d._printMenuIsShow=true;}catch(i){d._printMenu.subscribe("onReady",function(){d._printMenu.show(h);d._printMenuIsShow=true;});}}return e;});}},printReport:function(c){if(Object.isEmpty(this._options.reports)){return;}var f=this.getRecord(),e="",d=this,b;$ws.core.setCursor(false);if(d._printMenu!==null&&d._printMenuIsShow){d._printMenu.destroy();d._printMenu=null;d._printMenuIsShow=false;}if(c!==undefined){e=this._options.reports[c];b=this._notify("onPrepareReportData",c,f);if(b!==false){if(b instanceof $ws.proto.Deferred){b.addCallback(function(g){if(g instanceof $ws.proto.Record||g instanceof $ws.proto.RecordSet||g instanceof Array){d._showReport(c,g,e);}});}else{if(b instanceof $ws.proto.Record||b instanceof $ws.proto.RecordSet||b instanceof Array){f=b;}this._showReport(c,f,e);}}else{$ws.core.setCursor(true);}}},_showReport:function(c,f,e){var b="",d=this;if(c!==undefined){b=this._notify("onSelectReportTransform",c,f,e);if(typeof(b)==="string"){e=b;}e=$ws._const.resourceRoot+e;d._reportPrinter.prepareReport(f,e).addCallback(function(g){$ws.helpers.showHTMLForPrint(g).addCallback(function(h){h.subscribe("onReady",function(){this.getChildControlByName("ws-dataview-print-report").subscribe("onContentSet",function(){$ws.core.setCursor(true);});});});}).addErrback(function(g){$ws.core.setCursor(true);$ws.core.alert(g.message);});}},print:function(b){if(Object.isEmpty(this._options.reports)){return;}this.showReportList(b);}});return $ws.proto.DialogRecord;});