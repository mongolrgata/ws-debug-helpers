$ws.declareModule({namespace:"SBIS3.CORE",name:"Paging",imports:["SBIS3.CORE.Control"]},function(a){$ws.proto.Paging=a.Control.extend({$protected:{_options:{recordsPerPage:undefined,currentPage:1,recordsCount:undefined,pagesLeftRight:3,onlyLeftSide:false,rightArrow:undefined},_block:[],_maxPage:0,_hasAfterMax:true},$constructor:function(){if(this._options.onlyLeftSide&&this._options.rightArrow===undefined&&(this._options.recordsCount===undefined||this._options.currentPage===undefined||this._options.recordsPerPage===undefined)){throw new Error("Не указано количество записей для Control/Paging");}this._options.recordsCount=parseInt(this._options.recordsCount,10);this._options.currentPage=parseInt(this._options.currentPage,10);this._options.recordsPerPage=parseInt(this._options.recordsPerPage,10);this._options.pagesLeftRight=parseInt(this._options.pagesLeftRight,10);this._publish("onPageChange");this._container.append('<div class="ws-paging"></div>');this._block=this._container.find(".ws-paging");this._maxPage=this._options.currentPage;this._build();},addContainer:function(c){for(var d=0,b=c.length;d<b;++d){this._container.push(c[d]);this._block.push($('<div class="ws-paging"></div>'));c.eq(d).append(this._block[this._block.length-1]);}this._build();},_initContainer:function(b){if("element" in b){if(typeof(b.element)=="string"){var d=b.element.split(",");this._container=$();for(var c=0;c<d.length;++c){this._container.push($("#"+String.trim(d[c])).get(0));}}else{if("jquery" in b.element){this._container=b.element;}else{if(b.element.nodeType){this._container=$(b.element);}}}}},_isCorrectContainer:function(){return this._container!==undefined&&("jquery" in this._container)&&this._container.length>=1;},update:function(d,c,b){if(this._options.currentPage==d&&c===undefined&&b===undefined){return;}if(b!==undefined){var e=d||this._options.currentPage;if(e>=this._maxPage||!b){this._maxPage=e;this._hasAfterMax=!!b;}}d=d!==undefined?d:this._options.currentPage;c=c!==undefined?c:this._options.recordsCount;this._options.currentPage=d;this._options.recordsCount=c;this._options.rightArrow=b;this._build();},clearMaxPage:function(){this._maxPage=0;this._hasAfterMax=true;this._build();},_pageLoaded:function(c,b){if(b instanceof Object){this.update(b[0],b[1],b[2]);}else{this.update(c,undefined,b);}},_blockClick:function(c){if(!this._options.enable){return false;}var b=new $ws.proto.Deferred(),d=c.data.pageNum;if(this._options.onlyLeftSide){b.addCallback(this._pageLoaded.bind(this,d));}else{this.update(d);}this._notify("onPageChange",d,b);return false;},_createPageBlock:function(d,c,b,e,h,g){if(e===undefined){if(b!==undefined){e=!b;}else{e=false;}}var f=$('<span class="ws-paging-small">'+d+"</span>");if(g&&g.length){f.addClass(g);}if(e){if(h){f.attr("title",h);}f.addClass("ws-paging-active");f.bind("click",{pageNum:c},this._blockClick.bind(this));}else{if(b){f.addClass("ws-paging-current");}}this._block.append(f);},_build:function(){var c=(this._options.onlyLeftSide?this._maxPage:Math.ceil(this._options.recordsCount/this._options.recordsPerPage)),g=Math.max(this._options.currentPage,c),f;this._container.show();this._block.empty();if(g<=1&&(!this._options.onlyLeftSide||!this._options.rightArrow)){this._container.hide();return;}this._createPageBlock("&larr;",this._options.currentPage-1,false,this._options.currentPage!=1,"Перейти на предыдущую страницу","ws-paging-prev");this._createPageBlock(1,1,this._options.currentPage==1,undefined,"Перейти на страницу 1");if(2<this._options.currentPage-this._options.pagesLeftRight){if(this._options.currentPage-this._options.pagesLeftRight==3){f=this._options.currentPage-this._options.pagesLeftRight-1;this._createPageBlock(f,f,false,true,"Перейти на страницу "+f);}else{this._createPageBlock("...");}}var b=Math.min(this._options.currentPage+this._options.pagesLeftRight,g-1);var e=(this._options.onlyLeftSide?Math.min(this._options.currentPage+this._options.pagesLeftRight,Math.max(this._maxPage,this._options.currentPage)):b);for(var d=Math.max(this._options.currentPage-this._options.pagesLeftRight,2);d<=e;++d){this._createPageBlock(d,d,d==this._options.currentPage,undefined,"Перейти на страницу "+d);}if(g-1>this._options.currentPage+this._options.pagesLeftRight){if(this._options.currentPage+this._options.pagesLeftRight==g-2){f=this._options.currentPage+this._options.pagesLeftRight+1;this._createPageBlock(f,f,false,true,"Перейти на страницу "+f);}else{this._createPageBlock("...");}}if(e<g){this._createPageBlock(g,g,g==this._options.currentPage,undefined,"Перейти на странцу "+g);}if(this._options.onlyLeftSide&&this._hasAfterMax&&this._maxPage>=e){this._createPageBlock(this._maxPage+1,this._maxPage+1,this._maxPage+1==this._options.currentPage,undefined,"Перейти на странцу "+(this._maxPage+1));this._createPageBlock("...");}this._createPageBlock("&rarr;",this._options.currentPage+1,false,(this._options.onlyLeftSide?this._options.rightArrow:this._options.currentPage!=g),"Перейти на следующую страницу","ws-paging-next");if($ws._const.theme==="wi_scheme"&&this._options.onlyLeftSide){this._createPageBlock("&rarr;",0,false,this._options.rightArrow,"Перейти к последней странице","ws-paging-end");}},setRecordSet:function(c){var b=this;c.subscribe("onPageChange",function(e,d){b.update(d+1);});},setPageSize:function(b){this._options.recordsPerPage=b;this._build();},_redraw:function(b){this._build();}});return $ws.proto.Paging;});