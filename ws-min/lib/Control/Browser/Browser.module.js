$ws.declareModule({namespace:"SBIS3.CORE",name:"Browser",imports:["SBIS3.CORE.DataView"]},function(a){$ws.proto.Browser=a.extend({$protected:{_options:{display:{columns:"",folderIcon:$ws._const.Browser.folderIcon,itemIcon:$ws._const.Browser.itemIcon,ladder:[],useWordsLadder:false,wordsLadderCount:1,showRoot:false,rootName:"Все",showHead:true,useSorting:true,hasZebra:true,cutLongRows:true,rowOptions:false,rowRender:"",resultsRender:"",headColumnRender:"",headRender:"",resultText:"&Sigma;",showActiveRowInFocus:true,useDrawingLines:false,allowAddAtThePlace:false},mode:"oneClickMode",folderLinkAction:"open",selectChilds:""},_columnMap:[],_ladder:{},_bodyColumns:"",_headColumns:"",_resultsColumns:"",_editAtPlaceField:undefined,_editAtPlaceRecord:undefined,_editAtPlaceTimer:undefined,_editAtPlaceChanges:false,_editAtPlaceCell:undefined,_editAtPlaceFocusCallback:undefined,_editAtPlaceCellIndex:undefined,_editAtPlaceValidationErrors:0,_editAtPlaceValidationMap:{},_editAtPlaceWithValidationError:false,_hasLadder:false,_resultFields:[],_resultTypes:{leaves:"По листьям",folders:"По узлам",foldersAndLeaves:"По узлам и листьям"},_fieldTypesForEdit:{"Число целое":"Field:FieldInteger","Число вещественное":"Field:FieldNumeric","Деньги":"Field:FieldMoney","Дата":"Field:FieldDate","Дата и время":"Field:FieldDate","Время":"Field:FieldDate","Логическое":"Field:FieldCheckbox","Строка":"Field:FieldString","Текст":"Field:FieldText","Перечисляемое":"Field:FieldDropdown","Флаги":"Area:GroupCheckBox"},_rowOptionsInitialized:false,_rowOptionsElement:false,_hasRowOptions:false,_rowOptionsMenu:undefined,_rowOptionsHoverRow:undefined,_rowOptionsHoverRecord:undefined,_rowOptionsTargetRow:undefined,_rowOptionsMenuVisible:false,_rowOptionsCurrentMenu:undefined,_rowOptionsButtons:{},_rowOptionsMenuButtons:[],_rowOptionsDisableStandart:false,_rowOptionsDefault:[],_rowOptions:{},_highlight:"",_resultBrowser:undefined,_emptyDataScroller:undefined,_rowTemplates:[undefined,undefined],_selectAfterPathLoad:true,_columnFilterMap:[],_addAtPlace:false,_addAtPlaceRow:undefined,_addAtPlaceRecordId:undefined,_addAtPlaceRecord:undefined,_addAtPlaceLinkRow:undefined,_rootName:undefined,_rowSelection:undefined,_selectedPart:{},_disabledEditCells:{},_fullTreeExpand:false,_rowsMap:{},_useLoadChildsFlag:false,_dragRow:undefined,_dragStarted:false,_dragObject:undefined,_dragStartPoint:{},_dragTargetRow:undefined,_dragIsCorrect:false,_dragRecords:[],_isLoading:false},$constructor:function(){this._publish("onDragStart","onDragMove","onDragStop","onBeforeRender","onRowOptions","onResetColumnFilter","onBeforeEditColumn","onFolderOpen","onFolderClose","onFieldChange");this.subscribe("onFilterChange",this._onFilterChangeHandler);var b=this.getParentWindow();if(b!==undefined){this._container.addClass("ws-browser-in-dialog");}if(this._options.display.rowOptions){this._initRowOptionsDefaults();}},delegateUserEvent:function(b,d,c,e){if(typeof b!=="string"||b===""){throw new TypeError("delegateEvent: Selector must be a non-empty string");}if(typeof c!="function"){throw new TypeError("delegateEvent: Handler must be a function");}if(typeof d!="string"||d===""){throw new TypeError("delegateUserEvent: Event name must be a non-empty string");}this._container.find(".ws-browser-container table").delegate(b,d,e,c);},_contentHeightChanged:function(){$ws.proto.Browser.superclass._contentHeightChanged.apply(this,arguments);this._hideRowOptions();},_onFilterChangeHandler:function(f,d){var h,e,c;if(!Object.isEmpty(this._options.display.columns)){for(var b in this._options.display.columns){if(this._options.display.columns[b].filterDialog){e=this._options.display.columns[b];c=e.filterName?e.filterName:e.title;if(d[c]){this._columnFilterMap[c]=b;}else{delete this._columnFilterMap[c];this._clearMarkColumnFilter(b,e.title);}}}}if(this._columnMap.length>0){for(var g in this._columnFilterMap){if(d[g]){h=this._columnFilterMap[g];this._markFilteredColumn(d,h);}}}},resetFilterByColumnName:function(e){var k=this,b,h={},c;if(e){for(var f=0,g=this._columnMap.length;f<g;++f){if(this._columnMap[f].title===e){h=this._columnMap[f];c=f;break;}}if(!Object.isEmpty(h)&&h.filterDialog){var d=this.getQuery();if(d[h.filterName||h.title]){delete d[h.filterName||h.title];}var j=this._notify("onResetColumnFilter",d,h.filterName||h.title,h.title);this.setQuery(j&&Object.prototype.toString.call(j)=="[object Object]"?j:d);this._clearMarkColumnFilter(c,h.title);}}},_clearMarkColumnFilter:function(d,c){var b=this._head.find("#"+d+".ws-browser-head-link");$(b).next(".ws-browser-filter").css("display","none");if(b.html()!==c){b.text(c);}},_markFilteredColumn:function(d,g){var f,e={},c,b;if(d&&g){f=false;e=this._columnMap[g];c=e.filterName?e.filterName:e.title;b=this._head.find("#"+g+".ws-browser-head-link");if(b.length>0){if(e.visualFilterFunction){f=e.visualFilterFunction.apply(this,[d]);}if(!f&&e.title){b.empty().append(e.title);}if(d[c]){if(f instanceof Object&&"jquery" in f){b.empty().append(f);}else{if(typeof(f)==="string"){b.html($ws.helpers.escapeHtml(f));}else{b.text(d[c]);}}b.next(".ws-browser-filter").show();}}}},_createContainer:function(){var e="",d,c=this._options.display.showRecordsCount||this._options.display.showPaging||this._options.display.showSelectionCheckbox?'<div class="ws-browser-footer"><table class="ws-browser-foot" cellspacing="0"><tfoot><tr><td class="ws-browser-pager-cont"></td></tr></tfoot></table></div>':"";d=this._options.display.useDrawingLines?" ws-browser-border":"";if(this._options.display.viewType=="hierarchy"||this._options.display.showToolbar||this._options.display.showHead){e='<div class="ws-browser-head-container"><div class="ws-browser-head-scroller"><table cellspacing="0" class="ws-table-fixed ws-browser-head '+d+'"><colgroup></colgroup><thead></thead></table></div></div>';}if(this._options.display.showActiveRowInFocus===false){this._container.addClass("ws-browser-hide-active-row");}if(!this._options.display.showHead){d+=" ws-browser-border-top";}var g=($ws._const.theme==="wi_scheme"?"":"Загрузка"),f='<div class="ws-browser-ajax-loader ws-hidden"><div class="ws-loading-indicator-outer"><div class="ws-loading-indicator-block"><div class="ws-loading-indicator ws-browser-loading-indicator">'+g+"</div></div></div></div>"+this._getResizerCode(),b='<div class="ws-browser-data-container ws-browser-old" '+this._getBrowserDataContainerStyles()+'><div style="width: 100%;">'+e+'<div class="ws-browser-container-wrapper"><div class="ws-browser-container" tabindex="-1"><table cellspacing="0" class="ws-table-fixed ws-browser'+d+'"><colgroup></colgroup><tbody></tbody></table></div></div><div class="ws-browser-results-block"><table class="ws-table-fixed ws-browser-foot results" cellspacing="0"><colgroup></colgroup><tbody></tbody></table></div>'+c+"</div></div>";this._container.append(f).append(this._rootElement=$(b));this._body=this._rootElement.find(".ws-browser tbody");this._resultBrowser=this._rootElement.find(".ws-browser-foot.results");$ws.proto.Browser.superclass._createContainer.apply(this,arguments);if(this._options.display.allowHorizontalScroll){this._emptyDataScroller=$('<div style="font-size: 0;" class="ws-hidden"></div>').height(1).appendTo(this._browserContainer);if($.browser.msie){this._emptyDataScroller.append("&nbsp;");}}if($ws._const.theme==="wi_scheme"&&this._options.useHoverRowAsActive!==true){this._rowSelection=$('<div class="ws-browser-row-selection"></div>');}},_getBrowserDataContainerStyles:function(){var b="";if(this._options.isRelative&&this._horizontalAlignment==="Stretch"){b=' style="position: absolute; top: 0; left: 0; right: 0;"';}return b;},_getResizerCode:function(){var b="";if(this._options.isRelative&&this._horizontalAlignment==="Stretch"&&this._isHeightGrowable()){b='<div class="ws-browser-resizer" style="position: relative"></div>';}return b;},_updateDataBlockSize:function(){this._setWidth();var b=this._emptyDataBlock.parent().height(),c=this._emptyDataBlock.height("auto").height(),d=this._emptyDataBlock.width("auto").width();if(this._horizontalScrollShowed){b-=this._scrollWidth;}b=Math.max(b,c);this._emptyDataBlock.css({width:"",height:""});this._emptyDataBlock.height(b);this._browserContainer.css({"min-height":c+(this._horizontalScrollShowed?this._scrollWidth:0),"min-width":d+(this._verticalScrollShowed?this._scrollWidth:0)});this._updateSizeVariables();},_onResizeHandler:function(){$ws.proto.Browser.superclass._onResizeHandler.apply(this,arguments);if(this.getActiveRow()!==false){this._setSelection(this.getActiveRow(),true);}},_configChecking:function(){this._options.display.resizable=false;if(this._options.display.viewType!=="tree"){this._options.display.showRoot=false;this._initResultFieldsList();}if(this._options.mode==="navigationMode"){this._options.display.fixedExpand=true;}if(this._options.display.viewType==="tree"){this._options.display.usePaging="";this._options.display.useSorting=false;if(this._options.display.viewMode=="foldersTree"){this.setLoadChildFlag(true);}}if(this._options.display.viewType!=="tree"||this._options.display.partiallyLoad){this._options.selectChilds="";}if(this._options.display.showRoot){this._expanded[this._rootNode]=true;}for(var c=0,b=this._options.display.ladder.length;c<b;c++){this._ladder[this._options.display.ladder[c]]=c;}if(this._options.mode==="navigationMode"&&this._options.display.viewType==="tree"){this._options.useHoverRowAsActive=false;}$ws.proto.Browser.superclass._configChecking.apply(this,arguments);},_onBeforeRenderActions:function(){var b;try{this._inBeforeRenderActionCnt++;b=this._notify("onBeforeRender",this.getColumns());}finally{this._inBeforeRenderActionCnt--;}if(b===false){this._hideLoadingIndicator();return false;}else{if(b instanceof Object){this._options.display.columns=b;this._columnMap=[];}}return true;},_updateResults:function(){if(this._options.display.viewType!=="tree"||this._turn!==""){var g=this._resultBrowser.find(".ws-browser-results").length;if(this._resultFields.length!==0){if(g===0){this._resultBrowser.prepend('<tr class="ws-browser-results"></tr>');}else{this._resultBrowser.find(".ws-browser-results td").remove();}var k=this._columnMap.length;var f=this._currentRecordSet.getResults(),h,b,c,j,e;h=$('<tr class="ws-browser-results"/>');for(var d=0;d<k;d++){j=this._columnMap[d];e="";b=$(this._createTdTemplate(d,undefined,true));if(j.isResultField&&f!==null&&f.hasColumn(j.field)){b.attr("title",j.title);e=f.get(j.field);e=e===null?0:e;switch(j.type){case"Деньги":e=$ws.render.defaultColumn.money(e);break;case"oid":case"int2":case"int4":case"int8":case"Число целое":e=$ws.render.defaultColumn.integer(e);break;}}c=b.find(".ws-browser-cell-container");if(d===0){c.append($('<span class="ws-browser-sigma">'+this._options.display.resultText+"</span><div>"+e+"</div>"));}else{c.text(e);}h.append($(b));}h.append($('<td class="ws-browser-header-cell-scroll-placeholder" width="'+this._scrollWidth+'"/>'));if(typeof(this._options.display.resultsRender)==="function"){this._options.display.resultsRender.apply(this,[h,f]);}this._resultBrowser.find(".ws-browser-results").replaceWith(h);this._setHeight();}else{if(g!==0){this._resultBrowser.find(".ws-browser-results").remove();this._setHeight();}}}},_initResultFieldsList:function(){this._resultFields=[];for(var c=0,b=this._options.display.columns.length;c<b;c++){if(this._options.display.columns[c].isResultField===true){this._resultFields.push(this._options.display.columns[c].field);}}if(this._resultFields&&this._resultFields.length!==0){if(!this._options.display.resultType){this._options.display.resultType="leaves";}this._options.filterParams["_Итоги"]={"ПоляРасчета":this._resultFields,"ВидРасчета":this._resultTypes[this._options.display.resultType]};this._systemParams["_Итоги"]=this._currentFilter["Итоги"]=this._options.filterParams["_Итоги"];}else{delete this._systemParams["_Итоги"];}},_checkRowOptions:function(){if(this._options.display.rowOptions){if(!this._rowOptionsInitialized){this._rowOptionsInitialized=true;this._initRowOptions();}}},_initActionsFlags:function(){$ws.proto.Browser.superclass._initActionsFlags.apply(this,arguments);var c=this._options.display.viewType==="tree"&&this._turn==="",b=this;this._actions.clearSorting=!c&&this._options.display.useSorting&&$.proxy(b.clearSorting,b);this._actions.print=$.proxy(b._showReportsListForList,b);this._actions.printRecord=!Object.isEmpty(this._options.reports)&&function(g,e,f){var d;if(g instanceof Object&&"jquery" in g){if(b._printMenuIsShow){b._printMenu.show(f);b._createPrintMenu([]);b._printMenuIsShow=false;}else{d=b._currentRecordSet.getRecordByPrimaryKey(g.attr("rowkey"));b._showReportsListForRecord(d,g,f);}}else{b._showReportsListForRecord();}};},_filterState:function(b){$ws.proto.Browser.superclass._filterState.apply(this,arguments);if(this.isTree()&&b[this._hierColumnParentId]!==undefined){delete b[this._hierColumnParentId];}},_onEditColumnClick:function(b,c){this._onClickHandler(b);this._startEditTd(c,b);b.stopImmediatePropagation();b.preventDefault();},_enableEditCells:function(b){b.each(function(d,c){$(c).addClass("ws-browser-edit-column").attr("colindex",c.cellIndex);});},_disableEditCells:function(b){b.removeClass("ws-browser-edit-column").removeAttr("colindex");},setCellsEditEnabled:function(f,e,b){var d=this._disabledEditCells[f];if(b){var h=this._findCell(f,b);if(e){if(d!==undefined){if(Object.isEmpty(d)){for(var g in this._columnMap){if(this._columnMap.hasOwnProperty(g)&&this._columnMap[g].title!==b){d[this._columnMap[g].title]=true;}}}else{delete d[b];if(Object.isEmpty(d)){delete this._disabledEditCells[f];}}this._enableEditCells(h);}}else{if(d===undefined||!Object.isEmpty(d)){if(d===undefined){this._disabledEditCells[f]=d={};}d[b]=true;this._disableEditCells(h);}}}else{var c=this._findRow(f).children();if(e){delete this._disabledEditCells[f];this._enableEditCells(c);}else{this._disabledEditCells[f]={};this._disableEditCells(c);}}},_findRow:function(b){var c=this._rowsMap[b]?this._rowsMap[b]:this._body.find('tr[rowkey="'+b+'"]');if(!c||!c.length){$ws.single.ioc.resolve("ILogger").error("Browser","Cannot find row with rowkey "+b);}return c;},_haveRow:function(b){return !!this._rowsMap[b];},_findCell:function(d,b){var c=this._columnIndex(b);if(c>=0){return this._findRow(d).children("td:eq("+c+")");}$ws.single.ioc.resolve("ILogger").error("Browser","Cannot find column with name "+b);return $();},editCell:function(c,b){var d=this._findCell(c,b);if(d.length){this._startEditTd(d);}else{$ws.single.ioc.resolve("ILogger").error("Browser","Cannot find cell with rowkey "+c+" and column name "+b);}},_startEditTd:function(h,f){if(this._options.display.readOnly===true){return;}var b=this,g=h.parent(),d=g.attr("rowkey"),c=h.length?h[0].cellIndex:0,e=function(){b.setActiveElement(g);$ws.core.setCursor(false);return $ws.helpers.callbackWrapper(function(){if(b._editAtPlaceRecord&&b._isIdEqual(d,b._editAtPlaceRecord.getKey())){return b._editAtPlaceRecord;}var i=b._notify("onBeforeRead",d);if(i instanceof $ws.proto.Deferred||i instanceof $ws.proto.Record){return i;}else{if(d==b._addAtPlaceRecordId&&b._addAtPlace){return b._addAtPlaceRecord;}else{return b._currentRecordSet.readRecord(d);}}}(),function(i){$ws.core.setCursor(true);b._editTdAtPlace(i,h,c,f);});};this._runInBatchUpdate("",function(){var i=undefined;if(this._editAtPlaceRecord){clearTimeout(this._editAtPlaceTimer);this._editAtPlaceTimer=undefined;if(!this._isIdEqual(this._editAtPlaceRecord.getKey(),d)){if(!this._editAtPlaceValidationErrors){i=this._editTdUpdateRecord().addCallback(e).addErrback(function(){if(b._editAtPlaceField){b._editAtPlaceField.setActive(true);}});}}else{this._editTdDestroyField();i=e();}}else{if(!this._editAtPlaceValidationErrors){i=e();}}return i;});},_editTdHideContents:function(c){for(var e=0,b=c[0].childNodes,d=b.length;e<d;e++){if(b[e].nodeType==$ws._const.nodeType.TEXT_NODE){b[e].data="";}else{var f=$(b[e]);if(f.hasClass("ws-browser-expander-container")||f.hasClass("ws-browser-text-no-render")||f.hasClass("ws-browser-text-container")){f.css({display:"none"});}else{f.remove();--e;--d;}}}},_editTdKeyEnter:function(){if(this._editTdRecordCanSetData()){var g=this._editAtPlaceCell,f=g.closest("tr"),c=f,b=undefined,e=g[0].cellIndex;while(!b||!b.length){c=c.next();if(!c.length){break;}b=c.find("td[colIndex="+g[0].cellIndex+"]");}if(!this._editAtPlaceValidationErrors){if(b&&b.length){this._startEditTd(b);}else{var d=this;this._editTdSaveRecord().addBoth(function(){if(d._editAtPlaceChanges){if(!b){d._editTdDestroyField();d._editAtPlaceChanges=false;}if(d._options.display.reload){d.reload();}else{if(!b){d.refresh();}}}});}}}},_editTdCancel:function(){if(this._editAtPlaceField){this._runInBatchUpdate("",function(){this._editAtPlaceRecord.rollback();var b=this._editAtPlaceRecord.get(this._columnMap[this._editAtPlaceCell.get(0).cellIndex].field);this._editAtPlaceField.setValue(b);this._editTdDestroyField();this._editAtPlaceValidationErrors=0;if(this._isIdEqual(this._editAtPlaceRecord.getKey(),this._addAtPlaceRecordId)&&this._addAtPlace){this._addAtPlaceCancel();}else{if(this._options.display.reload&&this._editAtPlaceChanges){this._editAtPlaceChanges=false;this.reload();}}this._getElementToFocus().focus();});}},_editTdCancelEdit:function(){this._editAtPlaceRecord.rollback();this._editAtPlaceValidationErrors=0;var c=this._editAtPlaceCell.closest("tr"),e,b=this._columnMap[this._editAtPlaceCellIndex],d=this._renderTD(b,this._editAtPlaceRecord);if(this.isHierarchyMode()&&this._editAtPlaceCellIndex===0){e=this._editAtPlaceCell.find(".ws-browser-text-container");}else{e=this._editAtPlaceCell.find(".ws-browser-cell-container");}this._appendDataToCellContainer(e,d,this._editAtPlaceRecord.get(this._hierColumnIsLeaf)===true,!!b.render,b.allowEditAtThePlace,c.attr("rowkey"),c.attr("parentid"));if(this._isIdEqual(this._editAtPlaceRecord.getKey(),this._addAtPlaceRecordId)&&this._addAtPlace){this._addAtPlaceCancel();}else{if(this._options.display.reload&&this._editAtPlaceChanges){this._editAtPlaceChanges=false;this.reload();}}this._getElementToFocus().focus();},_editTdKeyTab:function(d){var g=!d.shiftKey,b,f=this._editAtPlaceCell;b=f;var c=false;while(true){if(b.length){b=b[g?"next":"prev"]("td");}else{c=true;b=f.closest("tr")[g?"nextAll":"prevAll"](".ws-visible:first").find(g?"td:first":"td:last");if(!b.length){break;}}if(b.length){f=b;}if(b.hasClass("ws-browser-edit-column")){break;}}if(this._editTdRecordCanSetData()||!c){if(b&&b.length){this._editTdFieldValueChange();this._startEditTd(b,d);}else{this._editTdUpdateRecordAndReload();}}},_editTdFieldConfig:function(h,g,b){var f={name:h.field,width:g,linkedContext:new $ws.proto.Context().setPrevious(this.getLinkedContext()),parent:this.getParent(),validators:h.validators,tabindex:-1};if(h.type==="Текст"){f.height=b;}else{if(h.type==="Число целое"||h.type==="Число вещественное"||h.type==="Деньги"){f.maxlength=255;f.delimiters=h.type==="Деньги";if(h.type==="Число вещественное"){f.decimals=h.decimals||9;}else{if(h.type==="Деньги"){f.decimals=2;}}}else{if(h.type==="Дата и время"){f.mask=h.maskField?h.maskField:"DD.MM.YY HH:II";}else{if(h.type==="Дата"){f.mask=h.maskField?h.maskField:"DD.MM.YY";}else{if(h.type==="Время"){f.mask=h.maskField?h.maskField:"HH:II";}else{if(h.type==="Логическое"){f.caption="";}else{if(h.type==="Флаги"){var i=this.getActiveRecord().get(h.field).getColumns(),c={};for(var e=0,d=i.length;e<d;e++){c[i[e]]={caption:i[e],isThirdPosition:true};}f.elements=c;}else{f.maxlength=255;f.inputFilter=h.inputFilter;}}}}}}}return f;},_editTdInitField:function(i,b){var c=i.getContainer(),j=c.closest("td"),d=j.parent(),g=this._columnMap[this._editAtPlaceCellIndex];c.height("").addClass("clearfix");var f=c.outerHeight();j.find("div.ws-browser-cell-container").height(f);d.height(f);i.getContainer().height(f);i.setActive(true);i.getLinkedContext().setContextData(this._editAtPlaceRecord);var k=i.getContainer().find(".ws-field :first-child")[0];if($.browser.msie&&k.createTextRange){k.createTextRange().select();}else{if($.browser.opera){var e=document.createRange();e.selectNode(k);window.getSelection().addRange(e);}else{if(typeof(k.select)=="function"){k.select();}}}this._editAtPlaceField=i;this._notifyOnSizeChanged(this,this,true);},_editTdAtPlace:function(b,e,c,d){this._runInBatchUpdate("",function(){var p=this,m=$("<div class='ws-browser-edit-field' />"),n=this._columnMap[c],k=e.find("div.ws-browser-cell-container"),j=e.closest("tr"),g=e.find(".ws-browser-cell-container").width(),o=k.height(),h=j.attr("rowkey");if(k.hasClass("ws-browser-validation-error")){p._editAtPlaceWithValidationError=true;k.removeClass("ws-browser-validation-error");}else{p._editAtPlaceWithValidationError=false;}k.removeClass("ws-browser-div-cut").addClass("ws-browser-has-edit-field");this._editAtPlaceCellIndex=c;this._editAtPlaceRecord=b;this._editAtPlaceCell=e;j.addClass("ws-browser-editable-row");m.css({width:g,height:o,position:"relative"});this._editTdHideContents(k);m.data("fieldIndex",c);m.data("oldFieldContainerHeight",k.height());m.data("oldTrHeight",j.height());k.prepend(m);if(!this._editAtPlaceFocusCallback){this._editAtPlaceFocusCallback=$.proxy(this._editTdFocusLost,this);$("body").bind("click.edit_"+this.getId(),this._editAtPlaceFocusCallback);}var i=this._editTdFieldConfig(n,g,o),l=p._fieldTypesForEdit[n.type]?p._fieldTypesForEdit[n.type]:p._fieldTypesForEdit["Строка"];i.element=m;i.handlers={onKeyPressed:function(q,r){if(r.which===$ws._const.key.insert){r.stopPropagation();r.preventDefault();}if(r.which===$ws._const.key.enter||r.which===$ws._const.key.esc||r.which===$ws._const.key.tab){r.stopPropagation();r.preventDefault();if(r.which===$ws._const.key.enter){p._editTdKeyEnter();}else{if(r.which===$ws._const.key.esc){p._editTdCancel();}else{p._editTdKeyTab(r);}}}return false;},onFocusOut:this._editAtPlaceFocusCallback};var f=p._notify("onBeforeEditColumn",b,l,i);if(f&&f instanceof Array&&f.length==2){l=f[0];i=f[1];}return $ws.core.attachInstance("Control/"+l,i).addCallback(function(q){p._editTdInitField(q,d);});});},_showEmptyDataBlock:function(){if(this._options.display.allowAddAtThePlace){var b=this._container.find(".ws-browser");if(b.find("tr").size()===1){this._emptyDataBlock.show();}}},_editTdFocusLost:function(){if(this._editAtPlaceField){var b=this;this._editTdFieldValueChange();this._editTdDestroyField();if(!this._editAtPlaceValidationErrors){this._editAtPlaceTimer=setTimeout(function(){b._editTdUpdateRecordAndReload();},$ws._const.Browser.editAtPlaceWait);}}this._showEmptyDataBlock();},_editTdFieldValueChange:function(){var c=this._editAtPlaceRecord.getKey(),b=this._currentRecordSet.contains(c)&&this._currentRecordSet.getRecordByPrimaryKey(c),d=this._columnMap[this._editAtPlaceCellIndex];this._notify("onFieldChange",this._editAtPlaceRecord,d.field,d.title,this._editAtPlaceRecord.get(d.field),b?b.get(d.field):null);},_editTdRecordCanSetData:function(){if(this._editAtPlaceField){if(this._editAtPlaceField.validate()){return true;}}else{return true;}return false;},_editTdSaveRecord:function(){var e=this,d=this._editAtPlaceRecord;if(this._editAtPlaceValidationErrors===0){var c=this._notify("onBeforeUpdate",d);if(typeof(c)!=="boolean"){if(this._addAtPlace&&this._isIdEqual(this._addAtPlaceRecordId,d.getKey())){return this._addAtPlaceOk();}else{$ws.core.setCursor(false);this._isUpdatingRecords=true;this._editAtPlaceChanges=true;var f=new $ws.proto.Deferred(),b=this._container.find(".ws-browser-ajax-loader").removeClass("ws-hidden"),g;$ws.helpers.clearSelection();g=d.update();g.addBoth(function(h){b.addClass("ws-hidden");$ws.core.setCursor(true);e._isUpdatingRecords=false;if(g.isSuccessful()){e._editTdFieldValueChange();var m=e._editAtPlaceRecord.getKey(),j=e._currentRecordSet.contains(m)&&e._currentRecordSet.getRecordByPrimaryKey(m);if(j){var l=j.getColumns();for(var k=0;k<l.length;++k){if(d.hasColumn(l[k])){j.set(l[k],d.get(l[k]));}}}e._editAtPlaceRecord=undefined;e._notify("onRecordsChanged");f.callback();}else{d.rollback();$ws.core.alert("Данные не были обновлены!");e._editAtPlaceRecord=undefined;f.errback(h);}return h;});return f;}}if(c===true){this._addAtPlaceRecordId=undefined;return new $ws.proto.Deferred().callback();}}if(c===true){this._endAddAtPlace();return new $ws.proto.Deferred().callback();}else{return new $ws.proto.Deferred().errback();}},_editTdUpdateRecordAndReload:function(){var b=this;return this._editTdUpdateRecord().addCallbacks(function(){if(b._options.display.reload&&b._editAtPlaceChanges===true){b._editAtPlaceChanges=false;b.reload();}},function(){if(b._editAtPlaceField){b._editAtPlaceField.setActive(true);}});},_editTdUpdateRecord:function(){if(this._editTdRecordCanSetData()){this._editTdDestroyField();clearTimeout(this._editAtPlaceTimer);this._editAtPlaceTimer=undefined;if(this._addAtPlace||this._editAtPlaceRecord.isChanged()){if(this._options.display.askConfirmSaving){var b=this,c=new $ws.proto.Deferred();$ws.core.attachInstance("SBIS3.CORE.DialogConfirm",{resizable:false,message:"Сохранить изменения?",handlers:{onConfirm:function(e,d){if(d){b._editTdSaveRecord().addCallback(function(){c.callback();});}else{b._editTdCancelEdit();}}}});return c;}else{return this._editTdSaveRecord();}}else{return new $ws.proto.Deferred().callback();}}return new $ws.proto.Deferred().errback();},_editTdDestroyField:function(){if(!this._editAtPlaceField){return;}this._runInBatchUpdate("",function(){var m=this._editAtPlaceField.getContainer(),h=m.closest("tr"),j=m.parent(),o=parseInt(m.data("fieldIndex"),10),n=isNaN(o)?false:this._columnMap[o];h.removeClass("ws-browser-editable-row");m.parent().height(m.data("oldFieldContainerHeight"));h.height(m.data("oldTrHeight"));m.height(m.data("oldFieldContainerHeight"));if(!this._options.display.cutLongRows){j.removeClass("ws-browser-div-cut");}var d=this._editAtPlaceField.validate(),b=this._editAtPlaceWithValidationError;if(!b&&!d){if(++this._editAtPlaceValidationErrors===1&&this._addAtPlaceLinkRow){this._addAtPlaceLinkRow.addClass("ws-browser-add-disabled");}this._editAtPlaceValidationMap[o]=true;}else{if(b&&d){if(--this._editAtPlaceValidationErrors===0&&this._addAtPlaceLinkRow){this._addAtPlaceLinkRow.removeClass("ws-browser-add-disabled");}delete this._editAtPlaceValidationMap[o];}}this._editAtPlaceField.unsubscribe("onFocusOut",this._editAtPlaceFocusCallback);this._editAtPlaceField.destroy();this._editAtPlaceField=null;if(this._options.display.ladder.length!==0){this.refresh();}else{if(this._editAtPlaceRecord&&n){var g=this._renderTD(n,this._editAtPlaceRecord);j.attr("title",(g instanceof Object&&"jquery" in g)?g.text():((g===null||g===undefined)?"":g));j.removeClass("ws-browser-has-edit-field");for(var f=0,p=j.children(),e=p.length;f<e;f++){var c=$(p[f]);if(c.hasClass("ws-browser-expander-container")||c.hasClass("ws-browser-text-no-render")||c.hasClass("ws-browser-text-container")){c.css({display:"block"});}}if(this._editAtPlaceValidationMap[o]){j.addClass("ws-browser-validation-error");}if(this.isHierarchyMode()&&o<=0){j=h.find(".ws-browser-text-container");}var k=this._options.editMode=="newDialog"&&(this.isHierarchyMode()?this._options.editBranchMode:true),q=k?false:this.isHierarchyMode()&&this._editAtPlaceRecord.get(this._hierColumnIsLeaf)===true;this._appendDataToCellContainer(j,g,q,!!n.render,n.allowEditAtThePlace,h.attr("rowkey"),h.attr("parentid"));}}this._notifyOnSizeChanged(this,this,true);});},openAll:function(){return this._runInBatchUpdate("Browser.openAll",function(){var b=this;if(this._options.display.viewType==="tree"){$(this._body).find("tr.ws-browser-folder").each(function(){var c=$(this).attr("rowkey");c=c==="null"?null:c;b._expanded[c]=true;});this._reloadBody();}});},_showRecordDialog:function(d,c,f,b,e){this._isInsertOnFolderInTree=false;if(this._editAtPlaceValidationErrors||this._editAtPlaceField){return;}if(d===undefined&&this._options.display.allowAddAtThePlace){this._createRowAtThePlace(f,c,b);}else{$ws.proto.Browser.superclass._showRecordDialog.apply(this,arguments);}},_createRowAtThePlace:function(f,e,b){if(this._editAtPlaceValidationErrors){return;}var d=this;var c=this._notify("onBeforeInsert",f);if(c!==false){$ws.helpers.callbackWrapper(this._beforeCreateRowAtThePlace(f),function(){var h=function(){$ws.core.setCursor(false);d._readRecord(undefined,f,e,b).addCallback(function(i){if(i instanceof $ws.proto.Record){$ws.core.setCursor(true);var j=false;if(d.isHierarchyMode()){var k=i.get(d._hierColumnParentId);if(k!=f){f=k;j=true;}}$ws.helpers.callbackWrapper(j&&d.showBranch(f),function(){d._addAtPlace=true;d._addAtPlaceRecord=i;d._addAtPlaceRecordId=i.getKey();if(d._addAtPlaceRecordId===null){d._addAtPlaceRecordId="null";}var o,n=0;if(d._options.display.viewType==="tree"){o=d._body.find('tr[rowkey="'+f+'"]:first');n=o.length?(parseInt(o.attr($ws._const.Browser.treeLevelAttribute),10)+1):0;}if(!o||!o.length){o=d._body.find(".ws-browser-add-at-place-link-row").prev("tr[rowkey]");}var m=$(d._createTR(i,n,o));m.addClass("ws-add-at-place");if(e){m.find(".ws-browser-expander").removeClass("ws-browser-expander minus").addClass("folder");}if(o&&o.length){m.insertAfter(o);}else{d._body.prepend(m);}if(d._count===0){d._emptyDataBlock.hide();d._data.removeClass("ws-indent-top");d._emptyDataBlock.removeClass("ws-back");}d._heightChangedIfVisible();d.zebraBody(d._options.display.hasZebra);d._addAtPlaceRow=m;d.setActiveRow(m);for(var l in d._columnMap){if(d._columnMap.hasOwnProperty(l)){if(d._columnMap[l].allowEditAtThePlace){var p=m.find("td[colindex="+l+"]");if(p.length){d._editTdAtPlace(i,p,l);break;}}}}});}});};var g=(d._editAtPlaceRecord&&d._editTdRecordCanSetData()&&d._editTdUpdateRecordAndReload())||!d._editAtPlaceField;if(g){$ws.helpers.callbackWrapper(g,h);}else{if(d._editAtPlaceField){d._editAtPlaceField.setActive(true);}}});}},_addAtPlaceOk:function(){var b=this._addAtPlaceRecord.update(),c=this;this._isUpdatingRecords=true;this._editAtPlaceChanges=true;b.addCallback(function(d){c._currentRecordSet.readRecord(d,c._options.dataSource.readerParams.linkedObject+".Список").addCallback(function(f){c._isUpdatingRecords=false;var e=c._body.find(".ws-add-at-place"),i=e.attr($ws._const.Browser.treeLevelAttribute),h=$(c._createTR(f,i));h.insertAfter(e);var g=e.find(".ws-browser-row-selection");if(g.length){c.setActiveElement(h);}e.remove();return f;});return d;});this._endAddAtPlace();return b;},_addAtPlaceCancel:function(){this._addAtPlaceRecord.destroy();this._addAtPlaceRow.empty().remove();this._endAddAtPlace();},_endAddAtPlace:function(){if(this._count===0){this._emptyDataBlock.show();this._data.addClass("ws-indent-top");this._emptyDataBlock.addClass("ws-back");}this._addAtPlace=false;this._addAtPlaceRecord=undefined;this._addAtPlaceRow=undefined;if(!this._options.display.reload){this._createAddAtPlaceLinkRow(this._body);}},_beforeCreateRowAtThePlace:function(c){var b=this._isIdEqual(this._rootNode,c);if(this._options.display.viewType==="tree"&&!this._expanded[c]&&(b&&this._options.display.showRoot||!b)){return this._processTreeClick(c,false);}return null;},setSelection:function(b){$ws.proto.Browser.superclass.setSelection.apply(this,arguments);this._rebuildPartialSelection();},clearSelection:function(b){$ws.proto.Browser.superclass.clearSelection.apply(this,arguments);this._rebuildPartialSelection();},removeSelection:function(){$ws.proto.Browser.superclass.removeSelection.apply(this,arguments);this._rebuildPartialSelection();},selectAll:function(){if(this._options.selectChilds){this._selected=[];this._selectedRecords=[];var b=this,c=function(e){b._selectRow(e);var f=b._currentRecordSet.recordChilds(e);for(var d=0;d<f.length;++d){c(f[d]);}};c(this._rootNode);this._updatePager();}else{$ws.proto.Browser.superclass.selectAll.apply(this,arguments);}},setSelectionMode:function(){$ws.proto.Browser.superclass.setSelectionMode.apply(this,arguments);},isShow:function(b){if(this._options.display.viewType=="tree"){if(b===this._rootNode){return true;}else{return this._turn===""?this._expanded[b]!==undefined:this._body.find('tr[rowkey="'+b+'"]').length!==0;}}else{return $ws.proto.Browser.superclass.isShow.apply(this,arguments);}},_showBranchAfterPathLoad:function(b,c){if(this._options.display.viewType==="tree"&&c){this._selectAfterPathLoad=b;}},_showBranchTree:function(c,h){if(this._isIdEqual(c,this._rootNode)){if(!this._expanded[this._rootNode]){if(this._haveRow(c)){this._processTreeClick(c,false);}if(!h){this.setActiveElement(this._body.find('tr[rowkey="'+c+'"]'));}}return undefined;}var j=[],e=c,g,b=this._hierColumnIsLeaf,d=this._hierColumnParentId;if(e&&e!=this._rootNode&&!this._currentRecordSet.contains(e)){return undefined;}g=this._currentRecordSet.getRecordByPrimaryKey(e);if(!g.get(b)){e=g.get(d)||null;}while(e&&e!=this._rootNode){j.push(e);if(this._currentRecordSet.contains(e)){g=this._currentRecordSet.getRecordByPrimaryKey(e);}else{throw new Error("Something wrong with the showBranch!");}e=g.get(d)||null;}if(this._options.mode==="navigationMode"){this._closeOtherBranches(c);}for(var f=j.length-1;f>=0;--f){g=this._currentRecordSet.getRecordByPrimaryKey(j[f]);if(g.get(this._hierColumnIsLeaf)===false){c=j[f];break;}if(!this._expanded[j[f]]){this._expanded[j[f]]=true;}}if(this._options.display.partiallyLoad&&this._currentRecordSet.getRecordByPrimaryKey(c).get(b)&&!this._loaded[c]){var l=this._currentRecordSet.loadNode(c,false),k=this;if(!h){l.addCallback(function(){k.setActiveElement(k._body.find('tr[rowkey="'+c+'"]'));});}return l;}else{this._drawBody();this._updatePager();}if(!h){this.setActiveElement(this._body.find('tr[rowkey="'+c+'"]'));}return undefined;},_showActiveFolderOrElement:function(b,c){if(this._options.display.viewType==="tree"){return this._showBranchTree(b,c);}else{return $ws.proto.Browser.superclass._showActiveFolderOrElement.apply(this,arguments);}},hideBranch:function(b){if(this._options.display.viewType==="tree"&&this._turn===""){this._processTreeClick(b,true);}},_mapColumns:function(){var b=this._options.display.columns,e=this._currentRecordSet.getColumns(),c=b?b:e,d=this._currentRecordSet.getPkColumnIndex(),g=0;if(c){for(var f in c){if(c.hasOwnProperty(f)){var m=c[f],l=m.field?m.field:m.title,k=m.title,j=b&&b[f]?b[f].allowEditAtThePlace:false,h=e[l]?e[l].type:(m.type?m.type:null);if(this._options.display.readOnly===true){j=false;}if(j&&e[l]&&e[l].index===d){j=false;}if(j&&h==="Связь"||h==="Файл"||h==="Двоичное"||h==="Символ"){j=false;}this._columnMap[g]={title:k,isSortable:m.field!==undefined&&(m.isSortable!==undefined?m.isSortable:true),field:l,render:m.render?m.render:null,type:h,allowEditAtThePlace:j===undefined?false:j,fixedSize:m.fixedSize?m.fixedSize:false,isResultField:m.isResultField===undefined?false:m.isResultField,textAlign:m.textAlign?m.textAlign:"auto",className:m.className?m.className:"",captionAlign:m.captionAlign?m.captionAlign:"auto",captionRender:m.captionRender?m.captionRender:null,formatValue:m.formatValue?m.formatValue:null,validators:m.validators?m.validators:[],filterDialog:m.filterDialog?m.filterDialog:null,filterName:m.filterName?m.filterName:k,visualFilterFunction:m.visualFilterFunction?m.visualFilterFunction:null,verticalAlign:m.verticalAlign?m.verticalAlign:null,decimals:m.decimals?m.decimals:9,inputFilter:m.inputFilter?m.inputFilter:"",minWidth:m.minWidth||null,useForFolder:m.useForFolder?m.useForFolder:null};if(j&&(h in {"Дата":0,"Дата и время":0,"Время":0})){this._columnMap[g].maskField=m.maskField?m.maskField:null;}if(j===true&&!this._useEditAtThePlace){this._useEditAtThePlace=true;}if(l===this._options.display.titleColumn){this._titleColumnIndex=g;}this._columnMap[g].width=m.width?parseInt(m.width,10):(this._getDefWidth(this._columnMap[g].type));g++;}}this._createRowTemplates();}},_columnIndex:function(b){for(var c in this._columnMap){if(this._columnMap.hasOwnProperty(c)&&this._columnMap[c].title===b){return c;}}return -1;},_getDefWidth:function(b){if(b&&$ws._const.Browser.defColWidth[b]){return $ws._const.Browser.defColWidth[b];}return null;},_getNodeForRecordUpdate:function(b){if(this._options.display.viewType==="tree"&&this._turn===""){if(!this._options.display.partiallyLoad){return this._rootNode;}var c=this.getActiveRecord();if(c){if(b){var e=b.get(this._hierColumnParentId),d=c.get(this._hierColumnParentId);if(e!==d&&this._currentRecordSet.contains(e)){return[e,d];}else{return d;}}return this._isInsertOnFolderInTree?c.getKey():c.get(this._hierColumnParentId);}return b.get(this._hierColumnParentId);}else{return !this._options.display.partiallyLoad?this._rootNode:this._options.display.viewType==="hierarchy"?this._currentRootId:$ws.proto.Browser.superclass._getNodeForRecordUpdate.apply(this,arguments);}},_getHandlersForDeleteRecordDialog:function(c){var b=this,d;d=$ws.proto.Browser.superclass._getHandlersForDeleteRecordDialog.apply(this,arguments);d.onSuccess=function(){if(b._options.display.viewType==="tree"){b._hovered=c;b._activeElement=undefined;}};return d;},_headCellClick:function(e){var d=e.data.columnId,n=e.data.self,m=n._columnMap[d].field,g=0,o=false;for(var h=n._sortingStack.length-1;h>=0;--h){if(!n._sortingStack[h]){continue;}if(n._sortingStack[h]["field"]==m){o=true;g=++n._sortingStack[h]["type"];if(g==2){delete n._sortingStack[h];}break;}}if(!o){n._sortingStack.push({field:m,type:0});}var f=$(this).find(".ws-browser-sortable"),b=["asc","desc","none"];f.removeClass(b[(g+2)%3]);f.addClass(b[g]);if(n._currentRecordSet&&n._currentRecordSet instanceof $ws.proto.RecordSet){var j=[];for(var l=0,k=n._sortingStack.length;l<k;++l){if(!n._sortingStack[l]){continue;}j.push([n._sortingStack[l]["field"],n._sortingStack[l]["type"]>0]);}n._currentRecordSet.setPage(0,true);n._currentRecordSet.setSorting(j,n.getQuery(),n._options.display.viewType==="hierarchy");}},_drawHead:function(){if(this._columnMap.length){return;}this._mapColumns();this._sortingMarkers={};var z=0,e=[],A,y=-1,f=0,B=0,u=null,q,o;for(A in this._columnMap){if(this._columnMap.hasOwnProperty(A)){e[++y]=[];f++;var C=this._columnMap[A].title,h=0,c;do{/^([^\.]*)(\.?(.*)$|$)/.exec(C);if(RegExp.$3){if(RegExp.$3.substr(0,1)===" "&&(RegExp.$1.charAt(RegExp.$1.length-1)!=="\\")){c=RegExp.$1;if(c.substr(-2)=="\\\\"){c=c.substr(0,c.length-2);}c+=".";/^([^\.]*)(\.?(.*)$|$)/.exec(RegExp.$3);c+=RegExp.$1;if(RegExp.$3===""){if(c.substr(-2)=="\\\\"){c=c.substr(0,c.length-2);}c+=".";}e[y].push(c);C=RegExp.$3;}else{e[y].push(RegExp.$1);C=RegExp.$3;}}else{c=RegExp.$1+RegExp.$2;e[y].push(c);C=null;}}while(C);h=0;while(h<e[y].length-1){if(e[y][h]!==""){var w=e[y][h];e[y][h]=e[y][h].replace(/\\\\\\./g,"\\.");if(w.charAt(w.length-1)==="\\"&&w.charAt(w.length-2==="\\")){e[y][h]=e[y][h].replace(/\\\\$/,".");e[y][h]+=e[y][h+1];e[y].splice(h+1,1);h--;}}h++;}z=e[y].length>z?e[y].length:z;}}this._rootElement.find("col").remove();if(f>0){var p=$ws.helpers.reduce(this._columnMap,function(k,j){var i;if((j.fixedSize||this._haveAutoWidth())&&(i=j.width)){k.push('<col width="',i,'"/>');}else{k.push("<col/>");}return k;},[],this).join("");this._rootElement.find("colgroup").append(p);}if(this._options.display.showHead){this._head.find("tr").empty().remove();var t=this;for(var v=0;v<z;v++){var g=this._head.get(0).insertRow(-1);g.className="ws-browser-head-"+(v===0?"top":"bottom");y=-1;for(A in this._columnMap){if(this._columnMap.hasOwnProperty(A)){++y;if(e[y][v]!==undefined&&(y===0||e[y][v]!=e[y-1][v])){u=null;var d=y;for(d=y;d<f&&e[d][v]==e[y][v];d++){}d--;var m;for(m=v+1;m<z&&e[y][m]===undefined;m++){}m--;var b=$(g.insertCell(-1)).addClass("ws-browser-header-cell").attr("csIndex",B);if(this._columnMap[y]&&this._columnMap[y].verticalAlign!=="center"){switch(this._columnMap[y].verticalAlign){case"bottom":b.addClass("ws-browser-valign-bottom");break;case"top":b.addClass("ws-browser-valign-top");break;}}if(this._options.display.useSorting&&m+1==z&&this._columnMap[A].isSortable){b.addClass("ws-browser-head-hover");b.bind("click",{columnId:A,self:this},this._headCellClick);}if(this._columnMap[A].captionAlign&&this._columnMap[A].captionAlign!=="auto"){b.addClass("ws-browser-"+this._columnMap[A].captionAlign);}if((d==y&&this._columnMap[A].type=="text")){b.addClass("ws-browser-text");}if(d>y){b.attr("colspan",(d-y+1).toString());B+=d-y+1;}else{B++;}if(m>v){b.attr("rowspan",(m-v+1).toString());}if(this._options.display.resizable){if(y!==0&&e[y+(d-y)][v]!==""){b.addClass("ws-browser-resizable").append($('<span class="ws-browser-resize">&nbsp;</span>'));}}var s="";for(var x=0;x<=v;x++){s+=(x===0?"":".")+e[y][x];}if(typeof(this._columnMap[A].captionRender)=="function"){u=this._columnMap[A].captionRender.apply(this,[s]);}else{if(typeof(this._options.display.headColumnRender)=="function"){u=this._options.display.headColumnRender.apply(this,[s]);}}u=u||e[y][v];b.append(q=$("<div></div>"));if(this._options.display.useSeparating===true&&y<(e.length-1)){q.closest("td").addClass("ws-browser-separatable");}if(this._options.display.showSelectionCheckbox===true&&!this._options.display.showRoot&&y===0&&v===(e[0].length-1)){var r=$('<span class="ws-browser-checkbox"></span>');r.click(function(i){var j=$(this).closest("tr");if(!j.hasClass("ws-browser-selected")){t.selectAll();j.addClass("ws-browser-selected");}else{t.removeSelection();j.removeClass("ws-browser-selected");}i.preventDefault();i.stopPropagation();return false;});b.prepend(r);}if(this._options.display.useSorting===true){q.append(this._sortingMarkers[this._columnMap[A].field]=$('<div class="ws-browser-sortable none"></div>'));}if(u instanceof Object&&"jquery" in u){q.append(u);}else{if(!t._columnMap[y].filterDialog){q.append("<div>"+$ws.helpers.escapeHtml(u).replace(/\n/mg,"<br>")+"</div>");}else{q.append(o=$("<div></div>"));o.append($('<a href="javascript:void(0)" class="ws-browser-head-link" hasFilter="true" id="'+A+'">'+u+'</a><span class="ws-browser-filter" hasFilter="false"></span>'));if(this._initialFilter){this._markFilteredColumn(this._initialFilter,A);}$("[hasFilter]",o[0]).live("click",function(j){var i,k;k=this.id?this.id:$(this).prev(".ws-browser-head-link").attr("id");i=t._columnMap[k];if($(this).attr("hasFilter")==="true"){t.createFiltersDialog.apply(t,[i.filterDialog,k]);}else{t.resetFilterByColumnName.apply(t,[i.title]);}j.preventDefault();j.stopPropagation();return false;});}}}}}var l=g.insertCell(-1);l.innerHTML="&nbsp";l.width=this._scrollWidth;l.style.display="none";$(l).addClass("ws-browser-header-cell-scroll-placeholder");}if(typeof(this._options.display.headRender)=="function"){this._options.display.headRender.apply(this,[this._head]);}}this._initHeadVariables();},_initHeadVariables:function(){$ws.proto.Browser.superclass._drawHead.apply(this,arguments);this._headColumns=this._head.parent().find("col");this._bodyColumns=this._body.parent().find("col");this._resultsColumns=this._rootElement.find(".ws-browser-foot.results").find("col");this._initColumnsWidth();if(this._options.display.resizable){this._initResizeEvents();}},_initEvents:function(){$ws.proto.Browser.superclass._initEvents.apply(this,arguments);this._checkRowOptions();if(this._useEditAtThePlace===true){this.subscribe("onKeyPressed",this._onKeyPressedOnBrowser);}var b=this,c,d=this._body.parent()[0];$("td.ws-browser-edit-column > div",d).live("click",function(f){if(b.isEnabled()){b._onEditColumnClick(f,$(this).closest("td"));}});if((this._options.display.viewType==="tree"&&this._turn==="")||this._options.display.viewType==="foldersTree"){var e=function(i){i.stopPropagation();var j=$(this).parents("tr"),h=j.attr("rowkey"),g=b._currentRecordSet.contains(h)?b._currentRecordSet.getRecordByPrimaryKey(h):undefined;if(b.isEnabled()){var f=b._notify("onRowClick",j,g,b._columnMap[0].title,b._columnMap[0].field);if(f!==false){b._processElementClick(j,h,g);}else{b._notifySetCursor(j,g);}}};$(".ws-browser-expander",d).live("click",e);}if(this._options.allowMove&&!this._options.display.readOnly&&this.isHierarchyMode()&&this._turn===""){$("[rowkey]",d).live("mousedown",function(j){var k=$(j.target),f=false;for(var h=0;h<j.target.childNodes.length;++h){if(j.target.childNodes[h].nodeType==$ws._const.nodeType.TEXT_NODE){f=true;break;}}if(k.closest("a").length===1){f=true;}if(!f){return true;}if(k.prop("nodeName").toLowerCase()!=="tr"){k=k.parents(".ws-browser tr");}var g=k.attr("rowkey");if(j.which!==1||!b.isEnabled()||!b._currentRecordSet.contains(g)){return true;}b.setActiveElement(k,false,true);b._dragRecords=b.getSelection();if(b._notify("onDragStart",b._dragRecords)===false){return true;}b._dragStartPoint.x=j.clientX;b._dragStartPoint.y=j.clientY;b._dragRow=k;b._dragBrowser=b._browserContainer;b._useKeyboard=true;$(document).bind("mousemove",$.proxy(b._recordsMouseMove,b)).bind("mouseup",$.proxy(b._recordsMouseUp,b));return false;});}$(".ws-browser-checkbox",d).live("click",function(g){var f=$(this);b._runInBatchUpdate("ws-browser-checkbox click",function(){if(b.isEnabled()){b._selectActiveElement(f.parents(".ws-browser tr"));}});g.stopImmediatePropagation();return false;});},_initRowOptions:function(){if(this.isEnabled()){var b=this;b._browserContainer.bind("mousemove",function(e){var c=$(e.target),d=c;if(e.target.nodeName.toLowerCase()!="tr"){d=d.parents(".ws-browser tr");}b._hideRowOptionsForRow.apply(b,[c,d]);});$("tr",b._body.parent()[0]).live("mouseenter",function(c){b._showRowOptions.apply(b,[c.target]);});this._rootElement.find(".ws-browser-container-wrapper").bind("mouseleave",function(c){if(!b._rowOptionsMenuVisible){if((b._actions.printRecord&&!b._printMenuIsShow)||!b._actions.printRecord){b._hideRowOptions();}}else{b._rowOptionsTargetRow=undefined;}});}},_hideRowOptionsForRow:function(b,c){if(!c||c.length===0||c.parents("table").get(0)!=this._data.get(0)){if(b.parents(".ws-browser-row-options-block").length===0&&!b.hasClass("ws-browser-row-options-block")){if(!this._rowOptionsMenuVisible){this._hideRowOptions();}else{this._rowOptionsTargetRow=undefined;}}return true;}},_showRowOptions:function(f){var d=$(f),e=d;if(f.nodeName.toLowerCase()!="tr"){e=e.parents(".ws-browser tr");}this._hideRowOptionsForRow.apply(this,[d,e]);var c=e.attr("rowkey"),b=this._currentRecordSet.contains(c)&&this._currentRecordSet.getRecordByPrimaryKey(c);if(!b&&!this._isIdEqual(this._rootNode,c)){this._hideRowOptionsForRow.apply(this,[d]);return true;}if(this._rowOptionsMenuVisible||(this._actions.printRecord&&this._printMenuIsShow)){this._rowOptionsTargetRow=e;return true;}this._showRowOptionsForRow(e);},_uninitRowOptions:function(){this._browserContainer.unbind("mousemove");$("tr",this._body.parent()[0]).die("hover");this._rootElement.find(".ws-browser-container-wrapper").unbind("mouseleave");},_onKeyPressedOnBrowser:function(b,c){if(c.which===$ws._const.key.enter&&this._editAtPlaceField!==null){c.preventDefault();c.stopPropagation();return false;}},_onScrollActions:function(){if(this._hasRowOptions){this._hideRowOptions();}},_hideRowOptions:function(){if(this._rowOptionsMenuVisible){this._rowOptionsMenuVisible=false;this._rowOptionsCurrentMenu.show({});}if(this._rowOptionsElement){this._rowOptionsElement.hide();}this._rowOptionsTargetRow=this._rowOptionsHoverRow=undefined;this._rowOptionsHoverRecord=undefined;},_showRowOptionsForRow:function(i){var e=i.attr("rowkey"),c=this._currentRecordSet.contains(e)&&this._currentRecordSet.getRecordByPrimaryKey(e);if(!i.hasClass("ws-add-at-place")&&(c||this._isIdEqual(this._rootNode,e))){var g=[],d=(!c||(this.isHierarchyMode()&&c.get(this._hierColumnIsLeaf)===true))?1:0;if(!c){g=["edit","delete","printRecord","copy","history","move"];}else{if(this._rowOptionsDisableStandart===true){g=["edit","delete","printRecord","copy","history","move","addItem","addFolder"];}else{if(this._rowOptionsDisableStandart!==false){g=this._rowOptionsDisableStandart;}}}if(!d){g.push("addItem","addFolder","move");}g=this._rowOptionsFilterConcat(g);this._refilterRowOptions(g);var b=$ws.core.merge({},this._rowOptions,{clone:true}),f=this._notify("onRowOptions",c,i,this._rowOptions);if(f!==false){this._rowOptionsHoverRow=this._rowOptionsTargetRow=i;this._rowOptionsHoverRecord=c;var h=i.height();if(!(f instanceof Array)){f=[];}this._createRowOptions();f=f.concat(this._updateRowOptions(b));this._refilterRowOptions(g.concat(f));this._applyRowOptions();if(this._hasRowOptions&&this._rowOptionsElement&&i.parent().parent().length){this._rowOptionsElement.css({top:i.position().top+$ws._const.Browser.rowOptionsElementsOffset.top,right:(this._verticalScrollShowed?this._scrollWidth:0)+$ws._const.Browser.rowOptionsElementsOffset.right,height:h}).show();if($ws._const.theme!="wi_scheme"){this._rowOptionsElement.find(".ws-browser-row-option-border").css("top",(h/2-10)+"px");}return;}}}this._hideRowOptions();},_updateRowOptions:function(b){var e=[];for(var d=0;d<this._rowOptionsDefault.length;++d){var c=this._rowOptionsDefault[d][3]||this._rowOptionsDefault[d][2];if(b.hasOwnProperty(c)&&this._rowOptions.hasOwnProperty(c)){if(b[c]["title"]!=this._rowOptions[c]["title"]){if(this._rowOptionsButtons[c]){this._rowOptionsButtons[c].attr("title",this._rowOptions[c]["title"]);}if(this._rowOptionsMenu instanceof Object){this._rowOptionsMenu.setItemText(this.getId()+"_"+c,this._rowOptions[c]["title"]);}this._rowOptionsDefault[d][0]=this._rowOptions[c]["title"];}if(b[c]["icon"]!=this._rowOptions[c]["icon"]){if(this._rowOptionsButtons[c]){$ws.helpers.makeBackground(this._rowOptionsButtons[c].find(".ws-browser-row-option"),this._rowOptions[c]["icon"]);}if(this._rowOptionsMenu instanceof Object){this._rowOptionsMenu.setItemIcon(this.getId()+"_"+c,this._rowOptions[c]["icon"]);}this._rowOptionsDefault[d][1]=this._rowOptions[c]["icon"];}if(b[c]["callback"]!=this._rowOptions[c]["callback"]){var f=this._rowOptionsCallbackWrapper(this._rowOptions[c]["callback"]);if(this._rowOptionsButtons[c]){this._rowOptionsButtons[c].unbind("click");this._rowOptionsButtons[c].bind("click",f);}if(this._rowOptionsMenu instanceof Object){this._rowOptionsMenu.setItemClickHandler(this.getId()+"_"+c,f);}this._rowOptionsDefault[d][2]=this._rowOptions[c]["callback"];}}else{if(b.hasOwnProperty(c)){e.push(c);}}}for(d in this._rowOptions){if(this._rowOptions.hasOwnProperty(d)&&!b.hasOwnProperty(d)){this.addRowOption(this._rowOptions[d]);}}return e;},_rowOptionsFilterConcat:function(f){var e=[];if(this._options.display.readOnly||!this._options.allowAdd){e=e.concat(["addMenu","addFolder","addItem"]);}if((this._options.display.readOnly||!this._options.allowEdit||this._options.display.editAtThePlaceOnly||(this._options.mode==="oneClickMode"&&this._options.folderLinkAction==="activate")||this._options.useHoverRowAsActive)&&!this._selectMode){e.push("edit");}if(this._options.display.readOnly||!this._options.allowDelete){e.push("delete");}if(this._options.display.readOnly||!this._options.allowMove||!this.isHierarchyMode()){e.push("move");}for(var d=0,b=e.length;d<b;++d){var g=false;for(var c=0;c<f.length;++c){if(f[c]==e[d]){g=true;break;}}if(!g){f.push(e[d]);}}return f;},_refilterRowOptions:function(e){var f={};for(var c=0;c<e.length;++c){f[e[c]]=true;}this._rowOptions={};for(c=0;c<this._rowOptionsDefault.length;++c){var d=this._rowOptionsDefault[c],b=d[3]||d[2];if(!f[b]&&!(typeof(d[2])==="string"&&!this._actions[d[2]])){this._rowOptions[b]={title:d[0],icon:d[1],name:b,callback:typeof(d[2])==="string"?this._actions[d[2]]:d[2]};}}},_applyRowOptions:function(){var j=0,g=this._rowOptions;for(var h in g){if(g.hasOwnProperty(h)){++j;}}var f=(j>=$ws._const.Browser.rowOptionsOverflow),c=this._rowOptionsDefault;this._rowOptionsMenuButton.css("display",f?"inline-block":"none");for(h=0;h<c.length;++h){var d=c[h],e=d[3]||d[2],b=g[e]&&!f;this._rowOptionsButtons[e].css("display",b?"inline-block":"none");if(this._rowOptionsMenu instanceof Object){this._rowOptionsMenu[g[e]?"showItem":"hideItem"](this.getId()+"_"+e);}}this._hasRowOptions=j>0;},_showRowOptionsForTargetRow:function(){if(this._rowOptionsTargetRow===undefined){this._hideRowOptions();}else{if(this._rowOptionsTargetRow!==this._rowOptionsHoverRow){this._showRowOptionsForRow(this._rowOptionsTargetRow);}else{this._rowOptionsTargetRow=undefined;}}},disableStandartRowOptions:function(b){this._rowOptionsDisableStandart=b===undefined?true:b;},_getMenuButtons:function(){var b=$ws.proto.Browser.superclass._getMenuButtons.apply(this,arguments);b.push(["Очистить сортировку","sprite:icon-16 icon-Close icon-primary","clearSorting"]);b.push(["Печать реестра (Ctrl+P)","sprite:icon-16 icon-Print icon-primary","print"]);if(!this._options.display.rowOptions){b.push(["Печать записи (F4)","sprite:icon-16 icon-Print icon-primary","printRecord"]);}return b;},_createFakeEvent:function(){var b;if(document.createEvent){b=document.createEvent("HTMLEvents");}else{if(document.createEventObject){b=document.createEventObject();}}return b;},_showReportsListForList:function(){if(this._needPrint===true){this._showReportsList(this._createFakeEvent(),true);}else{if(typeof(this._needPrint)=="string"){this.printReport(this._needPrint,true,null);}}},_showReportsListForRecord:function(b,d,c){if(this._needPrint===true){this._showReportsList(typeof(c)=="object"?c:this._createFakeEvent(),false,b,d);}else{if(typeof(this._needPrint)=="string"){this.printReport(this._needPrint,false,b);}}},_drawBodyCycle:function(){var d,b=false,f=$("<tbody/>");this._rowsMap={};if(this._options.display.showRoot){this._createRoot(f.get(0));}var c=this._body;this._body=f;if(this.isHierarchyMode()){if(this._turn){this._expanded[this._currentRootId]=2;}this._drawBranch(this._options.display.viewType==="tree"?this._rootNode:this._currentRootId);if(this._expanded[this._currentRootId]===2&&this._options.display.viewType==="tree"&&this._turn===""){delete this._expanded[this._currentRootId];}if(this._options.display.viewType==="tree"&&this._options.display.expand&&!this._options.display.fixedExpand){this._options.display.expand="";}}else{this._currentRecordSet.rewind();while((d=this._currentRecordSet.next())!==false){if(this._options.selectionType!=="node"||(this._options.selectionType==="node"&&this._testSelectedRecord(d))){var e=this._createTR(d,0,b);f.append(e);b=d;}}this._count=this._body.get(0).childNodes.length;}if(this._options.display.allowAddAtThePlace){this._createAddAtPlaceLinkRow(f.get(0));}if(this._options.display.allowHorizontalScroll){this._emptyDataScroller.toggleClass("ws-hidden",this._count>0);}c.remove();this._data.append(this._body);},_addAtPlaceLinkRowClick:function(d,c){if(d){this._onClickHandler(d);d.stopPropagation();}var b=(this._options.display.viewType!=="tree"?this._currentRootId:this._rootNode)+"";this._createRowAtThePlace(b,c,false);},_createAddAtPlaceLinkRow:function(f){var e=$('<td class="ws-browser-add-at-place-cell"></td>'),c=this,b,d;this._addAtPlaceLinkRow=$('<tr class="ws-browser-table-row ws-visible ws-browser-add-at-place-link-row" rowkey=""></tr>');if(this._options.display.viewMode!=="foldersTree"){d=$('<div class="icon-16 icon-Add icon-primary"/><span class="ws-browser-add-at-place-link">Новая запись</span>');d.appendTo(e).click(function(g){c._addAtPlaceLinkRowClick(g,false);});}if(this.isHierarchyMode()){b=$('<div class="icon-16 icon-CreateFolder icon-primary"/><span class="ws-browser-add-at-place-link">Новая папка</span>');b.appendTo(e).click(function(g){c._addAtPlaceLinkRowClick(g,true);});if(this._options.display.viewMode!=="foldersTree"){b.addClass("withItem");}}e.get(0).colSpan=this._getColumnsCount();e.appendTo(this._addAtPlaceLinkRow);if(this._options.display.hasZebra){this._addAtPlaceLinkRow.addClass("rE");}if(this._options.display.readOnly){this._addAtPlaceLinkRow.hide();}this._data.toggleClass("ws-indent-top",this._count===0);this._emptyDataBlock.toggleClass("ws-back",this._count===0);this._addAtPlaceLinkRow.appendTo(f);},_createRoot:function(c){var e=["ws-visible"],j=document.createElement("tr"),f=document.createElement("span"),b=!!this._expanded[this._rootNode],h=(this._rootNode===null?"null":this._rootNode.toString());j.setAttribute("rowkey",h);j.setAttribute($ws._const.Browser.treeLevelAttribute,"0");f.className="ws-browser-expander-container ws-browser-icon ws-browser-expander";e.push("ws-browser-root");if(this._selected[this._rootNode]){e.push("ws-browser-selected");}if(this._selectedPart[this._rootNode]){e.push("ws-browser-selected-part");}if(this._options.display.hasZebra){e.push("rE");}if(this._turn===""){f.className+=b?" minus":" plus";}j.setAttribute("parentId","null");e.push("ws-browser-tree-branch","ws-browser-folder","ws-browser-table-row");j.className=e.join(" ");var d=document.createElement("td"),g,i;if(this._options.mode=="oneClickMode"){this._rootName=i=$('<a class="ws-browser-folder-link" href="javascript:void(0)">'+this._options.display.rootName+"</a>");}else{i=this._options.display.rootName;}g=$('<div class="ws-browser-cell-container ws-browser-div-cut"></div>').append(i).css("padding-left","2px");g.prepend(f);if(this._options.mode!=="oneClickMode"){this._rootName=g;}if(this._getColumnsCount()!==0){d.colSpan=this._getColumnsCount();}$(d).append(g);j.appendChild(d);c.appendChild(j);this._rowsMap[h]=$(j);if(this._options.display.showSelectionCheckbox&&this._options.useSelection!==false&&this._options.selectionType!=="leaf"){this._addCheckBox(j);}},_prepareTreeLevel:function(h,d,e,c,b){var g=d.getKey(),f=this._rootNode,i=d.get(this._hierColumnParentId);if(this._expanded[g]===2&&!b){this._expanded[g]=1;h[1]=true;h[2]=g;}if(e.length){f=e[e.length-1];while(i!=f){if(f===h[2]){h[2]=-1;h[1]=false;}if(!this._expanded[e.pop()]){++h[0];}if(e.length){f=e[e.length-1];}else{f=this._rootNode;break;}}}if(h[0]&&h[1]&&!b&&c&&this._expanded[g]!==0&&this._expanded[g]!==false){this._expanded[g]=true;this._loaded[g]=true;}if(c){e.push(g);if(!this._expanded[g]){--h[0];}}return h[0]+(c?!this._expanded[g]:0)>0;},zebraBody:function(c){var b=this._body.find("tr").end();this._data.toggleClass("ws-browser-hasZebra",!!c);if(!this._options.display.hasZebra&&c){b.addClass("rE");}else{if(this._options.display.hasZebra&&!c){b.removeClass("rE");}}this._options.display.hasZebra=c;this._updateSelection();},isHierarchyMode:function(){return this._options.display.viewType==="tree"||this._options.display.viewType==="hierarchy";},isHierarchy:function(){return this._options.display.viewType==="hierarchy";},isTree:function(){return this._options.display.viewType==="tree";},_pathRecordSetLoaded:function(e,f,b){this._wayRS=f;if(b){if(this._options.display.viewType==="hierarchy"){$ws.proto.Browser.superclass._pathRecordSetLoaded.apply(this,arguments);}else{if(this._options.display.viewType==="tree"){var k=this._wayRS.getWay(),d,h=[];if(this._rootNode&&k!==null&&!k.contains(this._rootNode)){return;}k.rewind();while((d=k.next())!==false){if(d.get(this._hierColumnIsLeaf)===false){break;}var g=d.getKey();h.push(g);this._expanded[g]=1;this._loaded[g]=true;}if(h.length){var c=this._wayRS.getLoadingId();if(c instanceof Array){c=c[0];}if(this._selectAfterPathLoad===true){this._hovered=c;this._activeElement=undefined;}else{this._selectAfterPathLoad=true;}this._systemParams[this._hierColumnParentId]=h;var j=this._currentRecordSet.loadNode(h,false);if(!this._wayRSDeferred.isReady()){this._wayRSDeferred.dependOn(j);}if(this._options.mode==="navigationMode"){var i=this;j.addCallback(function(){i._closeOtherBranches(h[h.length-1]);i.refresh();});}}}}}},_keyboardHover:function(C){var y=$ws.core.hash([$ws._const.key.left,$ws._const.key.right,$ws._const.key.enter,$ws._const.key.insert]),F=false;if(!this._currentRecordSet||!this._currentRecordSet.isLoaded()){return F;}if((C.which in y)&&this.isActive()){var o=this.getActiveElement();if(!C.ctrlKey&&!C.altKey&&C.shiftKey&&(C.which===$ws._const.key.left||C.which===$ws._const.key.right)&&this._options.display.viewType==="tree"){var E=true,s=this.getSelection(),A=s.length==1?this.getActiveRow():this._body.find("tr.ws-browser-selected:first"),z=s.length==1?A:this._body.find("tr.ws-browser-selected:last"),D=A,j=s[0].get(this._hierColumnParentId),h=null;if(A.prev().length>0&&this._notify("onDragStart",s)!==false){for(var x=1,v=s.length;x<v;x++){if(s[x].get(this._hierColumnParentId)!==j){E=false;}}while(D.attr("rowkey")!==z.attr("rowkey")&&E){if(!D.hasClass("ws-browser-selected")){E=false;}D=D.next();}if(E){if(C.which===$ws._const.key.right){var k=A.prev(),n=k.attr("rowkey"),g=k.attr("parentid")===""?null:k.attr("parentid"),b=this._currentRecordSet.getRecordByPrimaryKey(n);if(n!==A.attr("parentid")){h=b.get(this._hierColumnIsLeaf)?n:g;if(this._notify("onDragStop",s,h===this._rootNode?this._rootNode:this._currentRecordSet.getRecordByPrimaryKey(h),true)!==false){this.move(h);}}}else{if(j!==null){h=this._currentRecordSet.getRecordByPrimaryKey(A.attr("parentid")).get(this._hierColumnParentId);if(this._notify("onDragStop",s,h===this._rootNode?this._rootNode:this._currentRecordSet.getRecordByPrimaryKey(h),true)!==false){this.move(h);}}}}else{$ws.core.alert("Данная операция доступна только для непрерывного диапазона данных.");}}}else{if(this._isNotModified(C)&&(C.which===$ws._const.key.left||C.which===$ws._const.key.right)&&this._options.display.viewType==="tree"&&o){f=o.attr("rowkey");var d=this.getActiveRecord();if(d&&C.which===$ws._const.key.left&&!this._expanded[f]){var w=d.get(this._hierColumnParentId),c=this._body.find('[rowkey="'+w+'"]');if(c.length){this.setActiveElement(c);}}else{if(C.which===$ws._const.key.right&&this._expanded[f]){var B=parseInt(o.attr($ws._const.Browser.treeLevelAttribute),10),t=o.next(":visible"),m=parseInt(t.attr($ws._const.Browser.treeLevelAttribute),10);if(B+1===m){this.setActiveElement(t);}}else{if(o.hasClass("ws-browser-folder")){this._processTreeClick(o.attr("rowkey"),C.which===$ws._const.key.left);}}}}else{if(C.which===$ws._const.key.enter&&!this._selectMode&&!C.ctrlKey&&!C.shiftKey&&!C.altKey){if(!o){return false;}var p=o.find(".ws-browser-expander");if(p.length>0&&this._turn===""){var r=p.not(":hidden"),q=r.hasClass("minus"),f=r.parents("tr").attr("rowkey");this._processTreeClick(f,q);return false;}else{if(o.hasClass("ws-browser-add-at-place-link-row")){this._addAtPlaceLinkRowClick();}}}else{if(this._options.display.viewType==="tree"&&C.which===$ws._const.key.insert&&C.altKey&&!C.shiftKey){var u=this._actions[C.ctrlKey?"addFolder":"addItem"];if(u){u(this.getActiveElement(),true);}}}}}}F=$ws.proto.Browser.superclass._keyboardHover.apply(this,arguments);return F;},_processElementClick:function(d,c,b){return this._runInBatchUpdate("Browser: _processElementClick",function(){var e=null;if(this._options.display.viewType==="tree"&&this._turn===""){e=this._processTreeClick(c,!!this._expanded[c]);}if(!e){this._notifySetCursor(this._body.find('[rowkey="'+c+'"]'),b);}return e;});},_updateActiveRow:function(){if(this._activeElement&&this._activeElement.closest("html").size()===0||!this._activeElement&&this._hovered){var b=(this._hovered&&this._haveRow(this._hovered))?this._findRow(this._hovered):undefined;this.setActiveElement(b,false,true);}},_clearBranch:function(b){var e,f,c,d;if(this._haveRow(b)){e=this._findRow(b);c=parseInt(e.attr($ws._const.Browser.treeLevelAttribute),10)||0;e=e.next();}else{if(this._isIdEqual(b,this._rootNode)){c=-1;e=this._body.find("tr:first");}else{return;}}while(e.length){d=parseInt(e.attr($ws._const.Browser.treeLevelAttribute),10)||0;if(d<=c){break;}this._rowsMap[e.attr("rowkey")]=undefined;f=e;e=e.next();f.remove();}},_closeBranch:function(b){this._toggleExpander(b,false);this._clearBranch(b);this._notify("onFolderClose",b);},_drawFolder:function(b,e,h,f,n){var j=this._currentRecordSet.recordChilds(b);for(var c=0,g=j.length;c<g;++c){var d=this._currentRecordSet.getRecordByPrimaryKey(j[c]),l=d.getKey();if((this._expanded[b]===2||f)&&(!this._useLoadChildsFlag||this._currentRecordSet.recordChilds(l).length>0||!d.get(this._hierColumnHasChild))){this._expanded[l]=1;}var k=(n.keys.length>0)?this._currentRecordSet.getRecordByPrimaryKey(n.keys[n.keys.length-1]):undefined,m=this._createTR(d,e,k);n.keys.push(l);n.rows.push(m);h.appendChild(m);if(d.get(this._hierColumnIsLeaf)===true&&this._expanded[l]||f){this._drawFolder(l,e+1,h,this._expanded[b]===2||f,n);}}if(this._expanded[b]===2){this._expanded[b]=1;}},_drawBranch:function(d){var e=this._haveRow(d)&&this._findRow(d),f=e&&parseInt(e.attr($ws._const.Browser.treeLevelAttribute),10)+1||0,c=document.createDocumentFragment(),b={keys:[],rows:$()};this._drawFolder(d,f,c,false,b);if(e&&e.length){this._body[0].insertBefore(c,e[0].nextSibling);}else{this._body.append(c);}this._count=this._body.get(0).childNodes.length;this._updatePager();this._updateActiveRow();return b;},_toggleExpander:function(c,b){var d=this._haveRow(c)&&this._findRow(c);if(d){d.find(".ws-browser-expander").toggleClass("minus",b).toggleClass("plus",!b);}},_openBranch:function(b){if(this._haveRow(b)){this._toggleExpander(b,true);}var c=this._drawBranch(b);this._notify("onFolderOpen",b,c.keys,c.rows);},_processTreeClick:function(c,b){return this._runInBatchUpdate("Browser: _processTreeClick",function(){if(this._options.display.fixedExpand===true&&this._options.mode!=="navigationMode"){return null;}var d,g=false,j=this._currentRecordSet.contains(c),f=j&&this._currentRecordSet.getRecordByPrimaryKey(c).get(this._hierColumnIsLeaf)||!j;if(!c){c=null;}if(this._options.mode==="navigationMode"&&!!this._expanded[c]){return null;}if(b){this._expanded[c]=0;}else{if(f){this._expanded[c]=1;}}if(this._options.mode==="navigationMode"){g=this._closeOtherBranches(c);if(g){for(var h in this._expanded){if(this._expanded.hasOwnProperty(h)&&this._expanded[h]===0){this._closeBranch(h);}}}}if(j&&!f){this._heightChangedIfVisible();return null;}if(b){this._closeBranch(c);this._heightChangedIfVisible();d=null;}else{if(this._options.display.partiallyLoad&&!this._loaded[c]){this._loaded[c]=true;this._toggleExpander(c,true);var e=this;d=this._currentRecordSet.loadNode(c,false,undefined,undefined,undefined,{browserFolder:true}).addCallback(function(k){e._hideLoadingIndicator();if(e._expanded[c]&&k){var i=e._drawBranch(c);e._notify("onFolderOpen",c,i.keys,i.rows);e._heightChangedIfVisible();}});}else{this._openBranch(c);this._heightChangedIfVisible();d=null;}}this._updatePager();return d?d:null;});},_closeOtherBranches:function(c){var g=this._getItemParents(c),b={},f=false;for(var e=0;e<g.length;++e){b[g[e]]=true;}for(e in this._expanded){if(this._expanded.hasOwnProperty(e)){if(this._expanded[e]&&!b[e]){this._expanded[e]=0;f=true;}}}for(e=1;e<g.length;++e){if(g.hasOwnProperty(e)){if(!this._expanded[g[e]]){var d=this._currentRecordSet.contains(g[e]);if(d&&this._currentRecordSet.getRecordByPrimaryKey(g[e]).get(this._hierColumnIsLeaf)||!d){this._expanded[g[e]]=1;f=true;}}}}return f;},isRecordFolder:function(c){if(this.isHierarchyMode()){var b=this._currentRecordSet.contains(c)&&this._currentRecordSet.getRecordByPrimaryKey(c);if(b){return b.get(this._hierColumnIsLeaf)===true;}}return false;},isTreeFolderExpanded:function(b){return !!this._expanded[b];},applyTurnTree:function(c,b){if(this._options.display.fixedExpand||this._options.display.viewType!=="tree"){return;}if(c){this._fullTreeExpand=true;this._expandTreeAll(b,this._rootNode);}else{this._fullTreeExpand=false;this._closeAll(b);}},_expandTreeAll:function(b,d){this._expanded={};this._expanded[d]=2;this._systemParams["Разворот"]="С разворотом";if(!b){if(this._options.display.partiallyLoad){var c=this;this._clearBranch(d);this._updateActiveRow();this._toggleExpander(d,true);this._loaded[d]=true;this._currentRecordSet.loadNode(d,false,0,true,undefined,{browserFolder:true}).addCallback(function(){c._hideLoadingIndicator();c._clearBranch(d);var e=c._drawBranch(d);c._notify("onFolderOpen",d,e.keys,e.rows);c._heightChangedIfVisible();});}else{this._clearBranch(d);this._openBranch(d);this._heightChangedIfVisible();}}},_closeAll:function(b){return this._runInBatchUpdate("Browser._closeAll",function(){this._expanded={};if(this._options.display.partiallyLoad){this._systemParams["Разворот"]="Без разворота";}if(!b){this._drawBody();}});},_expandAll:function(e,b){if(this._options.display.viewType==="tree"){if(e!==false){var c=this.getActiveRecord();var d=(c&&c.getKey())||this._rootNode;if(this._expanded[d]){this._processTreeClick(d,true);}else{if((c&&c.get(this._hierColumnIsLeaf))||!c){this._expandTreeAll(b,d);}}}}else{$ws.proto.Browser.superclass._expandAll.apply(this,arguments);}},_unselectRow:function(b){$ws.proto.Browser.superclass._unselectRow.apply(this,arguments);if(this._isIdEqual(b,this._rootNode)&&!this._options.display.showRoot){this._head.find(".ws-browser-checkbox").closest("tr").removeClass("ws-browser-selected-part");}else{var c=this._body.find('tr[rowkey="'+b+'"]');c.removeClass("ws-browser-selected-part");delete this._selectedPart[b];}},_selectRow:function(b){$ws.proto.Browser.superclass._selectRow.apply(this,arguments);if(this._isIdEqual(b,this._rootNode)&&!this._options.display.showRoot){this._head.find(".ws-browser-checkbox").closest("tr").removeClass("ws-browser-selected-part");}else{var c=this._body.find('tr[rowkey="'+b+'"]');c.removeClass("ws-browser-selected-part");delete this._selectedPart[b];}},_selectPartRow:function(b){if(this._isIdEqual(b,this._rootNode)&&!this._options.display.showRoot){this._head.find(".ws-browser-checkbox").closest("tr").addClass("ws-browser-selected-part").removeClass("ws-browser-selected");}else{this._unselectRow(b);var c=this._body.find('tr[rowkey="'+b+'"]');c.addClass("ws-browser-selected-part");this._selectedPart[b]=true;}},_toggleRowSelection:function(d){if(this._options.selectChilds){var e=this._selected[d]===undefined,c=this,b=function(h){if(e){c._selectRow(h);}else{c._unselectRow(h);}var j=c._currentRecordSet.recordChilds(h);for(var g=0;g<j.length;++g){b(j[g]);}};b(d);if(d){var f=function(j){var k=c._currentRecordSet.recordChilds(j),g=0,l=false;for(var h=0;h<k.length;++h){if(c._selected[k[h]]!==undefined){++g;}else{if(c._selectedPart[k[h]]!==undefined){l=true;}}}if(g===0&&!l){c._unselectRow(j);}else{if(g===k.length&&(c._options.selectChilds==="full"||c._isIdEqual(j,c._rootNode))){c._selectRow(j);}else{c._selectPartRow(j);}}if(!c._isIdEqual(c._rootNode,j)){f(c._currentRecordSet.getRecordByPrimaryKey(j).get(c._hierColumnParentId));}};f(c._currentRecordSet.getRecordByPrimaryKey(d).get(c._hierColumnParentId));}}else{$ws.proto.Browser.superclass._toggleRowSelection.apply(this,arguments);}},_rebuildPartialSelection:function(){if(this._options.selectChilds){this._selectedPart={};var c=this,b=function(h,k){var j=c._currentRecordSet.recordChilds(h),e=true,d=false;if(k){c._selectRow(h);}for(var g=0;g<j.length;++g){var f=b(j[g],c._selected[h]!==undefined);if(f!==2){e=false;}if(f>0){d=true;}}if(k||(d&&e&&c._options.selectChilds==="full")||c._selected[h]!==undefined){c._selectRow(h);return 2;}else{if(d){c._selectPartRow(h);return 1;}}c._unselectRow(h);return 0;};b(this._rootNode,this._selected[this._rootNode]!==undefined);}},setTextHighlight:function(f,c){this._highlight=f.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");if(f&&c){var e=this._body.find(".ws-browser-text-no-render");for(var d=0,b=e.length;d<b;++d){this._highlightNode($(e[d]));}}},_highlightNode:function(b){if(b.attr("highlight")===this._highlight){return;}b.attr("highlight",this._highlight);b.html(this._highlightData(b.text()));},_highlightData:function(b){if(this._highlight&&b&&typeof(b)==="string"){b=b.replace(new RegExp(this._highlight,"gi"),'<span class="ws-browser-highlight">$&</span>');}return b;},_renderTD:function(j,f,n){var e=f.hasColumn(j.field)?f.get(j.field):"",m="",h=false,g=this._ladder[j.field],k=undefined;if(n&&(g>0&&this._hasLadder||g===0)&&n.hasColumn(j.field)){this._hasLadder=true;h=true;m=n.get(j.field);}if(typeof(j.render)==="function"){k=j.render.apply(this,[f,j.field]);}if(k!==undefined){if(typeof(k)==="string"){k=$ws.helpers.escapeTagsFromStr(k,["script"]);}e=k;}else{if(e!==null){if(typeof(e)==="string"){e=$ws.helpers.escapeHtml(e);}if(j.formatValue){e=$ws.helpers.format(f,j.formatValue);m=h?$ws.helpers.format(n,j.formatValue):"";}else{switch(j.type){case"Перечисляемое":e=$ws.render.defaultColumn.enumType(e);m=h?$ws.render.defaultColumn.enumType(m):"";break;case"Деньги":e=$ws.render.defaultColumn.money(e);m=h?$ws.render.defaultColumn.money(m):"";break;case"timestamp":case"timestamptz":case"interval":case"date":case"Дата":case"Дата и время":case"Время":e=$ws.render.defaultColumn.timestamp(e,j.type);m=h?$ws.render.defaultColumn.timestamp(m,j.type):"";break;case"oid":case"int2":case"int4":case"int8":case"Число целое":e=$ws.render.defaultColumn.integer(e);m=h?$ws.render.defaultColumn.integer(m):"";break;case"boolean":case"bool":case"Логическое":e=$ws.render.defaultColumn.logic(e);break;case"Флаги":e=$ws.render.defaultColumn.flags(e);break;case"":break;default:break;}}if(!(e instanceof Object&&"jquery" in e)){e=$ws.helpers.escapeTagsFromStr(e+"",["script"]);}if(h){if(this._options.display.useWordsLadder&&j.type in {"Строка":0,"Текст":0,varchar:0,text:0}){var d=e?e.replace(/(^\s+)|(\s+$)/g,"").split(" "):[],c=m?m.replace(/(^\s+)|(\s+$)/g,"").split(" ",this._options.display.wordsLadderCount):[],b=this._options.display.wordsLadderCount<c.length?this._options.display.wordsLadderCount:c.length,l=0,o="",i=0;while(l<b&&d[l]==c[l]){l++;}if(l){e=[d.splice(0,l).join(" "),d.join(" ")];}}else{if(e===m){e=$("<div class='ws-browser-ladder-element ws-hidden'>"+e+"</div>");}else{this._hasLadder=false;}}}else{this._hasLadder=false;}e=this._highlightData(e);}else{e="";}}return e;},_fixDataForOneClickMode:function(c,d,h,g,j,f){var b=d?this._options.editBranchMode:this._options.editMode;if(!g&&!h&&(c!==null&&c!==undefined)){if(!this._options.useHoverRowAsActive&&this._options.mode=="oneClickMode"){var i=(b=="thisWindow")?this.generateEditPageURL(j,d,f):false,e=(b=="thisWindow")&&i!==false?' class="ws-browser-link" href="'+i+'"':'class="ws-browser-'+(d?"folder":"edit")+'-link" href="javascript:void(0)"';if(c instanceof Object&&"jquery" in c){c=$("<a "+e+" />").append(c);}else{if(c instanceof Array){c=$("<a "+e+'><span class="ws-invisible ws-browser-ladder-element">'+c[0]+" </span>"+c[1]+"</a>");}else{c=$("<a "+e+">"+c+"</a>");}}}else{if(this._options.mode!="oneClickMode"){if(c instanceof Object&&"jquery" in c){c=$("<span/>").append(c);}else{c=$("<span>"+c+"</span>");}}}}return c;},_createTD:function(j,i,e,g,k){var h=i>=0?this._columnMap[i]:{type:"Строка",render:null,field:this._options.display.titleColumn,title:this._options.display.titleColumn,allowEditAtThePlace:this._titleColumnIndex==-1?false:this._columnMap[this._titleColumnIndex].allowEditAtThePlace,textAlign:"left",fixedSize:false},d=this._renderTD(h,e,k),b=$(j).find(".ws-browser-cell-container")[0],c=this.isHierarchyMode()&&e.get(this._hierColumnIsLeaf)===true;if(i<=0&&g>0){b.style.paddingLeft=g+"px";}if(this.isHierarchyMode()&&i<=0){b=$(b).children(".ws-browser-text-container")[0];}d=this._appendDataToCellContainer($(b),d,c,h.render,h.allowEditAtThePlace,e.getKey(),this.isHierarchyMode()?e.get(this._hierColumnParentId):undefined);if(!h.render){if(!(d instanceof Object&&"jquery" in d)){b.className+=" ws-browser-text-no-render";}}var f=this._disabledEditCells[e.getKey()];if(f!==undefined&&(Object.isEmpty(f)||f[h.title]!==undefined)){this._disableEditCells($(j));}return j;},_appendDataToCellContainer:function(f,g,d,c,e,i,h){g=this._fixDataForOneClickMode(g,d,c,e,i,h);if(g instanceof Array){g=$('<span style="visibility:hidden">'+g[0]+"</span><span>"+g[1]+"</span>");}f[0].innerHTML="";if(g instanceof Object&&"jquery" in g){f.append(g);}else{if(this._highlight){f.html(g);}else{f[0].innerHTML=(g===null||g===undefined)?"":g;}}if(!c){if(g instanceof Object&&"jquery" in g){g.addClass("ws-browser-text-no-render");}}if(this._options.display.cutLongRows){var b=f[0];if(!c||!(g instanceof Object&&"jquery" in g)){b.title=(g instanceof Object&&"jquery" in g)?g.text():(b.textContent!==undefined?b.textContent:b.innerText);}}return g;},_createTdTemplate:function(j,g,c){var e=document.createElement("td"),i=j>=0?this._columnMap[j]:{type:"Строка",render:null,field:this._options.display.titleColumn,title:this._options.display.titleColumn,className:"",allowEditAtThePlace:this._titleColumnIndex==-1?false:this._columnMap[this._titleColumnIndex].allowEditAtThePlace,textAlign:"left",fixedSize:false},h=$ws._const.Browser.type2ClassMap[i.type]||i.type,f=[];if(this._options.display.cutLongRows){f.push("ws-browser-cell-cut");}if(i.textAlign!=="auto"){f.push("ws-browser-"+i.textAlign);}else{if($ws.render.defaultColumn.isNumeric(i.type)){f.push("ws-browser-type-numeric");}if(h){f.push("ws-browser-type-"+h);}}if(i.className){f.push(i.className);}if(c!==true){if(i.allowEditAtThePlace){f.push("ws-browser-edit-column");}if(this._hasLadder){f.push("ws-browser-column-with-ladder");}}if(f.length>0){e.className=f.join(" ");}var b=document.createElement("div");b.className="ws-browser-cell-container"+(this._options.display.cutLongRows?" ws-browser-div-cut":"");if(g){b.appendChild(g);}if(this.isHierarchyMode()&&j<=0){var d=document.createElement("div");d.className="ws-browser-text-container";b.appendChild(d);}e.appendChild(b);if(i.allowEditAtThePlace&&c!==true){$(e).attr("colIndex",j<0?this._titleColumnIndex:j);}return e;},_createRowTemplate:function(h){var l=document.createElement("tr"),c,b,g,k=this.isHierarchyMode();if(k&&h){c=document.createElement("span");c.className="ws-browser-expander-container";if(this._options.display.viewType==="tree"&&this._turn===""){if(this._options.display.hierarchyIcons&&this._options.display.hierarchyIcons!==$ws._const.Browser.hierarchyIcons){c.style.backgroundImage=["url(",$ws._const.wsRoot,this._options.display.hierarchyIcons,")"].join("");}c.className+=" ws-browser-icon ws-browser-expander";}}this._hasLadder=false;g=h&&((this._options.display.viewType==="tree"&&this._turn!=="")||this._options.display.viewType==="hierarchy");var e=0,j;for(var d=0,f=this._columnMap.length;d<f;++d,c=undefined){b=false;e=(d===0&&g)?-1:d;j=this._columnMap[d];if(g){if(e===-1||j.useForFolder){b=this._createTdTemplate(e,c);b.className+=h?" ws-browser-bold":"";}}else{b=this._createTdTemplate(e,c);}if(b){l.appendChild(b);}}if(this._options.display.showSelectionCheckbox&&this._options.useSelection!==false){if(!k||(k&&!(this._options.selectionType==="leaf"&&h)&&!(this._options.selectionType==="node"&&!h))){this._addCheckBox(l);}else{if(k){$(l).find("td:first .ws-browser-cell-container").before('<span class="ws-browser-checkbox-holder"></span>');}}}return l;},_createRowTemplates:function(){this._rowTemplates[0]=this._createRowTemplate(false);this._rowTemplates[1]=this._createRowTemplate(true);},_createTR:function(d,b,y){var t=(this.isHierarchyMode()?d.get(this._hierColumnIsLeaf):null),u=this._options.display.viewMode==="foldersTree"?d.get(this._hierColumnHasChild):null,f=this._rowTemplates[t?1:0].cloneNode(true),z=d.getKey(),c=!!this._expanded[z],n=this,x=["ws-browser-table-row"],l=0,m="ws-visible",g=$(f).find(".ws-browser-expander-container")[0];if(z===null){z="null";}f.setAttribute("rowkey",z);if(this.isHierarchyMode()){f.setAttribute($ws._const.Browser.treeLevelAttribute,b);}if(this._options.display.hasZebra){x.push("rE");}if(this._selected[z]!==undefined){x.push("ws-browser-selected");}if(this._selectedPart[z]!==undefined){x.push("ws-browser-selected-part");}if(this.isHierarchyMode()){if(this._options.display.viewType==="tree"&&this._turn===""&&t){if(this._options.display.viewMode!=="foldersTree"||u===true){$(g).addClass(c?"minus":"plus");}else{if($ws._const.theme!=="wi_scheme"){var j=$ws._const.theme?"img/themes/"+$ws._const.theme+"/browser/":"img/browser/";$(g).css("background",["url(",$ws._const.wsRoot,j+"bullet.png",") no-repeat scroll center center transparent"].join(""));}}}var o=$ws._const.Browser.iconWidth;l+=o*b;l+=$ws._const.Browser.defaultCellPadding;l+=!t&&this._options.display.viewType==="tree"&&this._turn!==""?o:0;f.setAttribute("parentId",d.get(this._hierColumnParentId));if(t&&(this._options.display.viewMode!=="foldersTree"||u)){x.push("ws-browser-tree-branch","ws-browser-folder");}if(t){if(this._options.display.viewType!=="tree"||!t||this._turn!==""||(this._options.display.viewMode==="foldersTree"&&!u&&$ws._const.theme==="wi_scheme")){if(this._options.display.hierarchyIcons&&this._options.display.hierarchyIcons!==$ws._const.Browser.hierarchyIcons){g.style.backgroundImage=["url(",$ws._const.wsRoot,this._options.display.hierarchyIcons,")"].join("");}g.className+=" "+((u||this._options.display.viewType!=="tree"||this._turn!=="")?((c&&this._options.display.viewType==="tree")||this._turn!==""?"icon-16 icon-OpenedFolder icon-primary":"icon-16 icon-Folder icon-primary"):"ws-browser-icon item item");}if(this._options.display.folderIcon){$(g).css("background",["url(",$ws.helpers.processImagePath(this._options.display.folderIcon),") no-repeat scroll center center transparent"].join(""));}}}x.push(m);if(x.length>0){f.className=x.join(" ");}var e=f.childNodes;if((this._options.display.viewType==="hierarchy"||(this._options.display.viewType==="tree"&&this._turn!==""))&&t){var r=false,w=0,p=1,v,h=this._createTD(e[0],-1,d,l,false);for(var q=1,s=this._columnMap.length;q<s;++q){if(this._columnMap[q].useForFolder){v=this._createTD(e[p++],q,d,l,false);if(!r){w=q;r=true;}}}if(r){h.colSpan=w;v.colSpan=this._getColumnsCount()-w;}else{h.colSpan=this._getColumnsCount();}}else{this._hasLadder=false;for(q=0,s=this._columnMap.length;q<s;++q){this._createTD(e[q],q,d,l,n._options.display.ladder.length!==0?y:false);}}this._rowsMap[z]=$(f);if(typeof(this._options.display.rowRender)=="function"){this._options.display.rowRender.apply(this,[d,$(f)]);}return f;},_rowOptionsCallbackWrapper:function(c){var b=this;return function(){b.setActiveRow(b._rowOptionsHoverRow);c(b._rowOptionsHoverRecord,b._rowOptionsHoverRow);};},_rowOptionsButtonCallback:function(c){var d,b=this;if(typeof(c[2])==="function"){d=this._rowOptionsCallbackWrapper(c[2]);}else{d=function(e){e.stopImmediatePropagation();b.setActiveRow(b._rowOptionsHoverRow);b._actions[c[2]](b._rowOptionsHoverRow,true,e);};}return d;},_addRowOption:function(f){var k=this._rowOptionsButtonCallback(f),c="",j=$ws._const.wsRoot+($ws._const.theme?"img/themes/"+$ws._const.theme+"/browser/":"img/browser/");if(typeof(f[2])==="string"){c=f[2];}else{if(f[3]){c=f[3];}}for(var e=0;e<this._rowOptionsDefault.length;++e){if(c===(this._rowOptionsDefault[e][3]||this._rowOptionsDefault[e][2])){return;}}var l=f[1].indexOf("/")>-1?f[1]:j+f[1];if(this._rowOptionsElement){var d=$('<span class="ws-browser-row-option"></span>'),g=$('<span class="ws-browser-row-option-border" title="'+f[0]+'"></span>').append(d).mousedown(function(i){i.stopPropagation();i.preventDefault();});if(f[4]){g.insertBefore(this._rowOptionsButtons[f[4]]);}else{g.appendTo(this._rowOptionsElement.find(".ws-browser-row-options-container"));}$ws.helpers.makeBackground(d,l);if(k){g.bind("click",k);}if(c){this._rowOptionsButtons[c]=g;}if(this._rowOptionsMenu instanceof Object){var b={imgSrc:l,id:this.getId()+"_"+c,caption:f[0],handlers:{onActivated:k}};if(f[4]!==undefined){this._rowOptionsMenu.insertItem(b,this.getId()+"_"+f[4]);}else{this._rowOptionsMenu.addItem(b);}}}if(f[4]){for(e=0;e<this._rowOptionsDefault.length;++e){var h=this._rowOptionsDefault[e];if((h[3]||h[2])==f[4]){this._rowOptionsDefault.splice(e,0,f);break;}}}else{this._rowOptionsDefault.push(f);}},addRowOption:function(b){this._addRowOption([b.title,b.icon,b.callback,b.name,b.before]);},addRowOptions:function(c){for(var d=0,b=c.length;d<b;++d){this._addRowOption(c[d]);}},_getRowOptions:function(){var b=[];if(this._turn===""&&(this._options.display.viewType==="tree"||this._options.display.viewType==="foldersTree")){b.push(["Добавить лист (Insert)","sprite: icon-16 icon-Add icon-primary","addItem","addItem"],["Добавить папку (Ctrl + Insert)","sprite:icon-16 icon-CreateFolder icon-primary","addFolder","addFolder"]);}if((this._options.mode=="oneClickMode")||this._options.mode!=="oneClickMode"||this._selectMode===true){b.push([this._options.display.readOnly?"Просмотреть (F3)":"Редактировать (F3)","sprite:icon-16 icon-Edit icon-primary","edit","edit"]);}b.push(["Удалить","sprite:icon-16 icon-Erase icon-error","delete","delete"],["Печать записи (F4)","sprite:icon-16 icon-Print icon-primary","printRecord","printRecord"],["Копировать запись (Shift+F5)","sprite:icon-16 icon-Copy icon-primary","copy","copy"],["История записи (Ctrl+H)","sprite:icon-16 icon-History icon-primary","history","history"]);b.push(["Переместить выбранные записи","sprite:icon-16 icon-Move icon-primary",$.proxy(this._moveSelectedRecordsToCurrent,this),"move","move"]);return b;},_initRowOptionsDefaults:function(){this._rowOptionsDefault=this._getRowOptions();},_moveSelectedRecordsToCurrent:function(b){this._confirmMoveRecords(b);},_createRowOptions:function(){if(this._rowOptionsElement!==false){return;}var r=this,m=this._rootElement.find(".ws-browser-container-wrapper"),l=$ws._const.wsRoot+($ws._const.theme?"img/themes/"+$ws._const.theme+"/browser/":"img/browser/"),s=this._rowOptionsDefault;if(s.length){var f=($ws._const.theme=="wi_scheme"?"":'<img src="'+l+'panel_bg0.png" width="10" height="100%" style="float:right;">'),e=($ws._const.theme=="wi_scheme"?"":'<img class="ws-browser-row-options-bg" src="'+l+'panel_bg1.png" height="100%" style="position:absolute;">'),c=$('<div class="ws-browser-row-options-block">'+f+"</div>").bind("mouseover mouseout",function(i){r._rowOptionsHoverRow&&r._rowOptionsHoverRow[i.type==="mouseover"?"addClass":"removeClass"]("hover");}),d=$('<div class="ws-browser-row-options-container">'+e+"</div>").prependTo(c),p=function(u){var t=u.offset(),i={};i.clientX=t.left+$ws._const.Browser.rowOptionsMenuOffset.left;i.clientY=t.top+$ws._const.Browser.rowOptionsMenuOffset.top;return i;},o=function(){if(!r._rowOptionsMenuVisible){r._rowOptionsMenuVisible=true;}else{r._rowOptionsMenuVisible=false;r._showRowOptionsForTargetRow();}};this._rowOptionsMenuButton=$('<span class="ws-browser-row-option-border"><span class="ws-browser-row-option menu"></span></span>').appendTo(d).bind("click",function(u){r.setActiveElement(r._rowOptionsHoverRow);u.stopImmediatePropagation();o();var t=p($(this));if(r._rowOptionsMenu instanceof Object){r._applyRowOptions();(r._rowOptionsCurrentMenu=r._rowOptionsMenu).show(t);if(r._rowOptionsMenuVisible&&r.isHierarchyMode()){if(!!r._options.editBranchDialogTemplate!==!!r._options.editDialogTemplate){var i=r._rowOptionsHoverRecord;if(i.get(r._hierColumnIsLeaf)===true&&!r._options.editBranchDialogTemplate||i.get(r._hierColumnIsLeaf)===null&&!r._options.editDialogTemplate){r._rowOptionsMenu.hideItem(r.getId()+"_edit");}else{r._rowOptionsMenu.showItem(r.getId()+"_edit");}}}}else{if(r._rowOptionsMenu===undefined){r._createRowOptionsMenu(t);}}}).mousedown(function(i){i.stopPropagation();i.preventDefault();});for(var g=0,k=s.length;g<k;++g){var n=this._rowOptionsButtonCallback(s[g]),b="";if(typeof(s[g][2])==="string"){b=s[g][2];}else{if(s[g][3]){b=s[g][3];}}var j=$('<span class="ws-browser-row-option"></span>'),h=$('<span class="ws-browser-row-option-border" title="'+s[g][0]+'"></span>').appendTo(d).append(j).mousedown(function(i){i.stopPropagation();i.preventDefault();});var q=s[g][1];if(q.indexOf("sprite:")!=-1){$(j).removeClass("ws-browser-row-option");$(j).addClass(q.split("sprite:")[1]);}else{q=s[g][1].indexOf("/")>-1?s[g][1]:l+s[g][1];$ws.helpers.makeBackground(j,q);}if(n){h.bind("click",n);}if(b){this._rowOptionsButtons[b]=h;}}this._rowOptionsElement=c.appendTo(m).bind("mousemove",function(){r._rowOptionsTargetRow=r._rowOptionsHoverRow;});}else{this._rowOptionsElement=undefined;}},_createRowOptionsSubMenu:function(c,f){if(c=="printRecord"){var e=this._rowOptionsHoverRow.attr("rowkey");if(!this._isIdEqual(e,this._rootNode)){var b=this.getRecordSet().getRecordByPrimaryKey(e),d=this._prepareReports(false,b);if(d===false){this._needPrint=false;}else{if(typeof(d)=="string"){this._needPrint=d;d=false;}}if(d){f.subMenu=d;}}}},_createRowOptionsMenu:function(b){var d=this._rowOptionsDefault,m=[],j=$ws._const.wsRoot+($ws._const.theme?"img/themes/"+$ws._const.theme+"/browser/":"img/browser/"),l=this,g=false;this._rowOptionsMenu=true;for(var f=0,h=d.length;f<h;++f){if(d[f][0]){var k;if(typeof(d[f][2])==="function"){k=this._rowOptionsCallbackWrapper(d[f][2]);}else{k=this._actions[d[f][2]];}var c=function(o,n,i){if(!i.subMenu){o(l._rowOptionsHoverRow,true);}}.bind(this,k),e={caption:d[f][0],id:l.getId()+"_"+(d[f][3]||d[f][2]),imgSrc:d[f][1].indexOf("/")>-1?d[f][1]:j+d[f][1],handlers:{onActivated:c}};this._createRowOptionsSubMenu(d[f][2],e);m.push(e);g=false;}else{if(m.length){m.push({caption:""});g=true;}}}if(g){m.pop();}$ws.core.attachInstance("Control/Menu",{data:m,handlers:{onReady:function(){l._rowOptionsMenu=this;l._rowOptionsCurrentMenu=this;l._applyRowOptions();this.show(b);},onClose:function(i,n){if(n===0){l._rowOptionsMenuVisible=false;l._showRowOptionsForTargetRow();}}}}).addCallback(function(i){l._rowOptionsMenu=i;if(l._needPrint===false&&l._actions.printRecord){i.hideItem(l.getId()+"_printRecord");}});},_addCheckBox:function(c){var b=$('<span class="ws-browser-checkbox"></span>');$(c).find("td:first .ws-browser-cell-container").before(b);},_dragStart:function(c,b){this._head.find("tr:first").css("cursor","col-resize");this._resizing=true;this._resizingColumn=c;this._start=b;},_dragMove:function(b){if(this._resizing&&this._isResizeAvailable(this._resizingColumn,b)){var f=this._newWidth(this._resizingColumn.prev(),b,1),e=this._newWidth(this._resizingColumn,b,-1);if(f&&e){this._setWidth(f);this._setWidth(e);this._start=b;}else{if(f){this._setWidth(f);var d=this._container.find(".ws-browser-container"),g=this._container.find(".ws-browser-footer"),c=this._container.find(".ws-browser-head");this._container.find(".ws-browser-head").css("overflow-x","hidden");d.width(d.width()+b-this._start+"px");g.width(g.width()+b-this._start+"px");c.width(c.width()+b-this._start+"px");this._start=b;}}}},_dragEnd:function(){if(this._resizing){this._head.find("tr:first").css("cursor","default");this._resizing=false;}},_newWidth:function(j,c,b){var g=0,f=[],e=0,h=j.attr("colspan");h=h?h:1;g=(c-this._start)/h;for(var d=j.attr("csIndex");h>0;d++,h--){e+=f[d]=parseInt(this._headColumns.eq(d).css("width"),10)+b*g;}return e>$ws._const.Browser.minColumnWidth?f:false;},_setWidth:function(B){var u=this,t=-1,m=0,d=0,y,C=[],o=[],g=[],j=[],E;y=u._rootElement.width()-(this._verticalScrollShowed?this._scrollWidth:0)-1;function p(I){var F=u._columnMap[I].type,i=u._columnMap[I].minWidth,H=$ws._const.Browser.defColWidth,G=F in H?H[F]:H.another;return parseInt(i!==null?i:G,10);}if(y===0){this._needResize=true;}E=(y>this._options.minWidth?y:this._options.minWidth)+"px";this._data.width(E);if(this._head){this._head.closest("table").width(E);}if(!this._haveAutoWidth()){if(B){$ws.helpers.forEach(B,function(F,i){this._headColumns.eq(i).attr("width",F);this._resultsColumns.eq(i).attr("width",F);this._bodyColumns.eq(i).attr("width",F);},this);}else{B=[];if(this._bodyColumns){this._bodyColumns.each(function(G){var F=(u._columnMap&&u._columnMap[G]&&u._columnMap[G].width)||0;o.push($(this));if(typeof(F)!="number"){if(F.indexOf("%")>0){F=Math.floor((y*parseInt(F,10))/100);}else{if(!u._columnMap[G]||!u._columnMap[G].fixedSize){g.push(G);}}}else{if(u._columnMap[G]&&!u._columnMap[G].fixedSize){g.push(G);}}if(u._columnMap[G]&&!u._columnMap[G].fixedSize){j.push(G);}F=parseInt(F,10);if(!F){F=p(G);if(u._columnMap[G]&&u._columnMap[G].fixedSize){throw new Error("Column with fixed size option must have width");}C.push(G);}B[G]=F;d+=F;if(F>m){m=F;t=G;}});}if(d>y&&j.length){var r=d-y,D=0;var n=function(i){$ws.helpers.forEach(j,function(F){if(F in B){var G=p(F);i(F,G,G-B[F]);}});};n(function(F,G,i){if(i>=0){r+=i;}else{D+=(-i);}});n(function(G,H,F){var i=B[G],I=(F>=0)?H:Math.max(i+r*(F/D),H);d+=(I-i);B[G]=I;});}var v=function(F){var i=F.length>0?Math.floor((y-d)/F.length):0;if(i>0){$ws.helpers.forEach(F,function(G){B[G]+=i;});d+=i*F.length;}};v(C.length?C:g);if(y>d){B[t]+=y-d;}if(this._bodyColumns){$ws.helpers.forEach(o,function(F,i){F.attr("width",B[i]);this._headColumns.eq(i).attr("width",B[i]);this._resultsColumns.eq(i).attr("width",B[i]);},this);}if(this._options.display.allowHorizontalScroll&&this._emptyDataScroller){this._emptyDataScroller.width(d);}}}else{this._rootElement.width("auto");this._data.removeClass("ws-table-fixed").width("auto").css({"table-layout":"auto"});this._head.parent().width("1px").css({"table-layout":"auto"});this._resultBrowser.removeClass("ws-table-fixed").width("1px").css({"table-layout":"auto"});this._browserContainer.width("auto");if(!B){B=$ws.helpers.map(this._columnMap,function(i){return i.width;});}var A=$(this._head).find("> tr:eq(0) > td"),s=this._resultBrowser.find("tr:eq(0) > td"),c=this._container.find(".ws-browser-footer");var w=this._options.display.allowAddAtThePlace?1:0,k=$(),l=this._data.find("tr:eq("+w+") > td"),b=this._data.find("tr"),x;for(x=w;x<b.length;x++){if($(b[x]).find('td[colspan="1"], td:not([colspan])').length>0){k=$(b[x]).find("td");break;}}$ws.helpers.forEach(B,function(F,G){u._bodyColumns.eq(G).attr("width","");u._headColumns.eq(G).attr("width","");u._resultsColumns.eq(G).attr("width","");},this);var f=0,e=this._currentRecordSet&&this._currentRecordSet.isEmptyTable();$ws.helpers.forEach(B,function(F,G){var H,I=u._columnMap[G]&&this._columnMap[G].fixedSize;if(I||e){H=I?B[G]:(B[G]||p(G));}else{H=Math.max(k.eq(G).outerWidth(),A.eq(G).outerWidth(),s.eq(G).outerWidth());if(this._columnMap[G]){this._columnMap[G].width=H=parseInt(H,10)+1;}}f+=H;},this);if(k.length===0){f=Math.max(l.eq(0).outerWidth(),f);}$ws.helpers.forEach(this._columnMap,function(F,G){this._headColumns.eq(G).attr("width",F.width);this._bodyColumns.eq(G).attr("width",F.width);this._resultsColumns.eq(G).attr("width",F.width);},this);this._data.width("auto");this._updateSizeVariables();var h=this._options.minWidth,q=false;if(this._verticalScrollShowed){h-=this._scrollWidth;}if(f<h){q=true;f=h;}var z=f;if(this._verticalScrollShowed){z+=this._scrollWidth;}this._data.width(f);this._browserContainer.width(z);this._head.parent().width(z);this._resultBrowser.width(z);c.width(z);this._container.width("auto");this._rootElement.width(z);if(q){$ws.helpers.forEach(this._columnMap,function(F,G){if(!F.fixedSize){this._bodyColumns.eq(G).attr("width","");}},this);$ws.helpers.forEach(this._columnMap,function(F,G){var H=k.eq(G).outerWidth();if(!F.fixedSize){F.width=H;}this._bodyColumns.eq(G).attr("width",H);this._headColumns.eq(G).attr("width",H);this._resultsColumns.eq(G).attr("width",H);},this);this._head.parent().width(z);}this._data.addClass("ws-table-fixed").css({"table-layout":"fixed"});this._head.parent().addClass("ws-table-fixed").css({"table-layout":"fixed"});this._resultBrowser.addClass("ws-table-fixed").css({"table-layout":"fixed"});}this._updateSizeVariables();},_getColumnsCount:function(){return this._columnMap.length;},_isResizeAvailable:function(g,b){var c=g.prev().attr("colspan"),e=g.attr("colspan"),d=(b-this._start)/(c?c:1),f=(b-this._start)/(e?e:1);return d===Math.round(d)&&f===Math.round(f);},_initColumnsWidth:function(){var c=0,b=this;b._resizingColumn=b._head.find("th:first");b._idCols=[];for(var d in b._columnMap){if(b._columnMap.hasOwnProperty(d)){b._idCols[c]=d;c++;}}c=0;b._body.find("tr:first > td").each(function(){if(b._options.display.viewType==="hierarchy"&&c!==0){$(this).attr("id",b._idCols[c-1]);}else{if(b._options.display.viewType!=="hierarchy"){$(this).attr("id",b._idCols[c]);}}c++;});b._setWidth();},_initResizeEvents:function(){var b=this;$("span.ws-browser-resize",b._head[0]).live("mousedown",function(c){b._dragStart($(this).parent(),c.clientX);return false;});$(".ws-browser-data-container",b._container[0]).live("mousemove",function(c){if(b._resizing===true){b._dragMove(c.clientX);}return false;});$(document).mouseup(function(){b._dragEnd();return false;});},setActiveRow:function(b){this.setActiveElement(b);},getActiveRow:function(){return this.getActiveElement();},_recordsMouseMove:function(b){if(!this._dragStarted){var k=Math.abs(b.clientX-this._dragStartPoint.x),j=Math.abs(b.clientY-this._dragStartPoint.y);if(k+j>$ws._const.startDragDistance){this._dragObject=$('<div class="ws-browser-dragged"><div class="ws-browser-dragged-count">'+this._dragRecords.length+"</div></div>").appendTo($("body")).css({left:b.clientX+$ws._const.Browser.recordsMoveOffset.left,top:b.clientY+$ws._const.Browser.recordsMoveOffset.top});this._dragRow.addClass("ws-browser-draggable-row");this._container.addClass("drag-over ws-no-select");this._dragStarted=true;}else{return true;}}this._dragObject.css({left:b.pageX+$ws._const.Browser.recordsMoveOffset.left,top:b.pageY+$ws._const.Browser.recordsMoveOffset.top});var e=$(b.target);if(b.target.nodeName.toLowerCase()!="tr"){e=e.closest("tr");}if(this._dragTargetRow){if(!(e.length!==0&&e.attr("rowkey")==this._dragTargetRow.attr("rowkey"))){this._dragTargetRow.removeClass("ws-browser-want-drag");this._dragTargetRow=undefined;}else{return false;}}this._dragTargetRow=e;this._dragIsCorrect=false;if(e.length===0||e.parents("table").get(0)!=this._data.get(0)){return false;}var c=e.attr("rowkey"),g=this._currentRecordSet.contains(c)&&this._currentRecordSet.getRecordByPrimaryKey(c);if(c==="null"){c=null;}if(!g&&c!=this._rootNode){return false;}var f,h;for(f=0,h=this._dragRecords.length;f<h;++f){if(this._dragRecords[f].getKey()==c){return false;}}if(this._notify("onDragMove",this._dragRecords,g)===false){return false;}if(this._options.display.viewType==="tree"){var d=c;while(d&&d!=this._rootNode){for(f=0,h=this._dragRecords.length;f<h;++f){if(this._dragRecords[f].getKey()==d){return false;}}d=g.get(this._hierColumnParentId);if(this._currentRecordSet.contains(d)){g=this._currentRecordSet.getRecordByPrimaryKey(d);}else{if(d!=this._rootNode){if(d!=this._currentRootId){return false;}break;}}}}this._dragIsCorrect=true;this._dragTargetRow.addClass("ws-browser-want-drag");return false;},_recordsMouseUp:function(){$(document).unbind("mousemove mouseup");this._useKeyboard=false;if(!this._dragStarted){return;}$ws.helpers.clearSelection();$(this._body.find("tr.ws-browser-draggable-row")).removeClass("ws-browser-draggable-row");var c=this;this._dragObject.fadeOut("fast",function(){c._dragObject.remove();});var d=this._dragTargetRow?this._dragTargetRow.attr("rowkey"):undefined,b=d?this._currentRecordSet.contains(d)&&this._currentRecordSet.getRecordByPrimaryKey(d):undefined;if(this._notify("onDragStop",this._dragRecords,b,this._dragIsCorrect)!==false){if(b){if(this.isHierarchyMode()&&b.get(this._hierColumnIsLeaf)!==true){d=b.get(this._hierColumnParentId);b=this._currentRecordSet.contains(d)?this._currentRecordSet.getRecordByPrimaryKey(d):undefined;}if(this._dragTargetRow&&this._dragIsCorrect){this.move(d);}}}if(this._dragTargetRow){this._dragTargetRow.removeClass("ws-browser-want-drag");this._dragTargetRow=undefined;}this._dragStarted=false;this._container.removeClass("drag-over ws-no-select");},_afterDrawActions:function(){clearTimeout(this._editAtPlaceTimer);this._editAtPlaceTimer=undefined;this._editTdCancel();this._editAtPlaceValidationErrors=0;this._editAtPlaceValidationMap={};this._editAtPlaceRecord=null;if(this._options.display.reload&&this._editAtPlaceChanges){this._editAtPlaceChanges=false;this.reload();}},reload:function(){if(this._options.display.viewType==="tree"){var g=this.getQuery(true),f=!this._options.display.partiallyLoad||this._options.display.expand||this._fullTreeExpand;g["Разворот"]=f?"С разворотом":"Без разворота";if(f){g[this._hierColumnParentId]=this._rootNode;}else{g[this._hierColumnParentId]=[];this._loaded={};for(var e in this._expanded){if(this._expanded.hasOwnProperty(e)){var b=this._expanded[e]?1:2,d=e,c=undefined;while(!this._isIdEqual(d,this._rootNode)){if(!this._currentRecordSet.contains(d)){b=0;break;}c=this._currentRecordSet.getRecordByPrimaryKey(d);d=c.get(this._hierColumnParentId);if(d!=this._rootNode&&!this._expanded[d]){b=0;break;}}if(b===1){g[this._hierColumnParentId].push(e);this._loaded[e]=true;}else{if(b===0){delete this._expanded[e];}}}}if(!this._options.display.showRoot&&!this._loaded[this._rootNode]){this._loaded[this._rootNode]=true;if(g[this._hierColumnParentId].length===0){g[this._hierColumnParentId]=this._rootNode;}else{g[this._hierColumnParentId].push(this._rootNode);}}else{if(g[this._hierColumnParentId].constructor===Array&&g[this._hierColumnParentId].length===0){this._expanded[this._rootNode]=true;g[this._hierColumnParentId]=this._rootNode;}}if(this._options.display.viewType==="tree"&&this._options.display.expand){this._expanded[this._rootNode]=2;g["Разворот"]="С разворотом";}}if(this._options.display.viewType==="tree"&&this._options.display.expand){this._expanded[this._rootNode]=2;g["Разворот"]="С разворотом";}return this._runQuery(g,true);}else{return $ws.proto.Browser.superclass.reload.apply(this,arguments);}},setColumns:function(e){var c=this,f=[];for(var d=0,b=e.length;d<b;d++){if(e[d]!==undefined){e[d].title=e[d].title.replace(/\\\.|\\/g,function(g){if(g.length==2){return".";}else{return g+g;}});f.push(e[d]);}}this._dReady.addCallback(function(){var o={},n=false,j,g,h;c._options.display.columns=f;g=c._resultFields.length;for(j=0;j<g;j++){o[c._resultFields[j]]=true;}c._initResultFieldsList();h=c._resultFields.length;if(g!==0&&h!==0){if(g==h){for(j=0;j<h;j++){if(!o[c._resultFields[j]]){n=true;return;}}}else{n=true;}}c._columnMap=[];c._drawHead();c._setHeight();if(n){var m=c.getQuery();m["_Итоги"]=c._options.filterParams["_Итоги"];c.setQuery(m);}else{c.refresh();}});},getColumns:function(){return this._options.display.columns||(this._currentRecordSet&&this._currentRecordSet.getColumns());},setEnabled:function(b){b=!!b;if(this._options.allowChangeEnable||b===this._options.enable){$ws.proto.Browser.superclass.setEnabled.apply(this,arguments);if(this._options.display.rowOptions){if(!b){this._hideRowOptions();this._uninitRowOptions();}else{this._initRowOptions();}}this._editTdDestroyField();}},_getAdditionalHeight:function(){var b=this._foot.height(),c=this._headContainer.height(),d=(this._resultBrowser?this._resultBrowser.height():0);return b+c+d;},setRowRender:function(b){this._options.display.rowRender=b;},setLoadChildFlag:function(b){this._useLoadChildsFlag=b;this._systemParams["_ЕстьДочерние"]=b;},_onDataLoaded:function(f,e,b,d,c){this._isLoading=true;if(!c||!c.browserFolder){$ws.proto.Browser.superclass._onDataLoaded.apply(this,arguments);}},isLoading:function(){return this._isLoading;},destroy:function(){if(this._rowOptionsMenu instanceof Object){this._rowOptionsMenu.destroy();}if(!Object.isEmpty(this._ladder)){this.unsubscribe("onKeyPressed",this._onKeyPressedOnBrowser);}if(this._editAtPlaceFocusCallback){$("body").unbind("click.edit_"+this.getId(),this._editAtPlaceFocusCallback);}$ws.proto.Browser.superclass.destroy.apply(this,arguments);},_redraw:function(){}});return $ws.proto.Browser;});