$ws.declareModule({namespace:"SBIS3.CORE",name:"HTMLView",imports:["SBIS3.CORE.TemplatedAreaAbstract"]},function(a){$ws.proto.HTMLView=a.extend({$protected:{_width:"",_height:"",_options:{docType:"string",url:"",string:"",hidden:false},_iframeReady:undefined,_dReady:undefined,_iframe:undefined,_iframeContainer:undefined,_loaded:true},$constructor:function(){this._publish("onContentSet","onBeforePrint");this._redraw(true);},_redraw:function(c){var b=this;this._dReady=new $ws.proto.Deferred();this._iframeReady=new $ws.proto.Deferred();if(!c){this._dChildReady=new $ws.proto.ParallelDeferred();this._iframeContainer.remove();this._iframe=null;this._isReady=false;this._loaded=false;this._container.html("");}if(this._options.maxWidth===undefined){this._options.maxWidth=Infinity;}if(this._options.maxHeight===undefined){this._options.maxHeight=Infinity;}switch(this._options.docType){case"string":if(this._options.string){this.setHTML(this._options.string);}else{this._dReady.callback();}break;case"url":if(this._options.url){this.setUrl(this._options.url);}else{this._dReady.callback();}break;case"template":this.setTemplate(this._options.template);break;default:throw new Error("HTMLView does not support this docType");}this._dReady.addCallback(function(){b._dChildReady.done();b._isReady=true;});},_contentLoaded:function(){var b=this;if(!this._iframeReady.isReady()){this._iframeReady.callback();}this.setAutoSize();if(!this._dReady.isReady()){this._dReady.callback();}setTimeout(function(){b.setAutoSize();},500);},_getCurrIframeCtrl:function(){var b=$("#htmlviewframe_"+this.getId());if(!(b||b.get(0).contentDocument||b.get(0).contentWindow)){return false;}else{return b;}},_getIframeBodySize:function(i){var g=$("body",i.contents()),f=$("html",i.contents()),e=g.css("position"),k,c;f.css("margin","0");g.css("margin","0");var h={width:f.outerWidth(true)-f.innerWidth(),height:f.outerHeight(true)-f.innerHeight()},b={width:g.outerWidth(true)-g.innerWidth()+h.width,height:g.outerHeight(true)-g.innerHeight()+h.height};var d=i.height(),j=i.width();if(this._horizontalAlignment!=="Stretch"){i.width("auto");if(i.width()<this._options.minWidth){i.width(this._options.minWidth);}}if(this._verticalAlignment!=="Stretch"){i.height("auto");}g.css("position","absolute");k=Math.max(g.size()?parseInt(g.prop("scrollHeight"),10):150,g.outerHeight(true)+b.height);if(this._verticalAlignment=="Stretch"){k=0;}c=Math.max(g.size()?parseInt(g.prop("scrollWidth"),10):300,g.outerWidth(true)+b.width);if(this._horizontalAlignment=="Stretch"){c=0;}i.height(d);i.width(j);g.css("position",e);return{height:k+1,width:c+1};},_updateResizer:function(){function i(n){var m,q,l,p;if(this._options.autoHeight){if(this._verticalAlignment=="Stretch"){m="100%";}else{m=n.height;}}else{m=this._container.height();}if(this._options.autoWidth){if(this._horizontalAlignment=="Stretch"){q="100%";}else{q=n.width;}}else{q=this._container.width();}if(q!=="100%"){q=parseInt(q,10);q=Math.min(q,this._options.maxWidth);q=Math.max(q,this._options.minWidth);p=q;}else{p=0;}if(m!=="100%"){m=parseInt(m,10);m=Math.min(m,this._options.maxHeight);m=Math.max(m,this._options.minHeight);l=m;}else{l=0;}d.width(q).height(m);var o=$("html",d.contents());if(j&&h){o.css("overflow","hidden");}else{if(h){o.css("overflow-x","hidden");}else{if(j){o.css("overflow-y","hidden");}}}this._resizer.css({width:p,height:l});if(h){this._container.width(q);}if(j){this._container.height(m);}return{width:p,height:l};}if(this._options.docType=="template"){$ws.proto.HTMLView.superclass._updateResizer();}else{var d=this._getCurrIframeCtrl();if(!d){return;}var h=this._options.autoWidth&&this._horizontalAlignment!=="Stretch",j=this._options.autoHeight&&this._verticalAlignment!=="Stretch",b=this._getIframeBodySize(d);b=i.call(this,b);if($ws._const.browser.isIE&&(h||j)){var c=d.contents(),f=$("body",c),e;if(f.size()>0){e=$("html",c);if(h){var k=f.prop("scrollWidth");if(k>b.width){b.width=k+1;b=i.call(this,b);}}if(j){var g=f.prop("scrollHeight");if(g>b.height){b.height=g+1;i.call(this,b);}}}}}},setAutoSize:function(){var b=this._getCurrIframeCtrl();if(!b){return;}this._initResizers();this._notifyOnSizeChanged(this,this);},_loadDescendents:function(){return new $ws.proto.Deferred().callback();},_createIFrame:function(c){var d="htmlviewframe_"+this.getId();this._container.html("");if(c){c();}this._iframeContainer=$('<div id="htmlview_'+this.getId()+'"></div>').appendTo(this._container);var g=/%/,f=this._options.autoWidth?"auto":g.test(this._options.width)?this._options.width:this._options.width+"px",b=this._options.autoHeight?"auto":g.test(this._options.height)?this._options.height:this._options.height+"px",e={position:"absolute",left:0,top:0,width:(this._options.autoWidth&&this._horizontalAlignment!="Stretch"?f:"100%"),height:(this._options.autoHeight&&this._verticalAlignment!="Stretch"?b:"100%")};this._iframeContainer.css(e);if($.browser.msie){this._iframeContainer.css("overflow","visible");}var h='<iframe width="100%" height="100%" id="'+d+'" name="'+d+'" frameborder="0">iFrame not supported!</iframe>';return $(h);},setHTML:function(c){var b=this;this._options.docType="string";this._loaded=false;this._createIFrame().load(function(){if(!b._loaded){b._loaded=true;b._iframe=this;var e=b._container.get(0);var d=(e&&e.style.visibility)||"";b._container.css("visibility","visible");var f=b.getIframeDocument();f.open();f.write('<meta name="format-detection" content="telephone=no"><script>function printPage(){window.print();}<\/script>');f.write(c);f.close();b._container.css("visibility",d);$(f).ready(function(){$(f).find("head").append('<style media="screen, print">body { margin: 0; } a[href^="tel:"] { text-decoration: none; color: inherit; }</style>');b._contentLoaded();b._notify("onContentSet","string",c);});}}).appendTo(this._iframeContainer);},getHTML:function(){return this.getIframeDocument().body.innerHTML;},setTemplate:function(b){BOOMR.plugins.WS.reportEvent("control.HTMLView","setTemplate");var c=this;this._options.template=b;this._options.docType="template";this._iframe=undefined;return this._runInBatchUpdate("setTemplate",function(){return c._loadTemplate().addCallback(function(){c._notify("onContentSet","template",b);});});},setUrl:function(c){var b=this;this._loaded=false;function d(){var e='<div class="ws-loading-indicator-outer"><div class="ws-area-service ws-loading-indicator">'+($ws._const.theme==="wi_scheme"?"":"Загрузка")+"</div></div>";b._container.html(e);}this._createIFrame(d).load(function(){b._iframe=this;b._loaded=true;var e=b.getIframeDocument();$(e).ready(function(){b._container.find(".ws-loading-indicator-outer").remove();b._contentLoaded();b._notify("onContentSet","url",c);});}).attr("src",c).appendTo(this._iframeContainer);},print:function(){if(this._iframe){if(this._notify("onBeforePrint",this._iframe)!==false){var b=this.getIframeWindow(),c=this;if($.browser.opera){var i=this.getIframeDocument().documentElement,g=window.document.documentElement,e=$('<style type="text/css">@media screen{body > *, body {display: none !important;}}</style>');window.document.replaceChild(i,window.document.documentElement);$("head").append(e);setTimeout(function(){window.focus();window.print();setTimeout(function(){window.document.replaceChild(g,window.document.documentElement);var j=c.getIframeDocument();j.replaceChild(i,j.documentElement);setTimeout(function(){e.remove();},100);},100);},500);}else{var h=false,f=$(this._iframe),d;if($.browser.msie&&!f.is(":visible")){h=true;f.parents().andSelf().each(function(){var j=$(this);j.data("display",j.css("display"));j.data("visibility",j.css("visibility"));j.data("ws-hidden",j.hasClass("ws-hidden"));j.css({display:"block",visibility:"visible"});j.removeClass("ws-hidden");});d=f.css("opacity");f.css({opacity:0});}setTimeout(function(){(c._iframe.contentWindow||b).focus();setTimeout(function(){b.printPage();if(h){f.css("opacity",d).parents().andSelf().each(function(){var j=$(this);j.data("display",j.css("display"));j.data("visibility",j.css("visibility"));j.css({display:j.data("display"),visibility:j.data("visibility")});if(j.data("ws-hidden")){j.addClass("ws-hidden");}});}},0);},100);}}}},getIframeDocument:function(){if($.browser.msie){return window.frames["htmlviewframe_"+this.getId()].document;}return this._iframe.contentDocument;},getIframeWindow:function(){if($.browser.msie){return window.frames["htmlviewframe_"+this.getId()];}return this._iframe.contentWindow;},getReadyDeferred:function(){return this._dReady;},addStyle:function(c){var b=this;return this._iframeReady.addCallback(function(){var d=b.getIframeDocument().createElement("link"),f=new $ws.proto.Deferred(),g=b.getIframeDocument();c=c.substr(0,1)=="/"?$ws.core.urlWithHost(c):$ws.core.urlWithHost($ws._const.wsRoot+c);d.setAttribute("rel","stylesheet");d.setAttribute("type","text/css");d.setAttribute("href",c);g.childNodes[0].childNodes[0].appendChild(d);var e=g.createElement("img");e.onerror=function(){f.callback();g.body.removeChild(e);};g.body.appendChild(e);e.src=c;return f;});},getIframe:function(){return this._iframe;},getIframeContainer:function(){return this._iframeContainer;},hideIframeContainer:function(){if($.browser.msie){this._iframeContainer.css("opacity",0);}else{if($.browser.opera){this._iframeContainer.css("display","none");}else{this._iframeContainer.css("visibility","hidden");}}}});return $ws.proto.HTMLView;});