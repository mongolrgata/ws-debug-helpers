$ws.declareModule({namespace:"SBIS3.CORE",name:"FieldImage",imports:["SBIS3.CORE.Control"]},function(a){$ws.single.DependencyResolver.register("SBIS3.CORE.FieldImage",function(c){var b=[];if(c){if(c.cropEnabled){b.push("/lib/Control/Plugins/FieldImageCrop-plugin.js");b.push("/ext/jcrop/jquery.Jcrop.min.js");b.push("/ext/jcrop/jquery.Jcrop.min.css");}if(c.zoomEnabled){b.push("/lib/Control/Plugins/FieldImageZoom-plugin.js");}}return b;});$ws.proto.FieldImage=a.DataBoundControl.extend({$protected:{_options:{dataSource:{},urlTemplate:"",allowSizeReduce:false,filterParams:{},cropEnabled:false,zoomEnabled:false},_cH:0,_cW:0,_imageReady:false,_realImH:0,_realImW:0,_url:"",_loading:undefined},$constructor:function(){this._publish("onImageReady","onError");this._options.tabindex=null;this._build();this._onResizeHandler();this._container.addClass("ws-image-container").addClass("ws-no-focus");this._buildUrl();if(this._url!==""){this._createImage(this._url);}},_build:function(){},_buildUrl:function(){var b=this._options.urlTemplate;if(b!==""&&b.indexOf("{VALUE}")==-1){this._url=b;this._options.urlTemplate="";}else{if(typeof(this._options.dataSource)=="object"&&!Object.isEmpty(this._options.dataSource)){this._options.dataSource=$ws.core.merge({filterParams:{},readerParams:{serviceUrl:"",linkedObject:"",queryName:""}},this._options.dataSource);this._url=this._buildRPCUrl(this._options.dataSource);}}},setSource:function(b){this._options.dataSource=b;this.reloadImage();},_onContextValueReceived:function(b){if(b!==undefined&&b!==null){this.setValue(b);}},_onClickHandler:function(){},_onResizeHandler:function(){this._cH=this._container.height();this._cW=this._container.width();this._getRepositionMethod().call(this);},_getImage:function(){return this._container.children("img:not(.ws-fieldImage-loading-indicator)");},_reposition:function(){var j=this._container.children("div"),i=this.getRealHeight(),d=this.getRealWidth(),g,c,e=this._getImage();j=j[0]?j:e;if(i>this._cH||d>this._cW){if(this._options.allowSizeReduce){var b=Math.max(i/this._cH,d/this._cW);g=i/b;c=d/b;j.css({height:Math.round(g),width:Math.round(c),left:Math.round((this._cW-c)/2),top:Math.round((this._cH-g)/2)});}else{this._container.css("overflow","auto");}}else{var f=Math.min(this._cH/i,this._cW/d);g=i*f;c=d*f;if(g>this._realImH||c>this._realImW){g=this._realImH;c=this._realImW;}this._container.css("overflow","hidden");j.css({height:Math.round(g),width:Math.round(c),left:Math.round((this._cW-c)/2),top:Math.round((this._cH-g)/2)});}},_getRepositionMethod:function(){return this._reposition;},_rebuildImage:function(){if(this._imageReady===false||this._cH<=0||this._cW<=0){return;}var b=this._getImage();this._container.css("overflow","hidden");b.css({visibility:"hidden",width:"",height:""});var c=new Image();c.src=b[0].src;this._realImH=b[0].naturalHeight||b[0].height||b.height()||c.height;this._realImW=b[0].naturalWidth||b[0].width||b.width()||c.width;b.css("visibility","");this._getRepositionMethod().call(this);},getRealHeight:function(){return this._realImH;},getRealWidth:function(){return this._realImW;},setValue:function(b){if(this._options.urlTemplate!==""){this._createImage(this._options.urlTemplate.replace("{VALUE}",b));}},_getImageContainer:function(){return this._container;},_createImage:function(d){var c=this,e=this._options.tooltip===""?this.getName():this._options.tooltip,f=this._options.tooltip;this._imageReady=false;var b=$("<img />",{title:f,alt:e}).load(function(){setTimeout(function(){c.removeImage();c._removeLoading();c._getImageContainer().append(b);c._imageReady=true;c._rebuildImage();c._notify("onImageReady");},0);}).error(function(){c._container.find(".ws-fieldImage-loading-indicator").remove();c._notify("onError");});this._removeLoading();this._loading=$("<img />",{src:$ws._const.wsRoot+"img/ajax-loader-indicator.gif","class":"ws-fieldImage-loading-indicator"}).appendTo(this._container);b.attr("src",d);},_removeLoading:function(){if(this._loading){this._loading.remove();this._loading=undefined;}},_buildRPCUrl:function(b){return $ws.helpers.prepareGetRPCInvocationURL(b.readerParams.linkedObject,b.readerParams.queryName,this._options.filterParams,this._context,b.readerParams.otherUrl);},reloadImage:function(){this._buildUrl();if(this._url!==""){this._createImage(this._url);}},setTooltip:function(b){$ws.proto.FieldImage.superclass.setTooltip.apply(this,arguments);this._container.find("img").attr("title",b);},removeImage:function(){this._getImageContainer().empty();this._imageReady=false;},_onPluginLoaded:function(b){},_redraw:function(){}});return $ws.proto.FieldImage;});