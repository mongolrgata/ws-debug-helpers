$ws.declareModule({namespace:"SBIS3.CORE",name:"AreaAbstract",imports:["SBIS3.CORE.Control"]},function(a){a.ControlBatchUpdater.registerDelayedAction("AreaAbstract.activateSiblingControlOrSelf",function(d,c,e){d._activateSiblingControlOrSelfLow(c,e);},true);var b=$ws.core.extend({},{$protected:{_group:[]},$constructor:function(c){this._group=c;},setEnabled:function(c){},setVisible:function(c){},getGroupContainers:function(){},destroy:function(){this._group=null;}});$ws.proto.AreaAbstract=a.Control.extend({$protected:{_horizontalAlignment:"Left",_verticalAlignment:"Top",_options:{context:false,record:false,groups:{},tabindex:1},_pending:[],_waiting:[],_groupInstances:{},_contextName:"",_rigisteredControls:0,_activeChildControl:-1,_activatedWithTabindex:true,_childControls:[],_childNonControls:[],_childsMapName:{},_childsMapId:{},_childContainers:[],_childsTabindex:false,_childsSizes:{},_maxTabindex:false,_dChildReady:null,_keysWeHandle:[$ws._const.key.tab,$ws._const.key.enter],_resizer:null,_toolbarCount:{top:0,right:0,bottom:0,left:0},_defaultButton:null,_craftedContext:false,_activationIndex:0,_opener:undefined,_isModal:false},$constructor:function(c){var d=this;this._publish("onResize","onActivate");this._dChildReady=new $ws.proto.ParallelDeferred();if(this._options.context instanceof $ws.proto.Context){this._context=this._options.context;this._options.context=null;delete this._options.context;}else{if(this._context.isGlobal()){this._context=new $ws.proto.Context();this._craftedContext=true;}else{this._context=new $ws.proto.Context();this._context.setPrevious(this._parent?this._parent.getLinkedContext():null);this._craftedContext=true;}if(typeof(this._options.context)=="object"){this._context.setContextData(d._options.context);}}if(d._options.record){this._context.setContextData(d._options.record);}if(!this._isCorrectContainer()){this._container=$("<div></div>",{tabindex:this._options.tabindex>=0?0:-1}).bind("click",$.proxy(this._onClickHandler,this));this._initKeyboardMonitor();}d._container.bind("mousedown.activate",function(){if(!$.event.props["ws-area-activated-id"]){var e=d.findParent(function(f){return(SBIS3.CORE.Window&&f instanceof SBIS3.CORE.Window)||(SBIS3.CORE.FloatArea&&f instanceof SBIS3.CORE.FloatArea);});if(e){e.moveToTop();}d._container.trigger("container-clicked");$.event.props["ws-area-activated-id"]=d.getId();}});$ws._const.$doc.bind("mousedown."+this.getId(),function(){if(d.getId()==$.event.props["ws-area-activated-id"]){$.event.props["ws-area-activated-id"]=null;}});if(!this.getParent()){$ws._const.$win.bind("resize."+this.getId(),$.proxy(this._onResizeHandler,this));}this._container.addClass("ws-area");this._dChildReady.getResult().addCallback(function(){d._childNonControls=d._container.children($ws.helpers.NON_CTRL);});if(c&&c.opener){this._opener=c.opener;}},addPendingOperation:function(c){if(c&&(c instanceof $ws.proto.Deferred)){this._pending.push(c);c.addBoth(this._checkPendingOperations.bind(this));return true;}else{return false;}},waitAllPendingOperations:function(c){if(c&&(c instanceof $ws.proto.Deferred)&&!c.isReady()){if(this._pending.length===0){c.callback();}else{this._waiting.push(c);}return true;}else{return false;}},_checkPendingOperations:function(e){var d,c,f=0;for(d=0,c=this._pending.length;d<c;d++){if(this._pending[d].isReady()){f++;}}if(f==c){this._pending=[];while(this._waiting.length>0){this._waiting.pop().callback();}}return e;},init:function(){$ws.single.WindowManager.addWindow(this);$ws.proto.AreaAbstract.superclass.init.apply(this,arguments);if(this._opener instanceof $ws.proto.Control){this._opener.getContainer().trigger("wsWindowOpen",this);}},_onClickHandler:function(c){c.stopImmediatePropagation();this.onBringToFront();this._notify("onClick");},_initFocusCatch:function(){},moveToTop:function(){},getReadyDeferred:function(){return this._dChildReady.getResult();},getTemplateName:function(){return this._options.template._templateName;},unregisterDefaultButton:function(c){if(this._defaultButton===c){this._defaultButton=null;}},registerDefaultButton:function(c){if(this._defaultButton){this._defaultButton.setDefault(false);}this._defaultButton=c;},_restoreSize:function(){if(this._width||this._height){this._container.css({width:this._options.autoWidth||this._horizontalAlignment==="Stretch"?"auto":this._width,height:this._options.autoHeight||this._verticalAlignment==="Stretch"?"auto":this._height});}},_resizeChilds:function(){var e;if(this.isVisible()){for(var c=0,d=this._childControls.length;c<d;c++){e=this._childControls[c];if(e&&e.isVisible()){e._onResizeHandler();}}}},_onResizeHandler:function(c,d){if(!this._isMaximize){this._restoreSize();}$ws.proto.AreaAbstract.superclass._onResizeHandler.apply(this,arguments);this._resizeChilds();this._notify("onResize",d);},activateFirstControl:function(){this._activateSiblingControlOrSelf(false,-1);},activateLastControl:function(){this._activateSiblingControlOrSelf(true,this._maxTabindex?this._maxTabindex+1:this._childControls.length);},_activateFirstCtrl:function(){this.activateFirstControl();},setSize:function(c){if(this._options.autoHeight){c.height="auto";}this._container.css(c);this._resizeChilds();this._notify("onResize");},setActive:function(d,c){this._isControlActive=d;if(d){this._container.removeClass("ws-control-inactive");if(c){this.activateLastControl();}else{this.activateFirstControl();}}},getNamedGroup:function(f){if(f in this._options.groups){if(f in this._groupInstances){return this._groupInstances[f];}else{var j=[];var d=this._options.groups[f];for(var g=0,c=d.length;g<c;g++){try{j.push(this.getChildControlById(d[g]));}catch(h){}}return(this._groupInstances[f]=new b(j));}}else{return null;}},registerChildControl:function(g){if(g instanceof $ws.proto.Control){var d=g.getParent();if(d){if(d!==this||this._childsMapId[g.getId()]){$ws.single.ioc.resolve("ILogger").error("AreaAbstract::registerChildControl","Нельзя зарегистрировать этот контрол: ("+g.getId()+") в контроле: "+this.getId()+", у него уже есть родитель: "+d.getId());}}var h=this._childControls.length,e=g.getTabindex();if(e){var f=parseInt(e,10);if(this._childsTabindex[f]!==undefined){f=this._maxTabindex+1;g.setTabindex(f,true);}if(f>0){if(!this._maxTabindex){this._maxTabindex=f;}else{this._maxTabindex=this._maxTabindex>f?this._maxTabindex:f;}if(!this._childsTabindex){this._childsTabindex={};}this._childsTabindex[f]=h;}}this._childsMapId[g.getId()]=h;this._childsMapName[g.getName()]=h;this._childControls.push(g);if(g instanceof $ws.proto.AreaAbstract){this._childContainers.push(g);}if(!this._options.enable){var c=function(){g.setEnabled(false);g.unsubscribe("onInit",c);};g.subscribe("onInit",c);}}},changeControlTabIndex:function(j,g){var c,h=j.getTabindex();delete this._childsTabindex[j.getTabindex()];for(var f=0,d=this._childControls.length;f<d;f++){var k=this._childControls[f];if(!k){continue;}var e=parseInt(k.getTabindex(),10);if(g>h){if(e>h&&e<=g){this._childsTabindex[e-1]=f;this._childControls[f].setTabindex(e-1,true);}}else{if(e>=g&&e<h){this._childsTabindex[e+1]=f;this._childControls[f].setTabindex(e+1,true);}}if(this._childControls[f]==j){c=f;}}this._childsTabindex[g]=c;this._maxTabindex=this._maxTabindex<g?g:this._maxTabindex;},unregisterChildControl:function(f){var d=this._childsMapId[f.getId()];if(d!==undefined){delete this._childControls[d];delete this._childsMapId[f.getId()];delete this._childsMapName[f.getName()];if(f instanceof $ws.proto.AreaAbstract){for(var e=0,c=this._childContainers.length;e<c;e++){if(this._childContainers[e]==f){delete this._childContainers[e];break;}}}}},_searchChildren:function(h,f){for(var d=0,c=this._childContainers.length;d<c;d++){try{return this._childContainers[d]["getChildControlBy"+h](f);}catch(g){}}return null;},getChildControlById:function(d){if(this._childsMapId[d]!==undefined){return this._childControls[this._childsMapId[d]];}var c=this._searchChildren("Id",d);if(c){return c;}throw new Error("Control with ID "+d+" is not present in this container");},getChildControlByName:function(d){if(this._childsMapName[d]!==undefined){return this._childControls[this._childsMapName[d]];}var c=this._searchChildren("Name",d);if(c){return c;}throw new Error("Control with name "+d+" is not present in this container");},hasChildControlByName:function(c){if(this._childsMapName[c]!==undefined){return true;}return !!this._searchChildren("Name",c);},getNearestChildControlByName:function(d,l){if(l){var j={},g=[],k,e=function(i){if(i&&!j[i.getId()]){j[i.getId()]=true;g.push(i);}};e(this);while(g.length){var c=g.shift();if(c.hasChildControlByName){if(c.hasChildControlByName(d)){return c.getChildControlByName(d);}}else{if(c.getName&&c.getName()===d){return c;}}k=c.getParent();if(k){e(k);}if(c.getOpener){e(c.getOpener());}if(c._childContainers){for(var f=0,h=c._childContainers.length;f<h;++f){e(c._childContainers[f]);}}}}else{k=this;while(k){if(k.hasChildControlByName){if(k.hasChildControlByName(d)){return k.getChildControlByName(d);}}k=k.getParent()||(k.getOpener&&k.getOpener());}}return undefined;},getChildControls:function(g){var f=[];for(var e=0,d=this._childControls.length;e<d;e++){if(e in this._childControls){var h=this._childControls[e];if(h){if(h instanceof $ws.proto.AreaAbstract){Array.prototype.push.apply(f,h.getChildControls(g));if(g){continue;}}f.push(h);}}}return f;},getImmediateChildControls:function(){return this._childControls;},getActiveChildControl:function(e){var d=this._activatedWithTabindex?this._childsTabindex[this._activeChildControl]:this._activeChildControl;if(e&&this._childControls[d]&&!this._childControls[d].canAcceptFocus()){for(var c=0;c<this._childControls.length;++c){if(this._childControls[c]&&this._childControls[c].canAcceptFocus()){return this._childControls[c];}}}return this._childControls[d];},_isActiveByTabindex:function(){return this._childsTabindex&&this._activeChildControl in this._childsTabindex&&this._childControls[this._childsTabindex[this._activeChildControl]];},isModal:function(){return this._isModal;},getContext:function(){return this._context;},_removeControls:function(){for(var c in this._childControls){if(this._childControls.hasOwnProperty(c)){this._childControls[c].destroy();}}this._childControls=[];this._childsMapId={};this._childsMapName={};this._childContainers=[];this._childsSizes={};},destroy:function(){var d=$ws.single.ControlBatchUpdater;d.beginBatchUpdate("AreaAbstract_destroy");try{for(var c in this._groupInstances){if(this._groupInstances.hasOwnProperty(c)){this._groupInstances[c].destroy();}}this._defaultButton=null;this._removeControls();if(this._craftedContext&&this._context){this._context.destroy();}$ws._const.$win.unbind("resize."+this.getId());$ws._const.$doc.unbind("mousedown."+this.getId());$ws.single.WindowManager.removeWindow(this);$ws.proto.AreaAbstract.superclass.destroy.apply(this,arguments);}finally{d.endBatchUpdate("AreaAbstract_destroy");}},destroyChild:function(g){var d=this._childsMapId[g];if(d!==undefined){var f=this._childControls[d];if(f){delete this._childsMapId[f.getId()];delete this._childsMapName[f.getName()];delete this._childControls[d];if(f instanceof $ws.proto.AreaAbstract){for(var e=0,c=this._childContainers.length;e<c;e++){if(this._childContainers[e]==f){delete this._childContainers[e];break;}}}f.destroy();}}},disableActiveCtrl:function(c){var e=this.getActiveChildControl();if(e&&e.isActive()){var d=e instanceof $ws.proto.AreaAbstract;if(d&&!c||!d){e.setActive(false);}}},_keyboardHover:function(c){if(c.which in this._keysWeHandle){if(c.which==$ws._const.key.tab){return this.moveFocus(c);}if(c.which==$ws._const.key.enter){if(!(c.altKey||c.shiftKey)){if(this._defaultButton&&this._defaultButton.isEnabled()){this._defaultButton._notify("onActivated");return false;}else{return true;}}}}},moveFocus:function(c){c.stopPropagation();if(!this.detectNextActiveChildControl(c.shiftKey)){if(this.focusCatch(c)){return true;}}return false;},focusCatch:function(d){var c=this.getParent();if(!c){$ws.single.WindowManager.disableLastActiveControl();if(d.shiftKey){$ws.single.WindowManager.focusToFirstElement();}else{$ws.single.WindowManager.focusToLastElement();}return true;}else{do{if(c.detectNextActiveChildControl(d.shiftKey)){return false;}}while(c.getParent()&&(c=c.getParent()));return c.focusCatch(d);}},_activateSiblingControlOrSelf:function(c,d){a.ControlBatchUpdater.runBatchedDelayedAction("AreaAbstract.activateSiblingControlOrSelf",[this,c,d]);},_moveFocusToSelf:function(){$ws.single.WindowManager.disableLastActiveControl(this);this._activeChildControl=-1;this._container.focus();if($.browser.mozilla){try{document.getSelection().removeAllRanges();}catch(c){}}this._notify("onActivate");},_activateSiblingControlOrSelfLow:function(c,d){if(!this.detectNextActiveChildControl(c,d)){this._moveFocusToSelf();}},detectNextActiveChildControl:function(f,j){var g=j!==undefined?j:this._activeChildControl,m=this,k=f?g-1:g+1,h=true,i=function(l){return m._childsTabindex?(l>0&&l<=m._maxTabindex):(l>=0&&l<m._childControls.length);};if(!i(k)&&!i(g)){var e=this._childsTabindex?this._maxTabindex+1:this._childControls.length;k=f?e-1:1;}if(this._childsTabindex){if(this._childsTabindex[k]===undefined||(this._childControls[this._childsTabindex[k]]&&!this._childControls[this._childsTabindex[k]].canAcceptFocus())){while(k>=0&&k<=this._maxTabindex){if(this._childControls[this._childsTabindex[k]]&&this._childControls[this._childsTabindex[k]].canAcceptFocus()){if(this._childsTabindex[k]!==undefined){break;}}k=f?k-1:k+1;}}}else{while(this._childControls[k]&&!this._childControls[k].canAcceptFocus()&&(k>=0&&k<this._childControls.length)){k=f?k-1:k+1;}}var c=this._childsTabindex?this._maxTabindex:this._childControls.length;if(k<0||k>c){k=f?c:-1;h=false;}if(h){var d=this._childsTabindex?this._childsTabindex[k]:k;if(this._childControls[d]){this._childControls[d].setActive(true,f);}else{h=false;}}return h;},setChildActive:function(f){var e=f.getId();if(f.getTabindex()>0){this._activeChildControl=parseInt(f.getTabindex(),10);this._activatedWithTabindex=true;}else{for(var d=0,c=this._childControls.length;d<c;d++){if(this._childControls[d]&&this._childControls[d].getId()===e){this._activeChildControl=d;this._activatedWithTabindex=false;break;}}}},onBringToFront:function(){if(this._childControls&&this._childControls.length){var c=this.getActiveChildControl(true);if(c){if(c instanceof $ws.proto.AreaAbstract){c.onBringToFront();}else{c.setActive(true);}}else{this._activateFirstCtrl();}}else{this._moveFocusToSelf();}},storeActiveChild:function(d){this.setChildActive(d);var c=this.getParent();if(c&&c instanceof $ws.proto.AreaAbstract){c.storeActiveChild(this);}},activate:function(e){var f;if(e){var c=$ws.single.WindowManager.getActiveWindow();if(c){var d=c.getActiveChildControl();if(d!=e&&d&&d.getParent()===c){f=d;}}}else{this._activeChildControl=undefined;}this.storeActiveChild(e);this._notify("onActivate");if(f){f.setActive(false,undefined,undefined,e);}},setActivationIndex:function(c){this._activationIndex=c;},isShow:function(){return true;},getZIndex:function(){return 0;},validate:function(g,d){if(!this.isVisible()&&!d){return true;}g=g===undefined?true:g;var e=false;for(var c in this._childControls){if(this._childControls.hasOwnProperty(c)){var f=this._childControls[c];if(f&&f.validate&&!f.validate(false)){e=true;}}}if(g&&e&&this.isVisible()&&this._container.parents(".ws-hidden").length===0&&this.getZIndex()===$ws.single.WindowManager.getMaxZWindow().getZIndex()){this._moveFailValidatedToFocus();}return !e;},_moveFailValidatedToFocus:function(){var k=true,e=-1,h=-1,d,c=Object.keys(this._childControls),m=this,j,l;c.sort(function(o,n){var i=m._childControls[o]&&m._childControls[o].getTabindex(),p=m._childControls[n]&&m._childControls[n].getTabindex();i=parseInt(i,10);p=parseInt(p,10);if(!i||i==-1){return 1;}if(!p||p==-1){return -1;}return((i<p)?-1:(i>p)?1:0);});for(var g=0;g<c.length;++g){var f=this._childControls[c[g]];if(!f){continue;}d=f.getTabindex();j=f._container&&f._container.hasClass("ws-validation-error");l=f._moveFailValidatedToFocus&&!f._moveFailValidatedToFocus();if(j||l){k=false;e=d;h=c[g];break;}}if(j){this._childControls[h].setActive(true);}return k;},getToolBarCount:function(c){return this._toolbarCount[c];},increaseToolBarCount:function(c){++this._toolbarCount[c];},setEnabled:function(d){d=!!d;if(this._options.allowChangeEnable||d===this._options.enable){$ws.proto.AreaAbstract.superclass.setEnabled.apply(this,arguments);for(var e=0,c=this._childControls.length;e<c;++e){if(this._childControls[e]&&this._childControls[e].setEnabled){this._childControls[e].setEnabled(d);}}}},_calcMinHeight:function(){return(this._resizer)?this._resizer.height():Math.max(this._options.minHeight,this._getResizerHeight())||0;},_calcMinWidth:function(){return(this._resizer)?this._resizer.width():Math.max(this._options.minWidth,this._getResizerWidth())||0;},_needResizer:function(){return !this._options.isRelativeTemplate;},_initResizers:function(){if(this._needResizer()){if(this._options.autoHeight){this._container.height("auto");this._container.removeClass("ws-area-height-100-fix");}if(this._options.autoWidth){this._container.width("auto");}if(this._resizer){this._resizer.remove();this._resizer=null;}if(this._options.autoHeight||this._options.autoWidth||!this.parent){this._resizer=$('<div class="r">').attr("id","resizer-"+this.getId());this._container.prepend(this._resizer);this._updateResizer();}}},getResizer:function(){return this._resizer;},_haveAutoSize:function(){return this._options.autoHeight||this._options.autoWidth;},_onResizeHandlerBatch:function(){this._onResizeHandler(null,this);if($.dtPostFilter){$.dtPostFilter({dom:this._container});}},_onSizeChangedBatch:function(c){$ws.helpers.forEach(c,function(d){if(d._isContainerInsideParent()){this._childsSizes[d.getId()]=d.getMinSize();}},this);if(this._resizer){this._updateResizer();}else{this._initResizers();}return true;},_getResizerHeight:function(){var c=!this._options.autoHeight,f=0,e;if(!c||(c&&!this.getParent())){for(var d in this._childsMapId){if(!this._childsMapId.hasOwnProperty(d)){continue;}var g=this._childControls[this._childsMapId[d]];if(g&&g._isContainerInsideParent()){if(this._childsSizes[d]!==undefined){this._childsSizes[d].minHeight=g.getMinHeight();}else{this._childsSizes[d]=g.getMinSize();}}}for(var j in this._childsSizes){if(!this._childsSizes.hasOwnProperty(j)){continue;}if(this._childsSizes[j].minHeight>f){f=this._childsSizes[j].minHeight;}}e=$ws.helpers.getNonControlSize(this._childNonControls,"Height");if(e>f){f=e;}}if(c&&this.getParent()){f=this._container.height();}return f;},_getResizerWidth:function(){var c=!this._options.autoWidth,e=0,d;if(!c||(c&&!this.getParent())){for(var f in this._childsSizes){if(!this._childsSizes.hasOwnProperty(f)){continue;}if(this._childsSizes[f].minWidth>e){e=this._childsSizes[f].minWidth;}}d=$ws.helpers.getNonControlSize(this._childNonControls,"Width");if(d>e){e=d;}}if(c&&this.getParent()){e=this._container.width();}return e;},_updateResizer:function(){if(this._needResizer()){var f=parseInt(this._options.minHeight,10),e=parseInt(this._options.minWidth,10),d=this._getResizerHeight(),c=this._getResizerWidth();this._resizer.height(d).width(c);if(this._options.autoWidth&&(!this._parent||(SBIS3.CORE.Window&&this instanceof SBIS3.CORE.Window))){this._container.css("min-width",(c>e)?c:e);}if(SBIS3.CORE.Window&&this instanceof SBIS3.CORE.Window){if(this._options.autoHeight){this._container.css("min-height",(d>f)?d:f);}}else{if(!this._parent){this._container.css("min-height",(d>f)?d:f);}}}else{if(this._resizer){this._resizer.remove();this._resizer=null;}}},getActivationIndex:function(){return this._activationIndex;},getOpener:function(){return this._opener;},canAcceptFocus:function(){if(this.isVisible()){for(var c=0;c<this._childControls.length;++c){if(this._childControls[c]&&this._childControls[c].canAcceptFocus()){return true;}}}return false;}});return $ws.proto.AreaAbstract;});