$ws.declareModule({namespace:"SBIS3.CORE",name:"TemplatedAreaAbstract",imports:["SBIS3.CORE.AreaAbstract"]},function(a){$ws.proto.TemplatedAreaAbstract=a.extend({$protected:{_needOptionsOverrideData:true,_width:"300px",_height:"100px",_title:undefined,_isPage:false,_currentTemplateInstance:null,_doGridCalculation:false,_isReady:false,_options:{minWidth:0,minHeight:0,origWidth:0,origHeight:0,template:"",page:false,currentTemplate:"",node:undefined,keepSize:true,isRelativeTemplate:false,children:[],functions:[]},_templateOverridenOptions:{},_defaultSize:null,_defaultTpl:null},$constructor:function(){this._defaultSize={autoHeight:this._options.autoHeight,autoWidth:this._options.autoWidth,verticalAlignment:this._verticalAlignment,horizontalAlignment:this._horizontalAlignment,_width:this._options.autoWidth?"auto":this._container.width(),_height:this._options.autoHeight?"auto":this._container.height()};this._prepareElements();if(this._options.template){this._defaultTpl=this._options.template;}this._publish("onBeforeShow","onAfterShow","onBeforeLoad","onAfterLoad","onBeforeControlsLoad","onBatchFinished");var d=["width","height","title"];for(var c=0,b=d.length;c<b;c++){var e=d[c];if(this._options[e]){this["_"+e]=this._options[e];}}if(this._width===""){this._width=this._options.autoWidth?"auto":this._container.width();}if(this._height===""){this._height=this._options.autoHeight?"auto":this._container.height();}},_prepareElements:function(){this._title=$("<span>Загрузка...</span>");},init:function(){if(!this._options.template){if(this._options.currentTemplate){this._runInBatchUpdate("TemplatedAreaAbstract - init",function(){return this._loadDescendents().addCallback($ws.helpers.proxy(this._childrenLoadCallback,this));});}else{this._childrenLoadCallback();}}$ws.proto.TemplatedAreaAbstract.superclass.init.apply(this,arguments);},_childrenLoadCallback:function(){this._notify("onBeforeShow");this._notifyBatchDelayed("onAfterShow");},_appendLoadingIndicator:function(){this._container.prepend(['<div class="ws-loading-indicator-outer">','<div class="ws-area-service ws-loading-indicator-block">','<div class="ws-loading-indicator">'+($ws._const.theme==="wi_scheme"?"":"Загрузка")+"</div>","</div>","</div>"].join(""));},_createTitleButtons:function(){},_makeLoadErrorHandler:function(b){return $.proxy(function(g){try{var f=g.message;if(g instanceof HTTPError){f+=", "+g.url;}$ws.single.ioc.resolve("ILogger").error("TemplatedAreaAbstract","Ошибка при загрузке шаблона ("+f+")");this._createTitleButtons();this._container.find(".ws-loading-indicator-outer").remove().end().append('<div class="ws-area-service"><p>Ошибка при попытке загрузки ресурса. </p><p>Описание ошибки: '+g.message+"</p></div>");}catch(d){BOOMR.plugins.WS.reportError(d);}finally{try{var c=new $ws.proto.Deferred();c.errback(g);b.push(c);b.done();}catch(d){BOOMR.plugins.WS.reportError(d);}}return g;},this);},_createChildrenLoadCallback:function(){var d=new $ws.proto.ParallelDeferred(),c=this,b=c._dChildReady.getResult().addCallback($.proxy(c._templateInnerCallback,c)).createDependent();d.getResult().addCallback(function(){c._dChildReady.done();return b;});return d;},_showControls:function(){this._notify("onAfterLoad");},_getControlsToBuild:function(b,c){return this._options.children.length?this._options.children:b.getControls(c);},_loadControls:function(c,b,d){return this._runInBatchUpdate("_loadControls",function(){this._notify("onBeforeControlsLoad");var g=1,f=this,e=this._getControlsToBuild(b,d);$ws.helpers.forEach(e,function(k){var l=k.type,j=k.id,h=$.extend(true,{},k);var i=BOOMR.plugins.WS.startSpan("+inst:"+h.type);h.element=$("#"+j,f._container[0]);h.parent=f;h.linkedContext=f._context;h.currentTemplate=b;h.zIndex=h.zIndex!==undefined?h.zIndex:g++;c.push($ws.core.attachInstance(l,h).addCallback(function(m){i.stop();if(m instanceof a){f._dChildReady.push(m.getReadyDeferred());}var n=m.getAlignment();if(n.horizontalAlignment!="Stretch"||n.verticalAlignment!="Stretch"){f._doGridCalculation=true;}return m;}).addErrback(function(n){i.stop();var m="Control "+l+"@"+j+" is not instantiated properly. Error: "+n.message;$ws.single.ioc.resolve("ILogger").error("TemplatedAreaAbstract",m);return n;}));});return c;}).done();},_loadDescendents:function(){return this._runInBatchUpdate("_loadDescendents",function(){var c=this,d=this._createChildrenLoadCallback(),b=this._makeLoadErrorHandler(d);this._notify("onBeforeLoad");$ws.core.attachComponent("Source").addCallbacks(function(){var e=c._options.currentTemplate;c._container.css({"min-width":"","min-height":"","max-width":"","max-height":""});e.getRenderResult().addCallbacks(function(){c._isPage=e.isPage();c._loadControls(d,e,c.getId());},b);},b);return d.getResult().createDependent();});},_setTemplateDimensions:function(b){this._width=b.width;this._height=(this._isPage&&!this._parent)?"100%":b.height;if((this._options.page||b.height=="100%")&&!this._options.autoHeight){this._container.addClass("ws-area-height-100-fix");if(navigator.userAgent.indexOf("MSIE 7")!=-1){this._height="";}}},_setMinMaxSizes:function(){this._container.css({"min-width":this._options.minWidth,"min-height":this._options.minHeight,"max-width":this._options.maxWidth==Infinity?"":this._options.maxWidth,"max-height":this._options.maxHeight==Infinity?"":this._options.maxHeight});},_restoreTemplateOverridenOptions:function(){$ws.helpers.forEach(this._templateOverridenOptions,function(b,c){this._options[c]=b;},this);this._templateOverridenOptions={};},_loadTemplate:function(b){return this._runInBatchUpdate("_loadTemplate "+b,function(){this._isReady=false;b=b||this._options.template;var e=(typeof b=="string"?b:(b.getName?b.getName():(b instanceof $ws.proto.Deferred?"Deferred":"DOM"))),f=BOOMR.plugins.WS.startSpan("ldTmpl:"+e),d=this,g=this._createChildrenLoadCallback(),c=this._makeLoadErrorHandler(g),h=function(i){d._currentTemplateInstance=i;i.getRenderResult().addCallbacks(function(){function l(u,t,v){if(this._isOptionDefault(v)){u[v]=t;}return u;}function n(u,t,v){u[v]=this._options[v];return u;}if(d._isDestroyed){g.getResult().errback();return;}var o=i.getDeclaredHandlers(),s=i.getConfig();if(s.resizeable!==undefined){s.resizable=s.resizeable;delete s.resizeable;}var r=d._hasOverridenOptions()?$ws.helpers.reduce(s,l,{},d):s,m=i.getStyle();d._restoreTemplateOverridenOptions();d._templateOverridenOptions=$ws.helpers.reduce(r,n,{},d);if(!d._options.name||d._options.name===""){d._options.name=r.windowName;}d._options.autoHeight=d._defaultSize.autoHeight;d._options.autoWidth=d._defaultSize.autoWidth;d._container.width("").height("").css({"min-width":"","min-height":"","max-width":"","max-height":""});d._options=$ws.core.merge(d._options,r);if(SBIS3.CORE.Window&&d instanceof SBIS3.CORE.Window){d._options.minWidth=Math.max(d._options.minWidth,100);}var k=i.getDimensions();if(d._options.keepSize){if(d._horizontalAlignment!=="Stretch"){d._container.css({width:d._options.autoWidth?"auto":k.width});}else{d._options.autoWidth=d._options.autoWidth||d._defaultSize.autoWidth;}if(d._verticalAlignment!=="Stretch"){d._container.css({height:d._options.autoHeight?"auto":k.height});}else{d._options.autoHeight=d._options.autoHeight||d._defaultSize.autoHeight;}}else{d._options.autoHeight=d._defaultSize.autoHeight;d._options.autoWidth=d._defaultSize.autoWidth;d._options.maxWidth=Infinity;d._options.minWidth=0;d._options.maxHeight=Infinity;d._options.minHeight=0;}d._initSizeOptions();d._setMinMaxSizes();d._isPage=i.isPage();d._createTitleButtons();for(var p in o){if(o.hasOwnProperty(p)){if(p in d._events){d.subscribe(p,o[p]);}else{d._handlers[p]=d._handlers[p]||[];Array.prototype.push.apply(d._handlers[p],o[p]);}}}var j=(d._container.attr("style")||"").replace(/background-color:.+?;/ig,""),q=m.replace(/background-color:#.+?;/ig,"");d._title.html($ws.helpers.escapeHtml(i.getTitle()||"")).attr("style",q);d._container.attr("style",j+";"+m);if(!d._hasMarkup()){i.createMarkup(d._container);}d._setTemplateDimensions(i.getDimensions());d._loadControls(g,i);},c).addErrback(c);return i;};this._container.attr("templatename",e);this._notify("onBeforeLoad");$ws.core.attachComponent("Source").addCallbacks(function(){if(typeof(b)==="string"||!b){var i=(b==d._defaultTpl&&d._hasMarkup())?String.trim(d.getContainer()[0].outerHTML):undefined;$ws.core.attachTemplate(b,$ws._const.fasttemplate,i).addCallbacks(h,c);}else{if(b instanceof $ws.proto.Deferred){b.addCallback(function(j){d._options.template=j.getName();return j;}).addCallbacks(h,c);}else{if(b instanceof $ws.proto.Template){h(b);}else{h(new $ws.proto.Template({templateXML:b}));}}}},c);return g.getResult().addBoth(function(i){f.stop();return i;}).createDependent();});},_templateInnerCallback:function(){this._isReady=true;$ws.helpers.forEach(this._childsMapId,function(b,d){var c=this._childControls[b];if(c&&c._isContainerInsideParent()){this._childsSizes[d]=c.getMinSize();}},this);this._initResizers();this._container.scrollTop(0);this._container.scrollLeft(0);this._notifyOnSizeChanged(this,this);this._notify("onReady");this._showControls();},isReady:function(){return this._isReady;},isAllReady:function(){var b=this.getChildControls();for(var c=0;c<b.length;++c){if(b[c].isReady&&!b[c].isReady()){return false;}}return true;},isPage:function(){return this._isPage;},_onResizeHandler:function(){$ws.proto.TemplatedAreaAbstract.superclass._onResizeHandler.apply(this,arguments);if(this._needResizer()){if(!this._resizer){this._initResizers();}else{this._updateResizer();}}},destroy:function(){this._currentTemplateInstance=null;$ws.proto.TemplatedAreaAbstract.superclass.destroy.apply(this,arguments);}});return $ws.proto.TemplatedAreaAbstract;});