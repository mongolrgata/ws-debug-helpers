$ws.declareModule({namespace:"SBIS3.CORE",name:"ToolBar",imports:["SBIS3.CORE.AreaAbstract"]},function(a){$ws._const.Toolbar={size:28,padding:3,menuOffset:{left:8,top:8},iconSize:"16px"};$ws.proto.ToolBar=a.extend({$protected:{_menuReady:undefined,_buttonsCounter:0,_separators:[],_menu:undefined,_toolbarBlock:undefined,_buttonsHeight:0,_options:{btnCfg:[],subBtnCfg:[],buttonsSide:"left",position:"top"}},$constructor:function(d){this._menuReady=new $ws.proto.Deferred();var g=this.getParent(),f=this._options.position,b=this.isVertical(f),c={};this._publish("onBeforeLoad","onAfterLoad","onActivate","onButtonAdded");var h=["top","right","bottom","left"];for(var e=0;e<4;++e){c[h[e]]=g?g.getToolBarCount(h[e]):0;if(b!=this.isVertical(h[e])){this._container.css(h[e],($ws._const.Toolbar.size*c[h[e]])+"px");}}if(g){this._container.appendTo(g.getContainer());}this._container.css(f,($ws._const.Toolbar.size*c[f])+"px");if(g){g.increaseToolBarCount(f);}this._container.addClass("ws-toolbar "+f).removeClass("ws-area");this._toolbarBlock=$('<div class="ws-toolbar-block"></div>').appendTo(this._container);if(this._options.position==="top"||this._options.position==="bottom"){this._toolbarBlock.css(this._options.buttonsSide,"0");}if(!d.buttons||!(d.buttons instanceof Array)){d.buttons=[];}this._buttonsCounter=d.buttons.length;if(this._options.subBtnCfg.length){this._addMenuButton(d.buttons);}this._buildMenu();this._notify("onBeforeLoad");this._draw(d.buttons);},isVertical:function(b){return b=="left"||b=="right";},_draw:function(g){this._buttonsHeight=$ws._const.Toolbar.padding;var c=this;this._dChildReady.push(this._menuReady);for(var e=0,b=g.length;e<b;e++){if(Object.isEmpty(g[e])){this.addSeparator();}else{var f=this.getId()+"-"+this._getButtonId(g[e],e),d=$.extend({},this._options.btnCfg,g[e],{element:f,parent:this,textAlign:"left",renderStyle:"asLink"});d.width="auto";this._toolbarBlock.append($('<div id="'+f+'"></div>'));this._dChildReady.push(this._drawButton(d));}}this._dChildReady.done().getResult().addCallback(function(){c._notify("onAfterLoad");c._notify("onReady");if(c._options.subBtnCfg.length){c.getButton("menu").getContainer().mousedown(function(h){h.stopPropagation();h.preventDefault();});}});},_getButtonId:function(b,c){if(b.id){return b.id;}if(b.name){return b.name;}return c;},_addMenuButton:function(c){var b=this;c.push({tooltip:"Открыть меню с дополнительными командами",img:$ws._const.wsRoot+($ws._const.theme?"img/themes/"+$ws._const.theme:"img")+"/toolbar/menu.png",name:"menu",handlers:{onActivated:$.proxy(b._showMenu,b)}});},_showMenu:function(){if(!this._menu){this._buildMenu();}else{var c;if(document.createEvent){c=document.createEvent("HTMLEvents");}else{if(document.createEventObject){c=document.createEventObject();}}var b=this.getChildControlByName("menu").getContainer(),d=b.offset();c.clientX=d.left+$ws._const.Toolbar.menuOffset.left;c.clientY=d.top+$ws._const.Toolbar.menuOffset.top+b.height();if(this._menu){this._menu.show(c);}else{this._menuReady.addCallback(function(e){e.show(c);return e;});}}},_buildMenu:function(){var f=[],d=this;for(var e=0,b=this._options.subBtnCfg.length;e<b;++e){var c=this._options.subBtnCfg[e],g={caption:c.caption?c.caption:c.tooltip,imgSrc:c.img,id:this._getButtonId(c,e),renderStyle:c.renderStyle};if(c.handlers&&c.handlers.onActivated){g.handlers={onActivated:c.handlers.onActivated};}f.push(g);}$ws.core.attachInstance("Control/Menu",{id:this.getId()+"-menuControl",data:f,handlers:{onReady:function(){d._menuReady.callback(d._menu=this);}}});},getMenu:function(){return this._menu;},getMenuReady:function(){return this._menuReady;},_drawButton:function(c){var b=this;return $ws.core.attachInstance(c.wsClassName||"Control/Button",c).addCallback(function(d){d.getContainer().addClass("ws-item-toolbar");if(b.isVertical(b._options.position)){var e=d.getContainer(),i=e.height(),f=e.width();if(i%2===1){e.height(++i);}if(f%2===1){e.width(++f);}e.addClass("ws-rotate-"+b._options.position);if($.browser.msie){e.css({top:b._buttonsHeight+"px",left:$ws._const.Toolbar.padding});}else{var h=Math.round(b._buttonsHeight+f/2-i/2),g=Math.round($ws._const.Toolbar.padding+i/2-f/2);if(Math.abs(h)%2!==0){++h;}if(Math.abs(g)%2!==0){++g;}e.css({top:h,left:g});}b._buttonsHeight+=f;}if(!b.isEnabled()){d.setEnabled(false);}b._notify("onButtonAdded",d);return d;});},_insertBlock:function(f,b){var c=(typeof(b)==="string"),e=this._toolbarBlock.children(),d;if(!b&&b!==0||!c&&!e[b]||c&&!this.hasChildControlByName(b)){if(this._childsMapName.menu!==undefined){d=this.getButton("menu").getContainer();}else{f.appendTo(this._toolbarBlock);return;}}else{d=(c?this.getButton(b).getContainer():e[b]);}f.insertBefore(d);},insertButton:function(d,b){var e=this._buttonsCounter++,f=this.getId()+"-"+this._getButtonId(d,e),c=$.extend({},this._options.btnCfg,d,{element:f,parent:this,textAlign:"left",renderStyle:"asLink"}),g=$('<div id="'+f+'"></div>');this._insertBlock(g,b);return this._drawButton(c);},hasButton:function(b){return this._childsMapId[this.getId()+"-"+b]!==undefined;},addButton:function(b){return this.insertButton(b,-1);},insertSeparator:function(c){var e=$('<div class="ws-toolbar-separator"></div>'),b=this.isVertical(this._options.position),d=this._options.btnCfg.height?parseInt(this._options.btnCfg.height,10)-2+"px":"18px";this._insertBlock(e,c);e.css({height:b?"1px":d,margin:this._options.btnCfg.margin,width:b?d:"1px"});e.addClass(b?"vertical":"horizontal");if(b){e.css({top:(this._buttonsHeight+2)+"px",left:$ws._const.Toolbar.padding+"px"});this._buttonsHeight+=6;}this._separators.push(e);},addSeparator:function(){this.insertSeparator(-1);},getButton:function(b){return this.getChildControlByName(b);},getSeparator:function(b){return this._separators[b];},clear:function(){var c,b;for(c=0,b=this._separators.length;c<b;++c){this._separators[c].empty().remove();}this._separators=[];for(c=0,b=this._childControls.length;c<b;++c){if(this._childControls[c]&&this._childControls[c].destroy){this._childControls[c].destroy();}this._childControls[c]=null;}this._childControls=[];},setEnabled:function(c){c=!!c;if(this._options.allowChangeEnable||c===this._options.enable){$ws.proto.ToolBar.superclass.setEnabled.apply(this,arguments);for(var d=0,b=this._childControls.length;d<b;++d){if(this._childControls[d]&&this._childControls[d].setEnabled){this._childControls[d].setEnabled(c);}}}},destroy:function(){this.clear();if(this._menu instanceof $ws.proto.Menu){this._menu.destroy();}$ws.proto.ToolBar.superclass.destroy.apply(this,arguments);},deleteButton:function(b){var c=this._childControls[this._childsMapName[b]],d;if(!c){d=this.getId()+"-"+b;}else{d=c.getId();}if(c||this._childsMapId[d]){this.destroyChild(d);return true;}return false;},_redraw:function(){}});return $ws.proto.ToolBar;});