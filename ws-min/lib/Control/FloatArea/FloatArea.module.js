$ws.declareModule({namespace:"SBIS3.CORE",name:"FloatArea",imports:["SBIS3.CORE.TemplatedAreaAbstract"]},function(a){$ws._const.FloatArea={animationLength:150,minAnimation:50,overflowBonusWidth:14,overflowBonusHeight:14,contentBorder:1,defaultSize:200,hoverTimeout:1000,showDelay:300};$ws.proto.FloatArea=a.extend({$protected:{_options:{target:"",side:"left",width:0,height:0,animation:"slide",autoHide:true,verticalAlign:"top",direction:"",animationLength:$ws._const.FloatArea.animationLength,startWidth:0,startHeight:0,offset:{x:0,y:0},fixed:false,autoShow:true,catchFocus:true,hoverTarget:undefined,showDelay:undefined,fitWindow:false,fullShadow:false},_horizontalAlignment:"Left",_verticalAlignment:"Top",_loaded:false,_loadStarted:false,_closeButton:undefined,_overflow:undefined,_loading:undefined,_area:undefined,_state:"",_visible:false,_animationStartTime:undefined,_collapsedSides:{},_containerShadow:undefined,_hoverTimer:undefined,_locksShowed:0,_showTimer:undefined,_keysWeHandle:[$ws._const.key.tab,$ws._const.key.enter,$ws._const.key.esc],_isModal:false,_zIndex:0,_cachedOffset:{},_cachedSize:{}},$constructor:function(){this._publishEvents();this._declareCommands();this._resizeAreas();this._zIndex=$ws.single.WindowManager.acquireZIndex(this._isModal);},_needRecalkInvisible:function(){return true;},_resizeAreas:function(){this.subscribe("onReady",function(){if(this._options.autoHeight||this._options.autoWidth){this._updateSize();}else{this._setSize({width:this._width==="auto"?this._options.width:parseInt(this._width,10),height:this._height==="auto"?this._options.height:parseInt(this._height,10)});}this._recalcPosition();});},_publishEvents:function(){this._publish("onClose","onBeforeClose","onAfterClose");},_declareCommands:function(){$ws.single.CommandDispatcher.declareCommand(this,"show",this.show);$ws.single.CommandDispatcher.declareCommand(this,"hide",this.hide);$ws.single.CommandDispatcher.declareCommand(this,"close",this.hide);},_prepareSideOptions:function(){if(this._options.side!=="left"&&this._options.side!=="right"&&this._options.side!=="center"){this._options.side="left";$ws.single.ioc.resolve("ILogger").error("FloatArea","Incorrect _options.side");}if(this._options.verticalAlign!=="top"&&this._options.verticalAlign!=="bottom"&&this._options.verticalAlign!=="middle"){this._options.verticalAlign="top";$ws.single.ioc.resolve("ILogger").error("FloatArea","Incorrect _options.verticalAlign");}if(this._options.animation!=="slide"&&this._options.animation!=="fade"){this._options.animation="slide";$ws.single.ioc.resolve("ILogger").error("FloatArea","Incorrect _options.animation");}},_checkDirectionLegalValues:function(){if(this._options.direction!==""&&this._options.direction!=="left"&&this._options.direction!=="right"&&this._options.direction!=="top"&&this._options.direction!=="bottom"){this._options.direction="";$ws.single.ioc.resolve("ILogger").error("FloatArea","Incorrect direction");}},_checkAutoDirection:function(){if(this._options.direction===""){if(this._options.side==="left"){this._options.direction="right";}else{if(this._options.side==="right"){this._options.direction="left";}else{if(this._options.verticalAlign==="top"){this._options.direction="bottom";}else{if(this._options.verticalAlign==="bottom"){this._options.direction="top";}else{this._options.direction="left";if(this._options.animation==="slide"){$ws.single.ioc.resolve("ILogger").error("FloatArea","Unspecified direction");}}}}}}},_prepareDirectionOptions:function(){this._checkDirectionLegalValues();this._checkAutoDirection();},_prepareCollapsedSides:function(){if(this._options.hoverTarget||this._options.fullShadow){this._collapsedSides={left:false,right:false,top:false,bottom:false};}else{this._collapsedSides={left:(this._options.side==="left"&&this._options.direction!=="left")||(this._options.side==="right"&&this._options.direction==="right"),right:(this._options.side==="right"&&this._options.direction!=="right")||(this._options.side==="left"&&this._options.direction==="left"),top:(this._options.verticalAlign==="top"&&this._options.direction!=="top")||(this._options.verticalAlign==="bottom"&&this._options.direction==="bottom"),bottom:(this._options.verticalAlign==="bottom"&&this._options.direction!=="bottom")||(this._options.verticalAlign==="top"&&this._options.direction==="top")};}},_prepareGeneralOptions:function(){this._options.width=parseInt(this._options.width,10);if(isNaN(this._options.width)){this._options.width=$ws._const.FloatArea.defaultSize;}this._width=this._options.width;this._options.height=parseInt(this._options.height,10);if(isNaN(this._options.height)){this._options.height=$ws._const.FloatArea.defaultSize;}this._height=this._options.height;this._area=this._options.target;if(this._options.showDelay===undefined){if(this._options.hoverTarget){this._options.showDelay=$ws._const.FloatArea.showDelay;}else{this._options.showDelay=0;}}},_prepareOptions:function(){this._prepareSideOptions();this._prepareDirectionOptions();this._prepareCollapsedSides();this._prepareGeneralOptions();},_getBorderSize:function(){return $ws._const.FloatArea.contentBorder;},_getBonusWidth:function(){return(+!this._collapsedSides.left+!this._collapsedSides.right)*($ws._const.FloatArea.overflowBonusWidth+this._getBorderSize());},_getBonusHeight:function(){return(+!this._collapsedSides.top+!this._collapsedSides.bottom)*($ws._const.FloatArea.overflowBonusHeight+this._getBorderSize());},_prepareElements:function(){$ws.proto.FloatArea.superclass._prepareElements.apply(this,arguments);this._prepareOptions();this._prepareArea();this._prepareCloseButton();this._prepareHover();},_addContainerClasses:function(){this._containerShadow.addClass("standart");},_prepareArea:function(){var c="";for(var b in this._collapsedSides){if(this._collapsedSides.hasOwnProperty(b)&&!this._collapsedSides[b]){c+="offset-"+b+" ";}}this._container=$('<div class="ws-area ws-float-area-inner"></div>').width(this._options.width).height(this._options.height).addClass(this._options.className);this._containerShadow=$('<div class="ws-float-area '+c+'"></div>').width(this._options.width).height(this._options.height).append(this._container);this._addContainerClasses();this._initKeyboardMonitor();this._overflow=$('<div class="ws-float-overflow ws-hidden ws-area'+(this._options.fixed?" ws-float-area-fixed":"")+'"></div>').width(this._options.width+this._getBonusWidth()).height(this._options.height+this._getBonusHeight()).append(this._containerShadow).appendTo("body");},_prepareCloseButton:function(){var b=this;this._closeButton=$('<div class="ws-float-close-block '+(!this._collapsedSides.right?"right-offset":"")+" "+(!this._collapsedSides.top?"top-offset":"")+' "></div>');this._closeButton.bind("click",function(){b.hide();}).attr("title","Закрыть панель").appendTo(this._overflow);},_stopHoverTimer:function(){if(this._hoverTimer){clearTimeout(this._hoverTimer);this._hoverTimer=undefined;}},_startHoverTimer:function(){this._stopHoverTimer();this._stopShowTimer();this._hoverTimer=setTimeout(function(){if(this._locksShowed===0){this.hide();}}.bind(this),$ws._const.FloatArea.hoverTimeout);},_elementMouseOver:function(){this._stopHoverTimer();this.show();},_childWindowOpen:function(c,b){this.lockShowed();b.subscribe("onBeforeClose",this.unlockShowed.bind(this));},_bindHoverEvents:function(){$(this._options.hoverTarget).bind("mouseenter.wsFloatAreaHover",this._elementMouseOver.bind(this)).bind("mouseleave.wsFloatAreaHover",this._startHoverTimer.bind(this));},_prepareHover:function(){this._overflow.bind("wsWindowOpen",this._childWindowOpen.bind(this));if(this._options.hoverTarget){this._bindHoverEvents();this._overflow.hover(this._stopHoverTimer.bind(this),this._startHoverTimer.bind(this)).bind("wsSubWindowOpen",this.lockShowed.bind(this)).bind("wsSubWindowClose",this.unlockShowed.bind(this));}},init:function(){$ws.proto.FloatArea.superclass.init.apply(this,arguments);this._startLoading();this._initAnimation();if(this._options.autoShow){this.show();}},_startLoading:function(){this.subscribe("onAfterLoad",$.proxy(this._onLoad,this));this._loadTemplate();},_addTitleClass:function(){this._container.find('[sbisname="windowTitleContainer"]').addClass("sbisname-window-title-container");this._container.find('[sbisname="windowTitleClose"]').addClass("sbisname-window-title-close");},_onLoad:function(){this._addTitleClass();this._loaded=true;if(this.isOpened()){this._notify("onBeforeShow");}if(this._visible&&this._state===""){if(this._options.catchFocus){this.activateFirstControl();}this._notifyBatchDelayed("onAfterShow");}if(!this._options.border&&this._closeButton){this._closeButton.remove();}},_initAnimation:function(){if(this._options.animation==="slide"){if(this._options.direction==="left"||this._options.direction==="right"){this._overflow.width(this._options.startWidth);}else{this._overflow.height(this._options.startHeight);}}else{this._overflow.css({opacity:0});}this._recalcPosition();},_recalcLeftPosition:function(c,b){if(this._options.direction==="left"){b.right=$ws._const.$win.width()-c.left-this._options.offset.x;}else{b.left=c.left+this._options.offset.x;}},_recalcCenterPosition:function(c,b){b.left=c.left+(this._cachedSize.width-this._container.width()-this._getBonusWidth())/2+this._options.offset.x;},_recalcRightPosition:function(c,b){if(this._options.direction==="right"){b.left=c.left+this._cachedSize.width+this._options.offset.x;}else{b.right=$ws._const.$win.width()-c.left-this._cachedSize.width-this._options.offset.x;}},_recalcHorizontalPosition:function(c,b){if(this._options.side==="left"){this._recalcLeftPosition(c,b);}else{if(this._options.side==="right"){this._recalcRightPosition(c,b);}else{if(this._options.side==="center"){this._recalcCenterPosition(c,b);}}}},_recalcTopPosition:function(c,b){if(this._options.direction==="top"){b.bottom=$ws._const.$win.height()-c.top-this._options.offset.y;}else{b.top=c.top+this._options.offset.y;}},_recalcMiddlePosition:function(c,b){b.top=c.top+(this._cachedSize.height-this._container.height()-this._getBonusHeight())/2+this._options.offset.y;},_recalcBottomPosition:function(c,b){if(this._options.direction==="bottom"){b.top=c.top+this._cachedSize.height+this._options.offset.y;}else{b.bottom=$ws._const.$win.height()-c.top-this._cachedSize.height-this._options.offset.y;}},_recalcVerticalPosition:function(c,b){if(this._options.verticalAlign==="top"){this._recalcTopPosition(c,b);}else{if(this._options.verticalAlign==="bottom"){this._recalcBottomPosition(c,b);}else{if(this._options.verticalAlign==="middle"){this._recalcMiddlePosition(c,b);}}}},_validateOffset:function(g){var b=this._width+this._getBonusWidth(),d=this._height+this._getBonusHeight(),f={};if(g.right!==undefined){var c=$ws._const.$win.width();f.left=c-g.right-b;}else{f.left=g.left;}if(g.bottom!==undefined){var h=$ws._const.$win.height();f.top=h-g.bottom-d;}else{f.top=g.top;}var e=$ws.helpers.positionInWindow($ws.core.merge({},f),b,d);if(g.right!==undefined){g.right-=e.left-f.left;}else{g.left+=e.left-f.left;}if(g.bottom!==undefined){g.bottom-=e.top-f.top;}else{g.top+=e.top-f.top;}return g;},_recalcPosition:function(){var d,b={};if(this._area.is(":visible")){this._cachedOffset=d=this._area.offset();this._cachedSize={width:this._area.outerWidth(),height:this._area.outerHeight()};}else{d=this._cachedOffset;}this._recalcHorizontalPosition(d,b);this._recalcVerticalPosition(d,b);if(this._options.hoverTarget||this._options.fitWindow){b=this._validateOffset(b);}if(!this._options.hoverTarget&&this._options.fullShadow){for(var c in b){if(b.hasOwnProperty(c)){if(c==="left"||c==="right"){b[c]-=this._getBonusWidth()/2;}else{b[c]-=this._getBonusHeight()/2;}}}}this._overflow.css(b);},_recalcSize:function(){var b=this._options.autoWidth||this._options.autoHeight,d,c;if(b){if(this._options.autoWidth){this._containerShadow.width("");this._container.width("");}if(this._options.autoHeight){this._containerShadow.height("");this._container.height("");}d=this._containerShadow.hasClass("offset-right");c=this._containerShadow.hasClass("offset-bottom");this._containerShadow.removeClass("offset-right");this._containerShadow.removeClass("offset-bottom");}this._setSize({width:this._container.width(),height:this._container.height()});if(b){if(d){this._containerShadow.addClass("offset-right");}if(c){this._containerShadow.addClass("offset-bottom");}}},_updateSize:function(){if(!this.isOpened()){return;}this._recalcSize();},_onResizeHandler:function(){$ws.proto.FloatArea.superclass._onResizeHandler.apply(this,arguments);this._updateSize();this._recalcPosition();},_notifyOnSizeChanged:function(){},_onSizeChangedBatch:function(){$ws.proto.FloatArea.superclass._onSizeChangedBatch.apply(this,arguments);this._updateSize();},show:function(){this._stopShowTimer();this._showTimer=setTimeout(function(){this._stopAnimation();this._overflow.removeClass("ws-hidden");this._recalcSize();this._startShow();var b=$ws.single.ControlBatchUpdater;if(b._needDelayedRecalk(this)){b._doDelayedRecalk(this);}if(this._loaded){this._notify("onBeforeShow");}this._recalcPosition();this.moveToTop();}.bind(this),this._options.showDelay);return true;},moveToTop:function(){$ws.single.WindowManager.releaseZIndex(this._zIndex);this._zIndex=$ws.single.WindowManager.acquireZIndex(this._isModal);$ws.single.WindowManager.setVisible(this._zIndex);this._overflow.css("z-index",this._zIndex);},getZIndex:function(){return this._zIndex;},hide:function(){if(this._locksShowed===0&&this._state!=="hide"){this._stopAnimation();this._stopShowTimer();if(this._state||this._visible){this._startHide();}return true;}return false;},isVisible:function(){return !this._state&&this._visible;},isShow:function(){return this.isVisible();},isOpened:function(){return(this._visible&&this._state==="")||this._state==="show";},_activateControls:function(){if(this._loaded&&this._options.catchFocus){this.onBringToFront();}},_stopAnimation:function(){if(this._state){this._overflow.stop();}},_stopShowTimer:function(){if(this._showTimer){clearTimeout(this._showTimer);this._showTimer=undefined;}},_startShow:function(){if(this._options.animation==="slide"){this._showSlide();}else{this._showFade();}this._animationStartTime=new Date();this._state="show";$ws.single.WindowManager.setVisible(this._zIndex);},_showSlideAnimate:function(f){var c,e,d={width:this._width+this._getBonusWidth(),height:this._height+this._getBonusHeight()},b={};this._overflow.stop();if(this._options.direction==="left"||this._options.direction==="right"){c="width";e="height";}else{c="height";e="width";}b[c]=d[c];this._overflow.css(e,d[e]).animate(b,Math.max(f,$ws._const.FloatArea.minAnimation),this._finishShow.bind(this));},_showSlide:function(){this._showSlideAnimate(this._options.animationLength);},_showFade:function(){this._overflow.fadeTo(this._options.animationLength,1,this._finishShow.bind(this));},_restartShowSlide:function(){var b=this._options.animationLength+(this._animationStartTime-new Date());this._showSlideAnimate(b);},_finishShow:function(){this._state="";this._visible=true;this._activateControls();if(this._loaded){this._notifyBatchDelayed("onAfterShow");}var b=$ws.single.ControlBatchUpdater;if(b._needDelayedRecalk(this)){b._doDelayedRecalk(this);}},_startHide:function(){this._notify("onBeforeClose");if(this._options.animation==="slide"){this._hideSlide();}else{this._hideFade();}this._state="hide";this._notify("onClose");},_hideSlide:function(){var b={};if(this._options.direction==="left"||this._options.direction==="right"){b.width=this._options.startWidth;}else{b.height=this._options.startHeight;}this._overflow.animate(b,this._options.animationLength,$.proxy(this._finishHide,this));},_hideFade:function(){this._overflow.fadeTo(this._options.animationLength,0,$.proxy(this._finishHide,this));},_finishHide:function(){this._state="";this._visible=false;this._overflow.addClass("ws-hidden");$ws.single.WindowManager.activateControl();$ws.single.WindowManager.setHidden(this._zIndex);this._notify("onAfterClose");},canAcceptFocus:function(){return this._visible;},_isAcceptKeyEvents:function(){return true;},_keyboardHover:function(b){if(b.which===$ws._const.key.esc){b.stopPropagation();this.hide();return false;}return $ws.proto.FloatArea.superclass._keyboardHover.apply(this,arguments);},_childrenLoadCallback:function(){},destroy:function(){$ws.proto.FloatArea.superclass.destroy.apply(this,arguments);$ws.single.WindowManager.releaseZIndex(this._zIndex);this._overflow.remove();},isAutoHide:function(){return this._options.autoHide;},_setSize:function(b){this._width=b.width;this._height=b.height;this._container.css({width:this._width,height:this._height});this._containerShadow.css({width:this._width,height:this._height});if((!this._state&&this._visible)||this._options.animation==="fade"){this._overflow.css({width:this._width+this._getBonusWidth(),height:this._height+this._getBonusHeight()});}else{if(this._state==="show"){this._restartShowSlide();}}},_calculatePositionHorisontal:function(){},_calculatePositionVertical:function(){},isCorrect:function(){return !!this._events;},toggle:function(){if(this._state=="show"||this._visible){this.hide();}else{this.show();}},setTarget:function(b){this._area=b;this._recalcPosition();},setOffset:function(b){this._options.offset=b;this._recalcPosition();},getTarget:function(){return this._area;},getOffset:function(){return $ws.core.merge({},this._options.offset);},storeActiveChild:function(b){this.setChildActive(b);},getTemplateName:function(){return this._options.template;},lockShowed:function(){++this._locksShowed;},unlockShowed:function(){if(--this._locksShowed===0&&this._hoverTimer){this._startHoverTimer();}},setHoverTarget:function(c,b){if(this._options.hoverTarget){$(this._options.hoverTarget).unbind(".wsFloatAreaHover");}this._options.hoverTarget=c;if(c){this._bindHoverEvents();}if(b){this._stopHoverTimer();}},getHoverTarget:function(){return this._options.hoverTarget;},_redraw:function(){}});return $ws.proto.FloatArea;});