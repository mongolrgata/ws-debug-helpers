$ws.declareModule({namespace:"SBIS3.CORE",name:"HierarchyView",imports:["SBIS3.CORE.HierarchyViewAbstract"]},function(a){$ws.single.DependencyResolver.register("SBIS3.CORE.HierarchyView",[],"SBIS3.CORE.DataViewAbstract/SBIS3.CORE.TableView/SBIS3.CORE.HierarchyViewAbstract");$ws.proto.HierarchyView=a.extend({$protected:{_options:{display:{hierarchyIcons:$ws._const.Browser.hierarchyIcons,folderIcon:$ws._const.Browser.folderIcon,itemIcon:$ws._const.Browser.itemIcon}},_turn:"",_rowTemplates:[undefined,undefined],_selectAfterPathLoad:true},$constructor:function(){this._registerShortcut($ws._const.key.backspace,$ws._const.modifiers.nothing,this._selectParentFolder);this._registerShortcut($ws._const.key.esc,$ws._const.modifiers.nothing,this._selectParentFolder);this._registerShortcut($ws._const.key.v,$ws._const.modifiers.control,this._toggleViewKey);this._publish("onFolderEnter");},_drawBody:function(){var b=this._currentRecordSet.getColumns();if(!Object.isEmpty(b)&&!(this._options.display.titleColumn in b)){throw new Error("Trying to render hierarchy with unexistent titleColumn");}$ws.proto.HierarchyView.superclass._drawBody.apply(this,arguments);},setQuery:function(d,c,f,e){$ws.proto.HierarchyView.superclass.setQuery.apply(this,arguments);var b=this;if(b._pathSelector!==undefined){b._pathReady.addCallback(function(){b._pathSelector.setQuery(d);});}},_forcedHideArea:function(){var b=this._isRecordFloatAreaOpen.getRecord();return(b.hasColumn(this._hierColumnParentId)&&(b.get(this._hierColumnParentId)!=this._currentRootId));},_drawBodyCycle:function(){var l,c=0,d=0,f=$("<tbody/>"),h="";this._rowsMap={};this._currentRecordSet.rewind();var k=this._body;this._body=f;this._selectedRecords=[];while((l=this._currentRecordSet.next())!==false){if(this._options.selectionType!=="node"||(this._options.selectionType==="node"&&this._testSelectedRecord(l))){if(l.get(this._hierColumnParentId)==this._currentRootId||this._turn!==""){var b=((this._turn===""||this._turn==="Mixed")?0:this._currentRecordSet.getRecordLevel(l.getKey())),p=this._options.display.hasZebra?(d%2):this;h+=this._createTRsHtml(l,b,p,false);++d;++c;}}}if(this._options.display.allowHorizontalScroll){this._emptyDataScroller[d?"hide":"show"]();}this._body.html(h);var o=this._body.children();for(var g=0,j=o.length;g<j;++g){var n=o.eq(g).attr("rowkey");this._rowsMap[n]=o.eq(g);if(this._options.display.rowRender){this._options.display.rowRender.apply(this,[this._currentRecordSet.getRecordByPrimaryKey(n),o.eq(g)]);}}var e=this._body.children().size(),m=f.children().size();if(m>0||(m===0&&e!==0)){this._body.remove();this._body=f;this._data.append(this._body);}this._count=c;k.remove();this._data.append(this._body);},_rowHTMLTemplate:function(b){var c=doT.template('<tr class="{{=it.className}}" rowkey="{{=it.rowkey}}" treelevel="{{=it.level}}" parentId="{{=it.parentId}}">{{? it.useCheckbox}}<td class="{{? it.checkbox}} ws-browser-checkbox-holder {{?}} "><div class="ws-browser-cell-paddings"><div class="ws-browser-cell-container">{{? it.checkbox }} <span class="ws-browser-checkbox"/> {{?}}</div></div></td>{{?}}{{~it.cells :cell:index }}{{ if(index === 0){ out += this._cellFirstTemplate(cell);}else{out += this._cellGeneralTemplate(cell);} }}{{~}}</tr>');this._rowHTMLTemplate=c;return c.call(this,b);},_cellFirstTemplate:function(b){var c=doT.template('<td class="{{=it.cellClassName}}"{{? it.isFolder}}colspan="{{=it.colspan}}"{{?}}{{? it.colDefIndex || "0"}} coldefindex="{{=it.colDefIndex}}"{{?}}><div class="{{=it.containerClassName}}" style="padding-left: {{=it.padding}}px;">{{? it.isHierColumn}}{{? it.folderIconSpan}}<span class="{{=it.folderIconSpan}} {{=it.expanded}}"></span>{{?}}{{?}}<div class="ws-browser-text-container">{{=it.data}}</div></div></td>');this._cellFirstTemplate=c;return c(b);},_cellGeneralTemplate:function(b){var c=doT.template('<td class="{{=it.cellClassName}}"{{? it.isFolder}} colspan="{{=it.colspan}}"{{?}}{{? it.colDefIndex || "0"}} coldefindex="{{=it.colDefIndex}}"{{?}}>{{? it.isHierColumn}}{{? it.folderIconSpan}}<span class="{{=it.folderIconSpan}} {{=it.expanded}}"></span>{{?}}{{?}}<div class="{{=it.containerClassName}}">{{=it.data}}</div></div></td>');this._cellGeneralTemplate=c;return c(b);},_createTRsHtml:function(j,b,n){var l=j.get(this._hierColumnIsLeaf),m=j.getKey(),e=["ws-browser-table-row"],c="ws-visible",h=j.get(this._hierColumnParentId),f={cells:[]},d={};if(typeof m=="string"){m=m.replace(/'/g,"&#039;");}else{if(m===null){m="null";}}if(!n){e.push("rE");}if(this._selected[m]!==undefined){e.push("ws-browser-selected");this._selectedRecords.push(j);}if(l){e.push("ws-browser-tree-branch","ws-browser-folder");d=this._countColspanForFolder();}e.push(c);var g=0,k;f.className=e.join(" ");f.rowkey=m;f.level=b;f.parentId=h===null?"":h;f.useCheckbox=this._options.display.showSelectionCheckbox&&this._options.useSelection!==false;f.checkbox=false;if(this._options.selectionType==="all"||this._options.selectionType==="node"&&l||this._options.selectionType==="leaf"&&!l){f.checkbox=true;}if(!l){for(g=0,k=this._columnMap.length;g<k;++g){f.cells.push(this._cellTemplateOptions(j,b,this._options.editMode,g,l,g));}}else{for(g=0,k=this._columnMap.length;g<k;++g){if((this._titleColumnIndex===-1&&g===0)||g===this._titleColumnIndex){f.cells.push(this._cellTemplateOptions(j,b,this._options.editMode,this._titleColumnIndex,l,d[g],true));}else{if(this._columnMap[g].useForFolder){f.cells.push(this._cellTemplateOptions(j,b,this._options.editMode,g,l,d[g],false));}}}}return this._rowHTMLTemplate.call(this,f);},_countColspanForFolder:function(){var g={},c=false,f=0,e,b=1;for(var d=this._columnMap.length-1;d>=0;d--){if(this._columnMap[d].useForFolder){if(e){g[e]--;g[d]=b;}if(!c){c=true;g[d]=b;f+=b;}else{g[d]=e===undefined?b:1;f+=b;}b=1;}else{if(d===this._titleColumnIndex||(d===0&&this._titleColumnIndex===-1)){g[d]=this._columnMap.length-f;b=1;e=(this._titleColumnIndex!==-1)?d:undefined;}else{b++;}}}return g;},clear:function(){var c=this.getRecordSet();if(c.getRecordCount()!==0){if(this.isHierarchyMode()){this.resetFilter(true);if(this._pathSelector&&this._pathSelector instanceof $ws.proto.PathSelector){this._pathSelector.setPath([]);}if(this._turn){this._clearExpandAll(true);}if(this._expanded){for(var b in this._expanded){if(this._expanded.hasOwnProperty(b)){delete this._expanded[b];}}}if(this._rootNode){this._currentRootId=this._rootNode;}}}$ws.proto.HierarchyView.superclass.clear.apply(this,arguments);},isHierarchy:function(){return true;},_prepareSystemParams:function(b){if(b[this._hierColumnParentId]===undefined){b[this._hierColumnParentId]=this._options.display.partiallyLoad?this._currentRootId:this._rootNode;}return $ws.proto.HierarchyView.superclass._prepareSystemParams.apply(this,arguments);},applyTurn:function(c,b){return this._runInBatchUpdate("HierarchyView.applyTurn",function(){if(this._options.display.fixedExpand){return;}if(this._foot){this._foot.toggleClass("ws-hidden",this._turn==="");}if(c==="mixed"){this._turn="Mixed";this._currentFilter["Разворот"]="С разворотом";if(!b){this.reload();}}else{$ws.proto.HierarchyView.superclass.applyTurn.call(this,c,b);}});},_expandAll:function(c,b){var d=this.getQuery();this._expanded[this._currentRootId]=2;d[this._hierColumnParentId]=this._currentRootId;this._systemParams[this._hierColumnParentId]=this._currentRootId;d["Разворот"]="С разворотом";d.usePages="";this._systemParams["Разворот"]="С разворотом";this._currentFilter["Разворот"]="С разворотом";this._options.dataSource.filterParams["Разворот"]="С разворотом";if(c){this._turn="BranchesAndLeaves";d["ВидДерева"]="С узлами и листьями";this._systemParams["ВидДерева"]="С узлами и листьями";}else{if(this._options.display.expand==="onlyFolders"){this._turn="OnlyFolders";d["ВидДерева"]="Только узлы";this._options.dataSource.filterParams["ВидДерева"]="Только узлы";this._systemParams["ВидДерева"]="Только узлы";}else{this._turn="OnlyLeaves";d["ВидДерева"]="Только листья";this._options.dataSource.filterParams["ВидДерева"]="Только листья";this._systemParams["ВидДерева"]="Только листья";}}if(this._currentRecordSet){this._currentRecordSet.setUsePages("");}if(this._paging){this._paging.setEnabled(false);}if(!b){this._runQuery(d,true);}},_clearExpandAll:function(b){$ws.proto.HierarchyView.superclass._clearExpandAll.apply(this,arguments);this._turn="";},showBranch:function(b,c){if(this._turn!==""){this._clearExpandAll(true);}$ws.proto.HierarchyView.superclass.showBranch.apply(this,arguments);},_onRecordUpdated:function(c,b){if(this._turn!==""&&!this._options.display.fixedExpand){if(this._onRecordUpdatedBegin()){this._clearExpandAll();}}else{$ws.proto.HierarchyView.superclass._onRecordUpdated.apply(this,arguments);}},_expandFromFilter:function(b,c){if(c=="С разворотом"&&this._turn===""){this._expandAll(b["ВидДерева"]=="С узлами и листьями",true);}else{if(c=="Без разворота"){this._clearExpandAll(true);}}},_reloadBody:function(){if(this._turn===""&&this._pathSelector){this._pathSelector.setPath([]);}$ws.proto.HierarchyView.superclass._reloadBody.apply(this,arguments);},_clearAdditionalStates:function(){if(this._pathSelector&&this._pathSelector instanceof $ws.proto.PathSelector){this._pathSelector.setPath([]);}if(this._turn){this._clearExpandAll(true);}if(this._rootNode){this._currentRootId=this._rootNode;}},_onPathSelectorChange:function(b,e){var d=this._options.display.partiallyLoad,c=this._pageSaver[e];this._currentRootId=e;if(this._notify("onFolderEnter",e)!==false){if(d){this._systemParams[this._hierColumnParentId]=e;this._currentRecordSet.loadNode(this._currentRootId,false,c?c:0,false);}else{this._drawBody();}this.setActive(true);}},_clickOnFolder:function(d,c,b){return this._runInBatchUpdate("HierarchyView._clickOnFolder",function(){if(this._turn!==""){this.clearTurn(true);}if(this._pathSelector&&b){this._pathSelector.append({id:c,title:b.get(this._options.display.titleColumn)});}this._currentRootId=c;this._systemParams[this._hierColumnParentId]=c;if(this._notify("onFolderEnter",c)!==false){this._notifyBatchDelayed("onRowActivated",d,b);if(this._options.display.partiallyLoad){this._currentRecordSet.loadNode(c);}else{this._drawBody();this._updatePager();}}});},_selectParentFolder:function(){if(this.isEnabled()){var e=this.getActiveElement(),d=this._hierColumnParentId;if(this._turn!==""||this._currentRootId===this._rootNode){return true;}if(e&&(e.attr("rowkey")==="null"||!e.attr("rowkey"))){return false;}var c=this._currentRootId,b=this._currentRecordSet.getWay();if(this._currentRecordSet.contains(c)){c=this._currentRecordSet.getRecordByPrimaryKey(c).get(d);}else{if(b&&b.contains(c)){c=b.getRecordByPrimaryKey(c).get(d);}else{throw new Error("HierarchyViewAbstract:_keyboardHover backspace error");}}if(this._pathSelector&&!this._pathSelector.isEmpty()){this._pathSelector.pop();}this._hovered=this._currentRootId;this.showBranch(c);this._updatePager();return false;}},_enterKey:function(){var c=this.getActiveElement();if(!c){return false;}if(c.hasClass("ws-browser-folder")){var b=this.getActiveRecord();this._clickOnFolder(c,b.getKey(),b);}else{if(this._turn===""){this._elementActivated(c);}}return true;},_cellTemplateOptions:function(c,i,g,f,d,h,b){if(b&&this._titleColumnIndex==-1){arguments[3]=-1;}var e=$ws.proto.HierarchyView.superclass._cellTemplateOptions.apply(this,arguments);e.expanded=(d?(this._turn!==""?"icon-16 icon-OpenedFolder icon-disabled":"icon-16 icon-Folder icon-disabled"):" ws-browser-icon item");e.isFolder=d;e.isHierColumn=b;e.colspan=h;e.colDefIndex=f;e.folderIconSpan=(Object.keys(this._expanded).length>0)||d?"ws-browser-expander-container":"";return e;},_getColumnConfigByIndex:function(b){if(b==-1){return{title:this._options.display.titleColumn,field:this._options.display.titleColumn,render:null};}else{return $ws.proto.HierarchyView.superclass._getColumnConfigByIndex.apply(this,arguments);}},_isDefaultPagingText:function(){return this._options.display.usePaging&&this._turn==="";},_toggleTurn:function(c,b){if(this._turn){this._clearExpandAll(b);}else{this._expandAll(c,b);}},setPage:function(b,c){if(this._options.display.usePaging){this._pageSaver[this.getCurrentRootNode()]=b;}$ws.proto.HierarchyView.superclass.setPage.apply(this,arguments);},_setPageSave:function(b){this._pageSaver[this.getCurrentRootNode()]=b-1;},clearTurn:function(b){this._clearExpandAll(b);},_redraw:function(){}});return $ws.proto.HierarchyView;});