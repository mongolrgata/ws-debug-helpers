$ws.declareModule({namespace:"SBIS3.CORE",name:"FieldLink",imports:["SBIS3.CORE.Control"]},function(d){var e=26,a=5,c=16,b=60;$ws.single.DependencyResolver.register("SBIS3.CORE.FieldLink",function(f){var g={};if(f){if(f.renderStyle!=="linkOnly"){g["SBIS3.CORE.FieldString"]=1;}if(f.suggestSettings&&f.suggestSettings.dataSource&&f.suggestSettings.dataSource.readerParams.linkedObject!==""){g["SBIS3.CORE.Suggest"]=1;}}return Object.keys(g);});$ws.proto.FieldLink=d.DataBoundControl.extend({$protected:{_options:{owner:"",canNotBeEmpty:false,multiSelect:false,selectionType:"all",dictionaries:[],showHistory:false,title:"",linkName:"",linkedDisplayField:"",linkTextAlign:"left",isRecordPath:true,labelPosition:"inline",value:null,suggestSettings:{inputTooltip:"",tooltipInside:false,inputFilter:"",formatMethod:"",editDialogTemplate:"",readOnly:false,className:"",editMode:"newDialog"},recordPrefix:"",readLink:true},_keysWeHandle:[$ws._const.key.del,$ws._const.key.backspace,$ws._const.key.esc,$ws._const.key.space,$ws._const.key.enter,$ws._const.key.down,$ws._const.key.up],_owner:false,_visualValue:false,_selectionProcessor:null,dictionaries:[],selectedRecords:false,_isDicListOpened:false,_currentMarkedDic:0,_curDic:false,_dicMenu:false,_linkSpec:null,_currentLinkValue:null,_inputField:null,_suggest:null,_useSuggest:false,_showAllLinks:null,_deleteAllLinks:null,_showAllContainer:null,_keyStorage:{},_dicStorage:[],_suggestDictionary:{},_history:false,_needShowHistory:true,_valueDeferred:undefined,_selection:[],_inputTabIndex:false,_initialVisualValue:undefined,_isReady:false,_fieldReady:null,_suggestReady:null},$constructor:function(){var g=this;this._publish("onBeforeDictionaryOpen","onLinkActivated","onLinkRemove","onVisualizeLink","onLinkSelected","onBeforeLinkActivated","onVisualizeHistoryLink","onBeforeShowRecord","onBeforeLinkRemove");if(this._options.dictionaries){var j=this._options.dictionaries;for(var h=0,f=j.length;h<f;h++){if(j[h].name&&j[h].template){this.dictionaries.push(j[h]);}}}this.subscribe("onValueChange",$.proxy(this.validate,this));this._valueDeferred=new $ws.proto.Deferred().callback();if($ws._const.userConfigSupport&&this._options.showHistory){this._history=[];$ws.single.UserConfig.getParam(this.getClosestArea().getName()+"-"+this.getName()).addCallback(function(i){if(typeof(i)=="string"){g._history=$ws.helpers.deserializeURLData(i);if(Object.isEmpty(g._history)){g._history=[];}if(g._inputField!==null){g._needShowHistory=false;g._drawHistory.apply(g,[]);}}});}if(this.dictionaries.length===0){throw new Error("FieldLink. Wrong dictionaries in config. At least one dictionary shuold be specified");}this._container.addClass("ws-field-fieldLink");this._zIndex=this._container.css("z-index");this._container.append($('<div class="ws-fieldLink-link '+(this._options.enable?"":"readonly")+'"></div>'));if(this._options.linkTextAlign==="right"){this._container.addClass("ws-fieldLink-linkonly-textAlignRight");if(this._options.canNotBeEmpty){this._container.addClass("ws-fieldLink-not-empty");}}if(this._options.renderStyle==="inputAndLink"&&this._options.labelPosition==="top"){this._container.find(".ws-fieldLink-link").css("float","none");}this._link=$('<a href="javascript:void(0)">'+this._options.title+"</a>").attr("title",this._options.tooltip).click(function(i){g._container.click();if(g._options.enable){g.processClick(i);}i.stopPropagation();i.stopImmediatePropagation();i.preventDefault();return false;});if(this._options.renderStyle==="inputAndLink"&&this._options.labelPosition==="top"){this._link.css("float","none");}this._container.find(".ws-fieldLink-link").append(this._link);if(this.dictionaries.length>1){this._createDictionariesMenu();}this._selectionProcessor=(function(K,x,p){if(this._isDestroyed){return;}if(this._curDic===false&&x!==true){this.setCurrentDictionary(0);}var E,w=[],C=[],G=[],r;var J=this._getTargetContext(),u=x===true?"suggest":this._curDic+"",t=u==="suggest"?this._suggestDictionary.objectName:this.getDictionary(u).objectName;if(this._options.multiSelect){if(this.selectedRecords.constructor!==Array){this.selectedRecords=[];}if(this._currentLinkValue&&this._currentLinkValue.constructor===Array){w=this._currentLinkValue.slice();}}else{this.selectedRecords=K;}if(this._options.renderStyle!=="linkOnly"&&!this._options.multiSelect){var q=this._fieldContainer.find(".ws-field");this._toggleInput(false);var o=q.find(".ws-fieldLink-active");if(o.length!==0){o.remove();}}if(!this._options.multiSelect){this._selection=[];}if(this._inputField!==null){this._inputField.setValue("");}for(var D=0,A=K.length;D<A;D++){E=this._prepareSelectionResult(K[D]);this._selection.push(E);if(this._history){this._onNewSelection(E,this._getCurrentDictionary());}r=false;for(var z in this._keyStorage[E.value]){if(z===u||this.getDictionary(z).objectName==t){r=true;break;}}if(r===false){w.push(E.value);if(this._options.multiSelect){this.selectedRecords.push(K[D]);this._keyStorage[E.value]=this._keyStorage[E.value]||{};this._keyStorage[E.value][u]=true;this._dicStorage.push(u);}if(this._options.renderStyle=="linkOnly"){C.push(E.visual);G.push(E.title?E.title:E.visual);}else{this._setVisualValue(E,E.value,this._dicStorage.length-1);}}else{if(this._options.multiSelect&&this._options.renderStyle!=="linkOnly"&&this.selectedRecords.length>1){var y=this._findRecordIdxByKeyAndDictionary(E.value,z||u);if(y!==undefined){var I=this._showAllContainer===null?this._fieldContainer.find(".ws-field"):this._showAllContainer,F=I.find('.ws-fieldLink-active[idx="'+y+'"]');if(F.length===0){this._setVisualValue(E,E.value,y);}else{var H=I.find(".ws-fieldLink-active:last");if(H.length===0){H=g._showAllLinks;}if(H.attr("idx")!==F.attr("idx")){H.after(F);}}if(this._inputField!==null){this._inputField.getContainer().find("input").val("");this._inputField.setActive(true);}}}}}if(this._options.renderStyle=="linkOnly"){this._setVisualValue({visual:C.join(", "),title:G.join(", ")},w.join(","),this._dicStorage.length-1);}var s=this.getValue(),m=s===undefined||s===null,k=w.length;if(!m){if(!this._options.multiSelect){s=[s];}var v=s.length;if(v>k){k=v;}for(var B=k-1;B>=0;B--){if(w[B]!==s[B]){m=true;break;}}}w=this._options.multiSelect?w:w[0];this._currentLinkValue=w;if(m){J.setValue(this._options.linkName,w,false,!this._options.multiSelect);}if(!this._options.multiSelect){J.insert(K[0],this._options.isRecordPath===true?null:this._options.linkName);}if(m){if(p!==true){this._notify("onChange",this.getSelectedRecords());}this._notify("onLinkActivated",this.getSelectedRecords());}this.validate();this._notifyOnValueChange([this.getSelectedRecords(),this.getValue()]);this._notifyOnSizeChanged(this,this,true);}).bind(this);this._fillDic();this._container.addClass("new-fieldLink");if(this._options.renderStyle=="linkOnly"||this._options.multiSelect){this._container.append(this._deleteAllLinks=$('<div class="ws-fieldLink-delete-allLinks ws-invisible"/>'));this._deleteAllLinks.attr("title",this._options.multiSelect?"очистить выбор":"отменить выбор записи").click($.proxy(g.dropAllLinks,g));}if(this._options.renderStyle!=="linkOnly"){this._fieldReady=new $ws.proto.Deferred();this._useSuggest=(this._options.suggestSettings.dataSource&&this._options.suggestSettings.dataSource.readerParams.linkedObject!=="")||false;if(this._useSuggest){this._suggestReady=new $ws.proto.Deferred();}this._addField();if(this._options.multiSelect){this.subscribe("onFocusOut",function(l,k,i){if(i!==g._inputField&&g._showAllContainer!==null){g._showLinksList();}});}}else{this._container.addClass("ws-fieldLink-linkonly");this._link.text(this.getLinkedContext().getValue(this._options.owner)||this._options.title);}},_getExtendedTooltipTarget:function(){return this._link;},_registerToParent:function(){if(this._options.renderStyle!=="linkOnly"&&this._options.suggestSettings.dataSource&&this._options.suggestSettings.dataSource.readerParams.linkedObject!==""){this._inputTabIndex=this.getTabindex();this.setTabindex(false,true);}$ws.proto.FieldLink.superclass._registerToParent.apply(this,arguments);},_markInitialValueSetted:function(){},getClosestArea:function(){var f=this.getParent();while(f&&f.getParent()&&!((SBIS3.CORE.TemplatedArea&&f instanceof SBIS3.CORE.TemplatedArea)||(SBIS3.CORE.Window&&f instanceof SBIS3.CORE.Window))){f=f.getParent();}return f;},_onNewSelection:function(j,m){if(j&&!Object.isEmpty(j)){j=[j];}var h,k;for(var g=0,f=j.length;g<f;g++){h=this._checkHistoryValue(j[g].value,m);if(h!==false){this._history.splice(h,1);}k={k:j[g].value,v:j[g].visual};if(this.dictionaries.length>1){k.d=m;}this._history.unshift(k);}},_checkHistoryValue:function(j,k){var g={};for(var h=0,f=this._history.length;h<f;h++){g=this._history[h];if(g.k==j&&(!g.d||g.d&&g.d.objectName==k.objectName)){return h;}}return false;},_checkDicionary:function(j){var g;for(var h=0,f=this.dictionaries.length;h<f;h++){g=this.dictionaries[h];if(g.name==j.name&&g.objectName==j.objectName){return h;}}return false;},_drawHistory:function(){var s=this,g=this._fieldContainer.width(),j=this._container.width()-g,h=0,f=[],r,q,p,n,o,k,m;this._container.append(this._historyContainer=$('<div class="ws-fieldLink-history">'));if(j>0){this._historyContainer.css("padding-left",j);}for(o=0,k=this._history.length;o<k;o++){r=this._history[o];q=r.d?this._checkDicionary(r.d):0;if(r.d&&q===false){f.push(o);}else{r.n=q;if(!r.d&&this.dictionaries.length>1){r.d=this.dictionaries[0];}if(h<g){m=this._notify("onVisualizeHistoryLink",r.k,r.d,r.v)||r.v;n=$('<div class="ws-fieldLink-history-linkContainer"/>').append(p=$('<a class="ws-fieldLink-history-link" href="javascript:void(0);" key="'+r.k+'" dic="'+r.n+'" >'+m+"</a>").click(function(i){s.setCurrentDictionary(parseInt(this.getAttribute("dic"),10));s.setValue(this.getAttribute("key"));i.stopPropagation();i.preventDefault();return false;}));this._historyContainer.append(n);h+=n.width();if(h>=g){n.remove();}}}}f.sort();for(o=f.length;o>=0;o--){if(f[o]!==undefined){this._history.splice(f[o],1);}}},_onContextValueReceived:function(g){if(this._currentLinkValue&&(g&&this._currentLinkValue!=g||!g)||!this._currentLinkValue&&g){if(this._currentLinkValue){if(g&&!this._options.multiSelect){this._linkSpec=null;}this.dropAllLinks(true);}var l=this.getLinkedContext();if(!this._initialVisualValue&&!this._inputField&&this._options.renderStyle==="inputAndLink"){this._initialVisualValue=this.getLinkedContext().getValue(this._options.linkedDisplayField);}var i=this._options.readLink?this._initialVisualValue:this.getLinkedContext().getValue(this._options.linkedDisplayField);i=i===null?undefined:i;if(g!==null){if(!this._options.multiSelect&&i!==undefined){this._initialVisualValue=undefined;var f=l.getFieldOrigin(this._options.linkedDisplayField),n=f?f.getRecord():false;if(f!==undefined&&n instanceof $ws.proto.Record){var m=n.toObject(),o={},q=[],j;for(var h in m){if(m.hasOwnProperty(h)&&((h.indexOf(this._options.linkName)===0||h.indexOf(this._options.recordPrefix)===0)&&(this._options.recordPrefix!==""?h.indexOf(this._options.recordPrefix+".")===0:h.indexOf(".")!=-1)||h==this._options.linkedDisplayField)){o[h]={type:n.getColumnType(h),title:h,index:q.length};q.push(h==this._options.linkName?g:f.getValue(h));}}j=new $ws.proto.Record({colDef:o,row:q,pkValue:g,parentRecordSet:null});this.selectedRecords=[j];var p=this._prepareSelectionResult(j,this._curDic||0);i=p.visual;}else{this.selectedRecords=[null];}if(this._inputField===null&&this._options.renderStyle!=="linkOnly"){this._visualValue=i;}else{this._setVisualValue(p!==undefined?p:i,g,-1);}this._selection=[{visual:i,value:g}];this._notifyOnSizeChanged(this,this,true);this._currentLinkValue=g;this._notify("onLinkActivated",this.getSelectedRecords());this._notifyOnValueChange([this.getSelectedRecords(),g]);this._notifyReady();}else{this.setValue(g);}}}else{if(g===null){this._notifyReady();}}},_notifyReady:function(){if(!this._isReady){this._isReady=true;if(this._options.renderStyle!=="linkOnly"){var g=new $ws.proto.ParallelDeferred(),f=this;g.push(this._fieldReady);if(this._useSuggest){g.push(this._suggestReady);}g.done();g.getResult().addBoth(function(){f._notify("onReady");});}else{this._notify("onReady");}this._initialValueSetted=true;}},setActive:function(h,g,i,f){$ws.proto.FieldLink.superclass.setActive.apply(this,arguments);if(this._inputField!==null&&this._useSuggest===true&&this._inputField!==f){this._container.removeClass("ws-has-focus");this._inputField.setActive(h);}},_keyboardHover:function(g){if(!g.ctrlKey&&!g.altKey&&!g.shiftKey){if(g.which==$ws._const.key.del){this.dropAllLinks();return false;}if(g.which==$ws._const.key.backspace){var f=this.getSelectedRecords().length;if(f>0){this._dropLinkChecked(f-1);}return false;}else{if(g.which==$ws._const.key.space){if(!this._useSuggest){this.processClick(g);return false;}}else{if(g.which==$ws._const.key.esc&&this._isDicListOpened){this._removeDicList();return false;}else{if(g.which==$ws._const.key.enter){if(this._isDicListOpened){$(document).find("li."+this.getId()+".active").click();return false;}else{this.processClick(g);return false;}}}}}}return true;},processClick:function(f){if(!this.isEnabled()){return;}if(this._showAllContainer!==null){this._showAllLinks.click();}if(this.dictionaries.length>1){this._showDicList(f);}else{this.setCurrentDictionary(0);this._showDictionary(0);}},setTitle:function(f){if(f){this._link.html(this._options.title=$ws.helpers.escapeHtml(f)+"");}},getTitle:function(){return this._options.title?this._options.title:"";},setCurrentDictionary:function(f){$ws.single.GlobalContext.setValue("link-dic-"+this.getId(),this._curDic=f);},_fillDic:function(){var f=$ws.single.GlobalContext.getValue("link-dic-"+this.getId());if(f!==undefined){this._curDic=f;}else{this._curDic=false;}},_createDictionariesMenu:function(){var j=[],g=this;this._link.mousedown(function(i){i.stopPropagation();i.preventDefault();});for(var h=0,f=this.dictionaries.length;h<f;h++){j.push({caption:this.dictionaries[h].name,id:g.getId()+"_number_"+h,addClass:g.getId(),handlers:{onActivated:function(k,i){g._curDic=parseInt(i.id.split("_number_")[1],10);g.setCurrentDictionary(g._curDic);g._showDictionary(g._curDic);}}});}$ws.core.attachInstance("Control/Menu",{data:j,handlers:{onOpen:function(){g._isDicListOpened=true;if(g._curDic!==false){$(document).find("li#"+this.getId()+"-"+g.getId()+"_number_"+g._curDic).addClass(g.getId()+"-dic-list-item-cursor").css("font-weight","bold");}else{$(document).find("li."+g.getId()+"-dic-list-item-cursor").css("font-weight","normal");}},onClose:function(){g._isDicListOpened=false;if(g._curDic!==false){$(document).find("li."+g.getId()+"-dic-list-item-cursor").css("font-weight","normal");}}}}).addCallback(function(i){if(g._dicMenu){g._dicMenu.destroy();}g._dicMenu=i;});},_showDicList:function(f){var g=this._link.offset();f.clientX=g.left+this._link.parent()[0].offsetLeft;f.clientY=g.top+this._link.parent()[0].offsetHeight;this._dicMenu.show(f);},_removeDicList:function(){this._dicMenu.show();},_showDictionary:function(i){var g=this,h=new $ws.proto.Context().setPrevious(g.getLinkedContext()),f;f=this._notify("onBeforeDictionaryOpen");if(f!==undefined&&(f instanceof $ws.proto.Record||f.constructor==Object)){h.setContextData(f);}$ws.core.attachInstance("SBIS3.CORE.DialogSelector",{opener:g,currentValue:g._options.multiSelect?this._currentLinkValue:(this._currentLinkValue?[this._currentLinkValue]:false),template:this.dictionaries[i].template,context:h,multiSelect:g._options.multiSelect,selectionType:g._options.selectionType,handlers:{onChange:function(k,l){if(!(l.length===1&&l[0]===null)){var j=g._notify("onBeforeLinkActivated",l);if(j!==false){this.close();if(j!==true){g._valueSelection(l);}if(g._options.multiSelect&&g._useSuggest){g._inputField.getContainer().click();}else{g.setActive(true);}}}}}});},_valueSelection:function(h,f,g){if(!this._options.multiSelect&&this._options.readLink===true){this._processActivationById(this._getRelationKey(h[0]),f,g);}else{this._selectionProcessor(h,f,g);}},_processActivationById:function(k,h,i){var g=this,j=this._createDLinkSpec(k),f=new $ws.proto.Deferred();h=h||this._curDic==="suggest";j.addCallback(function(l){g._linkSpec=l;g._selectionProcessor([l],h,i);if(!f.isReady()){f.callback(l);}}).addErrback(function(l){g.setCurrentDictionary(false);$ws.single.ioc.resolve("ILogger").log("Поле связи "+g.getName(),"Ошибка при загрузке связи: "+l.message);f.errback();});if(!this._valueDeferred.isReady()){this._valueDeferred.errback();}this._valueDeferred=f;return f;},_createDLinkSpec:function(i){var g=this._options.isRecordPath?this._getTargetRecord():false,f=this._options.linkName;if(g){return g.updateLink(i,f);}else{var h=this._getCurrentDictionary();return this._loadLinkSpec(f,i,h.objectName,h.formatMethod,h.readMethodName);}},_loadLinkSpec:function(l,j,m,i,f){if(m){var h,g="";if((h=m.indexOf("."))!==-1){g=m.substr(0,h);m=m.substr(h+1);}if(!i||i==="null"){i=null;}return $ws.helpers.newRecordSet(m,"Список",undefined,undefined,false,$ws.core.getServiceByName(g),{readMethodName:f}).addCallback(function(n){return n.readRecord(j,i).addCallback(function(o){return o;});});}var k=this._getTargetRecord();if(k){return k.readLink(j,l);}return new $ws.proto.Deferred().errback("No object name and no target record while loading link spec");},_setVisualValue:function(t,p,l,o){var i=t.visual?t.visual:t,m=t.title?t.title:i;if(this._options.renderStyle=="linkOnly"){this._link.text(i||this._options.title);this._link[0].title=m;if(i&&this._options.enable&&!this._options.canNotBeEmpty){this._deleteAllLinks.removeClass("ws-invisible");}else{if(!this._deleteAllLinks.hasClass("ws-invisible")){this._deleteAllLinks.addClass("ws-invisible");}}this._onResizeHandler();}else{if(this._inputField){if(i!==null){var j=this._showAllContainer===null?this._fieldContainer.find(".ws-field"):this._showAllContainer,n=j.find("input"),r=this,f,h,q=r._curDic||0,g=r._generateEditPageURL(p,q),s=r._getCurrentDictionary().editMode=="newWindow"&&g!==false?g:"javascript:void(0)";n.val("");if(!this._options.multiSelect){j.attr("title",m);if(this._useSuggest){this._inputField.setEnabled(false);}}h=$('<div class="ws-fieldLink-active ws-invisible" key="'+p+'" idx="'+l+'"/>').append(f=$('<a class="ws-fieldLink-activeLink" idx="'+l+'" href="'+s+'"target="_blank">'+i+"</a>").attr("title",m));if(!this._options.multiSelect||this._showAllContainer!==null){j.prepend(h);}else{var k=j.find(".ws-fieldLink-active:last");if(k.length===0){k=r._showAllLinks;}k.after(h);}f.click(function(y){var z=r._options.multiSelect?parseInt($(this).attr("idx"),10):0,v=r.selectedRecords[z],w=r._fieldContainer.offset(),x=r.getDictionary(r._options.multiSelect?r._dicStorage[z]:q),u=r._notify("onLinkSelected",v,x);if(x&&x.editMode!==undefined&&x.editMode!=="newWindow"){if(u!==false&&x.editDialogTemplate){$ws.helpers.toggleIndicator(true);if(r._showAllContainer!==null){r._showAllContainer.css({display:"none"});}(function(){var A=r._notify("onBeforeShowRecord",v);if(A instanceof $ws.proto.Deferred){return A;}else{if(A!==false){return new $ws.proto.Deferred().callback(A instanceof $ws.proto.Record?A:v);}else{return new $ws.proto.Deferred().errback();}}})().addCallback(function(A){$ws.core.attachInstance("SBIS3.CORE.DialogRecord",{opener:r,template:typeof(u)=="string"?u:x.editDialogTemplate,record:A instanceof $ws.proto.Record?A:v,top:w.top+r._fieldContainer.height()+"px",left:w.left+"px",readOnly:x.readOnly,handlers:{onBeforeShow:function(){var D=this.getMinSize(),C={left:w.left,top:w.top+r._fieldContainer.height()},B=false;if(D.minWidth+C.left>window.innerWidth){C.left=window.innerWidth-D.minWidth-5>0?window.innerWidth-D.minWidth-5:0;B=true;}if(D.minHeight+C.top>window.innerHeight){C.top=window.innerHeight-D.minHeight-2*r._fieldContainer.height()>0?window.innerHeight-D.minHeight-2*r._fieldContainer.height():0;B=true;}if(B){this.moveWindow(C.left,C.top);}},onAfterClose:function(){if(r._showAllContainer!==null){r._showAllContainer.css({display:""});}}}}).addCallback(function(B){B.subscribe("onRecordUpdate",function(D,C){r._loadLinkSpec(r._options.linkName,r._getRelationKey(v,x.keyField),x.objectName,x.formatMethod).addCallback(function(E){if((r._showAllContainer!==null)||(r._showAllContainer===null&&!r._options.multiSelect)){var G;if(r._showAllContainer!==null){G=r._showAllContainer.find(("[idx = "+z+"] a"))[0];}else{G=r._fieldContainer.find(".ws-fieldLink-activeLink")[0];}var F=r._prepareSelectionResult(E,q);G.text=F.visual;G.title=F.title?F.title:G.text;$(G.offsetParent).css("width",$(G).width()+(r._options.enable?c:0)+(r._options.multiSelect?a:0));if(r._showAllContainer!==null){r._refreshLinksList();}}else{r._fieldContainer.find(".ws-fieldLink-active").remove();r._refreshLinksList();}});});}).addBoth(function(){$ws.helpers.toggleIndicator(false);});}).addErrback(function(){$ws.helpers.toggleIndicator(false);});}y.stopPropagation();y.preventDefault();return false;}return true;});this._setInputFieldSupport(i,f,h,j,n,l,o);}}else{if(i!==undefined){if(typeof this._options.owner=="string"){this._visualValue=this._options.multiSelect?arguments:i;}}}}},_setInputFieldSupport:function(j,w,k,y,r,p,g){var o=w.width(),q=y.width(),h=(this._options.enable?c:0)+a,m=q>0&&q<=o+h&&!this._options.multiSelect;if(m){w.width(q);}k.css("width",m?q-a:o+h);if(j==="Значение не задано"){k.find(".ws-fieldLink-activeLink").css("color","#8C8C8C");}k.removeClass("ws-invisible");if(!this._options.multiSelect){this._toggleInput(false);}if(this._options.multiSelect&&this.getSelectedRecords().length>1&&this._options.enable){this._deleteAllLinks.removeClass("ws-invisible");}else{if(this._deleteAllLinks!==null&&!this._deleteAllLinks.hasClass("ws-invisible")){this._deleteAllLinks.addClass("ws-invisible");}}this._createDropButton(p,y,m);if(this._options.multiSelect&&g!==false){k.append($('<span class="ws-fieldLink-comma">&sbquo;</span>'));}if(this._showAllContainer===null&&this._options.multiSelect){var s=y.find(".ws-fieldLink-active"),n=r.innerWidth()-r.width()+1,f=y.width()-(this._useSuggest?b:0)-c,u=s.length,x,t=0,v;for(v=(u-1);v>=0;v--){t+=s[v].clientWidth;if(t>f){x=v;break;}}if(this.selectedRecords.length>1||x===undefined){if(x!==undefined){for(v=x;v>=0;v--){if(v===x){t-=s[v].clientWidth;}$(s[v]).remove();}this._showAllLinks.removeClass("ws-hidden");}if(!this._showAllLinks.hasClass("ws-hidden")){t+=(this._options.enable?1:-1)*c;}r.width(y.width()-t-n);this._container.removeClass("ws-fieldLink-oneValue");}else{this._container.addClass("ws-fieldLink-oneValue");if(this._useSuggest){$(s[0]).width(f);r.width(b);}else{$(s[0]).width(f+c);this._toggleInput(false);}}this._fieldContainer.find(".ws-tooltip-container").css("left",r.position().left);}},_getCurrentDictionary:function(){var f;if(this._curDic===false){this.setCurrentDictionary(f=0);if(this.dictionaries.length!=1){$ws.single.ioc.resolve("ILogger").log("Поле связи "+this.getName(),"Установка значения в поле связи с несколькими справочниками. Справочник не указан. Взят первый из списка.");}}else{f=this._curDic;}return f=="suggest"?this._suggestDictionary:this.dictionaries[f];},_getRelationKey:function(f,h){var g="";h=h||this._getCurrentDictionary();if(h!==undefined&&h.keyField){g=h.keyField;}if(g&&f.hasColumn(g)){return f.get(g);}else{return f.getKey();}},_prepareSelectionResult:function(f,i){var h={value:undefined,visual:undefined,title:undefined};var g=this._notify("onVisualizeLink",f);h.value=this._getRelationKey(f,i);if(this._options.linkedDisplayField){if(typeof g==="string"){h.visual=h.title=g;}else{if(!g){h.visual=h.title=$ws.helpers.escapeHtml(f.get(this._getLinkedRecordFieldName()));}else{h.visual=g.visual?g.visual:$ws.helpers.escapeHtml(f.get(this._getLinkedRecordFieldName()));h.title=g.title?g.title:h.visual;}}h.visual=$ws.helpers.escapeTagsFromStr(h.visual+"",["script"]);h.title=$ws.helpers.escapeTagsFromStr(h.title,[]);}if(!h.visual){h.visual="Значение не задано";}return h;},_getLinkedRecordFieldName:function(){if(this._options.linkedDisplayField===""){var f=this._options.linkName;return this._options.owner.indexOf(f)===0?this._options.owner.substr(f.length+1):false;}else{return this._options.linkedDisplayField;}},_getTargetRecord:function(){var f=this.getLinkedContext(),h,g=(f&&(h=f.getFieldOrigin(this._options.linkName))&&h.getRecord());if(g&&g.hasColumn(this.getName())&&g.getRecordSet()!==null){return g;}else{return false;}},_getTargetContext:function(){var f=this.getLinkedContext();return(f&&f.getFieldOrigin(this._options.linkName))||f;},_onSizeChangedBatch:function(){this._onResizeHandler();return true;},_setValue:function(n){var h=this;this._selection=[];this._notifyOnSizeChanged(this,this,true);if(!(!!n)){this.setCurrentDictionary(false);if(this.selectedRecords){this.dropAllLinks(false,true);}this._notifyReady();return new $ws.proto.Deferred().callback(null);}else{if(n&&typeof(n)==="object"&&"get" in n&&"hasColumn" in n){if(!this._options.multiSelect&&!this._options.readLink){this._valueSelection([n],undefined,true);return new $ws.proto.Deferred().callback(n);}else{return this.setValue(this._getRelationKey(n));}}else{if(n===true){this._createDropButton();this.selectedRecords=this._currentLinkValue=true;return new $ws.proto.Deferred().callback(true);}else{if(n instanceof Array){if(this._options.multiSelect&&n.length>0){if(n[0] instanceof $ws.proto.Record){this._valueSelection(n,undefined,true);return new $ws.proto.Deferred().callback(n);}else{var m=new $ws.proto.ParallelDeferred({stopOnFirstError:false}),g=[],f=new $ws.proto.Deferred();for(var l=0,k=n.length;l<k;l++){m.push(h._createDLinkSpec(n[l]).addCallback(function(i){g.push(i);}).addErrback(function(i){$ws.single.ioc.resolve("ILogger").log("Поле связи "+h.getName(),"Ошибка при загрузке связи: "+i.message);}));}m.done().getResult().addCallback(function(){h._valueSelection(g,undefined,true);if(!f.isReady()){f.callback(g);}});if(!this._valueDeferred.isReady()){this._valueDeferred.callback();}this._valueDeferred=f;return f;}}}else{if(typeof n==="number"||typeof n==="string"){return this._processActivationById(n,undefined,true);}}}}}$ws.single.ioc.resolve("ILogger").log("FieldLink","Don't know how to handle such value: "+n);return new $ws.proto.Deferred().errback();},setValue:d.ControlBatchUpdater.createBatchUpdateWrapper("FieldLink.setValue",function(f){return this._setValue(f).addCallback(function(){this._notifyReady();}.bind(this));}),_dropLinkChecked:function(f){this.dropLink(undefined,undefined,f);return false;},_findRecordIdxByKeyAndDictionary:function(j,m){var f;m=m||0;j+="";for(var h=0,g=this.selectedRecords.length;h<g;h++){if(this.selectedRecords[h]!==undefined){var k=this._getRelationKey(this.selectedRecords[h],this.dictionaries[m]);if(k===j&&this._keyStorage[j][m]===true){f=h;break;}}}return f;},dropLink:function(k,l,g){var f;if(this._options.renderStyle=="linkOnly"||!this._options.multiSelect||this.getSelectedRecords().length==1||arguments.length===0){this.dropAllLinks();return;}if(g===undefined){if(k===undefined){return;}g=this._findRecordIdxByKeyAndDictionary(k,l);}f=this._notify("onBeforeLinkRemove",this.selectedRecords[parseInt(g,10)]);if(g===undefined||f===false){return;}var h=this._getTargetContext();k=this._showAllContainer!==null?this._showAllContainer.find('.ws-fieldLink-active[idx="'+g+'"]:first').attr("key"):k||this._container.find('.ws-fieldLink-active[idx="'+g+'"]:first').attr("key");delete this.selectedRecords[parseInt(g,10)];delete this._keyStorage[k][this._dicStorage[g]];delete this._dicStorage[parseInt(g,10)];this.selectedRecords=this.getSelectedRecords();this._refreshLinkValue();h.setValue(this._options.linkName,this._currentLinkValue);for(var j=0;j<this._selection.length;++j){if(this._selection[j].value==k){this._selection.splice(j,1);}}this._notify("onChange",this.getSelectedRecords());this._notify("onLinkRemove");this._notifyOnValueChange([this.getSelectedRecords(),this.getValue()]);this.setCurrentDictionary(false);if(this._options.renderStyle!="linkOnly"){if(this._inputField){this._inputField.setValue(null);this._inputField.setEnabled(this._useSuggest);}if(this._showAllContainer===null){this._container.find(".ws-fieldLink-active").remove();}else{this._showAllContainer.find('.ws-fieldLink-active[idx="'+g+'"]').remove();}if(this._options.multiSelect){this._refreshLinksList();}else{this._refreshInputWidth(false,true);this._inputField.setActive(true);}}},_refreshLinkValue:function(){this._currentLinkValue=[];for(var g=0,f=this.selectedRecords.length;g<f;g++){if(this.selectedRecords[g]!==undefined){this._currentLinkValue.push(this._getRelationKey(this.selectedRecords[g],this.dictionaries[this._dicStorage[g]]));}}},_refreshLinksList:function(){if(this._showAllContainer===null){this._refreshLinksShotList();}else{if(!this.selectedRecords||this.selectedRecords.length===0){this._showLinksList();}}},dropAllLinks:function(k,i){var f=k?true:this._notify("onBeforeLinkRemove",this.selectedRecords);if(!k&&(f===false||this.selectedRecords===false||this.selectedRecords.length===0)){return;}var g=this._getTargetContext(),h=k===true?g.getValue(this._options.linkName):null;this._currentLinkValue=null;if(!h){g.setValue(this._options.linkName,null,undefined,k===true);}if(!this._options.multiSelect&&this._linkSpec){g.remove(this._linkSpec,this._options.isRecordPath===true?null:this._options.linkName);}this.selectedRecords=false;this._keyStorage={};this._dicStorage=[];this._selection=[];if(k!==true){if(i!==true){this._notify("onChange",null);}this._notify("onLinkRemove");}var j=this.getValue();if(!j){this._notifyOnValueChange([null,j]);}this.setCurrentDictionary(false);if(this._deleteAllLinks!==null){this._deleteAllLinks.addClass("ws-invisible");}if(this._options.renderStyle=="linkOnly"){this._container.find(".ws-fieldLink-link").css("width","");this._link.text(this._options.title);this._link.attr("title",this._options.tooltip?this._options.tooltip:"");}else{this._container.find(".ws-fieldLink-active").remove();if(this._inputField){if(!h){this._inputField.setValue(null);}this._inputField.setEnabled(this._useSuggest);}if(this._options.multiSelect){this._refreshLinksList();}else{this._refreshInputWidth(false,true);this._fieldContainer.find(".ws-field").attr("title","");}}},getSelectedRecords:function(){var g=[];for(var h=0,f=this.selectedRecords.length;h<f;h++){if(this.selectedRecords[h]!==undefined){g.push(this.selectedRecords[h]);}}return g;},_createDropButton:function(j,h,g){var i=this,k;if(h===undefined){h=this._fieldContainer.find(".ws-field");}var f=h.find('.ws-fieldLink-active[idx="'+j+'"]');f.append(k=$('<span class="ws-fieldLink-delete-container '+(this.isEnabled()?"ws-hidden":"")+' " title="отменить выбор записи"/>'));if(this._options.linkTextAlign==="right"){k.css("position","absolute");}if(!this._options.multiSelect){if(f.width()>h.width()||g){k.css("position","absolute");}else{k.css({position:"relative",right:"0"});}}k.toggleClass("ws-hidden",!i._options.enable);k.click(function(){i._dropLinkChecked.apply(i,[$(this).closest(".ws-fieldLink-active").attr("idx")]);});k.append($('<div class="ws-fieldLink-delete"></div>'));},_canValidate:function(){return $ws.proto.FieldLink.superclass._canValidate.apply(this,arguments)||this._options.canNotBeEmpty;},_invokeValidation:function(){var f=$ws.proto.FieldLink.superclass._invokeValidation.apply(this,arguments);if(this._options.canNotBeEmpty&&!this.selectedRecords){f.result=false;f.errors.push("Поле не может быть пустым");}return f;},getValue:function(){return this.getLinkedContext().getValue(this._options.linkName);},getDictionary:function(f){if(f=="suggest"){return{objectName:this._options.suggestSettings.dataSource.readerParams.linkedObject,name:"suggest",formatMethod:this._options.suggestSettings.formatMethod,editDialogTemplate:this._options.suggestSettings.editDialogTemplate,editMode:this._options.suggestSettings.editMode,readOnly:this._options.suggestSettings.readOnly};}else{return this.dictionaries[f];}},clearMark:function(){if(this._inputField){this._inputField.clearMark();}else{if(this._deleteAllLinks instanceof Object&&"jquery" in this._deleteAllLinks){this._deleteAllLinks.removeClass("ws-hidden");}}$ws.proto.FieldLink.superclass.clearMark.apply(this,arguments);},getSelectedRecordDictionary:function(){return(this._curDic!==false)?this.dictionaries[this._curDic]:undefined;},_saveHistory:function(){if(this._history){return $ws.single.UserConfig.setParam(this.getClosestArea().getName()+"-"+this.getName(),$ws.helpers.serializeURLData(this._history.slice(0,10)));}else{return new $ws.proto.Deferred().callback();}},destroy:function(){var f=this;if(this._dicMenu!==false){this._dicMenu.destroy();}if(this._showAllContainer!==null){this._showAllContainer.remove();this._showAllContainer=null;this._container.trigger("wsSubWindowClose");}if(this._showAllLinks!==null){this._showAllLinks.remove();this._showAllLinks=null;}if(this._deleteAllLinks!==null){this._deleteAllLinks.remove();this._deleteAllLinks=null;}this._saveHistory().addBoth(function(){$ws.proto.FieldLink.superclass.destroy.apply(f,arguments);});},setCanBeEmpty:function(f){this._options.canNotBeEmpty=!!!f;this._container.toggleClass("ws-fieldLink-not-empty",this._options.canNotBeEmpty);this.validate();},_addField:function(){var f=this;this._fieldContainer=$('<div class="ws-fieldLink-input-container"></div>');if(!this._options.multiSelect){this._fieldContainer.addClass("ws-fieldLink-oneValue");}this._container.append(this._fieldContainer);if(!this._initialVisualValue){this._initialVisualValue=this.getLinkedContext().getValue(this._options.linkedDisplayField);}f._fieldReady.dependOn($ws.core.attachInstance("Control/Field:FieldString",{name:this._options.owner,width:"100%",height:"100%",tooltip:this._options.suggestSettings.inputTooltip,tooltipInside:this._options.suggestSettings.tooltipInside,inputFilter:this._options.suggestSettings.inputFilter,tabindex:this._inputTabIndex||this._options.tabindex,element:this._fieldContainer,bindErrorBox:false,linkedContext:this.getLinkedContext(),owner:this.getId(),parent:this.getParent(),enable:this._useSuggest&&this._options.enable,"float":"x",subcontrol:true,allowChangeEnable:this._options.allowChangeEnable,handlers:{onFocusOut:function(i,h,g){if(g!==f&&f._showAllContainer!==null){f._showLinksList();}},onKeyPressed:function(h,g){if(f._useSuggest&&f._showAllContainer!==null){f._showLinksList();}if(!this.getValue()&&(g.which==$ws._const.key.del||g.which==$ws._const.key.backspace)){return f._keyboardHover(g);}return true;}}}).addCallback(function(h){h.validate=function(){return true;};h._setValueInternal=function(i){if(i===null||i===undefined){i="";}if(typeof i!="string"){i=i+"";}if(this._options.inputFilter){i=this._filterValue(i);}if(this._options.maxlength&&i.length>this._options.maxlength){i=i.substr(0,this._options.maxlength);}if(!this._inputControl.hasClass("ws-hidden")){this._inputControl.val(i);}$ws.proto.FieldString.superclass._setValueInternal.apply(h,[i]);h._tooltipHandler();};h.getMinWidth=function(){return 0;};h.getMinHeight=function(){return 0;};f._inputField=h;h._setupErrorBoxEventsToggler(f.getContainer(),h);if(f._needShowHistory&&f._history&&!Object.isEmpty(f._history)){f._drawHistory.apply(f,[]);}if(f._options.enable){f._fieldContainer.find(".ws-field").addClass("not-readonly");}f._inputField.getContainer().find(".input-string-field").click(function(){if(f.isEnabled()){f.setActive(true);}});if(f._options.multiSelect){f._fieldContainer.find(".ws-field").prepend(f._showAllLinks=$('<a class="ws-fieldLink-showAllLinks ws-hidden" href="javascript:void(0)">&hellip;</a>'));f._showAllLinks.click($.proxy(f._showLinksList,f));$(document).click(function(){if(f._showAllContainer!==null){f._showAllLinks.click();}});}var g=f._fieldContainer.find(".ws-field input");if(!f._options.enable){g.addClass("ws-invisible");}if(f._visualValue){if(f._options.multiSelect){f._setVisualValue.apply(f,f._visualValue);}else{f._setVisualValue(f._visualValue,f._currentLinkValue,-1);}f._visualValue=false;}if(f._useSuggest){f._addSuggest.apply(f,[]);}else{f._fieldContainer.addClass("ws-fieldLink-without-Suggest");}}));},_addSuggest:function(){var f=this,g={sourceField:[f._inputField.getId()],resultField:[],owner:this.getId(),linkedContext:this.getLinkedContext(),parent:this.getParent(),enable:this._options.enable,className:this._options.suggestSettings.className};delete this._options.suggestSettings.sourceField;delete this._options.suggestSettings.resultField;g=$ws.core.merge(g,this._options.suggestSettings);this._suggestDictionary={formatMethod:this._options.suggestSettings.formatMethod,name:"suggest",objectName:g.dataSource.readerParams.linkedObject,keyField:this._options.suggestSettings.keyField};f._suggestReady.dependOn($ws.core.attachInstance("Control/Suggest",g).addCallback(function(h){f._suggest=h;h.subscribe("onSuggest",function(k,i){k.setResult(false);var j=f._notify("onBeforeLinkActivated",[i]);if(j!==false){if(j!==true){f._curDic="suggest";f._valueSelection.apply(f,[[i],true]);}this.hide();}});}));},getSuggest:function(){return this._suggest;},_showLinksList:function(){if(this._showAllContainer===null){this._container.css("z-index",1001);this._fieldContainer.find(".ws-fieldLink-active").remove();this._refreshInputWidth(true,false);$(document.body).append(this._showAllContainer=$('<div class="ws-fieldLink-showAll-container" />'));var j=this._fieldContainer.offset();this._showAllContainer.css({top:j.top+this._fieldContainer.height(),left:j.left,width:this._fieldContainer.width(),position:"absolute"}).click(function(i){i.stopPropagation();i.preventDefault();return false;});for(var h=0,f=this.selectedRecords.length;h<f;h++){if(this.selectedRecords[h]!==undefined){var g=this._prepareSelectionResult(this.selectedRecords[h],this.dictionaries[this._dicStorage[h]]);this._setVisualValue(g,g.value,h,h!==0);}}this._container.trigger("wsSubWindowOpen");}else{this._container.css("z-index",this._zIndex);this._showAllContainer.remove();this._showAllContainer=null;this._refreshLinksShotList();this._container.trigger("wsSubWindowClose");}},_refreshLinksShotList:function(){if(this._options.multiSelect&&this._options.renderStyle!=="linkOnly"){var f=this.selectedRecords.length,i=0,h,l;for(var g=0;g<f;g++){if(this.selectedRecords[g]!==undefined){i++;h=this._prepareSelectionResult(this.selectedRecords[g],this.dictionaries[this._dicStorage[g]]);this._setVisualValue(h,h.value,g);}}l=this._fieldContainer.find(".ws-field").find(".ws-fieldLink-active");if(i===l.length&&!this._showAllLinks.hasClass("ws-hidden")){this._showAllLinks.addClass("ws-hidden");}if(i===0){this._refreshInputWidth(false,true);}}},_refreshInputWidth:function(f,i){var g=this._fieldContainer.find("input"),h,j;if(!g.size()){return;}h=g.innerWidth()-g.width();j=this._fieldContainer.find(".ws-field").width()-h;if(f===true){j-=e;}g.width(j);this._fieldContainer.find(".ws-tooltip-container").css("left",g.position().left);if(i===true){this._toggleInput(true);}},_toggleInput:function(f){this._fieldContainer.find("input, .ws-tooltip-container").toggleClass("ws-hidden",!f);},_onResizeHandler:function(){if(this._options.renderStyle=="linkOnly"){if(this._link.width()>=this._container.width()){this._deleteAllLinks.css({position:"absolute",right:0});this._link.closest(".ws-fieldLink-link").css({width:this._container.width()-(this._options.enable?c:0),"text-overflow":"ellipsis"});}else{this._deleteAllLinks.css({position:"relative"});}}else{if($ws.proto.FieldString&&this._inputField instanceof $ws.proto.FieldString){if(this._options.multiSelect){this._fieldContainer.find(".ws-fieldLink-active").remove();this._refreshLinksList();}else{var j=this._fieldContainer.find(".ws-fieldLink-active"),i=j.find("a.ws-fieldLink-activeLink");i.width("auto");j.width("auto");var k=this._options.enable?c:0,g=j.outerWidth()+k,f=this._fieldContainer.innerWidth()-k,h=g<f?g:f;this._fieldContainer.find(".ws-fieldLink-delete-container").css("position",g<f?"relative":"absolute");j.width(h+1);i.width(h);}}}},markControl:function(f){if(this._inputField===null){this._deleteAllLinks.addClass("ws-hidden");$ws.proto.FieldLink.superclass.markControl.apply(this,arguments);}else{this._inputField.markControl(f);$ws.proto.FieldLink.superclass.markControl.apply(this,arguments);}},setEnabled:function(f){f=!!f;if(this._options.enable!==f&&this._options.allowChangeEnable){if(this._useSuggest){if(this._suggest!==null){this._suggest.setEnabled(f);}}if(this._inputField!==null){this._inputField.setEnabled(f);this._fieldContainer.find(".ws-field").toggleClass("not-readonly");this._fieldContainer.find(".ws-field input").toggleClass("ws-invisible",!f);this._fieldContainer.find(".ws-fieldLink-delete-container").toggleClass("ws-hidden",!f);}if(this._options.renderStyle=="linkOnly"&&this.selectedRecords||this.selectedRecords.length>1){this._deleteAllLinks.toggleClass("ws-invisible",!f);}this._link.parent(".ws-fieldLink-link").toggleClass("readonly",!f);$ws.proto.FieldLink.superclass.setEnabled.apply(this,arguments);this._onResizeHandler();}},_generateEditPageURL:function(h,f){var j=this.getDictionary(f||0);if(j.editDialogTemplate&&j.editMode==="newWindow"){var i={},g={onBeforeShowRecord:this._handlersPath("onBeforeShowRecord")};i.readerParams={};i.readerParams.format=j.formatMethod||"";i.readerParams.linkedObject=j.objectName;if(j.readMethodName){i.readerParams.readMethodName=j.readMethodName;}return $ws.helpers.generateURL(h,false,null,false,j.editDialogTemplate,this.getId(),j.readOnly||false,i,undefined,undefined,g);}else{return false;}},setIsRecordPath:function(f){f=!!f;if(this._options.isRecordPath!==f){if(!this._options.multiSelect&&this._linkSpec){var g=this._getTargetContext();if(!this._options.isRecordPath){g.remove(this._linkSpec,this._options.linkName);}g.insert(this._linkSpec,this._options.isRecordPath===true?null:this._options.linkName);}this._options.isRecordPath=f;}},getInputField:function(){return this._inputField;},getStringValue:function(){var g=[];for(var f=0;f<this._selection.length;++f){g.push(this._selection[f].visual);}return g.join(", ");},getValueDeferred:function(){return this._valueDeferred;},_getDefaultValue:function(){if(typeof this._options.value==="function"){return this._options.value();}return this._options.value;},_redraw:function(){}});return $ws.proto.FieldLink;});