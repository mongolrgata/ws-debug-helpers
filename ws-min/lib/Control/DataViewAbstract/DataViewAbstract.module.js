$ws.declareModule({namespace:"SBIS3.CORE",name:"DataViewAbstract",imports:["SBIS3.CORE.Control"]},function(a){$ws._const.Browser=$ws._const.Browser||{};$ws._const.Browser.pageSizes=[10,25,50,100,200,500,1000];$ws._const.Browser.minHeight=24;$ws._const.Browser.loadingIndicatorDelay=200;$ws.single.DependencyResolver.register("SBIS3.CORE.DataViewAbstract",function(b){var c={};if(b){if(b.display.showPaging){c["SBIS3.CORE.Paging"]=1;}if(b.allowMove||!("allowMove" in b)){c["/lib/Control/Plugins/Move-plugin.js"]=1;}if(b.display.showRecordsCount){c["SBIS3.CORE.FieldDropdown"]=1;}if(b.rowOptions){c["SBIS3.CORE.Menu"]=1;}if(b.useCopyRecords){c["/lib/Control/Plugins/Copy-plugin.js"]=1;}if(b.useMergeRecords){c["/lib/Control/Plugins/Merge-plugin.js"]=1;}if(b.display.showHistory){c["/lib/Control/Plugins/History-plugin.js"]=1;}if(b.display.showToolbar){c["/lib/Control/Plugins/Toolbar-plugin.js"]=1;c["SBIS3.CORE.ToolBar"]=1;c["SBIS3.CORE.Button"]=1;c["SBIS3.CORE.Menu"]=1;}if(b.reports&&!Object.isEmpty(b.reports)||b.reportsForList&&!Object.isEmpty(b.reportsForList)){c["/lib/Control/Plugins/Print-plugin.js"]=1;}if(b.markedRowOptions&&!Object.isEmpty(b.markedRowOptions)){c["/lib/Control/Plugins/MarkedRowOptions-plugin.js"]=1;}}return Object.keys(c);});$ws.proto.DataViewAbstract=a.DataBoundControl.extend({$protected:{_options:{useCopyRecords:false,useMergeRecords:false,showHistory:false,preprocessQuery:false,multiSelect:true,useSelection:true,allowAdd:true,allowEdit:true,allowDelete:true,allowMove:false,dataSource:{readerParams:{format:undefined,readMethodName:""}},editMode:"newDialog",editDialogTemplate:"",editFullScreenTemplate:undefined,filterDialogTemplate:"",filterParams:{},setCursorOnLoad:true,mode:"oneClickMode",useHoverRowAsActive:false,setNewDataSourceWithParent:false,display:{viewType:"",columns:[],readOnly:false,showRecordsCount:true,showPaging:true,usePaging:"",recordsPerPage:20,pagesLeftRight:3,displayValue:"",emptyHtml:"",emptyTableHtml:"",reload:true,allowHorizontalScroll:true,showSelectionCheckbox:true,showRecordCountForEmptyData:true,usePageSizeSelect:true}},_rootElement:"",_headContainer:undefined,_resizer:undefined,_head:"",_body:"",_foot:"",_data:"",_browserContainer:undefined,_activeElement:false,_bodyHeight:0,_bodyRealHeight:0,_wsBrowserContainer:false,_currentRecordSet:null,_initialSource:{},_initialFilter:{},_currentFilter:{},_count:0,_hovered:0,_sortingStack:[],_paging:undefined,_pagingReady:undefined,_pagingFilter:{},_selected:{},_selectedRecords:[],_selectMode:false,_dReady:undefined,_verticalScrollShowed:false,_isUpdatingRecords:false,_needResize:true,_actions:{},_emptyDataBlock:undefined,_emptyDataText:true,_isFakeDelete:false,_loadingIndicator:undefined,_footerDrawed:false,_applyingState:false,_scrollGapPlaceholder:false,_ajaxLoader:false,_menuButtons:{},_initialColumns:[],_dropped:false,_keysActions:{},_systemParams:{},_keysWeHandle:[$ws._const.key.enter,$ws._const.key.down,$ws._const.key.up,$ws._const.key.del,$ws._const.key.insert,$ws._const.key.f3,$ws._const.key.esc,$ws._const.key.pageUp,$ws._const.key.minus,$ws._const.key.pageDown,$ws._const.key.space,$ws._const.key.q,$ws._const.key.n],_dataBindHandler:null,_setDataHandler:null,_clickEventsQueue:[],_rowSelectionSetted:false,_methodName:"static",_minimized:false,_initialRecordSet:false,_pageOptions:[],_pageOptionsContainer:undefined,_pageOptionsDropdown:false,_useKeyboard:false,_recordsOpened:[],_scrollWidth:undefined,_isGroupDelete:false,_inBeforeRenderActionCnt:0,_oldAdditionalHeight:null,_updateRecordMethodName:false,_isRecordFloatAreaOpen:false,_isLoading:false},$constructor:function(){var b=this;this._scrollWidth=$ws.helpers.getScrollWidth();this._pagingReady=new $ws.proto.Deferred();this._dReady=new $ws.proto.Deferred();this._firstLoadDeferred=new $ws.proto.Deferred();this._configChecking();this._publish("onBeforeRender","onBeforeCreate","onBeforeInsert","onBeforeUpdate","onDeleteStart","onBeforeDelete","onBeforeLoad","onAfterLoad","onAfterRender","onRowActivated","onFilterChange","onRowClick","onRowDoubleClick","onSetCursor","onChangeSelection","onSelectionConfirm","onLoadError","onBeforeRead","onRecordsChanged","onBeforeOpenEditWindow","onNewAction","onSelectEditMode","onAfterInsert");$ws.single.CommandDispatcher.declareCommand(this,"newItem",this._insertRecordItem);$ws.single.CommandDispatcher.declareCommand(this,"edit",this._editRecord);$ws.single.CommandDispatcher.declareCommand(this,"delete",this._deleteRecords);$ws.single.CommandDispatcher.declareCommand(this,"confirmSelection",this.confirmSelection);$ws.single.CommandDispatcher.declareCommand(this,"selectAll",this.selectAll);$ws.single.CommandDispatcher.declareCommand(this,"removeSelection",this.removeSelection);$ws.single.CommandDispatcher.declareCommand(this,"reload",this.reload);$ws.single.CommandDispatcher.declareCommand(this,"showSelection",this.showSelection);var c=BOOMR.plugins.WS.startSpan("DataViewAbstract:createContainer");this._mapColumns();this._initialColumns=this._options.display.columns;this._createContainer();c.stop();this._initActionsFlags();this._context=new $ws.proto.Context().setPrevious(this._context);if(this._options.saveState){$ws.single.ControlStorage.waitChildByName(this.getName()).addCallback(function(){b._notify("onStateChanged");}).addCallback(function(){b._initDataSource();});}else{b._initDataSource();}this._initEvents();this._initKeys();this._dataBindHandler=$.proxy(this._dataBind,this);if(!this._options.setNewDataSourceWithParent&&this._parent){this._parent.subscribe("onReady",this._dataBindHandler);}else{this._dataBind();}this._options.dataSource.readerType=this._options.dataSource.readerType||"ReaderUnifiedSBIS";this.subscribe("onKeyPressed",$.proxy(this._keyboardShortcut,this));if(!this._options.display.rowOptions){if(this._options.display.readOnly){this._menuButtons.view=["Просмотреть (F3)","sprite:icon-16 icon-Edit icon-primary","edit"];}else{this._menuButtons.edit=["Редактировать (F3)","sprite:icon-16 icon-Edit icon-primary","edit"];}}},_haveAutoWidth:function(){return this._options.autoWidth&&this._horizontalAlignment!=="Stretch";},_isHeightGrowable:function(){return this._options.autoHeight&&this._verticalAlignment!=="Stretch";},_isInBeforeRenderAction:function(){return this._inBeforeRenderActionCnt>0;},markControl:function(c){var b=$ws.proto.DataViewAbstract.superclass.markControl.apply(this,arguments);this._onResizeHandler();return b;},clearMark:function(){var b=$ws.proto.DataViewAbstract.superclass.clearMark.apply(this,arguments);this._onResizeHandler();return b;},isReadOnly:function(){return this._options.display.readOnly;},_getElementToFocus:function(){var b=this.getActiveElement();if(b){return b;}var c=this._browserContainer.find("tr:first");if(c.length){return c;}return this.getContainer();},show:function(){this._runInBatchUpdate("DataViewAbstract.show",function(){this._setVisibility(true);this._heightChangedIfVisible();});},recalcBrowserOnDOMChange:function(){this._notifyOnSizeChangedWithVisible(false);},_onSizeChangedBatch:function(){this._contentHeightChanged();return true;},_heightChangedIfVisible:function(){var b=this._isVisibleWithParents()&&!this._isInBeforeRenderAction();if(b){this._contentHeightChanged();}this._notifyOnSizeChanged(this,this,!b);},_isVisibleWithParents:function(){return this._container&&this._container.closest(".ws-hidden").length===0;},_notifyOnSizeChangedWithVisible:function(b){if(b===undefined){b=this._isVisibleWithParents();}this._notifyOnSizeChanged(this,this,!b);},_notifyOnSizeChanged:function(){this._setContainerHeightForRecalk();return $ws.proto.DataViewAbstract.superclass._notifyOnSizeChanged.apply(this,arguments);},_setContainerHeightForRecalk:function(){if(this._isHeightGrowable()&&this._horizontalAlignment==="Stretch"){this._containerHeightForRecalk=this._container.get(0).offsetHeight;}},_checkContainerHeightForRecalk:function(){if(this._isHeightGrowable()&&this._horizontalAlignment==="Stretch"){var b=this._containerHeightForRecalk;this._setContainerHeightForRecalk();if(this._containerHeightForRecalk!==b){this._notifyOnSizeChanged(this,this);}}},setMultiSelect:function(b){this._options.multiSelect=!!b;this._options.display.showSelectionCheckbox=!!b;if(!b){this.removeSelection();}this._colgroupCache=undefined;this.refresh(true);},isMultiSelect:function(){return this._options.multiSelect;},_createContainer:function(){this._container.click(function(b){b.stopImmediatePropagation();}).bind("mousewheel",function(b){if(!b.ctrlKey){b.stopPropagation();}return true;});this._resizer=this._container.find(".ws-browser-resizer");if(this._resizer.size()===0){this._resizer=null;}this._rootElement=this._container.find(".ws-browser-data-container");this._body=this._container.find(".ws-browser tbody");this._head=this._rootElement.find("thead");this._foot=this._rootElement.find("tfoot");this._headContainer=this._rootElement.find(".ws-browser-head-container");this._data=this._rootElement.find(".ws-browser");this._browserContainer=this._rootElement.find(".ws-browser-container");this._pageOptionsContainer=this._container.find(".ws-browser-page-selector");this._emptyDataScroller=this._container.find(".ws-browser-empty-scroller");this._emptyDataBlock=this._container.find(".ws-browser-empty");if(!this._options.display.allowHorizontalScroll){this._data.parent().css("overflow-x","hidden");}if(this._options.autoHeight){this._container.height("auto");this._data.parent().height("auto");}if(this._options.display.width>0){this._browserContainer.width(this._options.display.width+"px");this._rootElement.width(this._options.display.width+"px");}},_configChecking:function(){if(this._options.display.useDrawingLines){this._options.display.useSeparating=false;this._options.display.hasZebra=false;}if(!this._options.display.usePaging){this._options.display.showPaging=false;}this._options.display.usePaging?this._options.display.partiallyLoad=true:this._options.display.showPaging=false;if(this._options.multiSelect===false){this._options.display.showSelectionCheckbox=false;}this._initSystemParams();var b=this._options.dataSource?this._options.dataSource.readerParams||{}:{};if(!$.isEmptyObject(b)){this._methodName=[b.linkedObject,b.queryName].join(".");}},_initSystemParams:function(){},_getMenuButtons:function(){return[["Очистить сортировку","sprite:icon-16 icon-Close icon-primary","clearSorting"]];},_actionEdit:function(c){var b=c instanceof Object&&"jquery" in c?c:this.getActiveElement();if(b&&b.attr("rowkey")!=="null"){this._showDialogForRecord(this.getActiveRecord(b));}},_initActionsFlags:function(){var c=this._options.editDialogTemplate,d=this._options.display.readOnly,b=this;this._actions={addItem:c&&this._options.allowAdd!==false&&!d&&function(){b._showRecordDialog({});},edit:this._options.allowEdit!==false&&c&&this._actionEdit.bind(this),"delete":!d&&this._options.allowDelete!==false&&function(f){var e=f instanceof Object&&"jquery" in f;if(e&&(!b._activeElement||b._activeElement.attr("rowkey")!==f.attr("rowkey"))){b.setActiveRow(f);}b._deleteRecords.apply(b,[e,e?f.attr("rowkey"):undefined]);},filterParams:this._options.filterDialogTemplate&&function(){b.createFiltersDialog.apply(b,[]);},clearFilter:this._options.filterDialogTemplate&&function(){b.resetFilter();},refresh:$.proxy(b.reload,b)};},getActions:function(){return this._actions;},_changeRecordSetHandlers:function(c){if(c instanceof $ws.proto.RecordSet){var b=this;this._currentRecordSet=c;c.subscribe("onRecordUpdated",$.proxy(this._onRecordUpdated,this));c.subscribe("onRecordDeleted",$.proxy(this._onRecordDeleted,this));c.subscribe("onBeforeLoad",function(){b._minimized=false;});if(this._paging&&this._paging!==true){this._paging.setRecordSet(c);}if(this._pathSelector instanceof Object){this._pathSelector.setBrowserRecordSet(c);}}},_onDataLoadedBatchUpdateWrapper:$ws.single.ControlBatchUpdater.createBatchUpdateWrapper("_onDataLoaded wrap","_onDataLoaded"),setData:function(d){if(d instanceof $ws.proto.RecordSet){var b=this,c=function(){if(b._setDataHandler){b._parent.unsubscribe("onReady",b._setDataHandler);}d.subscribe("onBeforeLoad",b._onDataLoadStarted.bind(b));d.subscribe("onAfterLoad",b._onDataLoadedBatchUpdateWrapper.bind(b));b._changeRecordSetHandlers(d);b.setPageSize(d.getPageSize(),true);b.removeSelection();if(!b._dReady.isReady()){b._dReady.callback();}if(b._pathSelector instanceof Object){b._pathSelector.setSource(d.getSource());}if(b._options.display.usePaging&&b._currentRecordSet.getPageNumber()!==0){b.setPage(0,true);}else{b._onDataLoaded({},d,true);}};if(d.getContext().isGlobal()){d.setContext(new $ws.proto.Context().setPrevious(b.getLinkedContext()));}if(this._parent){this._parent.unsubscribe("onReady",this._dataBindHandler);}if(this._setDataHandler){this._parent.unsubscribe("onReady",this._setDataHandler);}if(this._parent&&!this._parent.isReady()){this._parent.subscribe("onReady",this._setDataHandler=c);}else{c();}}},recordSetReady:function(){return this._dReady;},setSource:function(b){if(b instanceof Object){if(this._parent){this._parent.unsubscribe("onReady",this._dataBindHandler);}if(this._setDataHandler){this._parent.unsubscribe("onReady",this._setDataHandler);}if(this._pathSelector instanceof Object){this._pathSelector.setSource($ws.core.merge({},b));}this._options.dataSource=b;this._dReady=new $ws.proto.Deferred();this._initDataSource();this._dataBind();}},getDataSource:function(){return this._options.dataSource;},setPage:function(b,d){b=parseInt(b,10);if(this._options.display.usePaging){var c=this;this._dReady.addCallback(function(){c._currentRecordSet.setPage(b,!d);});}},getPageNumber:function(){if(this._options.display.usePaging&&this._currentRecordSet){return this._currentRecordSet.getPageNumber();}return 0;},_setPageSize:function(d,b){if(this._options.display.recordsPerPage!==d){this._options.display.recordsPerPage=d;var c=this;this._dReady.addCallback(function(){c._currentRecordSet.setPageSize(d,b);});this.getPaging().addCallback(function(e){e.setPageSize(d);e.update(1);return e;});}},_insertPageCount:function(c){var e=-1;for(var d=0;d<this._pageOptions.length;++d){if(this._pageOptions[d]>=c){if(this._pageOptions[d]>c){this._pageOptions.splice(d,0,c);}e=d;break;}}if(e==-1){this._pageOptions.push(c);}if(this._pageOptionsDropdown){var b=this;this._pageOptionsDropdown.addCallback(function(h){var g={};for(var f in b._pageOptions){if(b._pageOptions.hasOwnProperty(f)){g[b._pageOptions[f]]=b._pageOptions[f];}}h.setData(g);h.setValue(c);return h;});}},setPageSize:function(c,b){if(this._options.display.usePaging&&c!==this._options.display.recordsPerPage){this._drawFooter();this._setPageSize(c,b);if(this._options.display.usePageSizeSelect){this._insertPageCount(c);}}},_prepareQueryFilter:function(d){var b=this._prepareFilter($ws.core.merge({},d));for(var c in b){if(b.hasOwnProperty(c)){if(b[c]===undefined){b[c]=this._initialFilter[c];}}}return b;},setQuery:function(e,d,g,f){var c=this,b=new $ws.proto.Deferred();this._dReady.addCallback(function(){var h=c._prepareQueryFilter($ws.core.merge({},e));if(!g){c._currentRecordSet.setPage(0,true);}else{if(typeof(g)==="number"){c._currentRecordSet.setPage(g,true);}}if(f!==undefined){c.setSorting(f,true);}b.dependOn(c._runQuery(h,d));});return b;},_runQuery:function(e,d){var c=this,b=new $ws.proto.Deferred();this._dReady.addCallback(function(){d=d===undefined?true:d;b.dependOn(c._currentRecordSet.setQuery(e,d));});return b;},resetFilter:function(b){this._currentFilter=$ws.core.merge({},this._initialFilter);var c=this;this._currentRecordSet.resetFilter(this._currentFilter,b);},getQuery:function(b){var c={},d=$ws.core.merge({},this._currentFilter);if(b){$ws.core.merge(d,this._prepareFilter(this._options.filterParams));}else{this._prepareSystemParams(d);}if(b){if(this._currentRecordSet){c=this._currentRecordSet.getUpdatedQuery(this._initialSource.filterParams);}return $ws.core.merge(d,c,{rec:true});}else{if(this._currentRecordSet){c=this._currentRecordSet.getQuery();}return $ws.core.merge(d,c);}},_prepareSystemParams:function(d){var b=$ws.core.merge({},d)||{};for(var c in this._systemParams){if(this._systemParams.hasOwnProperty(c)&&!(c in b)){b[c]=this._currentFilter[c]!==undefined?this._currentFilter[c]:this._systemParams[c];}}return b;},_prepareFilter:function(d){var b=this._prepareSystemParams(d);for(var c in b){if(b.hasOwnProperty(c)){if(b[c] instanceof Object&&b[c]["fieldName"]!==undefined){b[c]=this._context.getValue(b[c].fieldName);}else{if(typeof b[c]==="function"){b[c]=b[c].apply(this,[this._context,c]);}}}}return b;},_prepareDataSource:function(){var c=this._options.dataSource;if(!(c instanceof Object)){return;}var b={filterParams:{},hierarchyField:this._options.display.hierColumn?this._options.display.hierColumn:"",rowsPerPage:this._options.display.recordsPerPage,usePages:this._options.display.usePaging,handlers:{onBeforeLoad:this._onDataLoadStarted.bind(this),onAfterLoad:this._onDataLoadedBatchUpdateWrapper.bind(this)}};this._options.dataSource.filterParams=$ws.core.merge(this._options.dataSource.filterParams||{},this._options.filterParams,{preferSource:true});this._options.dataSource.filterParams=this._prepareSystemParams(this._options.dataSource.filterParams);$ws.core.merge(c,b);},_initDataSource:function(){var b=this._options.dataSource;this._prepareDataSource();this._initialSource=$ws.core.merge({},b,{clone:true});this._initialSource.context=this._context;},_dataBind:function(){var b=this,d=b._options.dataSource;if(this._parent){this._parent.unsubscribe("onReady",this._dataBindHandler);}if(!(d instanceof Object)){return false;}var c=$ws.core.merge({},d);c.context=this._context;this._initialFilter=this._options.filterParams?this._prepareFilter(this._options.filterParams):{};this._currentFilter=$ws.core.merge({},this._initialFilter);$ws.core.attachInstance("Source:RecordSet",c).addCallback(function(e){b._changeRecordSetHandlers(e);b._dReady.callback();b._notify("onReady");});return true;},_hasFilterChanges:function(c){for(var b in c){if(c.hasOwnProperty(b)){if(b!=="pageNum"&&this._pagingFilter[b]!==c[b]){return true;}}}return false;},_onDataLoadStarted:function(c,b){if(!this._ajaxLoader){this._ajaxLoader=this._container.find(".ws-browser-ajax-loader");}this._ajaxLoader.removeClass("ws-hidden");this._notify("onFilterChange",b);if(this._paging&&this._paging instanceof Object&&this._hasFilterChanges(b)){this._paging.clearMaxPage();}this._pagingFilter=b;this._currentFilter=b;this._emptyDataBlock.addClass("ws-hidden");this._isLoading=true;this._notify("onBeforeLoad");},isLoading:function(){return this._isLoading;},_onDataLoaded:function(e,d,b,c){function f(){var k=this,h=undefined;if(b){this._currentRecordSet=d;if(this._onBeforeRenderActions()&&!this._isDestroyed){this._processPaging();if(this._columnMap&&this._columnMap.length>0){this._mapColumns();}else{this._refreshHead();}if(this._turn===""&&this._pathSelector){this._findWay(this._currentRootId);}if(this.getActiveElement()){this._hovered=this.getActiveElement().attr("rowkey");}this._drawFooter();this._drawBody();var g=function(m){try{k._notifyOnSizeChangedWithVisible();}finally{k._notifyBatchDelayed("onAfterLoad");}return m;};var i=this._updatePager();if(i){i.addCallback(g);h=i;}else{g();}if(!this._firstLoadDeferred.isReady()){this._firstLoadDeferred.callback();}this._changeState();}}else{this._hideLoadingIndicator();var l=this._options.dataSource.readerParams,j=l.linkedObject+"."+(l.queryName||"Список");if(c instanceof HTTPError&&c.httpError!==0&&this._notify("onLoadError",c,j)!==true){if(c.httpError==403){this._body.empty();this._rootElement.find(".ws-browser-pager-text").empty();this._emptyDataBlock.html('<span class="ws-browser-deny">Недостаточно прав для просмотра информации</span>').removeClass("ws-hidden");this._emptyDataText=false;this._heightChangedIfVisible();}else{$ws.core.alert(c.message.replace(/\n/mg,"<br />"),"info");}c.processed=true;}}return h;}return this._runInBatchUpdate("_onDataLoaded",f,arguments);},_filterState:function(c){for(var b in c){if(c.hasOwnProperty(b)&&c[b] instanceof Date){c[b]=c[b].toSQL(true);}}},_changeState:function(c){if(!this._applyingState){var e;if(this._options.mode=="navigationMode"){var b=this.getActiveRecord();e=b?b.getKey():null;if(e){this._notify("onStateChanged",e,!c);}}else{var d=this.getQuery();this._filterState(d);e=JSON.stringify(d);if(e){this._notify("onStateChanged",e,true);}}}},applyState:function(d){var n=this;if(this._options.mode=="navigationMode"){var m=this.getActiveRecord(),h=m?m.getKey():null;if(d!=="null"&&d!=h){this._applyingState=true;this._firstLoadDeferred.addCallback(function(){$ws.helpers.callbackWrapper(n.showBranch(d),function(){n._applyingState=false;});});}else{this.setActiveElement(this._body.find('tr[rowkey="'+(this._rootNode===null?"null":this._rootNode.toString())+'"]'));}}else{var f;try{f=$.parseJSON(d);}catch(j){f={};}f=typeof f=="object"?f:{};this._dReady.addCallback(function(){n.setQuery(f);});var b=function(i,e){if(!i){return false;}if(i.hasChildControlByName(e)){return i.getChildControlByName(e);}else{return b(i.getParent(),e);}};for(var g in f){if(f.hasOwnProperty(g)&&!(g in {pageCount:0,usePages:0})){if(g!=="pageNum"){var k=this._initialFilter[g],c=k?k.fieldName:undefined,l=c!==undefined?b(this.getParent(),c):undefined;if(l instanceof $ws.proto.DataBoundControl){l.setValue(f[g]);}else{if(c!==undefined){this.getLinkedContext().setValue(c,f[g]);}}}else{if(f[g]){this._savedPageNum=f[g];}}}}}},_onBeforeRenderActions:function(){return true;},_hideLoadingIndicator:function(){if(!this._ajaxLoader){this._ajaxLoader=this._container.find(".ws-browser-ajax-loader");}this._ajaxLoader.addClass("ws-hidden");},_processPaging:function(){var b=this._currentRecordSet.hasNextPage();if(this._pageChangeDeferred){this._pageChangeDeferred.callback([this._currentRecordSet.getPageNumber()+1,b,b]);this._pageChangeDeferred=undefined;}else{if(this._paging&&this._paging instanceof Object){this._paging.update(undefined,b,b);}}},_reloadAfterRecordsChange:function(b){this._currentRecordSet.updatePages();this._currentRecordSet.reload();},_updateAfterRecordsDelete:function(b){this._notify("onRecordsChanged");if(this._options.display.reload){this._reloadAfterRecordsChange(b);}},_onRecordDeleted:function(d,c,b){if(this._isFakeDelete!==true&&!this._isGroupDelete){delete this._selectedRecords[this._selected[c]];delete this._selected[c];this._updateAfterRecordsDelete(b?[b]:[]);}if(this._isFakeDelete===true){this._isFakeDelete=false;}},_isIdEqual:function(c,b){if(c===undefined||b===undefined){return false;}if(c=="null"){c=null;}if(b=="null"){b=null;}return c==b;},_onRecordUpdated:function(c,b){this._minimized=false;this._initialRecordSet=false;if(this._isUpdatingRecords||this._notifyOnAfterInsert(b)){return;}this._notify("onRecordsChanged");if(this._options.display.reload){this.reload();}else{this._drawBody();}},_notifyOnAfterInsert:function(d){var f=this;if(this._updateRecordMethodName=="Insert"){var g=f.getRecordSet(),c;c=f._notify("onAfterInsert",d);if(c){f._isUpdatingRecords=true;f._updateRecordMethodName=false;var e=g.getRecordCount(),b=c===true?e:(c.position?c.position:c),h=c.record?c.record:d;if(e>=b){g.clearRecord(g.getRecords()[e-1].getKey());g.insertAfter(g.getRecords()[b-1-(e===b?1:0)].getKey(),h);}f.refresh();f._isUpdatingRecords=false;return true;}}return false;},_getNodeForRecordUpdate:function(){return null;},_applySorting:function(){if(this._currentRecordSet&&this._currentRecordSet instanceof $ws.proto.RecordSet){var d=[];for(var e=0,b=this._sortingStack.length;e<b;++e){d.push();}this._currentRecordSet.setPage(0,true);this._currentRecordSet.setSorting(d,false);}},_initEvents:function(){var b=this,c;var e=this._createBatchUpdateWrapper("DataViewAbstract.clickHandler",function(h){if(b._dropped){h.stopPropagation();return true;}var n=$(this),p=n.closest("tr[rowkey]"),i=p.attr("rowkey"),g=p.hasClass("ws-browser-folder")?b._options.editBranchMode:b._options.editMode,j=i&&b._currentRecordSet.contains(i)?b._currentRecordSet.getRecordByPrimaryKey(i):undefined,l=h.target;b._onClickHandler(h);if(b.isEnabled()){var m=n.attr("coldefindex")?parseInt(n.attr("coldefindex"),10):undefined,o=undefined,k=undefined,f=(l.tagName==="A"&&!($(l).hasClass("ws-browser-edit-link")||$(l).hasClass("ws-browser-link"))&&(l.href!==""||l.href!=="#"));if(m!==undefined&&b._columnMap&&m>=0){o=b._columnMap[m].title;k=b._columnMap[m].field;}if(h.type==="dblclick"){b._dblClickHandler.apply(b,[p,j,o,k,f]);}else{b._oneClickHandler.apply(b,[p,j,o,k,f]);}}return f||g=="thisWindow";},true);var d=$("tr[rowkey] > td",b._body.parent()[0]).live("mousedown",function(){if(b.isEnabled()){b.setActiveElement($(this).closest("tr"),false,true,true);}});d.wsFixedLiveClick2(e,e);},_onScrollActions:function(){},getFiltersDialogName:function(){return this._options.filterDialogTemplate;},createFiltersDialog:function(e,f){var b=this,c={onAfterClose:$.proxy(b._mouseMonitor,b)},d={};if(f){d=b._columnMap[f];}if(!e){e=this._options.filterDialogTemplate;}else{c.onBeforeApplyFilter=function(k,i){var j={},g=b.getQuery(),l=d.title;if(!Object.isEmpty(d)){if(!Object.isEmpty(i)){for(var h in i){if(i.hasOwnProperty(h)){if(h===l){j[h]=i[h];break;}}}j=$ws.core.merge(g,j);}else{if(g[l]){delete g[l];j=g;}}}k.setResult(j);};}this._useKeyboard=true;$ws.core.attachInstance("SBIS3.CORE.FiltersWindow",{template:e,context:new $ws.proto.Context().setPrevious(b.getLinkedContext()),linkedBrowsers:[this.getId()],handlers:c});},_drawBody:function(){var b=BOOMR.plugins.WS.startSpan(["DataViewAbstract._drawBody",this._methodName].join("?"));this._beforeDrawActions();if($ws.proto.RecordFloatArea&&this._isRecordFloatAreaOpen instanceof $ws.proto.RecordFloatArea){if(this._forcedHideArea()||!this._currentRecordSet.contains(this._isRecordFloatAreaOpen.getRecord().getKey())){this._isRecordFloatAreaOpen.hide();}}this._drawBodyCycle();if(this._options.useSelection===false){this._data.addClass("ws-browser-selection-none");}if(this._options.mode==="oneClickMode"){this._data.addClass("ws-one-click-browser");}this._data.toggleClass("ws-browser-hasZebra",!!this._options.display.hasZebra);if(this._count===0&&this.isActive()){this._data.focus();}this._hideLoadingIndicator();if(this._currentRecordSet.isInit()){this._head.removeClass("ws-hidden");if(!this._emptyDataText){this._emptyDataText=true;if(this._currentRecordSet.isEmptyTable()){this._emptyDataBlock.html(this._options.display.emptyTableHtml);this._head.toggleClass("ws-hidden",this._count!==0);}else{this._emptyDataBlock.html(this._options.display.emptyHtml);}}else{if(this._currentRecordSet.isEmptyTable()){this._emptyDataBlock.html(this._options.display.emptyTableHtml);this._head.toggleClass("ws-hidden",this._count!==0);}}this._emptyDataBlock.toggleClass("ws-hidden",this._count!==0);this._foot.toggleClass("ws-hidden",this._count===0&&!!this._emptyDataBlock.html());}this._rootElement.height("auto");this._heightChangedIfVisible();this._updateSelection();b.stop();this._runBatchDelayedFunc("drawBody.onAfterRender",function(){if(this._notify("onAfterRender")===true){this._heightChangedIfVisible();}});},_beforeDrawActions:function(){},_forcedHideArea:function(){return false;},_contentHeightChanged:function(){this._setHeight();},_drawBodyCycle:function(){throw new Error("DataViewAbstract::_drawBodyCycle must be implemented in child classes");},_reloadBody:function(){this._drawBody();},_updateSelection:function(){if(this._hovered||!this._hovered&&!this._options.useHoverRowAsActive&&this._options.setCursorOnLoad){var b=this._body.find(this._hovered?'[rowkey="'+this._hovered+'"]':":first");if(b.length!=1||b.hasClass("ws-hidden")){b=this._body.find(":first");}if(b.length===0){this._activeElement=undefined;this._hovered=undefined;this._notifySetCursor(undefined,undefined);}else{this.setActiveElement(b);}}},_notifySetCursor:function(c,b){if(!this._rowSelectionSetted){this._notifyBatchDelayed("onSetCursor",c,b);}else{this._rowSelectionSetted=false;}},_drawFooter:function(){if(!this._footerDrawed){this._footerDrawed=true;if(this._options.display.showRecordsCount){if(this._options.display.usePaging&&this._options.display.usePageSizeSelect){this._pageOptions=this._pageOptions.concat($ws._const.Browser.pageSizes);var b=this;this._insertPageCount(this._options.display.recordsPerPage);(this._pageOptionsDropdown=new $ws.proto.Deferred()).dependOn($ws.core.attachInstance("Control/Field:FieldDropdown",{element:this._container.find(".ws-browser-pager-select"),width:"100%",data:{keys:this._pageOptions,values:this._pageOptions},wordWrap:false,allowChangeEnable:this._options.allowChangeEnable,context:new $ws.proto.Context().setPrevious(b.getLinkedContext()).setValue("page-select-dropdown"+b._id,b._options.display.recordsPerPage),name:"page-select-dropdown"+b._id,value:b._options.display.recordsPerPage,handlers:{onChange:function(){b._setPageSize(this.getValue());}}}).addCallback(function(c){c.setEnabled(true);b._foot.find(".ws-browser-pager").removeClass("ws-hidden").bind("click",function(d){b._foot.find(".custom-select-arrow").click();d.stopImmediatePropagation();return true;});return c;}));}}}},isHierarchyMode:function(){return false;},_elementActivated:function(d,e){var c=this.getActiveRecord(d);if(c instanceof $ws.proto.Record){e=e?e:false;if(this._selectMode&&!e){this.confirmSelection([c]);return;}var b=this._notify("onRowActivated",d,c);if(b!==false){this._showDialogForRecord(c);}}},_showDialogForRecord:function(b){this._showRecordDialog({recordId:b.getKey()});},_dblClickHandler:function(g,e,c,b,f){var d=this._handlersNotifier("onRowDoubleClick",g,e,c,b);if(!f&&d!==false&&this._options.mode!=="oneClickMode"){this._elementActivated(g);}return d;},_oneClickHandler:function(g,e,c,b,f){var d=this._handlersNotifier("onRowClick",g,e,c,b);if(!f&&d!==false&&this._options.mode==="oneClickMode"){this._elementActivated(g);}return d;},_handlersNotifier:function(e,f,d,c,b){if(e==="onRowDoubleClick"){$ws.helpers.clearSelection();}this._notifySetCursor(f,d);return this._notify(e,f,d,c,b);},_processElementClick:function(d,c,b){this._notifySetCursor(d,b);},_insertRecordItem:function(){this._showRecordDialog({parentId:null});},_editRecord:function(){this._elementActivated(this.getActiveElement(),true);},_getHandlersForDeleteRecordDialog:function(e,c){var d={},b=this;d.onConfirm=function(g,y){if(y){var n=c.length,q=new $ws.proto.ParallelDeferred({stopOnFirstError:false}),x={},r=[],t=false,h=function(j,i){if(x[j.message]===undefined){x[j.message]=1;}else{x[j.message]++;}r.push(i);},w={},f=[],m=[];b._isGroupDelete=true;for(var o=b._recordsOpened.length-1;o>=0;--o){var k=false,s,v=b._recordsOpened[o];try{s=v.win.location.href;s=s.substr(0,s.search(/\?/));s=s.substr(s.search(/[^\/]\/[^\/]/)+2);k=s===v.url;}catch(u){}if(!k){b._recordsOpened.splice(o,1);}else{w[v.rec]=true;}}for(var p=0;p<n;p++){if(b._notify("onBeforeDelete",c[p])!==false){t=true;(function(i){if(w[i]){h({message:"Запись уже открыта в другой вкладке"},i);return;}m.push(c[p]);q.push(c[p].destroy().addCallback(function(j){f.push(i);return j;}).addErrback(function(j){h(j,i);j.processed=true;return j;}));})(c[p].getKey());}else{r.push(c[p].getKey());}}q.done();q.getResult().addBoth(function(){b._isGroupDelete=false;if(!Object.isEmpty(x)){var j="В процессе удаления возникли ошибки: \n ";for(var l in x){j+=l+(c.length===1?"":" ("+x[l]+")\n");}$ws.core.alert(j,"error");}if(r.length!==0){b._activeElement=b._body.find('[rowkey="'+r[0]+'"]');b.clearSelection(r,true);}else{var i=c[n-1]?b._body.find('[rowkey="'+c[n-1].getKey()+'"]'):null;if(c[n-1]&&i.next().length!==0){b._activeElement=i.next();}else{var z=b._body.find('[rowkey="'+c[0].getKey()+'"]');b._activeElement=z.prev();}}if(f.length>0){b._updateAfterRecordsDelete(m);b._showEmptyDataBlock();}b.clearSelection(f,true);});}};d.onAfterClose=function(){b._mouseMonitor.apply(b);var f=b.getActiveElement();if(f){f.focus();}};return d;},_deleteRecords:function(j,d){if(this._options.display.readOnly||this._options.allowDelete===false){return;}if((!Object.isEmpty(this._selected)||this.getActiveRecord()!==false)||d!==undefined){var k=this,i=k.getSelection(true),f=i.length,l=!j&&f?("Удалить "+(f==1?" отмеченную запись":" отмеченные записи")+"?"):"Удалить текущую запись?",h=!j&&f?((f>1?"отмечено ":"отмечена ")+f+" запис"+$ws.helpers.wordCaseByNumber(f,"ей","ь","и")):"",g=false,c,b,e;if(!f||j===true){g=d===undefined?this.getActiveRecord():this._currentRecordSet.getRecordByPrimaryKey(d);}e=function(m){$ws.core.setCursor(false);k._useKeyboard=true;$ws.core.attachInstance("SBIS3.CORE.DialogConfirm",{resizable:false,detail:h,message:m?m:l,context:new $ws.proto.Context().setPrevious(k.getLinkedContext()),handlers:k._getHandlersForDeleteRecordDialog(j,c,null)}).addBoth(function(n){$ws.core.setCursor(true);return n;});};c=j===true?[g?g:this.getActiveRecord()]:this.getSelection();this._onDeleteStartHandler(e,c);}},deleteRecordsByFilter:function(f,e){var g=new $ws.proto.Deferred();if(!this.isReadOnly()&&this._options.allowDelete!==false){var d=this,b=f?f:this.getQuery(),c=function(h){d.getRecordsCount().addCallback(function(i){if(i!==0){$ws.core.attachInstance("SBIS3.CORE.DialogConfirm",{resizable:false,message:h?h:"Удалить "+(i?i:"")+" запис"+(i?$ws.helpers.wordCaseByNumber(i,"ей","ь","и"):"и")+"?",detail:"Внимание: данные удаляются окончательно без возможности восстановления",handlers:{onConfirm:function(k,j){if(j){d.getRecordSet().deleteRecordsByFilter(b,e).addCallback(function(){g.callback(true);});}else{g.callback();}}}});}});};this._onDeleteStartHandler(c,b);}return g;},deleteSelectedRecords:function(d){var f=[],h=d?d:this.getSelection(),b=h.length,e=new $ws.proto.Deferred,c=this,g;g=function(i){$ws.helpers.question(i?i:"Удалить отмеченные записи?").addCallback(function(k){if(k){for(var j=0;j<b;j++){f.push(h[j].getKey());}var l=c._notify("onBeforeDelete",h);if(l!==false){if(l instanceof Array){f=l;}c.getRecordSet().deleteRecord(f).addCallback(function(){e.callback(true);});}else{e.callback();}}});};this._onDeleteStartHandler(g,h);return e;},_onDeleteStartHandler:function(d,b){var c=this._notify("onDeleteStart",b);if(typeof c=="string"){d.apply(this,[c]);}else{if(c instanceof $ws.proto.Deferred){c.addCallback(d);}else{if(c!==false){d.apply(this);}}}},getPagingMode:function(){return this._options.display.usePaging;},getRecordsCount:function(){var b=new $ws.proto.Deferred(),d=this.getQuery(),f=this.getDataSource().readerParams,c=this.getRecordSet();if(this.getPagingMode()==="parts"&&!(c.getPageNumber()===0&&!c.hasNextPage())){var e=new $ws.proto.BLObject(f.linkedObject);e.query(f.queryName||"Список",d,{type:"full",page:0,pageSize:0}).addCallbacks(function(g){b.callback(g.getRecordCount()!==0?g.hasNextPage():undefined);},function(g){b.errback(g.message);});}else{if(this.getPagingMode()==="full"){b.callback(c.hasNextPage());}else{b.callback(c.getRecordCount());}}return b;},clearSorting:function(){if(!this._sortingStack.length){return;}this._head.find(".ws-browser-sortable").removeClass("asc").removeClass("desc").addClass("none");this._sortingStack=[];this._currentRecordSet.setPage(0,true);this._currentRecordSet.setSorting([],this.getQuery(),false);},_isCtrl:function(b){return b.ctrlKey&&!b.altKey&&!b.shiftKey;},_isNotModified:function(b){return !b.ctrlKey&&!b.altKey&&!b.shiftKey;},_mouseMonitor:function(){var b=this,c=function(){b._useKeyboard=false;$("[rowkey]",b._body.parent()[0]).die("mousemove",c);};$("[rowkey]",b._body.parent()[0]).live("mousemove",c);},_keyboardHover:function(f){var g=false,k=this;if(!this._currentRecordSet||!this._currentRecordSet.isLoaded()){return g;}if(this.isActive()){var i=this.getActiveElement(),h=i?i.next(".ws-visible:first"):[],j=i?i.prev(".ws-visible:first"):[],d=h.length>0?h:null,c=j.length>0?j:null;if(f.ctrlKey&&f.which===$ws._const.key.space){if(!this._minimized){this.showSelection(true);}else{this.showSelection(false);}}else{if(this._isNotModified(f)&&(f.which===$ws._const.key.f5||f.which===$ws._const.key.pageUp||f.which===$ws._const.key.pageDown)){g=true;}else{if(this._isCtrl(f)&&f.which===$ws._const.key.n){this.reload();}else{if(this._isNotModified(f)&&f.which===$ws._const.key.minus){this.removeSelection();}else{if(this._isCtrl(f)&&f.which===$ws._const.key.q){if(this._options.filterDialogTemplate){this.createFiltersDialog();}}else{if(f.which===$ws._const.key.enter&&(this._selectMode||f.ctrlKey)&&!f.altKey&&!f.shiftKey){this.confirmSelection();}else{if(this._isCtrl(f)&&(f.which===$ws._const.key.pageDown||f.which===$ws._const.key.pageUp)){this.setActiveElement(this._body.find(".ws-visible:"+((f.which===$ws._const.key.pageDown)?"last":"first")));f.stopPropagation();f.preventDefault();}else{if(this._isNotModified(f)&&(f.which===$ws._const.key.down||f.which===$ws._const.key.up)){if(this._options.useHoverRowAsActive&&!this._useKeyboard){this._useKeyboard=true;this._mouseMonitor();}var b=(f.which===$ws._const.key.down)?d:c;if(b){this.setActiveElement(b);if(this._options.useHoverRowAsActive){k._showRowOptions.apply(k,[b[0]]);}}}else{if(this._isNotModified(f)&&f.which===$ws._const.key.space){if(this._options.useSelection!==false){if(!(this._options.multiSelect===false&&!Object.isEmpty(this._selected))||this._activeElement.hasClass("ws-browser-selected")){this._selectActiveElement();}this.setActiveElement(d);}}else{if(this._isNotModified(f)&&f.which===$ws._const.key.esc){g=true;}}}}}}}}}}}else{g=true;}return g;},_initKeys:function(){this._registerShortcut($ws._const.key.del,$ws._const.modifiers.nothing,this._deleteRecordsKey);this._registerShortcut($ws._const.key.insert,$ws._const.modifiers.nothing,this._insertRecordKey);this._registerShortcut($ws._const.key.f3,$ws._const.modifiers.nothing,this._editCurrentRow);this._registerShortcut($ws._const.key.enter,$ws._const.modifiers.nothing,this._enterKey);},_deleteRecordsKey:function(){if(!this.isReadOnly()&&this.isEnabled()){this._deleteRecords(false);}},_insertRecordKey:function(){var b=this._actions.addItem;if(this.isEnabled()&&b&&!this.isReadOnly()){b(this.getActiveElement(),false);}},_editCurrentRow:function(){var b=this.getActiveRow();if(this.isEnabled()&&b){this._elementActivated(b,true);return false;}return true;},_enterKey:function(){return this._editCurrentRow();},_prepareCreateFilter:function(){return $ws.core.merge({},this.getQuery());},_readRecord:function(d){var c=this;if(d===undefined){var f=c._prepareCreateFilter.apply(c,arguments),b=c._notify("onBeforeCreate",null,null,f);if(b instanceof $ws.proto.Deferred){var g=new $ws.proto.Deferred();b.addCallbacks(function(h){if(h instanceof $ws.proto.Record){g.callback(h);}else{if(h&&Object.prototype.toString.call(h)=="[object Object]"){f=$ws.core.merge(f,h);}f["ВызовИзБраузера"]=true;c._currentRecordSet.createRecord(f).addCallbacks(function(i){g.callback(i);},function(i){g.errback(i);return i;});}},function(h){g.errback(h);return h;});return g;}else{if(b instanceof $ws.proto.Record){return new $ws.proto.Deferred().callback(b);}else{if(b&&Object.prototype.toString.call(b)=="[object Object]"){f=$ws.core.merge(f,b);}f["ВызовИзБраузера"]=true;return c._currentRecordSet.createRecord(f);}}}else{var e=c._notify("onBeforeRead",d);if(e instanceof $ws.proto.Deferred){return e;}else{if(e instanceof $ws.proto.Record){return new $ws.proto.Deferred().callback(e);}else{return c._currentRecordSet.readRecord(d);}}}},_checkShowDialog:function(b){return(this._options.display.readOnly&&!b)||(b===undefined&&this._options.allowAdd===false);},_showRecordDialog:function(c){if(this._checkShowDialog(c.recordId)){return;}var d=this._options.editMode,b=this._options.editDialogTemplate;if(b!==""){this._editRecordWithMode(c,d,b,this._options.editFullScreenTemplate);}},_editRecordWithMode:function(d,f,c,e){var b=this._notify("onSelectEditMode",d.recordId,d.isBranch||false,d.parentId||null,f);if(typeof(b)=="string"&&b in {newDialog:0,newWindow:0,thisWindow:0,thisPage:0,newFloatArea:0}){f=b;}if(f=="newWindow"||f=="thisWindow"){this._openEditWindow(d,undefined,f);}else{if(f=="thisPage"){this._editRecordInThisPage(d,c);}else{this._useKeyboard=true;this._showDialogForRecordId(d,c,f=="newFloatArea"?"RecordFloatArea":"DialogRecord",e);}}},_editRecordInThisPage:function(d,c){var b=this.getTopParent();$ws.single.GlobalContext.setValue("editParams",this._generateEditPageURL(d));if(b instanceof SBIS3.CORE.AreaAbstract){$ws.core.bootup(c,undefined,undefined,b.getTemplateName());}},_getRecordFromConfig:function(b){return this._readRecord(b.recordId);},_showDialogForRecordId:function(g,d,f,e){var c=this,b;$ws.core.setCursor(false);this._toggleIndicator(f==="RecordFloatArea",true);(function(){var i=new $ws.proto.Deferred(),h=c.getTopParent();i.addCallback(function(){return c._getRecordFromConfig.apply(c,[g]);});if(h instanceof $ws.proto.AreaAbstract){h.waitAllPendingOperations(i);}else{i.callback();}return i;})().addBoth(function(h){$ws.core.setCursor(true);return h;}).addCallback(function(h){c._updateRecordMethodName=(g.recordId===undefined?"Insert":"Update");b=c._notify("onBefore"+c._updateRecordMethodName,h);if(typeof(b)!=="boolean"){if(typeof(b)=="string"){d=b;}else{if(typeof(b)=="object"){d=b.editTemplate;e=b.editFullScreenTemplate?b.editFullScreenTemplate:e;}}c._showDialog(d,h,g.recordId,f,e);}else{c._toggleIndicator(f==="RecordFloatArea",false);if(g.recordId===undefined&&b===false&&h.getKey()!==null){c._isFakeDelete=true;h.destroy();}}}).addErrback(function(i){c._toggleIndicator(f==="RecordFloatArea",false);var j=c._options.dataSource.readerParams,h=j.linkedObject+".";if(g.recordId===undefined){h+=(j.createMethodName||"Создать");}else{h+=(j.readMethodName||"Прочитать");}if(i&&i.message&&this._notify("onLoadError",i,h)!==true){$ws.core.alert(i.message,"error");}i.processed=true;return i;});},_toggleIndicator:function(c,b){if(c===true){this._ajaxLoader.toggleClass("ws-hidden",!b);}else{$ws.helpers.toggleIndicator(b);}},_onAfterCloseRecordDialog:function(g,e,c,f){this._mouseMonitor.apply(this);var h=this.getActiveElement();if(h){h.focus();}if(!g&&e===undefined&&c.getKey()!==null){this._isFakeDelete=true;c.destroy();}else{if(f!==null){var d=this,b=function(){this.unsubscribe("onAfterRender",b);var i=d._body.find('[rowkey="'+f+'"]');if(i.length!==0){this.setActiveElement(i);}};if(this._body.find('[rowkey="'+f+'"]').length!==0){b.call(this);}else{this.subscribe("onAfterRender",b);}}}},_onBeforeSaveRecordDialog:function(c,b){},_showDialog:function(d,g,f,c,k){var l=this,h=false,j=null,b={onAfterClose:function(){if(c==="RecordFloatArea"){if(this===l._isRecordFloatAreaOpen){l._isRecordFloatAreaOpen=false;}l._useKeyboard=false;}l._onAfterCloseRecordDialog(h,f,g,j);},onRecordUpdate:function(o,n){h=true;if(f===undefined){j=n;}l._onBeforeSaveRecordDialog(o,g);},onReady:function(){if(c==="RecordFloatArea"){l._isRecordFloatAreaOpen=this;}else{$ws.helpers.toggleIndicator(false);}}},m={opener:l,template:d,record:g,context:new $ws.proto.Context().setPrevious(l.getLinkedContext()),readOnly:l._options.display.readOnly,isNewRecord:f===undefined,handlers:b},e=false;if(c==="RecordFloatArea"){if(this._isRecordFloatAreaOpen){var i=function(){this.unsubscribe("onDestroy",i);$ws.core.attachInstance("SBIS3.CORE."+(c!==undefined?c:"DialogRecord"),m);};if(this._isRecordFloatAreaOpen.getTemplateName()!==d){e=true;this._isRecordFloatAreaOpen.subscribe("onDestroy",i);this._isRecordFloatAreaOpen.hide();}else{l._ajaxLoader.addClass("ws-hidden");this._isRecordFloatAreaOpen.setRecord(g);return;}}m.name=this.getName()+"-area";m.title="";m.target=this.getParent()===null?this.getContainer():this.getParent().getContainer();m.side="right";m.autoHide=false;m.autoShow=false;m.doNotLossFocus=true;m.showDelay=300;m.animationLength=300;m.parent=null;m.isModal=false;m.handlers.onAfterShow=function(){l._ajaxLoader.addClass("ws-hidden");};m.offset={x:1,y:0};if(k){m.editFullScreenTemplate=k;}}if(!e){$ws.core.attachInstance("SBIS3.CORE."+(c!==undefined?c:"DialogRecord"),m);}},openWindowRecord:function(c,b){this._openEditWindow({recordId:c},b);},_prepareEditParams:function(d){var c=this._options.dataSource.readerParams,b=c.format;if(b!==undefined){d.format=b;}b=this._options.dataSource.readerType;if(b&&b!=="ReaderUnifiedSBIS"){d.type=b;}b=c.otherURL;if(b&&b!==$ws._const.defaultServiceUrl){d.url=b;}b=c.dbScheme;if(b){d.db=b;}b=c.queryName;if(b&&b!=="Список"){d.method=b;}b=c.readMethodName;if(b&&b!=="Прочитать"){d.readMethod=b;}b=c.createMethodName;if(b&&b!=="Создать"){d.createMethod=b;}b=c.updateMethodName;if(b&&b!=="Записать"){d.updateMethod=b;}b=c.destroyMethodName;if(b&&b!=="Удалить"){d.destroyMethod=b;}d._events.onBeforeRead=this._handlersPath("onBeforeRead");d._events.onBeforeUpdate=this._handlersPath("onBeforeUpdate");if(this._options.reports&&!(Object.isEmpty(this._options.reports))){d.reports=this._options.reports;d._events.onBeforeShowPrintReports=this._handlersPath("onBeforeShowPrintReports");d._events.onPrepareReportData=this._handlersPath("onPrepareReportData");d._events.onSelectReportTransform=this._handlersPath("onSelectReportTransform");}return d;},_generateEditPageURL:function(c,b){return this.generateEditPageURL(c.recordId,b);},generateEditPageURL:function(e,c,i,f){if(this._options.editDialogTemplate||this._options.editFullScreenTemplate){var g={id:this.getId(),pk:e,readOnly:this._options.display.readOnly||false,obj:this._options.dataSource.readerParams.linkedObject,_events:{}},d,j=c?c:undefined,k=f?f:((this._options.editFullScreenTemplate&&this._options.editMode=="newFloatArea")?this._options.editFullScreenTemplate:this._options.editDialogTemplate),b=this._options.editMode;if(j===undefined){if($ws._const.htmlNames[k]){var h=$ws._const.htmlNames[k].split("/");j=h[h.length-1];}else{d=$ws._const.xmlContents[k].split("/");j=$ws._const.appRoot+d[d.length-1]+".html";}}if(i){g.changedRecordValues=i;}if(b==="thisWindow"){g.history=true;}if(e===undefined){g.filter=this.getQuery();g._events.onBeforeCreate=this._handlersPath("onBeforeCreate");g._events.onBeforeInsert=this._handlersPath("onBeforeInsert");}g=this._prepareEditParams(g);g=$ws.helpers.serializeURLData(g);j+="?editParams="+encodeURIComponent(g);return b==="thisPage"?g:j;}else{return false;}},_openEditWindow:function(e,c,d){var g=c?c:this._generateEditPageURL(e,c),b=this._notify("onBeforeOpenEditWindow",g),h,f=d||this._options.editMode;if(typeof(b)==="string"){g=b;}if(b!==false){if(f=="thisWindow"){window.location.href=g;}else{h=window.open(g,"_blank");this._recordsOpened.push({rec:e.recordId,url:g.substr(0,g.search(/\?/)),win:h});if(h){h.focus();}}}},scrollToActive:function(b){this._updateBodyHeight();if(this._bodyHeight<this._bodyRealHeight&&b&&"jquery" in b){if(!this._wsBrowserContainer){this._wsBrowserContainer=this._data.parent();}var e=this._wsBrowserContainer.position().top,c=this._wsBrowserContainer[0].clientHeight,d=b.height(),f=this._wsBrowserContainer.scrollTop(),g=f+b.position().top-e;if(g+d>f+c){this._wsBrowserContainer.scrollTop(g+d-c);}else{if(g<f){this._wsBrowserContainer.scrollTop(g);}}}},refresh:function(){if(this._dReady.isReady()&&this._currentRecordSet){this._rowSelectionSetted=false;if(this._onBeforeRenderActions()){this._drawBody();}}},reload:function(){this._useKeyboard=false;var b=this.getQuery(true);return this._runQuery(b,true);},clear:function(){var b=this.getRecordSet();if(b.getRecordCount()!==0){b.clear();this.refresh();this.getPaging().addCallback(function(c){c.update(undefined,0);return c;});this._updatePager();this.removeSelection();}},performFunction:function(f){var g=this.getSelection(),e=new $ws.proto.ParallelDeferred(),c=this;c._isUpdatingRecords=true;for(var d=0,b=g.length;d<b;d++){e.push(f(g[d]));}e.done();e.getResult().addCallback(function(){c._isUpdatingRecords=false;c.reload();});},getActiveElement:function(){if(this._options.useHoverRowAsActive===true){var b=this._body.find("[rowkey].ws-browser-row-selected");return b.length>0?b:false;}else{if(this._activeElement){return this._activeElement;}else{return false;}}},setActiveElement:function(f,c,b,e){if((f===null||f===undefined)&&this._activeElement&&!this._options.setCursorOnLoad){this._activeElement.removeClass("ws-browser-item-over");this._activeElement=undefined;this._hovered=undefined;}if(this._options.useSelection!==false&&f&&"jquery" in f&&f.length>0&&(this._activeElement&&this._activeElement[0]!==f||!this._activeElement)&&f.closest(".ws-browser")[0]==this._data[0]){if(this._activeElement){this._activeElement.removeClass("ws-browser-item-over");}f.addClass("ws-browser-item-over");this._setSelection(f,false);f.attr("tabindex","-1");if(c!==false){if(this.isActive()){f.focus();}this.scrollToActive(f);}this._activeElement=f;this._hovered=f.attr("rowKey")!=="null"?f.attr("rowKey"):null;var d=this._hovered?this.getActiveRecord():null;if(!b){this._notifySetCursor(this._activeElement,d);}this._changeState(e);}},_setSelection:function(b,c){this._container.find(".ws-browser-row-selected").removeClass("ws-browser-row-selected");b.addClass("ws-browser-row-selected");},destroy:function(){if(this._paging&&this._paging.destroy){this._paging.destroy();}if(this._pageOptionsDropdown){this._pageOptionsDropdown.addCallback(function(b){b.destroy();});}if($ws.proto.RecordFloatArea&&this._isRecordFloatAreaOpen instanceof $ws.proto.RecordFloatArea){this._isRecordFloatAreaOpen.destroy();}if(this._parent){this._parent.unsubscribe("onReady",this._dataBindHandler);}if(this._setDataHandler){this._parent.unsubscribe("onReady",this._setDataHandler);}if(this._currentRecordSet!==null){this._currentRecordSet.abort();}if(this._scrollGapPlaceholder){this._scrollGapPlaceholder=null;}if(this._ajaxLoader){this._ajaxLoader=null;}$ws.proto.DataViewAbstract.superclass.destroy.apply(this,arguments);},_selectRow:function(f){var j=this._body.find('[rowkey="'+f+'"]'),g=this._body.find(".ws-browser-table-row"),h=this._head.find(".ws-browser-checkbox").closest("tr"),d=true;j.addClass("ws-browser-selected");j.find(".ws-browser-checkbox").css("border","none");if(this._selected[f]===undefined){var c=this._currentRecordSet.contains(f)?this._currentRecordSet.getRecordByPrimaryKey(f):undefined;this._selected[f]=this._selectedRecords.length;this._selectedRecords.push(c);this._notifyBatchDelayed("onChangeSelection",c,true);}for(var e=0,b=g.length-1;e<=b;e++){if(!$(g[e]).hasClass("ws-browser-selected")){d=false;break;}}if(d&&!h.hasClass("ws-browser-selected")){h.addClass("ws-browser-selected");}},_unselectRow:function(c){var e=this._body.find('[rowkey="'+c+'"]'),d=this._head.find(".ws-browser-selected");e.removeClass("ws-browser-selected");if(this._selected[c]!==undefined){var b=this._currentRecordSet.contains(c)?this._currentRecordSet.getRecordByPrimaryKey(c):undefined;delete this._selectedRecords[this._selected[c]];delete this._selected[c];this._notifyBatchDelayed("onChangeSelection",b,false);}if(d.length!==0){d.removeClass("ws-browser-selected");}},toggleColumn:function(h,c){var b=[],f=this._initialColumns,d=0;for(var e in f){if(f.hasOwnProperty(e)){var g=f[e];if(g.field===h){g.show=c;}if(g.show!==false){b[d]=g;d++;}}}this.setColumns(b);},_toggleRowSelection:function(b){if(this._selected[b]===undefined){this._selectRow(b);}else{this._unselectRow(b);}},_selectActiveElement:function(c){var d=c||this.getActiveElement(),b=d.attr("rowkey");b=b==="null"?null:b;this._toggleRowSelection(b);this._updatePager();},getSelection:function(g){var d=[];g=g===undefined?false:g;if(Object.isEmpty(this._selected)&&g!==true){var b=this.getActiveRecord();if(b){d.push(b);}}else{for(var c in this._selected){if(this._selected.hasOwnProperty(c)){try{d.push(this._currentRecordSet.getRecordByPrimaryKey(c));}catch(f){}}}}return d;},setSelection:function(f){var h=[];if(f instanceof Array){h=f;}else{if(typeof(f)==="string"||typeof(f)=="number"){h.push(f);}}if(h.length>=1){var d=[];for(var g=0,c=h.length;g<c;g++){try{var b=this._currentRecordSet.getRecordByPrimaryKey(h[g]);this._selected[h[g]]=this._selectedRecords.length;this._selectedRecords.push(b);d.push(b);}catch(j){this._selectedRecords.push(undefined);}this._body.find('[rowkey="'+h[g]+'"]').addClass("ws-browser-selected");}this._notifyBatchDelayed("onChangeSelection",d,true);}if(h[0]!==undefined){this.setActiveElement(this._body.find('[rowkey="'+h[0]+'"]'),false);}else{if(this._activeElement&&!this._options.setCursorOnLoad){this._activeElement.removeClass("ws-browser-item-over");this._hovered=undefined;}}this._updatePager();},clearSelection:function(k,h){var m,f,n=[];if(k instanceof Array){n=k;}else{if(typeof(k)==="string"||typeof(k)=="number"){n.push(k);}}if(n.length>=1){var b=[];for(var e=0,c=n.length;e<c;e++){delete this._selected[n[e]];for(var d=0,g=this._selectedRecords.length;d<g;d++){if(this._selectedRecords[d]!==undefined){m=this._selectedRecords[d].getKey();if(m==n[e]){b.push(this._selectedRecords[d]);f=d;break;}}}if(f!==undefined){this._selectedRecords.splice(f,1);}this._body.find('[rowkey="'+n[e]+'"]').removeClass("ws-browser-selected");}if(!h){this._notifyBatchDelayed("onChangeSelection",b,false);}}this._head.find("tr:first").removeClass("ws-browser-selected");this._updatePager();},removeSelection:function(){this._selected={};this._selectedRecords=[];this._container.find(".ws-browser-selected").removeClass("ws-browser-selected");this._notifyBatchDelayed("onChangeSelection",null,false);this._updatePager();},showSelection:function(b){var e=this.getSelection(),c=this._foot.find(".ws-browser-dropdown-container"),j=this;if(b===undefined){b=true;}if(b!==false){if(!this._minimized){this._initialRecordSet=this._initialRecordSet||this._currentRecordSet;$ws.core.setCursor(false);var f=$ws.core.merge({},this._options.dataSource),h=this.getSelection(true).length,d="Выбра"+$ws.helpers.wordCaseByNumber(h,"но","на","ны")+" "+h+" запис"+$ws.helpers.wordCaseByNumber(h,"ей","ь","и")+".";$ws.core.attachInstance("Source:RecordSet",$ws.core.merge(f,{firstRequest:false},{preferSource:true})).addCallback(function(n){n.setColumns(j._currentRecordSet.getColumns());for(var m=0,k=e.length;m<k;m++){n.appendRecord(e[m]);}$ws.core.setCursor(true);j._minimized=true;j.setData(n);j.removeSelection();}).addErrback(function(k){$ws.core.setCursor(true);$ws.core.alert(k.message,"error");});this._foot.find(".ws-browser-pager-text").text(d);if(this._paging){c.addClass("ws-hidden");}}}else{if(this._minimized){if(this._initialRecordSet instanceof $ws.proto.RecordSet){var i=[],g=this.getActiveRecord().getKey();this._currentRecordSet.each(function(k){i.push(k.getKey());});this.removeSelection();this.setData(this._initialRecordSet);this.setSelection(i);this.setActiveElement(this._body.find('[rowkey="'+g+'"]'));this._initialRecordSet=false;}this._minimized=false;if(this._paging){c.removeClass("ws-hidden");}}}},isMinimized:function(){return this._minimized;},confirmSelection:function(b){b=b||this.getSelection();var d=[];for(var c in b){if(b.hasOwnProperty(c)&&this._testSelectedRecord(b[c])){d.push(b[c]);}}if(d&&d.length>0){this._notifyBatchDelayed("onSelectionConfirm",d);}else{this._notifyBatchDelayed("onSelectionConfirm",[null]);}},_testSelectedRecord:function(b){return true;},_selectRecords:function(d,c){var g=d.find("tr");this._selectedRecords=c;for(var b=0,f=c.length;b<f;b++){this._selected[c[b].getKey()]=b;}for(var e=0;e<g.length;++e){g.eq(e).addClass("ws-browser-selected");}},selectAll:function(){var b=new $ws.proto.Deferred(),c=this;this._selected={};this._selectedRecords=[];if(this._options.display.usePaging==="full"&&this._currentRecordSet.getRecordCount()<this._currentRecordSet.hasNextPage()||this._options.display.usePaging==="parts"&&this._currentRecordSet.hasNextPage()){var d=$ws.core.merge({},this.getDataSource());d.usePages="";d.firstRequest=true;d.handlers={onAfterLoad:function(){c._selectRecords(c._body,this.getRecords());b.callback();}};$ws.core.attachInstance("Source:RecordSet",d);}else{this._selectRecords(this._body,this._currentRecordSet.getRecords());b.callback();}b.addCallback(function(e){c._notifyBatchDelayed("onChangeSelection",c._selectedRecords,true);c._updatePager();return e;});return b;},selectCurrentPage:function(){this._selected=[];this._selectedRecords=[];this._selectRecords(this._body,this._currentRecordSet.getRecords());this._notifyBatchDelayed("onChangeSelection",this._selectedRecords,true);this._updatePager();},invertSelection:function(){var g=[],d=this,j=this.getSelection(true),h=function(k,i){if(k.length){if(i){this.removeSelection();}else{this.clearSelection(k,true);}}this._notifyBatchDelayed("onChangeSelection",this._selectedRecords,true);this._updatePager();};for(var f=0,b=j.length;f<b;f++){g.push(j[f].getKey());}var e=g.length,c=e===this._currentRecordSet.getRecordCount();if(e===0||!c){this.selectAll().addCallback(function(){h.apply(d,[g,c]);});}else{h.apply(d,[g,c]);}},getActiveRecord:function(d){d=d||this.getActiveElement();if(!d){return false;}var b=false,c=d.attr("rowkey");if(c!==undefined&&this._currentRecordSet.contains(c)){b=this._currentRecordSet.getRecordByPrimaryKey(c);}return b;},_updatePager:function(){if(this._currentRecordSet){var j=this._count===0?this._currentRecordSet.getRecordCount():this._count;var d="";if(this._options.display.showRecordCountForEmptyData||(!this._options.display.showRecordCountForEmptyData&&this._currentRecordSet.getRecordCount()>0)){if(this._options.display.showRecordsCount){if(this._options.display.usePaging){var o=this._options.display.usePaging==="full"?(" из "+this._currentRecordSet.hasNextPage()):"",h=this._currentRecordSet.getPageNumber(),k=h*this._options.display.recordsPerPage+1;if(j===0){d="0 записей";}else{if(j===1&&h===0){d="1 запись";}else{d="Записи с "+k+" по "+(k+j-1)+o;}}}else{d+=d===""?"Всего : ":". Всего : ";d+=j;}}}var c=0;for(var f=0,g=this._selectedRecords.length;f<g;++f){if(this._selectedRecords[f]){++c;}}if(c>0){d="Выбра"+$ws.helpers.wordCaseByNumber(c,"но","на","ны")+" "+c+" запис"+$ws.helpers.wordCaseByNumber(c,"ей","ь","и")+". "+d;}if(this._pageOptionsContainer){this._pageOptionsContainer.toggleClass("ws-hidden",!(j>1||this._currentRecordSet.getPageNumber()!==0));}this._foot.find(".ws-browser-pager").removeClass("ws-hidden");this._rootElement.find(".ws-browser-pager-text").text(d);if(!this._paging&&this._options.display.usePaging&&this._options.display.showPaging){var e=this._rootElement.find(".ws-browser-paging");if(e.length){this._rootElement.find(".ws-browser-pager-cont").addClass("ws-browser-has-paging");var b=this._currentRecordSet.hasNextPage()||(this._options.display.usePaging==="full"&&j),p=this,n=e.closest(".ws-browser-foot"),m=n.width(),l=n.height();p._paging=true;if(b===undefined){b=0;}this._pagingReady.dependOn($ws.core.attachInstance("Control/Paging",{recordsPerPage:p._options.display.recordsPerPage,currentPage:this._currentRecordSet.getPageNumber()+1,recordsCount:b,pagesLeftRight:this._options.display.pagesLeftRight,onlyLeftSide:(p._options.display.usePaging==="parts")||(p._options.display.usePaging==="auto"&&typeof(b)=="boolean"),rightArrow:b,element:e,allowChangeEnable:this._options.allowChangeEnable,handlers:{onPageChange:function(i,r,q){p._setPageSave(r);p._pageChangeDeferred=q;p._currentRecordSet.setPage(r-1,false,false);}}})).addCallback(function(i){p._paging=i;p._processPaging();i.setRecordSet(p._currentRecordSet);i.update(p._currentRecordSet.getPageNumber()+1);if(n.width()!==m||n.height()!==l){p._onResizeHandler();}return i;});}}}},_setPageSave:function(b){},_updateSizeVariables:function(){var b=this._data.parent();this._verticalScrollShowed=$ws.helpers.hasVerticalScrollbar(b);this._horizontalScrollShowed=$ws.helpers.hasHorizontalScrollbar(b);this._fixVerticalScrollGap();},_fixVerticalScrollGap:function(){if(this._scrollGapPlaceholder&&this._scrollGapPlaceholder.lastState!==this._verticalScrollShowed){this._scrollGapPlaceholder.lastState=this._verticalScrollShowed;this._scrollGapPlaceholder.toggle(this._verticalScrollShowed);}},_updateBodyHeight:function(){this._bodyHeight=this._data.parent().height();this._bodyRealHeight=this._body.height();},_setHeight:function(f){var e=BOOMR.plugins.WS.startSpan("_setHeight");var g,b,i,h,c=this._isHeightGrowable();g=this._data.parent();i=this._options.minHeight!==0;h=this._options.maxHeight!==Infinity;if(!c||i||h){b=this._getAdditionalHeight()+2;}if(c){g.height("auto");this._container.height("auto");}else{g.height(Math.max(this._container.height()-b,0));}if(h){this._browserContainer.css("max-height",b>this._options.maxHeight?0:(this._options.maxHeight-b));}else{this._browserContainer.css("max-height","");}if(i&&b<=this._options.minHeight){this._browserContainer.css("min-height",this._options.minHeight-b);}else{this._browserContainer.css("min-height","");}this._updateSizeVariables();this._updateDataBlockSize();if(c&&this._verticalScrollShowed&&$ws._const.browser.isIE7){if(this._horizontalScrollShowed){g.height(g.height()+this._scrollWidth);this._updateDataBlockSize();}}if(c){g.height(g.outerHeight()+1);var d=$ws._const.browser;if(d.isIE8||d.isIE7){this._browserContainer.css("overflow-y","hidden");}if(this._resizer){this._resizer.height(this._rootElement.height());}}if(c&&f){this._checkContainerHeightForRecalk();}e.stop();},_getAdditionalHeight:function(){var b=this._foot.height(),c=this._headContainer.height();return b+c;},_onResizeHandler:function(c,d){var b=BOOMR.plugins.WS.startSpan("_onResizeHandler");if(this!==d){this._setHeight(true);}$ws.proto.DataViewAbstract.superclass._onResizeHandler.apply(this,arguments);b.stop();},getRecordSet:function(){return this._currentRecordSet;},setSelectionMode:function(b){this._selectMode=!!b;this._options.display.showSelectionCheckbox=!!b;},getSelectionMode:function(){return this._selectMode;},_rebuildActions:function(){this._initActionsFlags();},setReadOnly:function(b){if(this._options.display.readOnly!=!!b){this._options.display.readOnly=!!b;this._rebuildActions();}},setAllowAdd:function(b){if(this._options.allowAdd!=b){this._options.allowAdd=b;this._rebuildActions();}},setAllowEdit:function(b){if(this._options.allowEdit!=b){this._options.allowEdit=b;this._rebuildActions();}},setAllowDelete:function(b){if(this._options.allowDelete!=b){this._options.allowDelete=b;this._rebuildActions();}},getPaging:function(){return this._pagingReady;},setEnabled:function(b){b=!!b;if(this._options.allowChangeEnable||b===this._options.enable){$ws.proto.DataViewAbstract.superclass.setEnabled.apply(this,arguments);this._rootElement.find(".ws-browser-container").toggleClass("ws-disabled",!b);}},_updateDataBlockSize:function(){},validate:function(){return true;},setSelectionType:function(b){},_showEmptyDataBlock:function(){},_keyboardShortcut:function(c,g){if(!this._currentRecordSet||!this._currentRecordSet.isLoaded()){return false;}var f=g.which;if(f in this._keysActions){var b=this._keysActions[f],d=this._modifiersFromEvent(g);if(d in b){var e=b[d].call(this,g);if(!e){g.stopPropagation();}return e;}}return undefined;},_modifiersFromEvent:function(c){var b=0;if(c.ctrlKey){b+=$ws._const.modifiers.control;}if(c.altKey){b+=$ws._const.modifiers.alt;}if(c.shiftKey){b+=$ws._const.modifiers.shift;}return b;},_registerShortcut:function(g,e,h){if(!this._keysActions[g]){this._keysActions[g]={};}if(e instanceof Array){var b=1<<e.length;for(var f=0;f<b;++f){var c=0;for(var d=0;d<e.length;++d){if((f&(1<<d))){c|=e[d];}}this._keysActions[g][c]=h;}}else{this._keysActions[g][e]=h;}},isTree:function(){return false;},isHierarchy:function(){return false;},setEmptyHtml:function(b){this._emptyDataBlock.html(b);this._emptyDataText=false;},_redraw:function(){}});return $ws.proto.DataViewAbstract;});