$ws.declareModule({namespace:"SBIS3.CORE",name:"FileBrowse",imports:["SBIS3.CORE.FileButton","SBIS3.CORE.LoadingIndicator"]},function(a,b){$ws.proto.FileBrowse=a.extend({$protected:{_fakeButton:undefined,_inputControl:null,_iframe:null,_form:null,_queryInput:null,_applet:null,_appletChooser:null,_appletID:"FileBrowseApplet",_appletIDChooser:"ChooserApplet",_curval:"",_options:{caption:"",method:"",showIndicator:true,otherUrl:"",filterParams:[],queryFilter:{},paramsMapping:{},img:"",imgAlign:"left",extensions:[],rootFolder:"",useJava:false,cssClassName:"ws-field-button ws-browse-file"},_indicator:null,_loading:false,_loadingDef:null,_appletOpen:false},$constructor:function(){this._initFileInput();if(this._options.useJava&&$ws.java.isJavaInstalled()){this._initApplet();}this.setEnabled(this._options.enable);},_initApplet:function(){var c=this;this._putChooserApplet().addCallbacks(function(d){if(!c._isDestroyed){c._applet=d;c.subscribe("onActivated",function(){if(!c._appletOpen){c._appletOpen=true;c._container.addClass("ws-disabled");var e={idControl:c.getId(),rootFolder:c._options.rootFolder||$ws.single.MicroSession.get(c.getName()+"_lastSelectedFile"),extensions:c._options.extensions};d.chooseFile(JSON.stringify(e));}});c._form.css("visibility","hidden");c._notify("onAppletReady",c._id,c._applet);}return d;},function(d){$ws.single.ioc.resolve("ILogger").error("FileBrowse",d.message);c._applet=null;c._notify("onAppletReady",c._id,c._applet,d);return d;});},_initFileInput:function(){var c=this;this._form=$('<form class="ws-file-browse-form" method="POST" enctype="multipart/form-data" action="'+this._targetUrl+'" target="ws-iframe-transport-'+this.getId()+'" accept-charset="utf-8"></form>');this._queryInput=$('<input type="hidden" name="Запрос"/>');this._fakeButton=$('<input class="input-file-browse ws-upload-trigger" type="file" name="file1">').attr("title",this._options.tooltip).change(function(){c._curval=$(this).val();c._notify("onChange",c._curval);c.post();}).click(function(f){var e=c._notify("onActivated");if(e===false){f.stopPropagation();f.preventDefault();return false;}});this._iframe=$('<iframe class="ws-hidden" name="ws-iframe-transport-'+this.getId()+'"></iframe>');this._iframe.bind("load",function(){var f;try{f=this.contentDocument?this.contentDocument.childNodes[0].childNodes[1].innerHTML:window.frames["ws-iframe-transport-"+c.getId()].document.childNodes[0].childNodes[1].innerHTML;}catch(g){}c._appletPostFinished(f);});var d=((this._options.renderStyle==="asLink")?this._container.find(".ws-field-button-link"):this._container);this._form.append(this._fakeButton).append(this._queryInput).append('<input name="iehack" type="hidden" value="&#9760;">');d.append(this._iframe).append(this._form);this._inputControl.addClass("ws-upload-trigger");if(this._options.renderStyle==="asLink"){this._fakeButton.bind("click",function(e){e.stopPropagation();});}},_fileSelected:function(d){if(!d||d=="undefined"){return;}var c=this;c._loading=true;if(c._options.showIndicator){c._showIndicator();}$ws.single.MicroSession.set(this.getName()+"_lastSelectedFile",d);this._putUploaderApplet().addCallback(function(e){var f=c._getRequestParameters();f.fileName=d;e.uploadFile(JSON.stringify(f));return e;});},_putUploaderApplet:function(){return $ws.java.runApplet("fileUploadApplet",{},false);},_putChooserApplet:function(){return $ws.java.runApplet("fileChooserApplet",{},false);},_notFormatedVal:function(){return this._curval;},getFileName:function(){return this._curval;},_getElementToFocus:function(){return this._inputControl||this._container;},setRootFolder:function(c){this._options.rootFolder=c;},reInitApplet:function(){if(this._options.useJava&&$ws.java.isJavaInstalled()&&this._applet===null){this._initApplet();}},_appletPost:function(d){this._appletOpen=false;if(d!=="undefined"){this._notify("onChange",this._curval=decodeURIComponent(d));}if(this.isEnabled()){this._container.removeClass("ws-disabled");}var c=this;this._upload(function(){c._fileSelected(d);});},_appletPostFinished:function(f){if(this._loading){var c;try{c=$.parseJSON(f);}catch(d){}if(!c){c={error:{code:"500",message:"Внутренняя ошибка сервера!"}};}if(c&&"result" in c){this._updateSelfContextValue(c.result);}this._notify("onLoaded",c,true);if(this._options.showIndicator){this._hideIndicator();}this._loading=false;this._form.get(0).reset();}},post:function(){var c=this;this._upload(function(){var g=c._prepareParams();c._loading=true;var f={jsonrpc:"2.0",method:c._options.method,params:{"Файл":{"Данные":{href:"file1"}}},protocol:3};for(var e in g){if(g.hasOwnProperty(e)){if(g[e] instanceof $ws.proto.Record){g[e]=g[e].toObject();}var d=$ws.proto.ReaderSBIS.serializeParameter(e,g[e]).d;if(e in {"Ид":0,"ИмяФайла":0,"Размер":0}){f.params["Файл"][e]=d;}else{f.params[e]=d;}}}c._queryInput.val(JSON.stringify(f));if(c._options.showIndicator){c._showIndicator();}c._form.submit();});},_showIndicator:function(){var c=this;if(c._indicator!==null&&c._indicator instanceof b){c._indicator.show();}else{if(!this._loadingDef){this._loadingDef=new $ws.proto.Deferred();$ws.core.attachInstance("SBIS3.CORE.LoadingIndicator",{loadingPicture:$ws._const.wsRoot+"img/ajax-loader.gif",showInWindow:true,message:"Загрузка",parent:this.getParent(),handlers:{onInit:function(){c._indicator=this;c._loadingDef.callback();}}});}}},_hideIndicator:function(){var c=this;if(this._loadingDef){this._loadingDef.addCallback(function(){c._loading=false;c._indicator.hide();c._loadingDef=null;});}else{if(this._indicator){this._loading=false;this._indicator.hide();}}},setEnabled:function(c){c=!!c;if(this._options.allowChangeEnable||c===this._options.enable){if(!c){if(this._inputControl){this._inputControl.attr("disabled","disabled");}}else{if(this._inputControl){this._inputControl.removeAttr("disabled");}}if(this._fakeButton){this._fakeButton.toggle(c);}$ws.proto.FileBrowse.superclass.setEnabled.apply(this,arguments);}}});return $ws.proto.FileBrowse;});