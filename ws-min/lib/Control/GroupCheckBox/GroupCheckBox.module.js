$ws.declareModule({namespace:"SBIS3.CORE",name:"GroupCheckBox",imports:["SBIS3.CORE.TemplatedAreaAbstract"]},function(a){$ws.proto.GroupCheckBox=a.extend({$protected:{_options:{elements:[],wordWrap:false,buttonDirection:"",fixWidth:true,allowEmpty:true,flagHeight:20},_flagAlign:{flagTop:1,flagRight:"0px",flagBottom:"0px",flagLeft:1},_disabledFlag:undefined,_defaultValue:undefined,_elementsCount:0},$constructor:function(){this._container.removeClass("ws-area").addClass("ws-groupcheckbox").addClass(this._options.wordWrap?"ws-prewrap":"ws-nowrap");this._height="";this._width="";this._createRecord();this._elementsCount=this._options.elements?this._options.elements.length:0;},_redraw:function(b){return this._runInBatchUpdate("appendFlags",function(){var c=this._createChildrenLoadCallback();this._dChildReady=new $ws.proto.ParallelDeferred();this._isReady=false;this._createRecord();this._removeControls();this._createFlags(c,b);this.setValue(this._curval);return c.done().getResult().createDependent();});},_createFlagMarkup:function(f,b,c,d){var e=$('<div id="'+f+'" class="ws-groupcheckbox-item-'+b+'"></div>');if(this._options.buttonDirection==="inblock"){if(d&&b>=this._elementsCount){e.attr("alignmargin",b*this._options.flagHeight+",0,0,0");e.css({position:"absolute",left:this._flagAlign.flagLeft+"px",right:"0px",top:(b*this._options.flagHeight+1+"px"),bottom:"0px",height:this._options.flagHeight+"px"});}else{e.css({"padding-left":this._flagAlign.flagLeft+"px",display:"block"});}}else{if(this._options.buttonDirection==="inline"){e.css({"padding-left":this._flagAlign.flagLeft+(b?4:0)+"px",width:(100/(c||1))+"%",display:"inline-block"});}}return e;},_templateInnerCallback:function(){if(this._options.name!==""){var b=this.getLinkedContext().getValue(this._options.name);if(b===undefined||b.getColumns().length===0){this.setValue(this._curval);}else{this._setValueInternal(b);}}$ws.proto.GroupCheckBox.superclass._templateInnerCallback.call(this);},_loadDescendents:function(){return this._runInBatchUpdate("_loadDescendents",function(){var b=this._createChildrenLoadCallback();this._createFlags(b);return b.done().getResult().createDependent();});},_createFlags:function(g,f){var c=0;for(var d in this._options.elements){if(this._options.elements.hasOwnProperty(d)){var h=this.getId()+"-"+c;this._container.append(this._createFlagMarkup(h,c,this._options.elements.length,f));var e=this,b=$.extend({name:this._options.elements[d].name||d,element:h,parent:this,subcontrol:true,handlers:{onChange:function(i,j){e._onFlagChange(this.getName(),j);}}},this._options.elements[d]);g.push($ws.core.attachInstance("Control/Field:FieldCheckbox",b).addCallback(function(i){i._notifyOnSizeChanged();}));c++;}}},_getCheckedFlags:function(){var d=[];for(var c=0;c<this._childControls.length;++c){var b=this._childControls[c];if(b){if(b.getValue()){d.push(b);}}}return d;},_checkEmpty:function(){if(!this._options.allowEmpty){var b=this._getCheckedFlags();if(b.length!==1){if(this._disabledFlag){this._disabledFlag.setEnabled(true);}}else{if(b.length===1){this._disabledFlag=b[0];this._disabledFlag.setEnabled(false);}}}},_onFlagChange:function(b,c){this._curval.set(b,c);this.setValue(this._curval);this._notify("onChange",this._curval,b);this._checkEmpty();},_removeControls:function(){$ws.proto.GroupCheckBox.superclass._removeControls.apply(this,arguments);this._childsTabindex={};},_createRecord:function(){var d={},f=[],c=0;for(var b in this._options.elements){if(this._options.elements.hasOwnProperty(b)){d[this._options.elements[b].name||b]={index:c,title:this._options.elements[b].name||b,type:"Логическое"};var e=this._options.elements[b].value;if(e===undefined){e=false;}f.push(e);c++;}}this._curval=new $ws.proto.Record({row:f,colDef:d});this._defaultValue=this._curval.cloneRecord();},setValue:function(b){this._setValueInternal(b);this.getLinkedContext().setValue(this._options.name,b,undefined,true);this._checkEmpty();},_notFormatedVal:function(){return this._curval;},_setValueInternal:function(e){if(e instanceof $ws.proto.Record){this._curval=e;for(var b in this._childControls){if(this._childControls.hasOwnProperty(b)){var c=this._childControls[b].getName(),d=e.get(c)===null&&!this._options.elements[b].isThirdPosition?false:e.get(c);this._childControls[b].setValue(d===undefined?false:d);this._curval.set(c,d===undefined?false:d);}}}},validate:function(){return true;},getValue:function(){return this.getLinkedContext().getValue(this._options.name);},setEnabled:function(e){e=!!e;if(this._options.allowChangeEnable||e===this._options.enable){$ws.proto.GroupCheckBox.superclass.setEnabled.apply(this,arguments);var c=this.getImmediateChildControls();for(var d=0,b=c.length;d<b;d++){c[d].setEnabled(e);}}},appendFlags:function(c,b){var d=this;if(b){d._options.elements.length=0;}$ws.helpers.forEach(c,function(e){d._options.elements[d._options.elements?d._options.elements.length:0]={name:e["Имя"]||"",caption:e["Текст"]||e["Имя"]||"",value:e["Значение"]||false,tabindex:d._options.elements.length,tooltip:e["Подсказка"]||"",isThirdPosition:e["Трехпозиционный"]||false};});return this._redraw(true);},getDefaultValue:function(){return this._defaultValue;},getFlagCaption:function(e){var c=this._options.elements;for(var d=0;d<c.length;++d){var b=c[d];if(b.name===e){return b.caption;}}return undefined;}});return $ws.proto.GroupCheckBox;});