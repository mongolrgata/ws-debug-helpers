$ws.declareModule({namespace:"SBIS3.CORE",name:"Accordion",imports:["SBIS3.CORE.Control","SBIS3.CORE.Marker"]},function(a){$ws.proto.Accordion=a.Control.extend({$protected:{_options:{collapseContent:false,instantLoad:false,openAll:false,dragToTop:false,hideActiveLabel:false,elements:[],autoHeight:false,autoWidth:false,cssClassName:"ws-accordion"},_elements:{},_defaultActiveElement:-1,_activeElement:-1,_loading:false},$constructor:function(){var b=this;this._publish("onGroupOpen","onBeforeGroupOpen","onGroupContentLoaded","onLabelClick");if(!this._hasMarkup()){this._options.id=this._id;if(!$ws.proto.Accordion.__markupTemplate){$ws.proto.Accordion.__markupTemplate=doT.template(this._createMarkup());}this._container.html($ws.proto.Accordion.__markupTemplate(this._options));}this._bindInternals();this._calculateSize();$ws.single.ControlStorage.waitChildByName(this.getName()).addCallback(function(){b._notify("onStateChanged");if(b._defaultActiveElement!==-1){b.openElement(b._defaultActiveElement,undefined,undefined,true);}});this.subscribe("onGroupOpen",function(d,f,c){this._notify("onStateChanged",f,!c);});},_isElementAreaVisible:function(b){return !b.areaHidden;},_isElementAreaHidden:function(b){return b.areaHidden;},_hideElementArea:function(b){b.area.addClass("ws-hidden");b.areaHidden=true;},_showElementArea:function(b){b.area.removeClass("ws-hidden");b.areaHidden=false;},_hideElementWrapper:function(b){b.wrapper.addClass("ws-hidden");b.hidden=true;},_showElementWrapper:function(b){b.wrapper.removeClass("ws-hidden");b.hidden=false;},toggleElement:function(c,b){this._runInBatchUpdate("Accordion:toggleElement",function(){var e=this,f=this._activeElement,d;if((this.isGroupLoaded(c)||!this._elements[c].template)&&this._isElementAreaVisible(this._elements[c])){this._notifyBatchDelayed("onLabelClick",c);}if(!this._options.collapseContent&&c==this._activeElement&&!this._options.openAll){return;}if(this._options.openAll){if(this._isElementAreaHidden(this._elements[c])){this.openElement(c,true,undefined,b);}else{this.closeElement(c,true);}return;}if(this._activeElement!=c){d=this.openElement(c,e._options.openAll,undefined,b);}else{this._activeElement=-1;}d.addCallback(function(g){if(g&&f!==-1&&!e._options.openAll){e.closeElement(f,true);}});return d;});},closeElement:function(d,b){var c=this._elements[d];if(c!==undefined){this._hideElementArea(c);c.label.removeClass("ws-accordion-active");this.toggleLabel(d,true);c.wrapper.removeClass("ws-accordion-wrapper-active");if(this._elements[d].toolbar!==undefined){this._elements[d].toolbar.hide();}if(b){this._calculateSize();}if(d==this._activeElement){this._activeElement=-1;}}},openElement:function(i,d,h,g){h=typeof h=="boolean"?h:true;var c=this,e=this._elements[i],b=new $ws.proto.Deferred(),f;if(e!==undefined){f=c._notify("onBeforeGroupOpen",i);if(f instanceof $ws.proto.Deferred){f.addBoth(function(j){if(j!==false){c._openElement(i,e,d,h,g);b.callback(true);}});}else{if(f!==false){this._openElement(i,e,d,h,g);b.callback(true);}else{b.callback(false);}}return b;}},_openElement:function(g,d,c,f,e){var b=this;if(this._options.dragToTop){this._dragToTop(g);}if(!d.area.is(":empty")||d.template){this._showElementArea(d);}d.label.addClass("ws-accordion-active");this.toggleLabel(g,!this._options.hideActiveLabel);d.wrapper.addClass("ws-accordion-wrapper-active");this._activeElement=g;if(!d.dReady&&d.template){this._loadTemplate(g,f,e);}else{if(d.dReady instanceof $ws.proto.Deferred){d.dReady.addCallback(function(){if(b._elements[g].toolbar!==undefined){b._elements[g].toolbar.show();}b._setGroupSize(g);if(c){b._calculateSize();}if(f){b._notifyBatchDelayed("onLabelClick",g);}b._notifyBatchDelayed("onGroupOpen",g,e);});}else{if(f){this._notifyBatchDelayed("onLabelClick",g);}this._notifyBatchDelayed("onGroupOpen",g,e);}}},hideElement:function(c){var b=this._elements[c];if(b){this._hideElementWrapper(b);this._calculateSize();}},showElement:function(c){var b=this._elements[c];if(b){this._showElementWrapper(b);this._calculateSize();}},isElementVisible:function(c){var b=this._elements[c];if(b){return !b.hidden;}return undefined;},toggleLabel:function(d,c){var b=this.getLabelById(d);if(b){b.css("display",c?"block":"none");}},enableLabel:function(c,b){this._elements[c].enabled=b===undefined?!this._elements[c].enabled:b;this.getLabelById(c).parent().toggleClass("ws-label-disabled",b===undefined?b:!b);},getGroupById:function(b){if(this._elements[b]){return this._elements[b].instance;}else{return undefined;}},getLabelById:function(b){if(this._elements[b]){return this._elements[b].label;}},getActiveElement:function(){return this._activeElement;},isGroupOpen:function(b){return this._activeElement==b;},isGroupLoaded:function(b){return(this._elements[b].dReady instanceof $ws.proto.Deferred)&&this._elements[b].dReady.isReady();},destroy:function(){for(var b in this._elements){this._elements[b].label.unbind("click");if(this._elements[b].instance){this._elements[b].instance.destroy();}}$ws.proto.Accordion.superclass.destroy.apply(this,arguments);},_loadToolbar:function(d){var c=this._elements[d].toolbarOpt,b=$('<div class="ws-accordion-toolbar"></div>');this._elements[d].label.append(b);c.element=b;return $ws.core.attachInstance("SBIS3.CORE.ToolBar",c);},_loadTemplate:function(h,g,f){var c=this,d=this._elements[h],b,e=this._activeElement;c._loading=true;b=d.area.find(".ws-accordion-area");d.dReady=new $ws.proto.Deferred();this._runInBatchUpdate("_loadTemplate - Accordion",function(){return $ws.core.attachInstance("SBIS3.CORE.TemplatedArea",{autoHeight:c._options.autoHeight,autoWidth:c._options.autoWidth,template:d.template,element:b,parent:c.getParent(),keepSize:false,page:false,context:c.getLinkedContext(),owner:this.getId(),isRelative:c._options.isRelative,handlers:{onAfterLoad:function(){c._loading=false;c._notifyBatchDelayed("onGroupContentLoaded",h);d.dReady.callback();if(e==h){if(g!==false){c._notifyBatchDelayed("onLabelClick",h);}c._notifyBatchDelayed("onGroupOpen",h,f);}}}}).addCallback(function(i){d.instance=i;if(c._elements[h].toolbarOpt!==undefined){c._loadToolbar(h).addCallback(function(j){c._elements[h].toolbar=j;i.registerChildControl(j);});}});});},_dragToTop:function(f){if(this._activeElement!==-1){var d=this._elements[this._activeElement].position;for(var c in this._elements){if(this._elements[c].position<d){this._elements[c].wrapper.after(this._elements[this._activeElement].wrapper);}}}var e=this._container.children("div:eq(0)"),b=this._elements[f].wrapper;if(e[0]!==b[0]){e.before(b);b.removeClass("ws-accordion-wr-hover");}},_bindInternals:function(){var d=this,h=this._options.elements,c=this.getContainer(),b=h.length;if(b){for(var f=0;f<b;f++){var e=c.find(".ws-element-id-"+f).bind("click",{id:h[f].id},function(i){if(d._elements[i.data.id].enabled&&!d._loading){d.toggleElement(i.data.id,true);}}).hover(function(i){$(this).parent().toggleClass("ws-accordion-wr-hover",i.type=="mouseenter");}),j=e.parent(),g=j.find(".ws-accordion-element-area");if(h[f].active){this._defaultActiveElement=h[f].id;}this._elements[h[f].id]={position:f,wrapper:j,hidden:h[f].hidden,areaHidden:true,label:e,area:g,dReady:false,template:h[f].template,toolbarOpt:h[f].toolbar,enabled:true};if(this._options.instantLoad&&h[f].template){this._loadTemplate(h[f].id);}}if(this._events.onLabelClick.length){this._container.find(".ws-accordion-element-title").addClass("ws-accordion-has-handlers");}}},_createMarkup:function(c){var b="               {{ for(var e in it.elements) { }}                  <div class='ws-accordion-wr {{? it.elements[e].hidden}}ws-hidden{{?}}'>                     <span class='ws-accordion-element-title ws-element-id-{{=e}}'>{{? it.elements[e].image }}<img src='{{=$ws.helpers.processImagePath(it.elements[e].image)}}' class='ws-accordion-element-img'/>{{?}}{{=it.elements[e].title}}<div class='ws-accordion-arrow'></div></span>                     <div class='ws-accordion-element-area ws-hidden'><div id='{{=it.id}}-{{=e}}' class='ws-accordion-area'><innerTpl></innerTpl></div></div>                     <div class='ws-accordion-shadow'></div>                  </div>               {{ } }}            ";return this._extendMarkup(c,b);},_haveAutoSize:function(){return this._verticalAlignment!=="Stretch"&&this._options.autoHeight;},_onResizeHandlerBatch:function(){this._onResizeHandler();},_onSizeChangedBatch:function(b){this._calculateSize(true);return true;},_calculateSize:function(g){var b=this._container.height();for(var d in this._elements){if(this._elements.hasOwnProperty(d)){var c=this._elements[d].label,h=String.trim(c.text()).indexOf(" ")>-1;c.removeClass("ws-dbl-line");if(h&&c[0].scrollWidth>c[0].clientWidth){c.addClass("ws-dbl-line");}b-=c.outerHeight();}}if(this._verticalAlignment!="Stretch"&&this._options.autoHeight){this._container.height("auto");if(!g){this._notifyOnSizeChanged(this,this);}}else{for(var e in this._elements){if(this._elements.hasOwnProperty(e)){var f=this._elements[e].area;f.height(b-(f.outerHeight()-f.height()));}}}},_onResizeHandler:function(){if(!(this._verticalAlignment!="Stretch"&&this._options.autoHeight)){this._calculateSize();}this._setGroupSize(this._activeElement);$ws.proto.Accordion.superclass._onResizeHandler.apply(this,arguments);},_setGroupSize:function(c){if(this._elements&&this._elements[c]){var b=this._elements[c];if(b&&b.instance instanceof SBIS3.CORE.TemplatedArea){b.instance._onResizeHandler();}}},applyState:function(b){if(this._activeElement==-1){this._defaultActiveElement=b;}else{if(this._activeElement!=b){this.toggleElement(b,true);}}},_redraw:function(){}});return $ws.proto.Accordion;});