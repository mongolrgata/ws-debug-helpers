$ws.declareModule({namespace:"SBIS3.CORE",name:"FieldFormatAbstract",imports:["SBIS3.CORE.FieldString"]},function(a){$ws.proto.FieldFormatAbstract=a.extend({$protected:{_sepExp:"",_htmlMask:"",_clearMask:"",_notsepExp:"",_valuePure:"",_options:{separatorFirst:false,mask:"",cssClassName:"ws-field-format"},_keysWeHandle:[$ws._const.key.enter,$ws._const.key.backspace,$ws._const.key.space,$ws._const.key.del,$ws._const.key.left,$ws._const.key.right]},$constructor:function(){var b=this;this._prepareRegExp();this._htmlMask=this._getMask(this._options.mask,"html");this._clearMask=this._getMask(this._options.mask,"clear");this._inputControl.html(this._htmlMask);this._valuePure=this._inputControl.text();this._defaultTxt=this._curValue();this._publish("onInputEnd","onChangePure");this._inputControl.unbind("keypress");if(this._options.readonly){this.setEnabled(false);}this._inputControl.unbind("focus");this._bindTooltipHandlers();this._inputControl.focus(function(c){b._funcFocus(b._inputControl.get(0));}).keypress(function(d){var c=d.which;if(!d.ctrlKey&&c!==$ws._const.key.tab&&((c&&c!=$ws._const.key.backspace&&c>40)||(c&&c<41&&d.shiftKey))){b._keyFunc(c,"right");return false;}}).bind("cut",function(){b._keyFunc(0,"delete");});this._containerWidth();this.subscribe("onChangePure",function(){b._changed=true;});},_onValueChangeHandler:function(){var c=this._notFormatedVal(true),b=this._valuePure,d;if(c&&c.equals){d=c.equals(b);}else{d=(c==b);}if(!d){this._valuePure=c;this._notify("onChangePure",c);this.clearMark();}$ws.proto.FieldFormatAbstract.superclass._onValueChangeHandler.apply(this,arguments);},_prepareRegExp:function(){this._sepExp=/[^dLlx]+/g;this._notsepExp=/[dLlx]+/g;},_isEmpty:function(){var b=/<[^<]+>/g,c=this._inputControl.html().replace(b,"");return(typeof(c)==="undefined"||c===""||c===this._getMask(this._options.mask,"html").replace(b,""));},_containerWidth:function(){var b=["font-size","font-style","font-family","font-weight"],d,c=this;$("body").append(d=$("<div class='ws-formatfield-temp'></div>"));c._inputControl.children().each(function(){var h=$(this),g={},j=h.clone();for(var f=0,e=b.length;f<e;f++){g[b[f]]=h.css(b[f]);}d.append(j.css(g));});c._inputControl.parent().width(d.width());d.empty().remove();},setEnabled:function(b){if(this._options.allowChangeEnable||b===this._options.enable){if(!b){this._container.addClass("readonly");}else{this._container.removeClass("readonly");}this._options.enable=b;this._inputControl.attr("contenteditable",b?"true":"false");}},_createMarkup:function(c){var b=$ws.proto.FieldAbstract.prototype._createMarkup.apply(this,arguments);return this._extendMarkup(b,"<div contenteditable='true' class='input-field' title='{{=it.tooltip}}' {{? it.tooltipInside }}placeholder='{{=it.tooltip}}'{{?}}></div>");},_bindInternals:function(){this._inputControl=this._container.find(".input-field");},_getString:function(){var b=this._inputControl.get(0);return b.textContent||b.innerText;},_curValue:function(b){var c=this._getString();if(b){return c;}else{return c.length===this._clearMask.length&&c.indexOf(this._placeHolder())===-1?c:"";}},_setValueInternal:function(d){this._inputControl.html(this._htmlMask);if(d!==null){d=this._formatTest(d);var c=this._options.separatorFirst,e=d.split(/[-.:,)( ]+/g),b=0;this._inputControl.children().each(function(){if(!(($(this).index()+c)%2)){if((typeof e[b]!="undefined")&&$(this).html().length==e[b].length){$(this).html(e[b]);b++;}else{throw new Error("not valid insert data");}}});$ws.proto.FieldAbstract.prototype._setValueInternal.apply(this,arguments);}this._hideMask(this.isActive());},_formatTest:function(p){var r=this,u=r._clearMask.match(this._notsepExp),n=this._options.separatorFirst,m=[];for(var f=0,d=u.length;f<d;f++){var t=u[f].split("");for(var e=0,g=t.length;e<g;e++){var q=this._keyExp(f*2+n,e),k=q[0],c=q[1];t[e]=this._placeHolder();for(var o=0,h=p.length;o<h;o++){var b=p.charAt(o);if(k.test(b)){if(c){b=b[c]();}t[e]=b;p=p.substr(o+1);break;}}}m.push(t.join(""));}return m.join(":");},_placeHolder:function(){return"_";},_getMask:function(s,c){var p=s.replace(/{[^}]+}/g,""),v,g=[],u=[],o=s,n=0,b;while(o.indexOf("{")!=-1){var f=o.indexOf("{"),d=o.substr(0,f).split(/[-.:,)( ]/g).length-1;u[d]=(/{[^}]+}/).exec(o).toString().replace(/[}{]/g,"");o=o.replace(/{[^}]+}/,"");}if(c=="html"){v=p.match(this._notsepExp);b=p.match(this._sepExp);if(b&&b[0]&&p.indexOf(b[0])===0){n=1;g.push("<em>",b[0],"</em>");this._options.separatorFirst=true;}for(var t=0;t<v.length;t++){g.push('<em class="fmt-cont vis-hide" style="'+u[t]+'">');for(var r=0;r<v[t].length;r++){g.push(this._placeHolder());}g.push("</em>");if(b&&b[t+n]){g.push("<em>",b[t+n],"</em>");}}return g.join("");}else{if(c=="clear"){return p;}else{if(c=="datepicker"){var e=p.toLowerCase(),h=e.lastIndexOf("y"),w=e.indexOf("y"),q=(h-w+1)/2,k=e.substring(0,w)+e.substr(h-q+1);return k.replace(/[hius]/g,"0");}else{if(c=="style"){return u;}else{throw new Error("Unexpected type specified to _getMask: "+c);}}}}},_keyExp:function(b,h){if(this._options.separatorFirst){b--;}b=b?b/2:b;var e=this._clearMask.match(this._notsepExp),g=e[b].charAt(h),f=this._charToRegExp(g),d={L:"toUpperCase",l:"toLowerCase"};return[f,d[g]||false];},_charToRegExp:function(d){var b;switch(d){case"d":b=/\d/;break;case"L":case"l":b=/[А-ЯA-Zа-яa-zёЁ]/;break;case"x":b=/[А-ЯA-Zа-яa-z0-9ёЁ]/;break;default:b=/\w/;break;}return b;},_keyFunc:function(m,g){var l=window.getSelection().getRangeAt(0),k=this._cursorCorrect(l.startContainer,l.startOffset),f=k[0],c=k[1],j=this._cursorCorrect(l.endContainer,l.endOffset),d=j[0],n=j[1],i,e=this._keyExp($(f.parentNode).index(),c),b=String.fromCharCode(m),h=f.parentNode.nextSibling;this._clearSelect(f,c,d,n);if(g=="right"){if(f.nodeValue.length<=c&&h){f=h.nextSibling;if(!f){return false;}f=f.firstChild;c=0;}else{if(f.nodeValue.length==c&&!h){return false;}}if(e[0].test(b)){i=f.nodeValue.split("");i[c]=e[1]?b[e[1]]():b;f.nodeValue=i.join("");c++;if(f.nodeValue.length==c&&!h){this._notify("onInputEnd");}}else{if(/[-.:,)( ]/.test(b)){this._moveCursor(f,c);}else{return false;}}}if(g=="backspace"){if(!c&&f.parentNode.previousSibling){f=f.parentNode.previousSibling.previousSibling;if(!f){return false;}f=f.firstChild;c=f.nodeValue.length;}else{if(!c&&!f.parentNode.previousSibling){return false;}}i=f.nodeValue.split("");i[c-1]=this._placeHolder();f.nodeValue=i.join("");c--;if(!c&&f.parentNode.previousSibling){f=f.parentNode.previousSibling.firstChild;}}if(g=="delete"){if(f==d&&c==n){if(f.nodeValue.length==c&&h){f=h.nextSibling;if(!f){return false;}f=f.firstChild;c=0;}else{if(f.nodeValue.length==c&&!h){return false;}}i=f.nodeValue.split("");i[c]=this._placeHolder();f.nodeValue=i.join("");c++;}}this._moveCursor(f,c);},_cursorCorrect:function(c,b){var h,j=b,e,g=this._options.separatorFirst,d=this._inputControl.get(0);if(c.parentNode.childNodes.length>1){for(var f=0;f<c.parentNode.childNodes.length;f++){if(c==c.parentNode.childNodes[f]){j=(f+g)%2?0:f?c.firstChild.length:b?c.firstChild.length:b;h=(f+g)%2?f+1:f;e=c.parentNode.childNodes[h];if(j>=e.firstChild.length){j=e.nextSibling?0:j;h=e.nextSibling?h+2:h;}}}}else{e=$(c.parentNode).index();h=(e+g)%2?e+1:e;j=(e+g)%2?0:j;if(h>=d.childNodes.length){h-=2;j=d.childNodes[h].childNodes[0].length;}}if($(c).hasClass("input-field")){h=b?b-1:0;j=b?d.childNodes[h].childNodes[0].length:0;return this._cursorCorrect(d.childNodes[h].childNodes[0],j);}return[d.children[h].childNodes[0],j];},_clearSelect:function(h,f,k,e){for(var g=$(k).parent().index();g>=$(h).parent().index();g=g-2){for(var d=(g==$(k).parent().index()?e:this._inputControl.get(0).childNodes[g].childNodes[0].nodeValue.toString().length);d>(g==$(h).parent().index()?f:0);d--){var c=this._inputControl.get(0).childNodes[g].childNodes[0].nodeValue.split("");c[d-1]=this._placeHolder();this._inputControl.get(0).childNodes[g].childNodes[0].nodeValue=c.join("");}}},_moveCursor:function(g,c){var b,d;try{if($.browser.msie){b=document.body.createTextRange();b.moveToElementText(g.parentNode);b.move("character",c);b.select();}else{d=window.getSelection();d.collapse(g,c);}}catch(f){}},_funcFocus:function(d){if($(d).text()==$(this._htmlMask).text()){var i=d.childNodes[0].childNodes[0],c=0;this._moveCursor(i,c);}else{var h,b,f;h=this._inputControl.get(0);try{if(document.body.createTextRange){b=document.body.createTextRange();b.moveToElementText(h);b.select();}else{b=document.createRange();b.selectNodeContents(h);f=window.getSelection();f.removeAllRanges();f.addRange(b);}}catch(g){}}},_notFormatedVal:function(b){return this._curValue(b);},clear:function(){this._inputControl.html(this._htmlMask);},setActive:function(b){$ws.proto.FieldFormatAbstract.superclass.setActive.apply(this,arguments);this._hideMask(this.isActive());},_hideMask:function(b){if(b){this._inputControl.find(".fmt-cont").removeClass("vis-hide");}else{this._inputControl.find(".fmt-cont").each(function(){var d="_________________________________________________________________",c=this.textContent||this.innerText;if(c==d.substr(0,this.childNodes[0].length)){$(this).addClass("vis-hide");}else{$(this).removeClass("vis-hide");}});}},_keyboardHover:function(c){var b=c.which;if(b==$ws._const.key.backspace){this._keyFunc(b,"backspace");return false;}else{if(b==$ws._const.key.del||b==$ws._const.key.space){this._keyFunc(b,"delete");return false;}}if(b===$ws._const.key.del||b===$ws._const.key.backspace||b===$ws._const.key.left||b===$ws._const.key.right){c.stopImmediatePropagation();}if(b==$ws._const.key.enter){c.preventDefault();}return true;},getStringValue:function(){var b=this._curValue(true);return b.replace(/\.|[_\.]*$|^[_\.]*/g,"").replace(/_/g," ");},_redraw:function(b){if((b&&!this._hasMarkup())||!b){if(!$ws.proto.FieldFormatAbstract.__markupTemplate){$ws.proto.FieldFormatAbstract.__markupTemplate=doT.template(this._getMarkupTemplate());}this._container.html($ws.proto.FieldFormatAbstract.__markupTemplate(this._options));}}});return $ws.proto.FieldFormatAbstract;});