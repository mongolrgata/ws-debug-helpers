$ws.declareModule({namespace:"SBIS3.CORE",name:"ScheduleEditor",imports:["SBIS3.CORE.Control"]},function(a){$ws.proto.ScheduleEditor=a.DataBoundControl.extend({$protected:{regional:{"default":{monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],dayNamesShort:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],dayNamesMin:["mo","tu","we","th","fr","sa","su"]},ru:{monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],monthNamesShort:["Янв","Фев","Май","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],dayNames:["Понедельник","Вторник","Среда","Четверг","Пятница","Суббота","Воскресенье"],dayNamesShort:["Пон","Вто","Сре","Чет","Пят","Суб","Вос"],dayNamesMin:["пн","вт","ср","чт","пт","сб","вс"]}},_options:{language:"ru",dataSource:null,dateField:"Дата",startDate:null,editDialog:undefined,cellRenderFunc:null,allowEditAtPlace:false,editAtPlaceGetValue:undefined,editAtPlaceSetValue:undefined},_keysWeHandle:[$ws._const.key.enter,$ws._const.key.down,$ws._const.key.up,$ws._const.key.left,$ws._const.key.right],_date:undefined,_year:undefined,_startDate:undefined,_month:undefined,_rootDiv:undefined,_currentRecordSet:null,_recordArray:null,_row:1,_col:1,_tableReady:false,_loadingIndicator:undefined,_editAtPlaceLockCell:false,_editAtPlaceField:undefined,_editAtPlaceElement:undefined,_editAtPlaceValue:undefined,_editingAtPlace:false},$constructor:function(){this._publish("onRecordsChanged","onAfterRender");this._redraw(true);},_redraw:function(b){if(!b){this._container.html("");}if(typeof(this._options.cellRenderFunc)!=="function"){throw new Error("Cell rendering function not set");}this._container.append(this._loadingIndicator=$('<div class="ws-browser-ajax-loader ws-hidden"><div class="ws-loading-indicator-outer"><div class="ws-loading-indicator-block"><div class="ws-loading-indicator">'+($ws._const.theme==="wi_scheme"?"":"Загрузка")+"</div></div></div></div>")).append(this._rootDiv=$('<div class="ws-calendar-edit">'));this._options.startDate=this._options.startDate?this._options.startDate:new Date();if(this._options.dataSource.filterParams===undefined){this._options.dataSource.filterParams={};}this._startDate=this._prepareStartDate(this._options.startDate);this._month=this._startDate.getMonth();this._year=this._startDate.getFullYear();this.refresh();},_prepareStartDate:function(b){if(!(b instanceof Date)){if(b instanceof Object&&b.fieldName!==undefined){b=this._context.getValue(b.fieldName);}else{if(typeof b==="function"){b=b.apply(this,[this._context]);}}b=b||"";if(!(b instanceof Date)){b=new Date(b.replace(/(\d+)\/(\d+)\/(\d+)/,"$3/$2/$1"));}}if(isNaN(b.getDay())){return new Date();}return b;},_initDataSource:function(){var c=this,g=c._options.dataSource;if(!(g instanceof Object)){return new $ws.proto.Deferred().errback("DataSource is not an object!");}var b=new $ws.proto.Deferred();var d=$ws.core.merge({},g);if(!c._options.dataSource.firstRequest){c._loadingIndicator.addClass("ws-hidden");}c._options.dataSource.firstRequest=true;d=$ws.core.merge(d,{handlers:{onAfterLoad:function e(j,i,f,h){i.unsubscribe("onAfterLoad",e);if(f){b.callback(i);}else{b.errback(h);}}}});$ws.core.attachInstance("Source:RecordSet",d);return b;},_renderCell:function(d,b){var c=this._options.cellRenderFunc.apply(this,[d,b]);if(c!==null){if(typeof(c)==="string"){c=$ws.helpers.escapeTagsFromStr(c,["script"]);}else{if(c.nodeType){c=$(c);}}}else{c=$("<div/>",{text:""});}return c;},_fillRecordArray:function(){this._recordArray={};if(this._currentRecordSet){this._currentRecordSet.rewind();var c;while((c=this._currentRecordSet.next())!==false){var b=c.get(this._options.dateField);if(b.getMonth()==this._month&&b.getFullYear()==this._year){this._recordArray[b]={key:c.getKey()};}}}},_buildCalendar:function(){this._tableReady=false;this._rootDiv.html("");this._startDate=this._prepareStartDate(this._options.startDate);this._month=this._startDate.getMonth();this._year=this._startDate.getFullYear();this._fillRecordArray();var e={0:7,1:1,2:2,3:3,4:4,5:5,6:6},s=new Date(this._year,this._month,1),q=new Date(this._year,this._month+1,0),m=new Date(this._year,this._month,1-e[s.getDay()]+1),c=new Date(this._year,this._month+1,7-e[q.getDay()]);var j=$("<table/>",{"class":"ws-calendar-edit-table"}).append("<tbody/>"),g=0,h=1,l=[];l[0]=$("<tr>",{"class":"ws-calendar-edit-row"});for(var t=0;t<7;t++){l[0].append($("<td/>",{"class":"ws-ce-day",text:this.regional[this._options.language].dayNamesMin[t],title:this.regional[this._options.language].dayNames[t]}));}var p,r=new Date();r=new Date(r.getFullYear(),r.getMonth(),r.getDate());while(m<=c){var k=!!this._recordArray[m],b=this._recordArray[m],f=(Math.floor((h-1)/7)+1),d=g+1,o=null;o=this._renderCell(k?this._currentRecordSet.getRecordByPrimaryKey(b.key):null,new Date(m));if(!l[f]){l[f]=$("<tr>",{"class":"ws-calendar-edit-row"});}l[f].append(p=$("<td/>",{"class":"day-"+f+"-"+d+" ws-ce-value",key:k?this._recordArray[m].key:"null"}));p.data({row:f,col:d,date:new Date(m.getFullYear(),m.getMonth(),m.getDate()),key:k?this._recordArray[m].key:"null"});p.html(o);if(m<s||m>q){p.addClass("ws-ce-other-month");}else{p.addClass("ws-ce-curr-month");}if(m.equals(r)){p.addClass("ws-ce-today");}g=(g+1)%7;h++;m.setDate(m.getDate()+1);}for(var n in l){if(l.hasOwnProperty(n)){j.append(l[n]);}}this._rootDiv.append(j);this._tableReady=true;this._notify("onAfterRender");},_bindKeyboardHandler:function(){var b=this;$ws.helpers.keyDown(b.getContainer(),function(f){var c=$(f.target);if(b._tableReady){var d;switch(f.keyCode){case $ws._const.key.enter:b._showDialog();break;case $ws._const.key.down:d=c.find(".day-"+(b._row+1)+"-"+b._col+".ws-ce-value");if(d[0]&&!d.hasClass("ws-ce-other-month")){b._row++;b._setSelection(d);}else{d=c.find(".day-1-"+(b._col+1)+".ws-ce-value");if(d[0]&&!d.hasClass("ws-ce-other-month")){b._row=1;b._col++;b._setSelection(d);}}break;case $ws._const.key.up:d=c.find(".day-"+(b._row-1)+"-"+b._col+".ws-ce-value");if(d[0]&&!d.hasClass("ws-ce-other-month")){b._row--;b._setSelection(d);}else{d=c.find(".day-7-"+(b._col-1)+".ws-ce-value");if(d[0]&&!d.hasClass("ws-ce-other-month")){b._row=7;b._col--;b._setSelection(d);}}break;case $ws._const.key.left:d=c.find(".day-"+b._row+"-"+(b._col-1)+".ws-ce-value");if(d[0]&&!d.hasClass("ws-ce-other-month")){b._col--;b._setSelection(d);}break;case $ws._const.key.right:d=c.find(".day-"+b._row+"-"+(b._col+1)+".ws-ce-value");if(d[0]&&!d.hasClass("ws-ce-other-month")){b._col++;b._setSelection(d);}break;default:}}});},_bindEventHandlers:function(e){var b=this,g=b.getContainer().attr("id"),d=e?e:$("#"+g+" .ws-ce-value");function f(j){var i=$(j.target).closest(".ws-ce-value"),h=i.data();b._row=h.row;b._col=h.col;b._onClickHandler(j);j.stopImmediatePropagation();b._showDialog();}function c(k){if(b._editAtPlaceLockCell||$(this).hasClass("ws-ce-other-month")){return;}if(b._editingAtPlace){var l=b._editCellSave();if(l&&l instanceof $ws.proto.Deferred){l.addBoth(function(){c(k);});}else{c(k);}return;}b._editingAtPlace=true;var j=$(k.currentTarget),h=j.width()-2,o=j.height()-2,m,i=j.data();b._editAtPlaceElement=j;j.html("");j.prepend(m=$("<div class='ws-edit-field' />"));m.css({width:h,height:o,position:"relative"});b._editAtPlaceLockCell=true;function n(r){b._editAtPlaceValue=r;var q={};q.element=m;q.parent=b.getParent();q.name=b.getId()+"-EditAtPlaceField";q.handlers={onKeyPressed:function(s,t){if(t.which===$ws._const.key.insert){t.stopPropagation();t.preventDefault();}if(t.which===$ws._const.key.enter||t.which===$ws._const.key.esc||t.which===$ws._const.key.tab){t.stopPropagation();t.preventDefault();if(t.which===$ws._const.key.enter){b._editCellSave();}else{if(t.which===$ws._const.key.esc){b._editCellCancel();}else{b._editCellSave();}}}return false;},onFocusOut:b._editAtPlaceFocusOutCallback};$ws.core.attachInstance("Control/Field:FieldString",q).addCallback(function(s){b._editAtPlaceField=s;s.setActive(true);s.setValue(r);var t=s.getContainer().find("input");if(t[0]&&$.browser.msie&&parseInt(jQuery.browser.version,10)<9){t.css("line-height",t.height()+"px");}if(t[0]){t.bind("blur",function(){b._editAtPlaceFocusOutCallback();});}});j.unbind("click");b._editAtPlaceLockCell=false;}var p=b._options.editAtPlaceGetValue(b._options.dataSource,b._editAtPlaceElement.data("date"),i.key==="null"?null:b._currentRecordSet.getRecordByPrimaryKey(i.key));if(p instanceof $ws.proto.Deferred){p.addCallbacks(n,function(){b._editAtPlaceLockCell=false;});}else{n(p);}}d.bind("click",this._options.allowEditAtPlace?c:f);},_editCellSave:function(){var d=this,f=this._editAtPlaceField._curval,b=null,c=new $ws.proto.Deferred();function e(){d._loadingIndicator.removeClass("ws-hidden");d._initDataSource().addBoth(function(g){d._currentRecordSet=g;d._loadingIndicator.addClass("ws-hidden");d._editCellCancel();c.callback();return g;});}if(this._editAtPlaceValue!=f){b=this._options.editAtPlaceSetValue(this._options.dataSource,this._editAtPlaceElement.data("date"),f);if(b&&b instanceof $ws.proto.Deferred){d._loadingIndicator.removeClass("ws-hidden");b.addBoth(e);}else{d._loadingIndicator.removeClass("ws-hidden");e();}}else{d._editCellCancel();c.callback();}return c;},_editCellCancel:function(){var e=this._editAtPlaceElement.data(),c;this._editAtPlaceDestroyField();this._fillRecordArray();var d=!!this._recordArray[e.date],b=!d?"null":this._recordArray[e.date].key;this._editAtPlaceElement.data("key",b);c=this._renderCell(b==="null"?null:this._currentRecordSet.getRecordByPrimaryKey(b),e.date);this._editAtPlaceElement.html(c);this._bindEventHandlers(this._editAtPlaceElement);this._editingAtPlace=false;},_editAtPlaceFocusOutCallback:function(){this._editCellSave();},_editAtPlaceDestroyField:function(){if(!this._editAtPlaceField){return;}this._editAtPlaceField.unsubscribe("onFocusOut",this._editAtPlaceFocusOutCallback);this._editAtPlaceField.destroy();this._editAtPlaceField=null;},_showDialog:function(){if(this._options.editDialog===undefined||this._options.editDialog===""){return;}var c=this,f=this.getContainer().find(".day-"+c._row+"-"+c._col+".ws-ce-value"),d=f[0]?f.attr("key"):"null";function b(g){$ws.helpers.toggleIndicator(true);$ws.core.attachInstance("SBIS3.CORE.DialogRecord",{opener:c,template:c._options.editDialog,record:g,context:new $ws.proto.Context().setContextData(g),readOnly:false,isNewRecord:!g.getKey(),handlers:{onReady:function(){$ws.helpers.toggleIndicator(false);},onAfterClose:function(){c.refresh();c._notify("onRecordsChanged",f.data("date"),g);}}}).addErrback(function(){$ws.helpers.toggleIndicator(false);});}d=(d==="null"||!d)?null:d;if(f.hasClass("ws-ce-curr-month")){if(d&&c._currentRecordSet.contains(d)){c._currentRecordSet.readRecord(d).addCallback(function(g){if(g instanceof $ws.proto.Record){b(g);}return g;}).addErrback(function(g){if(g&&g.message){$ws.core.alert(g.message,"error");}g.processed=true;return g;});}else{var e=$ws.core.merge({},c._options.dataSource.filterParams);e[c._options.dateField]=f.data("date").toSQL();c._currentRecordSet.createRecord(e).addCallback(function(g){b(g);return g;});}}},_setSelection:function(b){this.getContainer().find(".ws-ce-selected").removeClass("ws-ce-selected");b.addClass("ws-ce-selected");},setDate:function(c,b){if(c instanceof Date){this._month=c.getMonth();this._year=c.getFullYear();}else{if(b){this._year=b;}this._month=c;}this._row=1;this._col=1;this.refresh();},refresh:function(){var b=this;b._rootDiv.find("td.ws-ce-value").html("");b._loadingIndicator.removeClass("ws-hidden");b._initDataSource().addCallback(function(c){b._currentRecordSet=c;b._buildCalendar();b._loadingIndicator.addClass("ws-hidden");b._bindEventHandlers();return c;}).addErrback(function(c){b._currentRecordSet=null;b._buildCalendar();b._loadingIndicator.addClass("ws-hidden");return c;});}});return $ws.proto.ScheduleEditor;});